/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.IpAccessRule=Class.extend({initialize:function(a,b,c){this.mask=a||"";this.reason=b||"";this.allowed=c||false;}});jscape.IpAccessRule.fromJSON=function(data){return new jscape.IpAccessRule(data.mask,data.reason,data.allowed);};jscape.domain.IPAccessModule=jscape.domain.DomainModule.extend({onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.IpAccessController();this.controller.onCreate(this.domainName);},onStart:function(){this.controller.onStart();},onPause:function(){if(this.controller.hasChanged()){this._confirmAndApply([this.controller]);}},onResume:function(){this.controller.onResume();}});jscape.domain.IpAccessController=Class.extend({view:null,rules:null,copy:null,initialize:function(){this._initValidators();},onCreate:function(domainName){this.domainName=domainName;this.addController=new jscape.domain.AddIpAccessController();this.editController=new jscape.domain.EditIpAccessController();this.deleteController=new jscape.domain.DeleteIpAccessController();},onStart:function(){if(this.view==null){this.view=new jscape.domain.IpAccessView();}
this.view.show(this);},hasChanged:function(){return!Object._equals(this.copy,this.rules);},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.getIpAccessRules(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter(),function(){return{total:0,rows:[]};}).then($.proxy(function(data){this.rules=data.rows;this.copy=this._copyRules(this.rules);return data;},this));},onResume:function(){this.view.refresh();},onApply:function(){var rules=this.rules;return jscape.API.setIpAccessRules(this.domainName,rules).done($.proxy(function(){this.copy=this._copyRules(rules);},this)).done($.proxy(this._fireApplySuccess,this));},onDiscard:function(){this.rules=this.copy;this.view.refresh();},onAddRule:function(){this.addController.start().done($.proxy(this._ruleAdded,this));},onEditRule:function(rule){var index=$.inArray(rule,this.rules);if(index!=-1){this.editController.start(rule).done($.proxy(this._ruleEdited,this,index));}},onDeleteRule:function(rules){this.deleteController.start(rules).done($.proxy(this._ruleDeleted,this,rules));},onRuleUp:function(rule){var index=$.inArray(rule,this.rules);if(index>0){this.rules.splice(index-1,2,this.rules[index],this.rules[index-1]);this.view.setRules(this.rules);this.view.selectRule(rule);}},onRuleDown:function(rule){var index=$.inArray(rule,this.rules);if(index!=-1&&index<this.rules.length-1){this.rules.splice(index,2,this.rules[index+1],this.rules[index]);this.view.setRules(this.rules);this.view.selectRule(rule);}},_ruleAdded:function(rule){this.rules.push(rule);this.view.setRules(this.rules);this.view.selectRule(rule);},_ruleEdited:function(index,rule){this.rules[index]=rule;this.view.setRules(this.rules);this.view.selectRule(rule);},_ruleDeleted:function(rules){var index=-1;while(rules.length){index=$.inArray(rules.pop(),this.rules);this.rules.splice(index,1);}
this.view.setRules(this.rules);if(this.rules.length){index=Math.max(0,Math.min(index,this.rules.length-1));this.view.selectRule(this.rules[index]);}},_copyRules:function(rules){return $.map(rules,function(rule){return jscape.IpAccessRule.fromJSON(rule);});},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);},_initValidators:function(){var v=new jscape.Validator();v.rule("ipaccess_unique",$.proxy(this._ruleNotExists,this),window.R.string.IP_ACCESS_ERROR_ALREADY_EXIST);},_ruleNotExists:function(value,excludes){return $.grep(this.rules,function(rule){return rule.mask==value&&(excludes==undefined||$.inArray(rule.mask,excludes)==-1);}).length==0;}});jscape.domain.IpAccessView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#ip-access-fields").layout({fit:true,doSize:false,border:false});this.fieldset.find(".content").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=ipaccess]",this.fieldset);this.data.datagrid({fit:true,singleSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:false,columns:[[{field:"mask",title:$("thead th:nth-child(1)",this.data).text(),width:"60%"},{field:"allowed",title:$("thead th:nth-child(2)",this.data).text(),finder:{type:"combobox",options:{data:$.map([true,false],$.proxy(function(value){return{text:this._formatAccess(value),value:String(value)};},this)),panelHeight:"auto"}},formatter:$.proxy(this._formatAccess,this),styler:$.proxy(this._styleAccess,this),width:"10%"},{field:"reason",title:$("thead th:nth-child(3)",this.data).text(),width:"30%"}]],onBeforeSelect:function(){return!$(this).datagrid("options").disabled;},onBeforeCheck:function(){return!$(this).datagrid("options").disabled;},onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustButtonsState,this)});this.moveUpButton=$("a[role=button][name=moveup]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveUpButton,this)});this.moveDownButton=$("a[role=button][name=movedown]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveDownButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.refreshButton=$("a[role=button][name=refresh]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$RefreshButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});initializing=false;},setRules:function(values){this.data.datagrid("loadData",values);this._adjustButtonsState();},selectRule:function(rule){this.data.datagrid("selectRow",this.data.datagrid("getRowIndex",rule));},show:function(listener){this.listener=listener||jscape.domain.IpAccessView.LISTENER;this._adjustButtonsState();},_formatAccess:function(value){return!!value?window.R.string.IP_ACCESS_RULE_ALLOWED:window.R.string.IP_ACCESS_RULE_DENIED;},_styleAccess:function(value){return!!value?"color:green":"color:red";},_onClick$AddButton:function(){this.listener.onAddRule();},_onClick$EditButton:function(){this.listener.onEditRule(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteRule(this.selection);},_onClick$MoveUpButton:function(){this.listener.onRuleUp(this.selection[0]);},_onClick$MoveDownButton:function(){this.listener.onRuleDown(this.selection[0]);},_onClick$RefreshButton:function(){this.data.datagrid("reload");},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onClick$ApplyButton:function(){if(this.fieldset.form("validate")){this.applyButton.linkbutton("disable");this.listener.onApply(this).always($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.moveUpButton,this.moveDownButton]);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var index=this.selection.length==1?this.data.datagrid("getRowIndex",this.selection[0]):-1;var count=this.data.datagrid("getRows").length;var disabled=this.data.datagrid("options").disabled;this.moveUpButton.linkbutton(!disabled&&index>0&&index<=count-1?"enable":"disable");this.moveDownButton.linkbutton(!disabled&&index>=0&&index<count-1?"enable":"disable");this.addButton.linkbutton(!disabled?"enable":"disable");this.editButton.linkbutton(!disabled&&this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(!disabled&&this.selection.length!=0?"enable":"disable");}});jscape.domain.IpAccessView.LISTENER={onAddRule:$.noop,onEditRule:$.noop,onDeleteRule:$.noop,onRuleUp:$.noop,onRuleDown:$.noop,onLoadData:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.IpAccessRuleDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-ipaccess-rule"),{width:"50%",minWidth:530,height:"50%"});this.fieldset=$("fieldset[name=ipaccessrulefields]",this.dialog);this.mask=$("input[name=mask]",this.fieldset).textbox({required:true,validType:["non_empty","ipaccess_unique"],invalidMessage:window.R.string.IP_ACCESS_ERROR_BAD_MASK,missingMessage:window.R.string.IP_ACCESS_ERROR_BAD_MASK,width:"60%"});this.reason=$("input[name=reason]",this.fieldset).textbox({width:"60%"});this.allowed=$("input[name=allowed]:radio",this.fieldset);},show:function(listener){this._super(listener);this.mask.textbox("textbox").focus();},getMask:function(){return this.mask.textbox("getValue");},setMask:function(value){this.mask.textbox("setValue",value);if(value&&value.trim().length){this.mask.textbox("textbox").validatebox("options").validType=["non_empty","ipaccess_unique['"+value+"']"];}},getReason:function(){return this.reason.textbox("getValue");},setReason:function(value){this.reason.textbox("setValue",value);},getAllowed:function(){return(/^true$/i).test(this.allowed.filter(":checked").val());},setAllowed:function(value){this.allowed.filter("[value="+Boolean(value)+"]").prop("checked",true);}});jscape.domain.AddIpAccessController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var rule=this._createRule(dialog);return this.deferred.resolve(rule);},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createRule:function(dialog){return new jscape.IpAccessRule(dialog.getMask().trim(),dialog.getReason(),dialog.getAllowed());},_setupDialog:function(){var dialog=new jscape.domain.IpAccessRuleDialog();dialog.setTitle(window.R.string.IP_ACCESS_DIALOG_ADD_TITLE);dialog.setAllowed(true);return dialog;}});jscape.domain.EditIpAccessController=Class.extend({deferred:null,start:function(rule){this.deferred=$.Deferred();this._setupDialog(rule).show(this);return this.deferred.promise();},onSubmit:function(dialog){var rule=this._createRule(dialog);return this.deferred.resolve(rule);},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createRule:function(dialog){return new jscape.IpAccessRule(dialog.getMask().trim(),dialog.getReason(),dialog.getAllowed());},_setupDialog:function(rule){var dialog=new jscape.domain.IpAccessRuleDialog();dialog.setTitle(window.R.string.IP_ACCESS_DIALOG_EDIT_TITLE);dialog.setMask(rule.mask);dialog.setReason(rule.reason);dialog.setAllowed(rule.allowed);return dialog;}});jscape.domain.DeleteIpAccessController=Class.extend({start:function(rules){var text=$.map(rules,function(rule){return rule.mask;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.IP_ACCESS_CONFIRM_DELETE_TITLE,window.R.string.IP_ACCESS_CONFIRM_DELETE_MESSAGE.supplant({0:text}));}});