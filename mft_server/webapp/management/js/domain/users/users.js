/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.AccountInfo=Class.extend({initialize:function(a,b,c,d,e,f,g){this.name=a||"";this.login=b||"";this.owner=c||"";this.company=d||"";this.administrator=!!e||false;this.lastLoginDate=parseInt(f)||null;this.tags=g||[];}});jscape.AccountInfo.fromJSON=function(data){return data?new jscape.AccountInfo(data.name,data.login,data.owner,data.company,data.administrator,data.lastLoginDate,data.tags):null;};jscape.Account=Class.extend({initialize:function(){this.username="";this.login="";this.emailAddress="";this.company=null;this.phone=null;this.owner="";this.expirationDate=null;this.enabled=true;this.secured=false;this.groups=[];this.allowedProtocols=null;this.bindedKeys=[];this.resources=[];this.passwordChangingAllowed=false;this.emailFileTransferAllowed=false;this.adHocTransferPermissions=[];this.usePhoneAuthentication=false;this.ignorePasswordAgingRules=false;this.quotas=new jscape.AccountTransferQuotas();this.ipAccessVerifier=new jscape.IpAccessVerifier();this.administration=null;this.webOptions=new jscape.WebOptions();this.sftpPublicKeyAuthenticationRequired=false;this.notes="";this.tags=[];},toJSON:function(){return $.extend({},this,{quotas:undefined,webOptions:undefined},JSON.parse(JSON.stringify(this.quotas)),JSON.parse(JSON.stringify(this.webOptions)),{company:this.company?{name:this.company}:null,expirationDate:this.expirationDate?this.expirationDate.getTime():null});}});jscape.Account.fromJSON=function(data){return $.extend(new jscape.Account(),data,{company:data.company&&data.company.name?data.company.name:null,phone:jscape.Phone.fromJSON(data.phone),groups:$.isArray(data.groups)?data.groups:[],allowedProtocols:$.isArray(data.allowedProtocols)?data.allowedProtocols:null,expirationDate:$.isNumeric(data.expirationDate)?new Date(data.expirationDate):null,resources:$.map(data.resources||[],jscape.VirtualFile.fromJSON),ipAccessVerifier:jscape.IpAccessVerifier.fromJSON(data.ipAccessVerifier),adHocTransferPermissions:$.isArray(data.adHocTransferPermissions)?data.adHocTransferPermissions:[],administration:jscape.DomainAdministration.fromJSON(data.administration),quotas:jscape.AccountTransferQuotas.fromJSON(data),webOptions:jscape.WebOptions.fromJSON(data),notes:data.notes||"",tags:$.isArray(data.tags)?data.tags:[]});};jscape.domain.UsersModule=jscape.domain.DomainModule.extend({initialize:function(uca){this.uca=uca;},onCreate:function(_,app){this._super.apply(this,arguments);this.controller=new jscape.domain.AccountsController();this.controller.onCreate(this.domainName,this.uca);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.UserTemplatesModule=jscape.domain.DomainModule.extend({initialize:function(uca){this.uca=uca;},onCreate:function(_,app){this._super.apply(this,arguments);this.controller=new jscape.domain.AccountTemplatesController();this.controller.onCreate(this.domainName);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.AccountsController=jscape.ui.DatagridController.extend({view:null,variables:null,initialize:function(){this._initValidators();this.variables=[];},onCreate:function(domainName,uca){this.domainName=domainName;this.addController=new jscape.domain.AddAccountController(uca);this.editController=new jscape.domain.EditAccountController(uca);this.deleteController=new jscape.domain.DeleteAccountController(uca);this.copyController=new jscape.domain.CopyAccountController(uca);this.checkQuotaController=new jscape.domain.CheckQuotaController();this.reportController=new jscape.domain.UserReportController();this.emailController=new jscape.domain.EmailUsersController();this.importController=new jscape.domain.ImportAccountsController(uca);this.exportController=new jscape.domain.ExportAccountsController();this.promoteController=new jscape.domain.PromoteAccountsController(uca);},onStart:function(){if(this.view==null){this.view=new jscape.domain.AccountsView();jscape.API.getAccountVariables(this.domainName).then($.proxy(function(items){this.variables=items||[];},this));}
this.view.show(this);},onResume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listAccounts(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onAddAccount:function(){this.addController.start(this.domainName,this.variables).done($.proxy(this._accountAdded,this));},onCopyAccount:function(account){this.copyController.start(this.domainName,account.login).done($.proxy(this._accountCopied,this));},onEditAccount:function(account,force){var index=$.inArray(account,this.view.getAccounts());if(index!=-1||force===true){this.editController.start(this.domainName,account.login,this.variables).done($.proxy(this._accountEdited,this,index));}},onDeleteAccount:function(accounts){this.deleteController.start(this.domainName,accounts).done($.proxy(this._accountDeleted,this,accounts));},onCheckAccountQuotas:function(account){return this.checkQuotaController.start(this.domainName,account.login);},onAccountsReport:function(){this.reportController.start(this.domainName);},onSendEmail:function(){return this.emailController.start(this.domainName);},onImportAccounts:function(data){return this.importController.start(this.domainName,data).always($.proxy(function(){this.view.refresh();},this));},onExportAccounts:function(accounts){var names=$.map(accounts,function(account){return account.login;});return this.exportController.start(this.domainName,names);},onPromoteAccounts:function(accounts){var names=$.map(accounts,function(account){return account.login;});return this.promoteController.start(this.domainName,names).done($.proxy(this._fireApplySuccess,this));},_accountAdded:function(account){this._recordAdded(account);},_accountEdited:function(index,account){this._recordEdited(account);},_accountCopied:function(account,editAfterDone){if(editAfterDone){this.view.refresh($.proxy(function(){this.view.selectRecord(account);this.onEditAccount(account,true);},this));}else{this._accountAdded(account);}},_accountDeleted:function(accounts){this._recordDeleted(accounts);},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("user_login_nonempty",window.R.string.USERS_ERROR_BAD_LOGIN);v.rule("user_unique",$.proxy(this._accountNotExists,this),window.R.string.USERS_ERROR_ALREADY_EXIST);v.rule("user_login_compliance",$.proxy(this._usernameCompliant,this),window.R.string.USERS_ERROR_USERNAME_NON_COMPLIANT);v.rule("user_password_compliance",$.proxy(this._passwordCompliant,this),"");v.rule("user_password_confirm",$.proxy(this._passwordConfirmed,this),window.R.string.USERS_ERROR_CONFIRM_PWD);},_accountNotExists:function(login){var values=$.map(this.view.getAccounts(),function(account){return account.login.toUpperCase();});return $.inArray((login||"").toUpperCase(),values)==-1;},_usernameCompliant:function(value){var result=jscape.API.testUsernameCompliance(this.domainName,value);if($.isPlainObject(result)){if(result.valid===false){if(result.message){new jscape.Validator().ruleMessage("user_login_compliance",result.message);}
return false;}}
return true;},_passwordCompliant:function(value,params){var username=(params||[])[0]||null;var result=jscape.API.testPasswordCompliance(this.domainName,username,value);if($.isPlainObject(result)){if(result.valid===false){if(result.message){new jscape.Validator().ruleMessage("user_password_compliance",result.message);}
return false;}}
return true;},_passwordConfirmed:function(value,params){return params&&params.length&&$(params[0]).val()==value;}});jscape.domain.AccountsView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#domain-users-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=users]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,sortName:"name",idField:"login",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"20%"},{field:"login",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"20%"},{field:"lastLoginDate",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,align:"right",formatter:$.proxy(this._formatDate,this),finder:"datetimebox",width:"15%"},{field:"owner",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"13%"},{field:"company",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,width:"10%"},{field:"administrator",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,formatter:$.proxy(this._formatAdministration,this),styler:$.proxy(this._styleAdministration,this),finder:{type:"combobox",options:{data:$.map([true,false],$.proxy(function(val){return{text:!!val?"yes":"no",value:val};},this)),width:100,panelHeight:"auto"}},width:"7%"},{field:"tags",title:$("thead th:nth-child(7)",this.data).text(),sortable:false,formatter:$.proxy(this._formatTags,this),width:"15%"}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this._initDragAndDrop(this.data.datagrid("getPanel"));this.reportButton=$("a[role=button][name=report]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ReportButton,this)});this.emailButton=$("a[role=button][name=email]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EmailButton,this)});this.quotasButton=$("a[role=button][name=quotas]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$QuotasButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.copyButton=$("a[role=button][name=copy]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyButton,this)});this.importButton=$("a[role=button][name=import]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ImportButton,this)});this.exportButton=$("a[role=button][name=export]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExportButton,this)});this.promoteButton=$("a[role=button][name=promote]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PromoteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.AccountsView.LISTENER;this._adjustState();},getAccounts:function(){return this.getRecords();},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onClick$AddButton:function(){this.listener.onAddAccount();},_onClick$EditButton:function(){this.listener.onEditAccount(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteAccount(this.selection);},_onClick$CopyButton:function(){this.listener.onCopyAccount(this.selection[0]);},_onClick$QuotasButton:function(){this.quotasButton.linkbutton("disable");this.listener.onCheckAccountQuotas(this.selection[0]).always($.proxy(this._adjustState,this));},_onClick$ReportButton:function(){this.listener.onAccountsReport();},_onClick$EmailButton:function(){this.emailButton.linkbutton("disable");this.listener.onSendEmail().always($.proxy(function(){this.emailButton.linkbutton("enable");},this));},_onClick$ImportButton:function(data){this.importButton.linkbutton("disable");this.listener.onImportAccounts(data).always($.proxy(function(){this.importButton.linkbutton("enable");},this));},_onClick$ExportButton:function(){this.exportButton.linkbutton("disable");this.listener.onExportAccounts(this.selection).always($.proxy(function(){this.exportButton.linkbutton("enable");},this));},_onClick$PromoteButton:function(){this.promoteButton.linkbutton("disable");this.listener.onPromoteAccounts(this.selection).always($.proxy(function(){this.promoteButton.linkbutton("enable");},this));},_formatDate:function(value){return $.isNumeric(value)?new Date(value).toLocaleString():"";},_formatAdministration:function(value){return!!value?"yes":"";},_styleAdministration:function(value){return!!value?"color:green;font-weight:bold":"";},_formatTags:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();},_createDropArea:function(e){this._super(e,window.R.string.USERS_IMPORT_TITLE);},_onDrop:function(e){this._onClick$ImportButton(e.originalEvent.dataTransfer);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.copyButton,this.deleteButton,"-",this.quotasButton,"-",this.reportButton,this.emailButton,"-",this.importButton,this.exportButton,this.promoteButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");this.emailButton.linkbutton(this.data.datagrid("getRows").length!=0?"enable":"disable");this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.copyButton.linkbutton(this.selection.length==1?"enable":"disable");this.quotasButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");this.exportButton.linkbutton(this.selection.length!=0?"enable":"disable");this.promoteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.domain.AccountsView.LISTENER={onLoadData:$.noop,onAddAccount:$.noop,onCopyAccount:$.noop,onEditAccount:$.noop,onDeleteAccount:$.noop,onCheckAccountQuotas:$.noop,onAccountsReport:$.noop,onSendEmail:$.noop,onImportAccounts:$.noop,onExportAccounts:$.noop,onPromoteAccounts:$.noop};jscape.domain.AddAccountController=Class.extend({DEFAULT_TEMPLATE_NAME:"Default",infoController:null,vfsController:null,quotasController:null,ipAccessController:null,domainAdminController:null,webController:null,deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,variables){this.domainName=domainName;this.variables=variables;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{jscape.API.getAccountTemplateNames(this.domainName).then($.proxy(function(templates){if(templates&&templates.length){return this._selectAccountTemplate(templates);}else{this._showNoAccountTemplatesError();return $.Deferred().reject().promise();}},this),$.proxy(this._showNoAccountTemplatesError,this)).then($.proxy(function(templateName){return jscape.API.getAccountTemplate(this.domainName,templateName);},this)).done($.proxy(function(template){this._setupDialog(template).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},onSubmit:function(dialog){var account=this._createAccount(dialog);return this._rootPathPresent(account).then($.proxy(function(){return jscape.API.addAccount(this.domainName,account).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;this._cleanup();},this));},this),$.proxy(this._showRootNotFoundError,this));},onCancel:function(dialog){dialog.destroy();this._cleanup();this.deferred.reject();this.deferred=null;},_selectAccountTemplate:function(templateNames){var deferred=$.Deferred();var dialog=new jscape.domain.UserTemplateDialog(templateNames.sort());dialog.selectItem(this.DEFAULT_TEMPLATE_NAME);dialog.show({onSubmit:function(dialog){var templateName=dialog.getTemplate();dialog.destroy();deferred.resolve(templateName);deferred=null;},onCancel:function(dialog){dialog.destroy();deferred.reject();deferred=null;}});return deferred.promise();},_setupDialog:function(template){var dialog=new jscape.domain.AddAccountDialog();this._createView(dialog);window.setTimeout($.proxy(function(){try{this._setupView(template);}catch(e){dialog.destroy();this._cleanup();}finally{dialog=null;}},this),0);return dialog;},_createView:function(dialog){this._cleanup();this.infoController=new jscape.domain.AddUserInfoController(dialog);this.vfsController=new jscape.vfs.VirtualFilesController(dialog);this.quotasController=new jscape.domain.QuotasController(dialog);this.ipAccessController=new jscape.domain.UserIpAccessController(dialog);this.domainAdminController=new jscape.domain.DomainAdministrationController(dialog,this.vfsController);this.webController=new jscape.domain.WebOptionsController(dialog);},_setupView:function(template){this.infoController.start(this.domainName,template);this.vfsController.start(this.domainName,template.resources,this.variables);this.quotasController.start(template.quotas);this.ipAccessController.start(template.ipAccessVerifier);this.domainAdminController.start(this.domainName,template.administration);this.webController.start(template.webOptions);},_createAccount:function(dialog){var account=this.infoController.createAccount();return $.extend(account,{resources:this.vfsController.getDescriptors(),quotas:this.quotasController.getQuotas(),ipAccessVerifier:this.ipAccessController.getIpAccess(),administration:this.domainAdminController.getDomainAdministration(),webOptions:this.webController.getWebOptions()});},_rootPathPresent:function(account){function rootPathExists(resources){return new jscape.Validator().isSatisfied("vfs_root_found",resources);}
var deferred=$.Deferred();if(rootPathExists(account.resources)){deferred.resolve();}else if(account.groups.length!=0){$.when.apply(jQuery,$.map(account.groups,$.proxy(function(groupName){return jscape.API.getGroup(this.domainName,groupName);},this))).done(function(){for(var i=0;i<arguments.length;i++){if(rootPathExists(arguments[i].resources)){deferred.resolve();break;}}
deferred.reject();}).fail($.proxy(function(){deferred.reject();},this));}else{deferred.reject();}
return deferred.promise();},_showRootNotFoundError:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.VFS_ERROR_ROOT_PATH_NOT_FOUND,"error");},_showNoAccountTemplatesError:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.USERS_ERROR_NO_TEMPLATES,"error");},_cleanup:function(){this.infoController=null;this.vfsController=null;this.quotasController=null;this.ipAccessController=null;this.domainAdminController=null;this.webController=null;}});jscape.domain.EditAccountController=Class.extend({infoController:null,vfsController:null,quotasController:null,ipAccessController:null,domainAdminController:null,webController:null,deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,accountName,variables){this.domainName=domainName;this.accountName=accountName;this.variables=variables;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{jscape.API.getAccount(this.domainName,this.accountName).done($.proxy(function(account){this.account=account;this._setupDialog(account).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},hasChanged:function(dialog){return!!this.account&&!Object._equals(this.account,this._createAccount(dialog));},onSubmit:function(dialog){var account=this._createAccount(dialog);return this._rootPathPresent(account).then($.proxy(function(){return jscape.API.setAccount(this.domainName,this.accountName,account).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;this._cleanup();},this));},this),$.proxy(this._showMessageRootNotFound,this));},onCancel:function(dialog){dialog.destroy();this._cleanup();this.deferred.reject();},onAccountChanged:function(){jscape.API.getAccount(this.domainName,this.accountName).done($.proxy(function(account){account=$.extend(account,this._createAccount());this._setupView(account);},this));},_setupDialog:function(account){var dialog=new jscape.domain.EditAccountDialog();dialog.setAccountName(this.accountName);this._createView(dialog);window.setTimeout($.proxy(function(){try{this._setupView(account);}catch(e){dialog.destroy();this._cleanup();}finally{dialog=null;}},this),0);return dialog;},_createView:function(dialog){this._cleanup();this.infoController=new jscape.domain.EditUserInfoController(dialog);this.vfsController=new jscape.vfs.VirtualFilesController(dialog);this.quotasController=new jscape.domain.QuotasController(dialog);this.ipAccessController=new jscape.domain.UserIpAccessController(dialog);this.domainAdminController=new jscape.domain.DomainAdministrationController(dialog,this.vfsController);this.webController=new jscape.domain.WebOptionsController(dialog);},_setupView:function(account){this.infoController.start(this,this.domainName,account);this.vfsController.start(this.domainName,account.resources,this.variables);this.quotasController.start(account.quotas);this.ipAccessController.start(account.ipAccessVerifier);this.domainAdminController.start(this.domainName,account.administration);this.webController.start(account.webOptions);},_createAccount:function(){var account=this.infoController.createAccount();return $.extend(account,{resources:this.vfsController.getDescriptors(),quotas:this.quotasController.getQuotas(),ipAccessVerifier:this.ipAccessController.getIpAccess(),administration:this.domainAdminController.getDomainAdministration(),webOptions:this.webController.getWebOptions()});},_rootPathPresent:function(account){function rootPathExists(resources){return new jscape.Validator().isSatisfied("vfs_root_found",resources);}
var deferred=$.Deferred();if(rootPathExists(account.resources)){deferred.resolve();}else if(account.groups.length!=0){$.when.apply(jQuery,$.map(account.groups,$.proxy(function(groupName){return jscape.API.getGroup(this.domainName,groupName);},this))).done(function(){for(var i=0;i<arguments.length;i++){if(rootPathExists(arguments[i].resources)){deferred.resolve();break;}}
deferred.reject();}).fail($.proxy(function(){deferred.reject();},this));}else{deferred.reject();}
return deferred.promise();},_cleanup:function(){this.infoController=null;this.vfsController=null;this.quotasController=null;this.ipAccessController=null;this.domainAdminController=null;this.webController=null;},_showMessageRootNotFound:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.VFS_ERROR_ROOT_PATH_NOT_FOUND,"error");}});jscape.domain.DeleteAccountController=Class.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,accounts){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._confirmDelete(accounts).done($.proxy(this._deleteConfirmed,this,accounts)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},_confirmDelete:function(accounts){var text=$.map(accounts,function(user){return user.login;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.USERS_CONFIRM_DELETE_TITLE,window.R.string.USERS_CONFIRM_DELETE_MESSAGE.supplant({0:text}));},_deleteConfirmed:function(accounts){$.when.apply(jQuery,$.map(accounts,$.proxy(function(account){return jscape.API.deleteAccount(this.domainName,account.login);},this))).done($.proxy(function(){this.deferred.resolve(accounts);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});jscape.domain.CopyAccountController=Class.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,accountName){this.domainName=domainName;this.accountName=accountName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog().show(this);}
return this.deferred.promise();},onSubmit:function(dialog){var newLogin=dialog.getLogin();var editAfterDone=dialog.isEditAfterDone();return jscape.API.copyAccount(this.domainName,this.accountName,newLogin).done($.proxy(function(info){this.deferred.resolve(info,editAfterDone);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.CopyAccountDialog();dialog.setAccountName(this.accountName);dialog.setEditAfterDone(true);return dialog;}});jscape.domain.CheckQuotaController=Class.extend({start:function(domainName,accountName){this.domainName=domainName;this.accountName=accountName;this.deferred=$.Deferred();this._setupDialog(accountName).show(this);return this.deferred.promise();},onLoadData:function(dialog){return jscape.API.getAccountQuotas(this.domainName,this.accountName).catch(function(){return null;}).done(function(data){var quota=data?data:{};dialog.setDownloadsQuota(quota.downloadsQuota);dialog.setUploadsQuota(quota.uploadsQuota);dialog.setTransfersQuota(quota.transfersQuota);});},onSubmit:function(){return this.deferred.resolve();},_setupDialog:function(accountName){var dialog=new jscape.domain.CheckQuotaDialog();dialog.setAccountName(accountName);return dialog;}});jscape.domain.UserTemplateDialog=jscape.ui.DefaultDialog.extend({initialize:function(names){this._super($("#d-user-add-usertemplate"),{width:"40%",minWidth:500,minHeight:230});this.template=$("select[name=template]",this.fieldset).combobox({required:true,editable:true,limitToList:true,data:names||[],width:"65%",panelHeight:"auto",panelMaxHeight:"50%"});this.template.combobox("textbox").on("focus",function(){$(this).select();});},show:function(listener){this._super(listener);this.template.combobox("textbox").focus();},getTemplate:function(){return this.template.combobox("getValue");},selectItem:function(value){this.template.combobox("select",value);}});jscape.domain.AddAccountDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-user-add"),{width:"75%",height:"90%",minHeight:600,maximizable:true});this.tabs=$("div[role=tablist]",this.dialog).tabs({fit:true,plain:true,tabPosition:"top",minHeight:"80%"});},_valid:function(){return true;},_onSubmit:function(e){if(e&&!!e.__submitConfirmed){return this._super.apply(this,arguments);}
var self=this;var btn=this._defaultButton();if(e&&!e.defaultPrevented&&btn){e.preventDefault();e.stopPropagation();btn.linkbutton("disable");$.Deferred(function(d){if(new jscape.Validator().validateTabs(self.tabs,false)){d.resolve();}else{d.reject();}}).done(function(){setTimeout(function(){btn.linkbutton("enable").triggerHandler($.Event(e,{__submitConfirmed:true}));},50);}).fail(function(){btn.linkbutton("enable");});}
return $.Deferred().reject().promise();}});jscape.domain.EditAccountDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-user-edit"),{width:"75%",height:"90%",minHeight:750,maximizable:true});this.tabs=$("div[role=tablist]",this.dialog).tabs({fit:true,plain:true,tabPosition:"top",minHeight:"80%"});this.title=this.dialog.dialog("header").text()||"";},setAccountName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));},show:function(listener){this._super(listener);this.dialog.dialog("resize");},_valid:function(){return new jscape.Validator().validateTabs(this.tabs,false);}});jscape.domain.CopyAccountDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-user-copy"),{width:"50%",minWidth:570,minHeight:280});this.title=this.dialog.dialog("header").text();this.login=$("[name=login]",this.fieldset);this.login.textbox({required:true,delay:1500,validateOnBlur:true,validType:["user_login_nonempty","user_unique","user_login_compliance"],validParams:[{selector:$.proxy(function(){return this.login.textbox("textbox");},this)}],missingMessage:window.R.string.USERS_ERROR_BAD_LOGIN,width:"60%"});this.editAfterDone=$("input[name=editafterdone]:checkbox",this.fieldset);},getLogin:function(){return this.login.textbox("getValue");},setAccountName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));},isEditAfterDone:function(){return this.editAfterDone.is(":checked");},setEditAfterDone:function(value){this.editAfterDone.prop("checked",!!value);},show:function(listener){this._super(listener);this.login.textbox("textbox").focus();}});jscape.domain.CheckQuotaDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-user-quota"),{width:450,minHeight:260,buttons:[{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onSubmit,this)}],closable:false});this.downloadQuota=$("[aria-label=dloadquota]",this.dialog);this.uploadQuota=$("[aria-label=uploadquota]",this.dialog);this.transferQuota=$("[aria-label=transferquota]",this.dialog);this.title=this.dialog.dialog("header").text();},show:function(listener){this._super(listener);this.listener.onLoadData(this);},setAccountName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));},setDownloadsQuota:function(quota){this.downloadQuota.prop("readonly",false).text(this._formatQuota(quota)).prop("readonly",true);},setUploadsQuota:function(quota){this.uploadQuota.prop("readonly",false).text(this._formatQuota(quota)).prop("readonly",true);},setTransfersQuota:function(quota){this.transferQuota.prop("readonly",false).text(this._formatQuota(quota)).prop("readonly",true);},_formatQuota:function(quota){if(!!quota){var f=new jscape.SizeFormat();return window.R.string.USERS_QUOTA_TEMPLATE.supplant({0:f.format(quota.transferredBytes),1:f.format(quota.bytes)});}
return window.R.string.USERS_QUOTA_NONE;}});jscape.domain.BaseUserInfoController=Class.extend({onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},onLoadGroups:function(){return jscape.API.getGroupNames(this.domainName);},onLoadClientKeys:function(){return $.when(jscape.API.getClientPublicKeys(this.domainName),jscape.API.getClientCertificates(this.domainName)).then(function(publicKeys,certificates){publicKeys=$.map(publicKeys,function(key){return key.name;});certificates=$.map(certificates,function(key){return key.name;});return publicKeys.concat(certificates);});},onAdHocSettings:function(view){return new jscape.domain.AdHocTransferPermissionsController().start(view.getAdHocTransferPermissions()).done(function(data){view.setAdHocTransferPermissions(data);view.setAllowAdHocTransfers(data&&data.length!=0);});}});jscape.domain.AddUserInfoController=jscape.domain.BaseUserInfoController.extend({initialize:function(dialog){this.view=new jscape.domain.AddUserInfoView(dialog);},start:function(domainName,template){this.domainName=domainName;this.view.show(this);this._setupView(template);},createAccount:function(){var account=new jscape.Account();account.login=this.view.getLogin();account.password=this.view.getPassword();account.username=this.view.getUsername();account.emailAddress=this.view.getEmail();account.company=this.view.getCompany()?this.view.getCompany():null;account.phone=this.view.getPhoneCode()!=null||this.view.getPhoneNumber()!=null?new jscape.Phone(this.view.getPhoneCode(),this.view.getPhoneNumber(),this.view.getPhoneExtension()):null;account.bindedKeys=this.view.getClientKeys();account.groups=this.view.getGroups();account.allowedProtocols=this.view.getProtocols();account.owner=this.view.getOwner();account.expirationDate=this.view.getExpirationDate();account.enabled=this.view.getEnabled();account.secured=this.view.getSecured();account.usePhoneAuthentication=this.view.getUseMultiFactorAuthentication();account.passwordChangingAllowed=this.view.getAllowPasswordChanging();account.emailFileTransferAllowed=this.view.getAllowAdHocTransfers();account.adHocTransferPermissions=this.view.getAdHocTransferPermissions();account.ignorePasswordAgingRules=this.view.getIgnorePasswordAgingRules();account.sftpPublicKeyAuthenticationRequired=this.view.isSftpPublicKeyAuthRequired();account.notes=this.view.getNotes();account.tags=this.view.getTags();return account;},_setupView:function(template){if(template){this.view.setUsername(template.username);this.view.setEmail(template.emailAddress);this.view.setCompany(template.company!=null?template.company.name:"");}
if(template&&template.phone!=null){this.view.setPhoneCode(template.phone.code);this.view.setPhoneNumber(template.phone.number);this.view.setPhoneExtension(template.phone.extension);}
if(template.expirationDate!=null){this.view.setExpirationDate(template.expirationDate);}else if(template.expirationPeriodMillis!=null){this.view.setExpirationDate(new Date($.now()+template.expirationPeriodMillis));}
this.view.setEnabled(template.enabled);this.view.setSecured(template.secured);this.view.setUseMultiFactorAuthentication(template.usePhoneAuthentication);this.view.setSftpPublicKeyAuthRequired(template.sftpPublicKeyAuthenticationRequired);this.view.setAllowAdHocTransfers(template.emailFileTransferAllowed);this.view.setAdHocTransferPermissions(template.adHocTransferPermissions);this.view.setAllowPasswordChanging(template.passwordChangingAllowed);this.view.setIgnorePasswordAgingRules(template.ignorePasswordAgingRules);if(template){this.view.setClientKeys(template.bindedKeys||[]);this.view.setGroups(template.groups||[]);this.view.setProtocols(template.allowedProtocols);this.view.setTags(template.tags);}
jscape.API.getAccountAdminNames(this.domainName).done($.proxy(function(owners){this.view.setAvailableOwners(owners);template&&this.view.setOwner(template.owner);},this));}});jscape.domain.EditUserInfoController=jscape.domain.BaseUserInfoController.extend({initialize:function(dialog){this.view=new jscape.domain.EditUserInfoView(dialog);},start:function(listener,domainName,account){this.listener=listener;this.domainName=domainName;this.account=account;this.view.show(this);this._setupView(account);},createAccount:function(){var account=$.extend(new jscape.Account(),this.account);account.username=this.view.getUsername();account.emailAddress=this.view.getEmail();account.company=this.view.getCompany()?this.view.getCompany():null;account.phone=$.isNumeric(this.view.getPhoneCode())?new jscape.Phone(this.view.getPhoneCode(),this.view.getPhoneNumber(),this.view.getPhoneExtension()):null;account.bindedKeys=this.view.getClientKeys();account.groups=this.view.getGroups();account.allowedProtocols=this.view.getProtocols();account.owner=this.view.getOwner();account.expirationDate=this.view.getExpirationDate();account.enabled=this.view.getEnabled();account.secured=this.view.getSecured();account.usePhoneAuthentication=this.view.getUseMultiFactorAuthentication();account.passwordChangingAllowed=this.view.getAllowPasswordChanging();account.emailFileTransferAllowed=this.view.getAllowAdHocTransfers();account.adHocTransferPermissions=this.view.getAdHocTransferPermissions();account.ignorePasswordAgingRules=this.view.getIgnorePasswordAgingRules();account.sftpPublicKeyAuthenticationRequired=this.view.isSftpPublicKeyAuthRequired();account.notes=this.view.getNotes();account.tags=this.view.getTags();return account;},onChangePassword:function(){var controller=new jscape.domain.ChangePasswordController();return controller.start(this.domainName,this.account.login).done($.proxy(function(){this.listener.onAccountChanged();},this));},onResetTotpKey:function(){return jscape.API.resetAccountTotp(this.domainName,this.account.login).done($.proxy(function(){this._showMessageTotpKeyReset();this.listener.onAccountChanged();},this));},_setupView:function(account){if(account){this.view.setUsername(account.username);this.view.setEmail(account.emailAddress);this.view.setCompany(account.company!=null?account.company:"");if(account.phone!=null){this.view.setPhoneCode(account.phone.code);this.view.setPhoneNumber(account.phone.number);this.view.setPhoneExtension(account.phone.extension);}
this.view.setExpirationDate(account.expirationDate);this.view.setEnabled(account.enabled);this.view.setSecured(account.secured);this.view.setUseMultiFactorAuthentication(account.usePhoneAuthentication);this.view.setSftpPublicKeyAuthRequired(account.sftpPublicKeyAuthenticationRequired);this.view.setAllowAdHocTransfers(account.emailFileTransferAllowed);this.view.setAdHocTransferPermissions(account.adHocTransferPermissions);this.view.setAllowPasswordChanging(account.passwordChangingAllowed);this.view.setIgnorePasswordAgingRules(account.ignorePasswordAgingRules);this.view.setGroups(account.groups);this.view.setProtocols(account.allowedProtocols);this.view.setClientKeys(account.bindedKeys);this.view.setNotes(account.notes);this.view.setTags(account.tags);}
jscape.API.getAccountAdminNames(this.domainName).done($.proxy(function(owners){this.view.setAvailableOwners(owners);account&&this.view.setOwner(account.owner);},this));},_showMessageTotpKeyReset:function(){$.messager.alert("",window.R.string.USERS_SUCCESS_RESET_TOTP,"info");}});jscape.domain.BaseUserInfoView=jscape.domain.UserInfoView.extend({initialize:function(fieldset){this._super(fieldset);this.expires=$("input[name=expires]",this.fieldset).change($.proxy(function(){var enabled=this.expires.is(":checked");this.expirationDate.datetimebox(enabled?"enable":"disable").datetimebox(enabled?"enableValidation":"disableValidation");},this));this.expirationDate=$("input[name=expirationdate]",this.fieldset).datetimebox({required:true,editable:false,disabled:true,showSeconds:false,width:150,formatter:$.proxy(this._formatDate,this),parser:$.proxy(this._parseDate,this)});this.expirationDate.datetimebox("calendar").calendar({validator:function(date){var now=new Date();now.setHours(date.getHours());now.setMinutes(date.getMinutes());now.setSeconds(date.getSeconds());now.setMilliseconds(date.getMilliseconds());return now.getTime()<=date.getTime();}});this.expirationDate.datetimebox("setDate",new Date());this.sftpPublicKeyAuth=$("input[name=sftppublickeyauth]:checkbox",this.fieldset);},getExpirationDate:function(){return this.expires.is(":checked:not(:disabled)")?this.expirationDate.datetimebox("getDate"):null;},setExpirationDate:function(value){if(value!=null){this.expires.prop("checked",true).change();this.expirationDate.datetimebox("setDate",value).datetimebox("enable");}else{this.expires.prop("checked",false).change();this.expirationDate.datetimebox("setDate",new Date());}},isSftpPublicKeyAuthRequired:function(){return this.sftpPublicKeyAuth.is(":checked");},setSftpPublicKeyAuthRequired:function(value){this.sftpPublicKeyAuth.prop("checked",!!value).change();},_formatDate:function(date){return jscape.DateFormat.format(date,"{MM}/{dd}/{yy} {hh}:{mm}");},_parseDate:function(str){var matches=/(\d{1,2})\/(\d{1,2})\/(\d{2,4})\s(\d{2}):(\d{2})/.exec(str);if(matches!=null&&matches.length==6){var m=parseInt(matches[1],10),d=parseInt(matches[2],10),y=parseInt(matches[3],10),h=parseInt(matches[4],10),min=parseInt(matches[5],10);if(!isNaN(m)&&!isNaN(d)&&!isNaN(y)&&!isNaN(h)&&!isNaN(min)){return new Date(y,m-1,d,h,min);}}
return new Date();}});jscape.domain.AddUserInfoView=jscape.domain.BaseUserInfoView.extend({initialize:function(dialog){this._super($("#userinfoaddfields"+dialog.getIdSuffix()));this.login=$("input[name=login]",this.fieldset).textbox({required:true,delay:1500,validateOnBlur:true,validType:["user_login_nonempty","user_unique","user_login_compliance"],validParams:[{selector:$.proxy(function(){return this.login.textbox("textbox");},this)}],missingMessage:window.R.string.USERS_ERROR_BAD_LOGIN,width:"60%"});var id="newpwd_"+(1E9*Math.random()>>>0);this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({validType:"user_password_confirm",validParams:["#"+id],missingMessage:window.R.string.USERS_ERROR_CONFIRM_PWD,tipPosition:"bottom",width:"70%"});this.password=$("input[name=password]",this.fieldset).attr("id",id).passwordbox2({delay:700,validateOnCreate:false,validateOnBlur:true,validType:"user_password_compliance",validParams:[{selector:function(){return $("#"+id).passwordbox2("textbox");}}],inputEvents:{input:$.proxy(function(cpb,e){var t=$(e.data.target).passwordbox2("getText");cpb.passwordbox2("textbox").validatebox("options").required=t.length!=0;(!t||!t.length)&&cpb.passwordbox2("isValid");},this,this.confirmPassword)},onBeforeValidate:$.proxy(function(){this.password&&this.confirmPassword.passwordbox2("isValid");},this),tipPosition:"bottom",width:"70%"});this.useMultiFactorAuth=$("input[name=multifactorauth]:checkbox",this.fieldset);$("a[role=button][name=resettotp]",this.fieldset).hide();},show:function(listener){this._super(listener);this._adjustPasswordOptions();},getLogin:function(){return this.login.textbox("getValue");},getPassword:function(){return this.password.passwordbox2("getValue");},getUseMultiFactorAuthentication:function(){return this.useMultiFactorAuth.is(":checked");},setUseMultiFactorAuthentication:function(value){this.useMultiFactorAuth.prop("checked",!!value);},_adjustPasswordOptions:function(){var opts=this.password.passwordbox2("textbox").validatebox("options");opts.required=!this.password.passwordbox2("isSatisfied");}});jscape.domain.EditUserInfoView=jscape.domain.BaseUserInfoView.extend({initialize:function(dialog){this._super($("#userinfoeditfields"+dialog.getIdSuffix()));this.changePasswordButton=$("a[role=button][name=changepwd]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ChangePasswordButton,this)});this.useMultiFactorAuth=$("input[name=multifactorauth]:checkbox",this.fieldset).change($.proxy(function(){var enabled=this.useMultiFactorAuth.is(":checked");this.resetTotpKeyButton.linkbutton(enabled?"enable":"disable");},this));this.resetTotpKeyButton=$("a[role=button][name=resettotp]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ResetTotpKeyButton,this)});this.useMultiFactorAuth.change();this.sftpPublicKeyAuth=$("input[name=sftppublickeyauth]:checkbox",this.fieldset);},getUseMultiFactorAuthentication:function(){return this.useMultiFactorAuth.is(":checked");},setUseMultiFactorAuthentication:function(value){this.useMultiFactorAuth.prop("checked",!!value).change();},_onClick$ChangePasswordButton:function(){this.changePasswordButton.linkbutton("disable");this.listener.onChangePassword(this).always($.proxy(function(){this.changePasswordButton.linkbutton("enable");},this));},_onClick$ResetTotpKeyButton:function(){this.resetTotpKeyButton.linkbutton("disable");this.listener.onResetTotpKey(this).always($.proxy(function(){this.resetTotpKeyButton.linkbutton("enable");},this));}});jscape.domain.EditUserInfoView.LISTENER=$.extend({onChangePassword:$.noop,onResetTotpKey:$.noop},jscape.domain.UserInfoView.LISTENER);jscape.domain.ChangePasswordController=Class.extend({deferred:null,start:function(domainName,accountName){this.domainName=domainName;this.accountName=accountName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.changeAccountPassword(this.domainName,this.accountName,dialog.getPassword(),dialog.isResetRequired()).done($.proxy(this._showPasswordChangedMessage,this)).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.ChangePasswordDialog();dialog.setAccountName(this.accountName);return dialog;},_showPasswordChangedMessage:function(){$.messager.alert(window.R.string.USERS_CHANGE_PASSWORD_TITLE,window.R.string.USERS_CHANGE_PASSWORD_MESSAGE,"info");}});jscape.domain.ChangePasswordDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-user-changepwd"),{width:630,minHeight:300,resizable:false});var id="newpwd_"+Object._nextId();this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({delay:1500,validType:"user_password_confirm",validParams:["#"+id],missingMessage:window.R.string.USERS_ERROR_CONFIRM_PWD,tipPosition:"bottom",width:"70%"});this.password=$("input[name=password]",this.fieldset).attr("id",id).passwordbox2({validateOnCreate:false,validateOnBlur:true,delay:5000,interval:5000,validType:"user_password_compliance",validParams:[{selector:function(){return $("#"+id).passwordbox2("textbox");}}],inputEvents:{input:$.proxy(function(cpb,e){var t=$(e.data.target).passwordbox2("getText");cpb.passwordbox2("textbox").validatebox("options").required=t.length!=0;(!t||!t.length)&&cpb.passwordbox2("isValid");},this,this.confirmPassword)},onBeforeValidate:$.proxy(function(){this.password&&this.confirmPassword.passwordbox2("isValid");},this),tipPosition:"bottom",width:"70%"});this.resetRequired=$("input[name=resetrequired]",this.fieldset);},show:function(listener){this._super(listener);this._adjustPasswordOptions();},setAccountName:function(value){var opts=this.password.passwordbox2("textbox").validatebox("options");opts.validParams=!!value?[String(value).escapeXml()]:[];},getPassword:function(){return this.password.passwordbox2("getValue");},isResetRequired:function(){return this.resetRequired.is(":checked");},_adjustPasswordOptions:function(){var opts=this.password.passwordbox2("textbox").validatebox("options");opts.required=!this.password.passwordbox2("isSatisfied");}});jscape.domain.UserReportController=Class.extend({deferred:null,start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var detailed=dialog.isDetailedView();dialog.destroy();this._openReport(detailed);this.deferred.resolve();this.deferred=null;},onCancel:function(dialog){dialog.destroy();this.deferred.resolve();this.deferred=null;},_openReport:function(detailed){var url=window.location.pathname+"/accounts-report"+(detailed?"?all=true":"");window.open(url,"jscape-report-users");},_setupDialog:function(){return new jscape.domain.UserReportParametersDialog();}});jscape.domain.UserReportParametersDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-users-reportparams"),{minWidth:530,width:"30%",minHeight:240,resizable:false});this.detailed=$("input[name=detailed]:checkbox",this.fieldset);},isDetailedView:function(){return this.detailed.is(":checked");}});jscape.domain.EmailUsersController=Class.extend({deferred:null,start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},_setupDialog:function(){return new jscape.EmailUsersDialog();},_sendEmail:function(subject,message){return jscape.API.sendAccountsEmail(this.domainName,subject,message).then(function(data){$(document).triggerHandler("broadcast",[window.R.string.USERS_SUCCESS_EMAIL_SENT.supplant({0:data})]);});},onSubmit:function(dialog){return this._sendEmail(dialog.getSubject(),dialog.getMessage()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;}});jscape.EmailUsersDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-users-email"),{width:"60%",height:490,resizable:false});this.fieldset=$("fieldset",this.dialog).panel({fit:true});this.subject=$("input[name=subject]",this.dialog).textbox({required:true,validType:"non_empty",width:"75%"});this.message=$("textarea[name=message]",this.dialog).textbox({required:true,multiline:true,validType:"non_empty",width:"75%",height:320});},getSubject:function(){return this.subject.textbox("getValue");},getMessage:function(){return this.message.textbox("getValue");},show:function(listener){this._super(listener);this.subject.textbox("textbox").focus();}});jscape.domain.ImportAccountsController=jscape.ui.DefaultImportController.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,data){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog(data).show(this);}
return this.deferred.promise();},onSubmit:function(dialog){var file=this.file?this.file:dialog.getFile();return jscape.API.importAccounts(this.domainName,file,dialog.isOverwrite()).done($.proxy(function(){this._showSuccessMessage();this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(data){var d=new jscape.domain.ImportAccountsDialog();this._listFileEntries(data,"file").done($.proxy(function(files){if(files&&files.length){this.file=files[0];d.setFilename(this.file.name);d=undefined;}},this));return d;},_showSuccessMessage:function(){$(document).triggerHandler("broadcast",window.R.string.USERS_SUCCESS_IMPORT);}});jscape.domain.ImportAccountsDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-users-import"),{width:"50%",minWidth:550,maxWidth:750,minHeight:280});this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",validateOnBlur:true,width:"60%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getFile:function(){var files=!this.file.filebox("options").disabled?this.file.filebox("files"):null;return files&&files.length?files[0]:null;},setFilename:function(value){if(!!value){this.file.filebox("setText",value).filebox("disable");}},isOverwrite:function(){return this.overwrite.is(":checked");}});jscape.domain.ExportAccountsController=Class.extend({deferred:null,start:function(domainName,names){this.domainName=domainName;this.names=names;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportAccounts(this.domainName,this.names,dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this))},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.ui.ExportDialog($("#d-users-export"));dialog.setFilename("users.txt");return dialog;}});jscape.domain.PromoteAccountsController=Class.extend({DEFAULT_PORT:10880,deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,names){this.domainName=domainName;this.names=names||[];this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog().show(this);}
return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.promoteAccounts(this.domainName,this._createData(dialog)).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this))},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return{names:this.names,host:dialog.getHost(),port:dialog.getPort(),username:dialog.getUsername(),password:dialog.getPassword(),domain:dialog.getDomain(),overwrite:dialog.isOverwrite()};},_setupDialog:function(){var dialog=new jscape.domain.PromoteAccountsDialog();dialog.setDomain(this.domainName);dialog.setPort(this.DEFAULT_PORT);return dialog;}});jscape.domain.PromoteAccountsDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-users-promote"),{width:"50%",minWidth:570,minHeight:400});this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"non_empty",width:"60%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,width:80});this.domain=$("input[name=domain]",this.fieldset).textbox({required:true,validType:"non_empty",validateOnBlur:true,width:"50%"});this.login=$("input[name=login]",this.fieldset).textbox({required:true,validType:"non_empty",validateOnBlur:true,width:"50%"});this.password=$("input[name=pwd]",this.fieldset).passwordbox2({lastDelay:0,validateOnBlur:true,width:"50%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getHost:function(){return this.host.textbox("getValue");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value));},getDomain:function(){return this.domain.textbox("getValue");},setDomain:function(value){this.domain.textbox("setValue",value);},getUsername:function(){return this.login.textbox("getValue");},getPassword:function(){return this.password.passwordbox2("getValue");},isOverwrite:function(){return this.overwrite.is(":checked");},show:function(listener){this._super(listener);this.host.textbox("textbox").focus();}});