/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.Contact=Class.extend({initialize:function(a,b,c,d,e,f){this.id=a||undefined;this.name=b||"";this.email=c||"";this.company=d||null;this.owner=e||null;this.tags=f||[];}});jscape.Contact.fromJSON=function(data){return data?new jscape.Contact(data.id,data.name,data.email,data.company,data.owner,data.tags):null;};jscape.domain.ContactsModule=jscape.domain.DomainModule.extend({initialize:function(cca){this.cca=cca;},onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.ContactsController();this.controller.onCreate(this.domainName,this.cca);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.ContactsController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this._initValidators();},onCreate:function(domainName,cca){this.domainName=domainName;this.addController=new jscape.domain.AddContactController(cca);this.editController=new jscape.domain.EditContactController(cca);this.deleteController=new jscape.domain.DeleteContactController(cca);this.importController=new jscape.domain.ImportContactsController(cca);},onStart:function(){if(this.view==null){this.view=new jscape.domain.ContactsView();}
this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listContacts(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onAddContact:function(){this.addController.start(this.domainName).done($.proxy(this._contactAdded,this));},onEditContact:function(contact){var index=$.inArray(contact,this.view.getContacts());if(index!=-1){this.editController.start(this.domainName,contact).done($.proxy(this._contactEdited,this,index));}},onDeleteContact:function(contacts){this.deleteController.start(this.domainName,contacts).done($.proxy(this._contactDeleted,this,contacts));},onImportContacts:function(data){return this.importController.start(this.domainName,data).always($.proxy(function(){this.view.refresh();},this));},_contactAdded:function(contact){this._recordAdded(contact);},_contactEdited:function(index,contact){this._recordEdited(contact);},_contactDeleted:function(contacts){this._recordDeleted(contacts);},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("contact_name_nonempty",window.R.string.CONTACTS_ERROR_BAD_NAME);}});jscape.domain.ContactsView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#contacts-list-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=contacts]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,sortName:"name",idField:"id",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),width:"20%",sortable:true},{field:"company",title:$("thead th:nth-child(2)",this.data).text(),width:"20%",sortable:true,sorter:function(a,b){return a==b?0:a==null||a<b?-1:1;}},{field:"email",title:$("thead th:nth-child(3)",this.data).text(),width:"25%",sortable:false},{field:"owner",title:$("thead th:nth-child(4)",this.data).text(),width:"15%",sortable:true,sorter:function(a,b){return a==b?0:a==null||a<b?-1:1;}},{field:"tags",title:$("thead th:nth-child(5)",this.data).text(),width:"20%",formatter:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();}}]],onSelect:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustRowSelection,this)});this._initDragAndDrop(this.data.datagrid("getPanel"));this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.importButton=$("a[role=button][name=import]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ImportButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.ContactsView.LISTENER;this.data.datagrid("resize");this._adjustRowSelection();},getContacts:function(){return this.getRecords();},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).done(success).fail(error);},_onClick$AddButton:function(){this.listener.onAddContact();},_onClick$EditButton:function(){this.listener.onEditContact(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteContact(this.selection);},_onClick$ImportButton:function(file){this.importButton.linkbutton("disable");this.listener.onImportContacts(file).always($.proxy(function(){this.importButton.linkbutton("enable");},this));},_createDropArea:function(e){this._super(e,window.R.string.CONTACTS_IMPORT_TITLE);},_onDrop:function(e){this._onClick$ImportButton(e.originalEvent.dataTransfer);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.importButton]);},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");this._adjustButtonsState();},_adjustButtonsState:function(){this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.domain.ContactsView.LISTENER={onRefresh:$.noop,onAddContact:$.noop,onEditContact:$.noop,onDeleteContact:$.noop,onImportContacts:$.noop};jscape.domain.BaseContactEditor=Class.extend({onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},onLoadOwners:function(){return jscape.API.getAccountNames(this.domainName).then(function(names){return names.sort();});},_createContact:function(dialog,id){return new jscape.Contact(id,dialog.getName(),dialog.getEmail(),dialog.getCompany(),dialog.getOwner(),dialog.getTags());}});jscape.domain.AddContactController=jscape.domain.BaseContactEditor.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog().show(this);}
return this.deferred.promise();},onSubmit:function(dialog){var contact=this._createContact(dialog,null);return jscape.API.addContact(this.domainName,contact).done($.proxy(function(contact){this.deferred.resolve(contact);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.domain.AddContactDialog();}});jscape.domain.EditContactController=jscape.domain.BaseContactEditor.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,contact){this.domainName=domainName;this.contactId=contact.id;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{jscape.API.getContact(domainName,this.contactId).done($.proxy(function(contact){this._setupDialog(contact).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},onSubmit:function(dialog){var contact=this._createContact(dialog,this.contactId);return jscape.API.setContact(this.domainName,this.contactId,contact).done($.proxy(function(){this.deferred.resolve(contact);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(contact){var dialog=new jscape.domain.EditContactDialog();dialog.setName(contact.name);dialog.setEmail(contact.email);dialog.setCompany(contact.company);dialog.setTags(contact.tags);dialog.setOwner(contact.owner);return dialog;}});jscape.domain.DeleteContactController=Class.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,contacts){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._confirmDelete(contacts).done($.proxy(this._deleteConfirmed,this,contacts)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},_confirmDelete:function(contacts){var text=$.map(contacts||[],function(contact){return contact.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.CONTACTS_CONFIRM_DELETE_TITLE,window.R.string.CONTACTS_CONFIRM_DELETE_MESSAGE.supplant({0:text}));},_deleteConfirmed:function(contacts){$.when.apply(jQuery,$.map(contacts,$.proxy(function(contact){return jscape.API.deleteContact(this.domainName,contact.id);},this))).done($.proxy(function(){this.deferred.resolve(contacts);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});jscape.domain.ContactDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog){var initializing=true;this._super(dialog,{width:"50%",resizable:false});this.fieldset=$("fieldset[name=contactfields]",this.dialog);this.name=$("[name=name]",this.fieldset).textbox({required:true,validType:"contact_name_nonempty",missingMessage:window.R.string.CONTACTS_ERROR_BAD_NAME,width:"60%"});this.email=$("[name=email]",this.fieldset).textbox({required:true,validType:"multi_value['email',',']",missingMessage:window.R.string.CONTACTS_ERROR_BAD_EMAIL,invalidMessage:window.R.string.CONTACTS_ERROR_BAD_EMAIL,width:"50%"});this.company=$("[name=company]",this.fieldset).textbox({width:"50%"});this.ownedBy=$("[name=ownedby]:checkbox",this.fieldset).on("change",$.proxy(this._adjustFieldState,this));this.owner=$("[name=owner]",this.fieldset).combobox({required:false,editable:true,limitToList:true,disabled:true,loader:$.proxy(this._onLoad$Owners,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(function(data){this.ownedBy.prop("disabled",(data?data.length:0)==0);},this),onLoadError:$.proxy(function(){this.ownedBy.prop("disabled",true).prop("checked",false);},this),width:"40%",panelHeight:"auto",panelMaxHeight:"50%"});this.tags=$("select[name=tags]",this.fieldset).tagbox({limitToList:jscape.acl&&!jscape.acl.tic,hasDownArrow:true,loader:$.proxy(this._onLoad$Tags,this),onBeforeLoad:function(){return!initializing;},onAddTag:$.proxy(this._onClick$AddTagButton,this),tagEditor:$("#d-add-tag-inline"),width:"60%",panelHeight:"auto",panelMinHeight:50});initializing=false;},show:function(listener){this._super(listener);this.name.textbox("textbox").focus();this.owner.tagbox("reload");this.tags.tagbox("reload");},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value);},getEmail:function(){return this.email.textbox("getValue");},setEmail:function(value){this.email.textbox("setValue",value);},getCompany:function(){return this.company.textbox("getValue");},setCompany:function(value){this.company.textbox("setValue",value);},getOwner:function(){return this.ownedBy.is(":checked:not(:disabled)")?this.owner.combobox("getValue"):null;},setOwner:function(value){if(value!=null&&value.trim().length){this.ownedBy.prop("checked",true);this.owner.combobox("setValue",value);this._adjustFieldState();}else{this.ownedBy.prop("checked",false);}},getTags:function(){return this.tags.tagbox("getValues");},setTags:function(values){this.tags.tagbox("setValues",values);},_onClick$AddTagButton:function(tag){this.listener.onAddTag(tag).done($.proxy(function(){this.tags.tagbox("reload");},this));},_onLoad$Tags:function(params,success,error){this.listener.onLoadTags(params).done(success).fail(error);},_onLoad$Owners:function(params,success,error){this.listener.onLoadOwners(params).done(success).fail(error);},_adjustFieldState:function(){var enabled=this.ownedBy.is(":checked");this.owner.combobox(enabled?"enable":"disable");}});jscape.domain.AddContactDialog=jscape.domain.ContactDialog.extend({initialize:function(){this._super($("#d-contact-add"));}});jscape.domain.EditContactDialog=jscape.domain.ContactDialog.extend({initialize:function(){this._super($("#d-contact-edit"));this.title=this.dialog.dialog("header").text();},setName:function(value){this._super(value);this.dialog.dialog("setTitle",this.title.supplant({0:value}));}});jscape.domain.ImportContactsController=jscape.ui.DefaultImportController.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,data){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog(data).show(this);}
return this.deferred.promise();},onSubmit:function(dialog){var file=this.file?this.file:dialog.getFile();return jscape.API.importContacts(this.domainName,file,false).done($.proxy(function(){this._showSuccessMessage();this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(data){var d=new jscape.domain.ImportContactsDialog();this._listFileEntries(data,"file").done($.proxy(function(files){if(files&&files.length){this.file=files[0];d.setFilename(this.file.name);d=undefined;}},this));return d;},_showSuccessMessage:function(){$(document).triggerHandler("broadcast",window.R.string.CONTACTS_SUCCESS_IMPORT);}});jscape.domain.ImportContactsDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-contacts-import"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=contactsimportfields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",validateOnBlur:true,width:"60%"});},getFile:function(){var files=!this.file.filebox("options").disabled?this.file.filebox("files"):null;return files&&files.length?files[0]:null;},setFilename:function(value){if(!!value){this.file.filebox("setText",value).filebox("disable");}},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});