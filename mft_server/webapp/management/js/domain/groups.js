/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.Group=Class.extend({initialize:function(a,b,c,d){this.name=a||"";this.resources=b||[];this.useInAdHocTransferAllowed=!!c;this.tags=d||[];}});jscape.Group.fromJSON=function(data){return data?new jscape.Group(data.name,$.map(data.resources||[],jscape.VirtualFile.fromJSON),data.useInAdHocTransferAllowed,data.tags):null;};jscape.domain.GroupsModule=jscape.domain.DomainModule.extend({onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.GroupsController();this.controller.onCreate(this.domainName);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.GroupsController=jscape.ui.DatagridController.extend({view:null,variables:null,initialize:function(){this._initValidators();this.variables=[];},onCreate:function(domainName){this.domainName=domainName;this.addController=new jscape.domain.AddGroupController();this.editController=new jscape.domain.EditGroupController();this.copyController=new jscape.domain.CopyGroupController();this.usersController=new jscape.domain.GroupUsersController();this.deleteController=new jscape.domain.DeleteGroupController();this.emailController=new jscape.domain.EmailGroupMembersController();},onStart:function(){if(this.view==null){this.view=new jscape.domain.GroupsView();jscape.API.getAccountVariables(this.domainName).then($.proxy(function(items){this.variables=items;},this));}
this.view.show(this);},onResume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listGroups(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onAddGroup:function(){return this.addController.start(this.domainName,this.variables).done($.proxy(this._groupAdded,this));},onCopyGroup:function(group){return this.copyController.start(this.domainName,group.name).done($.proxy(this._groupAdded,this));},onEditGroup:function(group){var index=$.inArray(group,this.view.getGroups());if(index!=-1){this.editController.start(this.domainName,group,this.variables).done($.proxy(this._groupEdited,this,index));}},onDeleteGroup:function(groups){return this.deleteController.start(this.domainName,groups).done($.proxy(this._groupDeleted,this,groups));},onGroupAccounts:function(group){return this.usersController.start(this.domainName,group.name);},onSendEmail:function(group){return this.emailController.start(this.domainName,group.name);},_groupAdded:function(group){this._recordAdded(group);},_groupEdited:function(index,group){this._recordEdited(group);},_groupDeleted:function(groups){this._recordDeleted(groups);},_initValidators:function(){var v=new jscape.Validator();v.rule("group_name",$.proxy(this._groupNameValid,this),window.R.string.GROUPS_ERROR_BAD_NAME);v.rule("group_unique",$.proxy(this._groupNotExists,this),window.R.string.GROUPS_ERROR_ALREADY_EXIST);},_groupNotExists:function(groupName){groupName=(groupName||"").toUpperCase();var values=$.map(this.view.getGroups(),function(group){return group.name.toUpperCase();});return $.inArray(groupName,values)==-1;},_groupNameValid:function(value){return value==null||(value.length<=255&&value.indexOf("..")==-1&&value.indexOf("/")==-1&&value.indexOf("\\")==-1);}});jscape.domain.GroupsView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#groups-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=groups]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,singleSelect:true,pagination:true,search:true,remoteSearch:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"50%"},{field:"tags",title:$("thead th:nth-child(2)",this.data).text(),width:"50%",formatter:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();}}]],onSelect:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustRowSelection,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.copyButton=$("a[role=button][name=copy]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.usersButton=$("a[role=button][name=users]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$UsersButton,this)});this.sendEmailButton=$("a[role=button][name=email]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$SendEmailButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.GroupsView.LISTENER;this._adjustRowSelection();},getGroups:function(){return this.getRecords();},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onClick$AddButton:function(){this.addButton.linkbutton("disable");this.listener.onAddGroup().always($.proxy(function(){this.addButton.linkbutton("enable");},this));},_onClick$EditButton:function(){this.listener.onEditGroup(this.selection[0]);},_onClick$DeleteButton:function(){this.deleteButton.linkbutton("disable");this.listener.onDeleteGroup(this.selection).always($.proxy(function(){this.deleteButton.linkbutton("enable");},this));},_onClick$CopyButton:function(){this.copyButton.linkbutton("disable");this.listener.onCopyGroup(this.selection[0]).always($.proxy(function(){this.copyButton.linkbutton("enable");},this));},_onClick$UsersButton:function(){this.usersButton.linkbutton("disable");this.listener.onGroupAccounts(this.selection[0]).always($.proxy(function(){this.usersButton.linkbutton("enable");},this));},_onClick$SendEmailButton:function(){this.listener.onSendEmail(this.selection[0]);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.copyButton,this.deleteButton,"-",this.usersButton,"-",this.sendEmailButton]);},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");this._adjustButtonsState();},_adjustButtonsState:function(){this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.copyButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");this.usersButton.linkbutton(this.selection.length==1?"enable":"disable");this.sendEmailButton.linkbutton(this.selection.length==1?"enable":"disable");}});jscape.domain.GroupsView.LISTENER={onLoadData:$.noop,onAddGroup:$.noop,onEditGroup:$.noop,onCopyGroup:$.noop,onDeleteGroup:$.noop,onGroupAccounts:$.noop,onSendEmail:$.noop};jscape.domain.BaseGroupController=Class.extend({initialize:function(){this._initValidators();},onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},onSelectPath:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectDirectory().then(function(entry){return entry.path;});},onCancel:function(dialog){dialog.destroy();this.dialog=null;this.deferred.reject();},onAddPath:function(){var c=new jscape.vfs.AddPathController();return c.start(this.domainName,this.variables);},onEditPath:function(path){var c=new jscape.vfs.EditPathController();return c.start(this.domainName,path,this.variables);},onDeletePath:function(paths){var c=new jscape.vfs.DeletePathController();return c.start(paths).then(function(){return paths;});},_initValidators:function(){var v=new jscape.Validator();v.rule("vfs_unique",$.proxy(this._pathNotExists,this),window.R.string.VFS_ERROR_BAD_PATH);v.rule("vfs_root_found",$.proxy(this._rootPathFound,this),window.R.string.VFS_ERROR_ROOT_PATH_NOT_FOUND);v.nonEmptyRule("vfs_realpath_nonempty",window.R.string.VFS_ERROR_BAD_REAL_PATH);},_pathNotExists:function(path,excludes){var items=this.dialog?this.dialog.getPaths():[];return $.grep(items,function(file){return file.path==path&&(excludes==undefined||$.inArray(path,excludes)==-1);}).length==0;},_rootPathFound:function(paths){return $.grep(paths||[],function(path){return path.isRoot();}).length!=0;}});jscape.domain.AddGroupController=jscape.domain.BaseGroupController.extend({deferred:null,start:function(domainName,variables){this.domainName=domainName;this.variables=variables;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.addGroup(this.domainName,this._createGroup(dialog)).done($.proxy(function(group){this.deferred.resolve(group);this.deferred=null;},this));},_setupDialog:function(){this.dialog=new jscape.domain.AddGroupDialog();return this.dialog;},_createGroup:function(dialog){return new jscape.Group(dialog.getGroupName(),dialog.getPaths(),dialog.isUseInAdHocTransferAllowed(),dialog.getTags());}});jscape.domain.EditGroupController=jscape.domain.BaseGroupController.extend({deferred:null,start:function(domainName,group,variables){this.domainName=domainName;this.groupName=group.name;this.variables=variables;this.deferred=$.Deferred();jscape.API.getGroup(this.domainName,group.name).done($.proxy(function(group){this._setupDialog(group).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},onSubmit:function(dialog){var group=this._createGroup(dialog);return jscape.API.setGroup(this.domainName,group.name,group).done($.proxy(function(){this.dialog=null;this.deferred.resolve(group);this.deferred=null;},this));},_createGroup:function(dialog){return new jscape.Group(this.groupName,dialog.getPaths(),dialog.isUseInAdHocTransferAllowed(),dialog.getTags());},_setupDialog:function(group){this.dialog=new jscape.domain.EditGroupDialog();if(group){this.dialog.setGroupName(group.name);this.dialog.setPaths([].concat(group.resources));this.dialog.setUseInAdHocTransferAllowed(group.useInAdHocTransferAllowed);this.dialog.setTags(group.tags);}
return this.dialog;}});jscape.domain.GroupDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog){var initializing=true;this._super(dialog,{width:"70%",height:"80%",onResize:$.proxy(this._onResize$Dialog,this)});this.fieldset=$("#"+this.idFor("d-group-fields"));this.dialog.find(".content").layout({fit:true,doSize:false,border:true});this.useInAdhoc=$("input[name=useinadhoc]:checkbox",this.fieldset);this.data=$("table[role=grid][aria-label=paths]",this.fieldset);this.data.datagrid({minHeight:170,fitColumns:true,singleSelect:true,onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onSortColumn:$.proxy(this._adjustButtonsState,this),onLoadSuccess:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(function(){this.editButton.click();},this),idField:"path",columns:[[{field:"path",title:$("thead th:nth-child(1)",this.data).text(),resizable:true,sortable:false,width:60},{field:"mapping",title:$("thead th:nth-child(2)",this.data).text(),resizable:true,sortable:false,width:100,formatter:function(_,row){return(row.realPath?row.realPath:(row.reverseProxy?row.reverseProxy:"")).escapeXml();}},{field:"permissions",title:$("thead th:nth-child(3)",this.data).text(),resizable:false,sortable:false,width:70,formatter:function(_,row){return row.accessPermissions.format();}}]]});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddPathButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditPathButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeletePathButton,this)});this.moveUpButton=$("a[role=button][name=moveup]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveUpPathButton,this)});this.moveDownButton=$("a[role=button][name=movedown]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveDownPathButton,this)});this.tags=$("select[name=tags]",this.fieldset).tagbox({limitToList:jscape.acl&&!jscape.acl.tic,hasDownArrow:true,loader:$.proxy(this._onLoad$Tags,this),onBeforeLoad:function(){return!initializing;},onAddTag:$.proxy(this._onClick$AddTagButton,this),tagEditor:$("#d-add-tag-inline"),width:"60%",panelHeight:"auto",panelMinHeight:50});initializing=false;},show:function(listener){this._super(listener);this._onResize$Dialog();this.tags.tagbox("reload");},isUseInAdHocTransferAllowed:function(){return this.useInAdhoc.is(":checked");},setUseInAdHocTransferAllowed:function(value){this.useInAdhoc.prop("checked",!!value);},getPaths:function(){return this.data.datagrid("getRows");},setPaths:function(values){this.data.datagrid("loadData",values);},getTags:function(){return this.tags.tagbox("getValues");},setTags:function(values){this.tags.tagbox("setValues",values);},_onResize$Dialog:function(){function _adjustGridHeight(grid){return function(){var p=grid.parents(".layout-panel").first();var f=grid.parents("fieldset").first();var height=grid.datagrid("getPanel").outerHeight()+(p.outerHeight()-f.outerHeight(true));grid.datagrid("resize",{width:"auto",height:height});}}
if(this.data){setTimeout(_adjustGridHeight(this.data),10);}},_onClick$AddPathButton:function(){this.listener.onAddPath().done($.proxy(function(path){this.data.datagrid("appendRow",path).datagrid("selectRecord",path);},this));},_onClick$EditPathButton:function(){var row=this.selection[0];var index=this.data.datagrid("getRowIndex",row);this.listener.onEditPath(row,this).done($.proxy(function(path){this.data.datagrid("updateRow",{index:index,row:path}).datagrid("selectRow",index);},this));},_onClick$DeletePathButton:function(){this.listener.onDeletePath(this.selection).done($.proxy(function(paths){var index;while(paths.length){index=this.data.datagrid("getRowIndex",paths.pop());this.data.datagrid("deleteRow",index);}
var count=this.data.datagrid("getRows").length;if(count>0){this.data.datagrid("selectRow",Math.max(0,Math.min(index,--count)));}},this));},_onClick$MoveUpPathButton:function(){var row=this.selection[0];var index=this.data.datagrid("getRowIndex",row);if(index>0){this.data.datagrid("deleteRow",index).datagrid("insertRow",{index:--index,row:row}).datagrid("selectRow",index);}},_onClick$MoveDownPathButton:function(){var row=this.selection[0];var index=this.data.datagrid("getRowIndex",row);if(index>=0){this.data.datagrid("deleteRow",index).datagrid("insertRow",{index:++index,row:row}).datagrid("selectRow",index);}},_onClick$AddTagButton:function(tag){this.listener.onAddTag(tag).done($.proxy(function(){this.tags.tagbox("reload");},this));},_onLoad$Tags:function(params,success,error){this.listener.onLoadTags(params).done(success).fail(error);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var index=this.selection.length==1?this.data.datagrid("getRowIndex",this.selection[0]):-1;var rowCount=this.data.datagrid("getRows").length;this.moveUpButton.linkbutton(index>0&&index<=rowCount-1?"enable":"disable");this.moveDownButton.linkbutton(index>=0&&index<rowCount-1?"enable":"disable");this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length>0?"enable":"disable");}});jscape.domain.AddGroupDialog=jscape.domain.GroupDialog.extend({deferred:null,initialize:function(){this._super($("#d-group-add"));this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["non_empty","group_name","group_unique"],invalidMessage:window.R.string.GROUPS_ERROR_BAD_NAME,missingMessage:window.R.string.GROUPS_ERROR_BAD_NAME,width:"60%"});},getGroupName:function(){return this.name.textbox("getValue");}});jscape.domain.EditGroupDialog=jscape.domain.GroupDialog.extend({deferred:null,initialize:function(){this._super($("#d-group-edit"));this.title=this.dialog.dialog("header").text()||"";},setGroupName:function(name){this.dialog.dialog("setTitle",this.title.supplant({0:name}));}});jscape.domain.CopyGroupController=Class.extend({deferred:null,start:function(domainName,groupName){this.domainName=domainName;this.sourceGroupName=groupName;this.deferred=$.Deferred();this._setupDialog(groupName).show(this);return this.deferred.promise();},onSubmit:function(dialog){var targetGroupName=dialog.getGroupName();return jscape.API.copyGroup(this.domainName,this.sourceGroupName,targetGroupName).done($.proxy(function(group){this.deferred.resolve(group);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();},_setupDialog:function(groupName){var dialog=new jscape.domain.CopyGroupDialog();dialog.setCopyGroup(groupName);return dialog;}});jscape.domain.CopyGroupDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-group-copy"),{width:530,resizable:false});this.title=this.dialog.dialog("header").text()||"";this.fieldset=$("fieldset[name=copygroupfields]",this.dialog);this.name=$("[name=name]",this.fieldset).textbox({required:true,validType:["non_empty","group_name","group_unique"],invalidMessage:window.R.string.GROUPS_ERROR_BAD_NAME,missingMessage:window.R.string.GROUPS_ERROR_BAD_NAME,width:"60%"});},show:function(listener){this._super(listener);this.name.textbox("textbox").focus();},getGroupName:function(){return this.name.textbox("getValue");},setCopyGroup:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));}});jscape.domain.DeleteGroupController=Class.extend({groups:null,deferred:null,start:function(domainName,groups){this.domainName=domainName;this.deferred=$.Deferred();this._confirmDelete(groups).done($.proxy(this._deleteConfirmed,this,groups)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(groups){var text=$.map(groups,function(group){return group.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.GROUPS_CONFIRM_DELETE_TITLE,window.R.string.GROUPS_CONFIRM_DELETE_MESSAGE.supplant({0:text}));},_deleteConfirmed:function(groups){$.when.apply(jQuery,$.map(groups,$.proxy(function(group){return jscape.API.deleteGroup(this.domainName,group.name);},this))).done($.proxy(function(){this.deferred.resolve(groups);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});jscape.domain.GroupUsersController=Class.extend({deferred:null,start:function(domainName,groupName){this.domainName=domainName;this.groupName=groupName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var users=dialog.getAssignedUsers();return jscape.API.setGroupUsers(this.domainName,this.groupName,users).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.GroupUsersDialog();dialog.setGroupName(this.groupName);$.when(jscape.API.getAccountNames(this.domainName),jscape.API.getGroupUsers(this.domainName,this.groupName)).done(function(accountNames,groupUsers){dialog.setUsers(accountNames);dialog.setAssignedUsers(groupUsers);}).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return dialog;}});jscape.domain.GroupUsersDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-group-users"),{width:530,resizable:false});this.fieldset=$("fieldset[name=groupusersfields]",this.dialog);this.data=$("table[role=grid][aria-label=users]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,singleSelect:false,checkOnSelect:true,selectOnCheck:true,remoteSort:false,idField:"value",columns:[[{field:"_ck",checkbox:true},{field:"text",width:"90%"}]],loadFilter:function(data){return $.map($.isArray(data)?data:data.rows,function(val){return{text:String(val).escapeXml(),value:val};});}});this.title=this.dialog.dialog("header").text();},setGroupName:function(name){this.dialog.dialog("setTitle",this.title.supplant({0:name}));},setUsers:function(values){this.data.datagrid("loading").datagrid("loadData",values.sort()).datagrid("loaded");},getAssignedUsers:function(){var opts=this.data.datagrid("options");return $.map(this.data.datagrid("getSelections"),function(i){return i[opts.idField]||i;});},setAssignedUsers:function(values){this.data.datagrid("clearSelections");if(values&&values.length){this.data.datagrid("loadData",this.data.datagrid("getData").sort(function(o1,o2){var s1=$.inArray(o1,values)!=-1;var s2=$.inArray(o2,values)!=-1;return s1&&!s2?-1:!s1&&s2?1:(o1==o2?0:o1>o2?1:-1);}));for(var i=0;i<values.length;i++){this.data.datagrid("selectRecord",values[i]);}}}});jscape.domain.EmailGroupMembersController=Class.extend({deferred:null,start:function(domainName,groupName){this.domainName=domainName;this.groupName=groupName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},_setupDialog:function(){return new jscape.domain.EmailGroupMembersDialog();},onSubmit:function(dialog){return jscape.API.sendGroupEmail(this.domainName,this.groupName,dialog.getSubject(),dialog.getMessage()).then(function(data){$(document).triggerHandler("broadcast",[window.R.string.GROUPS_SUCCESS_EMAIL_SENT.supplant({0:data})]);}).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;}});jscape.domain.EmailGroupMembersDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-group-email"),{width:"60%",height:490,resizable:false});this.fieldset=$("fieldset",this.dialog).panel({fit:true});this.subject=$("input[name=subject]",this.dialog).textbox({required:true,validType:"non_empty",width:"75%"});this.message=$("textarea[name=message]",this.dialog).textbox({required:true,multiline:true,validType:"non_empty",width:"75%",height:320});},getSubject:function(){return this.subject.textbox("getValue");},getMessage:function(){return this.message.textbox("getValue");},show:function(listener){this._super(listener);this.subject.textbox("textbox").focus();}});