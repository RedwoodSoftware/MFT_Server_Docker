/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.LogConfiguration=Class.extend({initialize:function(a){this.maxBufferRecords=parseInt(a)||0;}});jscape.LogConfiguration.fromJSON=function(data){return data?new jscape.LogConfiguration(data.maxBufferRecords):null;};jscape.domain.LoggingSettingsModule=jscape.domain.DomainModule.extend({initialize:function(sca){this.sca=sca;},onCreate:function(){this._super.apply(this,arguments);this.serviceController=new jscape.domain.LogServiceController(this.sca);this.serviceController.onCreate(this.domainName);this.syslogController=new jscape.domain.SyslogController(this.sca);this.syslogController.onCreate(this.domainName);this.extendedController=new jscape.domain.DomainExtendedLogController(this.sca);this.extendedController.onCreate(this.domainName);this.configController=new jscape.domain.LogConfigController(this.sca);this.configController.onCreate(this.domainName);},onStart:function(){this.serviceController.onStart();this.syslogController.onStart();this.extendedController.onStart();this.configController.onStart();},onPause:function(){this._confirmAndApply($.grep([this.serviceController,this.syslogController,this.extendedController,this.configController],function(controller){return controller.hasChanged();}));},onResume:function(){this.serviceController.onResume();this.syslogController.onResume();this.extendedController.onResume();this.configController.onResume();}});jscape.domain.LogServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.LogService.file("",jscape.LogService.FILE_STRATEGY.DAILY,10*1024),type:null,descriptor:null,view:null,initialize:function(allowed){this.allowed=allowed;this.controllers={FILE:jscape.domain.FileLogServiceController,DB:jscape.domain.DbLogServiceController,DB_SYSTEM:jscape.domain.DomainLogServiceController};},onCreate:function(domainName){this.domainName=domainName;},onStart:function(){if(this.view==null){this.view=new jscape.domain.LogServiceView();}
this.view.show(this);},hasChanged:function(){var type=this._serviceTypeOf(this.view);return this.type!=type||(this.controllers[type]&&this.controllers[type].hasChanged());},onResume:function(){jscape.API.getLogService(this.domainName).done($.proxy(function(descriptor){this.descriptor=descriptor||this.DEFAULT_DESCRIPTOR;this._setupView(this.descriptor);},this)).fail($.proxy(function(){this.descriptor=null;this._setupView(this.DEFAULT_DESCRIPTOR);},this));},onApply:function(){var type=this._serviceTypeOf(this.view);var c=!!this.allowed?this.controllers[type]:null;if(!c||typeof c!=="object"){return $.Deferred().reject().promise();}
return this._requestMigrationOptions().then(function(options){return c.onApply(options);},function(){return c.onApply();}).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);},this));},onDiscard:function(){var c=this.controllers[this._serviceTypeOf(this.view)]||null;c&&typeof c==="object"&&c.onDiscard();this._setupView(this.descriptor);},onChangeType:function(view){var newValue=this._serviceTypeOf(view);var oldValue=this.type;$.each(this.controllers,$.proxy(function(type,controller){var t=$.type(controller);if(newValue===type){this.oldType=oldValue;this.type=newValue;if(t==="function"){this.controllers[type]=new controller();this.controllers[type].start(this.domainName,this.descriptor);}else if(t==="object"){controller.onResume();}}else{if(t==="object"){controller.onPause();}}},this));},_requestMigrationOptions:function(){if(this._migrationRequired(this.oldType,this.type)){return new jscape.domain.LogServiceMigrationController().start(this)}else{return $.Deferred().resolve(null).promise();}},_migrationRequired:function(oldServiceType,newServiceType){return(oldServiceType&&oldServiceType!==jscape.LogService.Type.DOMAIN)&&(newServiceType==jscape.LogService.Type.DOMAIN||(newServiceType==jscape.LogService.Type.DB&&this.hasChanged()));},_serviceTypeOf:function(view){return(view.getType()||"").toUpperCase();},_setupView:function(descriptor){var type=jscape.LogService.typeOf(descriptor,jscape.LogService.Type.FILE);this.view.setType(type);}});jscape.domain.LogServiceView=Class.extend({initialize:function(){this.fieldset=$("#domain-log-service-fields").layout({fit:true,doSize:false,border:false});this.type=$("select[name=type]",this.fieldset);this.type.combobox({required:true,editable:false,autoSelectFirst:false,value:null,width:"30%",panelHeight:"auto",onChange:$.proxy(this._onChange$Type,this),onLoadSuccess:$.proxy(this._onLoad$Types,this),formatter:$.proxy(this._formatTypeRow,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});},getType:function(){return this.type.combobox("getValue");},setType:function(value){var oldValue=this.type.combobox("getValue");this.type.combobox("setValue",value);if(oldValue===value){this._onChange$Type();}},show:function(listener){this.listener=listener||jscape.domain.LogServiceView.LISTENER;},_formatTypeRow:function(row){var text=row[this.type.combobox("options").textField];return!!row.disabled&&row.title?'<span aria-label="{tip}">{text}</span>'.supplant({tip:(row.title||"").escapeXml(),text:text}):text;},_createTooltips:function(combobox){combobox.combobox("panel").find(".combobox-item").each(function(){var tip=$(this).find("span[aria-label]").attr("aria-label")||"";if(tip){$(this).on("mouseenter",function(){$(this).tooltip({content:tip,position:"right",deltaX:$(this).parent().width()-$(this).width(),showEvent:"none",showDelay:0,hideEvent:"none",hideDelay:0,zIndex:"",onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");}).on("mouseleave",function(){$(this).tooltip("hide");});}});},_onLoad$Types:function(){this._createTooltips(this.type);},_onChange$Type:function(){this.listener&&this.listener.onChangeType(this);},_onClick$ApplyButton:function(){this.applyButton.linkbutton("disable");this.listener.onApply(this).always($.proxy(function(){this.applyButton.linkbutton("enable");},this));},_onClick$DiscardButton:function(){this.listener.onDiscard(this);}});jscape.domain.LogServiceView.LISTENER={onChangeType:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.FileLogServiceController=Class.extend({DEFAULT:{DIRECTORY:"%installdir%/logs/%domain%",STRATEGY:jscape.LogService.FILE_STRATEGY.DAILY},VARIABLES:["installdir","domain"],initialize:function(){this.view=new jscape.domain.FileLogServiceView();this.variableController=new jscape.VariableController();},start:function(domainName,descriptor){this.domainName=domainName;this.descriptor=descriptor;this._setupView(this.descriptor).show(this);},hasChanged:function(){return this.descriptor&&!Object._equals(this.descriptor,this._createDescriptor());},onPause:function(){this.view.hide();},onResume:function(){this.view.show(this);this._setupView(this.descriptor);},onApply:function(options){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setLogService(this.domainName,this._createDescriptor(),options).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},onDiscard:function(){this._setupView(this.descriptor);},onAddVariable:function(input){this.variableController.start(input,this.VARIABLES);},onSelectPath:function(){return new SelectPathController($.proxy(jscape.API.listLogDir,jscape.API),$.proxy(jscape.API.createLogDir,jscape.API)).selectPath().then(function(entry){return entry.path;});},_createDescriptor:function(){return jscape.LogService.file(this.view.getDirectory(),this.view.getStrategy(),this.view.getFileSize());},_setupView:function(descriptor){if(jscape.LogService.Type.FILE==jscape.LogService.typeOf(descriptor,null)){this.view.setDirectory(descriptor.directory);this.view.setStrategy(descriptor.strategyName);this.view.setFileSize(descriptor.fileSize);}else{this.view.setDirectory(this.DEFAULT.DIRECTORY);this.view.setStrategy(this.DEFAULT.STRATEGY);}
return this.view;},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.domain.FileLogServiceView=Class.extend({SIZE_FACTOR:1024*1024,DEFAULT_SIZE:10,initialize:function(){this.fieldset=$("#domain-file-log-service-fields").hide();this.directory=$("input[name=directory]",this.fieldset).textbox({required:true,validType:"length[1,500]",missingMessage:window.R.string.LOGGING_ERROR_BAD_DIR,invalidMessage:window.R.string.LOGGING_ERROR_BAD_DIR,tipPosition:"left",buttonText:"...",buttonAlign:"right",buttonIcon:null,onClickButton:$.proxy(this._onClick$BrowseButton,this),width:"50%"});this.directory.textbox("textbox").focus($.proxy(function(){this.addVariable.linkbutton("enable");},this));this.strategy=$("input[name=strategy]:radio",this.fieldset).change($.proxy(this._adjustFieldState,this));this.sizeStrategy=this.strategy.filter("[value=FileSize]");this.fileSize=$("input[name=filesize]",this.fieldset).numberspinner({required:true,min:1,value:this.DEFAULT_SIZE,width:80});this.addVariable=$("a[role=button][name=addvar]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$AddVariable,this)});},getDirectory:function(){return this.directory.textbox("getValue");},setDirectory:function(value){this.directory.textbox("setValue",value);},getStrategy:function(){return this.strategy.filter(":checked").val();},setStrategy:function(value){this.strategy.filter("[value="+value+"]").prop("checked",true).change();},getFileSize:function(){return parseInt(this.fileSize.numberspinner("getValue"))*this.SIZE_FACTOR;},setFileSize:function(value){this.fileSize.numberspinner("setValue",parseInt(value)/this.SIZE_FACTOR);},show:function(listener){this.listener=listener||jscape.domain.FileLogServiceView.LISTENER;this.fieldset.show().find(".easyui-fluid:visible").each(function(){$(this).triggerHandler("_resize");});this._adjustFieldState();},hide:function(){this.fieldset.hide();},valid:function(){return this.fieldset.form("validate");},_onClick$AddVariable:function(){this.addVariable.linkbutton("disable");this.listener.onAddVariable(this.directory.textbox("textbox"));},_onClick$BrowseButton:function(){this.directory.textbox("button").linkbutton("disable");this.listener.onSelectPath(this).done($.proxy(function(path){this.setDirectory(path);},this)).always($.proxy(function(){this.directory.textbox("button").linkbutton("enable");},this));},_adjustFieldState:function(){var enable=this.sizeStrategy.is(":checked");this.fileSize.numberspinner(enable?"enable":"disable").numberspinner(enable?"enableValidation":"disableValidation").numberspinner("validate");}});jscape.domain.FileLogServiceView.LISTENER={onAddVariable:$.noop,onSelectPath:$.noop};jscape.domain.DbLogServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.LogService.db("jdbc:","",null,5,5*60*1000,14*24*60*60*1000),initialize:function(){this.view=new jscape.domain.DbLogServiceView();},start:function(domainName,descriptor){this.domainName=domainName;this.descriptor=descriptor;this._setupView(descriptor).show(this);},hasChanged:function(){return this.descriptor&&!Object._equals(this.descriptor,this._createDescriptor());},onResume:function(){this.view.show(this);this._setupView(this.descriptor);},onPause:function(){this.view.hide();},onApply:function(options){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setLogService(this.domainName,this._createDescriptor(),options).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},onDiscard:function(){this._setupView(this.descriptor);},onTest:function(){return jscape.API.testLogService(this.domainName,this._createDescriptor()).done($.proxy(this._testPassed,this));},onCreateDb:function(){return jscape.API.createLogServiceDb(this.domainName,this._createDescriptor()).done($.proxy(this._databaseCreated,this));},_createDescriptor:function(){return jscape.LogService.db(this.view.getUrl(),this.view.getUsername(),this.view.getPassword(),this.view.getPoolSize(),this.view.getPoolTimeout(),this.view.getRecordExpirationPeriod());},_setupView:function(descriptor){if(jscape.LogService.Type.DB==jscape.LogService.typeOf(descriptor,null)){this.view.setUrl(descriptor.url);this.view.setUsername(descriptor.username);this.view.setPassword(descriptor.password);this.view.setPoolSize(descriptor.poolSize);this.view.setPoolTimeout(descriptor.idleConnectionTTL);this.view.setRecordExpirationPeriod(descriptor.recordExpirationPeriodMillis);}else{this.view.setUrl(this.DEFAULT_DESCRIPTOR.url);this.view.setUsername(this.DEFAULT_DESCRIPTOR.username);this.view.setPassword(this.DEFAULT_DESCRIPTOR.password);this.view.setPoolSize(this.DEFAULT_DESCRIPTOR.poolSize);this.view.setPoolTimeout(this.DEFAULT_DESCRIPTOR.idleConnectionTTL);this.view.setRecordExpirationPeriod(this.DEFAULT_DESCRIPTOR.recordExpirationPeriodMillis);}
return this.view;},_testPassed:function(){$.messager.alert(window.R.string.LOGGING_TEST_TITLE,window.R.string.LOGGING_TEST_PASSED_MESSAGE,"info");},_databaseCreated:function(data){if(data&&data.success&&data.message){$.messager.alert(window.R.string.APPLICATION_TITLE,data.message,"info");}else{this._fireApplySuccess();}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.domain.DbLogServiceView=jscape.ui.FormView.extend({TIMEOUT_FACTOR:60*1000,EXP_PERIOD_FACTOR:24*60*60*1000,initialize:function(){this.fieldset=$("#domain-db-log-service-fields").hide();this.url=$("input[name=dburl]",this.fieldset).textbox({required:true,validType:"length[1,2048]",missingMessage:window.R.string.LOGGING_ERROR_BAD_DB_URL,invalidMessage:window.R.string.LOGGING_ERROR_BAD_DB_URL,onChange:$.proxy(this._onForm$Change,this),width:410});this.username=$("input[name=username]",this.fieldset).textbox({required:false,validType:"length[1,50]",missingMessage:window.R.string.LOGGING_ERROR_BAD_DB_USER,invalidMessage:window.R.string.LOGGING_ERROR_BAD_DB_USER,onChange:$.proxy(this._onForm$Change,this),width:250});this.password=$("input[name=password]",this.fieldset).passwordbox2({required:false,onChange:$.proxy(this._onForm$Change,this),width:250});this.poolSize=$("input[name=poolsize]",this.fieldset).numberspinner({min:1,max:100,value:5,onChange:$.proxy(this._onForm$Change,this),width:50});this.poolTimeout=$("input[name=idlettl]",this.fieldset).numberspinner({min:1,max:100,value:5,onChange:$.proxy(this._onForm$Change,this),width:50});this.clearRecords=$("input[name=clearrecords]:checkbox",this.fieldset);this.expirationPeriod=$("input[name=expirationperiod]",this.fieldset).numberspinner({required:true,min:1,max:365,value:1,disabled:true,onChange:$.proxy(this._onForm$Change,this),width:80});this.clearRecords.change($.proxy(function(){var enabled=this.clearRecords.is(":checked");this.expirationPeriod.numberspinner(enabled?"enable":"disable");},this));this.testButton=$("a[role=button][name=testdb]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$TestButton,this)});this.createDbButton=$("a[role=button][name=createdb]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CreateDbButton,this)});this._bindEvents(this.fieldset);},getUrl:function(){return this.url.textbox("getValue");},setUrl:function(value){this.url.textbox("setValue",value);},getUsername:function(){return this.username.textbox("getValue");},setUsername:function(value){this.username.textbox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue");},setPassword:function(value){this.password.passwordbox2("setValue",value);},getPoolSize:function(){return parseInt(this.poolSize.numberspinner("getValue"));},setPoolSize:function(value){this.poolSize.numberspinner("setValue",parseInt(value));},getPoolTimeout:function(){return parseInt(this.poolTimeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setPoolTimeout:function(value){this.poolTimeout.numberspinner("setValue",parseInt(value)/this.TIMEOUT_FACTOR);},getRecordExpirationPeriod:function(){return this.clearRecords.is(":checked")?parseInt(this.expirationPeriod.numberspinner("getValue"))*this.EXP_PERIOD_FACTOR:null;},setRecordExpirationPeriod:function(value){if(value!=null){this.expirationPeriod.numberspinner("setValue",parseInt(value)/this.EXP_PERIOD_FACTOR);}
this.clearRecords.prop("checked",value!=null).change();},show:function(listener){this.listener=listener||jscape.domain.DbLogServiceView.LISTENER;this.fieldset.show().form("enableValidation").form("validate");this.url.textbox("textbox").select().focus();},hide:function(){this.fieldset.hide().form("disableValidation");},valid:function(){return this._valid();},_onClick$TestButton:function(){if(this.valid()){this.testButton.linkbutton("disable");this.listener.onTest(this).always($.proxy(function(){this.testButton.linkbutton("enable");},this));}},_onClick$CreateDbButton:function(){if(this.valid()){this.createDbButton.linkbutton("disable");this.listener.onCreateDb(this).always($.proxy(function(){this.createDbButton.linkbutton("enable");},this));}},_onForm$Change:function(){this._adjustButtonsState();},_adjustButtonsState:function(){var enabled=this._valid();this.testButton.linkbutton(enabled?"enable":"disable");this.createDbButton.linkbutton(enabled?"enable":"disable");},_showContextMenu:function(e,_,parent){this._super(e,[this.testButton,this.createDbButton],parent);}});jscape.domain.DbLogServiceView.LISTENER={onTest:$.noop,onCreateDb:$.noop};jscape.domain.DomainLogServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.LogService.domain(14*24*60*60*1000),initialize:function(){this.view=new jscape.domain.DomainLogServiceView();},start:function(domainName,descriptor){this.domainName=domainName;this.descriptor=descriptor;this._setupView(descriptor).show(this);},hasChanged:function(){return this.descriptor&&!Object._equals(this.descriptor,this._createDescriptor());},onResume:function(){this.view.show(this);this._setupView(this.descriptor);},onPause:function(){this.view.hide();},onApply:function(options){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setLogService(this.domainName,this._createDescriptor(),options).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},onDiscard:function(){this._setupView(this.descriptor);},_createDescriptor:function(){return jscape.LogService.domain(this.view.getRecordExpirationPeriod());},_setupView:function(descriptor){if(jscape.LogService.Type.DOMAIN==jscape.LogService.typeOf(descriptor,null)){this.view.setRecordExpirationPeriod(descriptor.recordExpirationPeriodMillis);}else{this.view.setRecordExpirationPeriod(this.DEFAULT_DESCRIPTOR.recordExpirationPeriodMillis);}
return this.view;},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.domain.DomainLogServiceView=Class.extend({EXP_PERIOD_FACTOR:24*60*60*1000,initialize:function(){this.fieldset=$("#domain-db-system-log-service-fields").hide();this.clearRecords=$("input[name=clearrecordsenabled]:checkbox",this.fieldset);this.expirationPeriod=$("input[name=expirationperiod]",this.fieldset).numberspinner({required:true,min:1,max:365,value:10,disabled:true,width:120});this.clearRecords.change($.proxy(function(){var enable=this.clearRecords.is(":checked");this.expirationPeriod.numberspinner(enable?"enable":"disable").numberspinner(enable?"enableValidation":"disableValidation");},this));},getRecordExpirationPeriod:function(){return this.clearRecords.is(":checked")?parseInt(this.expirationPeriod.numberspinner("getValue"))*this.EXP_PERIOD_FACTOR:null;},setRecordExpirationPeriod:function(value){if(value!=null){this.expirationPeriod.numberspinner("setValue",parseInt(value)/this.EXP_PERIOD_FACTOR);}
this.clearRecords.prop("checked",value!=null).change();},show:function(listener){this.listener=listener||jscape.domain.DomainLogServiceView.LISTENER;this.fieldset.show().form("enableValidation").form("validate");},hide:function(){this.fieldset.hide().form("disableValidation");},valid:function(){return this.fieldset.form("validate");}});jscape.domain.DomainLogServiceView.LISTENER={};jscape.domain.SyslogController=Class.extend({DEFAULT_DESCRIPTOR:new jscape.SyslogService("",514,1,"MFT Server","LEGACY",false,null),view:null,descriptor:null,initialize:function(allowed){this.allowed=allowed;},onLoadClientKeys:function(){return $.when(jscape.API.getClientCertificates(this.domainName)).then(function(clientCertificates){var clientCertificateNames=$.map(clientCertificates,function(certificate){return certificate.name;});return $.Deferred().resolve(clientCertificateNames);});},onCreate:function(domainName){this.domainName=domainName;},onStart:function(){if(this.view==null){this.view=new jscape.domain.SyslogView();}
this.view.show(this);},hasChanged:function(){return this.descriptor&&!Object._equals(this.descriptor,this._createDescriptor());},onResume:function(){jscape.API.getSyslogService(this.domainName).done($.proxy(function(descriptor){this.descriptor=this._copyDescriptor(descriptor);},this)).fail($.proxy(function(){this.descriptor=null;},this)).always($.proxy(function(){this._setupView(this.descriptor);},this));},onApply:function(){if(!this.allowed){return $.Deferred().reject().promise();}
return jscape.API.setSyslogService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=this._copyDescriptor(descriptor);this._setupView(descriptor);this._fireApplySuccess();},this));},onDiscard:function(){var descriptor=this.descriptor;this.descriptor=this._copyDescriptor(descriptor);this._setupView(this.descriptor);},_createDescriptor:function(){if(this.view.isEnabled()){return new jscape.SyslogService(this.view.getHost(),this.view.getPort(),this.view.getFacility(),this.view.getProcessName(),this.view.getFormatType(),this.view.getEnableTcp(),this.view.getHostKey());}
return null;},_copyDescriptor:function(descriptor){return jscape.SyslogService.fromJSON(descriptor);},_setupView:function(descriptor){this.view.setEnabled(descriptor!=null);if(descriptor==null){descriptor=this.DEFAULT_DESCRIPTOR;}
this.view.setHost(descriptor.host);this.view.setPort(descriptor.port);this.view.setFacility(descriptor.facilityCode);this.view.setProcessName(descriptor.processName);this.view.setFormatType(descriptor.formatType);this.view.setEnableTcp(descriptor.enableTcp);this.view.setHostKey(descriptor.keyProvider);this.onLoadClientKeys().done($.proxy(function(clientCertificates){this.view.setHostKeys(clientCertificates);},this));},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.domain.SyslogView=Class.extend({initialize:function(){this.fieldset=$("#domain-syslog-fields").layout({fit:true,doSize:false,border:false});this.enabled=$("input[name=enabled]:checkbox",this.fieldset).change($.proxy(this._adjustFieldState,this));this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"length[1,255]",missingMessage:window.R.string.LOGGING_ERROR_BAD_SYSLOG_HOST,invalidMessage:window.R.string.LOGGING_ERROR_BAD_SYSLOG_HOST,width:"40%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:0,max:65535,width:100});this.facility=$("select[name=facility]",this.fieldset).combobox({required:true,editable:false,width:"25%"});this.process=$("input[name=processname]",this.fieldset).textbox({required:false,validType:"length[1,32]",invalidMessage:window.R.string.LOGGING_ERROR_BAD_SYSLOG_PROCESS_NAME,width:"40%"});this.format=$("select[name=format]",this.fieldset).combobox({required:true,editable:false,limitToList:true,width:"25%",panelHeight:"auto"});this.enableTcp=$("input[name=enableTcp]:checkbox",this.fieldset).change($.proxy(function(){this.hostkey.combobox(this.enableTcp.is(":checked:not(:disabled)")?"enable":"disable");},this));this.hostkey=$("select[name=hostkey]",this.fieldset).combobox({limitToList:true,disabled:true,hasDownArrow:true,panelHeight:"auto",panelMaxHeight:150});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});},isEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value);},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value));},getEnableTcp:function(){return this.enableTcp.is(":checked");},setEnableTcp:function(value){this.enableTcp.prop("checked",!!value).change();},getHostKey:function(){return this.enableTcp.is(":checked")?this.hostkey.combobox("getValue"):null;},setHostKey:function(value){this.enableTcp.prop("checked",value!=null).change();if(value!=null){this.hostkey.combobox("setValue",value);}},setHostKeys:function(values){this.hostkey.combobox("loadData",values);},getFacility:function(){return this.facility.combobox("getValue");},setFacility:function(value){this.facility.combobox("setValue",value);},getProcessName:function(){return this.process.textbox("getValue");},setProcessName:function(value){this.process.textbox("setValue",value);},getFormatType:function(){return this.format.combobox("getValue");},setFormatType:function(value){this.format.combobox("setValue",value);},show:function(listener){this.listener=listener||jscape.domain.SyslogView.LISTENER;this._adjustFieldState();},_onClick$ApplyButton:function(){if(this.fieldset.form("validate")){this.applyButton.linkbutton("disable");this.listener.onApply(this).always($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_adjustFieldState:function(){var enable=this.isEnabled();this.host.textbox(enable?"enable":"disable").textbox(enable?"enableValidation":"disableValidation");this.port.numberspinner(enable?"enable":"disable").numberspinner(enable?"enableValidation":"disableValidation");this.facility.combobox(enable?"enable":"disable");this.process.textbox(enable?"enable":"disable");this.format.combobox(enable?"enable":"disable");this.fieldset.form("validate");}});jscape.domain.SyslogView.LISTENER={onApply:$.noop,onDiscard:$.noop};jscape.domain.LogConfigController=Class.extend({DEFAULT_CONFIG:new jscape.LogConfiguration(100,false),config:null,view:null,initialize:function(allowed){this.allowed=allowed;},onCreate:function(domainName){this.domainName=domainName;},onStart:function(){if(this.view==null){this.view=new jscape.domain.LogConfigView();}
this.view.show(this);},hasChanged:function(){return this.config&&!Object._equals(this.config,this._createConfiguration());},onResume:function(){return jscape.API.getLogConfiguration(this.domainName).done($.proxy(function(config){this.config=config||this._copyConfiguration(this.DEFAULT_CONFIG);},this)).fail($.proxy(function(){this.config=this._copyConfiguration(this.DEFAULT_CONFIG);},this)).always($.proxy(function(){this._setupView(this.config);},this));},onApply:function(){if(!this.allowed){return $.Deferred().reject().promise();}
return jscape.API.setLogConfiguration(this.domainName,this._createConfiguration()).done($.proxy(function(config){this.config=this._copyConfiguration(config);this._setupView(config);this._fireApplySuccess();},this));},onDiscard:function(){var config=this.config;this.config=this._copyConfiguration(config);this._setupView(this.config);},_createConfiguration:function(){return new jscape.LogConfiguration(this.view.getMaxRecords());},_copyConfiguration:function(config){return jscape.LogConfiguration.fromJSON(config);},_setupView:function(config){if(config&&this.view){this.view.setMaxRecords(config.maxBufferRecords);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.domain.LogConfigView=Class.extend({initialize:function(){this.fieldset=$("#log-config-fields").layout({fit:true,doSize:false,border:false});this.maxRecords=$("input[name=buffersize]",this.fieldset).numberspinner({required:true,min:10,max:1000,increment:10,width:100});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});},getMaxRecords:function(){return parseInt(this.maxRecords.numberspinner("getValue"));},setMaxRecords:function(value){this.maxRecords.numberspinner("setValue",parseInt(value)).numberspinner("validate");},show:function(listener){this.listener=listener||jscape.domain.LogConfigView.LISTENER;},_onClick$ApplyButton:function(){if(this.fieldset.form("validate")){this.applyButton.linkbutton("disable");this.listener.onApply(this).always($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);}});jscape.domain.LogConfigView.LISTENER={onApply:$.noop,onDiscard:$.noop};jscape.domain.LogServiceMigrationController=Class.extend({start:function(required){var deferred=$.Deferred();if(!!required){var dialog=new jscape.domain.LogServiceMigrationDialog();dialog.show({onSubmit:function(d){return deferred.resolve(d.getPeriod());},onCancel:function(d){d.destroy();return deferred.resolve(null);}});}else{deferred.reject();}
return deferred.promise();}});jscape.domain.LogServiceMigrationDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var okButtonId=this._nextId("ok");this._super($("#d-logging-migrate"),{width:"40%",minWidth:500,maxWidth:650,minHeight:210,buttons:[{text:window.R.string.DIALOG_BUTTON_YES||"Yes",id:okButtonId,handler:$.proxy(this._onSubmit,this)},{text:window.R.string.DIALOG_BUTTON_NO||"No",handler:$.proxy(this._onCancel,this)}]});this.okButton=this.dialog.siblings(".dialog-button").children("#"+okButtonId);this.fieldset=$("fieldset[name=migratelogrecordsfields]",this.dialog);this.enabled=$("input[name=enabled]",this.fieldset);this.period=$("select[name=period]",this.fieldset).combobox({required:true,editable:false,disabled:true,width:150,panelHeight:"auto"});this.enabled.change($.proxy(function(){var enabled=this.enabled.is(":checked");this.period.combobox(enabled?"enable":"disable");this.okButton.linkbutton(enabled?"enable":"disable");},this));this.enabled.change();},getPeriod:function(){return this.enabled.is(":checked")?this.period.combobox("getValue"):null;}});jscape.domain.DomainExtendedLogController=Class.extend({view:null,type:null,controllers:null,config:null,initialize:function(allowed){this.allowed=allowed;},onCreate:function(domainName){this.domainName=domainName;this.configManager=$.extend(new jscape.ConfigManager(),{doLoad_:$.proxy(this._loadConfig,this),doSave_:$.proxy(this._saveConfig,this),doTest_:$.proxy(this._testConfig,this)});this.configManager.subscribe(this);this.controllers={'NULL':new jscape.domain.NullExtendedLogsController(this.configManager),'SPLUNK':new jscape.domain.SplunkHttpLogsController(this.configManager)};},onStart:function(){$.each(this.controllers,function(_,c){c.onStart();});if(this.view==null){this.view=new jscape.domain.DomainExtendedLogView();}
this.view.show(this);},onResume:function(){this.configManager.loadConfig().done($.proxy(function(config){this._setupView(config);},this));},onPause:function(){var c=this._controller();if(!c.hasChanged()){return;}
this.__pausing=true;this._showConfirmApply().then($.proxy(function(){return c.onApply();},this)).then($.proxy(function(config){this.__pausing=false;return this.configManager.saveConfig(config,true);},this)).fail(function(){c.onDiscard();}).always($.proxy(function(){this.__pausing=false;},this));},onConfigurationChanged:function(config){this.config=config;},hasChanged:function(){return this.config!=null&&this._controller().hasChanged();},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onChangeType:function(type){this.type=type;$.each(this.controllers,$.proxy(function(t,c){if(this.type===t){c.onResume();}else{c.onPause();}},this));},onRefresh:function(){this.onResume();},onApply:function(){return this._controller().onApply();},onDiscard:function(){return this.view.refresh();},onTest:function(){return this._controller().onTest().done(function(){$.messager.alert("",window.R.string.LOGGING_TEST_PASSED_MESSAGE,"info");});},_loadConfig:function(){return jscape.API.getExtendedLogServiceConfiguration(this.domainName);},_saveConfig:function(config){if(!!this.__pausing){return $.Deferred().resolve(config).promise();}
return jscape.API.setExtendedLogServiceConfiguration(this.domainName,config).fail($.proxy(function(jqXhr){if(jscape.API.invalidParametersResponse(jqXhr)){this._loadConfig();}},this));},_testConfig:function(config){return jscape.API.testExtendedLogServiceConfiguration(this.domainName,config);},_setupView:function(config){if(config&&config.splunkHttpData){this.view.setEnabled(true);this.view.setType("SPLUNK");}else{this.view.setEnabled(false);}},_controller:function(){return this.controllers[this.view.getType()||"NULL"];}});jscape.domain.DomainExtendedLogView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#log-extensions-fields").layout({fit:true,doSize:false,border:false});this.enabled=$("input[name=enabled]:checkbox",this.fieldset).change($.proxy(this._onChange$Enabled,this));this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,disabled:true,onChange:$.proxy(this._onChange$Type,this),width:"25%",panelWidth:"auto",panelHeight:"auto",panelMaxHeight:"40%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this.testButton=$("a[role=button][name=test]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$TestButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.domain.DomainExtendedLogView.LISTENER;this.enabled.change();},refresh:function(){this.listener.onRefresh();},isEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getType:function(){return this.isEnabled()?this.type.combobox("getValue"):null;},setType:function(value){var selectedType=this.type.combobox("getValue");this.type.combobox("clear").combobox("select",value);if(selectedType===value){this._onForm$Change();}},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply(this).catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onChange$Enabled:function(){var enabled=this.isEnabled();this.type.combobox(enabled?"enable":"disable");this._onChange$Type();this.testButton.linkbutton(enabled?"enable":"disable");this.fieldset.find("fieldset[id]").triggerHandler("_enable",[enabled]);this.fieldset.form("validate");},_onClick$TestButton:function(){if(this._valid()){this.testButton.linkbutton("disable");this.listener.onTest(this).always($.proxy(function(){this.testButton.linkbutton("enable");},this));}},_onChange$Type:function(){this.listener.onChangeType(this.getType());},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.domain.DomainExtendedLogView.LISTENER={onChange:$.noop,onRefresh:$.noop,onTest:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.NullExtendedLogsController=Class.extend({NULL_CONFIG:new jscape.DomainExtendedLogConfiguration(null),config:null,initialize:function(publisher){this.publisher=publisher.subscribe(this);},onConfigurationChanged:function(config){this.config=config;},onStart:function(){},onPause:function(){},onResume:function(){},onStop:function(){},onApply:function(){return this.hasChanged()?this.publisher.saveConfig(this._createConfig()):$.Deferred().resolve(this.config).promise();},onDiscard:function(){return $.Deferred().resolve().promise();},onTest:function(){return $.Deferred().resolve().promise();},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfig());},_createConfig:function(){return this.NULL_CONFIG;}});jscape.domain.SplunkHttpLogsController=Class.extend({DEFAULTS:{port:8088,timeout:30*1000,sslRequired:true},view:null,config:null,initialize:function(publisher){this.publisher=publisher.subscribe(this);},onConfigurationChanged:function(config){this.config=config;},onStart:function(){if(this.view==null){this.view=new jscape.domain.SplunkHttpLogsView();}},onResume:function(){this._setupView(this.config);this.view.show(this);},onPause:function(){this.view.hide();},onStop:function(){this.view.destroy();},onApply:function(){return this.hasChanged()?this.publisher.saveConfig(this._createConfig()):$.Deferred().resolve(this.config).promise();},onDiscard:function(){this._setupView(this.config);return $.Deferred().resolve().promise();},onTest:function(){return this.publisher.testConfig(this._createConfig());},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfig());},_createConfig:function(){return jscape.DomainExtendedLogConfiguration.splunkHttp(this.view.getHost(),this.view.getPort(),this.view.getTimeout(),this.view.isSslRequired(),this.view.getToken(),this.view.getSource(),this.view.getSourceType(),this.view.getIndex());},_setupView:function(config){if(this.view&&config){var data=config.splunkHttpData;if(data){this.view.setHost(data.host);this.view.setPort(data.port);this.view.setTimeout(data.timeout);this.view.setSslRequired(data.sslRequired);this.view.setToken(data.accessToken);this.view.setSource(data.source);this.view.setSourceType(data.sourceType);this.view.setIndex(data.index);}else{this.view.setPort(this.DEFAULTS.port);this.view.setTimeout(this.DEFAULTS.timeout);this.view.setSslRequired(this.DEFAULTS.sslRequired);}}}});jscape.domain.SplunkHttpLogsView=jscape.ui.FormView.extend({TIMEOUT_FACTOR:1000,initialize:function(){this.fieldset=$("#log-extensions-splunk-fields");this.host=$("input[name=host]",this.fieldset).textbox({required:true,onChange:$.proxy(this._onForm$Change,this),validType:"non_empty",missingMessage:window.R.string.LOGGING_ERROR_BAD_SERVER_HOS,invalidMessage:window.R.string.LOGGING_ERROR_BAD_SERVER_HOS,width:"60%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({required:true,min:1,max:60,onChange:$.proxy(this._onForm$Change,this),width:100});this.sslRequired=$("input[name=ssl]:checkbox",this.fieldset);this.token=$("input[name=token]",this.fieldset).passwordbox2({required:true,validType:"length[1,1024]",onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.source=$("input[name=source]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.sourceType=$("input[name=sourcetype]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.index=$("input[name=index]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),width:"40%"});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.domain.SplunkHttpLogsView.LISTENER;this.fieldset.triggerHandler("_change");this._onForm$Enable(undefined,true);},hide:function(){this._onForm$Enable(undefined,false);},destroy:function(){this.host.textbox("destroy");this.port.numberspinner("destroy");this.timeout.numberspinner("destroy");},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value||"");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",value).numberspinner("validate");},getTimeout:function(){return parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setTimeout:function(value){this.timeout.numberspinner("setValue",value/this.TIMEOUT_FACTOR).numberspinner("validate");},isSslRequired:function(){return this.sslRequired.is(":checked");},setSslRequired:function(value){this.sslRequired.prop("checked",!!value).change();},getToken:function(){return this.token.passwordbox2("getValue");},setToken:function(value){this.token.passwordbox2("setValue",value);},getSource:function(){return this.source.textbox("getValue");},setSource:function(value){this.source.textbox("setValue",value||"");},getSourceType:function(){return this.sourceType.textbox("getValue");},setSourceType:function(value){this.sourceType.textbox("setValue",value||"");},getIndex:function(){return this.index.textbox("getValue");},setIndex:function(value){this.index.textbox("setValue",value||"");},_onForm$Change:function(){this.fieldset.closest("[role=group]").triggerHandler("_change");},_onForm$Enable:function(e,enabled){var enable=!!enabled;this.host.textbox(enable?"enable":"disable");this.port.numberspinner(enable?"enable":"disable");this.timeout.numberspinner(enable?"enable":"disable");this.sslRequired.prop("disabled",!enable);this.token.passwordbox2(enable?"enable":"disable");this.source.textbox(enable?"enable":"disable");this.sourceType.textbox(enable?"enable":"disable");this.index.textbox(enable?"enable":"disable");}});jscape.domain.SplunkHttpLogsView.LISTENER={};