/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.As2Message=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l){this.id=a||"";this.messageId=b||"";this.date=parseInt(c)||0;this.type=d||jscape.As2Message.Type.REQUEST;this.direction=e||jscape.As2Message.Direction.UNKNOWN;this.sender=f||"";this.recipient=g||"";this.username=h||"";this.tradingPartner=i||"";this.filename=j||"";this.receiptType=k||jscape.As2Message.ReceipType.NONE;this.status=l||jscape.As2Message.Status.PENDING;}});jscape.As2Message.fromJSON=function(data){return $.extend(new jscape.As2Message(),data);};jscape.As2Message.Type={REQUEST:"REQUEST",RECEIPT:"RECEIPT"};jscape.As2Message.Direction={INCOMING:"INCOMING",OUTGOING:"OUTGOING",UNKNOWN:"UNKNOWN"};jscape.As2Message.ReceipType={SYNC:"SYNC",ASYNC:"ASYNC",NONE:"NONE"};jscape.As2Message.Status={PENDING:"PENDING",SUCCESS:"SUCCESS",TRANSFER_FAILURE:"TRANSFER_FAILURE",FAILURE:"FAILURE",values:function(){return[jscape.As2Message.Status.PENDING,jscape.As2Message.Status.SUCCESS,jscape.As2Message.Status.TRANSFER_FAILURE,jscape.As2Message.Status.FAILURE];}};jscape.domain.AS2Module=jscape.domain.DomainModule.extend({initialize:function(soa,doa){this.soa=soa;this.doa=doa;},onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.As2MessagesController();this.controller.onCreate(this.domainName,this.soa,this.doa);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.As2MessagesController=Class.extend({view:null,onCreate:function(domainName,soa,doa){this.domainName=domainName;this.sendFileController=new jscape.domain.As2SendFileController(soa);this.resendController=new jscape.domain.As2ResendMessageController(soa);this.viewController=new jscape.domain.As2ViewMessageController();this.deleteController=new jscape.domain.As2DeleteMessageController(doa);},onStart:function(){if(this.view==null){this.view=new jscape.domain.As2MessagesView();}
this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listAs2Messages(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onSendFile:function(){return this.sendFileController.start(this.domainName).done($.proxy(function(){window.setTimeout($.proxy(function(){this.view.refresh();},this),1000);},this));},onDownloadMessageFile:function(id){return jscape.API.getAs2MessageFile(this.domainName,id);},onResendMessage:function(message){return this.resendController.start(this.domainName,message).done($.proxy(function(){window.setTimeout($.proxy(function(){this.view.refresh();},this),1000);},this));},onViewMessage:function(message){return this.viewController.start(this.domainName,message);},onDeleteMessage:function(messages){return this.deleteController.start(this.domainName,messages).done($.proxy(function(){this.view.refresh();},this));}});jscape.domain.As2MessagesView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#as2-messages-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=as2messages]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"date",sortOrder:"desc",columns:[[{field:"messageId",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"9%"},{field:"date",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"9%",align:"right",finder:"datebox",formatter:function(value){return window.moment(value).format("L, LT");}},{field:"type",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatType,this),finder:this._finderFor([jscape.As2Message.Type.RECEIPT,jscape.As2Message.Type.REQUEST],$.proxy(this._formatType,this))},{field:"direction",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatDirection,this),finder:this._finderFor([jscape.As2Message.Direction.INCOMING,jscape.As2Message.Direction.OUTGOING],$.proxy(this._formatDirection,this))},{field:"sender",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,width:"11%"},{field:"recipient",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,width:"11%"},{field:"filename",title:$("thead th:nth-child(7)",this.data).text(),sortable:true,width:"12%",formatter:$.proxy(this._formatFilename,this)},{field:"receiptType",title:$("thead th:nth-child(11)",this.data).text(),sortable:true,width:"5%",formatter:$.proxy(this._formatReceiptType,this),finder:this._finderFor([jscape.As2Message.ReceipType.SYNC,jscape.As2Message.ReceipType.ASYNC],$.proxy(this._formatReceiptType,this))},{field:"username",title:$("thead th:nth-child(9)",this.data).text(),sortable:true,width:"7%"},{field:"tradingPartner",title:$("thead th:nth-child(10)",this.data).text(),sortable:true,width:"11%"},{field:"status",title:$("thead th:nth-child(8)",this.data).text(),sortable:true,width:"7%",formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._formatStatusStyle,this),finder:this._finderFor(jscape.As2Message.Status.values(),$.proxy(this._formatStatus,this))}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$ViewButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),onLoadSuccess:$.proxy(this._onLoad$Success,this)});this.sendFileButton=$("a[role=button][name=sendfile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$SendFileButton,this)});this.viewButton=$("a[role=button][name=view]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.resendButton=$("a[role=button][name=resend]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ResendButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.As2MessagesView.LISTENER;this.data.datagrid("resize");this._adjustState();},refresh:function(){this.data.datagrid("reload");},_finderFor:function(values,formatter){return{type:"combobox",options:{panelHeight:"auto",data:$.map(values,function(value){return{text:formatter(value),value:value};})}};},_formatType:function(value){return window.R.string[("AS2_MESSAGES_TYPE_"+value).toUpperCase()]||"";},_formatDirection:function(value){return window.R.string[("AS2_MESSAGES_DIRECTION_"+value).toUpperCase()]||"";},_formatFilename:function(value,row){return jscape.As2Message.Type.REQUEST==row.type&&!!value?'<a role="button" data-options="plain:true,iconCls:\'icon-download\'" data-id="'+String(row.id).escapeXml()+'"></a>&nbsp;'+String(value).escapeXml():value;},_formatStatus:function(value){return window.R.string[("AS2_MESSAGES_STATUS_"+value).toUpperCase()]||"";},_formatStatusStyle:function(value){switch(value){case jscape.As2Message.Status.PENDING:return"color:grey";case jscape.As2Message.Status.SUCCESS:return"color:green";case jscape.As2Message.Status.TRANSFER_FAILURE:case jscape.As2Message.Status.FAILURE:return"color:red";default:return"";}},_formatReceiptType:function(value){return window.R.string[("AS2_MESSAGES_RECEIPT_TYPE_"+value).toUpperCase()]||"";},_onClick$SendFileButton:function(){this.listener.onSendFile();},_onClick$ViewButton:function(){this.listener.onViewMessage(this.selection[0]);},_onClick$ResendButton:function(){this.listener.onResendMessage(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteMessage(this.selection).done($.proxy(this._messageDeleted,this));},_onClick$DownloadButton:function(id){this.listener.onDownloadMessageFile(id);},_messageDeleted:function(items){var index=-1;while(items.length){index=this.data.datagrid("getRowIndex",items.pop());if(index!=-1){this.data.datagrid("deleteRow",index);}}
var opts=this.data.datagrid("options");var remains=this.data.datagrid("getData").total-(opts.pageNumber-1)*opts.pageSize;if(opts.pageNumber>1&&remains==0){this.data.datagrid("getPager").pagination("refresh",{pageNumber:--opts.pageNumber});this.data.datagrid("reload");}else{this.data.datagrid("selectRow",Math.max(0,Math.min(index,remains-1)));}},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).then(success,error);},_onLoad$Success:function(){var self=this;this.data.datagrid("getPanel").find("[role=button][data-id]").linkbutton({onClick:function(){self._onClick$DownloadButton.call(self,$(this).data("id"));}}).tooltip({showDelay:0,content:window.R.string.AS2_MESSAGES_BUTTON_DOWNLOAD});this._adjustState();},_showContextMenu:function(e){this._super(e,[this.viewButton,this.resendButton,this.deleteButton,"-",this.sendFileButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");var message=this.selection.length==1?this.selection[0]:null;var resendAllowed=message!=null&&jscape.As2Message.Type.REQUEST==message.type&&jscape.As2Message.Direction.OUTGOING==message.direction;this.viewButton.linkbutton(this.selection.length==1?"enable":"disable");this.resendButton.linkbutton(resendAllowed?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.domain.As2MessagesView.LISTENER={onSendFile:$.noop,onViewMessage:$.noop,onResendMessage:$.noop,onDeleteMessage:$.noop,onDownloadMessageFile:$.noop,onRefresh:$.noop};jscape.domain.As2SendFileController=Class.extend({PROTOCOLS:["AS2"],deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{jscape.API.getTradingPartnerNames(this.domainName,this.PROTOCOLS).then(function(names){if(names&&names.length){return names;}
throw window.R.string.AS2_MESSAGES_ERROR_NO_PARTNERS;}).then($.proxy(function(names){this._setupDialog(names).show(this);},this)).catch($.proxy(function(){this._showNoPartnersError();this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},onSelectFile:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectFile().then(function(entry){return entry.path;});},onSelectDebugFile:function(){return new SelectPathController($.proxy(jscape.API.listDebugDir,jscape.API),$.proxy(jscape.API.createDebugPath,jscape.API)).selectFile().then(function(entry){return entry.path;});},onSubmit:function(dialog){var data=this._createData(dialog);return jscape.API.sendTradingPartnerFile(this.domainName,dialog.getPartner(),data).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this))},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return{path:dialog.getFile(),debugfile:dialog.getDebugFile()};},_setupDialog:function(partnerNames){var dialog=new jscape.domain.As2SendFileDialog();dialog.setPartners(partnerNames);return dialog;},_showNoPartnersError:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.AS2_MESSAGES_ERROR_NO_PARTNERS,"warning");}});jscape.domain.As2SendFileDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-as2-sendfile"),{width:600,resizable:false});this.fieldset=$("fieldset[name=as2sendfilefields]",this.dialog);this.partner=$("select[name=partner]",this.fieldset).combobox({required:true,editable:false,width:170,panelHeight:"auto",panelMaxHeight:"40%"});this.file=$("input[name=file]",this.fieldset).textbox({required:true,tipPosition:"bottom",missingMessage:window.R.string.AS2_MESSAGES_ERROR_BAD_FILE,width:"50%"});this.browseFileButton=$("a[role=button][name=browsefile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseFileButton,this)});this.debugFile=$("input[name=debugfile]",this.fieldset).textbox({width:"50%"});this.browseDebugFileButton=$("a[role=button][name=browsedebugfile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseDebugFileButton,this)});},getPartner:function(){return this.partner.combobox("getValue");},setPartners:function(values){this.partner.combobox("loadData",values.sort(function(a,b){return a.toUpperCase()>b.toUpperCase();}));},getFile:function(){return this.file.textbox("getValue");},getDebugFile:function(){return this.debugFile.textbox("getValue");},show:function(listener){this._super(listener||jscape.domain.As2SendFileDialog.LISTENER);},_onClick$BrowseFileButton:function(){this.browseFileButton.linkbutton("disable");this.listener.onSelectFile().done($.proxy(function(path){this.file.textbox("setValue",path).textbox("textbox").focus();},this)).always($.proxy(function(){this.browseFileButton.linkbutton("enable");},this));},_onClick$BrowseDebugFileButton:function(){this.browseDebugFileButton.linkbutton("disable");this.listener.onSelectDebugFile().done($.proxy(function(path){this.debugFile.textbox("setValue",path).textbox("textbox").focus();},this)).always($.proxy(function(){this.browseDebugFileButton.linkbutton("enable");},this));}});jscape.domain.As2SendFileDialog.LISTENER={onSelectFile:$.noop,onSelectDebugFile:$.noop};jscape.domain.As2ViewMessageController=Class.extend({message:null,deferred:null,start:function(domainName,message){this.domainName=domainName;this.message=message;this.deferred=$.Deferred();var dialog=new jscape.domain.ViewAs2MessageDialog();dialog.show(this);if(message.type==jscape.As2Message.Type.REQUEST){dialog.selectRequest();}else if(message.type==jscape.As2Message.Type.RECEIPT){dialog.selectReceipt();}
return this.deferred.promise();},onLoadRequest:function(rawData){return this.message.type==jscape.As2Message.Type.RECEIPT?jscape.API.getAs2MessageRequestView(this.domainName,this.message.id,rawData):jscape.API.getAs2MessageView(this.domainName,this.message.id,rawData);},onLoadReceipt:function(rawData){return this.message.type==jscape.As2Message.Type.REQUEST?jscape.API.getAs2MessageReceiptView(this.domainName,this.message.id,rawData):jscape.API.getAs2MessageView(this.domainName,this.message.id,rawData);},onCancel:function(dialog){dialog.destroy();this.deferred.resolve();this.deferred=null;this.message=null;}});jscape.domain.ViewAs2MessageDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#as2-viewrecord"),{width:"77%",height:"80%",modal:true,resizable:true,closable:true,closed:true,buttons:[{text:window.R.string.AS2_MESSAGES_BUTTON_REQUEST,id:"request-btn",toggle:true,onClick:$.proxy(this._onClick$Request,this)},{text:window.R.string.AS2_MESSAGES_BUTTON_RECEIPT,id:"receipt-btn",toggle:true,onClick:$.proxy(this._onClick$Receipt,this)},{text:window.R.string.AS2_MESSAGES_BUTTON_RAW_DATA,id:"raw-data-bth",toggle:true,onClick:$.proxy(this._onClick$RawView,this)},{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}]});this.content=$("#as2-view-record-accordion"+this.getIdSuffix()).accordion({fit:true,border:false,selected:-1,onSelect:$.proxy(this._onSelect$View,this),onUnselect:$.proxy(this._onUnselect$View,this)});this.requestData=$("table[role=grid][aria-label=requestview]",this.dialog).propertygrid({fit:true,height:"auto",loader:$.proxy(this._onLoad$Request,this),onBeforeLoad:function(){return!initializing;}});this.receiptData=$("table[role=grid][aria-label=receiptview]",this.dialog).propertygrid({fit:true,height:"auto",loader:$.proxy(this._onLoad$Receipt,this),onBeforeLoad:function(){return!initializing;}});this.requestRawData=$("div[aria-label=requestrawview]",this.dialog).hide();this.receiptRawData=$("div[aria-label=receiptrawview]",this.dialog).hide();var buttonBar=this.dialog.dialog("dialog").find(".dialog-button");this.requestButton=buttonBar.children("#request-btn").css("float","left");this.receiptButton=buttonBar.children("#receipt-btn").css("float","left");this.rawDataButton=buttonBar.children("#raw-data-bth").css("float","left");initializing=false;},selectRequest:function(){this.requestButton.click();},selectReceipt:function(){this.receiptButton.click();},show:function(listener){this._super(listener||jscape.domain.ViewAs2MessageDialog.LISTENER);},_formatDate:function(value){return typeof value==="number"?window.moment(value).format("L, LT"):value;},_onLoad$Request:function(params,success,error){if(this._rawDataView()){this.listener.onLoadRequest(true).then($.proxy(function(data){this.requestData.propertygrid("getPanel").parent().hide();this.requestRawData.html("<pre>"+(data+"").escapeXml()+"</pre>").show();return[];},this)).then(success,error);}else{this.listener.onLoadRequest().then($.proxy(function(data){this.requestRawData.hide();this.requestData.propertygrid("getPanel").parent().show();return $.map(data,$.proxy(function(value,key){return{name:key,value:/date/i.test(key)?this._formatDate(value):value};},this));},this)).then(success,error);}},_onLoad$Receipt:function(params,success,error){if(this._rawDataView()){this.listener.onLoadReceipt(true).then($.proxy(function(data){this.receiptData.propertygrid("getPanel").parent().hide();this.receiptRawData.html("<pre>"+(data+"").escapeXml()+"</pre>").show();return[];},this)).then(success,error);}else{this.listener.onLoadReceipt().then($.proxy(function(data){this.receiptRawData.hide();this.receiptData.propertygrid("getPanel").parent().show();return $.map(data,$.proxy(function(value,key){return{name:key,value:/date/i.test(key)?this._formatDate(value):value};},this));},this)).then(success,error);}},_onSelect$View:function(title,index){if(!(this.content&&this.content.length)){return;}
var panel=this.content.accordion("getPanel",index);if(this._requestPanel(panel)){this.requestButton.linkbutton("select");this.requestData.propertygrid("reload");}else if(this._receiptPanel(panel)){this.receiptButton.linkbutton("select");this.receiptData.propertygrid("reload");}},_onUnselect$View:function(title,index){if(!(this.content&&this.content.length)){return;}
var panel=this.content.accordion("getPanel",index);if(this._requestPanel(panel)){this.requestButton.linkbutton("unselect")}else if(this._receiptPanel(panel)){this.receiptButton.linkbutton("unselect");}},_onClick$Request:function(){var panels=this.content.accordion("panels");for(var i=0;i<panels.length;i++){var panel=panels[i];if(this._requestPanel(panel)){if(!panel.panel("options").selected){this.content.accordion("select",i);}
break;}}},_onClick$Receipt:function(){var panels=this.content.accordion("panels");for(var i=0;i<panels.length;i++){var panel=panels[i];if(this._receiptPanel(panel)){if(!panel.panel("options").selected){this.content.accordion("select",i);}
break;}}},_onClick$RawView:function(){var panel=this.content.accordion("getSelected");if(panel){var index=this.content.accordion("getPanelIndex",panel);this._onSelect$View(panel.panel("options").title,index);}},_rawDataView:function(){return this.rawDataButton.linkbutton("options").selected;},_requestPanel:function(panel){return panel&&"as2-message-request"==panel.attr("id");},_receiptPanel:function(panel){return panel&&"as2-message-receipt"==panel.attr("id");}});jscape.domain.ViewAs2MessageDialog.LISTENER={onLoadRequest:$.noop,onLoadReceipt:$.noop};jscape.domain.As2ResendMessageController=Class.extend({initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,message){if(!this.allowed){return $.Deferred().reject().promise();}
return this._confirmResend(message).then(function(){return jscape.API.resendAs2Message(domainName,message.id);});},_confirmResend:function(message){return jscape.ConfirmDialog.confirm(window.R.string.AS2_MESSAGES_CONFIRM_RESEND_TITLE,window.R.string.AS2_MESSAGES_CONFIRM_RESEND_MESSAGE.supplant({0:message.messageId}),undefined,{width:"50%",minWidth:500});}});jscape.domain.As2DeleteMessageController=Class.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,messages){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._confirmDelete(messages).done($.proxy(this._deleteConfirmed,this,messages)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},_confirmDelete:function(messages){return jscape.ConfirmDialog.confirm(window.R.string.AS2_MESSAGES_CONFIRM_DELETE_TITLE,window.R.string.AS2_MESSAGES_CONFIRM_DELETE_MESSAGE);},_deleteConfirmed:function(messages){$.when.apply(jQuery,$.map(messages,$.proxy(function(message){return jscape.API.deleteAs2Message(this.domainName,message.id);},this))).done($.proxy(function(){this.deferred.resolve(messages);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});