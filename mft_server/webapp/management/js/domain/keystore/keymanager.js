/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.domain.KeystoreModule=jscape.domain.DomainModule.extend({initialize:function(kca){this.kca=kca;},onCreate:function(_,app){this._super.apply(this,arguments);this._initValidators();var serverKeys=new jscape.domain.ServerKeysModule(this.kca);app.register("server-keys",serverKeys);serverKeys.onCreate.apply(serverKeys,arguments);var hostKeys=new jscape.domain.HostKeysModule(this.kca);app.register("host-keys",hostKeys);hostKeys.onCreate.apply(hostKeys,arguments);var clientKeys=new jscape.domain.ClientKeysModule(this.kca);app.register("client-keys",clientKeys);clientKeys.onCreate.apply(clientKeys,arguments);var pgpKeys=new jscape.domain.PgpKeysModule(this.kca);app.register("pgp-keys",pgpKeys);pgpKeys.onCreate.apply(pgpKeys,arguments);var keysReport=new jscape.domain.KeysReportModule(this.kca);app.register("key-expiry-report",keysReport);keysReport.onCreate.apply(keysReport,arguments);},_initValidators:function(){var v=new jscape.Validator();v.rule("keystore_confirmpwd",$.proxy(this._passwordConfirmed,this),window.R.string.KEY_MANAGER_EXPORT_KEYS_ERROR_CONFIRM_PASSWORD);},_passwordConfirmed:function(value,params){return value==$(params[0]).val();}});jscape.domain.KeysReportModule=jscape.domain.DomainModule.extend({view:null,onStart:function(){if(this.view==null){this.view=new jscape.domain.KeyExpirationView();}
this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(){return $.when(jscape.API.getServerKeys(this.domainName,""),jscape.API.getClientPublicKeys(this.domainName),jscape.API.getClientCertificates(this.domainName),jscape.API.getPgpPublicKeys(this.domainName),jscape.API.getPgpSecretKeys(this.domainName));}});jscape.domain.KeyExpirationView=Class.extend({DATE_FORMAT:new jscape.DateFormat("{MM}-{dd}-{yy}"),initialize:function(){var initializing=true;this.fieldset=$("#keys-expiry-report-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=keyexpiryreport]",this.fieldset);this.data.propertygrid({fit:true,minHeight:300,height:"auto",showGroup:true,columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"25%",fixed:true},{field:"value",title:$("thead th:nth-child(2)",this.data).text(),width:"70%",align:"right",formatter:$.proxy(this._formatExpirationDate,this),styler:$.proxy(this._styleExpirationDate,this)}]],loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onLoadFilter$Data,this),onBeforeLoad:function(){return!initializing;}});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.KeyExpirationView.LISTENER;},refresh:function(){this.data.propertygrid("reload");},_formatExpirationDate:function(value){return $.isNumeric(value)?this.DATE_FORMAT.format(new Date(value)):value==null?window.R.string.KEY_MANAGER_REPORT_DATE_NON_EXPIRING:"";},_styleExpirationDate:function(value){return $.isNumeric(value)?value<new Date().getTime()?"color:red":"color:green":null;},_keyGroupFor:function(key){switch(key.type){case"server":return window.R.string.KEY_MANAGER_REPORT_GROUP_SERVER_KEYS;case"client":return window.R.string.KEY_MANAGER_REPORT_GROUP_CLIENT_KEYS;case"pgp":return window.R.string.KEY_MANAGER_REPORT_GROUP_PGP_KEYS;default:return null;}},_onLoad$Data:function(_,success,error){this.listener.onRefresh().then(function(serverKeys,clientPublicKeys,clientCertificates,pgpPublicKeys,pgpSecretKeys){return[].concat($.map(serverKeys,function(key){return $.extend(key,{type:"server"});}),$.map(clientPublicKeys,function(key){return $.extend(key,{type:"client"});}),$.map(clientCertificates,function(key){return $.extend(key,{type:"client"});}),$.map(pgpPublicKeys,function(key){return $.extend(key,{type:"pgp"});}),$.map(pgpSecretKeys,function(key){return $.extend(key,{type:"pgp"});}));}).done(success).fail(error);},_onLoadFilter$Data:function(data){if($.isArray(data)){data={total:data.length,rows:data};}
if(data.rows&&data.rows.length){data.rows=$.map(data.rows,$.proxy(function(key){var expires=key.hasOwnProperty("certificateEndDate")?parseInt(key.certificateEndDate):key.hasOwnProperty("expirationDate")?parseInt(key.expirationDate):NaN;return{name:key.name,value:!isNaN(expires)?expires:null,group:this._keyGroupFor(key),editor:null};},this));}
return data;}});jscape.domain.KeyExpirationView.LISTENER={onRefresh:$.noop};jscape.domain.ViewKeySummaryController=Class.extend({deferred:null,start:function(domainName,alias){this.domainName=domainName;this.alias=alias;this.deferred=$.Deferred();this._setupDialog(alias).show(this);return this.deferred.promise();},onCancel:function(dialog){dialog.destroy();this.deferred.resolve();this.deferred=null;},onLoadData:function(){throw"Not implemented";},_setupDialog:function(alias){var dialog=new jscape.domain.ViewKeySummaryDialog();dialog.setTitle(alias);return dialog;}});jscape.domain.ViewKeySummaryDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#d-keysummary-view"),{width:"70%",height:"75%",buttons:[{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}],onResize:$.proxy(function(){this.data&&this.data.propertygrid("resize");},this)});this.fieldset=this.dialog.find(".content").layout({fit:true,border:false,doSize:false}).first();this.data=$("table[role=grid][aria-label=summary]",this.dialog).propertygrid({fit:true,nowrap:false,sortName:"name",columns:[[{field:"name",width:"25%",sortable:true,styler:function(){return"font-weight: bold; border-color: transparent";}},{field:"value",width:"73%",styler:function(){return"border-color: transparent; overflow-wrap: break-word; word-break: break-word";}}]],onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onFilter$Data,this)});this.title=this.dialog.dialog("header").text()||"";initializing=false;},setTitle:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value||""}));},show:function(listener){this._super(listener);this.data.datagrid("reload");this.fieldset.layout("resize");},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onFilter$Data:function(data){return $.map(data||{},function(val,key){return{name:key,value:val};});}});jscape.domain.ImportPublicKeyDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkey-import"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=importpubkeyfields]",this.dialog);this.alias=$("input[name=alias]",this.fieldset).textbox({required:true});},getAlias:function(){return this.alias.textbox("getValue");},show:function(listener){this._super(listener);this.alias.textbox("textbox").focus();}});jscape.domain.ImportPublicKeysBatchDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkey-importjson"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=importpubkeyfields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,multiple:false,missingMessage:window.R.string.KEY_MANAGER_ERROR_BAD_JSON_FILE,width:"60%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},isOverwrite:function(){return this.overwrite.is(":checked");},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});jscape.domain.ImportPublicKeyTslDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkey-import-tsl"),{width:530,resizable:false});this.fieldset=$("fieldset[name=importpubkeyfields]",this.dialog);this.url=$("input[name=url]",this.fieldset).textbox({required:true,validType:"non_empty",invalidMessage:window.R.string.KEY_MANAGER_ERROR_BAD_URL,width:"60%"});},getUrl:function(){return this.url.textbox("getValue");}});jscape.domain.ExportDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog){this._super(dialog,{width:530,resizable:false});this.fieldset=$("fieldset[name=exportkeyfields]",this.dialog);this.filename=$("input[name=filename]",this.fieldset).textbox({required:true,missingMessage:window.R.string.KEY_MANAGER_EXPORT_KEYS_ERROR_BAD_FILENAME,width:"55%"});this.format=$("select[name=format]",this.fieldset).combobox({required:true,editable:false,width:"35%",panelHeight:"auto"});},getFilename:function(){return this.filename.textbox("getValue");},setFilename:function(value){this.filename.textbox("setValue",value);},getFormat:function(){return this.format.combobox("getValue");},show:function(listener){this._super(listener);this.filename.textbox("textbox").focus();}});jscape.domain.ExportPublicKeyDialog=jscape.domain.ExportDialog.extend({initialize:function(){this._super($("#d-publickey-export"));}});jscape.domain.ExportPrivateKeyDialog=jscape.domain.ExportDialog.extend({initialize:function(){this._super($("#d-privatekey-export"));var passwordId="pwd_"+Math.random().toString(36).substr(2);this.password=$("input[name=password]",this.fieldset).attr("id",passwordId).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.password.passwordbox("textbox").on("input",$.proxy(function(){var enabled=this.password.passwordbox("textbox").val().length!=0;this.confirmPassword.passwordbox(enabled?"enableValidation":"disableValidation").passwordbox("validate");},this));this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox({required:true,lastDelay:0,validateOnBlur:true,validType:"keystore_confirmpwd['#"+passwordId+"']",missingMessage:window.R.string.KEY_MANAGER_EXPORT_KEYS_ERROR_CONFIRM_PASSWORD,width:"50%"});},getPassword:function(){return this.password.passwordbox("getValue");},show:function(){this._super.apply(this,arguments);this.password.passwordbox("textbox").triggerHandler("input");}});jscape.domain.ExportCertificateDialog=jscape.domain.ExportDialog.extend({initialize:function(){this._super($("#d-certificate-export"));}});