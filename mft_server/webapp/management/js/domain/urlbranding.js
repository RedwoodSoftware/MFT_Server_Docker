/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.WebTheme=Class.extend({initialize:function(a,b,c,d,e){this.name=a||"";this.owner=b||"";this.encodedLogo=c||"";this.uri=d||"";this.tags=e||[];}});jscape.WebTheme.fromJSON=function(data){return data?new jscape.WebTheme(data.name,data.owner,data.encodedLogo,data.uri,data.tags):null;};jscape.domain.UrlBrandingModule=jscape.domain.DomainModule.extend({onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.UrlBrandingController();this.controller.onCreate(this.domainName);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.UrlBrandingController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this._initValidators();},onCreate:function(domainName){this.domainName=domainName;this.addController=new jscape.domain.AddUrlBrandingController();this.editController=new jscape.domain.EditUrlBrandingController();this.deleteController=new jscape.domain.DeleteUrlBrandingController();},onStart:function(){if(this.view==null){this.view=new jscape.domain.UrlBrandingView();}
this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listWebThemes(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onCopyLink:function(theme,target){return jscape.API.getWebThemeURI(this.domainName,theme.name).then(function(data){if(data&&data.uri){return new jscape.CopyToClipboardController().start(data.uri,target,window.R.string.APPLICATION_MESSAGE_COPIED,"top");}
return data;});},onAddTheme:function(){this.addController.start(this.domainName).done($.proxy(this._themeAdded,this));},onEditTheme:function(theme){var index=$.inArray(theme,this.view.getWebThemes());if(index!=-1){this.editController.start(this.domainName,theme).done($.proxy(this._themeEdited,this,index));}},onDeleteTheme:function(theme){this.deleteController.start(this.domainName,theme).done($.proxy(this._themeDeleted,this,theme));},_themeAdded:function(theme){this._recordAdded(theme);},_themeEdited:function(index,theme){this._recordEdited(theme);},_themeDeleted:function(themes){this._recordDeleted(themes);},_initValidators:function(){var v=new jscape.Validator();v.rule("webtheme_name",$.proxy(this._themeNameValid,this),window.R.string.WEB_THEME_ERROR_BAD_NAME);v.rule("webtheme_unique",$.proxy(this._themeNotExists,this),window.R.string.WEB_THEME_ERROR_ALREADY_EXIST);v.rule("webtheme_logo",$.proxy(this._logoLoaded,this),window.R.string.WEB_THEME_ERROR_LOAD_LOGO);},_themeNameValid:function(name){return name!=null&&/^[a-zA-Z0-9]+$/i.test(name);},_themeNotExists:function(name){var values=$.map(this.view.getWebThemes(),function(theme){return theme.name==name;});return $.inArray(name,values)==-1;},_logoLoaded:function(_,params){return!!$(params[0]).data("logo_loaded");}});jscape.domain.UrlBrandingView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#url-branding-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=urlbranding]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,singleSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:90},{field:"owner",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:90},{field:"uri",title:$("thead th:nth-child(3)",this.data).text(),searchable:false,width:110},{field:"tags",title:$("thead th:nth-child(4)",this.data).text(),width:80,formatter:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();}}]],onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustButtonsState,this)});this.copyLinkButton=$("a[role=button][name=copylink]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.logoButton=$("a[role=button][name=logo]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$LogoButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.UrlBrandingView.LISTENER;this._adjustButtonsState();},getWebThemes:function(){return this.getRecords();},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).done(success).fail(error);},_onClick$CopyLinkButton:function(){this.listener.onCopyLink(this.selection[0],this.copyLinkButton);},_onClick$AddButton:function(){this.listener.onAddTheme();},_onClick$EditButton:function(){this.listener.onEditTheme(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteTheme(this.selection);},_onClick$LogoButton:function(){var theme=this.data.datagrid("getSelected");var row=this.data.datagrid("options").finder.getTr(this.data[0],null,"selected").find("td:first");row.tooltip({position:"bottom",content:"<img src=\"data:image/png;base64,"+theme.encodedLogo+"\"/>",onShow:function(){var t=$(this);$(document).one("click",function(e){e.stopPropagation();t.tooltip("hide");t=null;})},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.logoButton,"-",this.copyLinkButton]);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var length=this.selection.length;this.copyLinkButton.linkbutton(length==1?"enable":"disable");this.editButton.linkbutton(length==1?"enable":"disable");this.logoButton.linkbutton(length==1?"enable":"disable");this.deleteButton.linkbutton(length!=0?"enable":"disable");}});jscape.domain.UrlBrandingView.LISTENER={onRefresh:$.noop,onCopyLink:$.noop,onAddTheme:$.noop,onEditTheme:$.noop,onDeleteTheme:$.noop};jscape.domain.BaseUrlBrandingController=Class.extend({DATA_URL:{pattern:/data:image\/.*;base64,(.+)/,template:"data:{0};base64,{1}",placeholder:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"},onLoadPreview:function(files){var deferred=$.Deferred();var promise=deferred.promise();if(files&&files.length&&window.FileReader){var type=files[0].type;var reader=new FileReader();reader.onload=$.proxy(function(e){var data=this.DATA_URL.pattern.test(e.target.result)?e.target.result:this.DATA_URL.template.supplant({0:type||"image/png",1:e.target.result||""});deferred.resolve(data);reader.onload=reader.onerror=null;type=reader=null;},this);reader.onerror=$.proxy(function(){deferred.reject();reader.onload=reader.onerror=null;type=reader=null;},this);reader.readAsDataURL(files[0]);}else{deferred.reject();}
return promise;},onGenerateLink:function(themeName){return!!themeName?jscape.API.getWebThemeURI(this.domainName,themeName).then(function(data){return data&&data.uri?data.uri:data||""},function(){return"";}):$.Deferred().reject().promise();},onCopyLink:function(themeName,target){return this.onGenerateLink(themeName).then(function(data){if(!!data){return new jscape.CopyToClipboardController().start(data,target,window.R.string.APPLICATION_MESSAGE_COPIED,"top");}
return data;});},onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},_createWebTheme:function(dialog,name,themeUri){var matches=this.DATA_URL.pattern.exec(dialog.getLogoData());var logoData=matches&&matches.length>1?matches[1]:"";return new jscape.WebTheme(name,dialog.getOwner(),logoData,themeUri,dialog.getTags());}});jscape.domain.AddUrlBrandingController=jscape.domain.BaseUrlBrandingController.extend({deferred:null,start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var theme=this._createWebTheme(dialog,dialog.getName(),null);return jscape.API.addWebTheme(this.domainName,theme).done($.proxy(function(theme){this.deferred.resolve(theme);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.AddUrlBrandingDialog();jscape.API.getAccountAdminNames(this.domainName).done(function(owners){dialog.setOwners(owners.sort());});return dialog;}});jscape.domain.EditUrlBrandingController=jscape.domain.BaseUrlBrandingController.extend({deferred:null,start:function(domainName,theme){this.domainName=domainName;this.theme=theme;this.themeName=theme.name;this.themeUri=theme.uri;this.deferred=$.Deferred();jscape.API.getWebTheme(this.domainName,this.themeName).done($.proxy(function(theme){this._setupDialog(theme).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},hasChanged:function(dialog){return!Object._equals(this.theme,this._createWebTheme(dialog,this.themeName,this.themeUri));},onSubmit:function(dialog){var theme=this._createWebTheme(dialog,this.themeName,this.themeUri);return jscape.API.setWebTheme(this.domainName,theme.name,theme).done($.proxy(function(){this.deferred.resolve(theme);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(theme){var dialog=new jscape.domain.EditUrlBrandingDialog();if(theme){var logoData=!!theme.encodedLogo?this.DATA_URL.template.supplant({0:"image/png",1:theme.encodedLogo}):this.DATA_URL.placeholder;dialog.setName(theme.name);dialog.setLogoData(logoData);dialog.setUri(theme.uri||"");dialog.setTags(theme.tags);}
jscape.API.getAccountAdminNames(this.domainName).done(function(owners){dialog.setOwners(owners.sort());theme&&dialog.setOwner(theme.owner);});return dialog;}});jscape.domain.UrlBrandingDialog=jscape.ui.DefaultDialog.extend({DATA_URL_RE:/data:image\/.*;base64,(.+)/,initialize:function(dialog){var initializing=true;this._super(dialog,{width:"60%",minWidth:670,maxWidth:870,height:"60%"});var logoPreviewId=this.idFor("_logo");this.logo=$("div[aria-label=logopreview]",this.fieldset).panel({fit:true,border:true,noheader:true,id:logoPreviewId,extractor:$.proxy(this._onExtract$LogoPreview,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$LogoPreview,this),onLoad:$.proxy(this._onLoadComplete$LogoPreview,this,true),onLoadError:$.proxy(this._onLoadComplete$LogoPreview,this,false)});this.logo.panel("panel").on("dblclick contextmenu",$.proxy(function(e){e.stopPropagation();e.preventDefault();var id=this.logoFile.filebox("options").fileboxId||"";this.logoFile.filebox("button").find("label[for="+id+"]").click();},this));this.logoFile=$("input[name=logo]",this.fieldset).filebox({required:true,accept:"image/*",multiple:false,validType:"webtheme_logo['#"+logoPreviewId+"']",missingMessage:window.R.string.WEB_THEME_ERROR_BAD_LOGO,onChange:$.proxy(function(){this.logo.panel("refresh","about:blank");},this),width:"60%"});this.ownedBy=$("input[name=ownedby]:checkbox",this.fieldset);this.ownedBy.change($.proxy(function(){this.owner.combobox(this.ownedBy.is(":checked:not(:disabled)")?"enable":"disable");},this));this.owner=$("select[name=owner]",this.fieldset);this.owner.combobox({required:false,editable:true,limitToList:true,disabled:true,width:120,panelHeight:"auto",panelMinHeight:50,onLoadSuccess:$.proxy(function(data){if(data.length==0){this.ownedBy.prop("disabled",true).prop("checked",false).change();}},this)});this.tags=$("select[name=tags]",this.fieldset).tagbox({limitToList:jscape.acl&&!jscape.acl.tic,hasDownArrow:true,loader:$.proxy(this._onLoad$Tags,this),onBeforeLoad:function(){return!initializing;},onAddTag:$.proxy(this._onClick$AddTagButton,this),tagEditor:$("#d-add-tag-inline"),width:"60%",panelHeight:"auto",panelMinHeight:50});this.uri=$("span[aria-label=themeuri]",this.fieldset);this.copyLinkButton=$("a[role=button][name=copylink]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)}).hide();this._adjustButtonsBarLayout(this.fieldset.layout("panel","center").find(".content"));initializing=false;},show:function(listener){this._super(listener);this.tags.tagbox("reload");},getName:function(){return this.themeName;},setName:function(value){this.themeName=value;},getLogoData:function(){return this.logo.panel("options").href||"";},setLogoData:function(value){if(!!value){this.logo.panel("body").html(this._onExtract$LogoPreview(value));this._onLoadComplete$LogoPreview(true,value);}else{this._onLoadComplete$LogoPreview(false);}},getOwner:function(){return this.ownedBy.is(":checked:not(:disabled)")?this.owner.combobox("getValue"):null;},setOwner:function(value){this.ownedBy.prop("checked",!!value).change();if(value){this.owner.combobox("clear").combobox("select",value);}},setOwners:function(values){this.owner.combobox("loadData",values);},getTags:function(){return this.tags.tagbox("getValues");},setTags:function(values){this.tags.tagbox("setValues",values);},setUri:function(value){value=value||"";this.uri.text(value);if(!!value){this.copyLinkButton.linkbutton("enable").show();}else{this.copyLinkButton.linkbutton("disable").hide();}},_onClick$AddTagButton:function(tag){this.listener.onAddTag(tag).done($.proxy(function(){this.tags.tagbox("reload");},this));},_onLoad$Tags:function(params,success,error){this.listener.onLoadTags(params).done(success).fail(error);},_onLoad$LogoPreview:function(params,success,error){var files=$.grep(this.logoFile.filebox("files"),function(file){return file&&file.type.match("image.*");});this.listener.onLoadPreview(files).then(success,error);},_onLoadComplete$LogoPreview:function(success,dataUrl){if(!success){this.logo.data("logo_loaded",false);this.logo.panel("options").href="";this.logo.panel("clear").panel("body").html(String(this.logoFile.filebox("options").missingMessage).escapeXml());}else{this.logo.panel("options").href=dataUrl;this.logo.data("logo_loaded",true);}
this.logoFile.filebox("validate");this._onForm$Change();},_onExtract$LogoPreview:function(value){if(!value||!this.DATA_URL_RE.test(value)){return String(this.logoFile.filebox("options").missingMessage).escapeXml();}
return'<img src="{data}" alt="" />'.supplant({data:String(value||"").escapeXml()});},_onClick$CopyLinkButton:function(){this.listener.onCopyLink(this.getName(),this.copyLinkButton);},_fileInputOf:function(filebox){return filebox.filebox("files");}});jscape.domain.AddUrlBrandingDialog=jscape.domain.UrlBrandingDialog.extend({INPUT_DELAY:800,timerId:null,initialize:function(){this._super($("#d-webtheme-add"));this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["webtheme_name","webtheme_unique"],missingMessage:window.R.string.WEB_THEME_ERROR_BAD_NAME,onChange:$.proxy(function(){if(this.name.textbox("isValid")){this._startTimer(this.getName(),0);}},this),inputEvents:{input:$.proxy(function(e){var val=$(e.data.target).textbox("textbox").val();if(new jscape.Validator().isSatisfied("webtheme_name",val)){this._startTimer(val,this.INPUT_DELAY);}else{this._startTimer("",0);}},this)},width:"60%"});},show:function(){this._super.apply(this,arguments);this._stopTimer();},getName:function(){return this.name.textbox("getText");},_startTimer:function(value,delay){this._stopTimer();this.timerId=setTimeout($.proxy(this._adjustBrandingUri,this,value),delay||0);},_stopTimer:function(){var timer=this.timerId;this.timerId=null;!!timer&&clearTimeout(timer);},_adjustBrandingUri:function(themeName){return this.listener.onGenerateLink(themeName).then($.proxy(function(value){this.setUri(value);},this),$.proxy(function(){this.setUri("");},this));}});jscape.domain.EditUrlBrandingDialog=jscape.domain.UrlBrandingDialog.extend({initialize:function(){this._super($("#d-webtheme-edit"));this.title=this.dialog.dialog("header").text()||"";},setName:function(value){this._super(value);this.dialog.dialog("setTitle",this.title.supplant({0:value}));},setLogoData:function(data){if(data&&data.trim().length){this.logoFile.filebox("textbox").validatebox("options").required=false;}
this._super(data);}});jscape.domain.DeleteUrlBrandingController=Class.extend({deferred:null,start:function(domainName,themes){this.domainName=domainName;this.deferred=$.Deferred();this._confirmDelete(themes).done($.proxy(this._deleteConfirmed,this,themes)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(themes){var text=$.map(themes,function(theme){return theme.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.WEB_THEME_CONFIRM_DELETE_TITLE,window.R.string.WEB_THEME_CONFIRM_DELETE_MESSAGE.supplant({0:text.escapeXml()}),false);},_deleteConfirmed:function(themes){$.when.apply(jQuery,$.map(themes,$.proxy(function(theme){return jscape.API.deleteWebTheme(this.domainName,theme.name);},this))).done($.proxy(function(){this.deferred.resolve(this.themes);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});