/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.domain.wizard=jscape.domain.wizard||{};jscape.DomainDescriptor=Class.extend({initialize:function(a,b,c){this.name=a||"";this.description=b||"";this.services=c||[];}});jscape.DomainDescriptor.fromJSON=function(data){return data?$.extend(new jscape.DomainDescriptor(),data):null;};jscape.domain.CreateDomainModule=jscape.ApplicationModule.extend({onStart:function(){$(document).on("selectmenu",$.proxy(this._onSelect$MenuItem,this));},onStop:function(){$(document).off("selectmenu");},_onSelect$MenuItem:function(e,id){if("menu-add-domain"==id){e.stopPropagation();return this.onAddDomain();}},onAddDomain:function(){var c=new jscape.domain.NewDomainController();return c.start().then($.proxy(function(domainName,editAfterDone){if(!!editAfterDone){jscape.API.editDomain(domainName);return $.Deferred().reject().promise();}
$(document).triggerHandler("broadcast",[window.R.string.DOMAIN_SUCCESS_ADD_MESSAGE]);return domainName;},this));}});jscape.domain.NewDomainController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onPageSelected:function(page){},onSubmit:function(dialog){try{var descriptor=this._createDescriptor(dialog);return jscape.API.storeDomain(descriptor).catch(function(){return $.Deferred().reject();}).then($.proxy(function(){return jscape.API.startDomain(descriptor.name).then(function(){return descriptor.name;}).catch(function(){return descriptor.name;});},this)).done($.proxy(function(domainName){this.deferred.resolve(domainName,dialog.isEditAfterDone());},this));}catch(e){this.deferred.reject();return this.deferred;}},onCancel:function(dialog){dialog.destroy();this.deferred.reject();},_setupDialog:function(){var dialog=new jscape.domain.AddDomainDialog();var pc=dialog.addItem(new jscape.domain.wizard.DomainParametersController(dialog.getParametersPage()));var tc=dialog.addItem(new jscape.domain.wizard.TransportServiceController(dialog.getTransportPage()));var lc=dialog.addItem(new jscape.domain.wizard.LogServiceController(dialog.getLoggingPage()));pc.start();tc.start();lc.start();dialog.setEditAfterDone(true);return dialog;},_createDescriptor:function(dialog){return new jscape.DomainDescriptor(dialog.getDomainName(),dialog.getDomainDescription(),dialog.getDomainServices());}});jscape.domain.AddDomainDialog=jscape.view.WizardDialog.extend({initialize:function(){this._super($("#domain-add-wizard"),{width:"50%",height:520,minHeight:520,maxHeight:"60%"});this.fieldset=$("#createdomainfields"+this.getIdSuffix()).layout({fit:true,doSize:false,border:false});this.parametersPage=new jscape.domain.wizard.DomainParametersView(this);this.transportPage=new jscape.domain.wizard.TransportServiceView(this);this.loggingPage=new jscape.domain.wizard.LogServiceView(this);this.editAfterDone=$("input[name=editafterdone]:checkbox",this.dialog);},getParametersPage:function(){return this.parametersPage;},getTransportPage:function(){return this.transportPage;},getLoggingPage:function(){return this.loggingPage;},getDomainName:function(){return this.parametersPage.getName();},getDomainDescription:function(){return this.parametersPage.getDescription();},isEditAfterDone:function(){return this.editAfterDone.is(":checked");},setEditAfterDone:function(value){this.editAfterDone.prop("checked",!!value);},getDomainServices:function(){return $.map(this.items,function(item){return item.applyChanges();});}});jscape.domain.wizard.BaseDomainServiceView=Class.extend({fieldset:null,initialize:function(fieldset){this.fieldset=fieldset.hide();},valid:function(){return this.fieldset.form("validate");},show:function(){this.fieldset.show().form("validate");this.fieldset.find(":input:visible:not(:disabled)").first().focus();},hide:function(){this.fieldset.hide();}});jscape.domain.wizard.BaseTransportServiceView=jscape.domain.wizard.BaseDomainServiceView.extend({show:function(listener){this.listener=listener||jscape.domain.wizard.BaseTransportServiceView.LISTENER;this._super();},_onLoad$ServerAddresses:function(params,success,error){this.listener.onLoadServerAddresses(params).done(success).fail(error);},_onLoad$ServerKeys:function(params,success,error){this.listener.onLoadServerKeys(params).done(success).fail(error);}});jscape.domain.wizard.BaseTransportServiceView.LISTENER={onLoadServerAddresses:$.noop,onLoadServerKeys:$.noop};jscape.domain.wizard.DomainParametersController=jscape.view.WizardDialog.Page.extend({domainNames:null,initialize:function(view){this.view=view;this._initValidators();},start:function(){jscape.API.getDomainNames().done($.proxy(function(names){this.domainNames=names||[];},this)).fail($.proxy(function(){this.domainNames=[];},this));},resume:function(){this.view.show();},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return null;},getDomainName:function(){return this.view.getName();},getDomainDescription:function(){return this.view.getDescription();},_initValidators:function(){var v=new jscape.Validator();v.rule("domain_name",$.proxy(this._domainNameValid,this),window.R.string.DOMAIN_ERROR_BAD_NAME);v.rule("domain_unique",$.proxy(this._domainNotExists,this),window.R.string.DOMAIN_ERROR_NAME_EXISTS);v.rule("domain_description",$.proxy(this._domainDescriptionValid,this),window.R.string.DOMAIN_ERROR_BAD_DESCRIPTION);},_domainNotExists:function(value){return $.inArray(value,this.domainNames)==-1;},_domainNameValid:function(value){return value&&value.trim().length!=0&&value.charAt(value.length-1)!=' '&&!/[<>\\/]/g.test(value);},_domainDescriptionValid:function(value){return typeof value!=="string"||value.length<1024;}});jscape.domain.wizard.DomainParametersView=Class.extend({initialize:function(dialog){this.fieldset=$("#"+dialog.getId()).find("fieldset[name=domainparametersfields]").hide();this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["domain_name","domain_unique"],missingMessage:window.R.string.DOMAIN_ERROR_BAD_NAME,width:"65%"});this.description=$("textarea[name=description]",this.fieldset).textbox({required:false,multiline:true,validType:"domain_description",width:"65%",height:150});},getName:function(){return this.name.textbox("getValue");},getDescription:function(){return this.description.textbox("getValue");},show:function(){this.fieldset.show();this.name.textbox("textbox").focus();},hide:function(){this.fieldset.hide();},valid:function(){return this.fieldset.form("validate");}});jscape.domain.wizard.TransportServiceController=jscape.view.ListView.extend({initialize:function(view){this._super();this.view=view;this.addItem(jscape.TransportService.Protocol.AFTP,jscape.domain.wizard.AftpServiceController);this.addItem(jscape.TransportService.Protocol.AS2,jscape.domain.wizard.As2ServiceController);this.addItem(jscape.TransportService.Protocol.FTP,jscape.domain.wizard.FtpServiceController);this.addItem(jscape.TransportService.Protocol.HTTP,jscape.domain.wizard.HttpServiceController);this.addItem(jscape.TransportService.Protocol.OFTP,jscape.domain.wizard.OftpServiceController);this.addItem(jscape.TransportService.Protocol.SFTP,jscape.domain.wizard.SftpServiceController);this.addItem(jscape.TransportService.Protocol.WEBDAV,jscape.domain.wizard.WebDavServiceController);},start:function(){this.serverKeys=null;this.serverAddresses=null;this.view.setAddService(true);this.view.setProtocol(jscape.TransportService.Protocol.FTP);},resume:function(){this.view.show(this);},pause:function(){this.view.hide();},valid:function(){if(this.view.isAddService()){var item=this.getItem(this.getCurrentItem());if($.type(item)==="object"){return item.valid();}}
return true;},applyChanges:function(){if(this.view.isAddService()){var item=this.getItem(this.getCurrentItem());if($.type(item)==="object"){return item._createDescriptor();}}
return null;},onChangeProtocol:function(protocol){this.setCurrentItem((protocol||"").toUpperCase());},onLoadServerKeys:function(){if(this.serverKeys){return $.Deferred().resolve(this.serverKeys).promise();}
return jscape.API.getServerKeys("_").then(function(keys){return $.map(keys,function(key){return key.name;});}).done($.proxy(function(keys){this.serverKeys=keys;},this));},onLoadServerAddresses:function(){if(this.serverAddresses){return $.Deferred().resolve(this.serverAddresses).promise();}
return jscape.API.getServerAddresses().then($.proxy(function(addresses){return $.map(addresses||[],$.proxy(function(value){return{text:this._formatHostname(value)||value,value:value};},this));},this)).done($.proxy(function(addresses){this.serverAddresses=addresses;},this));},_formatHostname:function(value){return jscape.ServerParameters.allHostsIpv4(value)?window.R.string.APPLICATION_HOST_ALL_IPV4:jscape.ServerParameters.allHostsIpv6(value)?window.R.string.APPLICATION_HOST_ALL_IPV6:value;},_createItem:function(item){var controller=new item(this.view.container());controller.start(this);return controller;}});jscape.domain.wizard.TransportServiceView=Class.extend({initialize:function(dialog){this.fieldset=$("#"+dialog.getId()).find("fieldset[name=domainservicefields]").hide();this.addService=$("[name=addservice]:checkbox",this.fieldset).change($.proxy(this._onChange$AddService,this));this.protocol=$("select[name=protocol]",this.fieldset);this.protocol.combobox({required:true,editable:false,formatter:$.proxy(this._formatProtocol,this),onChange:$.proxy(this._onChange$Protocol,this),onLoadSuccess:$.proxy(this._onLoad$Success,this),width:150,panelHeight:"auto",panelMaxHeight:"40%"});},isAddService:function(){return this.addService.is(":checked");},setAddService:function(value){this.addService.prop("checked",!!value).change();},getProtocol:function(){return this.isAddService()?this.protocol.combobox("getValue"):"";},setProtocol:function(value){var select=this.protocol.combobox("getValue");this.protocol.combobox("setValue",value);if(select===value){this._onChange$Protocol();}},container:function(){return this.fieldset;},show:function(listener){this.listener=listener||jscape.domain.wizard.TransportServiceView.LISTENER;this.fieldset.show();this.protocol.combobox("reset");this._onChange$Protocol();},hide:function(){this.fieldset.hide();},_formatProtocol:function(row){var text=row[this.protocol.combobox("options").textField];return!!row.disabled&&row.title?'<span aria-label="{tip}">{text}</span>'.supplant({tip:(row.title||"").escapeXml(),text:text}):text;},_onLoad$Success:function(){this.protocol.combobox("panel").find(".combobox-item").each(function(){var tip=$(this).find("span[aria-label]").attr("aria-label")||"";if(!!tip){$(this).on("mouseenter",function(){$(this).tooltip({content:String(tip).escapeXml(),position:"right",deltaX:$(this).parent().width()-$(this).width(),showEvent:"none",showDelay:0,hideEvent:"none",hideDelay:0,zIndex:"",onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");}).on("mouseleave",function(){$(this).tooltip("hide");});}});},_onChange$AddService:function(){this.protocol.combobox(this.isAddService()?"enable":"disable");this._onChange$Protocol();},_onChange$Protocol:function(){this.listener&&this.listener.onChangeProtocol(this.getProtocol());}});jscape.domain.wizard.TransportServiceView.LISTENER={onChangeProtocol:$.noop};jscape.domain.wizard.FtpServiceController=Class.extend({DEFAULTS:{"regular":{port:21,keyUsed:false},"explicit SSL":{port:21,keyUsed:true},"forced explicit SSL":{port:21,keyUsed:true},"implicit SSL":{port:990,keyUsed:true}},view:null,initialize:function(container){this.view=new jscape.domain.wizard.FtpServiceView(container);},start:function(listener){this.listener=listener;this.view.setType(jscape.TransportService.FTP_TYPE.EXPLICIT_SSL);},resume:function(){this.view.show(this);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},onLoadServerKeys:function(params){return this.listener.onLoadServerKeys(params);},onLoadServerAddresses:function(params){return this.listener.onLoadServerAddresses(params);},onChangeType:function(type){if(type&&this.DEFAULTS.hasOwnProperty(type)){this.view.setPort(this.DEFAULTS[type].port);this.view.setKeyUsed(this.DEFAULTS[type].keyUsed);}},_createDescriptor:function(){return jscape.TransportService.ftp(this.view.getHost(),this.view.getPort(),this.view.getType(),this.view.getKeyAlias());}});jscape.domain.wizard.FtpServiceView=jscape.domain.wizard.BaseTransportServiceView.extend({initialize:function(container){this._super($("fieldset[name=ftpservicefields]",container));var initializing=true;this.host=$("select[name=host]",this.fieldset).combobox({required:true,validType:"length[1,500]",missingMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,invalidMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerAddresses,this),width:200,panelWidth:"auto",panelHeight:"auto"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,width:80});this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onChange$Type,this),width:170,panelHeight:"auto"});this.key=$("select[name=privatekey]",this.fieldset).combobox({required:true,editable:false,width:170,panelHeight:"auto",onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerKeys,this)});initializing=false;},getHost:function(){return this.host.combobox("getValue");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value)).numberspinner("isValid");},getType:function(){return this.type.combobox("getValue");},setType:function(value){var select=this.type.combobox("getValue");this.type.combobox("setValue",value);if(select===value){this._onChange$Type();}},getKeyAlias:function(){return!this.key.combobox("options").disabled?this.key.combobox("getValue"):null;},setKeyUsed:function(value){this.key.combobox(!!value?"enable":"disable").combobox(!!value?"enableValidation":"disableValidation");},show:function(listener){this._super(listener);this.host.combobox("reload");this.key.combobox("reload");this._onChange$Type();},_onChange$Type:function(type){this.listener&&this.listener.onChangeType(type||this.getType());}});jscape.domain.wizard.FtpServiceView.LISTENER={onChangeType:$.noop};jscape.domain.wizard.OftpServiceController=Class.extend({DEFAULT_PORT:3305,view:null,initialize:function(container){this.view=new jscape.domain.wizard.OftpServiceView(container);},start:function(listener){this.listener=listener;this.view.setPort(this.DEFAULT_PORT);this.view.setUseSsl(true);this.view.setFileEncryptionRequired(true);this.view.setFileSignatureRequired(true);},resume:function(){this.view.show(this.listener);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},_createDescriptor:function(){return jscape.TransportService.oftp(this.view.getHost(),this.view.getPort(),this.view.getIdCode(),this.view.getKeyAlias(),this.view.isUseSsl(),this.view.isFileEncryptionRequired(),this.view.isFileSignatureRequired());}});jscape.domain.wizard.OftpServiceView=jscape.domain.wizard.BaseTransportServiceView.extend({initialize:function(container){this._super($("fieldset[name=oftpservicefields]",container));var initializing=true;this.host=$("select[name=host]",this.fieldset).combobox({required:true,validType:"length[1,500]",missingMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,invalidMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerAddresses,this),width:200,panelWidth:"auto",panelHeight:"auto"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,width:80});this.idCode=$("input[name=idcode]",this.fieldset).textbox({required:true,validType:"length[1,500]",missingMessage:window.R.string.DOMAIN_ERROR_BAD_ID_CODE,invalidMessage:window.R.string.DOMAIN_ERROR_BAD_ID_CODE,tipPosition:"bottom",width:310});this.key=$("select[name=privatekey]",this.fieldset).combobox({required:true,editable:false,width:170,panelHeight:"auto",onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerKeys,this)});this.useSsl=$("input[name=usessl]:checkbox",this.fieldset);this.fileEncryption=$("input[name=fileencryption]:checkbox",this.fieldset);this.fileSignature=$("input[name=filesignature]:checkbox",this.fieldset);initializing=false;},getHost:function(){return this.host.combobox("getValue");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",value);},getIdCode:function(){return this.idCode.textbox("getValue");},getKeyAlias:function(){return!this.key.combobox("options").disabled?this.key.combobox("getValue"):null;},isUseSsl:function(){return this.useSsl.is(":checked");},setUseSsl:function(value){this.useSsl.prop("checked",!!value);},isFileEncryptionRequired:function(){return this.fileEncryption.is(":checked");},setFileEncryptionRequired:function(value){this.fileEncryption.prop("checked",!!value);},isFileSignatureRequired:function(){return this.fileSignature.is(":checked");},setFileSignatureRequired:function(value){this.fileSignature.prop("checked",!!value);},show:function(listener){this._super(listener);this.host.combobox("reload");this.key.combobox("reload");}});jscape.domain.wizard.SftpServiceController=Class.extend({DEFAULT_PORT:22,view:null,initialize:function(container){this.view=new jscape.domain.wizard.SftpServiceView(container);},start:function(listener){this.listener=listener;this.view.setPort(this.DEFAULT_PORT);},resume:function(){this.view.show(this.listener);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},_createDescriptor:function(){return jscape.TransportService.sftp(this.view.getHost(),this.view.getPort(),this.view.getAuthentication(),this.view.getKeyAlias());}});jscape.domain.wizard.SftpServiceView=jscape.domain.wizard.BaseTransportServiceView.extend({initialize:function(container){this._super($("fieldset[name=sftpservicefields]",container));var initializing=true;this.host=$("select[name=host]",this.fieldset).combobox({required:true,validType:"length[1,500]",missingMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,invalidMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerAddresses,this),width:200,panelWidth:"auto",panelHeight:"auto"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,width:80});this.key=$("select[name=privatekey]",this.fieldset).combobox({required:true,editable:false,panelHeight:"auto",onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerKeys,this),width:170});this.auth=$("select[name=auth]",this.fieldset).combobox({required:true,editable:false,width:170,panelHeight:"auto"});initializing=false;},getHost:function(){return this.host.combobox("getValue");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value)).numberspinner("validate");},getAuthentication:function(){return this.auth.combobox("getValue");},getKeyAlias:function(){return!this.key.combobox("options").disabled?this.key.combobox("getValue"):null;},show:function(listener){this._super(listener);this.host.combobox("reload");this.key.combobox("reload");}});jscape.domain.wizard.AftpServiceController=Class.extend({DEFAULT_PORT:3000,view:null,initialize:function(container){this.view=new jscape.domain.wizard.AftpServiceView(container);},start:function(listener){this.listener=listener;this.view.setPort(this.DEFAULT_PORT);this.view.setProtectionRequired(true);},resume:function(){this.view.show(this.listener);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},_createDescriptor:function(){return jscape.TransportService.aftp(this.view.getHost(),this.view.getPort(),this.view.getKeyAlias(),this.view.isProtectionRequired());}});jscape.domain.wizard.AftpServiceView=jscape.domain.wizard.BaseTransportServiceView.extend({initialize:function(container){this._super($("fieldset[name=aftpservicefields]",container));var initializing=true;this.host=$("select[name=host]",this.fieldset).combobox({required:true,validType:"length[1,500]",missingMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,invalidMessage:window.R.string.DOMAIN_ERROR_BAD_HOST,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerAddresses,this),width:200,panelWidth:"auto",panelHeight:"auto"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,width:80});this.key=$("select[name=privatekey]",this.fieldset).combobox({required:true,editable:false,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$ServerKeys,this),width:170,panelHeight:"auto"});this.protectionRequired=$("input[name=requiresecure]:checkbox",this.fieldset);initializing=false;},getHost:function(){return this.host.combobox("getValue");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value)).numberspinner("validate");},getKeyAlias:function(){return!this.key.combobox("options").disabled?this.key.combobox("getValue"):null;},isProtectionRequired:function(){return this.protectionRequired.is(":checked");},setProtectionRequired:function(value){this.protectionRequired.prop("checked",!!value);},show:function(listener){this._super(listener);this.host.combobox("reload");this.key.combobox("reload");}});jscape.domain.wizard.HttpServiceController=Class.extend({view:null,initialize:function(container){this.view=new jscape.domain.wizard.HttpServiceView(container);},start:function(){this.view.setSecure(true);},resume:function(){this.view.show(this);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},_createDescriptor:function(){return jscape.TransportService.http(this.view.isPlain(),this.view.isSecure());}});jscape.domain.wizard.BaseWebServiceView=jscape.domain.wizard.BaseDomainServiceView.extend({initialize:function(fieldset){this._super(fieldset);this.plain=$("input[name=plain]:checkbox",fieldset);this.secure=$("input[name=secure]:checkbox",fieldset);},isPlain:function(){return this.plain.is(":checked");},setPlain:function(value){this.plain.prop("checked",!!value);},isSecure:function(){return this.secure.is(":checked");},setSecure:function(value){this.secure.prop("checked",!!value);}});jscape.domain.wizard.HttpServiceView=jscape.domain.wizard.BaseWebServiceView.extend({initialize:function(container){this._super($("fieldset[name=httpservicefields]",container));}});jscape.domain.wizard.WebDavServiceController=Class.extend({view:null,initialize:function(container){this.view=new jscape.domain.wizard.WebDavServiceView(container);},start:function(){this.view.setSecure(true);},resume:function(){this.view.show(this);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},_createDescriptor:function(){return jscape.TransportService.webdav(this.view.isPlain(),this.view.isSecure());}});jscape.domain.wizard.WebDavServiceView=jscape.domain.wizard.BaseWebServiceView.extend({initialize:function(container){this._super($("fieldset[name=webdavservicefields]",container));}});jscape.domain.wizard.As2ServiceController=Class.extend({view:null,initialize:function(container){this.view=new jscape.domain.wizard.As2ServiceView(container);},start:function(listener){this.listener=listener;this.view.setSecure(true);},resume:function(){this.view.show(this.listener);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},_createDescriptor:function(){return jscape.TransportService.as2(this.view.isPlain(),this.view.isSecure());}});jscape.domain.wizard.As2ServiceView=jscape.domain.wizard.BaseWebServiceView.extend({initialize:function(container){this._super($("fieldset[name=as2servicefields]",container));}});jscape.domain.wizard.LogServiceController=jscape.view.ListView.extend({initialize:function(view){this._super();this.view=view;this.addItem(jscape.LogService.Type.FILE,jscape.domain.wizard.FileLogServiceController);this.addItem(jscape.LogService.Type.DB,jscape.domain.wizard.DbLogServiceController);this.addItem(jscape.LogService.Type.DOMAIN,jscape.domain.wizard.DomainLogServiceController);},start:function(){this.view.setType(jscape.LogService.Type.FILE);},resume:function(){this.view.show(this);},pause:function(complete){!complete&&this.view.hide();},valid:function(){var item=this.getItem(this.getCurrentItem());return $.type(item)==="object"?item.valid():true;},applyChanges:function(){var item=this.getItem(this.getCurrentItem());return $.type(item)==="object"?item.applyChanges():null;},onChangeType:function(type){this.setCurrentItem((type||"").toUpperCase());},_createItem:function(item){var controller=new item(this.view.container());controller.start();return controller;}});jscape.domain.wizard.LogServiceView=Class.extend({initialize:function(dialog){this.fieldset=$("#"+dialog.getId()).find("fieldset[name=logservicefields]").hide();this.type=$("select[name=type]",this.fieldset);this.type.combobox({required:true,editable:false,width:"25%",panelHeight:"auto",onChange:$.proxy(this._onChange$Type,this),onLoadSuccess:$.proxy(this._onLoad$Types,this),formatter:$.proxy(this._formatTypeRow,this)});},getType:function(){return this.type.combobox("getValue");},setType:function(value){var opts=this.type.combobox("options");var row=opts.finder.getRow(this.type[0],value);if(row&&row.disabled){var copy=[].concat(this.type.combobox("getData")).sort(function(a,b){return a.disabled===b.disabled?0:(!a.disabled?-1:1);});if(copy.length&&!copy[0].disabled){value=copy[0][opts.valueField];}}
var select=this.type.combobox("getValue");this.type.combobox("setValue",value);if(select===value){this._onChange$Type();}},container:function(){return this.fieldset;},show:function(listener){this.listener=listener||jscape.domain.wizard.LogServiceView.LISTENER;this.fieldset.show();this._onChange$Type();},hide:function(){this.fieldset.hide();},_formatTypeRow:function(row){var text=row[this.type.combobox("options").textField];return!!row.disabled&&row.title?'<span aria-label="{tip}">{text}</span>'.supplant({tip:(row.title||"").escapeXml(),text:text}):text;},_createTooltips:function(combobox){combobox.combobox("panel").find(".combobox-item").each(function(){var tip=$(this).find("span[aria-label]").attr("aria-label")||"";if(tip){$(this).on("mouseenter",function(){$(this).tooltip({content:tip,position:"right",deltaX:$(this).parent().width()-$(this).width(),showEvent:"none",showDelay:0,hideEvent:"none",hideDelay:0,zIndex:"",onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");}).on("mouseleave",function(){$(this).tooltip("hide");});}});},_onLoad$Types:function(){this._createTooltips(this.type);},_onChange$Type:function(){this.listener&&this.listener.onChangeType(this.getType());}});jscape.domain.wizard.LogServiceView.LISTENER={onChangeType:$.noop};jscape.domain.wizard.FileLogServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.LogService.file("%installdir%/logs/%domain%",jscape.LogService.FILE_STRATEGY.DAILY,10*1024*1024),VARIABLES:["installdir","domain"],initialize:function(container){this.view=new jscape.domain.wizard.FileLogServiceView(container);this.variableController=new jscape.VariableController();},start:function(){this._setupView(this.DEFAULT_DESCRIPTOR).show(this);},pause:function(){this.view.hide();},resume:function(){this.view.show(this);},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},onAddVariable:function(input){this.variableController.start(input,this.VARIABLES);},onSelectPath:function(){return new SelectPathController($.proxy(jscape.API.listLogDir,jscape.API),$.proxy(jscape.API.createLogDir,jscape.API)).selectPath().then(function(entry){return entry.path;});},_createDescriptor:function(){return jscape.LogService.file(this.view.getDirectory(),this.view.getStrategy(),this.view.getFileSize());},_setupView:function(descriptor){if(jscape.LogService.Type.FILE==jscape.LogService.typeOf(descriptor,null)){this.view.setDirectory(descriptor.directory);this.view.setStrategy(descriptor.strategyName);this.view.setFileSize(descriptor.fileSize);}
return this.view;}});jscape.domain.wizard.FileLogServiceView=jscape.ui.FormView.extend({SIZE_FACTOR:1024*1024,DEFAULT_SIZE:10,initialize:function(container){this.fieldset=$("fieldset[name=filelogservicefields]",container).hide();this.directory=$("input[name=directory]",this.fieldset).textbox({required:true,validType:"length[1,500]",missingMessage:window.R.string.LOGGING_ERROR_BAD_DIR,invalidMessage:window.R.string.LOGGING_ERROR_BAD_DIR,tipPosition:"left",width:"50%"});this.directory.textbox("textbox").focus($.proxy(function(){this.addVariableButton.linkbutton("enable");},this));this.strategy=$("input[name=strategy]:radio",this.fieldset).change($.proxy(this._adjustFieldState,this));this.sizeStrategy=this.strategy.filter("[value=FileSize]");this.fileSize=$("input[name=filesize]",this.fieldset).numberspinner({required:true,min:1,value:this.DEFAULT_SIZE,width:80});this.browseButton=$("a[role=button][name=browsedir]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseButton,this)});this.addVariableButton=$("a[role=button][name=addvar]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$AddVariable,this)});this._bindEvents(this.fieldset);},getDirectory:function(){return this.directory.textbox("getValue");},setDirectory:function(value){this.directory.textbox("setValue",value);},getStrategy:function(){return this.strategy.filter(":checked").val();},setStrategy:function(value){this.strategy.filter("[value="+value+"]").prop("checked",true).change();},getFileSize:function(){return parseInt(this.fileSize.numberspinner("getValue"))*this.SIZE_FACTOR;},setFileSize:function(value){this.fileSize.numberspinner("setValue",parseInt(value)/this.SIZE_FACTOR);},show:function(listener){this.listener=listener||jscape.domain.wizard.FileLogServiceView.LISTENER;this.fieldset.show();this._adjustFieldState();},hide:function(){this.fieldset.hide();},valid:function(){return this.fieldset.form("validate");},_onClick$AddVariable:function(){this.addVariableButton.linkbutton("disable");this.listener.onAddVariable(this.directory.textbox("textbox"));},_onClick$BrowseButton:function(){this.browseButton.linkbutton("disable");this.listener.onSelectPath(this).done($.proxy(function(path){this.directory.textbox("setValue",path).textbox("textbox").select().focus();},this)).always($.proxy(function(){this.browseButton.linkbutton("enable");},this));},_adjustFieldState:function(){var enable=this.sizeStrategy.is(":checked");this.fileSize.numberspinner(enable?"enable":"disable").numberspinner("validate");}});jscape.domain.wizard.FileLogServiceView.LISTENER={onAddVariable:$.noop,onSelectPath:$.noop};jscape.domain.wizard.DbLogServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.LogService.db("jdbc:","",null,5,5*60*1000,14*24*60*60*1000),initialize:function(container){this.view=new jscape.domain.wizard.DbLogServiceView(container);},start:function(){this._setupView(this.DEFAULT_DESCRIPTOR).show(this);},resume:function(){this.view.show(this);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},onTest:function(){return jscape.API.testLogService(null,this._createDescriptor()).done($.proxy(this._testPassed,this));},onCreateDb:function(){return jscape.API.createLogServiceDb(null,this._createDescriptor()).done($.proxy(this._databaseCreated,this));},_createDescriptor:function(){return jscape.LogService.db(this.view.getUrl(),this.view.getUsername(),this.view.getPassword(),this.view.getPoolSize(),this.view.getPoolTimeout(),this.view.getRecordExpirationPeriod());},_setupView:function(descriptor){if(jscape.LogService.Type.DB==jscape.LogService.typeOf(descriptor,null)){this.view.setUrl(descriptor.url);this.view.setUsername(descriptor.username);this.view.setPassword(descriptor.password);this.view.setPoolSize(descriptor.poolSize);this.view.setPoolTimeout(descriptor.idleConnectionTTL);this.view.setRecordExpirationPeriod(descriptor.recordExpirationPeriodMillis);}
return this.view;},_testPassed:function(){$.messager.alert(window.R.string.LOGGING_TEST_TITLE,window.R.string.LOGGING_TEST_PASSED_MESSAGE,"info");},_databaseCreated:function(data){if(data&&data.message){$.messager.alert(window.R.string.APPLICATION_TITLE,data.message,data.success?"info":"error");}}});jscape.domain.wizard.DbLogServiceView=jscape.ui.FormView.extend({TIMEOUT_FACTOR:60*1000,EXP_PERIOD_FACTOR:24*60*60*1000,initialize:function(container){this.fieldset=$("fieldset[name=dblogservicefields]",container).hide();this.url=$("input[name=dburl]",this.fieldset).textbox({required:true,validType:"length[1,2048]",missingMessage:window.R.string.LOGGING_ERROR_BAD_DB_URL,invalidMessage:window.R.string.LOGGING_ERROR_BAD_DB_URL,onChange:$.proxy(this._onForm$Change,this),width:410});this.username=$("input[name=username]",this.fieldset).textbox({required:true,validType:"length[1,50]",missingMessage:window.R.string.LOGGING_ERROR_BAD_DB_USER,invalidMessage:window.R.string.LOGGING_ERROR_BAD_DB_USER,onChange:$.proxy(this._onForm$Change,this),width:250});this.password=$("input[name=password]",this.fieldset).passwordbox2({onChange:$.proxy(this._onForm$Change,this),width:250});this.poolSize=$("input[name=poolsize]",this.fieldset).numberspinner({min:1,max:100,value:5,onChange:$.proxy(this._onForm$Change,this),width:50});this.poolTimeout=$("input[name=idlettl]",this.fieldset).numberspinner({min:1,max:100,value:5,onChange:$.proxy(this._onForm$Change,this),width:50});this.clearRecords=$("input[name=clearrecords]:checkbox",this.fieldset);this.expirationPeriod=$("input[name=expirationperiod]",this.fieldset).numberspinner({required:true,min:1,max:365,value:1,disabled:true,onChange:$.proxy(this._onForm$Change,this),width:80});this.clearRecords.change($.proxy(function(){var enabled=this.clearRecords.is(":checked");this.expirationPeriod.numberspinner(enabled?"enable":"disable");},this));this.testButton=$("a[role=button][name=testdb]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$TestButton,this)});this.createDbButton=$("a[role=button][name=createdb]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$CreateDbButton,this)});this._bindEvents(this.fieldset);},getUrl:function(){return this.url.textbox("getValue");},setUrl:function(value){this.url.textbox("setValue",value);},getUsername:function(){return this.username.textbox("getValue");},setUsername:function(value){this.username.textbox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue");},setPassword:function(value){this.password.passwordbox2("setValue",value);},getPoolSize:function(){return parseInt(this.poolSize.numberspinner("getValue"));},setPoolSize:function(value){this.poolSize.numberspinner("setValue",parseInt(value));},getPoolTimeout:function(){return parseInt(this.poolTimeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setPoolTimeout:function(value){this.poolTimeout.numberspinner("setValue",parseInt(value)/this.TIMEOUT_FACTOR);},getRecordExpirationPeriod:function(){return this.clearRecords.is(":checked")?parseInt(this.expirationPeriod.numberspinner("getValue"))*this.EXP_PERIOD_FACTOR:null;},setRecordExpirationPeriod:function(value){if(value!=null){this.expirationPeriod.numberspinner("setValue",parseInt(value)/this.EXP_PERIOD_FACTOR);}
this.clearRecords.prop("checked",value!=null).change();},show:function(listener){this.listener=listener||jscape.domain.wizard.DbLogServiceView.LISTENER;this.fieldset.show().form("enableValidation").form("validate");this.url.textbox("textbox").select().focus();},hide:function(){this.fieldset.hide().form("disableValidation");},valid:function(){return this._valid();},_onClick$TestButton:function(){if(this.valid()){this.testButton.linkbutton("disable");this.listener.onTest(this).always($.proxy(function(){this.testButton.linkbutton("enable");},this));}},_onClick$CreateDbButton:function(){if(this.valid()){this.createDbButton.linkbutton("disable");this.listener.onCreateDb(this).always($.proxy(function(){this.createDbButton.linkbutton("enable");},this));}},_onForm$Change:function(){this._adjustButtonsState();},_adjustButtonsState:function(){var enabled=this._valid();this.testButton.linkbutton(enabled?"enable":"disable");this.createDbButton.linkbutton(enabled?"enable":"disable");},_showContextMenu:function(e,_,parent){this._super(e,[this.testButton,this.createDbButton],parent);}});jscape.domain.wizard.DbLogServiceView.LISTENER={onTest:$.noop,onCreateDb:$.noop};jscape.domain.wizard.DomainLogServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.LogService.domain(14*24*60*60*1000),initialize:function(container){this.view=new jscape.domain.wizard.DomainLogServiceView(container);},start:function(){this._setupView(this.DEFAULT_DESCRIPTOR).show(this);},resume:function(){this.view.show(this);},pause:function(){this.view.hide();},valid:function(){return this.view.valid();},applyChanges:function(){return this.view.valid()?this._createDescriptor():null;},_createDescriptor:function(){return jscape.LogService.domain(this.view.getRecordExpirationPeriod());},_setupView:function(descriptor){if(jscape.LogService.Type.DOMAIN==jscape.LogService.typeOf(descriptor,null)){this.view.setRecordExpirationPeriod(descriptor.recordExpirationPeriodMillis);}
return this.view;}});jscape.domain.wizard.DomainLogServiceView=Class.extend({EXP_PERIOD_FACTOR:24*60*60*1000,initialize:function(container){this.fieldset=$("fieldset[name=domainlogservicefields]",container).hide();this.clearRecords=$("input[name=clearrecordsenabled]:checkbox",this.fieldset);this.expirationPeriod=$("input[name=expirationperiod]",this.fieldset).numberspinner({required:true,min:1,max:365,value:10,disabled:true,width:120});this.clearRecords.change($.proxy(function(){var enable=this.clearRecords.is(":checked");this.expirationPeriod.numberspinner(enable?"enable":"disable").numberspinner(enable?"enableValidation":"disableValidation");},this));},getRecordExpirationPeriod:function(){return this.clearRecords.is(":checked")?parseInt(this.expirationPeriod.numberspinner("getValue"))*this.EXP_PERIOD_FACTOR:null;},setRecordExpirationPeriod:function(value){if(value!=null){this.expirationPeriod.numberspinner("setValue",parseInt(value)/this.EXP_PERIOD_FACTOR);}
this.clearRecords.prop("checked",value!=null).change();},show:function(listener){this.listener=listener||jscape.domain.wizard.DomainLogServiceView.LISTENER;this.fieldset.show().form("enableValidation").form("validate");},hide:function(){this.fieldset.hide().form("disableValidation");},valid:function(){return this.fieldset.form("validate");}});jscape.domain.wizard.DomainLogServiceView.LISTENER={};