/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.DirectoryMonitor=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k){this.name=a||"";this.tradingPartner=b||"";this.path=c||"";this.recursive=d||false;this.timeout=parseInt(e)||null;this.latency=parseInt(f)||null;this.owner=g||null;this.quota=h||null;this.events=i||new jscape.DirectoryMonitor.Event();this.lastRunDate=parseInt(j)||null;this.tags=k||[];},toJSON:function(){var data=$.extend(this.events.toJSON(),this);data.events=undefined;return data;}});jscape.DirectoryMonitor.fromJSON=function(data){return new jscape.DirectoryMonitor(data.name,data.tradingPartner,data.path,data.recursive,data.timeout,data.latency,data.owner,jscape.DirectoryQuota.fromJSON(data.quota),jscape.DirectoryMonitor.Event.fromJSON(data),data.lastRunDate,data.tags);};jscape.DirectoryMonitor.Event=Class.extend({MASK_ADD:1<<0,MASK_CHANGE:1<<1,MASK_DELETE:1<<2,MASK_FAILURE:1<<3,initialize:function(adding,changing,deleting,monitorFailure,maxFileAge,idleTimeout,raiseSingleEvent){this.mask=0;this.monitorAdd(!!adding);this.monitorChange(!!changing);this.monitorDelete(!!deleting);this.monitorFailure(!!monitorFailure);this.maxFileAge=parseInt(maxFileAge)||null;this.idleTimeout=parseInt(idleTimeout)||null;this.raiseSingleEvent=raiseSingleEvent!=undefined?!!raiseSingleEvent:true;},monitorAdd:function(value){return this._mask(value,this.MASK_ADD);},monitorChange:function(value){return this._mask(value,this.MASK_CHANGE);},monitorDelete:function(value){return this._mask(value,this.MASK_DELETE);},monitorFailure:function(value){return this._mask(value,this.MASK_FAILURE);},monitorFileAge:function(value){if(!arguments.length){return this.maxFileAge!=null;}
this.maxFileAge=parseInt(value)||null;return undefined;},monitorIdleTimeout:function(value){if(!arguments.length){return this.idleTimeout!=null;}
this.idleTimeout=parseInt(value)||null;return undefined;},_mask:function(value,flag){if(value!==undefined){this.mask|=value?flag:0;return undefined;}
return(this.mask&flag)!=0;},toJSON:function(){return{monitorAdding:this.monitorAdd(),monitorChanging:this.monitorChange(),monitorDeleting:this.monitorDelete(),maxFileAge:this.maxFileAge,idleTimeout:this.idleTimeout,errorEventRisingRequired:this.monitorFailure(),singleEventRisingRequired:this.raiseSingleEvent}}});jscape.DirectoryMonitor.Event.fromJSON=function(data){return new jscape.DirectoryMonitor.Event(data.monitorAdding,data.monitorChanging,data.monitorDeleting,data.errorEventRisingRequired,data.maxFileAge,data.idleTimeout,data.singleEventRisingRequired);};jscape.DirectoryMonitor.Event.Type={FILE:"FILE",FILE_ADDED:"FILE_ADDED",FILE_AGED:"FILE_AGED",FILE_CHANGED:"FILE_CHANGED",FILE_DELETED:"FILE_DELETED",FAILURE:"FAILURE",QUOTA_EXCEEDED:"QUOTA_EXCEEDED"};jscape.DirectoryMonitor.Event.Type.values=function(){return $.map(this,function(val){return typeof val!=="function"?val:null;});};jscape.DirectoryMonitor.Event.Type.fromString=function(str,defaultValue){var name=(""+str).toUpperCase();var ret=$.map(this,function(val,key){return val==str||key==name?val:null;});return ret.length!=0?ret[0]:defaultValue;};jscape.DirectoryMonitorEventSummary=Class.extend({initialize:function(a,b,c,d,e,f,g){this.id=a||"";this.monitorName=b||"";this.tradingPartner=c||"";this.path=d||"";this.date=parseInt(e)||null;this.type=jscape.DirectoryMonitor.Event.Type.fromString(f,null);this.errorMessage=g||null;}});jscape.DirectoryMonitorEventSummary.fromJSON=function(data){return new jscape.DirectoryMonitorEventSummary(data.id,data.monitorName,data.tradingPartner,data.path,data.date,data.type,data.errorMessage);};jscape.DirectoryQuota=Class.extend({initialize:function(a,b,c,d){this.type=jscape.DirectoryQuota.Type.valueOf(a);this.value=parseInt(b)||0;this.currentValue=parseInt(c)||0;this.exceeded=d||false;}});jscape.DirectoryQuota.fromJSON=function(data){return data?new jscape.DirectoryQuota(data.type,data.value,data.currentValue,data.exceeded):null;};jscape.DirectoryQuota.Type={HARD:"HARD",SOFT:"SOFT",values:function(){return $.map(this,function(entry){return typeof entry=="function"?null:entry;});},valueOf:function(value){value=(value||"").toUpperCase();return $.inArray(value,this.values())!=-1?value:jscape.DirectoryQuota.Type.SOFT;}};jscape.DirectoryMonitorServiceConfiguration=Class.extend({initialize:function(a,b){this.maxThreadCount=parseInt(a)||0;this.eventRecordExpirationPeriodMillis=parseInt(b)||null;}});jscape.DirectoryMonitorServiceConfiguration.fromJSON=function(data){return new jscape.DirectoryMonitorServiceConfiguration(data.maxThreadCount,data.eventRecordExpirationPeriodMillis);};jscape.domain.DirectoryMonitorsModule=jscape.domain.DomainModule.extend({initialize:function(dmca,dmta){this.dmca=dmca;this.dmta=dmta;},onCreate:function(domainName,app){this._super.apply(this,arguments);var submodules=[];this.monitorsController=new jscape.domain.DirectoryMonitorsController(this.dmta);submodules.push(app.register("dir-monitor-list",new jscape.domain.DomainSubmodule(this.monitorsController)));this.eventsController=new jscape.domain.DirectoryMonitorEventsController(this.dmca);submodules.push(app.register("dir-monitor-events",new jscape.domain.DomainSubmodule(this.eventsController)));submodules.push(app.register("dir-monitor-settings",new jscape.domain.DomainSubmodule(new jscape.domain.DirectoryMonitorsConfigurationController())));$.each(submodules,function(){this.onCreate(domainName,app);});},onStart:function(){this._super.apply(this,arguments);$(document).off(".dirmonitorquicklinks").on("search_dir_monitor_events.dirmonitorquicklinks",$.proxy(function(e,monitorName){this.onSearchMonitorEvents(monitorName);},this)).on("edit_dir_monitor.dirmonitorquicklinks",$.proxy(function(e,monitorName){this.onEditMonitor(monitorName);},this));},onStop:function(){this._super.apply(this,arguments);$(document).off(".dirmonitorquicklinks");},onSearchMonitorEvents:function(monitorName){if(this.app.navigateTo("dir-monitor-events")){this.eventsController.onSearchMonitorEvents(monitorName);}},onEditMonitor:function(monitorName){var current=this.app.currentModuleId();var changed=this.app.navigateTo("dir-monitor-list");this.monitorsController.onEditMonitor(monitorName).done($.proxy(function(){changed&&this.app.navigateTo(current);},this));}});jscape.domain.DirectoryMonitorsController=jscape.ui.DatagridController.extend({TRADING_PARTNER_PROTOCOLS:["AFTP","Agent","AmazonS3","S3 Compatible","BOX","DROPBOX","IBM CLOUD","Local Directory","Google Cloud Storage","Microsoft Azure File Storage","Microsoft Azure Blob Storage","Microsoft Azure Data Lake","Microsoft Azure Data Lake Gen2","Microsoft OneDrive","FTP","Implicit FTPS","Explicit FTPS","SFTP","SMB","REST","WebDAV","WebDAV SSL"],view:null,initialize:function(allowed){this.addController=new jscape.domain.AddDirectoryMonitorController(this.TRADING_PARTNER_PROTOCOLS);this.editController=new jscape.domain.EditDirectoryMonitorController(this.TRADING_PARTNER_PROTOCOLS);this.deleteController=new jscape.domain.DeleteDirectoryMonitorController();this.usageController=new jscape.domain.DirectoryMonitorUsageController(allowed);this._initValidators();},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.DirectoryMonitorsView();}
this.view.show(this);},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listDirectoryMonitors(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onAddMonitor:function(){return this.addController.start(this.domainName).done($.proxy(this._monitorAdded,this));},onEditMonitor:function(monitor){var index=this._indexOf(monitor);if(index==-1){return $.Deferred().reject().promise();}
if(typeof monitor=="string"){monitor=this.view.getMonitors()[index];}
return this.editController.start(this.domainName,monitor).done($.proxy(this._monitorEdited,this,index));},onDeleteMonitor:function(monitors){return this.deleteController.start(this.domainName,monitors).done($.proxy(this._monitorDeleted,this));},onRunMonitor:function(monitor){return jscape.API.runDirectoryMonitor(this.domainName,monitor.name).done($.proxy(function(){this.view.refresh();},this));},onReportUsageMonitor:function(monitor){return this.usageController.start(this.domainName,monitor);},onMonitorHistory:function(monitor){if(monitor&&monitor.name){$(document).triggerHandler("search_dir_monitor_events",[monitor.name]);}},onAvailableTags:function(){return jscape.API.getDomainTags(this.domainName);},_monitorAdded:function(monitor){this._recordAdded(monitor);},_monitorEdited:function(index,monitor){this._recordEdited(monitor);},_monitorDeleted:function(monitors){this._recordDeleted(monitors);},_initValidators:function(){var v=new jscape.Validator();v.rule("dirmonitor_unique",$.proxy(this._monitorNotExists,this),window.R.string.DIR_MONITOR_ERROR_ALREADY_EXIST);v.rule("dirmonitor_filename",$.proxy(this._filenameValid,this),window.R.string.DIR_MONITOR_ERROR_BAD_FILENAME);},_monitorNotExists:function(name){return this._indexOf(name)==-1;},_indexOf:function(monitor){var items=this.view.getMonitors();if(typeof monitor=="string"){items=$.map(items,function(item){return item.name;});}
return $.inArray(monitor,items);},_filenameValid:function(value){return!/[\*\?\<\>\|"]/g.test(value);}});jscape.domain.DirectoryMonitorsView=jscape.ui.DatagridView.extend({TIMEOUT_FACTOR:1000,selection:null,initialize:function(){var initializing=true;this.sizeFormat=new jscape.SizeFormat();this.fieldset=$("#dir-monitors-list-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=dirmonitors]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"10%"},{field:"path",title:$("thead th:nth-child(2)",this.data).text(),width:"18%"},{field:"timeout",title:$("thead th:nth-child(3)",this.data).text(),width:"8%",align:"right",formatter:$.proxy(this._formatTimeout,this),searchable:false},{field:"quota",title:$("thead th:nth-child(4)",this.data).text(),width:"8%",align:"right",formatter:$.proxy(this._formatQuota,this),styler:$.proxy(this._styleQuota,this),searchable:false},{field:"owner",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,width:"9%"},{field:"events",title:$("thead th:nth-child(6)",this.data).text(),width:"12%",formatter:$.proxy(this._formatEvents,this),searchable:false},{field:"lastRunDate",title:$("thead th:nth-child(7)",this.data).text(),width:"10%",align:"right",formatter:$.proxy(this._formatDate,this),finder:"datetimebox"},{field:"recursive",title:$("thead th:nth-child(8)",this.data).text(),width:"5%",finder:{type:"combobox",options:{data:$.map([true,false],$.proxy(function(value){return{text:value,value:value};},this)),panelHeight:"auto"}}},{field:"tags",title:$("thead th:nth-child(9)",this.data).text(),width:"10%",formatter:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();},finder:{type:"combobox",options:{loader:$.proxy(this._onLoad$Tags,this),panelHeight:"auto",panelMaxHeight:"50%"}}},{field:"tradingPartner",title:$("thead th:nth-child(10)",this.data).text(),sortable:true,width:"10%"}]],onSelect:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onDblClickRow:$.proxy(this._onDblClick$Row,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustRowSelection,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.runButton=$("a[role=button][name=run]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RunButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.reportUsageButton=$("a[role=button][name=reportusage]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ReportUsageButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.DirectoryMonitorsView.LISTENER;this._adjustRowSelection();},getMonitors:function(){return this.getRecords();},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).done(success).fail(error);},_onDblClick$Row:function(index,row){if($.inArray(row,this.selection)==-1||this.selection.length>1){this.data.datagrid("unselectAll").datagrid("selectRow",index);}
this.editButton.click();},_onClick$AddButton:function(){this.addButton.linkbutton("disable");this.listener.onAddMonitor().always($.proxy(function(){this.addButton.linkbutton("enable");},this));},_onClick$EditButton:function(){this.editButton.linkbutton("disable");this.listener.onEditMonitor(this.selection[0]).always($.proxy(this._adjustButtonsState,this));},_onClick$RunButton:function(){this.runButton.linkbutton("disable");this.listener.onRunMonitor(this.selection[0]);},_onClick$DeleteButton:function(){this.deleteButton.linkbutton("disable");this.listener.onDeleteMonitor(this.selection).always($.proxy(this._adjustButtonsState,this));},_onClick$HistoryButton:function(){this.listener.onMonitorHistory(this.selection[0]);},_onClick$ReportUsageButton:function(){this.reportUsageButton.linkbutton("disable");this.listener.onReportUsageMonitor(this.selection[0]).always($.proxy(function(){this.reportUsageButton.linkbutton("enable");},this));},_onLoad$Tags:function(params,success,error){this.listener.onAvailableTags(params).done(success).fail(error);},_formatTimeout:function(timeout){return timeout!=null?window.R.string.DIR_MONITOR_TEMPLATE_INTERVAL.supplant({0:timeout/this.TIMEOUT_FACTOR}):window.R.string.DIR_MONITOR_TEMPLATE_INTERVAL_NONE;},_formatDate:function(value){return $.isNumeric(value)&&value!=0?new Date(value).toLocaleString():"";},_formatQuota:function(quota){return quota?window.R.string.DIR_MONITOR_TEMPLATE_QUOTA.supplant({0:this.sizeFormat.format(quota.currentValue),1:this.sizeFormat.format(quota.value)}):"";},_styleQuota:function(quota){return quota&&!quota.exceeded?"color:green":"color:red";},_formatEvents:function(events){var t=[];events.monitorAdd()&&t.push(window.R.string.DIR_MONITOR_EVENTS_ADDING);events.monitorChange()&&t.push(window.R.string.DIR_MONITOR_EVENTS_CHANGING);events.monitorDelete()&&t.push(window.R.string.DIR_MONITOR_EVENTS_DELETING);events.monitorFailure()&&t.push(window.R.string.DIR_MONITOR_EVENTS_FAILING);events.monitorFileAge()&&t.push(window.R.string.DIR_MONITOR_EVENTS_FILE_AGING);events.monitorIdleTimeout()&&t.push(window.R.string.DIR_MONITOR_EVENTS_IDLE_TIMEOUT);return t.join(", ").escapeXml();},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.runButton,"-",{text:window.R.string.DIR_MONITOR_MENU_EVENTS_HISTORY,handler:$.proxy(this._onClick$HistoryButton,this),disabled:!this.selection||this.selection.length!=1},"-",this.reportUsageButton]);},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");this._adjustButtonsState();},_adjustButtonsState:function(){var singleSelection=this.selection.length==1;this.editButton.linkbutton(singleSelection?"enable":"disable");this.runButton.linkbutton(singleSelection?"enable":"disable");this.reportUsageButton.linkbutton(singleSelection?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.domain.DirectoryMonitorsView.LISTENER={onLoadData:$.noop,onAddMonitor:$.noop,onEditMonitor:$.noop,onDeleteMonitor:$.noop,onReportUsageMonitor:$.noop,onRunMonitor:$.noop,onMonitorHistory:$.noop,onAvailableTags:$.noop};jscape.domain.BaseDirectoryMonitorController=Class.extend({onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},onSelectPath:function(){return new SelectPathController($.proxy(jscape.API.listMonitorsDir,jscape.API),$.proxy(jscape.API.createMonitorsDir,jscape.API)).selectDirectory().then(function(entry){return entry.path;});},_createMonitor:function(dialog,name){return new jscape.DirectoryMonitor(name,dialog.getTradingPartner(),dialog.getPath(),dialog.getRecursive(),dialog.getTimeout(),dialog.getLatency(),dialog.getOwner(),dialog.getQuotaType()!=null&&dialog.getQuota()!=null?new jscape.DirectoryQuota(dialog.getQuotaType(),dialog.getQuota()):null,new jscape.DirectoryMonitor.Event(dialog.getMonitorAdding(),dialog.getMonitorChanging(),dialog.getMonitorDeleting(),dialog.getMonitorFailure(),dialog.getMaxFileAge(),dialog.getIdleTimeout(),dialog.getRaiseSingleEvent()),null,dialog.getTags());}});jscape.domain.AddDirectoryMonitorController=jscape.domain.BaseDirectoryMonitorController.extend({DEFAULT_TIMEOUT:600*1000,DEFAULT_LATENCY:5*1000,deferred:null,initialize:function(protocols){this.protocols=protocols||[];},start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},hasChanged:function(){return true;},onSubmit:function(dialog){var monitor=this._createMonitor(dialog,dialog.getName());return jscape.API.addDirectoryMonitor(this.domainName,monitor).done($.proxy(function(monitor){this.deferred.resolve(monitor);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.AddDirectoryMonitorDialog();dialog.setRecursive(true);dialog.setTimeout(this.DEFAULT_TIMEOUT);dialog.setLatency(this.DEFAULT_LATENCY);dialog.setMonitorAdding(true);dialog.setMonitorChanging(true);dialog.setMonitorDeleting(true);dialog.setMonitorFailure(true);dialog.setRaiseSingleEvent(true);jscape.API.getTradingPartnerNames(this.domainName,this.protocols).done(function(names){dialog.setTradingPartners(names.sort());});jscape.API.getAccountNames(this.domainName).done(function(owners){dialog.setOwners(owners.sort());});return dialog;}});jscape.domain.EditDirectoryMonitorController=jscape.domain.BaseDirectoryMonitorController.extend({protocols:null,deferred:null,initialize:function(protocols){this.protocols=protocols||[];},start:function(domainName,monitor){this.domainName=domainName;this.monitor=$.extend({},monitor,{lastRunDate:null});this.deferred=$.Deferred();jscape.API.getDirectoryMonitor(this.domainName,this.monitor.name).done($.proxy(function(monitor){this._setupDialog(monitor).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},hasChanged:function(dialog){return!Object._equals(this.monitor,this._createMonitor(dialog,this.monitor.name));},onSubmit:function(dialog){var monitor=this._createMonitor(dialog,this.monitor.name);return jscape.API.setDirectoryMonitor(this.domainName,monitor.name,monitor).done($.proxy(function(){this.deferred.resolve(monitor);},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();},_setupDialog:function(monitor){var dialog=new jscape.domain.EditDirectoryMonitorDialog();if(monitor){dialog.setName(monitor.name);dialog.setPath(monitor.path);dialog.setRecursive(monitor.recursive);dialog.setTimeout(monitor.timeout);dialog.setLatency(monitor.latency);if(monitor.quota){dialog.setQuota(monitor.quota.value);dialog.setQuotaType(monitor.quota.type);}
dialog.setMonitorAdding(monitor.events.monitorAdd());dialog.setMonitorChanging(monitor.events.monitorChange());dialog.setMonitorDeleting(monitor.events.monitorDelete());dialog.setMonitorFailure(monitor.events.monitorFailure());dialog.setMaxFileAge(monitor.events.maxFileAge);dialog.setIdleTimeout(monitor.events.idleTimeout);dialog.setRaiseSingleEvent(monitor.events.raiseSingleEvent);dialog.setTags(monitor.tags);}
jscape.API.getTradingPartnerNames(this.domainName,this.protocols).done(function(names){dialog.setTradingPartners(names.sort());monitor&&dialog.setTradingPartner(monitor.tradingPartner);});jscape.API.getAccountNames(this.domainName).done(function(owners){dialog.setOwners(owners.sort());monitor&&dialog.setOwner(monitor.owner);});return dialog;}});jscape.domain.DirectoryMonitorDialog=jscape.ui.DefaultDialog.extend({TIMEOUT_FACTOR:1000,LATENCY_FACTOR:1000,QUOTA_FACTOR:1024*1024,initialize:function(dialog){var initializing=true;this._super(dialog,{width:"70%",height:"80%",minWidth:650,minHeight:750});this.usePartner=$("input[name=usepartner]:checkbox",this.fieldset).change($.proxy(function(){var enabled=this.usePartner.is(":checked");this.partner.combobox(enabled?"enable":"disable");this.path.textbox("button").linkbutton(!enabled?"enable":"disable");},this));this.partner=$("select[name=partner]",this.fieldset).combobox({required:true,disabled:true,editable:true,limitToList:true,validType:"non_empty",missingMessage:window.R.string.DIR_MONITOR_ERROR_BAD_PARTNER,invalidMessage:window.R.string.DIR_MONITOR_ERROR_BAD_PARTNER,width:"50%",panelHeight:"auto",panelMaxHeight:150});this.path=$("input[name=path]",this.fieldset).textbox({required:true,validType:["non_empty","dirmonitor_filename"],invalidMessage:window.R.string.DIR_MONITOR_ERROR_BAD_PATH,missingMessage:window.R.string.DIR_MONITOR_ERROR_BAD_PATH,buttonText:"...",buttonAlign:"right",buttonIcon:null,onClickButton:$.proxy(this._onClick$BrowseButton,this),width:"60%"});this.recursive=$("input[name=recursive]:checkbox",this.fieldset);this.timeoutEnabled=$("input[name=timeoutenabled]:checkbox",this.fieldset).change($.proxy(function(){this.timeout.numberspinner(this.timeoutEnabled.is(":checked")?"enable":"disable");},this));this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({min:1,max:3600,value:600,increment:60,required:true,disabled:true,width:"15%"});this.latencyEnabled=$("input[name=latencyenabled]:checkbox",this.fieldset).change($.proxy(function(){this.latency.numberspinner(this.latencyEnabled.is(":checked")?"enable":"disable");},this));this.latency=$("input[name=latency]",this.fieldset).numberspinner({min:1,max:3600,value:5,increment:5,required:true,disabled:true,width:"15%"});this.ownedBy=$("input[name=ownedby]:checkbox",this.fieldset);this.ownedBy.change($.proxy(function(){this.owner.combobox(this.ownedBy.is(":checked:not(:disabled)")?"enable":"disable");},this));this.owner=$("select[name=owner]",this.fieldset).combobox({editable:true,limitToList:true,disabled:true,width:"30%",panelHeight:"auto",panelMaxHeight:150});this.tags=$("select[name=tags]",this.fieldset).tagbox({limitToList:jscape.acl&&!jscape.acl.tic,hasDownArrow:true,loader:$.proxy(this._onLoad$Tags,this),onBeforeLoad:function(){return!initializing;},onAddTag:$.proxy(this._onClick$AddTagButton,this),tagEditor:$("#d-add-tag-inline"),width:"60%",panelHeight:"auto",panelMinHeight:50});this.quotaEnabled=$("input[name=quotaenabled]:checkbox",this.fieldset).change($.proxy(function(){var enable=this.quotaEnabled.is(":checked");this.quota.numberspinner(enable?"enable":"disable");this.quotaType.combobox(enable?"enable":"disable");this.quotaUnit.combobox(enable?"enable":"disable");},this));this.quota=$("input[name=quota]",this.fieldset).numberspinner({min:1,max:9999,value:100,increment:10,required:true,disabled:true,width:90});this.quotaType=$("select[name=quotatype]",this.fieldset).combobox({required:true,editable:false,disabled:true,width:60,panelHeight:"auto",panelMaxHeight:150});this.quotaUnit=$("select[name=quotaunit]",this.fieldset).combobox({required:true,editable:false,disabled:true,width:60,panelHeight:"auto",panelMaxHeight:150});this.eventAdd=$("input[name=monitoradd]:checkbox",this.fieldset);this.eventChange=$("input[name=monitorchange]:checkbox",this.fieldset);this.eventDelete=$("input[name=monitordelete]:checkbox",this.fieldset);this.eventFailure=$("input[name=monitorfailure]:checkbox",this.fieldset);this.useMaxFileAge=$("input[name=usemaxfileage]:checkbox",this.fieldset).change($.proxy(function(){var enable=this.useMaxFileAge.is(":checked");this.maxFileAge.numberspinner(enable?"enable":"disable");var unitbox=this.maxFileAge.numberspinner("options").unitbox;unitbox&&unitbox.length&&unitbox.combobox(enable?"enable":"disable");},this));this.maxFileAge=$("input[name=maxfileage]",this.fieldset).numberspinner({min:1,max:1000,value:24*60*60*1000,required:true,disabled:true,width:120,unitbox:$("select[name=maxfileageunit]",this.fieldset).combobox({required:true,disabled:true,editable:false,width:100,panelHeight:"auto",panelMaxHeight:150})});this.useIdleTimeout=$("input[name=useidletimeout]:checkbox",this.fieldset).change($.proxy(function(){var enable=this.useIdleTimeout.is(":checked");this.idleTimeout.numberspinner(enable?"enable":"disable");var unitbox=this.idleTimeout.numberspinner("options").unitbox;unitbox&&unitbox.length&&unitbox.combobox(enable?"enable":"disable");},this));this.idleTimeout=$("input[name=idletimeout]",this.fieldset).numberspinner({min:1,max:1000,value:24*60*60*1000,required:true,disabled:true,width:120,unitbox:$("select[name=idletimeoutunit]",this.fieldset).combobox({required:true,disabled:true,editable:false,width:100,panelHeight:"auto",panelMaxHeight:150})});this.raiseEvents=$("select[name=raiseevents]",this.fieldset).combobox({editable:false,limitToList:true,width:70,panelHeight:"auto",panelMaxHeight:150});initializing=false;},show:function(listener){this._super(listener);this.tags.tagbox("reload");this.usePartner.change();},getTradingPartner:function(){return this.usePartner.is(":checked")?this.partner.combobox("getValue"):null;},setTradingPartner:function(value){if(value){this.partner.combobox("select",value);}
this.usePartner.prop("checked",!!value).change();},setTradingPartners:function(values){this.partner.combobox("loadData",values);},getPath:function(){return this.path.textbox("getValue");},setPath:function(value){this.path.textbox("setValue",value);},getRecursive:function(){return this.recursive.is(":checked");},setRecursive:function(value){this.recursive.prop("checked",!!value);},getTimeout:function(){return this.timeoutEnabled.is(":checked")?parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR:null;},setTimeout:function(value){this.timeoutEnabled.prop("checked",value!=null).change();if(value!=null){this.timeout.numberspinner("setValue",value/this.TIMEOUT_FACTOR);}},getLatency:function(){return this.latencyEnabled.is(":checked")?parseInt(this.latency.numberspinner("getValue"))*this.LATENCY_FACTOR:null;},setLatency:function(value){this.latencyEnabled.prop("checked",value!=null).change();if(value!=null){this.latency.numberspinner("setValue",value/this.LATENCY_FACTOR);}},getOwner:function(){return this.ownedBy.is(":checked:not(:disabled)")?this.owner.combobox("getValue"):null;},setOwner:function(value){var empty=this.owner.combobox("getData").length==0;if(value!=null&&!empty){this.owner.combobox("select",value);}
this.ownedBy.prop("checked",value!=null&&!empty).change();},setOwners:function(values){this.owner.combobox("loadData",values);this.ownedBy.prop("disabled",values.length==0);},getTags:function(){return this.tags.tagbox("getValues");},setTags:function(values){this.tags.tagbox("setValues",values);},getQuota:function(){if(this.quotaEnabled.is(":checked")){var factor=parseInt(this.quotaUnit.combobox("getValue"));return parseInt(this.quota.numberspinner("getValue"))*factor;}},setQuota:function(value){value=parseInt(value);if(isNaN(value)){this.quotaEnabled.prop("checked",false).change();}else{this.quotaEnabled.prop("checked",true).change();var factor=$.fn._unitValueFor(this.quotaUnit,value);this.quota.numberspinner("setValue",value/factor);this.quotaUnit.combobox("select",factor+"");}},getQuotaType:function(){return this.quotaType.combobox("getValue");},setQuotaType:function(value){this.quotaType.combobox("select",value);},getMonitorAdding:function(){return this.eventAdd.is(":checked");},setMonitorAdding:function(value){this.eventAdd.prop("checked",!!value);},getMonitorChanging:function(){return this.eventChange.is(":checked");},setMonitorChanging:function(value){this.eventChange.prop("checked",!!value);},getMonitorDeleting:function(){return this.eventDelete.is(":checked");},setMonitorDeleting:function(value){this.eventDelete.prop("checked",!!value);},getMonitorFailure:function(){return this.eventFailure.is(":checked");},setMonitorFailure:function(value){this.eventFailure.prop("checked",!!value);},getMaxFileAge:function(){return this.useMaxFileAge.is(":checked")?parseInt(this.maxFileAge.numberspinner("getValue")):null;},setMaxFileAge:function(value){this.useMaxFileAge.prop("checked",value!=null).change();if(value!=null){this.maxFileAge.numberspinner("setValue",parseInt(value));}},getIdleTimeout:function(){return this.useIdleTimeout.is(":checked")?parseInt(this.idleTimeout.numberspinner("getValue")):null;},setIdleTimeout:function(value){this.useIdleTimeout.prop("checked",value!=null).change();if(value!=null){this.idleTimeout.numberspinner("setValue",parseInt(value));}},getRaiseSingleEvent:function(){return"FIRST"===(""+this.raiseEvents.combobox("getValue")).toUpperCase();},setRaiseSingleEvent:function(value){if(!!value){this.raiseEvents.combobox("select","FIRST");}else{this.raiseEvents.combobox("select","ALL");}},_onClick$AddTagButton:function(tag){this.listener.onAddTag(tag).done($.proxy(function(){this.tags.tagbox("reload");},this));},_onLoad$Tags:function(params,success,error){this.listener.onLoadTags(params).done(success).fail(error);},_onClick$BrowseButton:function(){this.path.textbox("button").linkbutton("disable");this.listener.onSelectPath(this).done($.proxy(function(path){this.path.textbox("setValue",path).textbox("textbox").select().focus();},this)).always($.proxy(function(){this.path.textbox("button").linkbutton("enable");},this));}});jscape.domain.DirectoryMonitorDialog.LISTENER={onSubmit:$.noop,onCancel:$.noop,onSelectPath:$.noop,onAddTag:$.noop};jscape.domain.DirectoryMonitorUsageController=Class.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,monitor){this.domainName=domainName;this.monitorName=monitor.name;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog(this.monitorName).show(this);}
return this.deferred.promise();},onLoadData:function(){return jscape.API.getDirectoryMonitorTriggers(this.domainName,this.monitorName);},_setupDialog:function(monitorName){var dialog=new jscape.domain.DirectoryMonitorUsageDialog();dialog.setName(monitorName);return dialog;},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;}});jscape.domain.DirectoryMonitorUsageDialog=jscape.ui.DefaultDialog.extend({timer:null,initialize:function(){this._super($("#d-monitor-triggers"),{modal:true,buttons:null,width:"50%",minWidth:600,maxWidth:750,height:"60%",minHeight:400,maxHeight:"80%"});this.title=this.dialog.dialog("header").text()||"";var ws=this.dialog.data("window");if(ws&&ws.mask){$(ws.mask).one("click",$.proxy(this._onCancel,this));}
var initializing=true;this.search=$("input[name=search]",this.dialog).textbox({required:false,icons:[{iconCls:"icon-clear",handler:$.proxy(this._onClick$ClearButton,this)}],inputEvents:$.extend({},$.fn.textbox.defaults.inputEvents,{keyup:$.proxy(this._onKeyUp$SearchInput,this),keydown:$.proxy(this._onKeyDown$SearchInput,this)}),width:"100%"});this.data=$("div[role=listbox][aria-label=triggers]",this.dialog);this.data.datalist({fit:true,remoteSort:false,textFormatter:function(val,row){return String(row||"").escapeXml();},onBeforeLoad:function(){return!initializing;},loadFilter:$.proxy(this._onFilter$Data,this),loader:$.proxy(this._onLoad$Data,this)});initializing=false;},show:function(listener){this._super(listener);this.data.datalist("reload");this.search.textbox("textbox").triggerHandler("keyup",{target:this.search});},_onLoad$Data:function(params,success,error){return this.listener.onLoadData(params).done($.proxy(function(data){if(!data||!data.length){this.search.textbox("disable");}},this)).done(success).fail(error);},_onFilter$Data:function(data){var params=this.data.datalist("options").queryParams||{};var text=(params.query||"").toLocaleLowerCase();return!!text?$.grep(data,function(t){return t.toLocaleLowerCase().indexOf(text)>=0?t:null;}):data;},_onSearch$Data:function(query){this.data.datalist("options").queryParams={query:query};this.data.datalist("loading").datalist("loadData",this.data.datalist("getData")).datalist("loaded");},_onKeyDown$SearchInput:function(e){if(e.keyCode==13){$.fn.textbox.defaults.inputEvents.keydown.call(e.target,e);return false;}if(e.keyCode==27){e.preventDefault();$(e.data.target).textbox("getIcon",0).click();return false;}},_onKeyUp$SearchInput:function(e){var t=$(e.data.target);var icon=t.textbox("getIcon",0);var val=t.textbox("getText");icon.css("visibility",!!val?"visible":"hidden");clearTimeout(this.timer);this.timer=setTimeout($.proxy(this._onSearch$Data,this,val),200);},setName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:String(value).escapeXml()}));},_onClick$ClearButton:function(e){var t=$(e.data.target);t.textbox("clear").textbox("textbox").focus();t.textbox("getIcon",0).css("visibility","hidden");clearTimeout(this.timer);this._onSearch$Data(null);}});jscape.domain.DirectoryMonitorUsageDialog.Listener={onLoadData:$.noop};jscape.domain.AddDirectoryMonitorDialog=jscape.domain.DirectoryMonitorDialog.extend({initialize:function(){this._super($("#d-dirmonitors-add"));this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["non_empty","dirmonitor_unique"],invalidMessage:window.R.string.DIR_MONITOR_ERROR_BAD_NAME,missingMessage:window.R.string.DIR_MONITOR_ERROR_BAD_NAME,width:"50%"});},getName:function(){return this.name.textbox("getValue");}});jscape.domain.EditDirectoryMonitorDialog=jscape.domain.DirectoryMonitorDialog.extend({initialize:function(){this._super($("#d-dirmonitors-edit"));this.title=this.dialog.dialog("header").text()||"";},setName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));}});jscape.domain.DeleteDirectoryMonitorController=Class.extend({deferred:null,start:function(domainName,monitors){this.domainName=domainName;this.deferred=$.Deferred();this._confirmDelete(monitors).then($.proxy(function(){return this._deleteConfirmed(monitors);},this)).then($.proxy(function(){this.deferred.resolve(monitors);this.deferred=null;},this)).catch($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(monitors){var text=$.map(monitors,function(monitor){return monitor.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.DIR_MONITOR_CONFIRM_DELETE_TITLE,window.R.string.DIR_MONITOR_CONFIRM_DELETE_MESSAGE.supplant({0:text}));},_deleteConfirmed:function(monitors){return $.when.apply(jQuery,$.map(monitors,$.proxy(function(monitor){return jscape.API.deleteDirectoryMonitor(this.domainName,monitor.name);},this)));}});jscape.domain.DirectoryMonitorEventsController=jscape.ui.DatagridController.extend({view:null,initialize:function(a){this.purgeController=new jscape.domain.PurgeDirectoryMonitorEventsController(a);this.raiseController=new jscape.domain.RaiseDirectoryMonitorEventController(a);this.reRaiseController=new jscape.domain.ReRaiseDirectoryMonitorEventController(a);},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.DirectoryMonitorEventsView();}
this.view.show(this);},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},onSearchMonitorEvents:function(monitorName){this.view.search({query:monitorName,field:"monitorName",regexp:true,ignoreCase:true});},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listDirectoryMonitorEvents(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onLoadSuggestions:function(params){params=jscape.Page.requestParameters(params);return jscape.API.getDirectoryMonitorEventSuggestions(this.domainName,params.query).then(function(data){return $.map(data||[],function(d){return d.text||[];});});},onEditMonitor:function(event){if(event&&!!event.monitorName){$(document).triggerHandler("edit_dir_monitor",[event.monitorName]);}},onPurge:function(){return this.purgeController.start(this.domainName).done($.proxy(function(){this.view.firstPage();},this));},onRaise:function(){return this.raiseController.start(this.domainName).done($.proxy(function(){this.view.refresh();},this));},onReRaise:function(event){return this.reRaiseController.start(this.domainName,event.id).done($.proxy(function(){this.view.refresh();},this));}});jscape.domain.DirectoryMonitorEventsView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#dir-monitor-events-list-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=dirmonitorevents]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,singleSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"monitorName",idField:"id",columns:[[{field:"id",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"10%"},{field:"monitorName",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,finder:this._createFinder("combobox",{editable:true,limitToList:false,loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"directoryMonitor"}}),width:"15%"},{field:"tradingPartner",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"10%",finder:this._createFinder("combobox",{editable:true,limitToList:false,loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"tradingPartner"}})},{field:"path",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"20%"},{field:"date",title:$("thead th:nth-child(5)",this.data).text(),width:"15%",align:"right",sortable:true,formatter:$.proxy(this._formatDate,this),finder:"datetimebox"},{field:"type",title:$("thead th:nth-child(6)",this.data).text(),width:"20%",formatter:$.proxy(this._formatEvent,this),finder:{type:"combobox",options:{data:$.map(jscape.DirectoryMonitor.Event.Type.values(),$.proxy(function(val){return{text:this._formatEvent(val),value:val};},this)),width:280,minWidth:200,panelHeight:"auto",panelMaxHeight:"50%"}}},{field:"errorMessage",title:$("thead th:nth-child(7)",this.data).text(),width:"10%"}]],onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustButtonsState,this)});this.purgeButton=$("a[role=button][name=purge]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PurgeButton,this)});this.raiseButton=$("a[role=button][name=raise]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$RaiseButton,this)});this.reraiseButton=$("a[role=button][name=reraise]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ReraiseButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.DirectoryMonitorEventsView.LISTENER;this._adjustButtonsState();},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).done(success).fail(error);},_onLoad$Suggestions:function(params,success,error){this.listener.onLoadSuggestions(params).then(success,error);},_onClick$PurgeButton:function(){this.purgeButton.linkbutton("disable");this.data.datagrid("clearSelections");this.listener.onPurge().always($.proxy(this._adjustButtonsState,this));},_onClick$RaiseButton:function(){this.raiseButton.linkbutton("disable");this.listener.onRaise().always($.proxy(function(){this.raiseButton.linkbutton("enable");},this));},_onClick$ReraiseButton:function(){this.reraiseButton.linkbutton("disable");this.listener.onReRaise(this.selection[0]).always($.proxy(this._adjustButtonsState,this));},_onClick$EditMonitorButton:function(){this.listener.onEditMonitor(this.selection[0]);},_formatDate:function(value){return $.isNumeric(value)&&value!==0?new Date(value).toLocaleString():"";},_formatEvent:function(value){var key="DIR_MONITOR_EVENT_"+(""+value).toUpperCase();return window.R.string.contains(key)?window.R.string.DIR_MONITOR_EVENT_TEMPLATE.supplant({0:window.R.string[key]}):"";},_showContextMenu:function(e){this._super(e,[this.reraiseButton,"-",this.raiseButton,this.purgeButton,"-",{text:window.R.string.DIR_MONITOR_MENU_EDIT_MONITOR,handler:$.proxy(this._onClick$EditMonitorButton,this),disabled:!this.selection||this.selection.length!=1},]);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var totalCount=parseInt(this.data.datagrid("getData").total)||0;this.reraiseButton.linkbutton(this.selection.length==1?"enable":"disable");this.purgeButton.linkbutton(totalCount>0?"enable":"disable");}});jscape.domain.DirectoryMonitorsView.LISTENER={onLoadData:$.noop,onPurge:$.noop,onRaise:$.noop,onReRaise:$.noop,onEditMonitor:$.noop};jscape.domain.RaiseDirectoryMonitorEventController=Class.extend({deferred:null,paths:null,initialize:function(a){this.allowed=!!a;},start:function(domainName){this.domainName=domainName;this.paths={};this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog().show(this);}
return this.deferred.promise();},onLoadMonitorNames:function(){return jscape.API.getDirectoryMonitorNames(this.domainName);},onLoadMonitorPath:function(monitorName){if(this.paths[monitorName]){return $.Deferred().resolve(this.paths[monitorName]).promise();}
return jscape.API.getDirectoryMonitor(this.domainName,monitorName).then($.proxy(function(monitor){this.paths[monitor.name]=monitor.path;return monitor.path;},this));},onSelectPath:function(){return new SelectPathController($.proxy(jscape.API.listMonitorsDir,jscape.API),$.proxy(jscape.API.createMonitorsDir,jscape.API)).selectDirectory().then(function(entry){return entry.path;});},onSubmit:function(dialog){return jscape.API.raiseDirectoryMonitorEvent(this.domainName,dialog.getMonitorName(),dialog.getPath(),dialog.getEventType(),dialog.getFileEventType()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.domain.RaiseDirectoryMonitorEventDialog();}});jscape.domain.RaiseDirectoryMonitorEventDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-dirmonitors-events-raise"),{width:"50%",minWidth:700,maxWidth:850,minHeight:355,doSize:false});var initializing=true;this.name=$("select[name=dirmonitor]",this.dialog).combobox({required:true,editable:false,limitToList:true,onChange:$.proxy(this._onChange$Name,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Names,this),width:"60%",panelHeight:"auto",panelMinHeight:50,panelMaxHeight:"40%"});this.path=$("input[name=path]",this.dialog).textbox({required:true,validType:["non_empty","dirmonitor_filename"],invalidMessage:window.R.string.DIR_MONITOR_ERROR_BAD_PATH,missingMessage:window.R.string.DIR_MONITOR_ERROR_BAD_PATH,buttonText:"...",buttonAlign:"right",buttonIcon:null,onClickButton:$.proxy(this._onClick$BrowsePathButton,this),width:"60%"});this.event=$("select[name=event]",this.dialog).combobox({required:true,editable:false,onChange:$.proxy(this._onChange$Event,this),width:"60%",panelHeight:"auto",panelMinHeight:50,panelMaxHeight:"40%"});this.fileEvent=$("select[name=fileevent]",this.dialog).combobox({required:true,editable:false,disabled:true,width:"50%",panelHeight:"auto",panelMinHeight:50,panelMaxHeight:"40%"});initializing=false;},show:function(listener){this._super(listener);this.dialog.dialog("resize");this.name.combobox("reload");this._onChange$Event(this.getEventType());},getMonitorName:function(){return this.name.combobox("getValue");},getPath:function(){return this.path.textbox("getValue");},setPath:function(val){this.path.textbox("setValue",val).textbox("textbox").select().focus();},getEventType:function(){return this.event.combobox("getValue");},getFileEventType:function(){return!this.fileEvent.combobox("options").disabled?this.fileEvent.combobox("getValue"):null;},_onLoad$Names:function(params,success,error){this.listener.onLoadMonitorNames(params).done(success).fail(error);},_onChange$Name:function(value){this.listener.onLoadMonitorPath(value).done($.proxy(this.setPath,this));},_onChange$Event:function(value){if(this.fileEvent&&this.fileEvent.length){this.fileEvent.combobox(value=="FILE"?"enable":"disable");}},_onClick$BrowsePathButton:function(){this.path.textbox("button").linkbutton("disable");this.listener.onSelectPath().done($.proxy(function(value){this.setPath(value);},this)).always($.proxy(function(){this.path.textbox("button").linkbutton("enable");},this));}});jscape.domain.ReRaiseDirectoryMonitorEventController=Class.extend({deferred:null,initialize:function(a){this.allowed=!!a;},start:function(domainName,eventId){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog(eventId).show(this);}
return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.reRaiseDirectoryMonitorEvent(this.domainName,dialog.getEventId(),dialog.isDataMaintained()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(id){var dialog=new jscape.domain.ReRaiseDirectoryMonitorEventDialog();dialog.setEventId(id);return dialog;}});jscape.domain.ReRaiseDirectoryMonitorEventDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-dirmonitors-events-reraise"),{width:"40%",minWidth:550,maxWidth:700,minHeight:280});this.maintainData=$("input[name=maintaindata]:checkbox",this.fieldset);},show:function(listener){this._super(listener);this._defaultButton().focus();},getEventId:function(){return this.eventId||"";},setEventId:function(id){this.eventId=id||"";var t=this.dialog.find("[role=alert]");t.text(t.text().supplant({0:String(id).escapeXml()}));},isDataMaintained:function(){return this.maintainData.is(":checked");}});jscape.domain.PurgeDirectoryMonitorEventsController=Class.extend({DEFAULT_EXPIRATION_PERIOD:0,deferred:null,initialize:function(a){this.allowed=!!a;},start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog().show(this);}
return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.clearDirectoryMonitorEvents(this.domainName,dialog.getExpirationPeriod()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.PurgeDirectoryMonitorEventsDialog();dialog.setExpirationPeriod(this.DEFAULT_EXPIRATION_PERIOD);return dialog;}});jscape.domain.PurgeDirectoryMonitorEventsDialog=jscape.ui.DefaultDialog.extend({TIME_FACTOR:24*60*60*1000,initialize:function(){this._super($("#d-dirmonitors-events-clear"),{width:"40%",minWidth:450,maxWidth:700,minHeight:260});this.period=$("input[name=period]",this.fieldset).numberspinner({required:true,min:0,max:1000,width:80});},getExpirationPeriod:function(){return parseInt(this.period.numberspinner("getValue"))*this.TIME_FACTOR;},setExpirationPeriod:function(value){return this.period.numberspinner("setValue",parseInt(value)/this.TIME_FACTOR);}});jscape.domain.DirectoryMonitorsConfigurationController=Class.extend({DEFAULT_CONFIG:new jscape.DirectoryMonitorServiceConfiguration(10),view:null,config:null,start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.DirectoryMonitorsConfigurationView();}
this.view.show(this);},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},hasChanged:function(){return this.config&&!Object._equals(this.config,this._createConfiguration());},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onLoadData:function(){return jscape.API.getDirectoryMonitorServiceConfiguration(this.domainName).catch(function(){return null;}).then($.proxy(function(config){this.config=config||this._copyConfiguration(this.DEFAULT_CONFIG);},this)).done($.proxy(function(){this._setupView(this.config);},this));},onApply:function(){return jscape.API.setDirectoryMonitorServiceConfiguration(this.domainName,this._createConfiguration()).done($.proxy(function(config){this.config=this._copyConfiguration(config);this._fireApplySuccess();},this));},onDiscard:function(){this.config=this._copyConfiguration(this.config);this.view.refresh();},_createConfiguration:function(){return new jscape.DirectoryMonitorServiceConfiguration(this.view.getMaxThreads(),this.view.getRecordExpirationPeriod());},_copyConfiguration:function(config){return config!=null?$.extend(new jscape.DirectoryMonitorServiceConfiguration(),config):null;},_setupView:function(config){if(config&&this.view){this.view.setMaxThreads(config.maxThreadCount);this.view.setRecordExpirationPeriod(config.eventRecordExpirationPeriodMillis);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.domain.DirectoryMonitorsConfigurationView=jscape.ui.FormView.extend({EXP_PERIOD_FACTOR:24*60*60*1000,initialize:function(){this.fieldset=$("#dir-monitor-settings-fields").layout({fit:true,doSize:false,border:false});this.maxThreads=$("input[name=maxthreads]",this.fieldset).numberspinner({required:true,editable:false,min:1,max:100,onChange:$.proxy(this._onForm$Change,this),width:60});this.clearRecords=$("input[name=clearrecords]:checkbox",this.fieldset);this.expirationPeriod=$("input[name=expirationperiod]",this.fieldset).numberspinner({required:true,disabled:true,min:1,max:365,value:30,onChange:$.proxy(this._onForm$Change,this),width:80});this.clearRecords.change($.proxy(function(){var enabled=this.clearRecords.is(":checked");this.expirationPeriod.numberspinner(enabled?"enable":"disable");this._onForm$Change();},this));this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._adjustButtonsBarLayout(this.fieldset);},getMaxThreads:function(){return parseInt(this.maxThreads.numberspinner("getValue"));},setMaxThreads:function(value){if(parseInt(value)){this.maxThreads.numberspinner("setValue",value).numberspinner("validate");}},getRecordExpirationPeriod:function(){return this.clearRecords.is(":checked")?parseInt(this.expirationPeriod.numberspinner("getValue"))*this.EXP_PERIOD_FACTOR:null;},setRecordExpirationPeriod:function(value){if(value!=null){this.expirationPeriod.numberspinner("setValue",parseInt(value)/this.EXP_PERIOD_FACTOR);}
this.clearRecords.prop("checked",value!=null).change();},show:function(listener){this.listener=listener||jscape.domain.DirectoryMonitorsConfigurationView.LISTENER;this.fieldset.form("validate");this._onForm$Change();},refresh:function(){this.applyButton.linkbutton("disable");this.discardButton.linkbutton("disable");this.listener.onLoadData().done($.proxy(this._onForm$Change,this)).always($.proxy(function(){this.discardButton.linkbutton("enable");},this));},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_onClick$ApplyButton:function(){if(this.fieldset.form("validate")){this.applyButton.linkbutton("disable");this.listener.onApply(this).always($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);}});jscape.domain.DirectoryMonitorsConfigurationView.LISTENER={onLoadData:$.noop,onApply:$.noop,onDiscard:$.noop};