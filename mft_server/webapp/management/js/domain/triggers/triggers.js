/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.Trigger=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){this.name=a||"";this.description=b||"";this.eventType=c||null;this.expression=d||"";this.onStartActions=e||[];this.onFinishActions=f||[];this.onSuccessActions=g||[];this.onFailureActions=h||[];this.allowErrorEvent=!!i;this.enabled=!!j;this.asynchronous=!!k;this.singleInstanceRequired=!!l;this.singleInstanceMode=m||jscape.Trigger.SingleInstanceMode.QUEUED;this.ignoredDomainState=n||null;this.uiLayoutData=o||{};this.lastRunDate=parseInt(p)||null;this.tags=q||[];},clone:function(){return jscape.Trigger.fromJSON(this.toJSON());},runnable:function(){return/^([a-z]+\.){1,}(currenttimeevent|webhookevent)$/i.test(this.eventType);},toJSON:function(){var obj=$.extend({},this);try{obj.uiLayoutData=JSON.stringify(this.uiLayoutData);}catch(e){delete obj.uiLayoutData;}
return obj;}});jscape.Trigger.SingleInstanceMode={QUEUED:"QUEUED",SKIPPED:"SKIPPED"};jscape.Trigger.fromJSON=function(data){var layoutData=null;try{layoutData=JSON.parse(data.uiLayoutData);}catch(ignored){}
return data?new jscape.Trigger(data.name,data.description,data.eventType,data.expression,$.map(data.onStartActions,jscape.ActionContext.fromJSON),$.map(data.onFinishActions,jscape.ActionContext.fromJSON),$.map(data.onSuccessActions,jscape.ActionContext.fromJSON),$.map(data.onFailureActions,jscape.ActionContext.fromJSON),data.allowErrorEvent,data.enabled,data.asynchronous,data.singleInstanceRequired,data.singleInstanceMode,data.ignoredDomainState,layoutData,data.lastRunDate,data.tags):null;};jscape.Trigger.Status={QUEUED:"QUEUED",RUNNING:"RUNNING",PAUSED:"PAUSED",CANCELLED:"CANCELLED",SKIPPED:"SKIPPED",COMPLETED:"COMPLETED",FAILED:"FAILED"};jscape.Trigger.Status.values=function(){return[jscape.Trigger.Status.QUEUED,jscape.Trigger.Status.RUNNING,jscape.Trigger.Status.PAUSED,jscape.Trigger.Status.CANCELLED,jscape.Trigger.Status.SKIPPED,jscape.Trigger.Status.COMPLETED,jscape.Trigger.Status.FAILED];};jscape.TriggerStateSummary=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i){this.id=a||"";this.triggerName=b||"";this.eventId=c||"";this.status=d||jscape.Trigger.Status.QUEUED;this.startTime=parseInt(e)||0;this.endTime=parseInt(f)||0;this.runTime=parseInt(g)||0;this.actionStates=$.map(h||[],jscape.ActionState.fromJSON);this.filename=i||[];}});jscape.TriggerStateSummary.fromJSON=function(data){return data?new jscape.TriggerStateSummary(data.id,data.triggerName,data.eventId,data.status,data.startTime,data.endTime,data.runTime,data.actionStates,data.filename):null;};jscape.TriggerState=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k){this.id=a||"";this.triggerName=b||"";this.eventId=c||"";this.eventClassName=d||"";this.eventParameters=e||{};this.singleInstanceRequired=!!f;this.status=g||jscape.Trigger.Status.QUEUED;this.startTime=parseInt(h)||0;this.endTime=parseInt(i)||0;this.runTime=parseInt(j)||0;this.actionStates=k||[];}});jscape.TriggerState.fromJSON=function(data){return data?$.extend(new jscape.TriggerState(),data,{actionStates:$.map(data.actionStates||[],jscape.ActionState.fromJSON)}):null;};jscape.TriggerOperationContext=Class.extend({initialize:function(events,actions,functions,operators,properties){this.events=events||[];this.actions=actions||[];this.functions=functions||[];this.operators=operators;this.properties=properties||[];}});jscape.ActionContext=Class.extend({initialize:function(a,b,c,d,e,f,g){this.id=a||"";this.name=b||"";this.actionClass=c||null;this.parametersMap=d||{};this.onSuccessActions=$.map(e||[],jscape.ActionContext.fromJSON);this.onFailureActions=$.map(f||[],jscape.ActionContext.fromJSON);this.notes=g||"";},hasParameter:function(name){return this.parametersMap.hasOwnProperty(name);},getParameterNames:function(){return $.map(this.parametersMap,function(_,name){return name;});},getParameter:function(name){if(this.hasParameter(name)){var value=this.parametersMap[name];if(/^(true|false)$/i.test(value)){return"true"===value.toLowerCase();}else if(/^null$/.test(value)){return null;}else if(/\d+/.test(value)){var num=Number(value);return isNaN(num)?value:num;}else{return value;}}
return null;},setParameter:function(name,value){this.parametersMap[name+""]=value!=null?value+"":null;}});jscape.ActionContext.fromJSON=function(data){return data?new jscape.ActionContext(data.id,data.name,data.actionClass,data.parametersMap,data.onSuccessActions,data.onFailureActions,data.notes):null;};jscape.ActionState=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j){this.id=a||"";this.actionClass=b||null;this.actionId=c||"";this.actionName=d||"";this.startTime=parseInt(e)||0;this.endTime=parseInt(f)||0;this.runTime=parseInt(g)||0;this.status=h||jscape.ActionState.Status.QUEUED;this.actionMessage=i||"";this.triggerErrorMessage=j||"";}});jscape.ActionState.fromJSON=function(data){return data?new jscape.ActionState(data.id,data.actionClass,data.actionId,data.actionName,data.startTime,data.endTime,data.runTime,data.status,data.actionMessage,data.triggerErrorMessage):null;};jscape.ActionState.Status={QUEUED:"QUEUED",RUNNING:"RUNNING",INTERRUPTED:"INTERRUPTED",COMPLETED:"COMPLETED",FAILED:"FAILED",CANCELLED:"CANCELLED",OMITTED:"OMITTED"};jscape.TriggerOrder=Class.extend({initialize:function(a,b){this.eventType=a||"";this.triggers=b||[];}});jscape.TriggerOrder.fromJSON=function(data){return data?new jscape.TriggerOrder(data.eventType,data.triggers):null;};jscape.TriggerServiceConfiguration=Class.extend({initialize:function(a,b,c,d,e){this.maxThreadCount=!isNaN(parseInt(a))?parseInt(a):null;this.maxEventQueueSize=!isNaN(parseInt(b))?parseInt(b):null;this.maxTransferCount=!isNaN(parseInt(c))?parseInt(c):null;this.recentTriggerExpirationPeriodMillis=!isNaN(parseInt(d))?parseInt(d):null;this.globalVariables=e||{};},toJSON:function(){if(this.maxThreadCount==null&&this.maxEventQueueSize==null){var obj=$.extend({executionParameters:null},this);delete obj.maxThreadCount;delete obj.maxEventQueueSize;return obj;}
return this;}});jscape.TriggerServiceConfiguration.fromJSON=function(data){return data?new jscape.TriggerServiceConfiguration(data.maxThreadCount,data.maxEventQueueSize,data.maxTransferCount,data.recentTriggerExpirationPeriodMillis,data.globalVariables):null;};jscape.RemoteTriggerServiceConfiguration=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i){this.enabled=a!==undefined?!!a:false;this.brokerUrl=b||"";this.queueName=c||"";this.username=d||"";this.password=e||null;this.keyProvider=f||null;this.hostKeyProvider=g||null;this.events=h||[];this.maxQueueSize=parseInt(i)||0;}});jscape.RemoteTriggerServiceConfiguration.fromJSON=function(data){function keyProviderOf(provider){return provider?(provider.keyAlias?jscape.ServerKeyProvider.fromJSON(provider):(provider.file?jscape.FileKeyProvider.fromJSON(provider):null)):null;}
return $.extend(new jscape.RemoteTriggerServiceConfiguration(),data||{},data?{password:null,keyProvider:keyProviderOf(data.keyProvider),hostKeyProvider:keyProviderOf(data.hostKeyProvider)}:{});};jscape.domain.TriggersModule=jscape.domain.DomainModule.extend({onCreate:function(domainName,app,actions,functions){this._super.apply(this,arguments);var submodules=[];this.triggersController=new jscape.domain.TriggersController(actions,functions);submodules.push(app.register("trigger-list",new jscape.domain.DomainSubmodule(this.triggersController)));this.historyController=new jscape.domain.TriggerHistoryController(actions);submodules.push(app.register("trigger-history",new jscape.domain.DomainSubmodule(this.historyController)));submodules.push(app.register("trigger-templates",new jscape.domain.DomainSubmodule(new jscape.domain.TriggerTemplatesController(actions,functions))));submodules.push(app.register("trigger-settings",new jscape.domain.DomainSubmodule(new jscape.domain.TriggerSettingsController())));submodules.push(app.register("trigger-remote-settings",new jscape.domain.DomainSubmodule(new jscape.domain.RemoteTriggerSettingsController())));submodules.push(app.register("trigger-actions",new jscape.domain.DomainSubmodule(new jscape.domain.TriggerActionListController(actions))));submodules.push(app.register("trigger-functions",new jscape.domain.DomainSubmodule(new jscape.domain.TriggerFunctionListController(functions))));$.each(submodules,function(){this.onCreate(domainName,app);});},onStart:function(){this._super.apply(this,arguments);$(document).off(".triggerquicklinks").on("search_trigger_history.triggerquicklinks",$.proxy(function(e,triggerName){this.onSearchTriggerHistory(triggerName);},this)).on("edit_trigger_action.triggerquicklinks",$.proxy(function(e,triggerName,actionId){this.onEditTriggerAction(triggerName,actionId);},this));this.triggersController.start(this.domainName);},onStop:function(){this._super.apply(this,arguments);$(document).off(".triggerquicklinks");this.triggersController.stop();},onResume:function(){this._super.apply(this,arguments);this.triggersController.resume();},onPause:function(){this.triggersController.pause();},onSearchTriggerHistory:function(triggerName){if(this.app.navigateTo("trigger-history")){this.historyController.onSearchTriggerHistory(triggerName);}},onEditTriggerAction:function(triggerName,actionId){var current=this.app.currentModuleId();var changed=this.app.navigateTo("trigger-list");this.triggersController.onEditTriggerAction(triggerName,actionId).done($.proxy(function(){changed&&this.app.navigateTo(current);},this));}});jscape.domain.TriggersModule.displayClassNameOf=function(className){return(className||"").replace(/.+\.([^\.]+)(Event|Action)$/,"$1").replace(/([a-z])([A-Z])/g,"$1 $2");};jscape.domain.TriggersModule.actionDisplayNameOf=function(className,actions){for(var i=0,len=actions?actions.length:0;i<len;++i){var item=actions[i];if(item.actionClass==className&&!!item.displayName){return item.displayName;}}
return jscape.domain.TriggersModule.displayClassNameOf(className);};jscape.domain.TriggersController=jscape.ui.DatagridController.extend({view:null,initialize:function(actions,functions){this.actions=[].concat(actions||[]);this.functions=[].concat(functions||[]);this.addController=new jscape.domain.AddTriggerController();this.editController=new jscape.domain.EditTriggerController();this.copyController=new jscape.domain.CopyTriggerController();this.runController=new jscape.domain.RunTriggerController();this.deleteController=new jscape.domain.DeleteTriggerController();this.orderController=new jscape.domain.OrderTriggerController();this.importController=new jscape.domain.ImportTriggerController();this.exportController=new jscape.domain.ExportTriggerController();this.promoteController=new jscape.domain.PromoteTriggerController();this._initValidators();},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.TriggersView(this.actions);}
this.view.show(this);this.onLoadTriggerOperationContext(this.actions,this.functions).done($.proxy(function(context){this.operationContext=context;},this));},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},onLoadTriggerOperationContext:function(actions,functions){return $.when(jscape.API.getTriggerEvents(this.domainName),jscape.API.getTriggerOperators(this.domainName),jscape.API.getTriggerProperties(this.domainName)).then(function(events,operators,properties){return new jscape.TriggerOperationContext(events,actions,functions,operators,properties);},function(){return new jscape.TriggerOperationContext(undefined,actions,functions);});},onLoadTriggers:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listTriggers(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onTriggerOrder:function(){this.orderController.start(this.domainName,this.operationContext).done($.proxy(this._fireApplySuccess,this));},onTriggerHistory:function(trigger){$(document).triggerHandler("search_trigger_history",[trigger.name]);},onImportTrigger:function(data){return this.importController.start(this.domainName,data).always($.proxy(function(){this.view.refresh();},this));},onExportTrigger:function(triggers){var names=$.map(triggers,function(trigger){return trigger.name;});return this.exportController.start(this.domainName,names);},onPromoteTrigger:function(triggers){var names=$.map(triggers,function(trigger){return trigger.name;});return this.promoteController.start(this.domainName,names).done($.proxy(this._fireApplySuccess,this));},onAddTrigger:function(){this.addController.start(this.domainName,this.operationContext).done($.proxy(this._triggerAdded,this));},onEditTrigger:function(trigger,force){var index=$.inArray(trigger,this.view.getTriggers());if(index!=-1||force===true){this.editController.start(this.domainName,trigger,undefined,this.operationContext).done($.proxy(this._triggerEdited,this,index));}},onEditTriggerAction:function(triggerName,actionId){var trigger=null;for(var i=0,triggers=this.view.getTriggers(),len=triggers.length;i<len;++i){if(triggers[i].name==triggerName){trigger=triggers[i];break;}}
if(!trigger){return $.Deferred().reject();}
return this.editController.start(this.domainName,trigger,actionId,this.operationContext).done($.proxy(this._triggerEdited,this,i));},onCopyTrigger:function(trigger){this.copyController.start(this.domainName,trigger).done($.proxy(this._triggerCopied,this));},onRunTrigger:function(triggers,runWithData){var names=$.map(triggers,function(trigger){return trigger.name;});return this.runController.start(this.domainName,names,runWithData);},onDeleteTrigger:function(triggers){this.deleteController.start(this.domainName,triggers).done($.proxy(this._triggerDeleted,this,triggers)).done($.proxy(this._fireApplySuccess,this));},onTriggerEventTypes:function(){var events=$.map(this.operationContext.events,function(entry){return{text:entry.name,value:entry.type};});return $.Deferred().resolve(events).promise();},onAvailableTags:function(){return jscape.API.getDomainTags(this.domainName);},_triggerAdded:function(trigger){this._recordAdded(trigger);},_triggerEdited:function(index,trigger){this._recordEdited(trigger);},_triggerCopied:function(trigger,editAfterDone){if(editAfterDone){this.view.refresh($.proxy(function(){this.view.selectRecord(trigger);this.onEditTrigger(trigger,true);},this));}else{this._triggerAdded(trigger);}},_triggerDeleted:function(triggers){this._recordDeleted(triggers);},_initValidators:function(){var v=new jscape.Validator();v.rule("trigger_unique",$.proxy(this._triggerNotExists,this),window.R.string.TRIGGERS_ERROR_ALREADY_EXISTS);},_triggerNotExists:function(name){var names=$.map(this.view.getTriggers(),function(trigger){return trigger.name;});return $.inArray(name,names)==-1;}});jscape.domain.TriggersView=jscape.ui.DatagridView.extend({selection:null,initialize:function(actions){this.actions=actions||[];var initializing=true;this.fieldset=$("#domain-triggers-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=triggers]",this.fieldset);this.data.datagrid({fit:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"10%"},{field:"eventType",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"18%",finder:{type:"combobox",options:{loader:$.proxy(this._onLoad$EventTypes,this),editable:true,limitToList:true,width:200,panelWidth:"auto",panelMaxWidth:"50%",panelHeight:"auto",panelMaxHeight:"50%"}},formatter:$.proxy(this._formatEvent,this),sorter:$.proxy(this._sortEvent,this)},{field:"enabled",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"7%",finder:{type:"combobox",options:{data:$.map([true,false],function(value){return{text:value,value:value};}),panelHeight:"auto"}}},{field:"expression",title:$("thead th:nth-child(4)",this.data).text(),sortable:false,searchable:false,width:"27%"},{field:"actions",title:$("thead th:nth-child(5)",this.data).text(),sortable:false,searchable:false,width:"20%",formatter:$.proxy(function(_,rowData){return this._formatActions(rowData,this.actions);},this)},{field:"lastRunDate",title:$("thead th:nth-child(6)",this.data).text(),width:"10%",align:"right",formatter:$.proxy(this._formatDate,this),finder:"datetimebox"},{field:"tags",title:$("thead th:nth-child(7)",this.data).text(),width:"8%",finder:{type:"combobox",options:{loader:$.proxy(this._onLoad$Tags,this),panelHeight:"auto",panelMaxHeight:"50%"}},formatter:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();}}]],onSelect:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Triggers,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._onLoadSuccess$Triggers,this)});this._initDragAndDrop(this.data.datagrid("getPanel"));this.historyButton=$("a[role=button][name=history]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$HistoryButton,this)}).hide();this.orderButton=$("a[role=button][name=order]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$OrderButton,this)});this.importButton=$("a[role=button][name=import]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ImportButton,this)});this.exportButton=$("a[role=button][name=export]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExportButton,this)});this.promoteButton=$("a[role=button][name=promote]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$PromoteButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.copyButton=$("a[role=button][name=copy]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyButton,this)});this.runButton=$("a[role=button][name=run]",this.fieldset).splitbutton({disabled:true,plain:false,menu:"#runtriggermenu",onClick:$.proxy(this._onClick$RunButton,this)});var runButtonOpts=this.runButton.splitbutton("options");$(runButtonOpts.menu).menu({onClick:runButtonOpts.onClick});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.TriggersView.LISTENER;this._adjustRowSelection();this.data.datagrid("resize");},getTriggers:function(){return this.getRecords();},_formatEvent:function(value){return jscape.domain.TriggersModule.displayClassNameOf(value).escapeXml();},_sortEvent:function(a,b){a=jscape.domain.TriggersModule.displayClassNameOf(a);b=jscape.domain.TriggersModule.displayClassNameOf(b);return a==b?0:(a>b?1:-1);},_formatActions:function(trigger,actions){function _children(actionContexts){return $.map(actionContexts,function(context){return[jscape.domain.TriggersModule.actionDisplayNameOf(context.actionClass,actions)].concat(_children(context.onSuccessActions));});}
function _str(items,color){return items.length?'<span style="color:'+color+'">'+$.map(items,function(item){return item.escapeXml();}).join(", ")+"</span>":"";}
return $.grep([_str(_children(trigger.onStartActions),"green"),_str(_children(trigger.onFinishActions),"red"),_str(_children(trigger.onSuccessActions),"green"),_str(_children(trigger.onFailureActions),"red")],function(entry){return!!entry;}).join(", ");},_formatDate:function(value){return $.isNumeric(value)&&value!=0?new Date(value).toLocaleString():"";},_onLoad$Triggers:function(params,success,error){this.listener.onLoadTriggers(params).done(success).fail(error);},_onLoadSuccess$Triggers:function(data){this._adjustRowSelection();this.data.datagrid("autoSizeColumn","name");},_onLoad$EventTypes:function(params,success,error){this.listener.onTriggerEventTypes(params).done(success).fail(error);},_onLoad$Tags:function(params,success,error){this.listener.onAvailableTags(params).done(success).fail(error);},_onClick$OrderButton:function(){this.listener.onTriggerOrder();},_onClick$HistoryButton:function(){this.listener.onTriggerHistory(this.selection[0]);},_onClick$ImportButton:function(file){this.importButton.linkbutton("disable");this.listener.onImportTrigger(file).always($.proxy(function(){this.importButton.linkbutton("enable");},this));},_onClick$ExportButton:function(){this.exportButton.linkbutton("disable");this.listener.onExportTrigger(this.selection).always($.proxy(function(){this.exportButton.linkbutton("enable");},this));},_onClick$PromoteButton:function(){this.promoteButton.linkbutton("disable");this.listener.onPromoteTrigger(this.selection).always($.proxy(function(){this.promoteButton.linkbutton("enable");},this));},_onClick$AddButton:function(){this.listener.onAddTrigger();},_onClick$EditButton:function(){this.listener.onEditTrigger(this.selection[0]);},_onClick$CopyButton:function(){this.listener.onCopyTrigger(this.selection[0]);},_onClick$RunButton:function(item){var runWithData=item&&"run-data"==item.name;this.runButton.splitbutton("disable");this.listener.onRunTrigger(this.selection,runWithData).always($.proxy(function(){this.runButton.splitbutton("enable");},this));},_onClick$DeleteButton:function(){this.listener.onDeleteTrigger(this.selection);},_createDropArea:function(e){this._super(e,window.R.string.TRIGGERS_IMPORT_TITLE);},_onDrop:function(e){this._onClick$ImportButton(e.originalEvent.dataTransfer);},_showContextMenu:function(e){var runButtonOpts=this.runButton.splitbutton("options");var runDisabled=!!runButtonOpts.disabled;this._super(e,[{text:runButtonOpts.text,disabled:runDisabled,submenu:[{text:runButtonOpts.text,disabled:runDisabled,handler:$.proxy(this._onClick$RunButton,this)},{text:$(runButtonOpts.menu).text(),disabled:runDisabled,handler:$.proxy(this._onClick$RunButton,this,{name:"run-data"})}]},"-",this.addButton,this.editButton,this.copyButton,this.deleteButton,"-",this.historyButton,"-",this.orderButton,this.importButton,this.exportButton,this.promoteButton]);},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");this._adjustButtonsState();},_adjustButtonsState:function(){var count=this.data.datagrid("getRows").length;var runnable=this.selection.length!=0;$.each(this.selection,function(_,trigger){if(!trigger.runnable()){runnable=false;return false;}});this.orderButton.linkbutton(count>0?"enable":"disable");this.historyButton.linkbutton(this.selection.length==1?"enable":"disable");this.exportButton.linkbutton(this.selection.length!=0?"enable":"disable");this.promoteButton.linkbutton(this.selection.length!=0?"enable":"disable");this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.copyButton.linkbutton(this.selection.length==1?"enable":"disable");this.runButton.linkbutton(runnable?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.domain.TriggersView.LISTENER={onLoadTriggers:$.noop,onTriggerOrder:$.noop,onTriggerHistory:$.noop,onImportTrigger:$.noop,onExportTrigger:$.noop,onPromoteTrigger:$.noop,onAddTrigger:$.noop,onEditTrigger:$.noop,onCopyTrigger:$.noop,onRunTrigger:$.noop,onDeleteTrigger:$.noop};jscape.domain.DefaultTriggerController=Class.extend({index:-1,onChangePage:function(dialog,index,force){var previous=this.index;this.index=index;if(previous!=this.index||!!force){var item=dialog.getItem(previous);item&&typeof item.pause==="function"&&item.pause();var current=dialog.getItem(index);current&&typeof current.resume==="function"&&current.resume();}},onValidatePage:function(dialog,index){var item=dialog.getItem(index);return(item&&typeof item.validate=="function"?item.validate():$.Deferred().resolve().promise()).done($.proxy(this._onValidation$Complete,this,dialog,index)).fail($.proxy(this._onValidation$Complete,this,dialog,index));},_onValidation$Complete:function(dialog,index,data){if(data&&data.valid===false){dialog.showValidationMessage(index,false,data.message||"");}else{dialog.showValidationMessage(index,true);}},_updateTrigger:function(dialog){}});jscape.domain.AddTriggerController=jscape.domain.DefaultTriggerController.extend({deferred:null,trigger:null,start:function(domainName,operationContext){this.domainName=domainName;this.operationContext=operationContext;this.eventType=null;this.trigger=null;this.index=-1;this.deferred=$.Deferred();jscape.API.getTriggerTemplateNames(domainName).then($.proxy(function(names){if(!names||!names.length){var trigger=new jscape.Trigger();trigger.enabled=true;trigger.allowErrorEvent=true;return trigger;}
return this._selectTemplate(names).then(function(templateName){return templateName?jscape.API.getTriggerTemplate(domainName,templateName):null;}).then($.proxy(function(template){return this._triggerFromTemplate(template);},this));},this)).done($.proxy(function(trigger){this.trigger=trigger;this._setupDialog(trigger).show(this).setCurrentItem(this.parametersController);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},hasChanged:function(dialog){return true;},onSubmit:function(dialog){var trigger=this._updateTrigger(dialog,this.trigger);return jscape.API.addTrigger(this.domainName,trigger).done($.proxy(function(trigger){this.deferred.resolve(trigger);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_triggerFromTemplate:function(template){if(!template){var trigger=new jscape.Trigger();trigger.enabled=true;trigger.allowErrorEvent=true;return trigger;}
function _actionContextFor(action){var id=action.id||Object._nextId();return new jscape.ActionContext(id,action.name||id,action.className,action.parameters,$.map(action.onSuccessActions||[],_actionContextFor),$.map(action.onFailureActions||[],_actionContextFor),action.notes);}
return new jscape.Trigger("",template.description,template.eventClassName,template.expressionString,$.map(template.onStartActions,_actionContextFor),$.map(template.onFinishActions,_actionContextFor),$.map(template.onSuccessActions,_actionContextFor),$.map(template.onFailureActions,_actionContextFor),template.errorEventAllowed,true,template.asynchronous,template.singleInstanceRequired,template.singleInstanceMode,template.ignoredDomainState,template.uiLayoutData,null,[].concat(template.tags));},_selectTemplate:function(names){var deferred=$.Deferred();var dialog=new jscape.domain.SelectTriggerTemplateDialog(names);dialog.show({onSubmit:function(dialog){var name=dialog.getTemplate()||null;dialog.destroy();deferred.resolve(name);deferred=null;},onCancel:function(dialog){dialog.destroy();deferred.reject();deferred=null;}});return deferred.promise();},_setupDialog:function(trigger){var dialog=new jscape.domain.AddTriggerDialog();this.parametersController=dialog.addItem(new jscape.domain.AddTriggerParametersController(dialog));this.parametersController.start(this.domainName,trigger,this.operationContext);this.expressionController=dialog.addItem(new jscape.domain.AddTriggerExpressionController(dialog));this.expressionController.start(this.domainName,trigger,this.operationContext);this.actionsController=dialog.addItem(new jscape.domain.AddTriggerActionsController(dialog));this.actionsController.start(this.domainName,trigger,this.operationContext);return dialog;},_updateTrigger:function(dialog,trigger){this.parametersController.updateTrigger(trigger);this.expressionController.updateTrigger(trigger);this.actionsController.updateTrigger(trigger);return trigger;}});jscape.domain.EditTriggerController=jscape.domain.DefaultTriggerController.extend({deferred:null,trigger:null,start:function(domainName,trigger,actionId,operationContext){this.domainName=domainName;this.operationContext=operationContext;this.eventType=null;this.index=-1;this.deferred=$.Deferred();jscape.API.getTrigger(this.domainName,trigger.name).done($.proxy(function(trigger){this.trigger=trigger;var dialog=this._setupDialog(trigger).show(this);dialog.setCurrentItem(this.parametersController);this._navigateToEditActionPage(dialog,actionId);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},hasChanged:function(dialog){return this.parametersController.hasChanged(dialog)||this.expressionController.hasChanged(dialog)||this.actionsController.hasChanged(dialog);},onSubmit:function(dialog){var trigger=this._updateTrigger(dialog,this.trigger);return jscape.API.storeTrigger(this.domainName,trigger.name,trigger).done($.proxy(function(trigger){this.deferred.resolve(trigger);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(trigger){var dialog=new jscape.domain.EditTriggerDialog();dialog.setTriggerName(trigger.name);this.parametersController=dialog.addItem(new jscape.domain.EditTriggerParametersController(dialog));this.parametersController.start(this.domainName,trigger,this.operationContext);this.expressionController=dialog.addItem(new jscape.domain.EditTriggerExpressionController(dialog));this.expressionController.start(this.domainName,trigger,this.operationContext);this.actionsController=dialog.addItem(new jscape.domain.EditTriggerActionsController(dialog));this.actionsController.start(this.domainName,trigger,this.operationContext);return dialog;},_updateTrigger:function(dialog,trigger){this.parametersController.updateTrigger(trigger);this.expressionController.updateTrigger(trigger);this.actionsController.updateTrigger(trigger);return trigger;},_navigateToEditActionPage:function(dialog,actionId){if(!!actionId){var c=this.actionsController;dialog.setCurrentItem(c);setTimeout(function(){c.editAction(actionId);},200);}}});jscape.domain.SelectTriggerTemplateDialog=jscape.ui.DefaultDialog.extend({initialize:function(names){this._super($("#d-triggers-add-selecttemplate"),{width:"40%",minWidth:500,maxWidth:650,minHeight:250,resizable:false});this.template=$("select[name=template]",this.fieldset).combobox({required:false,editable:true,limitToList:true,data:names||[],width:"65%",panelHeight:"auto",panelMaxHeight:"50%"});this.template.combobox("textbox").on("focus",function(){$(this).select();});},show:function(listener){this._super(listener);this.template.combobox("clear");this.okButton.focus();},getTemplate:function(){return this.template.combobox("getValue");}});jscape.domain.DefaultTriggerDialog=jscape.ui.DefaultDialog.extend({items:null,initialize:function(target,options){this._super(target,$.extend({width:"95%",height:"95%",maximizable:true,resizable:true},options||{}));this.items=[];this.tabs=this.dialog.find(".content-tabs").tabs({fit:true,tabPosition:"top",justified:true,pill:true,narrow:false,plain:true,border:true,onSelect:$.proxy(this._onSelect$Tab,this),onUnselect:$.proxy(this._onUnselect$Tab,this)});},show:function(listener){this._super.apply(this,arguments);this.tabs.tabs("resize");this._moveToBottom();this.dialog.dialog("center").find("input[type=text]:visible:not(:disabled)").first().focus();return this;},addItem:function(item){this.items.push(item);return item;},getItem:function(index){return index>=0&&index<this.items.length?this.items[index]:null;},setCurrentItem:function(item){var index=$.inArray(item,this.items);if(index!=-1){var currentIndex=this.tabs.tabs("getTabIndex",this.tabs.tabs("getSelected"));if(currentIndex==index){this._onSelect$Tab(null,index);}else{this.tabs.tabs("select",index);}}},showValidationMessage:function(index,valid,message){var tab=this.tabs.tabs("getTab",index);var tabHeader=this.tabs.children("div.tabs-header").find("ul.tabs").children("li:eq("+index+")");if(!valid){this.tabs.tabs("update",{type:"header",tab:tab,options:{iconCls:"icon-warning"}});if(!!message){tabHeader.find(".icon-warning").tooltip({content:message,position:"bottom",showDelay:0,hideDelay:500,onShow:$.fn.validatebox.defaults.tipOptions.onShow||$.noop});}}else{tabHeader.find(".icon-warning").tooltip("destroy");this.tabs.tabs("update",{type:"header",tab:tab,options:{iconCls:null}});}},_valid:function(){return new jscape.Validator().validateTabs(this.tabs,false);},_onSubmit:function(e){if(e&&!!e.__submitConfirmed){return this._super.apply(this,arguments);}
var btn=this._defaultButton();if(e&&!e.defaultPrevented&&btn){e.preventDefault();e.stopPropagation();btn.linkbutton("disable");$.when.apply(jQuery,$.map(this.items,$.proxy(function(_,index){return this.listener.onValidatePage(this,index);},this))).done(function(){setTimeout(function(){btn.linkbutton("enable").triggerHandler($.Event(e,{__submitConfirmed:true}));},50);}).fail(function(){btn.linkbutton("enable");});}
return $.Deferred().reject().promise();},_onSelect$Tab:function(title,index){var item=this.getItem(index);if(!item){return;}
this.listener.onChangePage(this,index);setTimeout($.proxy(function(d){d.dialog("resize");},this,this.dialog),0);this._adjustDialogTitle();this._adjustButtonsState();},_onUnselect$Tab:function(title,index){this.listener.onValidatePage(this,index);},_adjustDialogTitle:function(){},_adjustButtonsState:function(){},_moveToBottom:function(){var opts=this.dialog.dialog("options");var win=this.dialog.dialog("window");var height,scrollTop=0;if(opts.inline){var p=win.parent();height=p.height();scrollTop=p.scrollTop();}else{height=$(window)._outerHeight();scrollTop=!opts.fixed?$(document).scrollTop():0;}
this.dialog.dialog("move",{top:Math.ceil((height-win._outerHeight())-scrollTop)});}});jscape.domain.AddTriggerDialog=jscape.domain.DefaultTriggerDialog.extend({initialize:function(){this._super($("#d-triggers-add"));}});jscape.domain.EditTriggerDialog=jscape.domain.DefaultTriggerDialog.extend({initialize:function(){this._super($("#d-triggers-edit"));},setTriggerName:function(value){this.triggerName=value||"";},_adjustDialogTitle:function(){this.dialog.dialog("setTitle",this.title.supplant({0:this.triggerName}));}});jscape.domain.TriggerParametersView=jscape.ui.FormView.extend({initialize:function(fieldset,dialog){var initializing=true;this.fieldset=fieldset;this.layout=fieldset.find(".content").layout({fit:true,doSize:false,border:true});this.event=$("select[name=eventtype]",this.fieldset).combobox({required:true,editable:true,limitToList:true,textField:"name",valueField:"type",loader:$.proxy(this._onLoad$Events,this),onBeforeLoad:function(){return!initializing;},onChange:$.proxy(this._onChange$Event,this),width:"60%",panelHeight:"auto",panelMinHeight:30,panelMaxHeight:"40%"});this.event.combobox("textbox").on("focus",function(){$(this).select();});this.eventHelp=this.fieldset.find("#"+this.event.attr("aria-describedby")).tooltip({position:"bottom",showDelay:200,onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");}});this.description=$("textarea[name=description]",this.fieldset).textbox({multiline:true,width:"60%",height:120});this.tags=$("select[name=tags]",this.fieldset).tagbox({limitToList:jscape.acl&&!jscape.acl.tic,hasDownArrow:true,loader:$.proxy(this._onLoad$Tags,this),onBeforeLoad:function(){return!initializing;},onAddTag:$.proxy(this._onClick$AddTagButton,this),tagEditor:$("#d-add-tag-inline"),width:"60%",panelHeight:"auto",panelMinHeight:50});this.ignoreDomainState=$("input[name=ignoredomainstate]:checkbox",this.fieldset).change($.proxy(function(){var enabled=this.ignoreDomainState.is(":checked");this.domainState.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");},this));this.domainState=$("select[name=domainstate]",this.fieldset);this.domainState.combobox({required:true,editable:false,width:170,panelHeight:"auto",onLoadSuccess:$.proxy(function(data){if(data.length==0){this.ignoreDomainState.prop("disabled",true).prop("checked",false)}
this.ignoreDomainState.change();},this)});this.enabled=$("input[name=enabled]:checkbox",this.fieldset);this.triggerSingleInstance=$("input[name=singleinstance]:checkbox",this.fieldset).change($.proxy(function(){var enabled=this.triggerSingleInstance.is(":checked");this.triggerSingleInstanceMode.combobox(enabled?"enable":"disable");},this));this.triggerSingleInstanceMode=$("select[name=singleinstancemode]",this.fieldset);this.triggerSingleInstanceMode.combobox({required:true,editable:false,width:"20%",panelHeight:"auto",onLoadSuccess:$.proxy(function(data){if(data.length==0){this.triggerSingleInstance.prop("disabled",true).prop("checked",false);}
this.triggerSingleInstance.change();},this)});this.triggerAsynchronous=$("input[name=triggerasync]:checkbox",this.fieldset);this.fireError=$("input[name=fireerror]:checkbox",this.fieldset);initializing=false;},getEvent:function(){var data=this.event.combobox("getData");var value=this.event.combobox("getValue");for(var i=0;i<data.length;i++){var event=data[i];if(event.type==value){return event;}}
return null;},setEvent:function(value){value&&this.event.combobox("setValue",value);},getDescription:function(){return this.description.textbox("getValue");},setDescription:function(value){this.description.textbox("setValue",value);},getIgnoredDomainState:function(){return this.ignoreDomainState.is(":checked")?this.domainState.combobox("getValue"):null;},setIgnoredDomainState:function(value){this.ignoreDomainState.prop("checked",value!=null).change();if(value!=null){this.domainState.combobox("select",value);}},isEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value);},isSingleInstanceRequired:function(){return this.triggerSingleInstance.is(":checked");},setSingleInstanceRequired:function(value){this.triggerSingleInstance.prop("checked",!!value).change();},getSingleInstanceMode:function(){return this.triggerSingleInstanceMode.combobox("getValue");},setSingleInstanceMode:function(value){this.triggerSingleInstanceMode.combobox("select",value);},isTriggerAsynchronous:function(){return this.triggerAsynchronous.is(":checked");},setTriggerAsynchronous:function(value){this.triggerAsynchronous.prop("checked",!!value);},isFireError:function(){return this.fireError.is(":checked");},setFireError:function(value){this.fireError.prop("checked",!!value);},getTags:function(){return this.tags.tagbox("getValues");},setTags:function(values){this.tags.tagbox("setValues",values);},setListener:function(listener){this.listener=listener;},show:function(){this.layout.layout("resize");this.event.combobox("reload");this.tags.tagbox("reload");this._onChange$Event();},hide:function(){},valid:function(){return this._valid();},_onClick$AddTagButton:function(tag){this.listener.onAddTag(tag).done($.proxy(function(){this.tags.tagbox("reload");},this));},_onLoad$Tags:function(params,success,error){this.listener.onLoadTags(params).done(success).fail(error);},_onLoad$Events:function(params,success,error){this.listener.onLoadEvents(params).then(success,error);},_onChange$Event:function(){var event=this.getEvent();if(event!=null){this._adjustEventHelp(event);this._adjustFireErrorState(event);}},_adjustEventHelp:function(event){if(event&&event.description){var content="<div class=\"tooltip-title\">"+event.name+"</div>"+event.description;this.eventHelp.tooltip("update",content).removeClass("disabled");}else{this.eventHelp.tooltip("update",function(){return"...";}).addClass("disabled");}},_adjustFireErrorState:function(event){if(this._triggerErrorEvent(event.type)){this.fireError.prop("disabled",true).prop("checked",false);}else if(this.fireError.is(":disabled")){this.fireError.prop("disabled",false);}},_triggerErrorEvent:function(type){return"com.jscape.inet.mft.workflow.TriggerErrorEvent"===type;}});jscape.domain.TriggerParametersController=Class.extend({copy:null,initialize:function(view){this.view=view;},start:function(domainName,trigger,operationContext){this.domainName=domainName;this.trigger=trigger;this.copy=trigger.clone();this.events=operationContext.events||[];this.view.setListener(this);this.setupView(trigger);},pause:function(){this.updateTrigger(this.trigger);this.view.hide();},resume:function(){this.view.show();this.setupView(this.trigger);},validate:function(){return!this.view.valid()?$.Deferred().reject({valid:false,message:window.R.string.TRIGGER_ERROR_PARAMETERS_TEST_FAILED}).promise():$.Deferred().resolve({valid:true}).promise();},hasChanged:function(dialog){return this.copy&&!Object._equals(this.copy,$.extend({},this.copy,this._createParameters()));},updateTrigger:function(trigger){$.extend(trigger,this._createParameters());},setupView:function(trigger){if(!!trigger){this.view.setDescription(trigger.description);this.view.setEvent(trigger.eventType);this.view.setFireError(trigger.allowErrorEvent);this.view.setEnabled(trigger.enabled);this.view.setTriggerAsynchronous(trigger.asynchronous);this.view.setSingleInstanceRequired(trigger.singleInstanceRequired);this.view.setSingleInstanceMode(trigger.singleInstanceMode);this.view.setIgnoredDomainState(trigger.ignoredDomainState);this.view.setTags(trigger.tags);}},_createParameters:function(){return{description:this.view.getDescription(),eventType:this.view.getEvent()!=null?this.view.getEvent().type:undefined,allowErrorEvent:!!this.view.isFireError(),enabled:!!this.view.isEnabled(),asynchronous:!!this.view.isTriggerAsynchronous(),singleInstanceRequired:!!this.view.isSingleInstanceRequired(),singleInstanceMode:this.view.getSingleInstanceMode(),ignoredDomainState:this.view.getIgnoredDomainState(),tags:this.view.getTags()};},onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},onLoadEvents:function(){return $.Deferred().resolve(this.events).promise();}});jscape.domain.AddTriggerParametersController=jscape.domain.TriggerParametersController.extend({initialize:function(dialog){this._super(new jscape.domain.AddTriggerParametersView(dialog));},setupView:function(trigger){this._super.apply(this,arguments);this.view.setName(trigger.name);},_createParameters:function(){return $.extend(this._super.apply(this,arguments),{name:this.view.getName()});}});jscape.domain.EditTriggerParametersController=jscape.domain.TriggerParametersController.extend({initialize:function(dialog){this._super(new jscape.domain.EditTriggerParametersView(dialog));}});jscape.domain.AddTriggerParametersView=jscape.domain.TriggerParametersView.extend({initialize:function(dialog){this._super($("#d-triggers-add-parameters-content"+dialog.getIdSuffix()),dialog);this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["trigger_unique","non_empty"],missingMessage:window.R.string.TRIGGERS_ERROR_BAD_TRIGGER_NAME,invalidMessage:window.R.string.TRIGGERS_ERROR_BAD_TRIGGER_NAME,width:"60%"});},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value);}});jscape.domain.EditTriggerParametersView=jscape.domain.TriggerParametersView.extend({initialize:function(dialog){this._super($("#d-triggers-edit-parameters-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.TriggerExpressionController=Class.extend({OPERATOR:{LOGICAL:{AND:"AND",OR:"OR"}},initialize:function(view){this.view=view;this.cache={};this.autoCompleteController=new jscape.AutoCompleteController();this.constantsController=new jscape.domain.ConstantsController();this.timeExpressionController=new jscape.domain.TimeExpressionController();this.testController=new jscape.domain.ExpressionTestController();},start:function(domainName,trigger,operationContext){this.domainName=domainName;this.trigger=trigger;this.copy=trigger.expression||"";this.eventType=trigger.eventType;this.eventProperties=null;this.operationContext=operationContext;this.cache={};this.view.setListener(this);this.setupView(trigger);},hasChanged:function(dialog){return!Object._equals(this.copy,this.view.getExpression());},updateTrigger:function(trigger){if(this._eventTypeLoaded(trigger.eventType)){trigger.expression=this.view.getExpression();}},setupView:function(trigger){var eventType=trigger.eventType;if(!!this.loading||!eventType||this._eventTypeLoaded(eventType)){return;}
this.loading=jscape.API.getTriggerEvent(this.domainName,eventType).done($.proxy(function(properties){this.loading=null;this.eventType=eventType;this.eventProperties=properties||[];this._setupView(trigger.expression,eventType);},this)).fail($.proxy(function(){this.loading=null;},this));},pause:function(){this.updateTrigger(this.trigger);this.view.hide();},resume:function(){this.view.show();this.setupView(this.trigger);},validate:function(){var expression=this.view.getExpression()||this.trigger.expression;return this._validateExpression(expression,this.eventType);},onInsertVariable:function(input){var variables=$.map([].concat(this.eventProperties,this.operationContext.properties),function(entry){return{value:entry.property,text:entry.property||"",title:entry.description||""};}).sort(function(a,b){return a.text.localeCompare(b.text);});return this.autoCompleteController.start(input,variables,true);},onInsertFunction:function(input){return new jscape.FunctionController('','').start(input,this.operationContext.functions,true);},onInsertOperator:function(input){var operators=$.map(this.operationContext.operators,function(operator){var help=operator.help||{};return{value:operator.signature,text:help.signature||operator.signature,tooltip:'<div class="tooltip-title">'+help.description+"</div>"
+(help.example?"<code>"+(help.example+"").escapeXml()+"</code>":"")
+(help.result?"<div>"+(help.result+"").escapeXml()+"</div>":"")};});return this.autoCompleteController.start(input,operators,true);},onInsertConstant:function(){return this.constantsController.start().then($.proxy(function(val){this.view.insertText(val);},this));},onInsertAndOperator:function(){this.view.insertText(this.OPERATOR.LOGICAL.AND+" ");},onInsertOrOperator:function(){this.view.insertText(this.OPERATOR.LOGICAL.OR+" ");},onInsertTimeExpression:function(){return this.timeExpressionController.start(this.eventProperties).then($.proxy(function(val){this.view.insertText(val);},this));},onTestExpression:function(){return this.validate().then($.proxy(function(){return this.testController.start(this.domainName,this.view.getExpression(),this.eventType,this.eventProperties);},this));},onParseExpression:function(data){return jscape.API.parseTriggerExpression(this.domainName,data).then($.proxy(function(data){if(this._containsFunction(data)){this.view.setOverrideMode(true,window.R.string.TRIGGERS_ERROR_EXPRESSION_CONTAINS_FUNCTION);return null;}
return data;},this));},_eventTypeLoaded:function(eventType){return!!eventType&&this.eventType==eventType&&!!this.eventProperties;},_setupView:function(expression,eventType){expression=expression||"";var filters=$.map([].concat(this.eventProperties,this.operationContext.properties),$.proxy(this._eventProperty2QueryFilter,this));this.view.setQueryFilters(this._uniqueQueryFilters(filters));this.view.setExpression(expression);if(expression.length!=0){this._validateExpression(expression,eventType).done($.proxy(function(){this.view.setOverrideMode(false);},this)).fail($.proxy(function(error){this.view.setOverrideMode(true);},this));}else{this.view.setOverrideMode(false);}},_containsFunction:function(data){var found=false;(function _contains(data){if(data!=null&&typeof data=="object"){if("functionName"in data){found=true;return;}
_contains(data.leftExpression);_contains(data.rightExpression);}})(data);return found;},_uniqueQueryFilters:function(filters){var copy=filters.concat();for(var i=0;i<copy.length;++i){for(var j=i+1;j<copy.length;++j){if(copy[i].id===copy[j].id){copy.splice(j--,1);}}}
return copy;},_eventProperty2QueryFilter:function(property){var name=property.property;switch(property.type){case"byte":case"short":case"int":case"long":case"number":return{id:name,label:name,description:property.description,type:"integer",operators:["equal","not_equal","less","less_or_equal","greater","greater_or_equal","contains","not_contains","matches","not_matches"]};break;case"boolean":return{id:name,label:name,description:property.description,type:"boolean",input:"radio",operators:["equal"],values:[{"true":true},{"false":false}]};break;default:var data={id:name,label:name,description:property.description,type:"string",operators:["equal","not_equal","is_empty","is_not_empty","contains","not_contains","matches","not_matches"]};var loader=this._eventPropertyValueLoader(name);if(typeof loader=="function"){$.extend(data,{input:"select",options:{editable:true,limitToList:false,autoSelectFirst:false,loader:loader}});}
return data;}},_eventPropertyValueLoader:function(property){property=String(property).toLocaleLowerCase();switch(property){case"partnername":case"tradingpartner":case"tradingpartnera":case"tradingpartnerb":return $.proxy(this._onLoadTradingPartners,this);case"monitorname":return $.proxy(this._onLoadDirectoryMonitors,this);case"username":return $.proxy(this._onLoadUsers,this);case"domainname":return $.proxy(this._onLoadDomains,this);default:return null;}},_onLoadTradingPartners:function(_,success,error){return this._loadPropertyValues("domain.tradingPartners",$.proxy(function(){return jscape.API.getTradingPartnerNames(this.domainName);},this)).done(success).fail(error);},_onLoadDirectoryMonitors:function(_,success,error){return this._loadPropertyValues("domain.directoryMonitors",$.proxy(function(){return jscape.API.getDirectoryMonitorNames(this.domainName);},this)).done(success).fail(error);},_onLoadUsers:function(_,success,error){return this._loadPropertyValues("domain.usernames",$.proxy(function(){return jscape.API.getAccountNames(this.domainName);},this)).done(success).fail(error);},_onLoadDomains:function(_,success,error){return this._loadPropertyValues("domain.names",function(){return jscape.API.getDomainNames();}).done(success).fail(error);},_loadPropertyValues:function(property,loader){var values=this.cache.hasOwnProperty(property)?this.cache[property]:null;if((!values||!values.length)&&typeof loader=="function"){return loader().then($.proxy(function(data){this.cache[property]=data;return data;},this),function(){return[];});}
return $.Deferred().resolve(values).promise();},_validateExpression:function(expression,eventType){return jscape.API.validateTriggerExpression(this.domainName,expression,eventType).catch(function(r){return $.Deferred().reject($.extend({valid:false},(r&&r.responseJSON)||{}));});}});jscape.domain.TriggerExpressionView=jscape.ui.FormView.extend({initialize:function(fieldset,dialog){this.fieldset=fieldset;this.layout=fieldset.find(".content").layout({fit:true,doSize:false,border:true});this.warning=$("[aria-label=query-builder-warning]",this.fieldset).hide();this.builder=$("div[aria-label=querybuilder]",this.fieldset).queryBuilder({sort_filters:true,filters:[{id:"________",type:"string"}],plugins:{"easyui":{}}}).on("rulesChanged.queryBuilder",$.proxy(function(){if(!!this.filtersLoaded&&this.builder.queryBuilder("isEnabled")){this.expression.textbox("setValue",this.builder.queryBuilder("getTriggerExpression"));}},this)).on("afterSetFilters.queryBuilder",$.proxy(function(){this.filtersLoaded=true;this.override.change();},this));this.builder.queryBuilder("disable");this.expression=$("textarea[name=expression]",this.fieldset).textbox({multiline:true,width:"100%",height:90});this.override=$("input[name=override]:checkbox",this.fieldset).change($.proxy(this._onChange$Override,this));this.variablesButton=$("a[role=button][name=variables]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$VariablesButton,this)});this.functionsButton=$("a[role=button][name=functions]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$FunctionsButton,this)});this.constantsButton=$("a[role=button][name=constants]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ConstantsButton,this)});this.timeExpressionButton=$("a[role=button][name=timeexpression]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$TimeExpressionButton,this)});this.operatorsButton=$("a[role=button][name=operators]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$OperatorsButton,this)});this.operatorAndButton=$("a[role=button][name=operatorand]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$OperatorAndButton,this)});this.operatorOrButton=$("a[role=button][name=operatoror]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$OperatorOrButton,this)});this.testButton=$("a[role=button][name=testexpression]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$TestButton,this)});this._adjustButtonsBarLayout(this.layout);},setListener:function(listener){this.listener=listener||jscape.domain.TriggerExpressionView.LISTENER;},show:function(listener){this.layout.layout("resize");this.override.change();},hide:function(){},getExpression:function(){return this.isOverrideMode()||!this.expressionParsed?this.expression.textbox("getValue").trim():this.builder.queryBuilder("getTriggerExpression");},setExpression:function(value){if(value){this.expression.textbox("setValue",value);}},isOverrideMode:function(){return this.override.is(":checked");},setOverrideMode:function(value,message){if(value===false){this.override.prop("checked",false).change();this.warning.hide().find("[aria-label=warning-message]").text();}else{this.override.prop("checked",true).change();this.warning.show().find("[aria-label=warning-message]").text(message||"");}},setQueryFilters:function(filters){this.builder.queryBuilder("setFilters",true,filters);},insertText:function(value){var input=this.expression.textbox("textbox");var text=input.val();text=text.substring(0,input[0].selectionStart)+value+text.substring(input[0].selectionEnd);this.expression.textbox("setText",text);input[0].selectionStart=input[0].selectionEnd=input[0].selectionStart+value.length;input.triggerHandler("blur");return input.focus();},_onChange$Override:function(){if(this.isOverrideMode()){this.expression.textbox("readonly",false);this.builder.queryBuilder("disable");}else{this.warning.hide();var str=this.expression.textbox("readonly",true).textbox("getValue");var expression=this.builder.queryBuilder("getTriggerExpression");this.builder.queryBuilder("enable");if(str!==expression){this.expressionParsed=false;this.listener.onParseExpression(str).then($.proxy(function(data){this.expressionParsed=true;if(data&&this.builder.queryBuilder("isEnabled")){this.builder.queryBuilder("setTriggerExpression",data);}},this));}}
this._adjustButtonsState();},_onClick$VariablesButton:function(){this.listener.onInsertVariable(this.expression.textbox("textbox"));},_onClick$FunctionsButton:function(){this.listener.onInsertFunction(this.expression.textbox("textbox"));},_onClick$OperatorsButton:function(){this.listener.onInsertOperator(this.expression.textbox("textbox"));},_onClick$ConstantsButton:function(){this.listener.onInsertConstant();},_onClick$OperatorAndButton:function(){this.listener.onInsertAndOperator();},_onClick$OperatorOrButton:function(){this.listener.onInsertOrOperator();},_onClick$TimeExpressionButton:function(){this.listener.onInsertTimeExpression();},_onClick$TestButton:function(){this.testButton.linkbutton("disable");this.listener.onTestExpression().always($.proxy(function(){this.testButton.linkbutton("enable");},this));},_adjustButtonsState:function(){var enabled=this.isOverrideMode();$.each([this.variablesButton,this.functionsButton,this.constantsButton,this.timeExpressionButton,this.operatorsButton,this.operatorAndButton,this.operatorOrButton],function(_,button){button.linkbutton(enabled?"enable":"disable");});}});jscape.domain.TriggerExpressionView.LISTENER={onInsertVariable:$.noop,onInsertFunction:$.noop,onInsertConstant:$.noop,onInsertOperator:$.noop,onInsertAndOperator:$.noop,onInsertOrOperator:$.noop,onInsertTimeExpression:$.noop,onParseExpression:$.noop,onTestExpression:$.noop};jscape.domain.AddTriggerExpressionController=jscape.domain.TriggerExpressionController.extend({initialize:function(dialog){this._super(new jscape.domain.AddTriggerExpressionView(dialog));}});jscape.domain.AddTriggerExpressionView=jscape.domain.TriggerExpressionView.extend({initialize:function(dialog){this._super($("#d-triggers-add-expression-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.EditTriggerExpressionController=jscape.domain.TriggerExpressionController.extend({initialize:function(dialog){this._super(new jscape.domain.EditTriggerExpressionView(dialog));}});jscape.domain.EditTriggerExpressionView=jscape.domain.TriggerExpressionView.extend({initialize:function(dialog){this._super($("#d-triggers-edit-expression-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.AddTriggerActionsController=jscape.domain.TriggerActionsController.extend({initialize:function(dialog){this._super(new jscape.domain.AddTriggerActionsView(dialog));}});jscape.domain.AddTriggerActionsView=jscape.domain.TriggerActionsView.extend({initialize:function(dialog){this._super($("#d-triggers-add-actions-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.EditTriggerActionsController=jscape.domain.TriggerActionsController.extend({initialize:function(dialog){this._super(new jscape.domain.EditTriggerActionsView(dialog));},editAction:function(id){this.view.editAction(id);}});jscape.domain.EditTriggerActionsView=jscape.domain.TriggerActionsView.extend({initialize:function(dialog){this._super($("#d-triggers-edit-actions-content"+dialog.getIdSuffix()),dialog);},editAction:function(id){if(this.selectOperator(id)){this.editButton.click();}}});jscape.domain.TimeExpressionController=Class.extend({FIELD:{HOUR:"Hour",MINUTE:"Minute",DAY_OF_WEEK:"DayOfWeek",DAY_OF_MONTH:"DayOfMonth",DAY_OF_YEAR:"DayOfYear",WEEK_OF_MONTH:"WeekOfMonth",WEEK_OF_YEAR:"WeekOfYear",MONTH:"Month",YEAR:"Year"},VALUE_SEPARATOR_REGEXP:/\s*,\s*/,deferred:null,eventProperties:null,initialize:function(){this._initValidators();},start:function(eventProperties){this.eventProperties=eventProperties||{};this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onHelpRequested:function(name){var help=null;$.each(this.eventProperties,function(_,entry){if((entry.property||"").toLowerCase()==name.toLowerCase()){help=entry.description;return false;}
return true;});return help;},onSubmit:function(dialog){var expression=this._createExpression(dialog);dialog.destroy();this.deferred.resolve(expression);},onCancel:function(dialog){dialog.destroy();this.deferred.reject();},_setupDialog:function(){return new jscape.domain.TimeExpressionDialog();},_createExpression:function(dialog){return $.map($.grep([this._fieldExpression(this.FIELD.HOUR,dialog.getHour()),this._fieldExpression(this.FIELD.MINUTE,dialog.getMinute()),this._fieldExpression(this.FIELD.DAY_OF_WEEK,dialog.getDayOfWeek()),this._fieldExpression(this.FIELD.DAY_OF_MONTH,dialog.getDayOfMonth()),this._fieldExpression(this.FIELD.DAY_OF_YEAR,dialog.getDayOfYear()),this._fieldExpression(this.FIELD.WEEK_OF_MONTH,dialog.getWeekOfMonth()),this._fieldExpression(this.FIELD.WEEK_OF_YEAR,dialog.getWeekOfYear()),this._fieldExpression(this.FIELD.MONTH,dialog.getMonth()),this._fieldExpression(this.FIELD.YEAR,dialog.getYear())],function(entry){return entry!=null;}),function(expression){return"("+expression+")"}).join(" AND ");},_fieldExpression:function(field,value){var values=value.trim().split(this.VALUE_SEPARATOR_REGEXP);return value.trim().length!=0?$.map(values,function(value){return field+" = "+parseInt(value,10);}).join(" OR "):null;},_initValidators:function(value){var v=new jscape.Validator();v.rule("timeexpression_comma_separated_numbers",$.proxy(this._commaSeparatedNumbers,this));},_commaSeparatedNumbers:function(value){var values=value.trim().split(this.VALUE_SEPARATOR_REGEXP);return $.grep(values,function(value){return/[^\d]+/.test(value)||isNaN(parseInt(value,10));}).length==0;}});jscape.domain.TimeExpressionDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-timexpression"),{width:"50%",resizable:false});this.fieldset=$("fieldset[name=timeexpressionfields]",this.dialog);this.hour=$("input[name=hour]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_HOURS,width:"60%"});this.minute=$("input[name=minute]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_MINUTES,width:"60%"});this.dayOfWeek=$("input[name=dayofweek]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_DAYSOFWEEK,width:"60%"});this.dayOfMonth=$("input[name=dayofmonth]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_DAYSOFMONTH,width:"60%"});this.dayOfYear=$("input[name=dayofyear]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_DAYSOFYEAR,width:"60%"});this.weekOfMonth=$("input[name=weekofmonth]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_WEEKSOFMONTH,width:"60%"});this.weekOfYear=$("input[name=weekofyear]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_WEEKSOFYEAR,width:"60%"});this.month=$("input[name=month]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_MONTHS,width:"60%"});this.year=$("input[name=year]",this.fieldset).textbox({required:false,validType:"timeexpression_comma_separated_numbers",invalidMessage:window.R.string.TIME_EXPRESSION_ERROR_BAD_YEARS,width:"60%"});},show:function(listener){var inputs=this.fieldset.find("input.textbox-f");this.fieldset.find("[role=tooltip]").each(function(_,el){var input=inputs.filter("[aria-describedby="+$(el).attr("id")+"]");if(input.length){var help=listener.onHelpRequested(input.attr("textboxName")||"");$(el).attr("title",help||"");}},this);this._super(listener);},getHour:function(){return this.hour.textbox("getValue");},getMinute:function(){return this.minute.textbox("getValue");},getDayOfWeek:function(){return this.dayOfWeek.textbox("getValue");},getDayOfMonth:function(){return this.dayOfMonth.textbox("getValue");},getDayOfYear:function(){return this.dayOfYear.textbox("getValue");},getWeekOfMonth:function(){return this.weekOfMonth.textbox("getValue");},getWeekOfYear:function(){return this.weekOfYear.textbox("getValue");},getMonth:function(){return this.month.textbox("getValue");},getYear:function(){return this.year.textbox("getValue");}});jscape.domain.TimeExpressionDialog.LISTENER={onHelpRequested:$.noop};jscape.domain.ConstantsController=Class.extend({BOOLEAN:{TRUE:"TRUE",FALSE:"FALSE"},deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return this.deferred.resolve(this._createConstant(dialog));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createConstant:function(dialog){if(dialog.isString()){return'"'+dialog.getString()+'"';}else if(dialog.isBoolean()){return dialog.getBoolean()?this.BOOLEAN.TRUE:this.BOOLEAN.FALSE;}else if(dialog.isNumber()){return dialog.getNumber();}
return"";},_setupDialog:function(){return new jscape.domain.ConstantsDialog();}});jscape.domain.ConstantsDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-constant"),{width:"40%",minWidth:450,maxWidth:650,resizable:false});this.fieldset=$("fieldset[name=triggerexpressionconstantsfields]",this.dialog);this.type=$("input[name=type]",this.fieldset).change($.proxy(this._adjustFieldState,this));this.stringValue=$("input[name=string]",this.fieldset).textbox({validType:"non_empty",width:"70%"});this.numberValue=$("input[name=number]",this.fieldset).numberspinner({value:0,width:"50%"});this.booleanValue=$("input[name=boolean]:radio",this.fieldset);},isString:function(){return this.type.filter("[value=string]").is(":checked");},getString:function(){return this.stringValue.textbox("getValue");},isNumber:function(){return this.type.filter("[value=number]").is(":checked");},getNumber:function(){return parseInt(this.numberValue.numberspinner("getValue"));},isBoolean:function(){return this.type.filter("[value=boolean]").is(":checked");},getBoolean:function(){return this.booleanValue.filter("[value=true]").is(":checked");},show:function(listener){this._super(listener);this.type.first().prop("checked",true).change();},_adjustFieldState:function(){this.stringValue.textbox(this.isString()?"enable":"disable");this.numberValue.numberspinner(this.isNumber()?"enable":"disable");this.booleanValue.prop("disabled",!this.isBoolean());if(this.isString()){this.stringValue.textbox("textbox").focus();}else if(this.isNumber()){this.numberValue.focus();}else if(this.isBoolean()){this.booleanValue.filter(":checked").focus();}}});jscape.domain.ExpressionTestController=Class.extend({deferred:null,start:function(domainName,expression,eventType,eventProperties){this.domainName=domainName;this.expression=expression||"";this.eventType=eventType||"";this.eventProperties=eventProperties;this.deferred=$.Deferred();if(this.expression.length){this._setupDialog().show(this);}else{this.deferred.reject();}
return this.deferred.promise();},onTest:function(dialog){return jscape.API.testTriggerExpression(this.domainName,this.expression,this._createParameters(dialog),this.eventType).then(function(data){return $.isPlainObject(data)?!!data.valid:"true"===(data||"").toLowerCase();}).done(function(success){if(success){$.messager.alert(window.R.string.TRIGGERS_TEST_EXPRESSION_DIALOG_TITLE,window.R.string.TRIGGERS_SUCCESS_EXPRESSION_TEST_PASSED,"info");}else{$.messager.alert(window.R.string.TRIGGERS_TEST_EXPRESSION_DIALOG_TITLE,window.R.string.TRIGGERS_ERROR_EXPRESSION_TEST_FAILED,"error");}});},onCancel:function(dialog){dialog.destroy();},_setupDialog:function(){var dialog=new jscape.domain.ExpressionTestDialog();dialog.setExpression(this.expression);dialog.setProperties(this.eventProperties);return dialog;},_createParameters:function(dialog){var parameters={};$.each(this.eventProperties,function(_,entry){var name=entry.property;parameters[name]=dialog.getParameter(name);});return parameters;}});jscape.domain.ExpressionTestDialog=jscape.ui.DefaultDialog.extend({panels:null,initialize:function(){this._super($("#d-triggers-expressiontest"),{width:"70%",buttons:[{text:window.R.string.DIALOG_BUTTON_TEST||"Test",handler:$.proxy(this._onTest,this)},{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}]});this.fieldset=$("fieldset[name=triggerexpressiontestfields]",this.dialog);this.expression=$("textarea[name=expression]",this.fieldset).textbox({multiline:true,width:"100%",height:80,readonly:true});this.parameters=$("fieldset[name=expressionparametersfields]",this.dialog);},setExpression:function(value){this.expression.textbox("setValue",value);},setProperties:function(properties){this.panels=[];this.parameters.empty();$.each(properties,$.proxy(function(_,entry){var panel=this._createValuePanel(entry);panel.appendTo(this.parameters);this.panels.push(panel);},this));},getParameter:function(name){for(var i=0;i<this.panels.length;i++){var panel=this.panels[i];if(name==panel.getName()){return panel.getValue();}}
return null;},_onTest:function(){if(this.fieldset.form("validate")){this.listener.onTest(this);}},_createValuePanel:function(eventProperty){return new jscape.domain.ExpressionTestDialog.ValuePanel(eventProperty.type,eventProperty.property);}});jscape.domain.ExpressionTestDialog.ValuePanel=Class.extend({type:null,input:null,initialize:function(type,name){this.type=type;this.name=name;},appendTo:function(parent){var row;if(this.isBoolean()){this.input=$('<div class="radio"><span style="width:16em;float:left">'+this.name+'</span>'
+'<label><input type="radio" name="'+this.name+'" value="true" />true</label>'
+'&nbsp;&nbsp;<label><input type="radio" name="'+this.name+'" value="false" />false</label>').appendTo(parent).find(":input");}else if(this.isNumber()){this.input=$('<div><label>'+this.name+'</label><input type="text" name="'+this.name+'"/></div>').appendTo(parent).find(":input").numberspinner({value:0,width:"25%"});}else{this.input=$('<div><label>'+this.name+'</label><input type="text" name="'+this.name+'" maxlength="50"/></div>').appendTo(parent).find(":input").textbox({width:"60%"});}},getName:function(){return this.name;},getValue:function(){if(this.isBoolean()){return this.input.filter("[value=true]").is(":checked");}else if(this.isNumber()){return parseInt(this.input.numberspinner("getValue"));}else{return this.input.val();}},isBoolean:function(){return this.type==="boolean";},isNumber:function(){return $.inArray(this.type,["byte","short","int","long","number"])!=-1;}});jscape.domain.OrderTriggerController=Class.extend({eventType:null,triggers:null,copy:null,deferred:null,start:function(domainName,operationContext){this.domainName=domainName;this.eventType=null;this.triggers=[];this.deferred=$.Deferred();this._selectTriggerEvent(operationContext.events).then($.proxy(function(eventType){this.eventType=eventType;return jscape.API.getTriggerOrder(this.domainName,eventType);},this)).done($.proxy(function(order){this.triggers=order.triggers;var event=$.grep(operationContext.events,$.proxy(function(event){return event.type==this.eventType;},this));this._setupDialog(event.length?event[0].name:"",this.triggers).show(this);},this)).fail($.proxy(this._onCancel,this));return this.deferred.promise();},onTriggerUp:function(dialog,item){var index=$.inArray(item,this.triggers);if(index>0){this.triggers.splice(index-1,2,this.triggers[index],this.triggers[index-1]);dialog.setTriggers(this.triggers);dialog.selectTrigger(item);}},onTriggerDown:function(dialog,item){var index=$.inArray(item,this.triggers);if(index!=-1&&index<this.triggers.length-1){this.triggers.splice(index,2,this.triggers[index+1],this.triggers[index]);dialog.setTriggers(this.triggers);dialog.selectTrigger(item);}},onSubmit:function(dialog){return jscape.API.setTriggerOrder(this.domainName,this.eventType,new jscape.TriggerOrder(this.eventType,this.triggers)).done($.proxy(function(order){this.deferred.resolve(order);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_selectTriggerEvent:function(events){var deferred=$.Deferred();var dialog=new jscape.domain.TriggerEventTypeDialog();dialog.setEvents(events);dialog.show({onSubmit:$.proxy(function(dialog){var event=dialog.getEvent();dialog.destroy();deferred.resolve(event?event.type:null);deferred=null;},this),onCancel:$.proxy(function(dialog){dialog.destroy();deferred.reject();deferred=null;},this)});return deferred.promise();},_setupDialog:function(event,triggers){var dialog=new jscape.domain.OrderTriggerDialog();dialog.setEvent(event);dialog.setTriggers(triggers);return dialog;}});jscape.domain.TriggerEventTypeDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-eventtype"),{width:"50%",minWidth:600,maxWidth:750,minHeight:260});this.event=$("select[name=event]",this.fieldset);this.event.combobox({required:true,editable:true,limitToList:true,textField:"name",valueField:"type",formatter:function(row){return'<span title="'+String(row.description||"").escapeXml()+'">'+String(row.name||"").escapeXml()+'</span>';},onChange:$.proxy(this._adjustEventHelp,this),width:310});this.eventHelp=this.fieldset.find("#"+this.event.attr("aria-describedby")).tooltip({position:"right",showDelay:0});},getEvent:function(){var value=this.event.combobox("getValue");var events=$.grep(this.event.combobox("getData"),function(event){return event.type==value;});return events.length?events[0]:null;},setEvents:function(values){this.event.combobox("loadData",values);},show:function(listener){this._super(listener);this._adjustEventHelp();},_adjustEventHelp:function(){var event=this.getEvent();this.eventHelp.tooltip("update",event?event.description:"");}});jscape.domain.OrderTriggerDialog=jscape.ui.DefaultDialog.extend({selection:null,initialize:function(){this.selection=[];var initializing=true;this._super($("#d-triggers-order"),{width:"50%",minWidth:550,maxWidth:750,minHeight:600});this.event=$("input[name=eventtype]",this.fieldset).textbox({readonly:true,width:"75%"});this.data=$("table[role=grid][aria-label=triggersorder]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:true,sortOrder:"asc",idField:"value",textField:"text",valueField:"value",columns:[[{field:"text",title:$("thead th:nth-child(1)",this.data).text(),sortable:false,width:"100%"}]],onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustButtonsState,this),loadFilter:function(data){return $.map(data,function(val){return{text:!!val?String(val).escapeXml():"",value:val};});}});this.moveUpButton=$("a[role=button][name=moveup]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveUpButton,this)});this.moveDownButton=$("a[role=button][name=movedown]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveDownButton,this)});initializing=false;},setEvent:function(value){this.event.textbox("setValue",value);},setTriggers:function(values){this.data.datagrid("loading").datagrid("loadData",values).datagrid("loaded");},selectTrigger:function(value){this.data.datagrid("selectRecord",value);},show:function(listener){this._super(listener||jscape.domain.OrderTriggerDialog.LISTENER);this._adjustButtonsState();},_onClick$MoveUpButton:function(){var trigger=this.selection[0][this.data.datagrid("options").valueField];this.listener.onTriggerUp(this,trigger);},_onClick$MoveDownButton:function(){var trigger=this.selection[0][this.data.datagrid("options").valueField];this.listener.onTriggerDown(this,trigger);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var rows=this.data.datagrid("getRows");var index=this.selection.length==1?$.inArray(this.selection[0],rows):-1;this.moveUpButton.linkbutton(index>0&&index<=rows.length-1?"enable":"disable");this.moveDownButton.linkbutton(index>=0&&index<rows.length-1?"enable":"disable");}});jscape.domain.OrderTriggerDialog.LISTENER={onTriggerUp:$.noop,onTriggerDown:$.noop};jscape.domain.CopyTriggerController=Class.extend({deferred:null,start:function(domainName,trigger){this.domainName=domainName;this.triggerName=trigger.name;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var editAfterDone=dialog.isEditAfterDone();return jscape.API.copyTrigger(this.domainName,this.triggerName,dialog.getName()).done($.proxy(function(trigger){this.deferred.resolve(trigger,editAfterDone);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.CopyTriggerDialog();dialog.setTitle(this.triggerName);dialog.setName("Copy - "+this.triggerName);dialog.setEditAfterDone(true);return dialog;}});jscape.domain.CopyTriggerDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-copy"),{width:"40%",minWidth:500,minHeight:260,resizable:false});this.title=this.dialog.dialog("header").text()||"";this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["trigger_unique","non_empty"],missingMessage:window.R.string.TRIGGERS_ERROR_BAD_TRIGGER_NAME,invalidMessage:window.R.string.TRIGGERS_ERROR_BAD_TRIGGER_NAME,width:"60%"});this.editAfterDone=$("input[name=editafterdone]:checkbox",this.fieldset);},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value).textbox("textbox").select();this.setTitle(this.title.supplant({0:(""+value).escapeXml()}));},isEditAfterDone:function(){return this.editAfterDone.is(":checked");},setEditAfterDone:function(value){this.editAfterDone.prop("checked",!!value);}});jscape.domain.RunTriggerController=Class.extend({deferred:null,start:function(domainName,triggerNames,runWithData){this.domainName=domainName;this.deferred=$.Deferred();if(!runWithData){this._confirmRunAction(triggerNames).then($.proxy(function(){return this._runTriggers(triggerNames);},this)).catch($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}else{this._requestRunData().then($.proxy(function(data){return this._runTriggers(triggerNames,data);},this)).catch($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},_requestRunData:function(){var deferred=$.Deferred();new jscape.domain.RunTriggerDialog().show({onSubmit:function(dialog){var data=dialog.getData();dialog.destroy();deferred.resolve(data);},onCancel:function(dialog){dialog.destroy();deferred.reject();}});return deferred.promise();},_confirmRunAction:function(names){return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_RUN_TITLE,window.R.string.TRIGGERS_CONFIRM_RUN_MESSAGE);},_runTriggers:function(names,runData){return $.when.apply(jQuery,$.map(names,$.proxy(function(name){return jscape.API.runTrigger(this.domainName,name,runData);},this))).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));}});jscape.domain.RunTriggerDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-run"),{width:"50%",minWidth:550,maxWidth:750,minHeight:600});this.data=$("table[role=grid][aria-label=runparameteres]",this.fieldset);this.data.propertygrid({fit:true,toolbar:[{iconCls:"icon-add",handler:$.proxy(this._onClick$AddRow,this)},{iconCls:"icon-remove",handler:$.proxy(this._onClick$RemoveRow,this)}],columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"50%"},{field:"value",title:$("thead th:nth-child(2)",this.data).text(),resizable:false,width:"45%"}]],onDblClickRow:function(index){$(this).propertygrid("beginEdit",index);},onBeginEdit:function(index){var pg=$(this);var ed=pg.propertygrid("getEditor",{index:index,field:"value"});var input;if($(ed.target).data("textbox")){input=$(ed.target).textbox("textbox");}else if($(ed.target).data("numberbox")){input=$(ed.target).numberbox("textbox");}
input&&input.on("keydown",function(e){if(e.keyCode==13){pg.propertygrid("endEdit",index);}}).focus();}});},show:function(listener){this._super(listener);this._onChange$Data();},getData:function(){this.data.datagrid("acceptChanges");var data={};$.each(this.data.datagrid("getRows"),function(_,row){data[row.name]=row.value;});return data;},_valid:function(){return this._super()&&this._changed();},_onClick$AddRow:function(){this._showPromptDialog().done($.proxy(function(data){var row=this._createInputField(data);this.data.propertygrid("appendRow",row);this.data.propertygrid("selectRow",this.data.propertygrid("getRowIndex",row));this._onChange$Data();},this));},_createInputField:function(data){switch(data.type){case"int":return this._createNumberInput(data.name,{value:0});case"boolean":return this._createBooleanInput(data.name,{value:true});default:return this._createStringInput(data.name,{value:""});}},_createNumberInput:function(name,opts){return $.extend({},opts||{},{name:name,editor:{type:"numberbox",options:{required:true}}});},_createStringInput:function(name,opts){return $.extend({},opts||{},{name:name,editor:{type:"textbox"}});},_createBooleanInput:function(name,opts){return $.extend({},opts||{},{name:name,editor:{type:"combobox",options:{editable:false,multivalue:false,limitToList:true,data:[{text:"true",value:true},{text:"false",value:false}],panelHeight:"auto"}}});},_showPromptDialog:function(){var deferred=$.Deferred();var name,type;var dialog=$.messager.prompt({title:"",content:"<div>Enter a new variable</div><br/>"
+"<div class='messager-input'> <input type='text' aria-label='name' placeholder='variable name' class='messager-input' style='width:65%;padding-left:.6em;outline-style:none;border-color:transparent'/>"
+"<select aria-label='type' style='outline-style:none;border-color:transparent'>"
+"<option value='string'>String</option>"
+"<option value='int'>Integer</option>"
+"<option value='boolean'>Boolean</option>"
+"</select></div>",buttons:[{text:$.messager.defaults.ok,onClick:function(){dialog.dialog("options").fn.call(this);dialog.dialog("close");}},{text:$.messager.defaults.cancel,onClick:function(){name=type=null;dialog.dialog("close");}}],fn:function(){name=dialog.find("input[aria-label=name]").val();type=dialog.find("select[aria-label=type]").val();},onDestroy:function(){if(name&&name.trim().length){deferred.resolve({name:name,type:type});}else{deferred.reject();}
name=type=deferred=null;}});dialog.find(":input:first").focus();return deferred.promise();},_changed:function(){return this.data.propertygrid("getChanges").length!=0;},_onChange$Data:function(){this.okButton.linkbutton(this._changed()?"enable":"disable");},_onClick$RemoveRow:function(){var index=-1;var rows=[].concat(this.data.propertygrid("getSelections"));while(rows.length){index=this.data.propertygrid("getRowIndex",rows.pop());this.data.propertygrid("deleteRow",index);}
index=Math.min(Math.max(0,index),this.data.propertygrid("getRows").length-1);if(index>=0){this.data.propertygrid("selectRow",index);}
this._onChange$Data();}});jscape.domain.DeleteTriggerController=Class.extend({deferred:null,start:function(domainName,triggers){this.domainName=domainName;this.deferred=$.Deferred();this._confirmDelete(triggers).done($.proxy(this._deleteConfirmed,this,triggers)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(triggers){var text=$.map(triggers,function(trigger){return trigger.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_DELETE_TITLE,window.R.string.TRIGGERS_CONFIRM_DELETE_MESSAGE.supplant({0:text}),undefined,{maxHeight:"50%"});},_deleteConfirmed:function(triggers){$.when.apply(jQuery,$.map(triggers,$.proxy(function(trigger){return jscape.API.deleteTrigger(this.domainName,trigger.name);},this))).done($.proxy(function(){this.deferred.resolve(triggers);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});jscape.domain.ImportTriggerController=jscape.ui.DefaultImportController.extend({deferred:null,start:function(domainName,data){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog(data).show(this);return this.deferred.promise();},onSubmit:function(dialog){var file=this.file?this.file:dialog.getFile();return jscape.API.importTriggers(this.domainName,file,dialog.isOverwrite()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;this._showSuccessMessage();},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(data){var d=new jscape.domain.ImportTriggerDialog();this._listFileEntries(data,"file").done($.proxy(function(files){if(files&&files.length){this.file=files[0];d.setFilename(this.file.name);d=undefined;}},this));return d;},_showSuccessMessage:function(){$(document).triggerHandler("broadcast",window.R.string.TRIGGERS_SUCCESS_IMPORT);}});jscape.domain.ImportTriggerDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-import"),{width:"50%",minWidth:500,maxWidth:750,minHeight:280});this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",validateOnBlur:true,width:"60%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getFile:function(){var files=!this.file.filebox("options").disabled?this.file.filebox("files"):null;return files&&files.length?files[0]:null;},setFilename:function(value){if(!!value){this.file.filebox("setText",value).filebox("disable");}},isOverwrite:function(){return this.overwrite.is(":checked");}});jscape.domain.ExportTriggerController=Class.extend({deferred:null,start:function(domainName,names){this.domainName=domainName;this.triggerNames=names;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportTriggers(this.domainName,this.triggerNames,dialog.getFilename(),dialog.isExcludePassword()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.ExportTriggersDialog();dialog.setFilename("triggers.txt");dialog.setExcludePassword(true);return dialog;}});jscape.domain.ExportTriggersDialog=jscape.ui.ExportDialog.extend({initialize:function(){this._super($("#d-triggers-export"),{width:"50%",minWidth:600,maxWidth:750,minHeight:280});this.excludePassword=$("input[name=excludepwd]:checkbox",this.dialog);},isExcludePassword:function(){return this.excludePassword.is(":checked");},setExcludePassword:function(value){this.excludePassword.prop("checked",!!value).change();}});jscape.domain.PromoteTriggerController=Class.extend({DEFAULT_PORT:10880,deferred:null,start:function(domainName,names){this.domainName=domainName;this.triggerNames=names||[];this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.promoteTriggers(this.domainName,this._createData(dialog)).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return{names:this.triggerNames,host:dialog.getHost(),port:dialog.getPort(),username:dialog.getUsername(),password:dialog.getPassword(),domain:dialog.getDomain(),overwrite:dialog.isOverwrite()};},_setupDialog:function(){var dialog=new jscape.domain.PromoteTriggerDialog();dialog.setDomain(this.domainName);dialog.setPort(this.DEFAULT_PORT);return dialog;}});jscape.domain.PromoteTriggerDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-promote"),{width:"50%",minWidth:550,maxWidth:750,minHeight:400});this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"non_empty",width:"60%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,width:80});this.domain=$("input[name=domain]",this.fieldset).textbox({required:true,validType:"non_empty",validateOnBlur:true,width:"50%"});this.login=$("input[name=login]",this.fieldset).textbox({required:true,validType:"non_empty",validateOnBlur:true,width:"50%"});this.password=$("input[name=pwd]",this.fieldset).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getHost:function(){return this.host.textbox("getValue");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value));},getDomain:function(){return this.domain.textbox("getValue");},setDomain:function(value){this.domain.textbox("setValue",value);},getUsername:function(){return this.login.textbox("getValue");},getPassword:function(){return this.password.passwordbox("getValue");},isOverwrite:function(){return this.overwrite.is(":checked");}});jscape.domain.TriggerHistoryController=Class.extend({view:null,initialize:function(actions){this.actions=actions;this.clearController=new jscape.domain.ClearTriggerStatesController();this.deleteController=new jscape.domain.DeleteTriggerStatesController();this.viewController=new jscape.domain.ViewTriggerStateController(actions);this.pauseController=new jscape.domain.PauseTriggerController();this.resumeController=new jscape.domain.ResumeTriggerController();this.rerunController=new jscape.domain.RerunTriggerController();this.killController=new jscape.domain.KillTriggerController();},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.TriggersHistoryView(this.actions);}
this.view.show(this);},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},onSearchTriggerHistory:function(triggerName){this.view.search({query:triggerName,field:"triggerName",regexp:true,ignoreCase:true});},onLoadTriggerStates:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listTriggerStates(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onPurgeTriggerStates:function(states){return this.clearController.start(this.domainName,states).done($.proxy(function(){this.view.firstPage();},this));},onDeleteTriggerStates:function(states){return this.deleteController.start(this.domainName,states).done($.proxy(function(){this.view.refresh();},this));},onViewTriggerState:function(state){return this.viewController.start(this,this.domainName,state.id);},onEditTriggerAction:function(triggerName,actionId){$(document).triggerHandler("edit_trigger_action",[triggerName,actionId]);},onPauseTrigger:function(states){var ids=$.map(states,function(state){return state.id;});return this.pauseController.start(this.domainName,ids).done($.proxy(function(){this.view.refresh();},this));},onResumeTrigger:function(states){var ids=$.map(states,function(state){return state.id;});return this.resumeController.start(this.domainName,ids).done($.proxy(function(){this.view.refresh();},this));},onRerunTrigger:function(states){var ids=$.map(states,function(state){return state.id;});return this.rerunController.start(this.domainName,ids).done($.proxy(function(){this.view.refresh();},this));},onKillTrigger:function(states,killQueued){var ids=$.map(states,function(state){return state.id;});return this.killController.start(this.domainName,ids,killQueued).done($.proxy(function(){this.view.refresh();},this));}});jscape.domain.TriggersHistoryView=jscape.ui.DatagridView.extend({selection:null,initialize:function(actions){this.actions=actions||[];var initializing=true;this.fieldset=$("#domain-triggers-history-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=triggershistory]",this.fieldset);this.data.datagrid({fit:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"startTime",sortOrder:"desc",columns:[[{field:"eventId",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"12%"},{field:"triggerName",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"8%"},{field:"status",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"8%",formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleStatus,this),finder:{type:"combobox",options:{data:$.map(jscape.Trigger.Status.values(),$.proxy(function(value){return{text:this._formatStatus(value),value:value};},this)),panelHeight:"auto"}}},{field:"startTime",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"15%",align:"right",formatter:$.proxy(this._formatDate,this),sorter:function(a,b){return a<b?-1:a>b?1:0;},finder:{type:"datetimebox",options:{width:180}}},{field:"endTime",title:$("thead th:nth-child(5)",this.data).text(),width:"15%",align:"right",formatter:$.proxy(this._formatDate,this),finder:{type:"datetimebox",options:{width:180}}},{field:"runTime",title:$("thead th:nth-child(6)",this.data).text(),width:"10%",align:"right",searchable:false,formatter:$.proxy(function(_,rowData){return this._formatRuntime(rowData);},this)},{field:"action",title:$("thead th:nth-child(7)",this.data).text(),width:"16%",searchable:false,formatter:$.proxy(function(_,rowData){return this._formatAction(rowData,this.actions);},this)},{field:"file",title:$("thead th:nth-child(8)",this.data).text(),width:"16%",searchable:true,formatter:$.proxy(function(_,rowData){return String(rowData.filename||"").escapeXml();},this)}]],onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onDblClick$Row,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._onLoadSuccess$Data,this)});this.purgeButton=$("a[role=button][name=purge]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$PurgeButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.viewButton=$("a[role=button][name=view]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.pauseButton=$("a[role=button][name=pause]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PauseButton,this)});this.resumeButton=$("a[role=button][name=resume]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ResumeButton,this)});this.rerunButton=$("a[role=button][name=rerun]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$RerunButton,this)});this.killButton=$("a[role=button][name=kill]",this.fieldset).splitbutton({disabled:true,plain:false,menu:"#killqueuedmenu",onClick:$.proxy(this._onClick$KillButton,this)});var killButtonOpts=this.killButton.splitbutton("options");$(killButtonOpts.menu).menu({onClick:killButtonOpts.onClick});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.TriggersHistoryView.LISTENER;this._adjustButtonsState();},refresh:function(){this.data.datagrid("reload");},_formatDate:function(value){return $.isNumeric(value)&&value!=0?new Date(value).toLocaleString():"";},_formatRuntime:function(triggerState){var date=$.isNumeric(triggerState.endTime)&&triggerState.endTime>0?new Date(0,0,1,0,0,0,triggerState.runTime):null;return date!=null?new jscape.DateFormat((date.getHours()!=0?"{h} hr. ":"")
+(date.getMinutes()!=0?"{m} min. ":"")
+(date.getSeconds()!=0?"{s} sec. ":"")
+"{S} ms.").format(date):"";},_formatAction:function(triggerState,actions){var names=[];var executed=0;$.each(triggerState.actionStates,function(_,actionState){var status=actionState.status;if(jscape.ActionState.Status.RUNNING==status){names.push(jscape.domain.TriggersModule.actionDisplayNameOf(actionState.actionClass,actions));}else if(jscape.ActionState.Status.COMPLETED==status){executed++;}});return window.R.string.TRIGGERS_TEMPLATE_COLUMN_ACTION.supplant({0:names.join(", ").escapeXml(),1:executed,2:triggerState.actionStates.length});},_formatStatus:function(status){return window.R.string[("TRIGGERS_STATE_"+status).toUpperCase()]||"";},_styleStatus:function(status){switch(status){case jscape.Trigger.Status.COMPLETED:return"color:green;font-weight:600";case jscape.Trigger.Status.FAILED:return"color:red;font-weight:600";case jscape.Trigger.Status.CANCELLED:return"color:gray;font-weight:600";case jscape.Trigger.Status.SKIPPED:return"color:#FFEB3B;font-weight:600";case jscape.Trigger.Status.PAUSED:return"color:blue;font-weight:600";default:return"color:black";}},_onLoad$Data:function(params,success,error){this.listener.onLoadTriggerStates(params).then(success,error);},_onLoadSuccess$Data:function(){this._adjustButtonsState();this.data.datagrid("autoSizeColumn","triggerName");},_onDblClick$Row:function(index,row){if($.inArray(row,this.selection)==-1||this.selection.length>1){this.data.datagrid("unselectAll").datagrid("selectRow",index);}
this.viewButton.click();},_onClick$PurgeButton:function(){this.purgeButton.linkbutton("disable");this.listener.onPurgeTriggerStates(this.selection).always($.proxy(function(){this.purgeButton.linkbutton("enable");},this));},_onClick$DeleteButton:function(){this.deleteButton.linkbutton("disable");this.listener.onDeleteTriggerStates(this.selection).always($.proxy(function(){this.deleteButton.linkbutton("enable");},this));},_onClick$ViewButton:function(){this.listener.onViewTriggerState(this.selection[0]);},_onClick$PauseButton:function(){this.listener.onPauseTrigger(this.selection);},_onClick$ResumeButton:function(){this.listener.onResumeTrigger(this.selection);},_onClick$RerunButton:function(){this.listener.onRerunTrigger(this.selection);},_onClick$KillButton:function(item){var killQueued=item&&"kill-queued"==item.name;this.killButton.splitbutton("disable");this.listener.onKillTrigger(this.selection,killQueued).always($.proxy(function(){this.killButton.splitbutton("enable");},this));},_showContextMenu:function(e){var killButtonOpts=this.killButton.splitbutton("options");var killDisabled=!!killButtonOpts.disabled;this._super(e,[this.viewButton,this.rerunButton,this.deleteButton,"-",this.purgeButton,"-",this.pauseButton,this.resumeButton,{text:killButtonOpts.text,disabled:killDisabled,submenu:[{text:killButtonOpts.text,disabled:killDisabled,handler:$.proxy(this._onClick$KillButton,this)},{text:"Kill Queued",disabled:killDisabled,handler:$.proxy(this._onClick$KillButton,this,{name:"kill-queued"})}]}]);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var state=this.selection.length==1?this.selection[0]:null;var canPause=this.selection.length!=0&&$.grep(this.selection,function(state){return state.status==jscape.Trigger.Status.RUNNING;}).length==this.selection.length;var canResume=this.selection.length!=0&&$.grep(this.selection,function(state){return state.status==jscape.Trigger.Status.PAUSED;}).length==this.selection.length;var canKill=this.selection.length!=0&&$.grep(this.selection,function(state){return state.status==jscape.Trigger.Status.QUEUED||state.status==jscape.Trigger.Status.RUNNING||state.status==jscape.Trigger.Status.PAUSED;}).length==this.selection.length;var canRerun=this.selection.length!=0&&$.grep(this.selection,function(state){return state.status==jscape.Trigger.Status.COMPLETED||state.status==jscape.Trigger.Status.CANCELLED||state.status==jscape.Trigger.Status.FAILED;}).length==this.selection.length;this.viewButton.linkbutton(this.selection.length==1&&this.selection[0]?"enable":"disable");this.deleteButton.linkbutton(this.selection.length>0?"enable":"disable");this.pauseButton.linkbutton(canPause?"enable":"disable");this.resumeButton.linkbutton(canResume?"enable":"disable");this.killButton.linkbutton(canKill?"enable":"disable");this.rerunButton.linkbutton(canRerun?"enable":"disable");}});jscape.domain.TriggersHistoryView.LISTENER={onLoadTriggerStates:$.noop,onPurgeTriggerStates:$.noop,onDeleteTriggerStates:$.noop,onViewTriggerState:$.noop,onPauseTrigger:$.noop,onResumeTrigger:$.noop,onRerunTrigger:$.noop,onKillTrigger:$.noop};jscape.domain.ClearTriggerStatesController=Class.extend({deferred:null,start:function(domainName,states){this.domainName=domainName;this.states=states
this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){let idList=this.states?.map(state=>state.id)||null;return jscape.API.clearTriggerStates(this.domainName,dialog.getExpirationPeriod(),idList).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.domain.ClearTriggerStatesDialog();}});jscape.domain.DeleteTriggerStatesController=Class.extend({start:function(domainName,states){return this._confirmDelete(states).then($.proxy(this._deleteConfirmed,this,domainName,states)).then(function(){return states;});},_confirmDelete:function(states){return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_DELETE_STATE_TITLE,window.R.string.TRIGGERS_CONFIRM_DELETE_STATE_MESSAGE);},_deleteConfirmed:function(domainName,states){return $.when.apply(jQuery,$.map(states,function(state){return jscape.API.deleteTriggerState(domainName,state.id);}));}});jscape.domain.ClearTriggerStatesDialog=jscape.ui.DefaultDialog.extend({TIME_FACTOR:24*60*60*1000,initialize:function(){this._super($("#d-trigger-state-clear"),{width:"50%",resizable:false});this.fieldset=$("fieldset[name=cleartriggerstatefields]",this.dialog);this.period=$("input[name=period]",this.fieldset).numberspinner({required:true,min:0,max:1000,value:7,width:80});},getExpirationPeriod:function(){return parseInt(this.period.numberspinner("getValue"))*this.TIME_FACTOR;}});jscape.domain.ViewTriggerStateController=Class.extend({deferred:null,initialize:function(actions){this.actions=actions||[];},start:function(listener,domainName,id){this.listener=listener||jscape.domain.ViewTriggerStateController.LISTENER;this.deferred=$.Deferred();var promise=this.deferred.promise();var dialog=new jscape.domain.TriggerStateDialog(this.actions);jscape.API.getTriggerState(domainName,id).done($.proxy(function(data){this.state=data;this._setupDialog(dialog,data).show(this);},this)).fail($.proxy(this._onCancel,this,dialog));return promise;},onLoadActionHistory:function(){return $.Deferred().resolve(this.state.actionStates).promise();},onLoadEventParameters:function(){return $.Deferred().resolve(this.state.eventParameters).promise();},onEditTriggerAction:function(dialog,actionId,force){var triggerName=this.state.triggerName;return this._confirmEditAction(force).done($.proxy(function(){this.listener.onEditTriggerAction(triggerName,actionId);this.onCancel(dialog);},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_confirmEditAction:function(force){if(!force===true){return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_STATE_CONFIRM_EDIT_ACTION_TITLE,window.R.string.TRIGGERS_STATE_CONFIRM_EDIT_ACTION_MESSAGE);}
return $.Deferred().resolve().promise();},_setupDialog:function(dialog,state){if(dialog&&state){dialog.setEventId(state.eventId);dialog.setEventType(jscape.domain.TriggersModule.displayClassNameOf(state.eventClassName));dialog.setTriggerName(state.triggerName);dialog.setStatus(state.status);dialog.setStartTime(state.startTime);dialog.setEndTime(state.endTime);}
return dialog;}});jscape.domain.ViewTriggerStateController.LISTENER={onEditTriggerAction:$.noop};jscape.domain.TriggerStateDialog=jscape.ui.DefaultDialog.extend({initialize:function(actions){this._super($("#d-trigger-recent"),{width:"80%",height:"90%",buttons:[{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}]});this.actions=actions||[];var initializing=true;this.fieldset=$("#"+this.idFor("d-trigger-recent-content")).layout({fit:true,doSize:false,border:false});this.fieldset.find(".content").layout({fit:true,doSize:false,border:true});this.eventId=$("code[aria-label=event-id]",this.fieldset);this.eventType=$("code[aria-label=event-type]",this.fieldset);this.triggerName=$("code[aria-label=trigger-name]",this.fieldset);this.status=$("code[aria-label=status]",this.fieldset);this.startTime=$("code[aria-label=start-time]",this.fieldset);this.endTime=$("code[aria-label=end-time]",this.fieldset);this.actionHistory=$("table[role=grid][aria-label=action-history]",this.fieldset);this.actionHistory.datagrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:true,columns:[[{field:"actionClass",title:$("thead th:nth-child(1)",this.actionHistory).text(),sortable:true,width:"21%",formatter:$.proxy(function(value,rowData){return this._formatAction(value,rowData,this.actions);},this)},{field:"status",title:$("thead th:nth-child(2)",this.actionHistory).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleActionStatus,this)},{field:"actionMessage",title:$("thead th:nth-child(3)",this.actionHistory).text(),sortable:false,width:"20%",formatter:$.proxy(function(value){return this._formatMessage(value);},this)},{field:"triggerErrorMessage",title:$("thead th:nth-child(4)",this.actionHistory).text(),sortable:false,width:"20%",formatter:$.proxy(function(value){return this._formatMessage(value);},this)},{field:"startTime",title:$("thead th:nth-child(5)",this.actionHistory).text(),sortable:true,width:"15%",align:"right",formatter:$.proxy(this._formatDate,this),sorter:this._timeComparator()},{field:"endTime",title:$("thead th:nth-child(6)",this.actionHistory).text(),sortable:true,width:"15%",align:"right",formatter:$.proxy(this._formatDate,this),sorter:this._timeComparator()}]],loader:$.proxy(this._onLoad$ActionHistory,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(function(){this._createEditActionButtons(this.actionHistory);this._createTooltips(this.actionHistory);},this),onDblClickRow:$.proxy(this._onEdit$TriggerAction,this),onRowContextMenu:$.proxy(this._onContextMenu$Event,this)});this.eventParameters=$("table[role=grid][aria-label=event-parameters]",this.fieldset);this.eventParameters.datagrid({fit:true,singleSelect:true,showGroup:true,remoteSort:false,sortName:"name",sortOrder:"asc",scrollbarSize:0,columns:[[{field:"name",title:"Name",width:"50%",sortable:true,formatter:$.proxy(this._formatEventParameterName,this),sorter:$.proxy(this._sortEventParameterName,this)},{field:"value",title:"Value",width:"50%",resizable:true,formatter:$.proxy(this._formatEventParameterValue,this)}]],loader:$.proxy(this._onLoad$EventParameters,this),loadFilter:$.proxy(this._filterEventParameters,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(function(){this._createHighlightActionButtons(this.eventParameters);this._createEventParameterValueTree(this.eventParameters);},this)});initializing=false;},show:function(listener){this._super(listener);this.actionHistory.datagrid("reload");this.eventParameters.datagrid("reload");},setEventId:function(value){this.eventId.text(value);},setEventType:function(value){this.eventType.text(value);},setTriggerName:function(value){this.triggerName.text(value);},setStatus:function(value){this.status.text(this._formatStatus(value)).css(this._styleTriggerStatus(value));},setStartTime:function(value){this.startTime.text(this._formatDate(value));},setEndTime:function(value){this.endTime.text(this._formatDate(value));},_timeComparator:function(){return function(a,b){return a<b?-1:a>b?1:0;}},_filterEventParameters:function(data){return $.map(data,$.proxy(function(value,key){return $.isPlainObject(value)?{name:key,value:value,collapsible:true}:{name:key,value:value};},this));},_onLoad$ActionHistory:function(params,success,error){this.listener.onLoadActionHistory(params).then(success,error);},_onLoad$EventParameters:function(params,success,error){this.listener.onLoadEventParameters(params).then(success,error);},_onEdit$TriggerAction:function(_,state,force){this.listener.onEditTriggerAction(this,state.actionId,force);},_onContextMenu$Event:function(e,index,row){e.preventDefault();var grid=this.actionHistory;if(row&&index>=0){if($.inArray(row,grid.datagrid("getSelections"))===-1){grid.datagrid("unselectAll").datagrid("selectRow",index);}
this._showContextMenu(e,[{text:window.R.string.TRIGGERS_STATE_CONFIRM_EDIT_ACTION_CONTEXT_MENU||"Edit Trigger Action",handler:$.proxy(this._onEdit$TriggerAction,this,e,row,true)}],grid);}},_formatAction:function(value,rowData,actions){return'<button name="editaction" class="link" title="{title}"><a href="#{id}" role="button">{name}</a></button>'.supplant({id:String(rowData.id).escapeXml(),name:jscape.domain.TriggersModule.actionDisplayNameOf(value,actions).escapeXml(),title:window.R.string.TRIGGERS_STATE_CONFIRM_EDIT_ACTION_CONTEXT_MENU});},_formatStatus:function(status){return window.R.string[("TRIGGERS_STATE_"+status).toUpperCase()]||"";},_styleActionStatus:function(status){switch(status){case jscape.ActionState.Status.COMPLETED:return"color:green";case jscape.ActionState.Status.FAILED:return"color:red";case jscape.ActionState.Status.CANCELLED:return"color:gray";case jscape.ActionState.Status.INTERRUPTED:return"color:blue";default:return"color:black";}},_styleTriggerStatus:function(status){switch(status){case jscape.Trigger.Status.COMPLETED:return{color:"green"};case jscape.Trigger.Status.FAILED:return{color:"red"};case jscape.Trigger.Status.CANCELLED:return{color:"gray"};case jscape.Trigger.Status.INTERRUPTED:return{color:"blue"};default:return{color:"black"};}},_formatDate:function(value){return $.isNumeric(value)&&value>0?new Date(value).toLocaleString():"";},_formatMessage:function(value){return'<span class="easyui-tooltip">'+String(value||"").escapeXml()+"</span>";},_formatEventParameterName:function(value){var parts=value.split(".");if(parts.length>1){return'<button name="selectaction" class="link" data-options="id:\'{id}\'"><a href="#action={id}" role="button">{id}</a>.{name}</button>'.supplant({id:String(parts[0]).escapeXml(),name:String(parts[1]).escapeXml()});}
return value;},_formatEventParameterValue:function(value,rowData){if(rowData.collapsible===true&&$.isPlainObject(value)){return'<ul class="easyui-tree">'
+(function _node(val,key){if($.isPlainObject(val)){return'<li data-options="iconCls:\'icon-none\',state:\'closed\'"><span>'+(!!key?key+": ":"")+JSON.stringify(val)+"</span>"
+"<ul>"+$.map(val,_node).join("")+"</ul>"
+"</li>";}
return"<li data-options=\"iconCls:'icon-none'\">"+key+": "+val+"</li>";})(value)
+"</ul>";}
return value;},_sortEventParameterName:function(a,b){var a1=(a||"").split(".");var b1=(b||"").split(".");if(a1.length>1||b1.length>1){return a1.length==b1.length?this._sortEventParameterName(a1[0],b1[0]):(a1.length>b1.length?1:-1);}
return a==b?0:(a>b?1:-1);},_onClick$EditActionButton:function(target){var row=$(target).closest(".datagrid-row");if(row.length){row.trigger(new $.Event("dblclick",{target:target}));}},_onClick$HighlightActionButton:function(actionId){var rows=this.actionHistory.datagrid("getRows");for(var i=0,len=rows.length;i<len;++i){var row=rows[i];if(row.actionId===actionId){var index=this.actionHistory.datagrid("getRowIndex",row);if(index!=-1){this.actionHistory.datagrid("unselectAll").datagrid("selectRow",index);}
break;}}},_createEditActionButtons:function(grid){grid.datagrid("getPanel").find("button[name=editaction]").each($.proxy(function(_,el){$(el).linkbutton({plain:true,onClick:$.proxy(this._onClick$EditActionButton,this,el)});},this));},_createHighlightActionButtons:function(grid){grid.datagrid("getPanel").find("button[name=selectaction]").each($.proxy(function(_,el){$(el).linkbutton({plain:true,onClick:$.proxy(function(){var id=$(el).linkbutton("options").id;this._onClick$HighlightActionButton(id);},this)});},this));},_createEventParameterValueTree:function(grid){grid.datagrid("getPanel").find(".easyui-tree").each(function(){$(this).tree({onBeforeSelect:function(){return false;},onClick:function(node){$(this).tree("toggle",node.target);}});});},_createTooltips:function(grid){grid.datagrid("getPanel").find(".easyui-tooltip").off(".triggerstatetip").on("mouseenter.triggerstatetip",function(){$(this).tooltip({showEvent:"none",position:"bottom",content:$(this).text(),onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");});}});jscape.domain.PauseTriggerController=Class.extend({start:function(domainName,states){this.domainName=domainName;return this._pauseTriggers(domainName,states);},_pauseTriggers:function(domainName,states){return $.when.apply(jQuery,$.map(states,$.proxy(function(state){return jscape.API.pauseTrigger(this.domainName,state);},this)));}});jscape.domain.ResumeTriggerController=Class.extend({start:function(domainName,states){this.domainName=domainName;return this._resumeTriggers(domainName,states);},_resumeTriggers:function(domainName,states){return $.when.apply(jQuery,$.map(states,$.proxy(function(state){return jscape.API.resumeTrigger(this.domainName,state);},this)));}});jscape.domain.RerunTriggerController=Class.extend({deferred:null,start:function(domainName,ids){this.domainName=domainName;this.ids=ids;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var rundData={restartAllActions:dialog.isRerunAllActions(),maintainEventDate:dialog.isMaintainVariables(),maintainGlobalVariables:dialog.isMaintainGlobalVariables()};return $.when.apply(jQuery,$.map(this.ids,$.proxy(function(id){return jscape.API.restartTrigger(this.domainName,id,rundData);},this))).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.RerunTriggerDialog();dialog.setRerunAllActions(true);return dialog;}});jscape.domain.RerunTriggerDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-rerun"),{width:"40%",minWidth:450,maxWidth:650,minHeight:450});this.restartMode=$("input[name=restartmode]:radio",this.fieldset);this.maintainVariables=$("input[name=maintainvars]:checkbox",this.fieldset);this.maintainGlobalVariables=$("input[name=maintainglobalvars]:checkbox",this.fieldset);},isRerunAllActions:function(){return/^all$/i.test(this.restartMode.filter(":checked").val());},setRerunAllActions:function(value){this.restartMode.filter("[value=all]").prop("checked",!!value).change();},isMaintainVariables:function(){return this.maintainVariables.is(":checked");},isMaintainGlobalVariables:function(){return this.maintainGlobalVariables.is(":checked");}});jscape.domain.KillTriggerController=Class.extend({deferred:null,start:function(domainName,states,killQueued=false){this.domainName=domainName;this.deferred=$.Deferred();if(killQueued){jscape.API.listTriggerStates(this.domainName,0,1,{field:"STATUS",query:"QUEUED"}).done($.proxy(this._showKillQueuedDialog,this)).fail($.proxy(this._handleError,this));}else{if(states.length>1){return this._confirmKill(states).then($.proxy(this._killConfirmed,this,domainName,states)).then(function(){return states;});}else{return $.when.apply(jQuery,$.map(states,$.proxy(function(state){return jscape.API.killTrigger(this.domainName,state);},this))).done($.proxy(this._handleSuccess,this)).fail($.proxy(this._handleError,this));}}
return this.deferred.promise();},_showKillQueuedDialog:function(response){var count=response.totalRecords||0;if(count===0){this._showNoQueuedTriggersDialog();}else{var dialog=this._setupDialog();var message=window.R.string.TRIGGERS_CONFIRM_KILL_QUEUED_MESSAGE.supplant({0:count});dialog.setMessage(message);dialog.show(this);}},_showNoQueuedTriggersDialog:function(){var dialog=new jscape.domain.NoQueuedTriggersDialog();dialog.show(window.R.string.TRIGGERS_NO_QUEUED_TRIGGERS_MESSAGE).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},_confirmKill:function(states){return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_KILL_TITLE,window.R.string.TRIGGERS_CONFIRM_KILL_MESSAGE);},_killConfirmed:function(domainName,states){return $.when.apply(jQuery,$.map(states,$.proxy(function(state){return jscape.API.killTrigger(this.domainName,state);},this)));},_handleSuccess:function(){this.deferred.resolve();this.deferred=null;},_handleError:function(){this.deferred.reject();this.deferred=null;},onSubmit:function(dialog){if(dialog.isConfirmed()){jscape.API.listTriggerStates(this.domainName,0,null,{field:"STATE",query:"QUEUED"}).then($.proxy(function(page){return $.when.apply(jQuery,$.map(page.records||[],$.proxy(function(state){return jscape.API.killTrigger(this.domainName,state.id);},this)));},this)).done($.proxy(this._handleSuccess,this)).fail($.proxy(this._handleError,this));}else{this.deferred.reject();this.deferred=null;}
dialog.destroy();},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.KillTriggerDialog();return dialog;}});jscape.domain.KillTriggerDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-kill-trigger"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=killtriggerfields]",this.dialog);this.message=$("div[name=killMessage]",this.fieldset);this.confirmation=$("input[name=confirmation]:checkbox",this.fieldset);this._setupConfirmationListener();},setMessage:function(message){this.message.text(message);},isConfirmed:function(){return this.confirmation.is(":checked");},show:function(listener){this._super(listener);this.confirmation.focus();this._updateOkButtonState();},_setupConfirmationListener:function(){this.confirmation.on('change',$.proxy(this._updateOkButtonState,this));},_updateOkButtonState:function(){if(this.isConfirmed()){this.okButton.linkbutton("enable");}else{this.okButton.linkbutton("disable");}}});jscape.domain.NoQueuedTriggersDialog=Class.extend({show:function(message){var deferred=$.Deferred();$.messager.alert({title:window.R.string.TRIGGERS_NO_QUEUED_TRIGGERS_TITLE,msg:message,icon:'info',fn:function(){deferred.resolve();}});return deferred.promise();}});jscape.domain.TriggerSettingsController=jscape.ui.DatagridController.extend({config:null,copy:null,variables:null,initialize:function(){this._initValidators();},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.TriggerSettingsView();}
this.view.show(this);},stop:function(){},pause:function(){},resume:function(){return jscape.API.getTriggerServiceConfiguration(this.domainName).done($.proxy(function(config){this.config=config;},this)).fail($.proxy(function(){this.config=this.DEFAULT_CONFIG;},this)).always($.proxy(function(){this.copy=this._copyConfiguration();this.variables=this._copyVariables(this.config);this._setupView(this.config,this.variables);},this));},hasChanged:function(){return this.copy&&!Object._equals(this.copy,this._createConfiguration());},onApply:function(){return jscape.API.setTriggerServiceConfiguration(this.domainName,this._createConfiguration()).done($.proxy(this._fireApplySuccess,this)).done($.proxy(function(config){this.config=config;this.copy=this._copyConfiguration();this.variables=this._copyVariables(this.config);this._setupView(this.config,this.variables);},this));},onDiscard:function(){this.config=this.copy;this.copy=this._copyConfiguration();this.variables=this._copyVariables(this.config);this._setupView(this.config,this.variables);},onAddVariable:function(){var dialog=new jscape.domain.AddGlobalVariableDialog();dialog.show({onSubmit:$.proxy(function(d){var name=d.getName();var value=d.getValue();d.destroy();this._variableAdded(name,value);},this),onCancel:function(d){d.destroy();}});},onDeleteVariable:function(name){jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_DELETE_VARIABLE_TITLE,window.R.string.TRIGGERS_CONFIRM_DELETE_VARIABLE_MESSAGE.supplant({0:name})).done($.proxy(this._variableDeleted,this,name));},onChangeVariable:function(name,value){for(var i=0;i<this.variables.length;i++){if(this.variables[i].name==name){this.variables[i].value=value;break;}}},_variableAdded:function(name,value){var variable={name:name,value:value};this.variables.push(variable);this.view.setVariables(this.variables);this.view.selectItem(variable);},_variableDeleted:function(name){var index=-1;for(var i=0;i<this.variables.length;i++){if(this.variables[i].name===name){index=i;break;}}
if(index!=-1){this.variables.splice(index,1);}
this.view.setVariables(this.variables);if(this.variables.length){index=Math.max(0,Math.min(index,this.variables.length-1));this.view.selectItem(this.variables[index]);}},_copyConfiguration:function(){return $.extend(new jscape.TriggerServiceConfiguration(),this.config);},_copyVariables:function(config){return $.map(config&&config.globalVariables||{},function(value,key){return{name:key,value:value};});},_createConfiguration:function(){var variables={};$.each(this.variables,function(_,entry){variables[entry.name]=entry.value;});return new jscape.TriggerServiceConfiguration(this.view.getMaxThreadCount(),this.view.getMaxEventQueueSize(),this.view.getMaxTransferCount(),this.view.getRecentTriggerExpirationPeriod(),variables);},_setupView:function(config,variables){if(config){this.view.setMaxThreadCount(config.maxThreadCount);this.view.setMaxEventQueueSize(config.maxEventQueueSize);this.view.setMaxTransferCount(config.maxTransferCount);this.view.setRecentTriggerExpirationPeriod(config.recentTriggerExpirationPeriodMillis);}
this.view.setVariables(variables);},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("triggers_variable_nonempty",window.R.string.TRIGGERS_ERROR_BAD_VARIABLE_NAME);v.rule("triggers_variable_unique",$.proxy(this._variableNotExists,this),window.R.string.TRIGGERS_ERROR_VARIABLE_EXISTS);},_variableNotExists:function(value){return $.grep(this.variables,function(entry){return entry.name==value;}).length==0;}});jscape.domain.TriggerSettingsView=Class.extend({TIME_FACTOR:24*60*60*1000,initialize:function(){this.fieldset=$("#triggers-settings-fields").layout({fit:true,doSize:false,border:false});this.fieldset.find(".content").layout({fit:true,doSize:false,border:false});this.limitTriggers=$("input[name=limittriggers]:checkbox",this.fieldset);this.limitTriggers.change($.proxy(function(){var enabled=this.limitTriggers.is(":checked");$.each([this.maxThreads,this.maxEventQueueSize],function(_,input){input.numberspinner(enabled?"enable":"disable").numberspinner(enabled?"enableValidation":"disableValidation");})},this));this.maxThreads=$("input[name=maxthreads]",this.fieldset);this.maxThreads.numberspinner({required:true,disabled:true,min:1,max:1000,value:50,width:70});this.maxEventQueueSize=$("input[name=triggersqueuesize]",this.fieldset);this.maxEventQueueSize.numberspinner({required:true,disabled:true,min:1,max:1000,value:100,width:70});this.limitTransfers=$("input[name=limittransfers]:checkbox",this.fieldset);this.limitTransfers.change($.proxy(function(){var enabled=this.limitTransfers.is(":checked");this.maxTransfers.numberspinner(enabled?"enable":"disable").numberspinner(enabled?"enableValidation":"disableValidation");},this));this.maxTransfers=$("input[name=maxtransfers]",this.fieldset);this.maxTransfers.numberspinner({required:true,disabled:true,min:1,max:1000,value:10,width:70});this.recentTriggerExpires=$("input[name=recenttriggerexpires]:checkbox",this.fieldset).change($.proxy(function(){var enabled=this.recentTriggerExpires.is(":checked");this.recentTriggerExpirationPeriod.numberspinner(enabled?"enable":"disable").numberspinner(enabled?"enableValidation":"disableValidation");},this));this.recentTriggerExpirationPeriod=$("input[name=recenttriggerexpiresperiod]",this.fieldset).numberspinner({required:true,min:0,max:100,value:0,width:80});this.variables=$("table[role=grid][aria-label=variables]",this.fieldset);this.variables.propertygrid({fit:true,fitColumns:true,onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onLoadSuccess:$.proxy(this._adjustButtonsState,this),onEndEdit:$.proxy(this._onAfterEdit,this),sortName:"name",sortOrder:"asc",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.variables).text(),sortable:true,width:100},{field:"value",title:$("thead th:nth-child(2)",this.variables).text(),width:100,resizable:false}]]});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});},show:function(listener){this.listener=listener||jscape.domain.TriggerSettingsView.LISTENER;this._adjustButtonsState();},getMaxThreadCount:function(){return this.limitTriggers.is(":checked")?parseInt(this.maxThreads.numberspinner("getValue")):null;},setMaxThreadCount:function(value){this.limitTriggers.prop("checked",value!=null).change();if(value!=null){this.maxThreads.numberspinner("setValue",parseInt(value));}},getMaxEventQueueSize:function(){return this.limitTriggers.is(":checked")?parseInt(this.maxEventQueueSize.numberspinner("getValue")):null;},setMaxEventQueueSize:function(value){if(value){this.maxEventQueueSize.numberspinner("setValue",parseInt(value));}},getMaxTransferCount:function(){return this.limitTransfers.is(":checked")?parseInt(this.maxTransfers.numberspinner("getValue")):null;},setMaxTransferCount:function(value){this.limitTransfers.prop("checked",value!=null).change();if(value!=null){this.maxTransfers.numberspinner("setValue",parseInt(value));}},getRecentTriggerExpirationPeriod:function(){return this.recentTriggerExpires.is(":checked")?parseInt(this.recentTriggerExpirationPeriod.numberspinner("getValue"))*this.TIME_FACTOR:null;},setRecentTriggerExpirationPeriod:function(value){if(value!=null){this.recentTriggerExpirationPeriod.numberspinner("setValue",parseInt(value)/this.TIME_FACTOR).numberspinner("validate");}
this.recentTriggerExpires.prop("checked",value!=null).change();},setVariables:function(values){var data=$.map(values||[],function(entry){return $.extend({editor:"text"},entry);});this.variables.propertygrid("loading").propertygrid("loadData",data).propertygrid("loaded");},selectItem:function(value){this.variables.propertygrid("selectRow",this.variables.propertygrid("getRowIndex",value));},_onClick$AddButton:function(){this.listener.onAddVariable();},_onClick$DeleteButton:function(){var name=this.variables.propertygrid("getSelected").name;this.listener.onDeleteVariable(name);},_onAfterEdit:function(index,data,changes){if(changes.value!==undefined){this.listener.onChangeVariable(data.name,changes.value);}},_onClick$ApplyButton:function(){this.variables.propertygrid("acceptChanges");if(this.fieldset.form("validate")){this.applyButton.linkbutton("disable");this.listener.onApply(this).always($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.variables.propertygrid("rejectChanges");this.listener.onDiscard();},_adjustButtonsState:function(){var selections=this.variables.propertygrid("getSelections");this.deleteButton.linkbutton(selections.length!=0?"enable":"disable");}});jscape.domain.TriggerSettingsView.LISTENER={onAddVariable:$.noop,onDeleteVariable:$.noop,onChangeVariable:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.AddGlobalVariableDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-addglobalvar"),{width:"50%",minHeight:260});this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["triggers_variable_nonempty","triggers_variable_unique"],missingMessage:window.R.string.TRIGGERS_ERROR_BAD_VARIABLE_NAME,width:"60%"});this.value=$("input[name=value]",this.fieldset).textbox({width:"60%"});},getName:function(){return this.name.textbox("getValue");},getValue:function(){return this.value.textbox("getValue");},_valid:function(){return this._super()&&this.dialog.dialog("options").disabled!==true;}});jscape.domain.RemoteTriggerSettingsController=jscape.ui.DatagridController.extend({DEFAULT_CONFIG:new jscape.RemoteTriggerServiceConfiguration(false,null,null,null,null,null,null,null,10000),config:null,copy:null,clientKeyProvider:null,initialize:function(){this.events=[];this.clientKeyController=new jscape.domain.ClientKeyController();this.testController=new jscape.domain.TestRemoteTriggerServiceController();this._initValidators();},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.RemoteTriggerSettingsView();}
this.view.show(this);this.view.refresh();},stop:function(){},pause:function(){},resume:function(){jscape.API.getRemoteTriggerServiceConfiguration(this.domainName).done($.proxy(function(config){this.config=config;},this)).fail($.proxy(function(){this.config=this.DEFAULT_CONFIG;},this)).always($.proxy(function(){this.clientKeyProvider=this.config.keyProvider;this.copy=this._copyConfiguration();this._setupView(this.config);},this));},hasChanged:function(){return this.copy&&!Object._equals(this.copy,this._createConfiguration());},onLoadEvents:function(){if(this.events&&this.events.length){return $.Deferred().resolve(this.events).promise();}
return jscape.API.getTriggerEvents(this.domainName).done($.proxy(function(events){this.events=events||[];},this));},onApply:function(){return jscape.API.setRemoteTriggerServiceConfiguration(this.domainName,this._createConfiguration()).done($.proxy(this._fireApplySuccess,this)).done($.proxy(function(config){this.config=config;this.copy=this._copyConfiguration();this._setupView(config);},this));},onDiscard:function(){this.config=this.copy;this.copy=this._copyConfiguration();this._setupView(this.config);},onTestRemoteServer:function(){return this.testController.start(this.domainName,this._createConfiguration());},onSelectClientKey:function(){this.clientKeyController.start(this.domainName,this.clientKeyProvider).done($.proxy(function(provider){this.clientKeyProvider=provider;},this));},_copyConfiguration:function(){return $.extend(new jscape.RemoteTriggerServiceConfiguration(),this.config);},_createConfiguration:function(){return new jscape.RemoteTriggerServiceConfiguration(this.view.isEnabled(),this.view.getBrokerUrl(),this.view.getQueueName(),this.view.getUsername(),this.view.getPassword(),this.clientKeyProvider,this.view.getHostKey()!=null?new jscape.ServerKeyProvider(this.view.getHostKey()):null,this.view.getSubscribedEvents(),this.view.getMaxQueueSize());},_setupView:function(config){if(config&&this.view){this.view.setEnabled(config.enabled);this.view.setBrokerUrl(config.brokerUrl);this.view.setQueueName(config.queueName);this.view.setUsername(config.username);this.view.setPassword(config.password);this.view.setMaxQueueSize(config.maxQueueSize);this.view.setSubscribedEvents(config.events);}
var hostKeyProvider=config?config.hostKeyProvider:null;jscape.API.getHostCertificates(this.domainName).then(function(certificates){return $.map(certificates,function(certificate){return certificate.name;});}).done($.proxy(function(keys){this.view.setHostKeys(keys);this.view.setHostKey(hostKeyProvider?hostKeyProvider.keyAlias:null);},this));},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("triggers_broker_url_nonempty",window.R.string.TRIGGERS_ERROR_BAD_BROKER_URL);v.nonEmptyRule("triggers_queue_name_nonempty",window.R.string.TRIGGERS_ERROR_BAD_QUEUE_NAME);}});jscape.domain.RemoteTriggerSettingsView=jscape.ui.FormView.extend({DEFAULT_MAX_QUEUE_SIZE:10000,initialize:function(){var initializing=true;this.fieldset=$("#triggers-remote-settings-fields").layout({fit:true,doSize:false,border:false});this.fieldset.find(".content").layout({fit:true,doSize:false,border:false});this.enabled=$("input[name=enabled]:checkbox",this.fieldset).change($.proxy(this._onChange$Enabled,this));this.brokerUrl=$("input[name=brokerurl]",this.fieldset).textbox({required:true,validType:"triggers_broker_url_nonempty",inputEvents:$.extend({},$.fn.textbox.defaults.inputEvents,{input:$.proxy(this._onInput$BrokerUrl,this)}),missingMessage:window.R.string.TRIGGERS_ERROR_BAD_BROKER_URL,invalidMessage:window.R.string.TRIGGERS_ERROR_BAD_BROKER_URL,width:"60%"});this.queueName=$("input[name=queuename]",this.fieldset).textbox({required:true,validType:"triggers_queue_name_nonempty",missingMessage:window.R.string.TRIGGERS_ERROR_BAD_QUEUE_NAME,invalidMessage:window.R.string.TRIGGERS_ERROR_BAD_QUEUE_NAME,width:"60%"});this.username=$("input[name=username]",this.fieldset).textbox({width:"40%"});this.password=$("input[name=password]",this.fieldset).textbox({type:"password",width:"40%"});this.maxQueueSize=$("input[name=queuesize]",this.fieldset).numberspinner({required:true,disabled:true,value:this.DEFAULT_MAX_QUEUE_SIZE,min:0,max:10000,width:120});this.useHostKey=$("input[name=usehostkey]:checkbox",this.fieldset).change($.proxy(function(){this.hostKey.combobox(this.useHostKey.is(":checked:not(:disabled)")?"enable":"disable");},this)).prop("disabled",true);this.hostKey=$("select[name=hostkey]",this.fieldset).combobox({editable:false,disabled:true,onLoadSuccess:$.proxy(function(data){this._adjustUseHostKeyFields();$.fn.combobox.defaults.onLoadSuccess.apply(this.hostKey,arguments);},this),width:170,panelHeight:"auto"});this.clientKeyButton=$("a[role=button][name=selectclientkey]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ClientKeyButton,this)});this.events=$("table[role=grid][aria-label=events]",this.fieldset);this.events.datagrid({fit:true,fitColumns:true,singleSelect:false,checkOnSelect:true,selectOnCheck:true,remoteSort:false,sortOrder:"asc",idField:"type",frozenColumns:[[{field:"_ck",checkbox:true}]],columns:[[{field:"name",title:$("thead th:nth-child(1)",this.events).text(),sortable:true,width:100},{field:"description",title:$("thead th:nth-child(2)",this.events).text(),sortable:true,width:200}]],onBeforeSelect:$.proxy(this.isEnabled,this),onBeforeCheck:$.proxy(this.isEnabled,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Events,this),onLoadSuccess:$.proxy(this._onLoadSuccess$Events,this)});this.testButton=$("a[role=button][name=testserver]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$TestButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._adjustButtonsBarLayout(this.fieldset);initializing=false;},show:function(listener){this.listener=listener||jscape.domain.RemoteTriggerSettingsView.LISTENER;this.enabled.change();},refresh:function(){this.events.datagrid("reload");},isEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getBrokerUrl:function(){return this.brokerUrl.textbox("getValue");},setBrokerUrl:function(value){this.brokerUrl.textbox("setValue",value);},getQueueName:function(){return this.queueName.textbox("getValue");},setQueueName:function(value){this.queueName.textbox("setValue",value);},getUsername:function(){return this.username.textbox("getValue");},setUsername:function(value){this.username.textbox("setValue",value);},getPassword:function(){return this.password.textbox("getValue");},setPassword:function(value){this.password.textbox("setValue",value);},getMaxQueueSize:function(){return parseInt(this.maxQueueSize.numberspinner("getValue"));},setMaxQueueSize:function(value){this.maxQueueSize.numberspinner("setValue",parseInt(value)||this.DEFAULT_MAX_QUEUE_SIZE);},setHostKeys:function(values){this.hostKey.combobox("loadData",values);},getHostKey:function(){return this.useHostKey.is(":checked:not(:disabled)")?this.hostKey.combobox("getValue"):null;},setHostKey:function(value){this.useHostKey.prop("checked",value!=null).change();if(value!=null){this.hostKey.combobox("select",value);}},getSubscribedEvents:function(){return this.isEnabled()?$.map(this.events.datagrid("getSelections"),function(event){return event.type||event;}):[];},setSubscribedEvents:function(values){this.events.datagrid("clearSelections");if(!this.loadingEvents){for(var i=0;i<values.length;i++){this.events.datagrid("selectRecord",values[i]);}}else{this.selectedEvents=values;}},_onLoad$Events:function(params,success,error){this.loadingEvents=true;this.listener.onLoadEvents(params).then(success,error).always($.proxy(function(){this.loadingEvents=false;var selection=this.selectedEvents;this.selectedEvents=null;!!selection&&this.setSubscribedEvents(selection);},this));},_onLoadSuccess$Events:function(){this._adjustRowSelectionState();this._onChange$Enabled();},_onClick$ClientKeyButton:function(){this.listener.onSelectClientKey(this);},_onClick$TestButton:function(){if(this.fieldset.form("validate")){this.testButton.linkbutton({iconCls:'icon-loading',disabled:true,__testing:true});this.listener.onTestRemoteServer(this).always($.proxy(function(){this.testButton.linkbutton({iconCls:'',disabled:false,__testing:false});this._adjustButtonsState();},this));}},_onClick$ApplyButton:function(){if(this.fieldset.form("validate")){this.applyButton.linkbutton("disable");this.listener.onApply(this).always($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onInput$BrokerUrl:function(e){var brokerUrl=$(e.data.target).textbox("textbox").val();this._adjustUseHostKeyFields(brokerUrl);},_adjustUseHostKeyFields:function(brokerUrl){var secureBroker=/^ssl:\/\/.*$/i.test(brokerUrl||this.brokerUrl.textbox("getValue"));var hasHostKeys=this.hostKey.combobox("getData").length!=0;this.useHostKey.prop("disabled",!(secureBroker&&hasHostKeys&&this.isEnabled())).change();if(this.isEnabled()&&!secureBroker){this.useHostKey.parent().tooltip({content:window.R.string.TRIGGERS_ERROR_BAD_BROKER_URL_SSL});}else{this.useHostKey.parent().tooltip("destroy");}},_adjustRowSelectionState:function(){if(!this.isEnabled()){this.events.datagrid("clearSelections");}
this.events.datagrid("getPanel").find("div.datagrid-header-check input:checkbox").prop("disabled",!this.isEnabled()||this.events.datagrid("getRows").length==0);},_onChange$Enabled:function(){var panel=this.events.datagrid("getPanel");if(this.isEnabled()){panel.children("div.datagrid-mask").remove();}else{if(!panel.children("div.datagrid-mask").length){$("<div class=\"datagrid-mask\" style=\"display:block\"></div>").appendTo(panel);}}
this._adjustFieldsState();},_adjustFieldsState:function(){var enabled=this.isEnabled();this.brokerUrl.textbox(enabled?"enable":"disable");this.queueName.textbox(enabled?"enable":"disable");this.username.textbox(enabled?"enable":"disable");this.password.textbox(enabled?"enable":"disable");this.maxQueueSize.numberspinner(enabled?"enable":"disable");this._adjustUseHostKeyFields();this._adjustRowSelectionState();this._adjustButtonsState();this.fieldset.form("validate");},_adjustButtonsState:function(){var enabled=this.isEnabled();this.clientKeyButton.linkbutton(enabled?"enable":"disable");this.testButton.linkbutton(enabled&&!this.testButton.linkbutton("options").__testing?"enable":"disable");}});jscape.domain.RemoteTriggerSettingsView.LISTENER={onLoadEvents:$.noop,onSelectClientKey:$.noop,onTestRemoteServer:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.TestRemoteTriggerServiceController=Class.extend({deferred:null,start:function(domainName,config){this.deferred=$.Deferred();var promise=this.deferred.promise();jscape.API.testRemoteTriggerServiceConfiguration(domainName,config).then($.proxy(this._testComplete,this),$.proxy(function(){this.deferred.reject();},this));return promise;},_testComplete:function(data){if(data&&data.valid===false){this._testFailed(data.message);}else{this._testPassed(data?data.message:"");}},_testPassed:function(message){$.messager.alert(window.R.string.TRIGGERS_TEST_REMOTE_SERVICE_TITLE,message||window.R.string.TRIGGERS_TEST_REMOTE_SERVICE_MESSAGE_PASSED,"info");this.deferred.resolve();},_testFailed:function(message){$.messager.alert(window.R.string.TRIGGERS_TEST_REMOTE_SERVICE_TITLE,message||window.R.string.TRIGGERS_TEST_REMOTE_SERVICE_MESSAGE_FAILED,"error");this.deferred.reject();}});jscape.domain.TriggerActionListController=Class.extend({initialize:function(actions){this.actions=actions||[];},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.ActionsView();}
this.view.show(this);},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},onLoadActions:function(){if(!!this.actions&&this.actions.length){return $.Deferred().resolve(this.actions).promise();}
return jscape.API.getTriggerActions(this.domainName).done($.proxy(function(actions){this.actions=actions||[];},this));}});jscape.domain.ActionsView=Class.extend({initialize:function(){var initializing=true;this.fieldset=$("#trigger-actions-content").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=triggeractionslist]",this.fieldset);this.data.treegrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:true,sortName:"name",idField:"id",treeField:"name",groupField:"group",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),formatter:$.proxy(this._formatName,this),styler:$.proxy(this._styleName,this),sortable:true,sorter:function(a,b){return a.localeCompare(b.toLocaleString());},width:"40%"},{field:"description",title:$("thead th:nth-child(2)",this.data).text(),formatter:$.proxy(this._formatDescription,this),width:"60%"}]],onContextMenu:function(e){e.preventDefault();},onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._createTooltips,this),loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onLoadFilter$Data,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.ActionsView.LISTENER;},refresh:function(){this.data.treegrid("reload");},_onLoad$Data:function(params,success,error){this.listener.onLoadActions(params).then(success,error);},_onLoadFilter$Data:function(data){var opts=this.data.treegrid("options");var rows=$.isArray(data)?data:data.rows||[];return this._groupByField(rows,opts.groupField,opts.treeField);},_groupByField:function(data,field,treeField){function _nodeOf(obj,id){return $.extend({iconCls:'icon-none',id:id},obj);}
data.sort(function(a,b){return String(a[field]||"").localeCompare(b[field]||"");});var tree=[];for(var i=0,groupIndex=0,lastGroup;i<data.length;++i){var node=data[i];var group=node[field];var id=""+(1E9*Math.random()>>>0);if(!!group){if(lastGroup!=group){lastGroup=group;groupIndex=tree.push(_nodeOf({children:[]},id+"-"+i))-1;tree[groupIndex][treeField]=group;}
tree[groupIndex].children.push(_nodeOf(node,id));}else{tree.push(_nodeOf(node,id));lastGroup=undefined;}}
return tree;},_formatName:function(val,node){return node?node.displayName||val:val;},_styleName:function(val,node){return node&&node.children&&node.children.length?"font-weight:bold":"";},_formatDescription:function(value,rowData){return!value?"":'<span class="easyui-tooltip" data-tooltip-title="'+String(rowData.name).escapeXml()+'" title="">'+String(value).escapeXml()+"</span>";},_createTooltips:function(){this.data.datagrid("getPanel").find(".easyui-tooltip").on("mouseenter",function(){$(this).tooltip({showEvent:"none",position:"bottom",content:"<div class=\"tooltip-title\"><code>"+$(this).data("tooltip-title")+"</code></div>"+$(this).text(),onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");});}});jscape.domain.ActionsView.LISTENER={onLoadActions:$.noop};jscape.domain.TriggerFunctionListController=Class.extend({initialize:function(functions){this.functions=[].concat(functions||[]);},start:function(){if(this.view==null){this.view=new jscape.domain.FunctionsView();}
this.view.show(this);},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},onLoadFunctions:function(){if(!!this.functions&&this.functions.length){return $.Deferred().resolve(this.functions).promise();}
return jscape.API.getTriggerFunctions(this.domainName).done($.proxy(function(functions){this.functions=functions||[];},this));}});jscape.domain.FunctionsView=Class.extend({initialize:function(){var initializing=true;this.fieldset=$("#trigger-functions-content").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=triggerfunctionslist]",this.fieldset);this.data.treegrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:true,sortName:"name",idField:"id",treeField:"name",groupField:"group",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),formatter:$.proxy(this._formatName,this),styler:$.proxy(this._styleName,this),sortable:true,sorter:function(a,b){return a.localeCompare(b.toLocaleString());},width:100},{field:"syntax",title:$("thead th:nth-child(2)",this.data).text(),width:150,formatter:$.proxy(this._formatSyntax,this)},{field:"description",title:$("thead th:nth-child(3)",this.data).text(),width:250,formatter:$.proxy(this._formatDescription,this)}]],onContextMenu:function(e){e.preventDefault();},onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._createTooltips,this),loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onLoadFilter$Data,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.FunctionsView.LISTENER;},refresh:function(){this.data.treegrid("reload");},_onLoad$Data:function(params,success,error){this.listener.onLoadFunctions(params).then(success,error);},_onLoadFilter$Data:function(data){var opts=this.data.treegrid("options");var rows=$.isArray(data)?data:data.rows||[];return this._groupByField(rows,opts.groupField,opts.treeField);},_groupByField:function(data,groupField,treeField){function _nodeOf(obj,id){return $.extend({iconCls:'icon-none',id:id},obj);}
data.sort(function(a,b){return String(a[groupField]||"").localeCompare(b[groupField]||"");});var tree=[];for(var i=0,groupIndex=0,lastGroup;i<data.length;++i){var node=data[i];var group=node[groupField];var id=""+(1E9*Math.random()>>>0);if(!!group){if(lastGroup!=group){lastGroup=group;groupIndex=tree.push(_nodeOf({children:[]},id))-1;tree[groupIndex][treeField]=group;}
tree[groupIndex].children.push(_nodeOf(node,id+"-"+i));}else{tree.push(_nodeOf(node,id));lastGroup=undefined;}}
return tree;},_formatName:function(name){return name.replace(/([a-z])([A-Z])/g,"$1 $2").escapeXml();},_styleName:function(val,node){return node&&node.children&&node.children.length?"font-weight:bold":"";},_formatSyntax:function(value,rowData){return $.map(rowData.templates,function(value,key){return"<code>"+String(key).escapeXml()+"</code>";}).join("<br/>")},_formatDescription:function(value,rowData){return $.map(rowData.templates,function(value,key){return'<span class="easyui-tooltip" data-tooltip-title="'+String(key).escapeXml()+'" title="">'+String(value).escapeXml()+"</span>";}).join("<br/>");},_createTooltips:function(){this.data.treegrid("getPanel").find(".easyui-tooltip").off(".triggerfunctiontip").on("mouseenter.triggerfunctiontip",function(){$(this).tooltip({showEvent:"none",position:"bottom",content:"<div class=\"tooltip-title\"><code>"+$(this).data("tooltip-title")+"</code></div>"+$(this).text(),onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");});}});jscape.domain.FunctionsView.LISTENER={onLoadFunctions:$.noop};