/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain.TriggerActionFlow=Class.extend({padding:{top:20,left:20},initialize:function(rootId){this.rootId=jscape.domain.TriggerActionFlow.isRootId(rootId)?rootId:"workflow"+(1E9*Math.random()>>>0);},onEvent:function(type,id){switch(type){case"link.create":this._onCreateLink.apply(this,Array.prototype.slice.call(arguments,1));break;case"link.delete":this._onDeleteLink(id);break;case"operator.create":this._onCreateOperator.apply(this,Array.prototype.slice.call(arguments,1));break;case"operator.delete":this._onDeleteOperator(id);break;case"operator.moved":this._onMoveOperator(id,Array.prototype.slice.call(arguments,1));break;case"operator.mouseover":this._onMouseOverOperator(id);break;case"operator.mouseout":this._onMouseOutOperator(id);break;}},getRootId:function(){return this.rootId;},_onCreateLink:function(id,data,view){data.color=this._formatLinkColor(data.fromOperator,data.fromConnector,view);},_onDeleteLink:function(id){},_onCreateOperator:function(id,data,el,view){if(this.rootId==id){$(el.operator).attr("id",id);data=this._positionRoot(data,el,view);this._formatRootTitle(id,data,el);}else{data=this._positionOperator(data,el,view);this._formatOperatorTitle(id,data,el,view);this._formatOperatorContent(id,data,el,view);}},_onDeleteOperator:function(id){this._deleteOperatorTooltip(id);},_onMoveOperator:function(id,position){},_onMouseOverOperator:function(id){},_onMouseOutOperator:function(id){},_positionRoot:function(data,el,view){data.top=200;data.left=140;return data;},_positionOperator:function(data,el,view){var selected=view.getSelectedOperatorId();if(data.id==selected){var parent=view.getOperatorPosition(selected);data.top=(parent.top||0)+this.padding.top;data.left=(parent.left||0)+this.padding.left;}else{var c=view.viewport();data.top=c.height()/2;data.left=c.width()/2;}
return data;},_formatRootTitle:function(id,data,el){this._createOperatorTooltip(id,data.title||$(el.title).text(),undefined,el);},_formatOperatorTitle:function(id,data,el,view){var title=data.title||$(el.title).text();var context=data.actionContext;this._createOperatorTooltip(id,title,context,el);this._createOperatorTools(id,data,el,view);},_formatOperatorContent:function(id,data,el){var context=data.actionContext;var inputs=el.connectors[jscape.domain.TriggerActionFlow.Connector.EXECUTE];var lbl=inputs&&inputs.length?$(inputs[0]).find(".flowchart-operator-connector-label"):null;if(lbl&&lbl.length){var text;if(jscape.domain.TriggerActionFlow.isConditionAction(context)){text=context.getParameter("Condition");}else if(jscape.domain.TriggerActionFlow.isIteratorAction(context)){text=context.getParameter("Items");}
if(!!text){lbl.text(" ("+text+") ");lbl.closest(".flowchart-operator-inputs").css({width:"100px",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"});lbl.tooltip({content:String(text).escapeXml(),onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},showDelay:0}).attr("id",id+"-lbl-tooltip");}}},_createOperatorTooltip:function(id,title,context,el){$(el.title).attr("title","").tooltip({trackMouse:true,content:"<div class=\"tooltip-title\"><code>{title}</code></div><div class=\"desc\">{description}{notes}</div>".supplant({title:String(title).escapeXml(),description:context?String(context.name||context.id).escapeXml():"",notes:context&&!!context.notes?"<div>"+String(context.notes).escapeXml()+"</div>":""}),onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");}}).attr("id",id+"-tooltip");},_deleteOperatorTooltip:function(id){$.each([$("#"+id+"-tooltip"),$("#"+id+"-lbl-tooltip")],function(_,t){t.length&&t.tooltip("destroy");});},_createOperatorTools:function(id,data,el){var title=$(el.title).css("position","relative");title.append('<div class="panel-tool">'
+'<a role="button" name="copy" href="javascript:;" class="icon-copy"></a>'
+'<a role="button" name="delete" href="javascript:;" class="panel-tool-close"></a>'
+'</div>');},_formatLinkColor:function(sourceId,sourceConnector,view){var context=view.getOperatorContext(sourceId);if(context&&(this._isConditionAction(context)||this._isIteratorAction(context))){return"green";}else if(jscape.domain.TriggerActionFlow.Connector.isStart(sourceConnector)||jscape.domain.TriggerActionFlow.Connector.isSuccess(sourceConnector)){return"green";}else if(jscape.domain.TriggerActionFlow.Connector.isFinish(sourceConnector)||jscape.domain.TriggerActionFlow.Connector.isFailure(sourceConnector)){return"red";}
return null;},_isConditionAction:function(actionContext){return jscape.domain.TriggerActionFlow.isConditionAction(actionContext);},_isIteratorAction:function(actionContext){return jscape.domain.TriggerActionFlow.isIteratorAction(actionContext);},hasOrphanActions:function(data){var found=false;var rootId=this.rootId;$.each(data.operators,function(operatorId){if(operatorId==rootId){return true;}
var hasParent=false;$.each(data.links,function(_,link){if(link.toOperator==operatorId&&link.toConnector==jscape.domain.TriggerActionFlow.Connector.EXECUTE){hasParent=true;return false;}});if(!hasParent){found=true;return false;}});return found;}});jscape.domain.TriggerActionFlow.Connector={START:"start",FINISH:"finish",SUCCESS:"success",FAILURE:"failure",EXECUTE:"execute",isStart:function(value){return/start/ig.test(value);},isFinish:function(value){return/finish/ig.test(value);},isSuccess:function(value){return/success/ig.test(value);},isFailure:function(value){return/failure/ig.test(value);}};jscape.domain.TriggerActionFlow.ACTIONS={CONDITION:"com.jscape.inet.mft.workflow.actions.IfAction",ITERATOR:"com.jscape.inet.mft.workflow.actions.ForEachAction"};jscape.domain.TriggerActionFlow.isRootId=function(value){return!!value&&/^workflow\d*$/i.test(value);};jscape.domain.TriggerActionFlow.isConditionAction=function(context){return context&&jscape.domain.TriggerActionFlow.ACTIONS.CONDITION===context.actionClass;};jscape.domain.TriggerActionFlow.isIteratorAction=function(context){return context&&jscape.domain.TriggerActionFlow.ACTIONS.ITERATOR===context.actionClass;};jscape.domain.TriggerActionsController=Class.extend({copy:null,rootId:null,initialize:function(view){this.view=view;this.addController=new jscape.domain.AddTriggerActionController();this.editController=new jscape.domain.EditTriggerActionController();this._initValidators();},start:function(domainName,trigger,operationContext){this.domainName=domainName;this.trigger=trigger;this.copy=trigger.clone();this.operationContext=operationContext;this.allowedActions=$.map(operationContext.actions,function(action){return action.actionClass;});this.eventType=null;this.variables=[];this.view.setListener(this);this.setupView(trigger);},hasChanged:function(dialog){return this._hasOrphanActions()||!Object._equals(this.copy.uiLayoutData,this.view.getLayoutData())||!Object._equals(this.copy,$.extend({},this.copy,this._createTriggerActionContext(this.rootId)));},pause:function(completed){!completed&&this.view.hide();this.updateTrigger(this.trigger);},resume:function(){this.view.show();this.setupView(this.trigger);},validate:function(){if(!this.trigger.name){return $.Deferred().resolve().promise();}
return this._confirmOrphanActions().then($.proxy(function(){var trigger=this.trigger.clone();this.updateTrigger(trigger);return jscape.API.validateTriggerActions(this.domainName,trigger.name,trigger).catch(function(r){return $.Deferred().reject($.extend({valid:false},(r&&r.responseJSON)||{}));});},this));},updateTrigger:function(trigger){if(!!this.flow){var rootId=this.flow.getRootId();var actionContext=this._createTriggerActionContext(rootId);$.extend(trigger,actionContext,{uiLayoutData:this.view.getLayoutData()});}},setupView:function(trigger){var eventType=trigger.eventType;if(!!this.loading||!eventType||this.eventType==eventType){return;}
this.loading=jscape.API.getTriggerEvent(this.domainName,eventType).done($.proxy(function(properties){this.loading=null;this.eventType=eventType;this.variables=this._propertiesToVariables(properties.concat(this.operationContext.properties));this.rootId=this._triggerActionFlowFor(trigger).getRootId();this.view.createWorkflow(this.rootId);this._traverseActionFlow(trigger.onStartActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.START);this._traverseActionFlow(trigger.onFinishActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.FINISH);this._traverseActionFlow(trigger.onSuccessActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.SUCCESS);this._traverseActionFlow(trigger.onFailureActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.FAILURE);this.view.setLayoutData(trigger.uiLayoutData);this.copy.uiLayoutData=$.extend(true,{},this.view.getLayoutData());},this)).fail($.proxy(function(){this.loading=null;},this));},onAddAction:function(actionClass){return this.addController.start(this.domainName,this.operationContext.actions,this.operationContext.functions,this.variables,this._operators2Links(this.view.getOperatorsData()),this.eventType,actionClass).then($.proxy(function(context){var title=jscape.domain.TriggersModule.actionDisplayNameOf(context.actionClass,this.operationContext.actions);this.view.addOperator(context.id,context,title);return $.Deferred().resolve(context.id).promise();},this));},onCopyAction:function(context){if(!this._isActionAllowed(context)){this._showOperationNotAllowed();return $.Deferred().reject().promise();}
return this._confirmCopyAction().then($.proxy(function(){return jscape.API.createTriggerActionContext(this.domainName,context.actionClass);},this)).then($.proxy(function(copy){$.each(context.getParameterNames(),function(_,name){if(!/password/ig.test(name)){copy.setParameter(name,context.getParameter(name));}});copy.notes=context.notes;var title=jscape.domain.TriggersModule.actionDisplayNameOf(context.actionClass,this.operationContext.actions);return $.Deferred().resolve(copy,title).promise();},this));},onCopyActionId:function(context){return new jscape.CopyToClipboardController().start(context.id);},onEditAction:function(context,title){if(!this._isActionAllowed(context)){this._showOperationNotAllowed();return $.Deferred().reject().promise();}
return this.editController.start(this.domainName,this.operationContext.actions,this.operationContext.functions,this.variables,this._operators2Links(this.view.getOperatorsData()),this.eventType,context,title);},onDeleteAction:function(context,title){if(!this._isActionAllowed(context)){this._showOperationNotAllowed();return $.Deferred().reject().promise();}
return this._confirmDeleteAction(title);},_confirmDeleteAction:function(action){return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_DELETE_ACTION_TITLE,window.R.string.TRIGGERS_CONFIRM_DELETE_ACTION_MESSAGE.supplant({0:action}));},_confirmOrphanActions:function(){return this._hasOrphanActions()?jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_ORPHAN_ACTION_TITLE,window.R.string.TRIGGERS_CONFIRM_ORPHAN_ACTION_MESSAGE):$.Deferred().resolve().promise();},_confirmCopyAction:function(){if(!!this.preventConfirmCopyAction){return $.Deferred().resolve().promise();}
return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_COPY_ACTION_TITLE,window.R.string.TRIGGERS_CONFIRM_COPY_ACTION_MESSAGE,true,undefined,true).then($.proxy(function(_,preventConfirmation){this.preventConfirmCopyAction=!!preventConfirmation},this));},_showOperationNotAllowed:function(){return $.messager.alert(window.R.string.APPLICATION_TITLE,window.R.string.NO_PERMISSIONS,"error");},_hasOrphanActions:function(){return!!this.flow&&this.flow.hasOrphanActions(this.view.getData());},_triggerActionFlowFor:function(trigger){if(!!this.flow){this.view.unsubscribe(this.flow);}
if(!this.flow){this.flow=new jscape.domain.TriggerActionFlow(this._rootIdForLayout((trigger?trigger.uiLayoutData:{})));}
this.view.subscribe(this.flow);return this.flow;},_traverseActionFlow:function(actionContexts,parentId,parentConnector){$.each(actionContexts||[],$.proxy(function(_,context){var id=context.id;if(!this.view.containsOperator(id)){this.view.addOperator(id,context,jscape.domain.TriggersModule.actionDisplayNameOf(context.actionClass,this.operationContext.actions));this.view.setOperatorEnabled(id,this._isActionAllowed(context));this.view.addLink(parentId,parentConnector,id,jscape.domain.TriggerActionFlow.Connector.EXECUTE);}
this._traverseActionFlow(context.onSuccessActions,id,jscape.domain.TriggerActionFlow.Connector.SUCCESS);this._traverseActionFlow(context.onFailureActions,id,jscape.domain.TriggerActionFlow.Connector.FAILURE);},this));},_createTriggerActionContext:function(rootId){return{onStartActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.START,jscape.domain.TriggerActionFlow.Connector.EXECUTE),onFinishActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.FINISH,jscape.domain.TriggerActionFlow.Connector.EXECUTE),onSuccessActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.SUCCESS,jscape.domain.TriggerActionFlow.Connector.EXECUTE),onFailureActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.FAILURE,jscape.domain.TriggerActionFlow.Connector.EXECUTE)};},_actionContextFor:function(fromOperator,fromConnector,toConnector){return $.map(this.view.getLinksFrom(fromOperator,fromConnector,toConnector),$.proxy(function(link){if(link){var operatorId=link.toOperator;var context=this.view.getOperatorContext(operatorId);if(context){context.onSuccessActions=this._actionContextFor(operatorId,jscape.domain.TriggerActionFlow.Connector.SUCCESS,jscape.domain.TriggerActionFlow.Connector.EXECUTE);context.onFailureActions=this._actionContextFor(operatorId,jscape.domain.TriggerActionFlow.Connector.FAILURE,jscape.domain.TriggerActionFlow.Connector.EXECUTE);return context;}}
return null;},this));},_isActionAllowed:function(context){return context&&$.inArray(context.actionClass,this.allowedActions)!=-1;},_rootIdForLayout:function(data){var rootId=null;if(data&&data.layout){$.each(data.layout,function(id){if(jscape.domain.TriggerActionFlow.isRootId(id)){rootId=id;return false;}})}
return rootId;},_propertiesToVariables:function(props){return $.map(props,function(entry){return{value:entry.property,text:entry.property||"",title:entry.description||""};}).sort(function(a,b){return a.text.localeCompare(b.text);});},_operators2Links:function(operators){return $.map(operators,function(entry){return{value:entry.actionId,text:entry.title,description:entry.actionName===entry.actionId?entry.actionId:entry.actionName};});},_initValidators:function(){var v=new jscape.Validator();v.rule("trigger_action_name_unique",$.proxy(this._triggerActionNameNotExists,this));},_triggerActionNameNotExists:function(value,excludes){if(this.flow&&this.flow.getRootId()==value){return false;}
for(var i=0,data=this.view.getOperatorsData();i<data.length;++i){if(data[i].actionName==value||data[i].actionId==value){if(excludes==undefined){return false;}
return $.inArray(value,excludes)!=-1;}}
return true;}});jscape.domain.TriggerActionsView=jscape.ui.FormView.extend({FORM_CHANGE_EVENTS:["link_create","link_delete","operator_create","operator_data_change","operator_moved","operator_delete","zoom"],padding:{top:20,left:20,bottom:20,right:80},layoutData:null,subscribers:null,initialize:function(fieldset,dialog){this.layoutData={};this.subscribers=[];this.fieldset=fieldset;this.layout=fieldset.find(".content").layout({fit:true,border:false});this.canvas=$("div[aria-label=actions-workflow]",this.fieldset);this.canvas.flowchart({multipleLinksOnInput:false,multipleLinksOnOutput:true,onAfterChange:$.proxy(function(type){this._onAfterChange(type);},this),onOperatorCreate:$.proxy(function(id,data,el){this._publishOnChanged("operator.create",id,data,el);this._onOperator$Create(id,data,el);return true;},this),onLinkCreate:$.proxy(function(id,data){this._publishOnChanged("link.create",id,data);return true;},this),onOperatorDelete:$.proxy(function(id){this._publishOnChanged("operator.delete",id);this._onOperator$Delete(id);return true;},this),onLinkDelete:$.proxy(function(id){this._publishOnChanged("link.delete",id);return true;},this),onOperatorMouseOver:$.proxy(function(id){this._publishOnChanged("operator.mouseover",id);return true;},this),onOperatorMouseOut:$.proxy(function(id){this._publishOnChanged("operator.mouseout",id);return true;},this),onOperatorMoved:$.proxy(function(id,pos){this._onOperator$Moved(id,pos);},this),onOperatorDblClick:$.proxy(function(){this.editButton.click();},this),onOperatorSelect:$.proxy(function(id){this._adjustButtonsState(id,this.getSelectedLinkId());return true;},this),onOperatorUnselect:$.proxy(function(){this._adjustButtonsState(null,this.getSelectedLinkId());return true;},this),onLinkSelect:$.proxy(function(id){this._adjustButtonsState(this.getSelectedOperatorId(),id);return true;},this),onLinkUnselect:$.proxy(function(){this._adjustButtonsState(this.getSelectedOperatorId(),null);return true;},this)});var cp=this.canvas.parent().panel({fit:true,border:true,title:" ",onResize:$.proxy(this._onResize$Panel,this),tools:$("#chart-toolbar"+dialog.getIdSuffix())});var tb=cp.panel("header").find(".panel-tool").css({"height":"32px","top":0,"margin-top":0});var zb=tb.find(".panel-tool-a");this.zoomInButton=zb.filter("[role=button][name=chart-zoom-in]").linkbutton({plain:true,onClick:$.proxy(this._onClick$ZoomIn,this)});this.zoomOutButton=zb.filter("[role=button][name=chart-zoom-out]").linkbutton({plain:true,onClick:$.proxy(this._onClick$ZoomOut,this)});this.zoomScaleButton=zb.filter("[role=button][name=chart-zoom-scale]").linkbutton({plain:true,onClick:$.proxy(this._onClick$ZoomScale,this)});this.canvas.panzoom({minScale:0.25,maxScale:3,step:0.25}).on("panzoomchange",$.proxy(function(e){this._onChange$Zoom(e);this._onAfterChange("zoom");},this)).on("panzoomend panzoomzoom panzoomreset",$.proxy(function(e){this.canvas.flowchart("setPositionRatio",e.detail.scale);this._onChange$Layout();},this)).on("mousewheel.focal",$.proxy(function(e){this.canvas.panzoom("zoomWithWheel",e);},this)).on("contextmenu",$.proxy(this._onContextMenu$Event,this));this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddActionButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.copyButton=$("a[role=button][name=copy]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyButton,this)});this._adjustButtonsBarLayout(this.layout);},setListener:function(listener){this.listener=listener||jscape.domain.TriggerActionsView.LISTENER;},subscribe:function(entry){this.subscribers.push(entry);return this;},unsubscribe:function(entry){var index=$.inArray(entry,this.subscribers);if(index!=-1){this.subscribers.splice(index,1);}},show:function(){this.fieldset.show();this.layout.layout("resize");this.canvas.flowchart("redrawLinksLayer");this._bindEvents();},hide:function(){this._unbindEvents();},viewport:function(){return this.canvas.parent();},getOperatorsData:function(){var data=this.canvas.flowchart("getData");return $.map(data.operators,$.proxy(function(entry,id){return{id:id,title:this.canvas.flowchart("getOperatorTitle",id)||"",actionId:entry.actionContext?entry.actionContext.id:id,actionName:(entry.actionContext||{}).name};},this));},getData:function(){return this.canvas.flowchart("getData");},getLayoutData:function(){return this.layoutData;},setLayoutData:function(data){this.layoutData=data||{};try{if(this.layoutData.hasOwnProperty("layout")){this.arrangeActions(this.layoutData.layout,this.layoutData.scale,this.layoutData.pan);}else{this.arrangeActions();}}catch(e){this.arrangeActions();}},getOperatorContext:function(id){return this.canvas.flowchart("doesOperatorExists",id)?this.canvas.flowchart("getOperatorData",id).actionContext:null;},getOperatorPosition:function(id){var data=this.canvas.flowchart("getOperatorData",id);return{top:data.top||0,left:data.left||0};},getLinksFrom:function(sourceId,sourceConnector,targetConnector){return this.canvas.flowchart("getLinksFrom",sourceId,function(link){return link&&link.fromConnector==sourceConnector&&link.toConnector==targetConnector;});},getSelectedLinkId:function(){return this.canvas.flowchart("getSelectedLinkId");},getSelectedOperatorId:function(){return this.canvas.flowchart("getSelectedOperatorId");},selectOperator:function(id){if(this.canvas.flowchart("doesOperatorExists",id)){this.canvas.flowchart("selectOperator",id);return true;}
return false;},createWorkflow:function(id){if(!this.canvas.flowchart("doesOperatorExists",id)){this.canvas.flowchart("createOperator",id,{id:id,title:"Workflow",properties:{title:"Workflow",inputs:{},outputs:{start:{label:"Start",multipleLinks:true},finish:{label:"Finish",multipleLinks:true},success:{label:"Success",multipleLinks:true},failure:{label:"Failure",multipleLinks:true}}}});this.workflowId=id;}
return id;},containsOperator:function(id){return!!id&&this.canvas.flowchart("doesOperatorExists",id);},addOperator:function(id,context,title){var props;if(jscape.domain.TriggerActionFlow.isConditionAction(context)){props={inputs:{execute:{label:"Execute"}},outputs:{success:{label:"Then",multipleLinks:true},failure:{label:"Else",multipleLinks:true}}};}else if(jscape.domain.TriggerActionFlow.isIteratorAction(context)){props={inputs:{execute:{label:"Execute"}},outputs:{success:{label:"Cycle",multipleLinks:true},failure:{label:"End",multipleLinks:true}}}}else{props={inputs:{execute:{label:"Execute"}},outputs:{success:{label:"Success",multipleLinks:true},failure:{label:"Failure",multipleLinks:true}}}}
this.canvas.flowchart("createOperator",id,{id:id,actionContext:context,title:title,properties:$.extend(props,{title:title})});return true;},updateOperator:function(id,context){var data=this.canvas.flowchart("getOperatorData",id);if(data){data.actionContext=context;data.properties.notes=context.notes||"";this.canvas.flowchart("setOperatorData",id,data);}},deleteOperator:function(id){if(id!=null){this.canvas.flowchart("deleteOperator",id);}},isOperatorEnabled:function(id){var data=this.canvas.flowchart("getOperatorData",id);return data&&!data.disabled;},setOperatorEnabled:function(id,enabled){var data=this.canvas.flowchart("getOperatorData",id);if(data&&data.disabled===enabled){data.disabled=!enabled;this.canvas.flowchart("setOperatorData",data);}},addLink:function(sourceId,sourceConnector,targetId,targetConnector){return this.canvas.flowchart("addLink",{fromOperator:sourceId,fromConnector:sourceConnector,toOperator:targetId,toConnector:targetConnector});},deleteLink:function(id){if(id!=null){this.canvas.flowchart("deleteLink",id);}},setLinkColor:function(id,color){this.canvas.flowchart("setLinkMainColor",id,color);},arrangeActions:function(layout,scale,pan){if(layout){this.canvas.panzoom("reset",{animate:false});this.canvas.flowchart("redrawLinksLayer");$.each(layout,$.proxy(function(id,pos){this.canvas.flowchart("moveOperator",id,pos);},this));this.canvas.panzoom("zoom",scale||1);pan&&setTimeout($.proxy(function(p){this.canvas.panzoom("pan",p.x,p.y,{animate:false});},this,pan),50);}else{this.canvas.flowchart("redrawLinksLayer");}},_bindEvents:function(){this.canvas.panzoom("bind").panzoom("setOptions",{contain:"outside"});$(document).off(".trigger_actions").on("keydown.trigger_actions",$.proxy(this._onKey$Event,this));},_unbindEvents:function(){this.canvas.panzoom("destroy").panzoom("setOptions",{contain:null});$(document).off("keydown.trigger_actions");},_onKey$Event:function(e){if(!$(e.target).is(":input")){if(e.keyCode==45){e.stopPropagation();this.addButton.click();}else if(e.keyCode==46){e.stopPropagation();this.deleteButton.click();}}},_onContextMenu$Event:function(e){e.preventDefault();var target=$(e.target);var link=target.closest(".flowchart-link");if(link&&link.length){var linkId=link.data("link_id");this.canvas.flowchart("selectLink",linkId);this._showContextMenu(e,[{text:this.deleteButton.text(),handler:$.proxy(this._onClick$DeleteLinkButton,this,linkId)},"-",{text:window.R.string.TRIGGERS_CONTEXT_MENU_ALIGN_ACTIONS_TO_GRID,iconCls:!this.alignToGrid?"":"icon-ok",handler:$.proxy(this._onClick$AlignToGrid,this)},{text:this.zoomScaleButton.attr("aria-label"),handler:$.proxy(this._onClick$ZoomScale,this)}]);}else{var op=target.closest(".flowchart-operator");var operatorId=op&&op.length?op.data("operator_id"):null;var copyActionIdDisabled=!operatorId||jscape.domain.TriggerActionFlow.isRootId(operatorId);if(operatorId!=null){this.canvas.flowchart("selectOperator",operatorId);}else{this.canvas.flowchart("unselectOperator");}
var offset=this.canvas.parent().offset();var position={top:e.pageY-offset.top,left:e.pageX-offset.left};var addButtonOpts=this.addButton.linkbutton("options");this._showContextMenu(e,[{text:addButtonOpts.text,disabled:addButtonOpts.disabled,submenu:[{text:window.R.string.TRIGGERS_CONTEXT_MENU_ADD_ACTION,disabled:addButtonOpts.disabled,handler:$.proxy(this._onClick$AddActionButton,this,undefined,position)},{separator:true},{text:window.R.string.TRIGGERS_CONTEXT_MENU_ADD_IF_ACTION,handler:$.proxy(this._onClick$AddActionButton,this,jscape.domain.TriggerActionFlow.ACTIONS.CONDITION,position)},{text:window.R.string.TRIGGERS_CONTEXT_MENU_ADD_FOREACH_ACTION,handler:$.proxy(this._onClick$AddActionButton,this,jscape.domain.TriggerActionFlow.ACTIONS.ITERATOR,position)}]},this.editButton,this.deleteButton,"-",this.copyButton,{text:window.R.string.TRIGGERS_CONTEXT_MENU_COPY_ACTION_ID,disabled:copyActionIdDisabled,handler:$.proxy(this._onClick$CopyActionId,this,operatorId)},"-",{text:window.R.string.TRIGGERS_CONTEXT_MENU_ALIGN_ACTIONS_TO_GRID,iconCls:!this.alignToGrid?"":"icon-ok",handler:$.proxy(this._onClick$AlignToGrid,this)},{text:this.zoomScaleButton.attr("aria-label"),handler:$.proxy(this._onClick$ZoomScale,this)}]);}},_onChange$Zoom:function(e){var scale=parseFloat(e.detail.scale);var btn=this.zoomScaleButton;if(!isNaN(scale)&&btn.length){btn.linkbutton({text:(scale*100).toFixed()+"%"});}},_onClick$ZoomIn:function(){var scale=this.canvas.panzoom("getScale");var opts=this.canvas.panzoom("getOptions");var offset=this.canvas.parent().offset();this.canvas.panzoom("zoomToPoint",scale*Math.exp(opts.step),{clientX:offset.left,clientY:offset.top},{animate:true});},_onClick$ZoomOut:function(){var scale=this.canvas.panzoom("getScale");var opts=this.canvas.panzoom("getOptions");var offset=this.canvas.parent().offset();this.canvas.panzoom("zoomToPoint",scale*Math.exp(-1*opts.step),{clientX:offset.left,clientY:offset.top},{animate:true});},_onClick$ZoomScale:function(){this.canvas.panzoom("reset",{animate:false});},_onClick$AlignToGrid:function(){this.alignToGrid=!this.alignToGrid;if(this.alignToGrid){this.canvas.flowchart({grid:this.canvas.flowchart("calculateGridDimension")});}else{this.canvas.flowchart({grid:$.fn.flowchart.defaults.grid});}
this._alignToGrid();},_onClick$AddActionButton:function(actionClass,position){this._adjustButtonsState(undefined,undefined,true);this.listener.onAddAction(actionClass).done($.proxy(function(id){if(position&&position.top&&position.left){this.canvas.flowchart("moveOperator",id,position);this.selectOperator(id);}else{var selection=this.getSelectedOperatorId();this.selectOperator(id);this._arrangeRelativeTo(id,selection);}},this)).fail($.proxy(this._adjustButtonsState,this));},_onClick$CopyButton:function(id){id=typeof id==="string"?id:this.getSelectedOperatorId();this._adjustButtonsState(undefined,undefined,true);this.listener.onCopyAction(this.getOperatorContext(id)).then($.proxy(function(context,title){var copyId=context.id;this.addOperator(copyId,context,title);this.selectOperator(copyId);this._arrangeRelativeTo(copyId,id);},this),$.proxy(this._adjustButtonsState,this));},_onClick$CopyActionId:function(id){this.listener.onCopyActionId(this.getOperatorContext(id));},_onClick$EditButton:function(){var id=this.getSelectedOperatorId();var position=$.extend({},this.layoutData.layout?this.layoutData.layout[id]:{});this._adjustButtonsState(undefined,undefined,true);this.listener.onEditAction(this.getOperatorContext(id),this.canvas.flowchart("getOperatorTitle",id)).then($.proxy(function(context){this.updateOperator(id,context);this.canvas.flowchart("moveOperator",id,position);this.selectOperator(id);},this),$.proxy(this._adjustButtonsState,this));},_onClick$DeleteButton:function(){this._onClick$DeleteLinkButton(this.getSelectedLinkId());this._onClick$DeleteActionButton();},_onClick$DeleteLinkButton:function(id){this.deleteLink(id);},_onClick$DeleteActionButton:function(id){id=id||this.getSelectedOperatorId();if(id!=null){this._adjustButtonsState(undefined,undefined,true);this.listener.onDeleteAction(this.getOperatorContext(id),this.canvas.flowchart("getOperatorTitle",id)).done($.proxy(function(){this.deleteOperator(id);this._adjustButtonsState();},this)).fail($.proxy(this._adjustButtonsState,this,id));}},_onResize$Panel:function(width,height){this._adjustViewportDimension(width,height);},_onChange$Layout:function(){var scale=this._toFixed(this.canvas.panzoom("getScale"),2);var pan=this.canvas.panzoom("getPan");pan=$.extend(pan,{x:this._toFixed(pan.x,1),y:this._toFixed(pan.y,1)});$.extend(this.layoutData,{scale:scale||1,pan:pan||{}});},_onOperator$Create:function(id,data,el){var operator=$(el.operator);var toolbar=operator.find(".panel-tool").hide();var buttons=toolbar.find("[role=button]");buttons.filter("[name=copy]").attr("title",this.copyButton.text()).on("click",{id:id},$.proxy(function(e){e.stopPropagation();this._onClick$CopyButton(e.data.id);},this));buttons.filter("[name=delete]").attr("title",this.deleteButton.text()).on("click",{id:id},$.proxy(function(e){e.stopPropagation();this._onClick$DeleteActionButton(e.data.id);},this));operator.hover(function(){$(this).find(".panel-tool").show();},function(){$(this).find(".panel-tool").hide();});},_onOperator$Moved:function(id,position){if(!this.layoutData.layout){this.layoutData.layout={};}
if(!this.layoutData.layout[id]){this.layoutData.layout[id]={};}
$.extend(this.layoutData.layout[id],{top:this._toFixed(position.top),left:this._toFixed(position.left)});this._onChange$Layout();var scale=this.canvas.panzoom("getScale")||1;var width=Math.abs(Math.round(position.left/scale))+position.width;var height=Math.abs(Math.round(position.top/scale))+position.height;this._adjustViewportDimension(width,height);if(scale!==1){this.canvas.panzoom("zoom",scale,{animate:false});}},_onOperator$Delete:function(id){if(this.layoutData.layout&&this.layoutData.layout.hasOwnProperty(id)){delete this.layoutData.layout[id];}},_toFixed:function(value,digits){digits=Math.abs(parseInt(digits)||0);return Number(Math.round(value+"e"+digits)+"e-"+digits);},_showContextMenu:function(e,entries){var suffix=""+(1E9*Math.random()>>>0);var items=[];for(var i=0,len=entries.length;i<len;++i){var opts=this._contextMenuItemOptions(entries[i],suffix);if(opts.separator){if(items.length<=0||i>=len-1||items[items.length-1].separator){continue;}
items.push(opts);}
if(opts.handler||opts.submenu){items.push(opts);}}
if(items.length){var menu=$("<div></div>").appendTo($(e.target).closest(".panel-body")).menu({onHide:function(){var m=$(this);setTimeout(function(){m.menu("destroy");m=null;},100);}}).off(".triggeractions").on("contextmenu.triggeractions",function(e){e.preventDefault();});this._createContextMenu(menu,items).menu("show",{top:e.pageY||0,left:e.pageX||0});}},_createContextMenu:function(menu,items,parentId){$.each(items,$.proxy(function(_,opts){if(opts.handler||opts.separator){var itemId=parentId!==undefined?parentId:opts.id;var item=menu.menu("findItem",function(mi){return mi.id&&mi.id==itemId});if(parentId&&item&&item.target){menu.menu("appendItem",$.extend(opts,{parent:item.target}));}else{menu.menu("appendItem",opts);}}else if(opts.submenu){var id="_"+(1E9*Math.random()>>>0);menu.menu("appendItem",{id:id,text:opts.text,disabled:!!opts.disabled});this._createContextMenu(menu,opts.submenu,id);}},this));return menu;},_contextMenuItemOptions:function(data,suffix){if("-"===data){return{separator:true};}
if(typeof data==="object"&&data.hasOwnProperty("button")&&data.hasOwnProperty("submenu")){if(data.button.length&&data.submenu.length){var sm=data.submenu;var onClick=sm.menu("options").onClick;var subMenuItems=$.map(sm.children(".menu-item"),function(el){return $.extend({},sm.menu("getItem",el),{handler:function(e){var menu=$(e.target).closest(".menu");menu.length&&onClick.call(menu[0],menu.menu("getItem",this));}});});return $.extend(this._contextMenuItemOptions(data.button),{handler:null,submenu:subMenuItems});}
return{};}
if(data&&data.length&&$.data(data[0],"linkbutton")){var opts=data.linkbutton("options");var text=data.text()||opts.text;var id=text.toLowerCase().replace(/[^\w]/g,"")+(suffix||"");return{id:id,text:text,handler:opts.onClick,disabled:!!opts.disabled};}
return $.isPlainObject(data)?data:{};},_alignToGrid:function(operatorId){operatorId=!operatorId?this.getSelectedOperatorId():operatorId;var gridDimension=this.canvas.flowchart("calculateGridDimension");if(!operatorId||jscape.domain.TriggerActionFlow.isRootId(operatorId)){var operators=[].concat(this._traverseLeaf(jscape.domain.TriggerActionFlow.Connector.isStart,this.workflowId),this._traverseLeaf(jscape.domain.TriggerActionFlow.Connector.isFinish,this.workflowId),this._traverseLeaf(jscape.domain.TriggerActionFlow.Connector.isSuccess,this.workflowId),this._traverseLeaf(jscape.domain.TriggerActionFlow.Connector.isFailure,this.workflowId),this._findOrphanActions(this.getData(),this.workflowId));while(operators.length){operatorId=operators.shift();this.canvas.flowchart("alignToGrid",operatorId,$.proxy(this._traverseLeaf,this,jscape.domain.TriggerActionFlow.Connector.isSuccess),$.proxy(this._traverseLeaf,this,jscape.domain.TriggerActionFlow.Connector.isFailure),$.proxy(this._traverseParent,this),gridDimension);}}else{this.canvas.flowchart("alignToGrid",operatorId,$.proxy(this._traverseLeaf,this,jscape.domain.TriggerActionFlow.Connector.isSuccess),$.proxy(this._traverseLeaf,this,jscape.domain.TriggerActionFlow.Connector.isFailure),$.proxy(this._traverseParent,this),gridDimension);}},_traverseParent:function(operatorId){if(operatorId===this.workflowId){return null;}
var result=null;$.each(this.canvas.flowchart("getData").links,function(_,link){if(link.toOperator===operatorId&&!!link.fromOperator){result=link.fromOperator;return false;}});return result;},_traverseLeaf:function(filter,operatorId){var links=this.canvas.flowchart("getLinksFrom",operatorId,function(data){return filter(data.fromConnector,data.fromOperator);});return $.map(links,function(link){return link.toOperator;});},_findOrphanActions:function(data,rootId){var result=[];$.each(data.operators,function(operatorId){if(operatorId==rootId){return true;}
var hasParent=false;$.each(data.links,function(_,link){if(link.toOperator==operatorId&&link.toConnector==jscape.domain.TriggerActionFlow.Connector.EXECUTE){hasParent=true;return false;}});if(!hasParent){result.push(operatorId);}});return result;},_arrangeRelativeTo:function(operatorId,relativeOperatorId){if(!this.canvas.flowchart("doesOperatorExists",relativeOperatorId)){return;}
var pos=this.getOperatorPosition(relativeOperatorId);if(!!this.alignToGrid){var dim=this.canvas.flowchart("getOperatorDimension",relativeOperatorId);pos.left+=dim.width+this.padding.left;this.canvas.flowchart("moveOperator",operatorId,pos);this._alignToGrid(operatorId);}else{pos.top+=this.padding.top;pos.left+=this.padding.left;this.canvas.flowchart("moveOperator",operatorId,pos);}},_arrangeActions:function(){var id=this.getSelectedOperatorId();if(id!=null){this.canvas.flowchart("arrange",id,{filter:{left:function(link){return jscape.domain.TriggerActionFlow.Connector.isFailure(link.fromConnector);},right:function(link){return jscape.domain.TriggerActionFlow.Connector.isSuccess(link.fromConnector);}}});}else{this.canvas.flowchart("arrange",this.workflowId,{filter:{left:function(link){return jscape.domain.TriggerActionFlow.Connector.isFinish(link.fromConnector);},right:function(link){return jscape.domain.TriggerActionFlow.Connector.isStart(link.fromConnector);}}});this.canvas.flowchart("arrange",this.workflowId,{filter:{left:function(link){return jscape.domain.TriggerActionFlow.Connector.isFailure(link.fromConnector);},right:function(link){return jscape.domain.TriggerActionFlow.Connector.isSuccess(link.fromConnector);}}});}
this.canvas.flowchart("redrawLinksLayer");},_adjustViewportDimension:function(width,height){width=parseInt(width);height=parseInt(height);if(isNaN(width)||isNaN(height)){return;}
width+=this.padding.left+this.padding.right;height+=this.padding.top+this.padding.bottom;var s=this.canvas.panzoom("getScale")||1;var w=Math.round(this.canvas.width()/s);var h=Math.round(this.canvas.height()/s);var p=this.canvas.parent();if(p.is(":visible")&&width>w||height>h){var minScale=0.25;width=Math.max(p.width()/minScale,Math.max(w,width));height=Math.max(p.height()/minScale,Math.max(h,height));this.canvas.css({width:width+"px",height:height+"px"});}},_adjustButtonsState:function(operatorId,linkId,disableAddButton){var isRoot=jscape.domain.TriggerActionFlow.isRootId(operatorId);this.addButton.linkbutton(disableAddButton===true?"disable":"enable");this.editButton.linkbutton(!!operatorId&&!isRoot?"enable":"disable");this.copyButton.linkbutton(!!operatorId&&!isRoot?"enable":"disable");this.deleteButton.linkbutton(!!operatorId&&!isRoot||$.isNumeric(linkId)?"enable":"disable");},_publishOnChanged:function(type,id,data){var args=Array.prototype.slice.call(arguments,1);for(var i=0,len=this.subscribers.length;i<len;++i){var s=this.subscribers[i];if(typeof s.onEvent=="function"){s.onEvent.apply(s,[type].concat(args,this));}}},_onAfterChange:function(type){if($.inArray(type,this.FORM_CHANGE_EVENTS)!=-1){this.fieldset.closest("form").trigger("change");}}});jscape.domain.TriggerActionsView.LISTENER={onAddAction:$.noop,onEditAction:$.noop,onDeleteAction:$.noop,onCopyAction:$.noop};jscape.domain.BaseTriggerActionController=Class.extend({controllers:null,functions:null,variables:null,links:null,actionClass:null,deferred:null,initialize:function(){this.variableController=new jscape.VariableController();this.linkController=new jscape.VariableController('"','"');this.functionController=new jscape.FunctionController();},onAddVariable:function(input){this.variableController.start(input,this.variables||[]);},onAddFunction:function(input){this.functionController.start(input,this.functions||[]);},onLinkAction:function(input){this.linkController.start(input,this.links||[]);},onSubmit:function(dialog){$.each(this.controllers,function(_,controller){controller.onPause();});return jscape.API.validateTriggerActionContext(this.domainName,this.actionContext,this.eventType).done($.proxy(function(){$.each(this.controllers,$.proxy(function(_,controller){controller.onStop(dialog);},this));this.deferred.resolve(this.actionContext);this.deferred=null;},this)).fail($.proxy(function(){$.each(this.controllers,function(_,controller){controller.onResume();});},this));},onCancel:function(dialog){$.each(this.controllers,$.proxy(function(_,controller){controller.onStop(dialog);}));dialog.destroy();this.deferred.reject();this.deferred=null;},_selectActionType:function(types,actionClass){var deferred=$.Deferred();var index=!!actionClass?$.inArray(actionClass,$.map(types,function(t){return t.actionClass;})):-1;if(index!=-1){deferred.resolve(types[index]);}else{deferred.reject();}
return deferred.promise();},_createControllerFor:function(field,actionClass){var type=(field.type||"").toLowerCase();if(type=="integer"){return new jscape.domain.NumberPropertyController();}else if(type=="boolean"||type=="logaction"){return new jscape.domain.BooleanPropertyController();}else if(type=="string"||type=="memo"||type=="password"){return new jscape.domain.StringPropertyController();}else if(type=="choice"){return new jscape.domain.ComboboxPropertyController();}else if(type=="date"){return new jscape.domain.DatePropertyController();}else if(type=="path"){return jscape.domain.PathPropertyController.pathMode();}else if(type=="file"){return jscape.domain.PathPropertyController.fileMode();}else if(type=="directory"){return jscape.domain.PathPropertyController.directoryMode();}else if(type=="account"){return new jscape.domain.DisableUsersPropertyController();}else if(type=="serverkey"){return new jscape.domain.ServerKeysPropertyController();}else if(type=="hostkey"){return new jscape.domain.HostKeysPropertyController();}else if(type=="pgppublickey"){return new jscape.domain.PgpPublicKeysPropertyController();}else if(type=="pgpsecretkey"){return new jscape.domain.PgpSecretKeysPropertyController();}else if(type=="partner"){return new jscape.domain.TradingPartnersPropertyController();}else if(type=="trigger"){return new jscape.domain.TriggersPropertyController();}else if(type=="triggermetrics"){return new jscape.domain.ComboPropertyController();}else if(type=="directorymonitor"){return new jscape.domain.DirectoryMonitorsPropertyController();}else if(type=="owner"){return new jscape.domain.OwnerPropertyController();}else if(type=="group"){return new jscape.domain.GroupPropertyController();}else if(type=="urlbranding"){return new jscape.domain.UrlBrandingPropertyController();}else if(type=="amazonsnstopic"){return new jscape.domain.AmazonSnsTopicPropertyController();}else if(/redwood/i.test(actionClass)){if(type=="process"){return new jscape.domain.RedwoodProcessPropertyController();}else if(type=="processdescription"){return new jscape.domain.RedwoodProcessDescriptionPropertyController();}else if(type=="processqueue"){return new jscape.domain.RedwoodProcessQueuePropertyController();}else if(type=="processparameters"){return new jscape.domain.RedwoodProcessParametersPropertyController();}else{return this._createControllerFor(field,null);}}else if(/activebatch/i.test(actionClass)){if(type=="job"){return new jscape.domain.ActiveBatchJobPropertyController();}else if(type=="jobqueue"){return new jscape.domain.ActiveBatchJobQueuePropertyController();}else{return this._createControllerFor(field,null);}}else if(/tidal/i.test(actionClass)){if(type=="job"){return new jscape.domain.TidalJobPropertyController("tidaljob",{format:function(job){return job.id;},sorter:function(job1,job2){return String(job1.name).localeCompare(String(job2.name));}});}else if(type=="jobparameters"){return new jscape.domain.ConsumerPropertyController(new jscape.domain.StringPropertyController(),"tidaljob",{format:function(job){return job.parameters;}});}else if(type=="jobvariables"){return new jscape.domain.ConsumerPropertyController(new jscape.domain.StringPropertyController(),"tidaljob",{format:function(job){return job.variables;}});}else{return this._createControllerFor(field,null);}}
throw"Unsupported field: "+type;}});jscape.domain.AddTriggerActionController=jscape.domain.BaseTriggerActionController.extend({start:function(domainName,actions,functions,variables,links,eventType,actionClass){this.domainName=domainName;this.functions=functions||[];this.variables=variables||[];this.links=links||[];this.eventType=eventType;this.deferred=$.Deferred();this._selectActionType(actions,actionClass).then($.proxy(function(action){this.actionClass=action.actionClass;this.actionName=action.displayName;return jscape.API.createTriggerActionContext(this.domainName,this.actionClass);},this)).then($.proxy(function(context){this.actionContext=context;return jscape.API.getTriggerActionProperties(this.domainName,context.actionClass);},this)).done($.proxy(function(properties){this._createActionDialog(properties).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_selectActionType:function(types,actionClass){var deferred=$.Deferred();var index=!!actionClass?$.inArray(actionClass,$.map(types,function(t){return t.actionClass;})):-1;if(index!=-1){deferred.resolve(types[index]);}else{var dialog=new jscape.domain.TriggerActionTypeDialog();dialog.setActions(types);dialog.show({onSubmit:$.proxy(function(d){var action=d.getAction();d.destroy();deferred.resolve(action);},this),onCancel:$.proxy(function(d){d.destroy();deferred.reject();},this)});}
return deferred.promise();},_createActionDialog:function(properties){this.controllers=[];var dialog=new jscape.domain.AddTriggerActionDialog();dialog.setActionName(this.actionName);var nameController=new jscape.domain.ActionNameController(dialog,this.actionContext);nameController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(nameController);var notesController=new jscape.domain.ActionNotesController(dialog);notesController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(notesController);$.each(properties,$.proxy(function(_,property){var controller=this._createControllerFor(property.field,this.actionContext.actionClass);controller.onCreate(this.domainName,property,this.actionContext);this.controllers.push(controller);},this));for(var i=0,len=this.controllers.length;i<len;++i){var c=this.controllers[i];c.onStart(dialog);c.onResume();}
return dialog.finish();}});jscape.domain.EditTriggerActionController=jscape.domain.BaseTriggerActionController.extend({start:function(domainName,actions,functions,variables,links,eventType,actionContext,actionDisplayName){this.domainName=domainName;this.functions=functions||[];this.variables=variables||[];this.links=links||[];this.eventType=eventType;this.deferred=$.Deferred();this._selectActionType(actions,actionContext.actionClass).then($.proxy(function(action){this.actionClass=action.actionClass;this.actionName=action.displayName||actionDisplayName;return $.extend(true,new jscape.ActionContext(),actionContext);},this)).then($.proxy(function(context){this.actionContext=context;return jscape.API.getTriggerActionProperties(this.domainName,context.actionClass);},this)).done($.proxy(function(properties){this._createActionDialog(properties).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_createActionDialog:function(properties){this.controllers=[];var dialog=new jscape.domain.EditTriggerActionDialog();dialog.setActionName(this.actionName);var nameController=new jscape.domain.ActionNameController(dialog,this.actionContext);nameController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(nameController);var notesController=new jscape.domain.ActionNotesController(dialog);notesController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(notesController);$.each(properties,$.proxy(function(_,property){var controller=this._createControllerFor(property.field,this.actionContext.actionClass);controller.onCreate(this.domainName,property,this.actionContext);this.controllers.push(controller);},this));for(var i=0,len=this.controllers.length;i<len;++i){var c=this.controllers[i];c.onStart(dialog);c.onResume();}
return dialog.finish();}});jscape.domain.TriggerActionTypeDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggers-actiontype"),{width:"40%",minWidth:530});this.fieldset=$("fieldset[name=triggeractiontypefields]",this.dialog);this.action=$("select[name=action]",this.fieldset).combobox({required:true,limitToList:true,textField:"displayName",valueField:"actionClass",groupField:"group",groupPosition:"sticky",onChange:$.proxy(this._adjustActionHelp,this),formatter:function(row){return'<span title="'+String(row.description||"").escapeXml()+'">'+String(row.displayName||row.name).escapeXml()+'</span>';},filter:function(query,row){function _c(a,b){return String(a).toLocaleLowerCase().indexOf(String(b).toLocaleLowerCase())>=0;}
var opts=$(this).combobox("options");return _c(row[opts.valueField],query)||(opts.groupField&&_c(row[opts.groupField],query));},keyHandler:$.extend({},$.fn.combobox.defaults.keyHandler,{enter:$.proxy(function(e){$.fn.combobox.defaults.keyHandler.enter.call(e.data.target,e);if(!this.action.combobox("panel").is(":visible")){var okBtn=this.okButton;setTimeout(function(){okBtn.click();okBtn=undefined;},100);}},this)}),width:"60%",panelHeight:"auto",panelMaxHeight:"40%"});this.action.combobox("textbox").on("focus",function(){$(this).select();});this.actionHelp=this.fieldset.find("#"+this.action.attr("aria-describedby")).tooltip({position:"bottom",showDelay:0,onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");}});},getAction:function(){var value=this.action.combobox("getValue");var actions=$.grep(this.action.combobox("getData"),function(action){return action.actionClass==value;});return actions.length?actions[0]:null;},setActions:function(values){this.action.combobox("loadData",values);},show:function(listener){this._super(listener);this._adjustActionHelp();this.action.combobox("textbox").focus();},_adjustActionHelp:function(){var action=this.getAction();var content=action?"<div class=\"tooltip-title\"><code>{name}</code></div>{description}".supplant({name:String(action.displayName||action.name).escapeXml(),description:String(action.description).escapeXml()}):"";this.actionHelp.tooltip("update",content);}});jscape.domain.TriggerActionDialog=jscape.ui.DefaultDialog.extend({FIELDSET_CLASSES:["small","large","x-large","xx-large","xxx-large"],currentInput:null,views:null,initialize:function(dialog){this._super(dialog,{width:"85%",height:"90%",resizable:true,onResize:$.proxy(this._onResize$Dialog,this)});this.views=[];this.title=this.dialog.dialog("header").text()||"";this.fieldset=$("#triggeractionfields"+this.getIdSuffix()).layout({fit:true,border:false});this.tabs=$("div[role=tablist]",this.fieldset).tabs({fit:true,plain:true,minHeight:350});this.parametersFieldset=$("fieldset[name=parametersfields]",this.fieldset);this.advancedFieldset=$("fieldset[name=advancedparametersfields]",this.fieldset);this.variablesButton=$("a[role=button][name=addvariable]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$VariablesButton,this)});this.functionsButton=$("a[role=button][name=addfunction]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$FunctionsButton,this)});this.linkActionButton=$("a[role=button][name=linkaction]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$LinkActionButton,this)});},setActionName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value||""}));},addFormField:function(html,group){var field;if(group){group=String(group).escapeXml();field=$(html).appendTo(this._findGroup(group,this.parametersFieldset));}else{field=$(html).appendTo(this.parametersFieldset);}
this._adjustChildrenId(field);return field;},addAdvancedField:function(html,group){var field;if(group){group=String(group).escapeXml();field=$(html).appendTo(this._findGroup(group,this.advancedFieldset));}else{field=$(html).appendTo(this.advancedFieldset);}
this._adjustChildrenId(field);return field;},_findGroup:function(name,parent){var t=parent.find("fieldset[name='"+name+"']");if(t.length){return t;}
var fs=$("<div><fieldset name='{name}'><legend>{name}</legend></fieldset></div>".supplant({name:name}));var groups=parent.find("fieldset");if(groups.length){if(name=="Action"){fs.insertBefore(groups.parent().first());}else{fs.insertAfter(groups.parent().last());}}else{var c=parent.children();if(c.length){fs.insertBefore(c.first());}else{parent.append(fs);}}
return this._findGroup(name,parent);},finish:function(){this.parametersFieldset.focusin($.proxy(this._onForm$FocusIn,this));this.advancedFieldset.focusin($.proxy(this._onForm$FocusIn,this));this.tabs.tabs({onSelect:function(_,index){$(this).tabs("getTab",index).find("fieldset").trigger("focusin");}});return this;},container:function(){return this.fieldset;},register:function(view){this.views.push(view);},unregister:function(view){for(var i=0;i<this.views.length;++i){if(view==this.views[i]){this.views.splice(i--,1);}}},show:function(listener){this.listener=listener;this.currentInput=null;this.dialog.dialog("center").dialog("open").dialog("resize");this.fieldset.form("validate");this.fieldset.find("input:not(:disabled):first").focus();},hide:function(){this.currentInput=null;this._super();},_onResize$Dialog:function(){this.fieldset&&this.fieldset.layout("resize");this._inspect(this.parametersFieldset);this._inspect(this.advancedFieldset);},_inspect:function(fieldset){if(!fieldset||!fieldset.is(":visible")||$.data(fieldset[0],"__inspected__")){return;}
for(var i=0;i<this.views.length;++i){if(!this.views[i].collide()){continue;}
var index=this._indexOfClass(fieldset,this.FIELDSET_CLASSES);if(index>=0&&(index+1)<this.FIELDSET_CLASSES.length-1){fieldset.addClass(this.FIELDSET_CLASSES[index+1]);fieldset.removeClass(this.FIELDSET_CLASSES[index]);--i;}else{break;}}
$.data(fieldset[0],"__inspected__",true);},_indexOfClass:function(fieldset,classes){for(var i=0;i<classes.length;++i){if(fieldset.hasClass(classes[i])){return i;}}
return-1;},_onClick$VariablesButton:function(){var input=this.currentInput;if(input&&input.is(":not(:disabled)")){this.listener.onAddVariable(input);}},_onClick$FunctionsButton:function(){var input=this.currentInput;if(input&&input.is(":not(:disabled)")){this.listener.onAddFunction(input);}},_onClick$LinkActionButton:function(){var input=this.currentInput;if(input&&input.is(":not(:disabled)")){this.listener.onLinkAction(input);}},_onForm$FocusIn:function(e){var t=$(e.target);var buttons=[this.variablesButton,this.variablesButton,this.functionsButton,this.linkActionButton];if(t.is("input[type=text]:visible:not([readonly])")||t.is("textarea:visible")){this.currentInput=t;$.each(buttons,function(_,b){b.linkbutton("enable");});}else{this.currentInput=null;$.each(buttons,function(_,b){b.linkbutton("disable");});if(t.is("fieldset")){this._inspect(t);}}}});jscape.domain.TriggerActionDialog.LISTENER={onAddVariable:$.noop,onAddFunction:$.noop};jscape.domain.AddTriggerActionDialog=jscape.domain.TriggerActionDialog.extend({initialize:function(){this._super($("#d-triggers-addaction"));}});jscape.domain.EditTriggerActionDialog=jscape.domain.TriggerActionDialog.extend({initialize:function(){this._super($("#d-triggers-editaction"));}});jscape.domain.PropertyController=Class.extend({property:null,view:null,initialize:function(view){this.view=!!view?view:null;},onCreate:function(domainName,property,context){this.domainName=domainName;this.property=property;this.context=context;},onStart:function(dialog){if(this.view==null){this.view=this._createView(this.property,dialog);}
if(this.view){dialog.register(this.view);this.view.show(this);}},onResume:function(){if(this.context&&this.view){if(this.view.variants){var hasParameter=this.context.hasParameter(this.property.id);var value=this.context.getParameter(this.property.id);this._loadVariants().done($.proxy(function(values){values&&this.view.variants(values);},this)).always($.proxy(function(){hasParameter&&this.view.val(value);},this));}else{if(this.context.hasParameter(this.property.id)){this.view.val(this.context.getParameter(this.property.id));}}}},onPause:function(){if(this.view&&this.view.valid()){this.context.setParameter(this.property.id,this.view.val());}},onStop:function(dialog){if(this.view){dialog.unregister(this.view);}},onChange:function(view){if(this.context){this.context.setParameter(this.property.id,view.val());}},_loadVariants:function(){return $.Deferred().resolve();},_setupView:function(){if(this.context&&this.context.hasParameter(this.property.id)){this.view.val(this.context.getParameter(this.property.id));}},_addFieldView:function(property,dialog){if(!!property.advanced){return dialog.addAdvancedField(property.html,property.group);}else{return dialog.addFormField(property.html,property.group);}},_createView:function(property,dialog){return null;}});jscape.domain.ActionNameController=jscape.domain.PropertyController.extend({initialize:function(dialog,actionContext){var v=dialog.addFormField("<div><label for=\"{id}\">{label}</label><input type=\"text\" id=\"{id}\"/></div>".supplant({id:":"+(1E9*Math.random()>>>0),label:"Name<em>*</em>"}),"Action");this._super(new jscape.domain.StringPropertyView(v,{required:true,delay:1200,validateOnCreate:false,validateOnBlur:true,validType:["non_empty","trigger_action_name_unique['"+actionContext.id+"','"+(actionContext.name||actionContext.id)+"']"],invalidMessage:window.R.string.TRIGGERS_ERROR_BAD_ACTION_NAME}));},onResume:function(){if(this.context){this.view.val(this.context.name||this.context.id);}},onPause:function(){if(this.context&&this.view.valid()){this.context.name=this.view.val();}},onChange:function(view){if(this.context){this.context.name=view.val();}},_createView:function(property,dialog){return this.view;}});jscape.domain.ActionNotesController=jscape.domain.PropertyController.extend({initialize:function(domainName,context){this.domainName=domainName;this.context=context;},onResume:function(){if(this.context){this.view.val(this.context.notes);}},onPause:function(){if(this.context&&this.view.valid()){this.context.notes=this.view.val();}},onChange:function(view){if(this.context){this.context.notes=view.val();}},_createView:function(property,dialog){var v=dialog.addFormField("<div><label for=\"{id}\">{label}</label><textarea id=\"{id}\"/></div>".supplant({id:":"+(1E9*Math.random()>>>0),label:"Notes"}),"Action");return new jscape.domain.StringPropertyView(v,{height:60});}});jscape.domain.ServerKeysPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getServerKeys(this.domainName).then(function(keys){return $.map(keys,function(key){return key.name;});});},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return property.field&&property.field.optional===true?new jscape.domain.OptionalComboboxPropertyView(v,{limitToList:true}):new jscape.domain.ComboboxPropertyView(v,true,{limitToList:true});}});jscape.domain.HostKeysPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return $.when(jscape.API.getHostPublicKeys(this.domainName),jscape.API.getHostCertificates(this.domainName)).then(function(publicKeys,certificates){publicKeys=$.map(publicKeys,function(key){return key.name;});certificates=$.map(certificates,function(certificate){return certificate.name;});return publicKeys.concat(certificates);});},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.OptionalComboboxPropertyView(v);}});jscape.domain.PgpPublicKeysPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return $.when(jscape.API.getPgpPublicKeys(this.domainName),jscape.API.getPgpSecretKeys(this.domainName)).then(function(publicKeys,secretKeys){publicKeys=$.map(publicKeys,function(key){return"public: "+key.name;});secretKeys=$.map(secretKeys,function(key){return"secret: "+key.name;});return publicKeys.concat(secretKeys);});},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.OptionalComboboxPropertyView(v);}});jscape.domain.PgpSecretKeysPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getPgpSecretKeys(this.domainName).then(function(keys){return $.map(keys,function(key){return key.name;});});},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.OptionalComboboxPropertyView(v);}});jscape.domain.TradingPartnersPropertyController=jscape.domain.PropertyController.extend({protocols:null,onCreate:function(_,property,context){this._super.apply(this,arguments);this.protocols=property&&property.field?property.field.supportedProtocols||[]:[];},onChange:function(view){this._super.apply(this,arguments);$(document).triggerHandler("onchange.partnername",view.val());},_loadVariants:function(){return jscape.API.getTradingPartnerNames(this.domainName,this.protocols).then(function(data){return data.sort(function(a,b){return String(a).localeCompare(b);});});},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.ComboboxPropertyView(v,true,{limitToList:false,validateOnBlur:true});}});jscape.domain.DirectoryMonitorsPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getDirectoryMonitorNames(this.domainName);},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.ComboboxPropertyView(v);}});jscape.domain.TriggersPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getTriggerNames(this.domainName);},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.ComboPropertyView(v,false,{multiple:true});}});jscape.domain.OwnerPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getAccountAdminNames(this.domainName);},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.OptionalComboboxPropertyView(v);}});jscape.domain.GroupPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getGroupNames(this.domainName);},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.ComboboxPropertyView(v,true,{limitToList:false,validateOnBlur:true,width:"60%"});}});jscape.domain.UrlBrandingPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getWebThemeNames(this.domainName);},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.OptionalComboboxPropertyView(v);}});jscape.domain.BasePropertyView=Class.extend({show:function(listener){this.listener=listener;},collide:function(){return false;},_collide:function(a,b){return!(a.max.x<b.min.x||a.min.x>b.max.x||a.max.y<b.min.y||a.min.y>b.min.y);},_onChange:function(){this.listener&&this.listener.onChange(this);},_aabb:function(el){var offset=el.offset();return{min:{x:offset.left,y:offset.top},max:{x:offset.left+Math.max(el.outerWidth(),el[0].scrollWidth),y:offset.top+Math.max(el.outerHeight(),el[0].scrollHeight)}};},_initHelpFor:function(input){var id=input.attr("aria-describedby");if(!!id){var help=$("#"+id);if(help.length){help.tooltip({position:"right",showDelay:0,content:help.html(),onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");}});help.empty();}}}});jscape.domain.StringPropertyController=jscape.domain.PropertyController.extend({_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.StringPropertyView(v);}});jscape.domain.StringPropertyView=jscape.domain.BasePropertyView.extend({label:null,input:null,initialize:function(parent,options){this.input=parent.find("input[id],textarea[id]").first();var labelledBy=this.input.attr("aria-labelledby");this.label=!!labelledBy?$("#"+labelledBy):parent.find("label[for='"+this.input.attr("id")+"']");var maxLength=parseInt(this.input.prop("maxlength"));var pattern=this.input.prop("pattern");this.input.textbox($.extend({doSize:false,multiline:this.input.is("textarea"),onChange:$.proxy(this._onChange,this)},options||{}));var opts=this.input.textbox("options");if(opts.required&&!isNaN(maxLength)){if(maxLength>0){opts.validType="length[1,"+maxLength+"]";}else{opts.validType="length[1,"+Number.MAX_VALUE+"]";opts.invalidMessage=opts.missingMessage;}}
if(pattern&&pattern.trim().length!=0){opts.validType="pattern['"+pattern+"', 'g']";opts.invalidMessage=opts.missingMessage;}
this._initHelpFor(this.input);},show:function(){this._super.apply(this,arguments);this.resize({width:"60%"});},resize:function(options){var opts=this.input.textbox("options");this.input.textbox("resize",$.extend(opts.multiline?{height:$.isNumeric(opts.height)?opts.height:120}:{},options||{}));},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.input.textbox("textbox")));},valid:function(){return this.input.textbox("isValid");},val:function(value){if(!arguments.length){return this.input.is(":not(:disabled)")?this.input.textbox("getValue"):null;}
this.input.textbox("setValue",value);return this;}});jscape.domain.BooleanPropertyController=jscape.domain.PropertyController.extend({_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.BooleanPropertyView(v);}});jscape.domain.BooleanPropertyView=jscape.domain.BasePropertyView.extend({input:null,initialize:function(parent){this.input=parent.find("input[id]").change($.proxy(this._onChange,this));this._initHelpFor(this.input);},collide:function(){return false;},valid:function(){return true;},val:function(value){if(!arguments.length){return this.input.is(":checked");}
this.input.prop("checked",!!value).change();return this;}});jscape.domain.NumberPropertyController=jscape.domain.PropertyController.extend({_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.NumberPropertyView(v);}});jscape.domain.NumberPropertyView=jscape.domain.BasePropertyView.extend({label:null,input:null,initialize:function(parent){function _expression(value){return value.length&&/%\w+[()%]?/.test(value);}
function _expressionChar(c){return/[%\w\s(),.]/.test(c);}
this.input=parent.find("input[id]");this.label=parent.find("label[for='"+this.input.attr("id")+"']");this.input.numberspinner({onChange:$.proxy(this._onChange,this),filter:function(e){if(_expression($(this).numberspinner("getValue"))&&_expressionChar(String.fromCharCode(e.which))){return true;}
return $.fn.numberbox.defaults.filter.call(this,e);},formatter:function(value){return _expression(value)?value:$.fn.numberbox.defaults.formatter.call(this,value);},parser:function(value){return _expression(value)?value:$.fn.numberbox.defaults.parser.call(this,value);},width:100});this._initHelpFor(this.input);},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.input.numberspinner("textbox")));},valid:function(){return this.input.numberspinner("isValid");},val:function(value){if(!arguments.length){return this.input.numberspinner("getValue");}
this.input.numberspinner("setValue",value);return this;}});jscape.domain.DatePropertyController=jscape.domain.PropertyController.extend({_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.DatePropertyView(v);}});jscape.domain.DatePropertyView=jscape.domain.BasePropertyView.extend({label:null,input:null,initialize:function(parent){this.input=parent.find("input[id]");this.label=parent.find("label[for='"+this.input.attr("id")+"']");this.input.datebox({width:"25%"});this.input.datebox("calendar").calendar({onChange:$.proxy(this._onChange,this)});this._initHelpFor(this.input);},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.input.datebox("textbox")));},valid:function(){return this.input.datebox("isValid");},val:function(value){var opts=this.input.datebox("options");if(!arguments.length){var date=this.input.datebox("getDate");return date?date.getTime():null;}
if($.isNumeric(value)){this.input.datebox("setDate",new Date(value));}else{this.input.datebox("setValue",value);}
return this;}});jscape.domain.ComboboxPropertyController=jscape.domain.PropertyController.extend({_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return property.field&&property.field.optional===true?new jscape.domain.OptionalComboboxPropertyView(v,{limitToList:true,width:100}):new jscape.domain.ComboboxPropertyView(v);}});jscape.domain.ComboboxPropertyView=jscape.domain.BasePropertyView.extend({label:null,input:null,initialize:function(parent,autocomplete,options){this.input=parent.find("select[id]");this.label=parent.find("label[for='"+this.input.attr("id")+"']");this.input.combobox($.extend({onChange:$.proxy(this._onChange,this),onLoadSuccess:function(data){var c=$(this);var opts=c.combo("options");if(data.length!=0&&!opts.editable){c.combobox("clear").combobox("select",data[0].value);}
opts.panelHeight=data.length>0&&data.length<15?"auto":$.fn.combo.defaults.panelHeight;c.combo("resize");}},options||{}));var opts=this.input.combobox("options");if(autocomplete&&options.limitToList!==false){opts.limitToList=true;opts.editable=true;}
this._initHelpFor(this.input);},reset:function(){this.input.combobox("reset");},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.input.combobox("textbox")));},valid:function(){return this.input.combobox("isValid");},variants:function(values){this.input.combobox("loadData",values);},val:function(value){var opts=this.input.combobox("options");if(!arguments.length){return!!opts.multiple?this.input.combobox("getValues"):this.input.combobox("getValue");}
if(!!opts.editable){this.input.combobox("clear");if(!!opts.multiple&&!!opts.separator){value=value.split(opts.separator);}
this.input.combobox("setValue",value);}else{if(this.contains(value)){this.input.combobox("clear").combobox("select",value);}}
return this;},contains:function(value){var options=this.input.combobox("options");var data=this.input.combobox("getData");for(var i=0;i<data.length;i++){if(data[i][options.valueField]===value){return true;}}
return false;}});jscape.domain.ComboPropertyController=jscape.domain.PropertyController.extend({_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.ComboPropertyView(v);}});jscape.domain.ComboPropertyView=jscape.domain.BasePropertyView.extend({label:null,input:null,initialize:function(parent,autocomplete,options){this.input=parent.find("select[id]");this.label=parent.find("label[for='"+this.input.attr("id")+"']");this.input.combo($.extend({editable:false,multiple:true,onChange:$.proxy(this._onChange$Combo,this),panelHeight:"auto",panelMinHeight:100,panelMaxHeight:"40%"},options||{}));var panel=this.input.parent().find(".combo-panel");this.input.combo("panel").append(panel);var list=this.input.combo("panel").find("ul");list.datalist({border:false,checkbox:true,selectOnCheck:true,singleSelect:false,onSelect:$.proxy(this._onChange$DataList,this),onUnselect:$.proxy(this._onChange$DataList,this),onSelectAll:$.proxy(this._onChange$DataList,this),onUnselectAll:$.proxy(this._onChange$DataList,this)});this.list=this.input.combo("panel").find(".datagrid-f");this.selectAllBtn=this.input.combo("panel").find(".select-all").click($.proxy(this._onClick$SelectAllButton,this));this._initHelpFor(this.input);},reset:function(){this.input.combo("reset");},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.input.combo("textbox")));},valid:function(){return this.input.combo("isValid");},variants:function(values){var opts=this.list.datalist("options");var data=$.map(values,function(val){var obj={};obj[opts.textField]=obj[opts.valueField]=val;return obj;});this.list.datalist("loadData",data);},val:function(value){if(!arguments.length){return this.input.combo("getValues");}
this.input.combo("clear");this.list.datalist("unselectAll");var values=(""+value).split(this.input.combo("options").separator);var data=this.list.datalist("getData");var rows=$.isArray(data)?data:data&&$.isArray(data.rows)?data.rows:[];for(var index=0,opts=this.list.datalist("options");index<rows.length;++index){var val=rows[index][opts.valueField];if($.inArray(val,values)!=-1){this.list.datalist("selectRow",index);}}
return this;},_onChange$Combo:function(newValues){var oldSelected=!!this.selectAllBtn.prop("selected");this.selectAllBtn.prop("selected",newValues.length!=0);if(oldSelected!=this.selectAllBtn.prop("selected")){this._toggleButtonText(this.selectAllBtn);}},_onChange$DataList:function(){var sep=this.input.combo("options").separator;var data=this.list.datalist("getSelections");this.input.combo("setText",$.map(data,function(r){return r.text;}).join(sep));this.input.combo("setValues",$.map(data,function(r){return r.value;}));},_onClick$SelectAllButton:function(e){if($(e.target).closest("button").prop("selected")){this.list.datalist("unselectAll");}else{this.list.datalist("selectAll");}},_toggleButtonText:function(btn){var text=btn.text();var toggleText=btn.data("toggle-text")||"";if(!!toggleText&&toggleText!==text){btn.html(btn.html().replace(text,toggleText));btn.data("toggle-text",text);if(btn.data("linkbutton")){btn.linkbutton("resize");}}}});jscape.domain.OptionalComboboxPropertyView=jscape.domain.BasePropertyView.extend({enableInput:null,valueInput:null,initialize:function(parent,options){this.valueInput=parent.find("select");this.enableInput=parent.find("input[name=use"+this.valueInput.attr("name")+"]:checkbox");this.label=$("#"+this.valueInput.attr("aria-labelledby"));this.valueInput.combobox($.extend({disabled:true,panelHeight:"auto",panelMinHeight:100,panelMaxHeight:300,onChange:$.proxy(this._onChange,this),onLoadSuccess:$.proxy(function(data){this.valueInput.combobox("clear");if(data.length){var opts=this.valueInput.combobox("options");this.valueInput.combobox("setValue",data[0][opts.valueField]).combobox("resize");this.enableInput.change();}else{this.enableInput.prop("disabled",true).prop("checked",false).change();}},this)},options||{}));this.enableInput.change($.proxy(function(){var enabled=this.enableInput.is(":checked");this.valueInput.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");this._onChange();},this));this._initHelpFor(this.valueInput);},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.valueInput.combobox("textbox")));},valid:function(){return this.valueInput.combobox("isValid");},variants:function(values){this.valueInput.combobox("loadData",values);},val:function(value){if(!arguments.length){return this.enableInput.is(":checked:not(:disabled)")?this.valueInput.combobox("getValue"):null;}
if(value!=null){this.valueInput.combobox("setValue",value);}
this.enableInput.prop("checked",value!=null).change();return this;}});jscape.domain.LazyComboboxPropertyView=jscape.domain.ComboboxPropertyView.extend({label:null,input:null,initialize:function(parent,listener,options){this._super(parent,false,$.extend({initialized:false,limitToList:false,editable:true,width:600,panelMinWidth:600,panelWidth:"auto",panelMaxWidth:"75%",panelHeight:"auto",panelMinHeight:150,panelMaxHeight:"40%",inputEvents:$.extend({},$.fn.combobox.defaults.inputEvents,{focus:function(e){$(e.data.target).combobox("reload");}}),onBeforeLoad:function(){return!!$(this).combobox("options").initialized;},onLoadSuccess:function(data){if(data&&data.length){$(this).combobox("options").limitToList=true;var p=$(this).combobox("panel");if(p&&p.length){p.panel("resize",{minHeight:null});}}},loader:function(_,success,error){if(!listener){return;}
var $p=$(this).combobox("panel").panel("clear");$(this).combobox("showPanel");$p.html($("<div class=\"panel-loading\"></div>").html($p.panel("options").loadingMessage));listener.onLoadVariants().then(success,error);},onChange:$.proxy(this._onChange,this)},options||{}));this.input.combobox("options").initialized=true;},_onChange:function(newValue,oldValue){this.listener&&this.listener.onChange(this,newValue,oldValue);}});jscape.domain.PathPropertyController=jscape.domain.PropertyController.extend({provider:null,initialize:function(provider){this.provider=provider;},onBrowse:function(view){return this.provider.browse().done(function(value){view.val(value);});},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.PathPropertyView(v);}});jscape.domain.PathPropertyController.pathMode=function(){return new jscape.domain.PathPropertyController({browse:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectPath().then(function(entry){return entry.path;});}})};jscape.domain.PathPropertyController.fileMode=function(){return new jscape.domain.PathPropertyController({browse:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectFile().then(function(entry){return entry.path;});}})};jscape.domain.PathPropertyController.directoryMode=function(){return new jscape.domain.PathPropertyController({browse:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectDirectory().then(function(entry){return entry.path;});}})};jscape.domain.PathPropertyView=jscape.domain.StringPropertyView.extend({initialize:function(parent){this._super(parent);this.input.textbox("textbox").validatebox({tipPosition:"bottom"});this.browseButton=parent.find("a[role=button][name^=browse]").linkbutton({onClick:$.proxy(this._onBrowse,this)});},show:function(){this._super.apply(this,arguments);this.input.textbox("resize",{width:"55%"});},_onBrowse:function(){if(this.listener){var fieldset=this.input.parents("fieldset");fieldset.form("disableValidation");this.listener.onBrowse(this).done($.proxy(function(){this.input.textbox("textbox").select().focus();},this)).always(function(){fieldset.form("enableValidation").form("validate");});}}});jscape.domain.DisableUsersPropertyController=jscape.domain.PropertyController.extend({_loadVariants:function(){return jscape.API.getAccountNames(this.domainName).then(function(names){return names.sort();});},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.DisableUsersPropertyView(v);}});jscape.domain.DisableUsersPropertyView=jscape.domain.BasePropertyView.extend({label:null,input:null,disableUser:null,initialize:function(parent){this.input=parent.find("select").combobox({width:"50%",editable:false,onChange:$.proxy(this._onChange,this),onLoadSuccess:$.proxy(function(data){this.input.combobox("clear");if(data.length){this.input.combobox("setValue",data[0].value);this.input.combo("options").panelHeight="auto";this.input.combo("resize");}else{this.concreteUser.prop("disabled",true);}
this.concreteUser.prop("checked",false).change();},this)});this.label=this.input.parent().find("label");this.disableUser=parent.find("input[name=disableuser]:radio");this.disableUser.change($.proxy(function(){var enabled=this.concreteUser.is(":checked");this.input.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");this._onChange();},this));this.concreteUser=this.disableUser.filter("[value=concrete]");this.currentUser=this.disableUser.filter("[value=current]");this._initHelpFor(this.input);},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.input.combobox("textbox")));},valid:function(){return this.concreteUser.is(":checked")?this.input.combobox("isValid"):true;},variants:function(values){this.input.combobox("loadData",values);},val:function(value){if(!arguments.length){return this.concreteUser.is(":checked")?this.input.combobox("getValue"):null;}
if(value!=null){this.input.combobox("setValue",value);this.concreteUser.prop("checked",this.input.combobox("getValue")==value).change();}else{this.currentUser.prop("checked",true).change();}
return this;}});jscape.domain.AmazonSnsTopicPropertyController=jscape.domain.ComboboxPropertyController.extend({cache:{params:null,variants:[]},onLoadVariants:function(){return this._loadVariants();},_loadVariants:function(){var params={domain:this.domainName,partner:this.context.getParameter("Partner")};if(params.partner&&!Object._equals(this.cache.params,params)){return jscape.API.getTradingPartnerAmazonSnsTopics(params.domain,params.partner).done($.proxy(function(variants){this.cache={variants:variants,params:params};},this));}
return $.Deferred().resolve(this.cache.variants);},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.AmazonSnsTopicPropertyView(v,this);}});jscape.domain.AmazonSnsTopicPropertyView=jscape.domain.ComboboxPropertyView.extend({label:null,input:null,initialize:function(parent,listener){this._super(parent,false,{initialized:false,limitToList:false,editable:true,inputEvents:$.extend({},$.fn.combobox.defaults.inputEvents,{focus:function(e){$(e.data.target).combobox("reload");}}),onBeforeLoad:function(){return!!$(this).combobox("options").initialized;},loader:function(_,success,error){var icon=$(this).combobox("getIcon",0);if(listener){icon.removeClass("combo-arrow").addClass("icon-loading");listener.onLoadVariants().done(success).fail(error).always(function(){icon.removeClass("icon-loading").addClass("combo-arrow");icon=null;});}}});this.input.combobox("options").initialized=true;}});jscape.domain.RedwoodProcessPropertyController=jscape.domain.ComboboxPropertyController.extend({cache:{params:null,variants:[]},processes:[],events:"onchange.redwood",onLoadVariants:function(){return this._loadVariants();},onChange:function(_,val){var eventType=this.events;var originalValue=this.context?this.context.getParameter(this.property.id):undefined;var format=$.proxy(this._formatProcessValue,this);$.each(this.processes,function(_,process){if(format(process)===val){$(document).triggerHandler(eventType,[process,val===originalValue]);return false;}});},_formatProcessValue:function(process){return(process.partition?process.partition+".":"")+process.name;},_loadVariants:function(){var params={domain:this.domainName,partner:this.context.getParameter("Partner")};if(params.partner&&!Object._equals(this.cache.params,params)){return jscape.API.getTradingPartnerRedwoodProcesses(params.domain,params.partner).then($.proxy(function(data){this.processes=data||[];return $.map(this.processes,$.proxy(this._formatProcessValue,this));},this)).done($.proxy(function(variants){this.cache={variants:variants,params:params};},this));}
return $.Deferred().resolve(this.cache.variants).promise();},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.LazyComboboxPropertyView(v,this,{limitToList:true});}});jscape.domain.RedwoodProcessAwareController=jscape.domain.PropertyController.extend({process:null,initValue:null,onStart:function(){this._super.apply(this,arguments);this.initValue=this.context.getParameter(this.property.id);$(document).on("onchange.redwood",$.proxy(function(e){var args=Array.prototype.slice.call(arguments,1);this.onProcessChanged.apply(this,args);},this));},onStop:function(){$(document).off(".redwood");this._super.apply(this,arguments);},onProcessChanged:function(process,isInitialValue){this.process=process;}});jscape.domain.RedwoodProcessDescriptionPropertyController=jscape.domain.RedwoodProcessAwareController.extend({onProcessChanged:function(process,isInitialValue){if(this.view&&process){if(!isInitialValue){this.view.val(process.description||this.view.val());}else{this.view.val(this.initValue||process.description);}}},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.StringPropertyView(v,this);}});jscape.domain.RedwoodProcessQueuePropertyController=jscape.domain.RedwoodProcessAwareController.extend({onProcessChanged:function(process,isInitialValue){if(this.view&&process){if(!isInitialValue){this.view.val(process.defaultQueue||this.view.val());}else{this.view.val(this.initValue||process.defaultQueue);}}},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.StringPropertyView(v,this);}});jscape.domain.RedwoodProcessParametersPropertyController=jscape.domain.RedwoodProcessAwareController.extend({onResume:function(){if(this.context&&this.view){if(this.context.hasParameter(this.property.id)){var json=JSON.parse(this.context.getParameter(this.property.id));this.view.val($.map(json,function(val,key){return{name:key,value:val};}));}}},onPause:function(){if(this.view&&this.view.valid()){var value=JSON.stringify(this.view.val());this.context.setParameter(this.property.id,value);}},onChange:function(view){if(this.context){var value=JSON.stringify(view.val());this.context.setParameter(this.property.id,value);}},onProcessChanged:function(process){if(this.view&&process){var params=$.grep(process.jobDefinitionParameters,function(p){return/in/ig.test(p.direction||"");}).sort(function(a,b){return a.order==b.order?0:(a.order>b.order?1:-1);});var current=$.extend({},JSON.parse(this.context.getParameter(this.property.id)),this.view.val()||{});var data=$.map(params,function(param){return $.extend({},param,{value:current[param.name]||param.defaultExpression});});this.view.val(data);}},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.RedwoodProcessParametersView(v,this);}});jscape.domain.RedwoodProcessParametersView=jscape.domain.BasePropertyView.extend({label:null,input:null,editIndex:null,initialize:function(parent){this.input=parent.find("[id][role=grid]");this.label=parent.find("label[for='"+this.input.attr("id")+"']");this.input.datagrid({sortName:"name",singleSelect:true,columns:[[{field:"name",title:$("thead th:nth-child(1)",this.input).text(),sortable:true,width:"20%"},{field:"description",title:$("thead th:nth-child(2)",this.input).text(),resizable:false,width:"30%"},{field:"value",title:$("thead th:nth-child(3)",this.input).text(),editor:{type:"textbox",options:{required:true}},resizable:false,width:"50%"}]],onBeginEdit:$.proxy(this._onEdit$Begin,this),onEndEdit:$.proxy(this.onEdit$End,this),onAfterEdit:$.proxy(this._onChange,this),onClickRow:$.proxy(this._onClick$Row,this),onDblClickRow:$.proxy(this._onDblClick$Row,this),width:"auto"});this._initHelpFor(this.input);},show:function(){this._super.apply(this,arguments);this.editIndex=-1;this.input.datagrid("resize",{width:"95%",minWidth:300,minHeight:200});},collide:function(){return this.label.is(":visible")&&this._collide(this._aabb(this.label),this._aabb(this.input.datagrid("getPanel")));},valid:function(){this.input.datagrid("acceptChanges");return true;},val:function(value){if(!arguments.length){this.input.datagrid("acceptChanges");var ret={};$.each(this.input.datagrid("getRows"),function(_,row){ret[row.name]=row.value;});return ret;}
var data=$.map(value,$.proxy(function(param){return{name:param.name,description:param.description||param.dataType,value:param.value,editor:this._editorFor(param.dataType,!param.nullable)};},this));this.input.datagrid("loading").datagrid("loadData",data).datagrid("loaded");return this;},_editorFor:function(type,required){type=(""+type).toLowerCase();switch(type){case"boolean":return{type:"combobox",options:{editable:false,multivalue:false,limitToList:true,data:[{text:"true",value:true},{text:"false",value:false}],panelHeight:"auto"}};case"number":case"int":return{type:"numberbox",options:{required:required}};default:return{type:"textbox",options:{required:required}};}},_onClick$Row:function(index,row){if(this.editIndex==index){this.input.datagrid("endEdit",index);}},_onDblClick$Row:function(index){if(this.editIndex!=index&&this.editIndex>=0){this.input.datagrid("endEdit",this.editIndex);}
this.input.datagrid("beginEdit",index);},_onEdit$Begin:function(index){var grid=this.input;var ed=grid.datagrid("getEditor",{index:index,field:"value"});if(!!ed&&ed.target){this.editIndex=index;var t=$(ed.target);var input;if(t.data("textbox")){input=t.textbox("textbox");}else if(t.data("numberbox")){input=t.numberbox("textbox");}
if(input&&input.length){var self=this;setTimeout(function(){input.unbind(".processparameters").bind("keydown.processparameters",function(e){if(e.keyCode==13){if($(this).val()){self.editIndex=-1;grid.datagrid("endEdit",index);}else{grid.datagrid("cancelEdit",index);}
return false;}else if(e.keyCode==27){grid.datagrid("cancelEdit",index);return false;}
self=grid=null;});},0);input.focus();}}},onEdit$End:function(index){this.editIndex=-1;}});jscape.domain.ActiveBatchJobPropertyController=jscape.domain.ComboboxPropertyController.extend({cache:{params:null,variants:[]},values:[],onStart:function(){this._super.apply(this,arguments);this.initValue=this.context.getParameter(this.property.id);$(document).on("onchange.partnername",$.proxy(function(e){var args=Array.prototype.slice.call(arguments,1);this.onPartnerChanged.apply(this,args);},this));},onStop:function(){$(document).off("onchange.partnername");this._super.apply(this,arguments);},onLoadVariants:function(){return this._loadVariants();},onPartnerChanged:function(val){this.view.reset();},onChange:function(_,val){var originalValue=this.context?this.context.getParameter(this.property.id):undefined;var format=$.proxy(this._formatValue,this);$.each(this.values,function(_,value){if(format(value)===val){$(document).triggerHandler("onchange.activebatch",[value,val===originalValue]);return false;}});},_formatValue:function(value){return value;},_loadVariants:function(){var params={domain:this.domainName,partner:this.context.getParameter("Partner")};if(params.partner&&!Object._equals(this.cache.params,params)){return jscape.API.getTradingPartnerActiveBatchJobs(params.domain,params.partner).then($.proxy(function(data){this.values=data||[];return $.map(this.values,$.proxy(this._formatValue,this));},this)).done($.proxy(function(variants){this.cache={variants:variants,params:params};},this));}
return $.Deferred().resolve(this.cache.variants).promise();},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.LazyComboboxPropertyView(v,this,{limitToList:true});}});jscape.domain.ActiveBatchJobQueuePropertyController=jscape.domain.PropertyController.extend({job:null,initValue:null,onStart:function(){this._super.apply(this,arguments);this.initValue=this.context.getParameter(this.property.id);$(document).on("onchange.activebatch",$.proxy(function(e){var args=Array.prototype.slice.call(arguments,1);this.onJobChanged.apply(this,args);},this));},onStop:function(){$(document).off(".activebatch");this._super.apply(this,arguments);},onJobChanged:function(job,isInitialValue){if(this.view&&job){if(!isInitialValue){this.view.val(job.defaultQueue||this.view.val());}else{this.view.val(this.initValue||job.defaultQueue);}}},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.StringPropertyView(v,this);}});jscape.domain.TidalJobPropertyController=jscape.domain.ComboboxPropertyController.extend({cache:{params:null,variants:[]},values:[],initialize:function(namespace,options){this._super();this.namespace=namespace.startsWith(".")?namespace.substr(1):namespace;this.format=options&&typeof options.format==="function"?options.format:function(val){return val;};this.sorter=options&&typeof options.sorter==="function"?options.sorter:undefined;},onStart:function(){this._super.apply(this,arguments);this.initValue=this.context.getParameter(this.property.id);$(document).on("onchange.partnername",$.proxy(function(e){var args=Array.prototype.slice.call(arguments,1);this.onPartnerChanged.apply(this,args);},this));},onStop:function(){$(document).off("onchange.partnername");this._super.apply(this,arguments);},onLoadVariants:function(){return this._loadVariants();},onPartnerChanged:function(val){this.view.reset();},onChange:function(_,val){var originalValue=this.context?this.context.getParameter(this.property.id):undefined;var format=this.format;var namespace=this.namespace;$.each(this.values,function(_,value){if(format(value)===val){$(document).triggerHandler("onchange."+namespace,[value,val===originalValue]);return false;}});},_loadVariants:function(){var params={domain:this.domainName,partner:this.context.getParameter("Partner")};if(params.partner&&!Object._equals(this.cache.params,params)){return jscape.API.getTradingPartnerTidalJobs(params.domain,params.partner).then($.proxy(function(data){this.values=data||[];this.values.sort(this.sorter);return this.values;},this)).done($.proxy(function(variants){this.cache={variants:variants,params:params};},this));}
return $.Deferred().resolve(this.cache.variants).promise();},_createView:function(property,dialog){var v=this._addFieldView(property,dialog);return new jscape.domain.LazyComboboxPropertyView(v,this,{limitToList:true,textField:"name",valueField:"id"});}});jscape.domain.ConsumerPropertyController=jscape.domain.PropertyController.extend({linkedValue:null,initValue:null,initialize:function(base,namespace,options){this.base=base;this.namespace=namespace.startsWith(".")?namespace.substr(1):namespace;this.format=options&&typeof options.format==="function"?options.format:function(val){return val;};},onStart:function(){this._super.apply(this,arguments);this.initValue=this.context.getParameter(this.property.id);$(document).on("onchange."+this.namespace,$.proxy(this.onChangeValue,this));},onStop:function(){$(document).off("onchange."+this.namespace);this._super.apply(this,arguments);},onChangeValue:function(e,newValue,isInitialValue){if(this.view&&newValue){var val=this._formatValue(newValue);if(!isInitialValue){this.view.val(val||this.view.val());}else{this.view.val(this.initValue||val);}}},_formatValue:function(value){return this.format.call(this,value);},_createView:function(property,dialog){return this.base._createView(property,dialog);}});