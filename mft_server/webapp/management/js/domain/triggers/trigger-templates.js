/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.TriggerTemplate=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){this.name=a||"";this.type=b||jscape.TriggerTemplate.Type.USER;this.description=c||"";this.eventClassName=d||null;this.expressionString=e||"";this.onStartActions=f||[];this.onFinishActions=g||[];this.onSuccessActions=h||[];this.onFailureActions=i||[];this.errorEventAllowed=!!j;this.asynchronous=!!k;this.singleInstanceRequired=!!l;this.singleInstanceMode=m||jscape.Trigger.SingleInstanceMode.QUEUED;this.ignoredDomainState=n||null;this.uiLayoutData=o||{};this.tags=p||[];},clone:function(){return jscape.TriggerTemplate.fromJSON(this.toJSON());},toJSON:function(){var obj=$.extend({},this);try{obj.uiLayoutData=JSON.stringify(this.uiLayoutData);}catch(e){delete obj.uiLayoutData;}
return obj;}});jscape.TriggerTemplate.fromJSON=function(data){var layoutData=null;try{layoutData=JSON.parse(data.uiLayoutData);}catch(ignored){}
return data?$.extend(new jscape.TriggerTemplate(),data,{onStartActions:$.map(data.onStartActions,jscape.ActionEntry.fromJSON),onFinishActions:$.map(data.onFinishActions,jscape.ActionEntry.fromJSON),onSuccessActions:$.map(data.onSuccessActions,jscape.ActionEntry.fromJSON),onFailureActions:$.map(data.onFailureActions,jscape.ActionEntry.fromJSON),uiLayoutData:layoutData||{}}):null;};jscape.TriggerTemplate.Type={SYSTEM:"SYSTEM_MANAGED",USER:"USER_MANAGED"};jscape.ActionEntry=Class.extend({initialize:function(a,b,c,d,e,f,g){this.id=a||"";this.name=b||"";this.className=c||null;this.actionClass=this.className;this.parameters=d||{};this.notes=e||"";this.onSuccessActions=$.map(f||[],jscape.ActionEntry.fromJSON);this.onFailureActions=$.map(g||[],jscape.ActionEntry.fromJSON);},hasParameter:function(name){return this.parameters.hasOwnProperty(name);},getParameterNames:function(){return $.map(this.parameters,function(_,name){return name;});},getParameter:function(name){if(this.hasParameter(name)){var value=this.parameters[name];if(/^(true|false)$/i.test(value)){return"true"===value.toLowerCase();}else if(/^null$/.test(value)){return null;}else if(/\d+/.test(value)){var num=Number(value);return isNaN(num)?value:num;}else{return value;}}
return null;},setParameter:function(name,value){this.parameters[name+""]=value!=null?value+"":null;},toJSON:function(){var obj=$.extend({},this);delete obj.actionClass;return obj;}});jscape.ActionEntry.fromJSON=function(data){return data?new jscape.ActionEntry(data.id,data.name,data.className,data.parameters,data.notes,data.onSuccessActions,data.onFailureActions):null;};jscape.TriggerTemplateSummary=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i){this.name=a||"";this.templateType=b||jscape.TriggerTemplate.Type.USER;this.eventType=c||"";this.expressionString=d||"";this.onStartActions=e||[];this.onFinishActions=f||[];this.onSuccessActions=g||[];this.onFailureActions=h||[];this.tags=i||[];},manageable:function(){return jscape.TriggerTemplate.Type.USER===this.templateType;}});jscape.TriggerTemplateSummary.fromJSON=function(data){return data?new jscape.TriggerTemplateSummary(data.name,data.templateType,data.eventType,data.expressionString,data.onStartActions,data.onFinishActions,data.onSuccessActions,data.onFailureActions,data.tags):null;};jscape.domain.TriggerTemplatesController=jscape.ui.DatagridController.extend({view:null,initialize:function(actions,functions){this.actions=[].concat(actions||[]);this.functions=[].concat(functions||[]);this.addController=new jscape.domain.AddTriggerTemplateController();this.editController=new jscape.domain.EditTriggerTemplateController();this.copyController=new jscape.domain.CopyTriggerTemplateController();this.deleteController=new jscape.domain.DeleteTriggerTemplateController();this.importController=new jscape.domain.ImportTriggerTemplateController();this.exportController=new jscape.domain.ExportTriggerTemplateController();this.promoteController=new jscape.domain.PromoteTriggerTemplateController();this._initValidators();},start:function(domainName){this.domainName=domainName;if(this.view==null){this.view=new jscape.domain.TriggerTemplatesView(this.actions);}
this.view.show(this);this.onLoadTriggerOperationContext(this.actions,this.functions).done($.proxy(function(context){this.operationContext=context;},this));},stop:function(){},pause:function(){},resume:function(){this.view.refresh();},onLoadTriggerOperationContext:function(actions,functions){return $.when(jscape.API.getTriggerEvents(this.domainName),jscape.API.getTriggerOperators(this.domainName),jscape.API.getTriggerProperties(this.domainName)).then(function(events,operators,properties){return new jscape.TriggerOperationContext(events,actions,functions,operators,properties);},function(){return new jscape.TriggerOperationContext(undefined,actions,functions);});},onLoadTemplates:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listTriggerTemplates(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onImportTemplate:function(data){return this.importController.start(this.domainName,data).always($.proxy(function(){this.view.refresh();},this));},onExportTemplate:function(templates){var names=$.map(templates,function(template){return template.name;});return this.exportController.start(this.domainName,names);},onPromoteTemplate:function(templates){var names=$.map(templates,function(template){return template.name;});return this.promoteController.start(this.domainName,names).done($.proxy(this._fireApplySuccess,this));},onAddTemplate:function(){return this.addController.start(this.domainName,this.operationContext).done($.proxy(this._templateAdded,this));},onEditTemplate:function(template,force){var index=$.inArray(template,this.view.getTemplates());if(index!=-1||force===true){this.editController.start(this.domainName,template,this.operationContext).done($.proxy(this._templateEdited,this,index));}},onCopyTemplate:function(template){this.copyController.start(this.domainName,template).done($.proxy(this._templateCopied,this));},onDeleteTemplate:function(templates){this.deleteController.start(this.domainName,templates).done($.proxy(this._templateDeleted,this,templates)).done($.proxy(this._fireApplySuccess,this));},onTriggerEventTypes:function(){var events=$.map(this.operationContext.events,function(entry){return{text:entry.name,value:entry.type};});return $.Deferred().resolve(events).promise();},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},_templateAdded:function(template){this._recordAdded(template);},_templateEdited:function(index,template){this._recordEdited(template);},_templateCopied:function(template,editAfterDone){if(editAfterDone){this.view.refresh($.proxy(function(){this.view.selectRecord(template);this.onEditTemplate(template,true);},this));}else{this._templateAdded(template);}},_templateDeleted:function(templates){this._recordDeleted(templates);},_initValidators:function(){var v=new jscape.Validator();v.rule("trigger_template_unique",$.proxy(this._templateNotExists,this),window.R.string.TRIGGERS_ERROR_TEMPLATE_ALREADY_EXISTS);},_templateNotExists:function(name){var names=$.map(this.view.getTemplates(),function(template){return template.name;});return $.inArray(name,names)==-1;}});jscape.domain.TriggerTemplatesView=jscape.ui.DatagridView.extend({selection:null,initialize:function(actions){var initializing=true;this.actions=actions||[];this.fieldset=$("#domain-trigger-templates-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=templates]",this.fieldset);this.data.datagrid({fit:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"12%"},{field:"eventType",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"13%",finder:{type:"combobox",options:{loader:$.proxy(this._onLoad$EventTypes,this),editable:true,limitToList:true,width:200,panelWidth:"auto",panelMaxWidth:"50%",panelHeight:"auto",panelMaxHeight:"50%"}},formatter:$.proxy(this._formatEvent,this),sorter:$.proxy(this._sortEvent,this)},{field:"templateType",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"10%",formatter:$.proxy(this._formatType,this),finder:{type:"combobox",options:{data:$.map([jscape.TriggerTemplate.Type.SYSTEM,jscape.TriggerTemplate.Type.USER],$.proxy(function(value){return{text:this._formatType(value),value:value};},this)),panelHeight:"auto"}}},{field:"expressionString",title:$("thead th:nth-child(4)",this.data).text(),sortable:false,searchable:false,width:"30%"},{field:"actions",title:$("thead th:nth-child(5)",this.data).text(),sortable:false,searchable:false,width:"25%",formatter:$.proxy(function(_,rowData){return this._formatActions(rowData,this.actions);},this)},{field:"tags",title:$("thead th:nth-child(6)",this.data).text(),width:"10%",finder:{type:"combobox",options:{loader:$.proxy(this._onLoad$Tags,this),panelHeight:"auto",panelMaxHeight:"50%"}},formatter:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();}}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),onLoadSuccess:$.proxy(this._onLoadSuccess$Data,this)});this._initDragAndDrop(this.data.datagrid("getPanel"));this.importButton=$("a[role=button][name=import]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ImportButton,this)});this.exportButton=$("a[role=button][name=export]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExportButton,this)});this.promoteButton=$("a[role=button][name=promote]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$PromoteButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.copyButton=$("a[role=button][name=copy]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.TriggerTemplatesView.LISTENER;this.data.datagrid("resize").datagrid("reload");this._adjustState();},getTemplates:function(){return this.getRecords();},_formatEvent:function(value){return jscape.domain.TriggersModule.displayClassNameOf(value).escapeXml();},_sortEvent:function(a,b){a=jscape.domain.TriggersModule.displayClassNameOf(a);b=jscape.domain.TriggersModule.displayClassNameOf(b);return a==b?0:(a>b?1:-1);},_formatType:function(type){var key=("TRIGGER_TEMPLATES_TYPE_"+type).toLocaleUpperCase();return window.R.string[key]||type;},_formatActions:function(template,actions){function _str(actionContexts,color){return actionContexts.length?'<span style="color:'+color+'">'
+$.map(actionContexts,function(entry){return jscape.domain.TriggersModule.actionDisplayNameOf(entry,actions).escapeXml();}).join(", ")
+'</span>':"";}
return $.grep([_str(template.onStartActions,"green"),_str(template.onFinishActions,"red"),_str(template.onSuccessActions,"green"),_str(template.onFailureActions,"red")],function(entry){return!!entry;}).join(", ");},_onLoad$Data:function(params,success,error){this.listener.onLoadTemplates(params).then(success,error);},_onLoadSuccess$Data:function(){this._adjustState();this.data.datagrid("autoSizeColumn","name");},_onLoad$EventTypes:function(params,success,error){this.listener.onTriggerEventTypes(params).then(success,error);},_onLoad$Tags:function(params,success,error){this.listener.onLoadTags(params).then(success,error);},_onClick$ImportButton:function(data){this.importButton.linkbutton("disable");this.listener.onImportTemplate(data).always($.proxy(function(){this.importButton.linkbutton("enable");},this));},_onClick$ExportButton:function(){this.exportButton.linkbutton("disable");this.listener.onExportTemplate(this.selection).always($.proxy(function(){this.exportButton.linkbutton("enable");},this));},_onClick$PromoteButton:function(){this.promoteButton.linkbutton("disable");this.listener.onPromoteTemplate(this.selection).always($.proxy(function(){this.promoteButton.linkbutton("enable");},this));},_onClick$AddButton:function(){this.listener.onAddTemplate();},_onClick$EditButton:function(){this.listener.onEditTemplate(this.selection[0]);},_onClick$CopyButton:function(){this.listener.onCopyTemplate(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteTemplate(this.selection);},_createDropArea:function(e){this._super(e,window.R.string.TRIGGERS_IMPORT_TEMPLATE_TITLE);},_onDrop:function(e){this._onClick$ImportButton(e.originalEvent.dataTransfer);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.copyButton,this.deleteButton,"-",this.importButton,this.exportButton,this.promoteButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");var manageable=this.selection.length!=0;$.each(this.selection,function(_,template){if(!template.manageable()){manageable=false;return false;}});this.exportButton.linkbutton(this.selection.length!=0?"enable":"disable");this.promoteButton.linkbutton(this.selection.length!=0?"enable":"disable");this.editButton.linkbutton(this.selection.length==1&&manageable?"enable":"disable");this.copyButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(manageable?"enable":"disable");}});jscape.domain.AddTriggerTemplateController=jscape.domain.DefaultTriggerController.extend({deferred:null,start:function(domainName,operationContext){this.domainName=domainName;this.operationContext=operationContext;this.template=new jscape.TriggerTemplate();this.eventType=null;this.index=-1;this.deferred=$.Deferred();var dialog=this._setupDialog(this.template).show(this);dialog.setCurrentItem(this.parametersController);return this.deferred.promise();},hasChanged:function(){return true;},onSubmit:function(dialog){var template=this._updateTrigger(dialog,this.template);return jscape.API.addTriggerTemplate(this.domainName,template).done($.proxy(function(template){this.deferred.resolve(template);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(template){var dialog=new jscape.domain.AddTriggerTemplateDialog();this.parametersController=dialog.addItem(new jscape.domain.AddTriggerTemplateParametersController(dialog));this.parametersController.start(this.domainName,template,this.operationContext);this.expressionController=dialog.addItem(new jscape.domain.AddTriggerTemplateExpressionController(dialog));this.expressionController.start(this.domainName,template,this.operationContext);this.actionsController=dialog.addItem(new jscape.domain.AddTriggerTemplateActionsController(dialog));this.actionsController.start(this.domainName,template,this.operationContext);return dialog;},_updateTrigger:function(dialog,template){this.parametersController.updateTriggerTemplate(template);this.expressionController.updateTriggerTemplate(template);this.actionsController.updateTriggerTemplate(template);return template;}});jscape.domain.EditTriggerTemplateController=jscape.domain.DefaultTriggerController.extend({deferred:null,start:function(domainName,template,operationContext){this.domainName=domainName;this.operationContext=operationContext;this.eventType=null;this.index=-1;this.deferred=$.Deferred();jscape.API.getTriggerTemplate(this.domainName,template.name).done($.proxy(function(template){this.template=template;var dialog=this._setupDialog(template).show(this);dialog.setCurrentItem(this.parametersController);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},hasChanged:function(dialog){return this.parametersController.hasChanged(dialog)||this.expressionController.hasChanged(dialog)||this.actionsController.hasChanged(dialog);},onSubmit:function(dialog){var template=this._updateTrigger(dialog,this.template);return jscape.API.storeTriggerTemplate(this.domainName,template.name,template).done($.proxy(function(template){this.deferred.resolve(template);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(template){var dialog=new jscape.domain.EditTriggerTemplateDialog();dialog.setTemplateName(template.name);this.parametersController=dialog.addItem(new jscape.domain.EditTriggerTemplateParametersController(dialog));this.parametersController.start(this.domainName,template,this.operationContext);this.expressionController=dialog.addItem(new jscape.domain.EditTriggerTemplateExpressionController(dialog));this.expressionController.start(this.domainName,template,this.operationContext);this.actionsController=dialog.addItem(new jscape.domain.EditTriggerTemplateActionsController(dialog));this.actionsController.start(this.domainName,template,this.operationContext);return dialog;},_updateTrigger:function(dialog,template){this.parametersController.updateTriggerTemplate(template);this.expressionController.updateTriggerTemplate(template);this.actionsController.updateTriggerTemplate(template);return template;}});jscape.domain.AddTriggerTemplateDialog=jscape.domain.DefaultTriggerDialog.extend({initialize:function(){this._super($("#d-triggertemplates-add"));}});jscape.domain.EditTriggerTemplateDialog=jscape.domain.DefaultTriggerDialog.extend({initialize:function(){this._super($("#d-triggertemplates-edit"));},setTemplateName:function(value){this.name=value||"";},_adjustDialogTitle:function(){this.dialog.dialog("setTitle",this.title.supplant({0:this.name}));}});jscape.domain.TriggerTemplateParametersController=Class.extend({copy:null,initialize:function(view){this.view=view;},start:function(domainName,template,operationContext){this.domainName=domainName;this.template=template;this.copy=template.clone();this.events=operationContext.events||[];this.view.setListener(this);this.setupView(template);},pause:function(){this.updateTriggerTemplate(this.template);this.view.hide();},resume:function(){this.view.show();this.setupView(this.template);},validate:function(){return!this.view.valid()?$.Deferred().reject({valid:false,message:window.R.string.TRIGGER_ERROR_PARAMETERS_TEST_FAILED}).promise():$.Deferred().resolve({valid:true}).promise();},hasChanged:function(dialog){return this.copy&&!Object._equals(this.copy,$.extend({},this.copy,this._createParameters()));},updateTriggerTemplate:function(template){$.extend(template,this._createParameters());},setupView:function(template){if(!!template){this.view.setDescription(template.description);this.view.setEvent(template.eventClassName);this.view.setFireError(template.errorEventAllowed);this.view.setTriggerAsynchronous(template.asynchronous);this.view.setSingleInstanceRequired(template.singleInstanceRequired);this.view.setSingleInstanceMode(template.singleInstanceMode);this.view.setIgnoredDomainState(template.ignoredDomainState);this.view.setTags(template.tags);}},_createParameters:function(){return{description:this.view.getDescription(),eventClassName:this.view.getEvent()!=null?this.view.getEvent().type:undefined,errorEventAllowed:!!this.view.isFireError(),asynchronous:!!this.view.isTriggerAsynchronous(),singleInstanceRequired:!!this.view.isSingleInstanceRequired(),singleInstanceMode:this.view.getSingleInstanceMode(),ignoredDomainState:this.view.getIgnoredDomainState(),tags:this.view.getTags()};},onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},onLoadEvents:function(){return $.Deferred().resolve(this.events).promise();}});jscape.domain.AddTriggerTemplateParametersController=jscape.domain.TriggerTemplateParametersController.extend({initialize:function(dialog){this._super(new jscape.domain.AddTriggerTemplateParametersView(dialog));},pause:function(){this._super();this.template.name=this.view.getName();},resume:function(){this._super();this.view.setName(this.template.name);},_createParameters:function(){return $.extend(this._super.apply(this,arguments),{name:this.view.getName()});}});jscape.domain.AddTriggerTemplateParametersView=jscape.domain.TriggerParametersView.extend({initialize:function(dialog){this._super($("#d-trigger-templates-add-parameters-content"+dialog.getIdSuffix()),dialog);this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["trigger_template_unique","non_empty"],missingMessage:window.R.string.TRIGGERS_ERROR_BAD_TEMPLATE_NAME,invalidMessage:window.R.string.TRIGGERS_ERROR_BAD_TEMPLATE_NAME,width:"60%"});},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value);}});jscape.domain.EditTriggerTemplateParametersController=jscape.domain.TriggerTemplateParametersController.extend({initialize:function(container){this._super(new jscape.domain.EditTriggerTemplateParametersView(container));}});jscape.domain.EditTriggerTemplateParametersView=jscape.domain.TriggerParametersView.extend({initialize:function(dialog){this._super($("#d-trigger-templates-edit-parameters-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.TriggerTemplateExpressionController=jscape.domain.TriggerExpressionController.extend({start:function(domainName,template,operationContext){this.domainName=domainName;this.template=template;this.copy=template.expression||"";this.operationContext=operationContext;this.eventType=template.eventClassName;this.eventProperties=null;this.view.setListener(this);this.setupView(template);},hasChanged:function(dialog){return!Object._equals(this.copy,this.view.getExpression());},updateTriggerTemplate:function(template){if(this._eventTypeLoaded(template.eventType)){template.expressionString=this.view.getExpression();}},setupView:function(template){var eventType=template.eventClassName;if(!!this.loading||!eventType||this._eventTypeLoaded(eventType)){return;}
this.loading=jscape.API.getTriggerEvent(this.domainName,eventType).done($.proxy(function(properties){this.loading=null;this.eventType=eventType;this.eventProperties=properties||[];this._setupView(template.expressionString,eventType);},this)).fail($.proxy(function(){this.loading=null;},this));},pause:function(){this.updateTriggerTemplate(this.template);this.view.hide();},resume:function(){this.view.show(this);this.setupView(this.template);},validate:function(){var expression=this.view.getExpression()||this.template.expressionString;return this._validateExpression(expression,this.eventType);}});jscape.domain.AddTriggerTemplateExpressionController=jscape.domain.TriggerTemplateExpressionController.extend({initialize:function(dialog){this._super(new jscape.domain.AddTriggerTemplateExpressionView(dialog));}});jscape.domain.AddTriggerTemplateExpressionView=jscape.domain.TriggerExpressionView.extend({initialize:function(dialog){this._super($("#d-trigger-templates-add-expression-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.EditTriggerTemplateExpressionController=jscape.domain.TriggerTemplateExpressionController.extend({initialize:function(dialog){this._super(new jscape.domain.EditTriggerTemplateExpressionView(dialog));}});jscape.domain.EditTriggerTemplateExpressionView=jscape.domain.TriggerExpressionView.extend({initialize:function(dialog){this._super($("#d-trigger-templates-edit-expression-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.BaseTriggerTemplateActionController=jscape.domain.BaseTriggerActionController.extend({onSubmit:function(dialog){$.each(this.controllers,function(_,controller){controller.onPause();});return jscape.API.validateTriggerTemplateAction(this.domainName,this.actionContext,this.eventType).done($.proxy(function(){$.each(this.controllers,$.proxy(function(_,controller){controller.onStop(dialog);},this));this.deferred.resolve(this.actionContext);this.deferred=null;},this)).fail($.proxy(function(){$.each(this.controllers,function(_,controller){controller.onResume();});},this));}});jscape.domain.AddTriggerTemplateActionController=jscape.domain.BaseTriggerTemplateActionController.extend({start:function(domainName,types,functions,variables,links,eventType,actionClass){this.domainName=domainName;this.functions=functions||[];this.variables=variables||[];this.links=links||[];this.eventType=eventType;this.deferred=$.Deferred();this._selectActionType(types,actionClass).then($.proxy(function(action){this.actionName=action.displayName;this.actionClass=action.actionClass;return jscape.API.createTriggerTemplateActionEntry(this.domainName,this.actionClass);},this)).then($.proxy(function(actionEntry){this.actionContext=actionEntry;return jscape.API.getTriggerActionProperties(this.domainName,this.actionClass);},this)).done($.proxy(function(properties){this._createActionDialog(properties).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_selectActionType:function(types,actionClass){var deferred=$.Deferred();var index=!!actionClass?$.inArray(actionClass,$.map(types,function(t){return t.actionClass;})):-1;if(index!=-1){deferred.resolve(types[index]);}else{var dialog=new jscape.domain.TriggerActionTypeDialog();dialog.setActions(types);dialog.show({onSubmit:$.proxy(function(d){var action=d.getAction();d.destroy();deferred.resolve(action);},this),onCancel:$.proxy(function(d){d.destroy();deferred.reject();},this)});}
return deferred.promise();},_createActionDialog:function(properties){this.controllers=[];var dialog=new jscape.domain.AddTriggerActionDialog();dialog.setActionName(this.actionName);var nameController=new jscape.domain.ActionNameController(dialog,this.actionContext);nameController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(nameController);var notesController=new jscape.domain.ActionNotesController(dialog);notesController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(notesController);$.each(properties,$.proxy(function(_,property){var controller=this._createControllerFor(property.field);controller.onCreate(this.domainName,property,this.actionContext);this.controllers.push(controller);},this));for(var i=0,len=this.controllers.length;i<len;++i){var c=this.controllers[i];c.onStart(dialog);c.onResume();}
return dialog.finish();}});jscape.domain.EditTriggerTemplateActionController=jscape.domain.BaseTriggerTemplateActionController.extend({start:function(domainName,actions,functions,variables,links,eventType,actionContext,actionDisplayName){this.domainName=domainName;this.functions=functions||[];this.variables=variables||[];this.links=links||[];this.eventType=eventType;this.deferred=$.Deferred();this._selectActionType(actions,actionContext.className).then($.proxy(function(action){this.actionClass=action.actionClass;this.actionName=action.displayName||actionDisplayName;return $.extend(true,new jscape.ActionEntry(),actionContext);},this)).then($.proxy(function(context){this.actionContext=context;return jscape.API.getTriggerActionProperties(this.domainName,context.actionClass);},this)).done($.proxy(function(properties){this._createActionDialog(properties).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_createActionDialog:function(properties){this.controllers=[];var dialog=new jscape.domain.EditTriggerActionDialog();dialog.setActionName(this.actionName);var nameController=new jscape.domain.ActionNameController(dialog,this.actionContext);nameController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(nameController);var notesController=new jscape.domain.ActionNotesController(dialog);notesController.onCreate(this.domainName,null,this.actionContext);this.controllers.push(notesController);$.each(properties,$.proxy(function(_,property){var controller=this._createControllerFor(property.field);controller.onCreate(this.domainName,property,this.actionContext);this.controllers.push(controller);},this));for(var i=0,len=this.controllers.length;i<len;++i){var c=this.controllers[i];c.onStart(dialog);c.onResume();}
return dialog.finish();}});jscape.domain.TriggerTemplateActionsController=Class.extend({copy:null,initialize:function(view){this.view=view;this.addController=new jscape.domain.AddTriggerTemplateActionController();this.editController=new jscape.domain.EditTriggerTemplateActionController();this._initValidators();},start:function(domainName,template,operationContext){this.domainName=domainName;this.template=template;this.copy=template.clone();this.operationContext=operationContext;this.allowedActions=$.map(operationContext.actions,function(action){return action.actionClass;});this.eventType=null;this.variables=[];this.view.setListener(this);this.setupView(template);},hasChanged:function(dialog){return this._hasOrphanActions()||!Object._equals(this.copy.uiLayoutData,this.view.getLayoutData())||!Object._equals(this.copy,$.extend({},this.copy,this._createTriggerActionContext(this.rootId)));},pause:function(completed){!completed&&this.view.hide();this.updateTriggerTemplate(this.template);},resume:function(){this.view.show();this.setupView(this.template);},validate:function(){if(!this.template.name){return $.Deferred().resolve().promise();}
return this._confirmOrphanActions().then($.proxy(function(){var template=this.template.clone();this.updateTriggerTemplate(template);return jscape.API.validateTriggerTemplateActions(this.domainName,template.name,template).catch(function(r){return $.Deferred().reject($.extend({valid:false},(r&&r.responseJSON)||{}));});},this));},updateTriggerTemplate:function(template){if(!!this.flow){var rootId=this.flow.getRootId();var actionContext=this._createTriggerActionContext(rootId);$.extend(template,actionContext,{uiLayoutData:this.view.getLayoutData()});}},onAddAction:function(actionClass){return this.addController.start(this.domainName,this.operationContext.actions,this.operationContext.functions,this.variables,this._operators2Links(this.view.getOperatorsData()),this.eventType,actionClass).then($.proxy(function(context){var title=jscape.domain.TriggersModule.actionDisplayNameOf(context.actionClass,this.operationContext.actions);this.view.addOperator(context.id,context,title);return $.Deferred().resolve(context.id).promise();},this));},onCopyAction:function(context){if(!this._isActionAllowed(context)){this._showOperationNotAllowed();return $.Deferred().reject().promise();}
return jscape.API.createTriggerTemplateActionEntry(this.domainName,context.className).then($.proxy(function(copy){$.each(context.getParameterNames(),function(_,name){copy.setParameter(name,context.getParameter(name));});copy.notes=context.notes;var title=jscape.domain.TriggersModule.actionDisplayNameOf(context.actionClass,this.operationContext.actions);return $.Deferred().resolve(copy,title).promise();},this));},onCopyActionId:function(context){return new jscape.CopyToClipboardController().start(context.id);},onEditAction:function(context,title){if(!this._isActionAllowed(context)){this._showOperationNotAllowed();return $.Deferred().reject().promise();}
return this.editController.start(this.domainName,this.operationContext.actions,this.operationContext.functions,this.variables,this._operators2Links(this.view.getOperatorsData()),this.eventType,context,title);},onDeleteAction:function(context,title){if(!this._isActionAllowed(context)){this._showOperationNotAllowed();return $.Deferred().reject().promise();}
return this._confirmDeleteAction(title);},_confirmOrphanActions:function(){return this._hasOrphanActions()?jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_ORPHAN_ACTION_TITLE,window.R.string.TRIGGERS_CONFIRM_ORPHAN_ACTION_MESSAGE):$.Deferred().resolve().promise();},_confirmDeleteAction:function(action){return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_DELETE_ACTION_TITLE,window.R.string.TRIGGERS_CONFIRM_DELETE_ACTION_MESSAGE.supplant({0:action}));},_showOperationNotAllowed:function(){return $.messager.alert(window.R.string.APPLICATION_TITLE,window.R.string.NO_PERMISSIONS,"error");},_hasOrphanActions:function(){return this.flow&&this.flow.hasOrphanActions(this.view.getData());},setupView:function(template){var eventType=template.eventClassName;if(!!this.loading||!eventType||this.eventType==eventType){return;}
this.loading=jscape.API.getTriggerEvent(this.domainName,eventType).done($.proxy(function(properties){this.loading=null;this.eventType=eventType;this.variables=this._propertiesToVariables(properties.concat(this.operationContext.properties));this.rootId=this._triggerActionFlowFor(template).getRootId();this.view.createWorkflow(this.rootId);this._traverseActionFlow(template.onStartActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.START);this._traverseActionFlow(template.onFinishActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.FINISH);this._traverseActionFlow(template.onSuccessActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.SUCCESS);this._traverseActionFlow(template.onFailureActions,this.rootId,jscape.domain.TriggerActionFlow.Connector.FAILURE);this.view.setLayoutData(template.uiLayoutData);this.copy.uiLayoutData=$.extend(true,{},this.view.getLayoutData());},this)).fail($.proxy(function(){this.loading=null;},this));},_triggerActionFlowFor:function(trigger){if(!!this.flow){this.view.unsubscribe(this.flow);}
if(!this.flow){this.flow=new jscape.domain.TriggerActionFlow(this._rootIdForLayout((trigger?trigger.uiLayoutData:{})));}
this.view.subscribe(this.flow);return this.flow;},_traverseActionFlow:function(actionContexts,parentId,parentConnector){$.each(actionContexts||[],$.proxy(function(_,context){var id=context.id;if(!this.view.containsOperator(id)){this.view.addOperator(id,context,jscape.domain.TriggersModule.actionDisplayNameOf(context.actionClass,this.operationContext.actions));this.view.setOperatorEnabled(id,this._isActionAllowed(context));this.view.addLink(parentId,parentConnector,id,jscape.domain.TriggerActionFlow.Connector.EXECUTE);}
this._traverseActionFlow(context.onSuccessActions,id,jscape.domain.TriggerActionFlow.Connector.SUCCESS);this._traverseActionFlow(context.onFailureActions,id,jscape.domain.TriggerActionFlow.Connector.FAILURE);},this));},_createTriggerActionContext:function(rootId){return{onStartActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.START,jscape.domain.TriggerActionFlow.Connector.EXECUTE),onFinishActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.FINISH,jscape.domain.TriggerActionFlow.Connector.EXECUTE),onSuccessActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.SUCCESS,jscape.domain.TriggerActionFlow.Connector.EXECUTE),onFailureActions:this._actionContextFor(rootId,jscape.domain.TriggerActionFlow.Connector.FAILURE,jscape.domain.TriggerActionFlow.Connector.EXECUTE)};},_actionContextFor:function(fromOperator,fromConnector,toConnector){return $.map(this.view.getLinksFrom(fromOperator,fromConnector,toConnector),$.proxy(function(link){if(link){var operatorId=link.toOperator;var context=this.view.getOperatorContext(operatorId);if(context){context.onSuccessActions=this._actionContextFor(operatorId,jscape.domain.TriggerActionFlow.Connector.SUCCESS,jscape.domain.TriggerActionFlow.Connector.EXECUTE);context.onFailureActions=this._actionContextFor(operatorId,jscape.domain.TriggerActionFlow.Connector.FAILURE,jscape.domain.TriggerActionFlow.Connector.EXECUTE);return context;}}
return null;},this));},_isActionAllowed:function(context){return context&&$.inArray(context.className,this.allowedActions)!=-1;},_rootIdForLayout:function(data){var rootId=null;if(data&&data.layout){$.each(data.layout,function(id){if(jscape.domain.TriggerActionFlow.isRootId(id)){rootId=id;return false;}})}
return rootId;},_propertiesToVariables:function(props){return $.map(props,function(entry){return{value:entry.property,text:entry.property||"",title:entry.description||""};}).sort(function(a,b){return a.text.localeCompare(b.text);});},_operators2Links:function(operators){return $.map(operators,function(entry){return{value:entry.actionId,text:entry.title,description:entry.actionName===entry.actionId?entry.actionId:entry.actionName};});},_initValidators:function(){var v=new jscape.Validator();v.rule("trigger_action_name_unique",$.proxy(this._triggerActionNameNotExists,this));},_triggerActionNameNotExists:function(value,excludes){if(this.flow&&this.flow.getRootId()==value){return false;}
for(var i=0,data=this.view.getOperatorsData();i<data.length;++i){if(data[i].actionName==value||data[i].actionId==value){if(excludes==undefined){return false;}
return $.inArray(value,excludes)!=-1;}}
return true;}});jscape.domain.AddTriggerTemplateActionsController=jscape.domain.TriggerTemplateActionsController.extend({initialize:function(dialog){this._super(new jscape.domain.AddTriggerTemplateActionsView(dialog));}});jscape.domain.AddTriggerTemplateActionsView=jscape.domain.TriggerActionsView.extend({initialize:function(dialog){this._super($("#d-trigger-templates-add-actions-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.EditTriggerTemplateActionsController=jscape.domain.TriggerTemplateActionsController.extend({initialize:function(dialog){this._super(new jscape.domain.EditTriggerTemplateActionsView(dialog));}});jscape.domain.EditTriggerTemplateActionsView=jscape.domain.TriggerActionsView.extend({initialize:function(dialog){this._super($("#d-trigger-templates-edit-actions-content"+dialog.getIdSuffix()),dialog);}});jscape.domain.CopyTriggerTemplateController=Class.extend({deferred:null,start:function(domainName,template){this.domainName=domainName;this.templateName=template.name;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var editAfterDone=dialog.isEditAfterDone();return jscape.API.copyTriggerTemplate(this.domainName,this.templateName,dialog.getName()).done($.proxy(function(template){this.deferred.resolve(template,editAfterDone);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.CopyTriggerTemplateDialog();dialog.setName(this.templateName);dialog.setEditAfterDone(true);return dialog;}});jscape.domain.CopyTriggerTemplateDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggertemplate-copy"),{width:"40%",minWidth:500,minHeight:260,resizable:false});this.title=this.dialog.dialog("header").text()||"";this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["trigger_template_unique","non_empty"],missingMessage:window.R.string.TRIGGERS_ERROR_BAD_TEMPLATE_NAME,invalidMessage:window.R.string.TRIGGERS_ERROR_BAD_TEMPLATE_NAME,width:"60%"});this.editAfterDone=$("input[name=editafterdone]:checkbox",this.fieldset);},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value).textbox("textbox").select();this.setTitle(this.title.supplant({0:(""+value).escapeXml()}));},isEditAfterDone:function(){return this.editAfterDone.is(":checked");},setEditAfterDone:function(value){this.editAfterDone.prop("checked",!!value);}});jscape.domain.DeleteTriggerTemplateController=Class.extend({start:function(domainName,templates){var names=$.map(templates,function(template){return template.name;});var deferred=$.Deferred();this._confirmDelete(names).then(function(){return $.when.apply(jQuery,$.map(names,function(name){return jscape.API.deleteTriggerTemplate(domainName,name);}));}).done($.proxy(function(){deferred.resolve(templates);deferred=null;},this)).fail($.proxy(function(){deferred.reject();deferred=null;},this));return deferred.promise();},_confirmDelete:function(names){return jscape.ConfirmDialog.confirm(window.R.string.TRIGGERS_CONFIRM_DELETE_TEMPLATE_TITLE,window.R.string.TRIGGERS_CONFIRM_DELETE_TEMPLATE_MESSAGE.supplant({0:names.join(", ")}));}});jscape.domain.ImportTriggerTemplateController=jscape.ui.DefaultImportController.extend({deferred:null,start:function(domainName,data){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog(data).show(this);return this.deferred.promise();},onSubmit:function(dialog){var file=this.file?this.file:dialog.getFile();return jscape.API.importTriggerTemplates(this.domainName,file,dialog.isOverwrite()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;this._showSuccessMessage();},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(data){var d=new jscape.domain.ImportTriggerTemplateDialog();this._listFileEntries(data,"file").done($.proxy(function(files){if(files&&files.length){this.file=files[0];d.setFilename(this.file.name);d=undefined;}},this));return d;},_showSuccessMessage:function(){$(document).triggerHandler("broadcast",window.R.string.TRIGGERS_SUCCESS_TEMPLATE_IMPORT);}});jscape.domain.ImportTriggerTemplateDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggertemplate-import"),{width:"50%",minWidth:500,maxWidth:750,minHeight:280});this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",validateOnBlur:true,width:"60%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getFile:function(){var files=!this.file.filebox("options").disabled?this.file.filebox("files"):null;return files&&files.length?files[0]:null;},setFilename:function(value){if(!!value){this.file.filebox("setText",value).filebox("disable");}},isOverwrite:function(){return this.overwrite.is(":checked");}});jscape.domain.ExportTriggerTemplateController=Class.extend({deferred:null,start:function(domainName,names){this.domainName=domainName;this.triggerNames=names;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportTriggerTemplates(this.domainName,this.triggerNames,dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.ui.ExportDialog($("#d-triggertemplate-export"));dialog.setFilename("trigger-templates.txt");return dialog;}});jscape.domain.PromoteTriggerTemplateController=Class.extend({DEFAULT_PORT:10880,deferred:null,start:function(domainName,names){this.domainName=domainName;this.names=names||[];this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.promoteTriggerTemplates(this.domainName,this._createData(dialog)).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return{names:this.names,host:dialog.getHost(),port:dialog.getPort(),username:dialog.getUsername(),password:dialog.getPassword(),domain:dialog.getDomain(),overwrite:dialog.isOverwrite()};},_setupDialog:function(){var dialog=new jscape.domain.PromoteTriggerTemplateDialog();dialog.setDomain(this.domainName);dialog.setPort(this.DEFAULT_PORT);return dialog;}});jscape.domain.PromoteTriggerTemplateDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-triggertemplate-promote"),{width:"50%",minWidth:550,maxWidth:750,minHeight:400});this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"non_empty",width:"60%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,width:80});this.domain=$("input[name=domain]",this.fieldset).textbox({required:true,validType:"non_empty",validateOnBlur:true,width:"50%"});this.login=$("input[name=login]",this.fieldset).textbox({required:true,validType:"non_empty",validateOnBlur:true,width:"50%"});this.password=$("input[name=pwd]",this.fieldset).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getHost:function(){return this.host.textbox("getValue");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value));},getDomain:function(){return this.domain.textbox("getValue");},setDomain:function(value){this.domain.textbox("setValue",value);},getUsername:function(){return this.login.textbox("getValue");},getPassword:function(){return this.password.passwordbox("getValue");},isOverwrite:function(){return this.overwrite.is(":checked");}});