/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.AuthService=Class.extend({initialize:function(type){this.type=type||null;}});jscape.AuthService.fromJSON=function(data){var type=jscape.AuthService.typeOf(data);switch(type){case jscape.AuthService.TYPE.DOMAIN:return jscape.AuthService.domain();case jscape.AuthService.TYPE.DB:return jscape.AuthService.db(data.url,data.accountTemplate,data.usernameConversion);case jscape.AuthService.TYPE.DB_QUERY:return jscape.AuthService.dbQuery(data.url,data.username,undefined,data.sql,data.hasher,data.accountTemplate,data.usernameConversion);case jscape.AuthService.TYPE.LDAP:return jscape.AuthService.ldap(data.host,data.port,data.timeout,data.userDN,data.useSsl,data.anonymousAllowed,data.accountTemplate,data.usernameConversion,data.failoverServers);case jscape.AuthService.TYPE.LDAP_QUERY:return jscape.AuthService.ldapQuery(data.host,data.port,data.timeout,data.userDN,data.searchUserDN,data.baseDN,undefined,data.hasher,data.filter,data.useSsl,data.anonymousAllowed,data.accountTemplate,data.usernameConversion,data.failoverServers);case jscape.AuthService.TYPE.NTLM:return jscape.AuthService.ntlm(data.host,data.windowsDomain,data.accountTemplate,data.usernameConversion);case jscape.AuthService.TYPE.PAM:return jscape.AuthService.pam(data.accountTemplate,data.usernameConversion);case jscape.AuthService.TYPE.RADIUS:return jscape.AuthService.radius(data.localhost,data.serverhost,data.serverport,data.timeout,data.maxRetransmitAttempts,data.identifier,data.sharedSecret,data.accountTemplate,data.usernameConversion);case jscape.AuthService.TYPE.CUSTOM:return jscape.AuthService.custom(data.className,data.accountTemplate,data.usernameConversion);case jscape.AuthService.TYPE.MULTIPLE:return jscape.AuthService.multiple(jscape.AuthService.fromJSON(data.primary),jscape.AuthService.fromJSON(data.secondary),$.map(data.otherServices||[],jscape.AuthService.fromJSON));default:return jscape.AuthService.none();}};jscape.UsernameConversion={NONE:'NONE',UPPERCASE:'UPPERCASE',LOWERCASE:'LOWERCASE',values:function(){return[this.NONE,this.UPPERCASE,this.LOWERCASE];},valueOf:function(value){return $.inArray(value,this.values())!=-1?value:this.NONE;}};jscape.AuthService.TYPE={NONE:'NONE',DOMAIN:'DOMAIN',DB:'DB',DB_QUERY:'DB_QUERY',LDAP:'LDAP',LDAP_QUERY:'LDAP_QUERY',NTLM:'NTLM',PAM:'PAM',CUSTOM:'CUSTOM',MULTIPLE:'MULTIPLE',PHONE:'PHONE',RADIUS:'RADIUS'};jscape.AuthService.NONE=$.extend(new jscape.AuthService(jscape.AuthService.TYPE.NONE),{toJSON:function(){return null;}});jscape.AuthService.none=function(){return jscape.AuthService.NONE;};jscape.AuthService.typeOf=function(data,defaultType){return data&&$.inArray(data.type,[jscape.AuthService.TYPE.NONE,jscape.AuthService.TYPE.DOMAIN,jscape.AuthService.TYPE.DB,jscape.AuthService.TYPE.DB_QUERY,jscape.AuthService.TYPE.LDAP,jscape.AuthService.TYPE.LDAP_QUERY,jscape.AuthService.TYPE.NTLM,jscape.AuthService.TYPE.PAM,jscape.AuthService.TYPE.CUSTOM,jscape.AuthService.TYPE.MULTIPLE,jscape.AuthService.TYPE.PHONE,jscape.AuthService.TYPE.RADIUS])!=-1?data.type:defaultType||jscape.AuthService.NONE;};jscape.AuthService.domain=function(){return new jscape.AuthService(jscape.AuthService.TYPE.DOMAIN);};jscape.AuthService.db=function(url,template,usernameConversion){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.DB),{url:url,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.AuthService.dbQuery=function(url,username,password,query,hasher,template,usernameConversion){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.DB_QUERY),{url:url,username:username,password:password||"",sql:query,hasher:hasher,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.AuthService.ldap=function(host,port,timeout,userDN,useSsl,anonymousAllowed,template,usernameConversion,failover){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.LDAP),{host:host,port:port,timeout:timeout,userDN:userDN,useSsl:!!useSsl,anonymousAllowed:!!anonymousAllowed,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion),failoverServers:$.isArray(failover)?failover:(failover?[failover]:[])});};jscape.AuthService.ldapQuery=function(host,port,timeout,userDN,searchUserDN,baseDN,password,hasher,filter,useSsl,anonymousAllowed,template,usernameConversion,failover){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.LDAP_QUERY),{host:host,port:port,timeout:timeout,userDN:userDN,searchUserDN:searchUserDN,baseDN:baseDN,password:password||"",hasher:hasher,filter:filter,useSsl:!!useSsl,anonymousAllowed:!!anonymousAllowed,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion),failoverServers:$.isArray(failover)?failover:(failover?[failover]:[])});};jscape.AuthService.ntlm=function(host,domain,template,usernameConversion){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.NTLM),{host:host,windowsDomain:domain,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.AuthService.pam=function(template,usernameConversion){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.PAM),{accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.AuthService.radius=function(localHost,serverHost,serverPort,timeout,maxRetransmitAttempts,identifier,sharedSecret,template,usernameConversion){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.RADIUS),{localhost:localHost,localport:0,serverhost:serverHost,serverport:serverPort,timeout:timeout,maxRetransmitAttempts:maxRetransmitAttempts,identifier:identifier,sharedSecret:sharedSecret,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.AuthService.custom=function(className,template,usernameConversion){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.CUSTOM),{className:className,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.AuthService.multiple=function(primaryService,secondaryService,otherServices){return $.extend(new jscape.AuthService(jscape.AuthService.TYPE.MULTIPLE),{primary:primaryService,secondary:secondaryService,otherServices:otherServices||[]});};jscape.UserConfirmationService=Class.extend({initialize:function(type){this.type=type||null;}});jscape.UserConfirmationService.fromJSON=function(data){var type=jscape.UserConfirmationService.typeOf(data);switch(type){case jscape.UserConfirmationService.TYPE.PHONE:return jscape.UserConfirmationService.phone(data.licenseDirectory,undefined,data.internationalCallsAllowed);case jscape.UserConfirmationService.TYPE.CUSTOM:return jscape.UserConfirmationService.custom(data.serviceClassName);case jscape.UserConfirmationService.TYPE.TOTP:return jscape.UserConfirmationService.totp();default:return jscape.UserConfirmationService.none();}};jscape.UserConfirmationService.TYPE={NONE:'NONE',PHONE:'PHONE',CUSTOM:'CUSTOM',TOTP:'TOTP'};jscape.UserConfirmationService.NONE=$.extend(new jscape.UserConfirmationService(jscape.UserConfirmationService.TYPE.NONE),{toJSON:function(){return null;}});jscape.UserConfirmationService.none=function(){return jscape.UserConfirmationService.NONE;};jscape.UserConfirmationService.phoneFactor=function(licenseDirectory,password,internationalCallsAllowed){return $.extend(new jscape.UserConfirmationService(jscape.UserConfirmationService.TYPE.PHONE),{licenseDirectory:licenseDirectory,password:password||null,internationalCallsAllowed:internationalCallsAllowed});};jscape.UserConfirmationService.totp=function(){return new jscape.UserConfirmationService(jscape.UserConfirmationService.TYPE.TOTP);};jscape.UserConfirmationService.custom=function(serviceClass){return $.extend(new jscape.UserConfirmationService(jscape.UserConfirmationService.TYPE.CUSTOM),{serviceClassName:serviceClass});};jscape.UserConfirmationService.typeOf=function(data,defaultType){return data&&$.inArray(data.type,[jscape.UserConfirmationService.TYPE.NONE,jscape.UserConfirmationService.TYPE.PHONE,jscape.UserConfirmationService.TYPE.CUSTOM,jscape.UserConfirmationService.TYPE.TOTP])!=-1?data.type:defaultType||jscape.UserConfirmationService.NONE;};jscape.WebSsoService=Class.extend({initialize:function(type){this.type=type||null;}});jscape.WebSsoService.fromJSON=function(data){var type=jscape.WebSsoService.typeOf(data);switch(type){case jscape.WebSsoService.TYPE.OPEN_ID:return jscape.WebSsoService.openId(data.signInUrl,data.signOutUrl,data.nonSsoLoginAllowed,data.accountTemplate,data.usernameConversion);case jscape.WebSsoService.TYPE.OPEN_ID_CONNECT:return jscape.WebSsoService.openIdConnect(data.signInUrl,data.tokenVerificationUrl,data.redirectionUrl,data.clientId,data.clientSecret,data.nonSsoLoginAllowed,data.accountTemplate,data.usernameConversion);case jscape.WebSsoService.TYPE.SAML:return jscape.WebSsoService.saml(data.signInUrl,data.signOutUrl,data.changePasswordUrl,data.decryptionKeyProvider,data.verificationHostKey,data.nameIdFormat,data.nonSsoLoginAllowed,data.accountTemplate,data.usernameConversion);default:return jscape.AuthService.none();}};jscape.WebSsoService.TYPE={OPEN_ID:'OPEN_ID',OPEN_ID_CONNECT:'OPEN_ID_CONNECT',SAML:'SAML'};jscape.WebSsoService.openId=function(signInUrl,signOutUrl,nonSsoLoginAllowed,template,usernameConversion){return $.extend(new jscape.WebSsoService(jscape.WebSsoService.TYPE.OPEN_ID),{signInUrl:signInUrl,signOutUrl:signOutUrl,nonSsoLoginAllowed:!!nonSsoLoginAllowed,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.WebSsoService.openIdConnect=function(signInUrl,tokenVerificationUrl,redirectionUrl,clientId,clientSecret,nonSsoLoginAllowed,template,usernameConversion){return $.extend(new jscape.WebSsoService(jscape.WebSsoService.TYPE.OPEN_ID_CONNECT),{signInUrl:signInUrl,tokenVerificationUrl:tokenVerificationUrl,redirectionUrl:redirectionUrl,clientId:clientId,clientSecret:clientSecret,nonSsoLoginAllowed:!!nonSsoLoginAllowed,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.WebSsoService.saml=function(signInUrl,signOutUrl,changePasswordUrl,decryptionKeyProvider,certificate,nameIdFormat,nonSsoLoginAllowed,template,usernameConversion){return $.extend(new jscape.WebSsoService(jscape.WebSsoService.TYPE.SAML),{signInUrl:signInUrl,signOutUrl:signOutUrl,changePasswordUrl:changePasswordUrl,decryptionKeyProvider:decryptionKeyProvider,verificationHostKey:certificate,nameIdFormat:nameIdFormat,nonSsoLoginAllowed:!!nonSsoLoginAllowed,accountTemplate:template,usernameConversion:jscape.UsernameConversion.valueOf(usernameConversion)});};jscape.WebSsoService.typeOf=function(data,defaultType){return data&&$.inArray(data.type,[jscape.WebSsoService.TYPE.OPEN_ID,jscape.WebSsoService.TYPE.OPEN_ID_CONNECT,jscape.WebSsoService.TYPE.SAML])!=-1?data.type:defaultType||null;};jscape.domain.AuthenticationModule=jscape.domain.DomainModule.extend({onCreate:function(){this._super.apply(this,arguments);this.authServiceController=new jscape.domain.AuthenticationServiceController();this.authServiceController.onCreate(this.domainName);this.twoFactorController=new jscape.domain.TwoFactorAuthServiceController();this.twoFactorController.onCreate(this.domainName);this.webSsoController=new jscape.domain.WebSsoAuthServiceController();this.webSsoController.onCreate(this.domainName);},onStart:function(){this.authServiceController.onStart();this.twoFactorController.onStart();this.webSsoController.onStart();},onPause:function(){this._confirmAndApply($.grep([this.authServiceController,this.twoFactorController,this.webSsoController],function(controller){return controller.hasChanged();}));},onResume:function(){this.authServiceController.onResume();this.twoFactorController.onResume();this.webSsoController.onResume();}});jscape.domain.AuthenticationServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.AuthService.domain(),view:null,type:null,descriptor:null,initialize:function(){this.controllers={DOMAIN:jscape.domain.DomainAuthServiceController,DB:jscape.domain.DbAuthServiceController,DB_QUERY:jscape.domain.DbQueryAuthServiceController,LDAP:jscape.domain.LdapAuthServiceController,LDAP_QUERY:jscape.domain.LdapQueryAuthServiceController,NTLM:jscape.domain.NtlmAuthServiceController,PAM:jscape.domain.PamAuthServiceController,RADIUS:jscape.domain.RadiusAuthServiceController,CUSTOM:jscape.domain.CustomAuthServiceController,MULTIPLE:jscape.domain.MultipleAuthServiceController};},onCreate:function(domainName){this.domainName=domainName;},onStart:function(){if(this.view==null){this.view=new jscape.domain.AuthenticationServiceView();}
this.view.show(this);},onResume:function(){$.when(jscape.API.getAuthenticationService(this.domainName),jscape.API.getAccountTemplateNames(this.domainName)).done($.proxy(function(descriptor,templates){this.descriptor=descriptor;this.templates=templates.sort();},this)).fail($.proxy(function(){this.descriptor=this.DEFAULT_DESCRIPTOR;this.templates=[];},this)).always($.proxy(function(){this._setupView(this.descriptor);},this));},onApply:function(){var c=this.controllers[this._serviceTypeOf(this.view)]||null;if(!c){return $.Deferred().reject().promise();}
return c.onApply().done($.proxy(function(descriptor){this.descriptor=descriptor;},this));},onDiscard:function(){var c=this.controllers[this._serviceTypeOf(this.view)]||null;c&&c.onDiscard();this._setupView(this.descriptor);return $.Deferred().resolve().promise();},onChange:function(){var changed=this.hasChanged();return $.Deferred().resolve(changed).promise();},onChangeType:function(view){var serviceType=this._serviceTypeOf(view);$.each(this.controllers,$.proxy(function(type,controller){var t=typeof controller;if(serviceType===type){this.type=serviceType;if(t==="function"){var c=new controller(view.container());this.controllers[type]=c;c.start(this.domainName,this.descriptor,this.templates);}else if(t==="object"){controller.resume(this.descriptor,this.templates);}}else{if(t==="object"){controller.pause();}}},this));},hasChanged:function(){var type=this.descriptor?this.descriptor.type:this.type;if(type!=this._serviceTypeOf(this.view)){return true;}
var c=this.controllers[type];return!!c&&typeof c.hasChanged==="function"&&c.hasChanged();},_serviceTypeOf:function(view){return(view.getType()||"").toUpperCase();},_setupView:function(descriptor){var type=descriptor&&descriptor.type?descriptor.type:this.DEFAULT_DESCRIPTOR.type;this.view.setType(type);}});jscape.domain.AuthenticationServiceView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#domain-auth-service-fields").layout({fit:true,doSize:false,border:false});this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,selectOnNavigation:false,onChange:$.proxy(this._onChange$Type,this),width:"25%",minWidth:250,panelHeight:"auto",panelMinHeight:80,panelMaxHeight:"40%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},container:function(){return this.fieldset.layout("panel","center");},show:function(listener){this.listener=listener||jscape.domain.AuthenticationServiceView.LISTENER;},getType:function(){return this.type.combobox("getValue");},setType:function(value){var selectedType=this.type.combobox("getValue");this.type.combobox("clear").combobox("select",value);if(selectedType===value){this._onChange$Type();}},_onChange$Type:function(){this.listener.onChangeType(this);this.fieldset.triggerHandler("_change");},_onClick$ApplyButton:function(){this.applyButton.linkbutton("disable");this.listener.onApply(this).catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));}});jscape.domain.AuthenticationServiceView.LISTENER={onChangeType:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.BaseAuthServiceController=Class.extend({view:null,type:null,descriptor:null,templates:null,initialize:function(type){this.type=type;this.testController=new jscape.domain.TestAuthServiceController();},start:function(domainName,descriptor,templates){this.domainName=domainName;this.descriptor=descriptor||null;this.templates=templates||[];this.view.show(this);this._setupView(this.descriptor);},resume:function(descriptor,templates){this.descriptor=this._support(descriptor)?descriptor:null;this.templates=templates||[];this.view.show(this);},pause:function(){this.view.hide();},hasChanged:function(){return this.descriptor!=null&&!Object._equals(this.descriptor,this._createDescriptor());},onChange:function(){var changed=this.hasChanged();return $.Deferred().resolve(changed).promise();},onLoadAccountTemplates:function(){return $.Deferred().resolve(this.templates).promise();},onTest:function(){return this.testController.start(this.domainName,this._createDescriptor());},onApply:function(){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setAuthenticationService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},onDiscard:function(){this._setupView(this.descriptor);},_createDescriptor:function(){throw"Not implemented";},_setupView:function(descriptor){},_support:function(descriptor){return descriptor&&descriptor.type===this.type;},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.domain.BaseAuthServiceView=jscape.ui.FormView.extend({focusInField:null,initialize:function(el){var initializing=true;this.fieldset=el.first().layout({fit:true,doSize:false,border:false}).hide();this.useTemplate=$("input[name=usetemplate]:checkbox",this.fieldset);this.useTemplate.change($.proxy(function(){var enabled=this.useTemplate.is(":checked");this.template.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");},this));this.template=$("select[name=template]",this.fieldset);this.template.combobox({required:true,editable:false,loader:$.proxy(this._onLoad$AccountTemplates,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._onLoadSuccess$Templates,this),onLoadError:$.proxy(this._onLoadError$Templates,this),onChange:$.proxy(this._onForm$Change,this),width:210,panelHeight:"auto",panelMaxHeight:"40%"});this.useUsernameConversion=$("input[name=useusernameconversion]:checkbox",this.fieldset);this.useUsernameConversion.change($.proxy(function(){var enabled=this.useUsernameConversion.is(":checked");this.usernameConversion.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");},this));this.usernameConversion=$("select[name=usernameconversion]",this.fieldset);this.usernameConversion.combobox({required:true,editable:false,onChange:$.proxy(this._onForm$Change,this),onLoadSuccess:$.proxy(this._onLoadSuccess$UsernameConversion,this),onLoadError:$.proxy(this._onLoadError$UsernameConversion,this),width:100,panelHeight:"auto",panelMaxHeight:"40%"});this.addVariableButton=$("a[role=button][name=addvar]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$AddVariableButton,this)});this.testButton=$("a[role=button][name=test]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$TestButton,this)});this.fieldset.off("focusin").on("focusin",$.proxy(this._onChange$FocusIn,this));this._bindEvents(this.fieldset);initializing=false;},show:function(listener){this.listener=listener||jscape.domain.BaseAuthServiceView.LISTENER;this.focusInField=null;this.fieldset.show().layout({height:"auto"});this.template.length&&this.template.combobox("reload");this.fieldset.form("validate");},hide:function(){this.fieldset.hide();this.focusInField=null;},valid:function(){return this.fieldset.form("validate");},getUsernameConversion:function(){return this.usernameConversion.length&&this.useUsernameConversion.is(":checked:not(:disabled)")?this.usernameConversion.combobox("getValue"):jscape.UsernameConversion.NONE;},setUsernameConversion:function(value){if(this.usernameConversion.length==0){return;}
if(jscape.UsernameConversion.NONE!=value){this.useUsernameConversion.prop("checked",true).change();this.usernameConversion.combobox("select",value);}else{this.useUsernameConversion.prop("checked",false).change();this.usernameConversion.combobox("reset");}},getTemplate:function(){return this.useTemplate.length&&this.useTemplate.is(":checked")?this.template.combobox("getValue"):null;},setTemplate:function(value){if(this.template.length){this.template.combobox("select",value);this.useTemplate.prop("checked",value!=null).change();}},_onClick$TestButton:function(){if(this.valid()){this.testButton.linkbutton("disable");this.listener.onTest(this).always($.proxy(function(){this.testButton.linkbutton("enable");},this));}},_onClick$AddVariableButton:function(){if(this.focusInField&&this.focusInField.length){this.addVariableButton.linkbutton("disable");this.listener.onAddVariable(this.focusInField);}},_onChange$FocusIn:function(e){var t=$(e.target);if(t&&t.is(this.addVariableButton)){return;}
if(t&&!t.is("[readonly]")&&(t.is("[type=text]")||t.is("textarea"))){this.focusInField=t;if(this.addVariableButton&&this.addVariableButton.length){this.addVariableButton.linkbutton("enable");}}else{if(this.addVariableButton&&this.addVariableButton.length){if(!this.addVariableButton.is(t)){this.focusInField=null;this.addVariableButton.linkbutton("disable");}}else{this.focusInField=null;}}},_onLoad$AccountTemplates:function(params,success,error){if(this.listener){this.listener.onLoadAccountTemplates(params).done(success).fail(error);}else{$.Deferred().resolve([]).promise().then(success,error);}},_onLoadSuccess$Templates:function(data){if(data&&data.length){this.useTemplate.prop("disabled",false).change();}else{this.template.combobox("clear");this._onLoadError$Templates();}},_onLoadError$Templates:function(){this.useTemplate.prop("disabled",true).change();},_onLoadSuccess$UsernameConversion:function(data){if(data&&data.length){this.usernameConversion.combobox("clear").combobox("select",data[0].value);this.useUsernameConversion.change();}else{this._onLoadError$UsernameConversion();}},_onLoadError$UsernameConversion:function(){this.useUsernameConversion.prop("disabled",true).change();},_onForm$Change:function(){this.fieldset.closest("[role=group]").triggerHandler("_change");}});jscape.domain.BaseAuthServiceView.LISTENER={onTest:$.noop,onAddVariable:$.noop};jscape.domain.NoneAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(){},show:function(){},hide:function(){},valid:function(){return true;}});jscape.domain.DomainAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function($parent){this._super(jscape.AuthService.TYPE.DOMAIN);var el=$("#domainauthfields").clone().attr("id","").appendTo($parent);this.view=new jscape.domain.DomainAuthServiceView(el);},_createDescriptor:function(){return jscape.AuthService.domain();}});jscape.domain.DomainAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(el){this._super(el);}});jscape.domain.DbAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(parent){this._super(jscape.AuthService.TYPE.DB);var content=$("#dbauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.DbAuthServiceView(content);},_createDescriptor:function(){return jscape.AuthService.db(this.view.getUrl(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setUrl(descriptor.url);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.DbAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(el){this._super(el);this.url=$("input[name=dburl]",this.fieldset).textbox({required:true,validType:"length[1,2048]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_DB_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_DB_URL,width:350});},getUrl:function(){return this.url.textbox("getValue").trim();},setUrl:function(value){this.url.textbox("setValue",value);}});jscape.domain.DbQueryAuthServiceController=jscape.domain.BaseAuthServiceController.extend({VARIABLES:["username","password"],initialize:function(parent){this._super(jscape.AuthService.TYPE.DB_QUERY);var content=$("#dbqueryauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.DbQueryAuthServiceView(content);this.variableController=new jscape.VariableController();},onAddVariable:function(input){this.variableController.start(input,this.VARIABLES);},_createDescriptor:function(){return jscape.AuthService.dbQuery(this.view.getUrl(),this.view.getUsername(),this.view.getPassword(),this.view.getQuery(),this.view.getHashClass(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setUrl(descriptor.url);this.view.setUsername(descriptor.username);this.view.setPassword(descriptor.password);this.view.setQuery(descriptor.sql);this.view.setHashClass(descriptor.hasher);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.DbQueryAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(el){this._super(el);this.url=$("input[name=dburl]",this.fieldset).textbox({required:true,validType:"length[1,2048]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_DB_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_DB_URL,width:410});this.username=$("input[name=dbuser]",this.fieldset).textbox({required:true,validType:"length[1,50]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_DB_USER,invalidMessage:window.R.string.AUTH_ERROR_BAD_DB_USER,width:250});this.password=$("input[name=dbpwd]",this.fieldset).passwordbox2({onChange:$.proxy(this._onForm$Change,this),width:250});this.query=$("textarea[name=query]",this.fieldset).textbox({required:true,multiline:true,validType:"length[1,2000]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_DB_QUERY,invalidMessage:window.R.string.AUTH_ERROR_BAD_DB_QUERY,width:610,height:120});this.hashClass=$("input[name=hashclass]",this.fieldset).textbox({width:310});},getUrl:function(){return this.url.textbox("getValue").trim();},setUrl:function(value){this.url.textbox("setValue",value);},getUsername:function(){return this.username.textbox("getValue");},setUsername:function(value){this.username.textbox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue")||"";},setPassword:function(value){this.password.passwordbox2("setValue",value||"");},getQuery:function(){return this.query.textbox("getValue");},setQuery:function(value){this.query.textbox("setValue",value);},getHashClass:function(){return this.hashClass.textbox("getValue");},setHashClass:function(value){this.hashClass.textbox("setValue",value);},_onChange$FocusIn:function(e){var t=$(e.target);if(this.query.textbox("textbox").is(t)){this.focusInField=t;this.addVariableButton.linkbutton("enable");}else if(!this.addVariableButton.is(t)){this._super(jQuery.Event(e.type,{target:null}));}}});jscape.domain.LdapAuthServiceController=jscape.domain.BaseAuthServiceController.extend({DEFAULT_PORT:389,DEFAULT_TIMEOUT:30*1000,VARIABLES:["username","password"],initialize:function(parent){this._super(jscape.AuthService.TYPE.LDAP);var content=$("#ldapauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.LdapAuthServiceView(content);this.variableController=new jscape.VariableController();},onAddVariable:function(input){this.variableController.start(input,this.VARIABLES);},_createDescriptor:function(){var failover=this.view.getFailoverHost()!=null?{host:this.view.getFailoverHost(),port:this.view.getFailoverPort()}:null;return jscape.AuthService.ldap(this.view.getHost(),this.view.getPort(),this.view.getTimeout(),this.view.getUserDN(),this.view.isUseSsl(),this.view.isAnonymousAllowed(),this.view.getTemplate(),this.view.getUsernameConversion(),failover);},_setupView:function(descriptor){if(descriptor){this.view.setHost(descriptor.host);this.view.setPort(descriptor.port);this.view.setTimeout(descriptor.timeout);this.view.setUserDN(descriptor.userDN);this.view.setUseSsl(descriptor.useSsl);this.view.setAnonymousAllowed(descriptor.anonymousAllowed);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);var failover=descriptor.failoverServers;if(failover&&failover.length){this.view.setFailoverHost(failover[0].host);this.view.setFailoverPort(failover[0].port);}}
if(!this._support(descriptor)){this.view.setPort(this.DEFAULT_PORT);this.view.setTimeout(this.DEFAULT_TIMEOUT);this.view.setFailoverPort(this.DEFAULT_PORT);}}});jscape.domain.LdapAuthServiceView=jscape.domain.BaseAuthServiceView.extend({TIMEOUT_FACTOR:1000,initialize:function(el){this._super(el);this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_LDAP_HOST,invalidMessage:window.R.string.AUTH_ERROR_BAD_LDAP_HOST,width:410});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({required:true,min:1,max:999,onChange:$.proxy(this._onForm$Change,this),width:80});this.userDN=$("input[name=userdn]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_USER_DN,invalidMessage:window.R.string.AUTH_ERROR_BAD_USER_DN,width:410});this.useSsl=$("input[name=usessl]",this.fieldset);this.anonymousAllowed=$("input[name=allowanonymous]",this.fieldset);this.useFailover=$("input[name=usefailover]",this.fieldset);this.useFailover.change($.proxy(function(){var enabled=this.useFailover.is(":checked");this.failoverHost.textbox(enabled?"enable":"disable").textbox(enabled?"enableValidation":"disableValidation").textbox("isValid");this.failoverPort.numberspinner(enabled?"enable":"disable").numberspinner(enabled?"enableValidation":"disableValidation");},this));this.failoverHost=$("input[name=failoverhost]",this.fieldset).textbox({required:true,disabled:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_FAILOVER_HOST,invalidMessage:window.R.string.AUTH_ERROR_BAD_FAILOVER_HOST,width:410});this.failoverPort=$("input[name=failoverport]",this.fieldset).numberspinner({required:true,disabled:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value);},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value));},getTimeout:function(){return parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setTimeout:function(value){this.timeout.numberspinner("setValue",parseInt(value)/this.TIMEOUT_FACTOR);},getUserDN:function(){return this.userDN.textbox("getValue");},setUserDN:function(value){this.userDN.textbox("setValue",value);},isUseSsl:function(){return this.useSsl.is(":checked");},setUseSsl:function(value){this.useSsl.prop("checked",!!value);},isAnonymousAllowed:function(){return this.anonymousAllowed.is(":checked");},setAnonymousAllowed:function(value){this.anonymousAllowed.prop("checked",!!value);},getFailoverHost:function(){return this.useFailover.is(":checked")?this.failoverHost.textbox("getValue"):null;},setFailoverHost:function(value){this.failoverHost.textbox("setValue",value);this.useFailover.prop("checked",!!value).change();},getFailoverPort:function(){return parseInt(this.failoverPort.numberspinner("getValue"));},setFailoverPort:function(value){this.failoverPort.numberspinner("setValue",parseInt(value));}});jscape.domain.LdapQueryAuthServiceController=jscape.domain.BaseAuthServiceController.extend({DEFAULT_PORT:389,DEFAULT_TIMEOUT:30*1000,VARIABLES:["username","password"],initialize:function(parent){this._super(jscape.AuthService.TYPE.LDAP_QUERY);var content=$("#ldapqueryauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.LdapQueryAuthServiceView(content);this.variableController=new jscape.VariableController();},onAddVariable:function(input){this.variableController.start(input,this.VARIABLES);},_createDescriptor:function(){var failover=this.view.getFailoverHost()!=null?{host:this.view.getFailoverHost(),port:this.view.getFailoverPort()}:null;return jscape.AuthService.ldapQuery(this.view.getHost(),this.view.getPort(),this.view.getTimeout(),this.view.getUserDN(),this.view.getSearchUserDN(),this.view.getBaseDN(),this.view.getPassword(),this.view.getHasher(),this.view.getFilter(),this.view.isUseSsl(),this.view.isAnonymousAllowed(),this.view.getTemplate(),this.view.getUsernameConversion(),failover);},_setupView:function(descriptor){if(descriptor){this.view.setHost(descriptor.host);this.view.setPort(descriptor.port);this.view.setTimeout(descriptor.timeout);this.view.setUserDN(descriptor.userDN);this.view.setSearchUserDN(descriptor.searchUserDN);this.view.setBaseDN(descriptor.baseDN);this.view.setPassword(descriptor.password);this.view.setHasher(descriptor.hasher);this.view.setFilter(descriptor.filter);this.view.setUseSsl(descriptor.useSsl);this.view.setAnonymousAllowed(descriptor.anonymousAllowed);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);var failover=descriptor.failoverServers;if(failover&&failover.length){this.view.setFailoverHost(failover[0].host);this.view.setFailoverPort(failover[0].port);}}
if(!this._support(descriptor)){this.view.setPort(this.DEFAULT_PORT);this.view.setTimeout(this.DEFAULT_TIMEOUT);this.view.setFailoverPort(this.DEFAULT_PORT);}}});jscape.domain.LdapQueryAuthServiceView=jscape.domain.BaseAuthServiceView.extend({TIMEOUT_FACTOR:1000,initialize:function(el){this._super(el);this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_LDAP_HOST,invalidMessage:window.R.string.AUTH_ERROR_BAD_LDAP_HOST,width:410});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({required:true,min:1,max:999,onChange:$.proxy(this._onForm$Change,this),width:80});this.userDN=$("input[name=userdn]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_USER_DN,invalidMessage:window.R.string.AUTH_ERROR_BAD_USER_DN,width:410});this.searchUserDN=$("input[name=searchuserdn]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_SEARCH_USER_DN,invalidMessage:window.R.string.AUTH_ERROR_BAD_SEARCH_USER_DN,width:410});this.password=$("input[name=password]",this.fieldset).passwordbox2({onChange:$.proxy(this._onForm$Change,this),width:410});this.baseDN=$("input[name=basedn]",this.fieldset).textbox({onChange:$.proxy(this._onForm$Change,this),width:410});this.filter=$("textarea[name=filter]",this.fieldset).textbox({required:true,multiline:true,validType:"length[1,2000]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_FILTER,invalidMessage:window.R.string.AUTH_ERROR_BAD_FILTER,width:610,height:120});this.hasher=$("input[name=hasher]",this.fieldset).textbox({onChange:$.proxy(this._onForm$Change,this),width:410});this.useSsl=$("input[name=usessl]",this.fieldset);this.anonymousAllowed=$("input[name=allowanonymous]",this.fieldset);this.useFailover=$("input[name=usefailover]",this.fieldset);this.useFailover.change($.proxy(function(){var enabled=this.useFailover.is(":checked");this.failoverHost.textbox(enabled?"enable":"disable").textbox(enabled?"enableValidation":"disableValidation").textbox("isValid");this.failoverPort.numberspinner(enabled?"enable":"disable").numberspinner(enabled?"enableValidation":"disableValidation");},this));this.failoverHost=$("input[name=failoverhost]",this.fieldset).textbox({required:true,disabled:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_FAILOVER_HOST,invalidMessage:window.R.string.AUTH_ERROR_BAD_FAILOVER_HOST,width:410});this.failoverPort=$("input[name=failoverport]",this.fieldset).numberspinner({required:true,disabled:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value);},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value));},getTimeout:function(){return parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setTimeout:function(value){this.timeout.numberspinner("setValue",parseInt(value)/this.TIMEOUT_FACTOR);},getUserDN:function(){return this.userDN.textbox("getValue");},setUserDN:function(value){this.userDN.textbox("setValue",value);},getSearchUserDN:function(){return this.searchUserDN.textbox("getValue");},setSearchUserDN:function(value){this.searchUserDN.textbox("setValue",value);},getBaseDN:function(){return this.baseDN.textbox("getValue");},setBaseDN:function(value){this.baseDN.textbox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue");},setPassword:function(value){this.password.passwordbox2("setValue",value);},getHasher:function(){return this.hasher.textbox("getValue");},setHasher:function(value){this.hasher.textbox("setValue",value);},getFilter:function(){return this.filter.textbox("getValue");},setFilter:function(value){this.filter.textbox("setValue",value);},isUseSsl:function(){return this.useSsl.is(":checked");},setUseSsl:function(value){this.useSsl.prop("checked",!!value);},isAnonymousAllowed:function(){return this.anonymousAllowed.is(":checked");},setAnonymousAllowed:function(value){this.anonymousAllowed.prop("checked",!!value);},getFailoverHost:function(){return this.useFailover.is(":checked")?this.failoverHost.textbox("getValue"):null;},setFailoverHost:function(value){this.failoverHost.textbox("setValue",value);this.useFailover.prop("checked",!!value).change();},getFailoverPort:function(){return parseInt(this.failoverPort.numberspinner("getValue"));},setFailoverPort:function(value){this.failoverPort.numberspinner("setValue",parseInt(value));}});jscape.domain.NtlmAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(parent){this._super(jscape.AuthService.TYPE.NTLM);var content=$("#ntlmauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.NtlmAuthServiceView(content);},_createDescriptor:function(){return jscape.AuthService.ntlm(this.view.getHost(),this.view.getDomain(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setHost(descriptor.host);this.view.setDomain(descriptor.windowsDomain);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.NtlmAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(el){this._super(el);this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_NTLM_HOST,invalidMessage:window.R.string.AUTH_ERROR_BAD_NTLM_HOST,width:410});this.domain=$("input[name=domain]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_NTLM_DOMAIN,invalidMessage:window.R.string.AUTH_ERROR_BAD_NTLM_DOMAIN,width:410});},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value);},getDomain:function(){return this.domain.textbox("getValue");},setDomain:function(value){this.domain.textbox("setValue",value);}});jscape.domain.PamAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(parent){this._super(jscape.AuthService.TYPE.PAM);var content=$("#pamauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.PamAuthServiceView(content);},_createDescriptor:function(){return jscape.AuthService.pam(this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.PamAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(el){this._super(el);}});jscape.domain.RadiusAuthServiceController=jscape.domain.BaseAuthServiceController.extend({DEFAULT_PORT:1812,DEFAULT_TIMEOUT:30*1000,DEFAULT_RETRANSMIT_ATTEMPTS:3,inetAddresses:null,initialize:function(parent){this._super(jscape.AuthService.TYPE.RADIUS);var content=$("#radiusauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.RadiusAuthServiceView(content);},start:function(){this.inetAddresses=[];this._super.apply(this,arguments);},onLoadInetAddresses:function(){if(this.inetAddresses.length){return $.Deferred().resolve(this.inetAddresses).promise();}
return jscape.API.getServerAddresses().catch(function(){return[];}).done($.proxy(function(data){this.inetAddresses=data;},this));},_createDescriptor:function(){return jscape.AuthService.radius(this.view.getLocalHost(),this.view.getServerHost(),this.view.getServerPort(),this.view.getTimeout(),this.view.getMaxRetransmitAttempts(),this.view.getIdentifier(),this.view.getSharedSecret(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setLocalHost(descriptor.localhost);this.view.setServerHost(descriptor.serverhost);this.view.setServerPort(descriptor.serverport);this.view.setTimeout(descriptor.timeout);this.view.setMaxRetransmitAttempts(descriptor.maxRetransmitAttempts);this.view.setIdentifier(descriptor.identifier);this.view.setSharedSecret(descriptor.sharedSecret);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}
if(!this._support(descriptor)){this.view.setServerPort(this.DEFAULT_PORT);this.view.setTimeout(this.DEFAULT_TIMEOUT);this.view.setMaxRetransmitAttempts(this.DEFAULT_RETRANSMIT_ATTEMPTS);}}});jscape.domain.RadiusAuthServiceView=jscape.domain.BaseAuthServiceView.extend({TIMEOUT_FACTOR:1000,initialize:function(el){this._super(el);var initializing=true;this.localHost=$("select[name=localhost]",this.fieldset).combobox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),loader:$.proxy(this._onLoad$InetAddresses,this),onBeforeLoad:function(){return!initializing;},missingMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_HOST,invalidMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_HOST,width:200,panelWidth:"auto",panelHeight:"auto",panelMaxHeight:"40%"});this.serverHost=$("input[name=serverhost]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_HOST,invalidMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_HOST,width:410});this.serverPort=$("input[name=serverport]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({required:true,min:1,max:999,onChange:$.proxy(this._onForm$Change,this),width:80});this.retransmitAttempts=$("input[name=retransmitattempts]",this.fieldset).numberspinner({required:true,min:1,max:100,onChange:$.proxy(this._onForm$Change,this),width:60});this.identifier=$("input[name=identifier]",this.fieldset).textbox({required:true,onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_ID,invalidMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_ID,width:410});this.sharedSecret=$("input[name=secret]",this.fieldset).textbox({required:true,onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_SECRET,invalidMessage:window.R.string.AUTH_ERROR_BAD_RADIUS_SECRET,width:410});initializing=false;},show:function(){this._super.apply(this,arguments);this.localHost.combobox("reload");},getLocalHost:function(){return this.localHost.combobox("getValue");},setLocalHost:function(value){this.localHost.combobox("setValue",value);},getServerHost:function(){return this.serverHost.textbox("getValue");},setServerHost:function(value){this.serverHost.textbox("setValue",value);},getServerPort:function(){return parseInt(this.serverPort.numberspinner("getValue"));},setServerPort:function(value){this.serverPort.numberspinner("setValue",parseInt(value));},getTimeout:function(){return parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setTimeout:function(value){this.timeout.numberspinner("setValue",parseInt(value)/this.TIMEOUT_FACTOR);},getMaxRetransmitAttempts:function(){return parseInt(this.retransmitAttempts.numberspinner("getValue"));},setMaxRetransmitAttempts:function(value){this.retransmitAttempts.numberspinner("setValue",parseInt(value));},getIdentifier:function(){return this.identifier.textbox("getValue");},setIdentifier:function(value){this.identifier.textbox("setValue",value);},getSharedSecret:function(){return this.sharedSecret.textbox("getValue");},setSharedSecret:function(value){this.sharedSecret.textbox("setValue",value);},_onLoad$InetAddresses:function(params,success,error){if(this.listener){this.listener.onLoadInetAddresses(params).then($.proxy(function(data){return this._filterInetAddresses(data);},this)).then(success,error);}else{$.Deferred().resolve([]).promise().then(success,error);}},_filterInetAddresses:function(values){return $.map(values||[],$.proxy(function(value){return{text:this._formatHostname(value),value:value};},this));},_formatHostname:function(value){return jscape.ServerParameters.allHostsIpv4(value)?window.R.string.APPLICATION_HOST_ALL_IPV4:jscape.ServerParameters.allHostsIpv6(value)?window.R.string.APPLICATION_HOST_ALL_IPV6:value;}});jscape.domain.CustomAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(parent){this._super(jscape.AuthService.TYPE.CUSTOM);var content=$("#customauthfields").clone().attr("id","").appendTo(parent);this.view=new jscape.domain.CustomAuthServiceView(content);},_createDescriptor:function(){return jscape.AuthService.custom(this.view.getClassName(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setClassName(descriptor.className);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.CustomAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(el){this._super(el);this.className=$("input[name=classname]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_CLASS,invalidMessage:window.R.string.AUTH_ERROR_BAD_CLASS,width:500});},getClassName:function(){return this.className.textbox("getValue");},setClassName:function(value){this.className.textbox("setValue",value);}});jscape.domain.MultipleAuthServiceController=jscape.domain.BaseAuthServiceController.extend({MIN_SERVICES_COUNT:2,MAX_SERVICES_COUNT:5,descriptors:null,copy:null,initialize:function(){this._super(jscape.AuthService.TYPE.MULTIPLE);this.view=new jscape.domain.MultipleAuthServiceView(this.MIN_SERVICES_COUNT,this.MAX_SERVICES_COUNT);this.addController=new jscape.domain.AddUserMultipleAuthServiceController();this.editController=new jscape.domain.EditUserMultipleAuthServiceController();},start:function(domainName,descriptor,templates){this.domainName=domainName;this.descriptors=this._support(descriptor)&&!!descriptor.primary&&!!descriptor.secondary?[descriptor.primary,descriptor.secondary].concat(descriptor.otherServices||[]):[];this.copy=this._copyDescriptor(this.descriptors);this.templates=templates;this.view.show(this);this.view.setDescriptors(this.descriptors);},resume:function(templates){this.templates=templates;this.view.show(this);},pause:function(){this.view.hide();},hasChanged:function(){return!Object._equals(this.copy,this.descriptors);},onAdd:function(){return this.addController.start({onTest:$.proxy(function(data){return this.testController.start(this.domainName,this._createTestDescriptor(data,-1));},this)},this.domainName).then($.proxy(function(data){this.descriptors.push(data);this.view.setDescriptors(this.descriptors,this.descriptors.length-1);},this));},onEdit:function(item){var index=$.inArray(item,this.descriptors);if(index==-1){return $.Deferred().reject().promise();}
return this.editController.start({onTest:$.proxy(function(data){return this.testController.start(this.domainName,this._createTestDescriptor(data,index));},this)},this.domainName,item).then($.proxy(function(data){this.descriptors[index]=data;this.view.setDescriptors(this.descriptors,index);},this));},onDelete:function(items){return this._confirmDelete(items).then($.proxy(function(items){var index=-1;while(items.length){index=$.inArray(items.pop(),this.descriptors);this.descriptors.splice(index,1);}
if(this.descriptors.length){index=Math.max(0,Math.min(index,this.descriptors.length-1));}else{index=-1;}
this.view.setDescriptors(this.descriptors,index);},this,items));},onMoveUp:function(item){var index=$.inArray(item,this.descriptors);if(index>0){this.descriptors.splice(index-1,2,this.descriptors[index],this.descriptors[index-1]);this.view.setDescriptors(this.descriptors,index-1);}},onMoveDown:function(item){var index=$.inArray(item,this.descriptors);if(index!=-1&&index<this.descriptors.length-1){this.descriptors.splice(index,2,this.descriptors[index+1],this.descriptors[index]);this.view.setDescriptors(this.descriptors,index+1);}},onApply:function(){if(!this.view.valid()){if(this.descriptors.length<this.MIN_SERVICES_COUNT){this.view._showMinServicesCountError();}
return $.Deferred().reject().promise();}
return jscape.API.setAuthenticationService(this.domainName,this._createDescriptor()).done($.proxy(this._fireApplySuccess,this)).done($.proxy(function(){this.copy=this._copyDescriptor(this.descriptors);},this));},onDiscard:function(){this.descriptors=$.map(this.copy,function(data){return jscape.AuthService.fromJSON(data);});this.view.setDescriptors(this.descriptors);},_copyDescriptor:function(descriptors){return $.map(descriptors,function(data){return jscape.AuthService.fromJSON(data);});},_createTestDescriptor:function(data,index){var descriptors=[].concat(this.descriptors);if(index>=0&&index<descriptors.length){descriptors[index]=data;}else{descriptors.push(data);}
return jscape.AuthService.multiple(descriptors.length>0?descriptors[0]:jscape.AuthService.domain(),descriptors.length>1?descriptors[1]:jscape.AuthService.domain(),descriptors.length>2?descriptors.slice(2):[]);},_createDescriptor:function(){var primaryService=this.descriptors.length>0?this.descriptors[0]:jscape.AuthService.domain();var secondaryService=this.descriptors.length>1?this.descriptors[1]:jscape.AuthService.domain();var otherDescriptors=this.descriptors.length>2?this.descriptors.slice(2):[];return jscape.AuthService.multiple(primaryService,secondaryService,otherDescriptors);},_confirmDelete:function(){return jscape.ConfirmDialog.confirm(window.R.string.AUTH_CONFIRM_DELETE_TITLE,window.R.string.AUTH_CONFIRM_DELETE_MESSAGE);}});jscape.domain.MultipleAuthServiceView=jscape.ui.DatagridView.extend({initialize:function(minServicesCount,maxServicesCount){var initializing=true;this.minCount=parseInt(minServicesCount)||1;this.maxCount=parseInt(maxServicesCount)||1;this.fieldset=$("#multipleauthfields").layout({fit:true,border:false,doSize:false}).hide();this.data=$("table[role=grid][aria-label=multipleauthconfigs]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,singleSelect:false,remoteSort:false,columns:[[{field:"order",title:$("thead th:nth-child(1)",this.data).text(),width:"15%",formatter:$.proxy(this._formatOrder,this),styler:function(){return"font-weight:bold";}},{field:"type",title:$("thead th:nth-child(2)",this.data).text(),width:"85%",formatter:$.proxy(this._formatType,this)}]],onBeforeSelect:function(){return!$(this).datagrid("options").disabled;},onBeforeCheck:function(){return!$(this).datagrid("options").disabled;},onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onDblClick$Row,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustButtonsState,this)});this.moveUpButton=$("a[role=button][name=moveup]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveUpButton,this)});this.moveDownButton=$("a[role=button][name=movedown]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveDownButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.MultipleAuthServiceView.LISTENER;this.fieldset.form("validate");this.fieldset.show().layout({height:"auto"});this._adjustButtonsState();},hide:function(){this.fieldset.hide();},valid:function(){var data=this.data.datagrid("getData");return data.length>=this.minCount&&data.length<=this.maxCount;},setDescriptors:function(items,selectIndex){this.data.datagrid("loadData",items);this.data.datagrid("selectRow",selectIndex);this._onForm$Change();},_formatOrder:function(_,rowData,rowIndex){var values=(window.R.string.AUTH_ORDER_FORMAT||"").split(",");return rowIndex<values.length?values[rowIndex]:"";},_formatType:function(value){return window.R.string["AUTH_TYPE_"+(""+value).toUpperCase()]||"";},_onClick$AddButton:function(){if(this.data.datagrid("getData").length<this.maxCount){this.listener.onAdd();}else{this._showMaxServicesCountError();}},_onClick$EditButton:function(){this.listener.onEdit(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDelete(this.selection);},_onClick$MoveUpButton:function(){this.listener.onMoveUp(this.selection[0]);},_onClick$MoveDownButton:function(){this.listener.onMoveDown(this.selection[0]);},_onDblClick$Row:function(index,row){if($.inArray(row,this.selection)==-1||this.selection.length>1){this.data.datagrid("unselectAll").datagrid("selectRow",index);}
this.editButton.click();},_onLoad$Data:function(params,success,error){this.listener.onRefresh().done(success).fail(error);},_onForm$Change:function(){this.fieldset.closest("[role=group]").triggerHandler("_change");},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.moveUpButton,this.moveDownButton]);},_showMinServicesCountError:function(){$.messager.alert(window.R.string.APPLICATION_TITLE,window.R.string.AUTH_ERROR_MULTIPLE_MIN_COUNT.supplant({0:this.minCount}),"error");},_showMaxServicesCountError:function(){$.messager.alert(window.R.string.APPLICATION_TITLE,window.R.string.AUTH_ERROR_MULTIPLE_MAX_COUNT.supplant({0:this.maxCount}),"warning");},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var selectionCount=this.selection.length;var totalRowsCount=this.data.datagrid("getRows").length;var index=selectionCount==1?this.data.datagrid("getRowIndex",this.selection[0]):-1;var disabled=this.fieldset.is(":disabled");this.moveUpButton.linkbutton(!disabled&&index>0&&index<=totalRowsCount-1?"enable":"disable");this.moveDownButton.linkbutton(!disabled&&index>=0&&index<totalRowsCount-1?"enable":"disable");this.addButton.linkbutton(!disabled?"enable":"disable");this.editButton.linkbutton(!disabled&&selectionCount==1?"enable":"disable");this.deleteButton.linkbutton(!disabled&&selectionCount!=0?"enable":"disable");}});jscape.domain.MultipleAuthServiceView.LISTENER={onMoveUp:$.noop,onMoveDown:$.noop,onAdd:$.noop,onEdit:$.noop,onDelete:$.noop,onTest:$.noop};jscape.domain.UserMultipleAuthServiceController=Class.extend({initialize:function(){this.controllers={DOMAIN:jscape.domain.DomainAuthServiceController,DB:jscape.domain.DbAuthServiceController,DB_QUERY:jscape.domain.DbQueryAuthServiceController,LDAP:jscape.domain.LdapAuthServiceController,LDAP_QUERY:jscape.domain.LdapQueryAuthServiceController,NTLM:jscape.domain.NtlmAuthServiceController,PAM:jscape.domain.PamAuthServiceController,RADIUS:jscape.domain.RadiusAuthServiceController,CUSTOM:jscape.domain.CustomAuthServiceController};},start:function(listener,domainName,descriptor){this.listener=listener||jscape.domain.UserMultipleAuthServiceController.LISTENER;this.domainName=domainName;this.templates=[];this.deferred=$.Deferred();var promise=this.deferred.promise();this.onLoadUserTemplates().then($.proxy(function(data){this.templates=data||[];},this),$.proxy(function(){this.templates=[];},this)).then($.proxy(this._selectServiceType,this)).then($.proxy(function(type){var theClass=this.controllers[type].extend({onTest:$.proxy(this.onTest,this)});var dialog=this._setupDialog(type);this.controller=new theClass(dialog.container());this.controller.start(domainName,descriptor,this.templates);dialog.show(this);},this),$.proxy(function(){this.deferred.reject();},this));return promise;},onSubmit:function(dialog){var data=this.controller._createDescriptor();dialog.destroy();this.deferred.resolve(data);},onCancel:function(dialog){dialog.destroy();return this.deferred.reject();},onTest:function(){return this.listener.onTest(this.controller._createDescriptor());},onLoadUserTemplates:function(){if(this.templates.length){return $.Deferred().resolve(this.templates).promise();}
return jscape.API.getAccountTemplateNames(this.domainName).then(function(data){return data.sort();},function(){return[];}).done($.proxy(function(data){this.templates=data},this));},_selectServiceType:function(){return $.Deferred().reject().promise();},_setupDialog:function(type){}});jscape.domain.UserMultipleAuthServiceController.LISTENER={onTest:$.noop};jscape.domain.UserMultipleAuthServiceDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog){this._super(dialog,{width:"60%",minWidth:750,height:"60%"});this.fieldset=this.dialog.find(".content").first().layout({fit:true,border:false,doSize:false});this.title=this.dialog.dialog("header").text()||"";},container:function(){return this.fieldset.layout("panel","center");},setServiceType:function(value){this.setTitle(this.title.supplant({0:window.R.string["AUTH_TYPE_"+(""+value).toUpperCase()]||""}));},show:function(){this._super.apply(this,arguments);this.fieldset.layout("resize",{width:"auto",height:"auto"});this.fieldset.form("validate");setTimeout($.proxy(function(){this.fieldset.find(".validatebox-invalid").first().trigger("focusin");},this),50);}});jscape.domain.AddUserMultipleAuthServiceController=jscape.domain.UserMultipleAuthServiceController.extend({_selectServiceType:function(){var deferred=$.Deferred();var dialog=new jscape.domain.UserMultipleAuthServiceTypeDialog();dialog.show({onSubmit:$.proxy(function(d){var type=d.getType();d.destroy();deferred.resolve(type);},this),onCancel:$.proxy(function(d){d.destroy();deferred.reject();},this)});return deferred.promise();},_setupDialog:function(type){var dialog=new jscape.domain.UserMultipleAuthServiceDialog($("#d-auth-multi-service-add"));dialog.setServiceType(type);return dialog;}});jscape.domain.EditUserMultipleAuthServiceController=jscape.domain.UserMultipleAuthServiceController.extend({start:function(listener,domainName,descriptor){this.serviceType=descriptor.type;return this._super.apply(this,arguments);},_selectServiceType:function(){return $.Deferred().resolve(this.serviceType).promise();},_setupDialog:function(type){var dialog=new jscape.domain.UserMultipleAuthServiceDialog($("#d-auth-multi-service-edit"));dialog.setServiceType(type);return dialog;}});jscape.domain.UserMultipleAuthServiceTypeDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-auth-service-type"),{width:"40%",minWidth:530,maxWidth:700});this.type=$("select[name=type]",this.dialog).combobox({required:true,limitToList:true,keyHandler:$.extend({},$.fn.combobox.defaults.keyHandler,{enter:$.proxy(function(e){$.fn.combobox.defaults.keyHandler.enter.call(e.data.target,e);if(!this.type.combobox("panel").is(":visible")){var okBtn=this.okButton;setTimeout(function(){okBtn.click();okBtn=undefined;},100);}},this)}),width:"60%",panelHeight:"auto",panelMaxHeight:"40%"});this.type.combobox("textbox").on("focus",function(){$(this).select();});},getType:function(){return this.type.combobox("getValue");}});jscape.domain.TestAuthServiceController=Class.extend({deferred:null,start:function(domainName,descriptor){this.domainName=domainName;this.descriptor=descriptor;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.testAuthenticationService(this.domainName,this.descriptor,dialog.getUsername(),dialog.getPassword(),dialog.getClientIp()).done($.proxy(this._testPassed,this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.domain.TestAuthCredentialsDialog();},_testPassed:function(){$.messager.alert(window.R.string.AUTH_ERROR_TEST_TITLE,window.R.string.AUTH_ERROR_TEST_SUCCESS_MESSAGE,"info");this.deferred.resolve();this.deferred=null;}});jscape.domain.TestAuthCredentialsDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-auth-credentials"),{width:530,resizable:false});this.fieldset=$("fieldset[name=testauthcredentialsfields]",this.dialog);this.username=$("input[name=username]",this.fieldset).textbox({width:"60%"});this.password=$("input[name=password]",this.fieldset).passwordbox2({width:"60%"});this.clientIp=$("input[name=clientip]",this.fieldset).textbox({width:"50%"});},getUsername:function(){return this.username.textbox("getValue");},getPassword:function(){return this.password.passwordbox2("getValue");},getClientIp:function(){return this.clientIp.textbox("getValue");}});jscape.domain.TwoFactorAuthServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.UserConfirmationService.none(),view:null,type:null,descriptor:null,initialize:function(){this.controllers={NONE:jscape.domain.NoneUserConfirmationServiceController,PHONE:jscape.domain.PhoneFactorServiceController,TOTP:jscape.domain.TotpUserConfirmationServiceController,CUSTOM:jscape.domain.CustomUserConfirmationServiceController};},onCreate:function(domainName){this.domainName=domainName;},onStart:function(){if(this.view==null){this.view=new jscape.domain.TwoFactorAuthServiceServiceView();}
this.view.show(this);},onResume:function(){jscape.API.getTwoFactorService(this.domainName).done($.proxy(function(descriptor){this.descriptor=descriptor;},this)).fail($.proxy(function(){this.descriptor=this.DEFAULT_DESCRIPTOR;},this)).always($.proxy(function(){this._setupView(this.descriptor);},this));},onApply:function(){var c=this.controllers[this._serviceTypeOf(this.view)]||null;if(!c){return $.Deferred().reject().promise();}
return c.onApply().done($.proxy(function(descriptor){this.descriptor=descriptor;},this));},onDiscard:function(){var c=this.controllers[this._serviceTypeOf(this.view)]||null;c&&c.onDiscard();this._setupView(this.descriptor);},onChange:function(){var changed=this.hasChanged();return $.Deferred().resolve(changed).promise();},onChangeType:function(view){var serviceType=this._serviceTypeOf(view);$.each(this.controllers,$.proxy(function(type,controller){var t=typeof controller;if(serviceType===type){this.type=serviceType;if(t==="function"){this.controllers[type]=new controller(view.container());this.controllers[type].start(this.domainName,this.descriptor);}else if(t==="object"){controller.resume(this.descriptor);}}else{if(t==="object"){controller.pause();}}},this));},hasChanged:function(){var type=this.descriptor?this.descriptor.type:this.type;if(type!=this._serviceTypeOf(this.view)){return true;}
var c=this.controllers[type];return!!c&&typeof c.hasChanged==="function"&&c.hasChanged();},_serviceTypeOf:function(view){return(view.getType()||"").toUpperCase();},_setupView:function(descriptor){var type=descriptor&&descriptor.type?descriptor.type:this.DEFAULT_DESCRIPTOR.type;this.view.setType(type);}});jscape.domain.TwoFactorAuthServiceServiceView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#domain-two-factor-auth-fields").layout({fit:true,doSize:false,border:false});this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,selectOnNavigation:false,onChange:$.proxy(this._onChange$Type,this),width:"25%",minWidth:250,panelHeight:"auto",panelMinHeight:80,panelMaxHeight:"40%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},container:function(){return this.fieldset.layout("panel","center");},show:function(listener){this.listener=listener||jscape.domain.TwoFactorAuthServiceServiceView.LISTENER;},getType:function(){return this.type.combobox("getValue");},setType:function(value){var selectedType=this.type.combobox("getValue");this.type.combobox("clear").combobox("select",value);if(selectedType===value){this._onChange$Type();}},_onChange$Type:function(){this.listener.onChangeType(this);this.fieldset.triggerHandler("_change");},_onClick$ApplyButton:function(){this.applyButton.linkbutton("disable");this.listener.onApply(this).catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));}});jscape.domain.TwoFactorAuthServiceServiceView.LISTENER={onChangeType:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.NoneUserConfirmationServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(){this._super(jscape.UserConfirmationService.TYPE.NONE);this.view=new jscape.domain.NoneAuthServiceView();},_createDescriptor:function(){return jscape.UserConfirmationService.none();},onApply:function(){return jscape.API.setTwoFactorService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._fireApplySuccess();},this));}});jscape.domain.PhoneFactorServiceController=jscape.domain.BaseAuthServiceController.extend({VARIABLES:["installdir"],initialize:function(){this._super(jscape.UserConfirmationService.TYPE.PHONE);this.view=new jscape.domain.PhoneFactorServiceView();this.variableController=new jscape.VariableController();},onAddVariable:function(input){this.variableController.start(input,this.VARIABLES);},onSelectPath:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectPath().then(function(entry){return entry.path;});},onApply:function(){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setTwoFactorService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},_createDescriptor:function(){return jscape.UserConfirmationService.phoneFactor(this.view.getDirectory(),this.view.getPassword(),this.view.isInternationalCallsAllowed());},_setupView:function(descriptor){if(descriptor){this.view.setDirectory(descriptor.licenseDirectory);this.view.setPassword(descriptor.password);this.view.setInternationalCallsAllowed(descriptor.internationalCallsAllowed);}}});jscape.domain.PhoneFactorServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(){this._super($("#phonefactorauthfields"));this.directory=$("input[name=dir]",this.fieldset).textbox({required:true,validType:"length[1,500]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_PHONE_DIR,invalidMessage:window.R.string.AUTH_ERROR_BAD_PHONE_DIR,tipPosition:"bottom",width:610});this.browseDir=$("a[role=button][name=browsedir]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseDirectory,this)});this.password=$("input[name=password]",this.fieldset).passwordbox2({onChange:$.proxy(this._onForm$Change,this),width:410});this.allowInternationalCall=$("input[name=allowinterncall]:checkbox",this.fieldset);},getDirectory:function(){return this.directory.textbox("getValue");},setDirectory:function(value){this.directory.textbox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue");},setPassword:function(value){this.password.passwordbox2("setValue",value);},isInternationalCallsAllowed:function(){return this.allowInternationalCall.is(":checked");},setInternationalCallsAllowed:function(value){this.allowInternationalCall.prop("checked",!!value);},_onClick$BrowseDirectory:function(){this.browseDir.linkbutton("disable");this.listener.onSelectPath(this).done($.proxy(function(path){this.directory.textbox("setValue",path).textbox("textbox").focus();},this)).always($.proxy(function(){this.browseDir.linkbutton("enable");},this));}});jscape.domain.CustomUserConfirmationServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(){this._super(jscape.UserConfirmationService.TYPE.CUSTOM);this.view=new jscape.domain.CustomUserConfirmationServiceView();},onApply:function(){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setTwoFactorService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},_createDescriptor:function(){return jscape.UserConfirmationService.custom(this.view.getClassName());},_setupView:function(descriptor){if(descriptor){this.view.setClassName(descriptor.serviceClassName);}}});jscape.domain.CustomUserConfirmationServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(){this._super($("#customuserconfirmfields"));this.className=$("input[name=classname]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_CLASS,invalidMessage:window.R.string.AUTH_ERROR_BAD_CLASS,width:500});},getClassName:function(){return this.className.textbox("getValue");},setClassName:function(value){this.className.textbox("setValue",value);}});jscape.domain.TotpUserConfirmationServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(){this._super(jscape.UserConfirmationService.TYPE.TOTP);this.view=new jscape.domain.TotpUserConfirmationServiceControllerView();},onApply:function(){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setTwoFactorService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},_createDescriptor:function(){return jscape.UserConfirmationService.totp();},_setupView:function(descriptor){}});jscape.domain.TotpUserConfirmationServiceControllerView=jscape.domain.BaseAuthServiceView.extend({initialize:function(){this._super($("#totpuserconfirmfields"));}});jscape.domain.WebSsoAuthServiceController=Class.extend({DEFAULT_DESCRIPTOR:jscape.AuthService.none(),view:null,type:null,descriptor:null,initialize:function(){this.controllers={NONE:jscape.domain.NoneWebSsoAuthServiceController,OPEN_ID:jscape.domain.OpenIdAuthServiceController,OPEN_ID_CONNECT:jscape.domain.OpenIdConnectAuthServiceController,SAML:jscape.domain.SamlAuthServiceController};},onCreate:function(domainName){this.domainName=domainName;},onStart:function(){if(this.view==null){this.view=new jscape.domain.WebSsoAuthServiceView();}
this.view.show(this);},onResume:function(){$.when(jscape.API.getWebSsoService(this.domainName),jscape.API.getAccountTemplateNames(this.domainName)).done($.proxy(function(descriptor,templates){this.descriptor=descriptor;this.templates=templates.sort();},this)).fail($.proxy(function(){this.descriptor=this.DEFAULT_DESCRIPTOR;this.templates=[];},this)).always($.proxy(function(){this._setupView(this.descriptor);},this));},onApply:function(){var c=this.controllers[this._serviceTypeOf(this.view)]||null;if(!c){return $.Deferred().reject().promise();}
return c.onApply().done($.proxy(function(descriptor){this.descriptor=descriptor;},this));},onDiscard:function(){var c=this.controllers[this._serviceTypeOf(this.view)]||null;c&&c.onDiscard();this._setupView(this.descriptor);},onChange:function(){var changed=this.hasChanged();return $.Deferred().resolve(changed).promise();},onChangeType:function(view){var serviceType=this._serviceTypeOf(view);$.each(this.controllers,$.proxy(function(type,controller){var t=typeof controller;if(serviceType===type){this.type=serviceType;if(t==="function"){this.controllers[type]=new controller(view.container());this.controllers[type].start(this.domainName,this.descriptor,this.templates);}else if(t==="object"){controller.resume(this.descriptor,this.templates);}}else{if(t==="object"){controller.pause();}}},this));},hasChanged:function(){var type=this.descriptor?this.descriptor.type:this.type;if(type!=this._serviceTypeOf(this.view)){return true;}
var c=this.controllers[type];return!!c&&typeof c.hasChanged==="function"&&c.hasChanged();},_serviceTypeOf:function(view){return(view.getType()||"").toUpperCase();},_setupView:function(descriptor){var type=descriptor&&descriptor.type?descriptor.type:this.DEFAULT_DESCRIPTOR.type;this.view.setType(type);}});jscape.domain.WebSsoAuthServiceView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#domain-web-sso-auth-fields").layout({fit:true,doSize:false,border:false});this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,selectOnNavigation:false,onChange:$.proxy(this._onChange$Type,this),width:"25%",minWidth:300,panelHeight:"auto",panelMinHeight:80,panelMaxHeight:"40%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},container:function(){return this.fieldset.layout("panel","center");},show:function(listener){this.listener=listener||jscape.domain.WebSsoAuthServiceView.LISTENER;},getType:function(){return this.type.combobox("getValue");},setType:function(value){var selectedType=this.type.combobox("getValue");this.type.combobox("clear").combobox("select",value);if(selectedType===value){this._onChange$Type();}},_onChange$Type:function(){this.listener.onChangeType(this);this.fieldset.triggerHandler("_change");},_onClick$ApplyButton:function(){this.applyButton.linkbutton("disable");this.listener.onApply(this).catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));}});jscape.domain.WebSsoAuthServiceView.LISTENER={onChangeType:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.domain.NoneWebSsoAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(){this._super(jscape.AuthService.TYPE.NONE);this.view=new jscape.domain.NoneAuthServiceView();},_createDescriptor:function(){return jscape.AuthService.none();},onApply:function(){return jscape.API.setWebSsoService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._fireApplySuccess();},this));}});jscape.domain.SamlAuthServiceController=jscape.domain.BaseAuthServiceController.extend({decryptionKeys:null,hostKeys:null,initialize:function(){this._super(jscape.WebSsoService.TYPE.SAML);this.view=new jscape.domain.SamlAuthServiceView();},start:function(){this.decryptionKeys=[];this.hostKeys=[];this._super.apply(this,arguments);},onApply:function(){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setWebSsoService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},onLoadDecryptionKeys:function(){if(this.decryptionKeys.length){return $.Deferred().resolve(this.decryptionKeys).promise();}
return jscape.API.getServerKeys(this.domainName).then(function(keys){return $.map(keys,function(key){return key.name;});}).done($.proxy(function(names){this.decryptionKeys=names;},this));},onLoadHostKeys:function(){if(this.hostKeys.length){return $.Deferred().resolve(this.hostKeys).promise();}
return jscape.API.getHostCertificates(this.domainName).then(function(certificates){return $.map(certificates,function(c){return c.name;});}).done($.proxy(function(names){this.hostKeys=names;},this));},_createDescriptor:function(){return jscape.WebSsoService.saml(this.view.getSignInUrl(),this.view.getSignOutUrl(),this.view.getChangePasswordUrl(),this.view.getDecryptionKey()!=null?new jscape.ServerKeyProvider(this.view.getDecryptionKey()):null,this.view.getHostKey(),this.view.getNameIdFormat(),this.view.isNonSsoLoginAllowed(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setSignInUrl(descriptor.signInUrl);this.view.setSignOutUrl(descriptor.signOutUrl);this.view.setChangePasswordUrl(descriptor.changePasswordUrl);if(descriptor.decryptionKeyProvider){this.view.setDecryptionKey(descriptor.decryptionKeyProvider.keyAlias);}
this.view.setHostKey(descriptor.verificationHostKey);this.view.setNameIdFormat(descriptor.nameIdFormat);this.view.setNonSsoLoginAllowed(descriptor.nonSsoLoginAllowed);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.SamlAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(){this._super($("#webssoauthsamlfields"));var initializing=true;this.signInUrl=$("input[name=signinurl]",this.fieldset).textbox({required:true,validType:"length[1,500]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_SIGNIN_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_SIGNIN_URL,width:610});this.signOutUrl=$("input[name=signouturl]",this.fieldset).textbox({required:true,validType:"length[1,500]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_SIGNOUT_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_SIGNOUT_URL,width:610});this.changePasswordUrl=$("input[name=changepwdurl]",this.fieldset).textbox({onChange:$.proxy(this._onForm$Change,this),width:610});this.nonSsoLoginAllowed=$("input[name=allownonsso]:checkbox",this.fieldset);this.useDecryptionKey=$("input[name=usedecryptionkey]:checkbox",this.fieldset).change($.proxy(function(){this.decryptionKey.combobox(this.useDecryptionKey.is(":checked")?"enable":"disable");},this));this.decryptionKey=$("select[name=decryptionkey]",this.fieldset).combobox({editable:false,disabled:true,loader:$.proxy(this._onLoad$DecryptionKeys,this),onBeforeLoad:function(){return!initializing;},onChange:$.proxy(this._onForm$Change,this),width:"30%",panelHeight:"auto",panelMinHeight:80,panelMaxHeight:"40%"});this.hostKey=$("select[name=hostkey]",this.fieldset);this.hostKey.combobox({required:true,editable:false,loader:$.proxy(this._onLoad$HostKeys,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._onLoadSuccess$HostKey,this),onChange:$.proxy(this._onForm$Change,this),width:"30%",panelHeight:"auto",panelMaxHeight:"40%"});this.nameIdFormat=$("select[name=nameidformat]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onForm$Change,this),width:"30%",panelHeight:"auto",panelMaxHeight:"40%"});initializing=false;},show:function(){this._super.apply(this,arguments);this.decryptionKey.combobox("reload").combobox("resize");this.hostKey.combobox("reload").combobox("resize");this.nameIdFormat.combobox("resize");},getSignInUrl:function(){return this.signInUrl.textbox("getValue");},setSignInUrl:function(value){this.signInUrl.textbox("setValue",value);},getSignOutUrl:function(){return this.signOutUrl.textbox("getValue");},setSignOutUrl:function(value){this.signOutUrl.textbox("setValue",value);},getChangePasswordUrl:function(){return this.changePasswordUrl.textbox("getValue");},setChangePasswordUrl:function(value){this.changePasswordUrl.textbox("setValue",value);},getDecryptionKey:function(){return this.useDecryptionKey.is(":checked")?this.decryptionKey.combobox("getValue"):null;},setDecryptionKey:function(value){this.useDecryptionKey.prop("checked",!!value).change();if(value){this.decryptionKey.combobox("clear").combobox("select",value)}},getHostKey:function(){return this.hostKey.combobox("getValue");},setHostKey:function(value){this.hostKey.combobox("setValue",value);},getNameIdFormat:function(){return this.nameIdFormat.combobox("getValue");},setNameIdFormat:function(value){value&&this.nameIdFormat.combobox("select",value);},isNonSsoLoginAllowed:function(){return this.nonSsoLoginAllowed.is(":checked");},setNonSsoLoginAllowed:function(value){this.nonSsoLoginAllowed.prop("checked",!!value).change();},_onLoad$DecryptionKeys:function(params,success,error){this.listener.onLoadDecryptionKeys(params).done(success).fail(error);},_onLoad$HostKeys:function(params,success,error){this.listener.onLoadHostKeys(params).done(success).fail(error);},_onLoadSuccess$HostKey:function(data){if(data&&data.length==0){this.hostKey.combobox("disable").combobox("disableValidation");}}});jscape.domain.OpenIdAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(){this._super(jscape.WebSsoService.TYPE.OPEN_ID);this.view=new jscape.domain.OpenIdAuthServiceView();},onApply:function(){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setWebSsoService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},_createDescriptor:function(){return jscape.WebSsoService.openId(this.view.getSignInUrl(),this.view.getSignOutUrl(),this.view.isNonSsoLoginAllowed(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setSignInUrl(descriptor.signInUrl);this.view.setSignOutUrl(descriptor.signOutUrl);this.view.setNonSsoLoginAllowed(descriptor.nonSsoLoginAllowed);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.OpenIdAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(){this._super($("#webssoauthopenidfields"));this.signInUrl=$("input[name=signinurl]",this.fieldset).textbox({required:true,validType:"length[1,500]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_SIGNIN_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_SIGNIN_URL,width:610});this.signOutUrl=$("input[name=signouturl]",this.fieldset).textbox({required:true,validType:"length[1,500]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_SIGNOUT_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_SIGNOUT_URL,width:610});this.nonSsoLoginAllowed=$("input[name=allownonsso]:checkbox",this.fieldset);},getSignInUrl:function(){return this.signInUrl.textbox("getValue");},setSignInUrl:function(value){this.signInUrl.textbox("setValue",value);},getSignOutUrl:function(){return this.signOutUrl.textbox("getValue");},setSignOutUrl:function(value){this.signOutUrl.textbox("setValue",value);},isNonSsoLoginAllowed:function(){return this.nonSsoLoginAllowed.is(":checked");},setNonSsoLoginAllowed:function(value){this.nonSsoLoginAllowed.prop("checked",!!value).change();}});jscape.domain.OpenIdConnectAuthServiceController=jscape.domain.BaseAuthServiceController.extend({initialize:function(){this._super(jscape.WebSsoService.TYPE.OPEN_ID_CONNECT);this.view=new jscape.domain.OpenIdConnectAuthServiceView();},onApply:function(){if(!this.view.valid()){return $.Deferred().reject().promise();}
return jscape.API.setWebSsoService(this.domainName,this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;this._setupView(descriptor);this._fireApplySuccess();},this));},_createDescriptor:function(){return jscape.WebSsoService.openIdConnect(this.view.getSignInUrl(),this.view.getTokenUrl(),this.view.getRedirectionUrl(),this.view.getClientId(),this.view.getClientSecret(),this.view.isNonSsoLoginAllowed(),this.view.getTemplate(),this.view.getUsernameConversion());},_setupView:function(descriptor){if(descriptor){this.view.setSignInUrl(descriptor.signInUrl);this.view.setTokenUrl(descriptor.tokenVerificationUrl);this.view.setRedirectionUrl(descriptor.redirectionUrl);this.view.setClientId(descriptor.clientId);this.view.setClientSecret(descriptor.clientSecret);this.view.setNonSsoLoginAllowed(descriptor.nonSsoLoginAllowed);this.view.setTemplate(descriptor.accountTemplate);this.view.setUsernameConversion(descriptor.usernameConversion);}}});jscape.domain.OpenIdConnectAuthServiceView=jscape.domain.BaseAuthServiceView.extend({initialize:function(){this._super($("#webssoauthopenidconnectfields"));this.signInUrl=$("input[name=signinurl]",this.fieldset).textbox({required:true,validType:"url",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_SIGNIN_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_SIGNIN_URL,width:610});this.tokenUrl=$("input[name=tokenurl]",this.fieldset).textbox({required:true,validType:"url",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_TOKEN_URL,invalidMessage:window.R.string.AUTH_ERROR_BAD_TOKEN_URL,width:610});this.redirectionUrl=$("input[name=redirectionurl]",this.fieldset).textbox({required:false,validType:["url","non_empty"],onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_REDIRECTION_URL,width:610});this.clientId=$("input[name=clientid]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_CLIENT_ID,invalidMessage:window.R.string.AUTH_ERROR_BAD_CLIENT_ID,width:510});this.clientSecret=$("input[name=clientsecret]",this.fieldset).passwordbox2({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AUTH_ERROR_BAD_CLIENT_SECRET,invalidMessage:window.R.string.AUTH_ERROR_BAD_CLIENT_SECRET,width:510});this.nonSsoLoginAllowed=$("input[name=allownonsso]:checkbox",this.fieldset);},getSignInUrl:function(){return this.signInUrl.textbox("getValue");},setSignInUrl:function(value){this.signInUrl.textbox("setValue",value);},getTokenUrl:function(){return this.tokenUrl.textbox("getValue");},setTokenUrl:function(value){this.tokenUrl.textbox("setValue",value);},getRedirectionUrl:function(){return this.redirectionUrl.textbox("getValue");},setRedirectionUrl:function(value){this.redirectionUrl.textbox("setValue",value);},getClientId:function(){return this.clientId.textbox("getValue");},setClientId:function(value){this.clientId.textbox("setValue",value);},getClientSecret:function(){return this.clientSecret.passwordbox2("getValue");},setClientSecret:function(value){this.clientSecret.passwordbox2("setValue",value);},isNonSsoLoginAllowed:function(){return this.nonSsoLoginAllowed.is(":checked");},setNonSsoLoginAllowed:function(value){this.nonSsoLoginAllowed.prop("checked",!!value).change();}});