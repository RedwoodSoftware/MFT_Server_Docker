/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.AdHocTransferSummary=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m){this.id=a||"";this.type=jscape.AdHocTransferSummary.Type.valueOf(b);this.user=c||"";this.recipient=d||"";this.ccRecipients=e||[];this.bccRecipients=f||[];this.subject=g||"";this.message=h||"";this.transferObjects=i||[];this.address=j||"";this.dispatchTime=parseInt(k)||0;this.downloads=parseInt(l)||0;this.status=jscape.AdHocTransferSummary.Status.valueOf(m);}});jscape.AdHocTransferSummary.fromJSON=function(data){return data?new jscape.AdHocTransferSummary(data.id,data.type,data.user,data.recipient,data.ccRecipients,data.bccRecipients,data.subject,data.message,$.map(data.transferObjects||[],jscape.AdHocTransferSummary.Entry.fromJSON),data.address,data.dispatchTime,data.downloads,data.status):null;};jscape.AdHocTransferSummary.Entry=Class.extend({initialize:function(id,type,name,path,clientAddresses,address,expires,downloads,deletionTime,status){this.id=id||"";this.type=jscape.AdHocTransferSummary.Type.valueOf(type);this.name=name||"";this.path=path||"";this.clientAddresses=clientAddresses||[];this.address=address||"";this.expires=parseInt(expires)||null;this.downloads=parseInt(downloads)||0;this.deletionTime=parseInt(deletionTime)||null;this.status=jscape.AdHocTransferSummary.Status.valueOf(status);}});jscape.AdHocTransferSummary.Entry.fromJSON=function(data){return data?new jscape.AdHocTransferSummary.Entry(data.id,data.type,data.name,data.path,data.clientAddresses,data.address,data.expires,data.downloads,data.deletionTime,data.status):null;};jscape.AdHocTransferSummary.Type={EMAIL:"EMAIL",LINK:"LINK",INTERNAL:"INTERNAL",values:function(){return[this.EMAIL,this.LINK,this.INTERNAL];},valueOf:function(value){return $.inArray(value,this.values())!=-1?value:this.EMAIL;}};jscape.AdHocTransferSummary.Status={ACTIVE:"ACTIVE",REVOKED:"REVOKED",EXPIRED:"EXPIRED",values:function(){return[this.ACTIVE,this.REVOKED,this.EXPIRED];},valueOf:function(value){return $.inArray(value,this.values())!=-1?value:this.ACTIVE;}};jscape.domain.AdHocActivityModule=jscape.domain.DomainModule.extend({initialize:function(coa){this.coa=coa;},onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.AdHocTransfersController();this.controller.onCreate(this.domainName,this.coa);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.AdHocTransfersController=jscape.ui.DatagridController.extend({view:null,onCreate:function(domainName,coa){this.domainName=domainName;this.viewController=new jscape.domain.ViewAdHocTransferController(coa);this.extendController=new jscape.domain.ExtendAdHocTransferController(coa);this.revokeController=new jscape.domain.RevokeAdHocTransferController(coa);},onStart:function(){if(this.view==null){this.view=new jscape.domain.AdHocTransfersView();}
this.view.show(this);},onResume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listAdHocTransfers(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onView:function(transfer){return this.viewController.start(this.domainName,transfer).done($.proxy(function(changed){!!changed&&this.view.refresh();},this));},onExtend:function(transfers){return this.extendController.start(this.domainName,transfers).then($.proxy(this._transferExtended,this,transfers));},onRevoke:function(transfers){return this.revokeController.start(this.domainName,transfers).then($.proxy(this._transferRevoked,this,transfers));},onCopyLink:function(transfer){return jscape.API.getAdHocTransferLink(this.domainName,transfer.id).done(function(data){if(data&&data.uri){new jscape.CopyToClipboardController().start(data.uri,null,window.R.string.ADHOC_TRANSFER_MESSAGE_LINK_COPIED);}});},_transferRevoked:function(transfers){this._reloadAndSelect(transfers)},_transferExtended:function(transfer){this._reloadAndSelect(transfer);}});jscape.domain.AdHocTransfersView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#adhoc-activity-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=adhocactivity]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"date",sortOrder:"desc",idField:"id",columns:[[{field:"date",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"15%",align:"right",finder:"datebox",formatter:function(_,row){return window.moment(row.dispatchTime).format("L, LT");}},{field:"subject",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"23%"},{field:"user",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"13%"},{field:"recipient",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"13%"},{field:"files",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,width:"8%",formatter:function(_,data){return data&&data.transferObjects?data.transferObjects.length:"";}},{field:"downloads",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,width:"10%"},{field:"type",title:$("thead th:nth-child(7)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatType,this),finder:this._finderFor(jscape.AdHocTransferSummary.Type.values(),$.proxy(this._formatType,this))},{field:"status",title:$("thead th:nth-child(8)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleStatus,this),finder:this._finderFor(jscape.AdHocTransferSummary.Status.values(),$.proxy(this._formatStatus,this))}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(function(){this.viewButton.click();},this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.copyLinkButton=$("a[role=button][name=copylink]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)});this.viewButton=$("a[role=button][name=view]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.extendButton=$("a[role=button][name=extend]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExtendButton,this)});this.revokeButton=$("a[role=button][name=revoke]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RevokeButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.AdHocTransfersView.LISTENER;this.data.datagrid("resize");this._adjustState();},_finderFor:function(values,formatter){return{type:"combobox",options:{panelHeight:"auto",data:$.map(values,function(value){return{text:formatter(value),value:value};})}};},_formatType:function(value){return(window.R.string[("ADHOC_TRANSFER_TYPE_"+value).toUpperCase()]||"").escapeXml();},_formatStatus:function(value){return(window.R.string[("ADHOC_TRANSFER_STATUS_"+value).toUpperCase()]||"").escapeXml();},_styleStatus:function(value){switch(value){case jscape.AdHocTransferSummary.Status.ACTIVE:return"color:green";case jscape.AdHocTransferSummary.Status.EXPIRED:return"color:brown";case jscape.AdHocTransferSummary.Status.REVOKED:return"color:red";default:return"color:#000";}},_onClick$CopyLinkButton:function(){this.listener.onCopyLink(this.selection[0],this.copyLinkButton).always($.proxy(function(){this.copyLinkButton.linkbutton("enable");},this));},_onClick$ViewButton:function(){this.viewButton.linkbutton("disable");this.listener.onView(this.selection[0]).always($.proxy(function(){this.viewButton.linkbutton("enable");},this));},_onClick$ExtendButton:function(){this.extendButton.linkbutton("disable");this.listener.onExtend(this.selection).always($.proxy(function(){this.extendButton.linkbutton("enable");},this));},_onClick$RevokeButton:function(){this.revokeButton.linkbutton("disable");this.listener.onRevoke(this.selection).always($.proxy(function(){this.revokeButton.linkbutton("enable");},this));},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_showContextMenu:function(e){this._super(e,[this.viewButton,"-",this.extendButton,this.revokeButton,"-",this.copyLinkButton]);},_adjustState:function(){this.selection=this._pageSelectionFor(this.data);var revokedCount=$.grep(this.selection,function(entry){return jscape.AdHocTransferSummary.Status.REVOKED==entry.status;}).length;this.copyLinkButton.linkbutton(this.selection.length==1?"enable":"disable");this.viewButton.linkbutton(this.selection.length==1?"enable":"disable");this.revokeButton.linkbutton(this.selection.length!=0&&revokedCount==0?"enable":"disable");this.extendButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.domain.AdHocTransfersView.LISTENER={onLoadData:$.noop,onView:$.noop,onExtend:$.noop,onRevoke:$.noop,onCopyLink:$.noop};jscape.domain.ViewAdHocTransferController=Class.extend({deferred:null,changed:null,start:function(domainName,transfer){this.changed=false;this.domainName=domainName;this.transfer=transfer;this.deferred=$.Deferred();this._setupDialog().show(this).refresh();return this.deferred.promise();},onLoadData:function(params){return jscape.API.getAdHocTransfer(this.domainName,this.transfer.id);},onExtendObject:function(objects,dialog){var c=new jscape.domain.ExtendAdHocTransferController();return c.start(this.domainName,[this.transfer],$.map(objects,function(object){return object.id;})).done($.proxy(function(){dialog.refresh();this.changed=true;},this));},onRevokeObject:function(objects,dialog){var c=new jscape.domain.RevokeAdHocTransferController();return c.start(this.domainName,[this.transfer],$.map(objects,function(object){return object.id;})).done($.proxy(function(){dialog.refresh();this.changed=true;},this));},onCopyLink:function(object){return jscape.API.getAdHocTransferLink(this.domainName,this.transfer.id,object.id).done(function(data){if(data&&data.uri){new jscape.CopyToClipboardController().start(data.uri,null,window.R.string.ADHOC_TRANSFER_MESSAGE_LINK_COPIED);}});},onCancel:function(dialog){dialog.destroy();this.deferred.resolve(this.changed);this.deferred=null;},_setupDialog:function(){return new jscape.domain.ViewAdHocTransferDialog();}});jscape.domain.ViewAdHocTransferDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#d-adhoctransfer-view"),{width:"85%",height:"80%",minHeight:600,closable:true,buttons:null});this.fieldset=$("#adhoctransferemailfields"+this.getIdSuffix()).layout({fit:true,doSize:false,border:false});this.user=$("span[aria-label=user]",this.fieldset);this.date=$("span[aria-label=date]",this.fieldset);this.recipient=$("span[aria-label=recipient]",this.fieldset);this.cc=$("span[aria-label=cc]",this.fieldset);this.bcc=$("span[aria-label=bcc]",this.fieldset);this.message=$("span[aria-label=message]",this.fieldset);this.data=$("table[role=grid][aria-label=transferobjects]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,remoteSort:false,sortName:"name",sortOrder:"desc",idField:"id",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),width:"10%",sortable:true},{field:"path",title:$("thead th:nth-child(2)",this.data).text(),width:"23%",sortable:true},{field:"clientAddresses",title:$("thead th:nth-child(3)",this.data).text(),width:"21%",sortable:false,formatter:function(val){return $.isArray(val)?val.join(", "):val}},{field:"downloads",title:$("thead th:nth-child(4)",this.data).text(),width:"8%",sortable:true},{field:"expires",title:$("thead th:nth-child(5)",this.data).text(),width:"12%",sortable:true,formatter:$.proxy(this._formatDate,this),sorter:$.proxy(this._compareNumeric,this),finder:"datebox"},{field:"deletionTime",title:$("thead th:nth-child(6)",this.data).text(),width:"8%",sortable:true,formatter:$.proxy(this._formatDate,this),sorter:$.proxy(this._compareNumeric,this),finder:"datebox"},{field:"type",title:$("thead th:nth-child(7)",this.data).text(),width:"9%",sortable:true,formatter:$.proxy(this._formatType,this),styler:$.proxy(this._styleStatus,this),finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.AdHocTransferSummary.Type.values(),$.proxy(function(entry){return{text:this._formatType(entry),value:entry};},this))}}},{field:"status",title:$("thead th:nth-child(8)",this.data).text(),width:"9%",sortable:true,formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleStatus,this),finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.AdHocTransferSummary.Status.values(),$.proxy(function(entry){return{text:this._formatStatus(entry),value:entry};},this))}}}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.copyLinkButton=$("a[role=button][name=copylink]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)});this.revokeButton=$("a[role=button][name=revoke]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RevokeButton,this)});this.extendButton=$("a[role=button][name=extend]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExtendButton,this)});this.fieldset.layout("panel","south").panel("resize",{height:"auto"});initializing=false;},show:function(listener){this._super(listener);this.fieldset.layout("resize");return this;},refresh:function(){this.data.datagrid("reload");},_formatDate:function(value){return $.isNumeric(value)?new Date(value).toLocaleString():"";},_formatType:function(value){return window.R.string[("ADHOC_TRANSFER_TYPE_"+value).toUpperCase()]||String(value||"").escapeXml();},_formatStatus:function(value){return window.R.string[("ADHOC_TRANSFER_STATUS_"+value).toUpperCase()]||String(value||"").escapeXml();},_styleStatus:function(value){switch(value){case jscape.AdHocTransferSummary.Status.ACTIVE:return"color:green";case jscape.AdHocTransferSummary.Status.EXPIRED:return"color:brown";case jscape.AdHocTransferSummary.Status.REVOKED:return"color:red";default:return"color:#000";}},_compareNumeric:function(o1,o2){o1=parseInt(o1);o2=parseInt(o2);return isNaN(o1)?(isNaN(o2)?0:1):(isNaN(o2)?1:(o1==o2?0:o1>o2?1:-1));},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then($.proxy(function(data){return data?this._loadData(data).transferObjects:[];},this)).done(success).fail(error);},_loadData:function(data){this.user.text(data.user);this.date.text(this._formatDate(data.dispatchTime));this.recipient.text(data.recipient);this.cc.text(data.ccRecipients.join(", "));this.bcc.text(data.bccRecipients.join(", "));this.message.text(data.message);return data;},_onClick$CopyLinkButton:function(){this.copyLinkButton.linkbutton("disable");this.listener.onCopyLink(this.selection[0],this,this.copyLinkButton).always($.proxy(this._adjustState,this));},_onClick$RevokeButton:function(){this.revokeButton.linkbutton("disable");this.listener.onRevokeObject(this.selection,this).always($.proxy(this._adjustState,this));},_onClick$ExtendButton:function(){this.extendButton.linkbutton("disable");this.listener.onExtendObject(this.selection,this).always($.proxy(this._adjustState,this));},_adjustState:function(){this.selection=this.data.datagrid("getSelections");var revokedCount=$.grep(this.selection,function(entry){return jscape.AdHocTransferSummary.Status.REVOKED==entry.status;}).length;this.copyLinkButton.linkbutton(this.selection.length==1?"enable":"disable");this.extendButton.linkbutton(this.selection.length!=0?"enable":"disable");this.revokeButton.linkbutton(this.selection.length!=0&&revokedCount==0?"enable":"disable");}});jscape.domain.ExtendAdHocTransferController=Class.extend({deferred:null,start:function(domainName,transfers,transferObjectIds){this.domainName=domainName;this.transfers=transfers;this.transferObjectIds=transferObjectIds||[];this.deferred=$.Deferred();this._setupDialog(transfers).show(this);return this.deferred.promise();},onSubmit:function(dialog){var expires=(dialog.getDate()||(this._addDays(new Date(),7))).getTime();return $.when.apply(jQuery,$.map(this.transfers,$.proxy(function(transfer){return jscape.API.extendAdHocTransfer(this.domainName,transfer.id,this.transferObjectIds,expires);},this))).done($.proxy(function(){dialog.destroy();this.deferred.resolve(this.transfers);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.ExtendAdHocTransferDialog();dialog.setDate(this._addDays(new Date(),7));return dialog;},_addDays:function(date,days){date.setDate(date.getDate()+days);return date;}});jscape.domain.ExtendAdHocTransferDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-adhoctransfer-extend"),{width:430,resizable:false});this.fieldset=$("fieldset[name=adhoctransferextendfields]",this.dialog);this.date=$("input[name=date]",this.fieldset).datebox({required:true,width:150});this.date.datebox("calendar").calendar({validator:function(date){return new Date().getTime()<date.getTime();}});},getDate:function(){return this.date.datebox("getDate");},setDate:function(value){this.date.datebox("setDate",value);}});jscape.domain.RevokeAdHocTransferController=Class.extend({deferred:null,start:function(domainName,transfers,transferObjectIds){return this._confirmRevoke(transfers).then($.proxy(this._revokeConfirmed,this,domainName,transfers,transferObjectIds));},_confirmRevoke:function(transfers){return jscape.ConfirmDialog.confirm(window.R.string.ADHOC_TRANSFER_REVOKE_TITLE,window.R.string.ADHOC_TRANSFER_REVOKE_MESSAGE);},_revokeConfirmed:function(domainName,transfers,transferObjectIds){return $.when.apply(jQuery,$.map(transfers,function(transfer){return jscape.API.revokeAdHocTransfer(domainName,transfer.id,transferObjectIds);}));}});