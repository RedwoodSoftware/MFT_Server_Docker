/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.LogRecord=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){this.date=parseInt(a)||0;this.clientHost=b||"";this.clientPort=parseInt(c)||0;this.serverHost=d||"";this.serverPort=parseInt(e)||0;this.user=f||"";this.clientRequest=g||"";this.clientMessage=h||"";this.serverStatus=i||"";this.serverMessage=j||"";this.inboundBytes=parseInt(k)||null;this.outboundBytes=parseInt(l)||null;this.sessionId=m||null;this.appInstanceId=n||null;}});jscape.LogRecord.fromJSON=function(data){return data?new jscape.LogRecord(data.date,data.clientHost,data.clientPort,data.serverHost,data.serverPort,data.user,data.clientRequest,data.clientMessage,data.serverStatus,data.serverMessage,data.inboundBytes,data.outboundBytes,data.sessionId,data.appInstanceId):null;};jscape.domain.LogBuffer=Class.extend({DEFAULT_MAX_RECORDS:1000,EOL:"\r\n",data:null,maxRecords:null,initialize:function(a){this.data=[];this.setLength(a);},setLength:function(value){value=parseInt(value);this.maxRecords=!isNaN(value)?value:this.DEFAULT_MAX_RECORDS;this._removeSuperfluousRecords();return this;},clear:function(){this.data=[];return this;},append:function(text){if(!!text){var recordsCount=this.maxRecords;var index=text.length-1;while(--recordsCount>=0&&index>-1){index=text.lastIndexOf(this.EOL,index-this.EOL.length);if(index!=-1){this.data.push(text.substring(index+this.EOL.length));}}
this._removeSuperfluousRecords();}
return this;},appendAll:function(data){if(data&&data.length){for(var i=0,len=data.length;i<len;++i){this.data.push(data[i]);}
this._removeSuperfluousRecords();}
return this;},toString:function(){this._removeSuperfluousRecords();return this.data.join("");},toArray:function(){return[].concat(this.data);},_removeSuperfluousRecords:function(){this.data.splice(this.maxRecords,this.data.length+1);}});jscape.domain.EventLogController=Class.extend({DELAY:5*1000,DEFAULT_MAX_RECORDS:1000,view:null,timerId:null,onCreate:function(domainName){this.domainName=domainName;this.logsBuffer=new jscape.domain.LogBuffer(this.DEFAULT_MAX_RECORDS);this.lastQuery=null;},onStart:function(){if(this.view==null){this.view=new jscape.domain.EventLogView();}
this.view.show(this);},onPause:function(){this._stopPoll();},onResume:function(){if(!this.view.isPaused()){this._poll(0);}},onStop:function(){this._stopPoll();this.logsBuffer.clear();this.lastQuery=null;},hasChanged:function(){return false;},onPauseLog:function(){this._stopPoll();},onResumeLog:function(){this._poll(0);},onExportLogRecords:function(){var c=new jscape.domain.ExportLogRecordsController();return c.start(this.domainName);},onLoadLogRecords:function(params){params=jscape.Page.requestParameters(params);var modified=!Object._equals(params,this.lastQuery);return jscape.API.listLogRecords(this.domainName,params.startIndex,params.count,params.query).then($.proxy(function(data){this.lastQuery=params;if(data&&data.records){if(modified&&data.records.length){this.logsBuffer.clear();}
this.logsBuffer.appendAll(data.records);}
return this.logsBuffer.toArray();},this)).then(jscape.Page.datagridFormatter());},onChangeMaxRecords:function(newValue){this.logsBuffer.setLength(newValue);this._poll(0);},_poll:function(delay){this._stopPoll();this.timerId=setTimeout($.proxy(function(){this.timerId=null;this.view.refresh($.proxy(this._poll,this));},this),arguments.length==0?this.DELAY:delay||0);},_stopPoll:function(){var id=this.timerId;this.timerId=null;id&&clearTimeout(id);}});jscape.domain.EventLogView=jscape.ui.DatagridView.extend({DEFAULT_MAX_RECORDS:1000,initialize:function(el,options){this.sizeFormat=new jscape.SizeFormat();this.__initializing=true;this.fieldset=$(el).layout({fit:true,doSize:true,border:false});this.data=$("table[role=grid][aria-label=records]",this.fieldset);this.data.datagrid($.extend({fit:true,fitColumns:true,pagination:false,search:true,remoteSearch:false,remoteSort:false,sortName:"date",sortOrder:"desc",queryParams:{rows:this.DEFAULT_MAX_RECORDS},columns:[[{field:"date",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,formatter:$.proxy(this._formatDate,this),width:"8%"},{field:"clientHost",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,formatter:$.proxy(this._formatHost,this),width:"10%"},{field:"clientPort",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,formatter:$.proxy(this._formatPort,this),width:"5%"},{field:"serverHost",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,formatter:$.proxy(this._formatHost,this),width:"10%"},{field:"serverPort",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,formatter:$.proxy(this._formatPort,this),width:"5%"},{field:"user",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,width:"7%"},{field:"clientRequest",title:$("thead th:nth-child(7)",this.data).text(),width:"10%"},{field:"clientMessage",title:$("thead th:nth-child(8)",this.data).text(),width:"5%"},{field:"serverStatus",title:$("thead th:nth-child(9)",this.data).text(),sortable:true,width:"10%"},{field:"serverMessage",title:$("thead th:nth-child(10)",this.data).text(),sortable:true,width:"5%"},{field:"inboundBytes",title:$("thead th:nth-child(11)",this.data).text(),formatter:$.proxy(this._formatSize,this),width:"5%"},{field:"outboundBytes",title:$("thead th:nth-child(12)",this.data).text(),formatter:$.proxy(this._formatSize,this),width:"5%"},{field:"sessionId",title:$("thead th:nth-child(13)",this.data).text(),sortable:true,width:"7%"},{field:"appInstanceId",title:$("thead th:nth-child(14)",this.data).text(),sortable:true,width:"8%"}]],loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:$.proxy(function(){var opts=this.data.datagrid("options");opts.emptyMsg=(!!this.__initializing?opts.bufferingMsg:opts.noRecordsMsg)||"";return!this.__initializing;},this)},options||{}));this.maxRecords=$("input[name=maxrecords]",this.fieldset).numberspinner({required:true,min:10,max:1000,increment:10,value:this.DEFAULT_MAX_RECORDS,width:100,onChange:$.proxy(this._onChange$MaxRecords,this)});this.pauseButton=$("a[role=button][name=pauselog]",this.fieldset).linkbutton({toggle:true,onClick:$.proxy(this._onClick$PauseButton,this)});this.exportButton=$("a[role=button][name=exportlog]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ExportButton,this)});this.__initializing=false;},isPaused:function(){return this.pauseButton.linkbutton("options").selected;},show:function(listener){this.listener=listener||jscape.domain.EventLogView.LISTENER;},_formatDate:function(value){return $.isNumeric(value)&&value!=0?new Date(value).toLocaleString():"";},_formatHost:function(value){return value||"";},_formatPort:function(value){return String(value||"").escapeXml();},_formatSize:function(value){return $.isNumeric(value)&&value!=0?this.sizeFormat.format(value):"";},_onLoad$Data:function(params,success,error){this.listener.onLoadLogRecords(params).then(success,error);},_onChange$MaxRecords:function(newValue,oldValue){newValue=parseInt(newValue)||0;oldValue=parseInt(oldValue)||0;this._adjustLogRecordsCount(newValue);this.listener.onChangeMaxRecords(newValue,oldValue);},_onClick$PauseButton:function(){this._adjustPauseButtonText();if(!this.isPaused()){this.listener.onResumeLog();}else{this.listener.onPauseLog();}},_onClick$ExportButton:function(){this.exportButton.linkbutton("disable");this.listener.onExportLogRecords().always($.proxy(function(){this.exportButton.linkbutton("enable");},this));},_adjustLogRecordsCount:function(value){var opts=this.data.datagrid("options");opts.queryParams=$.extend(opts.queryParams,{rows:value});},_adjustPauseButtonText:function(){var text=this.pauseButton.text();this.pauseButton.html(this.pauseButton.html().replace(text,this.pauseButton.data("toggle-text")));this.pauseButton.data("toggle-text",text);}});jscape.domain.EventLogView.LISTENER={onLoadLogRecords:$.noop,onChangeMaxRecords:$.noop,onExportLogRecords:$.noop,onPauseLog:$.noop,onResumeLog:$.noop};jscape.domain.ExportLogRecordsController=Class.extend({deferred:null,start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportLogRecords(this.domainName,dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var filename="domain_logs_{date}.txt".supplant({date:window.moment().format("YYYYMMDDHHmmss")});var dialog=new jscape.ui.ExportDialog($("#d-logging-export"));dialog.setFilename(filename);return dialog;}});