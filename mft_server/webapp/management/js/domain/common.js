/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain.ClientKeyController=Class.extend({deferred:null,start:function(domainName,keyProvider,keyUseNone,keyUseOneTime){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog(keyProvider,keyUseNone,keyUseOneTime).show(this);return this.deferred.promise();},onSubmit:function(dialog){var provider=this._createKeyProvider(dialog);return this.deferred.resolve(provider);},onCancel:function(dialog){dialog.destroy();this.deferred.reject();},onSelectKeyFile:function(dialog){return new SelectPathController($.proxy(jscape.API.listKeystorePath,jscape.API),$.proxy(jscape.API.createKeystorePath,jscape.API)).selectFile().then(function(entry){return entry.path;});},_setupDialog:function(keyProvider,keyUseNone,keyUseOneTime){var dialog=new jscape.domain.ClientKeyDialog(keyUseNone,keyUseOneTime);if(keyProvider instanceof jscape.FileKeyProvider){dialog.setUseKeyFile(keyProvider.file,keyProvider.filePassword);}else{if(keyUseNone){dialog.setUseNone();}else if(keyUseOneTime){dialog.setUseOneTimeKey();}}
jscape.API.getServerKeys(this.domainName).then(function(keys){return $.map(keys,function(key){return key.name;})}).done(function(serverKeys){dialog.setServerKeys(serverKeys);if(keyProvider instanceof jscape.ServerKeyProvider){dialog.setServerKey(keyProvider.keyAlias);}});return dialog;},_createKeyProvider:function(dialog){if(dialog.isUseServerKey()){return new jscape.ServerKeyProvider(dialog.getServerKey());}else if(dialog.isUseKeyFile()){return new jscape.FileKeyProvider(dialog.getKeyFile(),dialog.getKeyFilePassword());}
return null;}});jscape.domain.ClientKeyDialog=jscape.ui.DefaultDialog.extend({initialize:function(showNoneKey,showOneTimeKey){this._super($("#d-clientkeys"),{width:"50%",minWidth:600,maxWidth:750,minHeight:320});this.types=$("input[name=type]:radio",this.fieldset);this.typeNone=this.types.filter("[value=none]");this.typeOneTime=this.types.filter("[value=onetimekey]");this.typeServerKey=this.types.filter("[value=serverkey]");this.typeKeyFile=this.types.filter("[value=keyfile]");this.types.change($.proxy(this._adjustFieldState,this));if(!showNoneKey){this.typeNone.prop("disabled",true);this.typeNone.parents(".row").hide();}
if(!showOneTimeKey){this.typeOneTime.prop("disabled",true);this.typeOneTime.parents(".row").hide();}
this.serverKey=$("select[name=serverkey]",this.fieldset);this.serverKey.combobox({required:true,editable:false,disabled:true,width:170,panelHeight:"auto",onLoadSuccess:$.proxy(function(){var data=this.serverKey.combobox("getData");if(data.length!=0){this.serverKey.combobox("setValue",data[0].value);}else{this.serverKey.combobox("disable");}
this.typeServerKey.prop("disabled",data.length==0);},this)});this.keyFile=$("input[name=keyfile]",this.fieldset).textbox({required:true,missingMessage:window.R.string.DOMAIN_ERROR_BAD_KEY_FILE,width:"50%"});this.keyFilePassword=$("input[name=keyfilepwd]",this.fieldset).passwordbox2({width:"50%"});this.browseKeyFile=$("a[role=button][name=browsekeyfile]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$BrowseKeyFile,this)});},isUseNone:function(){return this.typeNone.is(":checked:not(:disabled)");},setUseNone:function(){this.typeNone.prop("checked",true).change();},isUseOneTimeKey:function(){return this.typeOneTime.is(":checked:not(:disabled)");},setUseOneTimeKey:function(){this.typeOneTime.prop("checked",true).change();},isUseServerKey:function(){return this.typeServerKey.is(":checked");},getServerKey:function(){return this.isUseServerKey()?this.serverKey.combobox("getValue"):null;},setServerKey:function(value){this.serverKey.combobox("select",value);this.typeServerKey.prop("checked",value!=null).change();},setServerKeys:function(values){this.serverKey.combobox("loadData",values);},isUseKeyFile:function(){return this.typeKeyFile.is(":checked");},setUseKeyFile:function(file,filepwd){this.typeKeyFile.prop("checked",true).change();this.keyFile.textbox("setValue",file);this.keyFilePassword.passwordbox2("setValue",filepwd);},getKeyFile:function(){return this.keyFile.textbox("getValue");},getKeyFilePassword:function(){return this.keyFilePassword.passwordbox2("getValue");},show:function(listener){this._super(listener||jscape.domain.ClientKeyDialog.LISTENER);this.dialog.find(".dialog-button input:first").focus();this._adjustFieldState();},_onClick$BrowseKeyFile:function(){this.browseKeyFile.linkbutton("disable");this.listener.onSelectKeyFile(this).done($.proxy(function(path){this.keyFile.textbox("setValue",path).textbox("textbox").focus();},this)).always($.proxy(function(){this.browseKeyFile.linkbutton("enable");},this));},_adjustFieldState:function(){this.serverKey.combobox(this.isUseServerKey()?"enable":"disable");var useKeyFile=this.isUseKeyFile();this.keyFile.textbox(useKeyFile?"enable":"disable");this.keyFilePassword.passwordbox2(useKeyFile?"enable":"disable");this.browseKeyFile.linkbutton(useKeyFile?"enable":"disable");}});jscape.domain.ClientKeyDialog.LISTENER={onSelectKeyFile:$.noop};