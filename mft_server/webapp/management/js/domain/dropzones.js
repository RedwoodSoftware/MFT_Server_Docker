/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.DropZoneDescriptor=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j){this.name=a||"";this.account=b||"";this.path=c||"";this.password=d||null;this.createDirectoryIfNotExists=e!=undefined?!!e:true;this.overwriteFileIfExists=f||false;this.theme=g||null;this.owner=h||null;this.uri=i||"";this.tags=j||[];}});jscape.DropZoneDescriptor.fromJSON=function(data){return data?new jscape.DropZoneDescriptor(data.name,data.account,data.path,undefined,data.createDirectoryIfNotExists,data.overwriteFileIfExists,data.theme,data.owner,data.uri,data.tags):null;};jscape.domain.DropZonesModule=jscape.domain.DomainModule.extend({onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.DropZonesController();this.controller.onCreate(this.domainName);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.DropZonesController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this._initValidators();},onCreate:function(domainName){this.domainName=domainName;this.addController=new jscape.domain.AddDropZoneController();this.editController=new jscape.domain.EditDropZoneController();this.deleteController=new jscape.domain.DeleteDropZoneController();this.purgeController=new jscape.domain.PurgeDropZoneController();},onStart:function(){if(this.view==null){this.view=new jscape.domain.DropZonesView();}
this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listDropZones(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onAddZone:function(){return this.addController.start(this.domainName).done($.proxy(this._dropZoneAdded,this));},onEditZone:function(dropzone){var index=$.inArray(dropzone,this.view.getDropZones());if(index==-1){return $.Deferred().reject().promise();}
return this.editController.start(this.domainName,dropzone).done($.proxy(this._dropZoneEdited,this,index));},onDeleteZone:function(dropzones){return this.deleteController.start(this.domainName,dropzones).done($.proxy(this._dropZoneDeleted,this,dropzones));},onPurgeZone:function(dropzone){return this.purgeController.start(this.domainName,dropzone);},onCopyLink:function(dropzone,target){return jscape.API.getDropZoneLink(this.domainName,dropzone.name).then(function(data){if(data&&data.uri){return new jscape.CopyToClipboardController().start(data.uri,target,window.R.string.APPLICATION_MESSAGE_COPIED,"top");}
return data;});},_dropZoneAdded:function(dropzone){this._recordAdded(dropzone);},_dropZoneEdited:function(index,dropzone){this._recordEdited(dropzone);},_dropZoneDeleted:function(dropzones){this._recordDeleted(dropzones);},_initValidators:function(){var v=new jscape.Validator();v.rule("dropzone_name",$.proxy(this._dropZoneNameValid,this),window.R.string.DROP_ZONE_ERROR_BAD_NAME);v.rule("dropzone_unique",$.proxy(this._dropZoneNotExists,this),window.R.string.DROP_ZONE_ERROR_ALREADY_EXIST);v.nonEmptyRule("dropzone_path_nonempty",window.R.string.DROP_ZONE_ERROR_BAD_PATH);v.rule("dropzone_password_confirm",$.proxy(this._passwordConfirmed,this),window.R.string.DROP_ZONE_ERROR_CONFIRM_PWD);v.rule("dropzone_password_compliance",$.proxy(this._passwordCompliant,this),"");},_dropZoneNameValid:function(name){return/^\w+$/g.test(name);},_dropZoneNotExists:function(name){return $.inArray(name,$.map(this.view.getDropZones(),function(zone){return zone.name;}))==-1;},_passwordCompliant:function(value,params){var accountName=params&&params.length?params[0]:null;var result=jscape.API.testPasswordCompliance(this.domainName,accountName,value);if($.isPlainObject(result)){if(result.valid===false){if(result.message){new jscape.Validator().ruleMessage("dropzone_password_compliance",result.message);}
return false;}}
return true;},_passwordConfirmed:function(value,params){return params&&params.length&&$(params[0]).val()==value;}});jscape.domain.DropZonesView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#dropzone-list-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=dropzones]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,singleSelect:false,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"10%"},{field:"account",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"10%"},{field:"path",title:$("thead th:nth-child(3)",this.data).text(),width:"20%"},{field:"uri",title:$("thead th:nth-child(4)",this.data).text(),width:"15%",searchable:false},{field:"owner",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,width:"10%",sorter:function(a,b){return a==b?0:a==null||a<b?-1:1;}},{field:"theme",title:$("thead th:nth-child(6)",this.data).text(),width:"10%"},{field:"tags",title:$("thead th:nth-child(7)",this.data).text(),width:"25%",formatter:function(value){return String($.isArray(value)?value.join(", "):value).escapeXml();}}]],onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onLoadSuccess:$.proxy(this._onLoad$Success,this),onBeforeLoad:function(){return!initializing;}});this.copyLinkButton=$("a[role=button][name=copylink]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.purgeButton=$("a[role=button][name=purge]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PurgeButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.DropZonesView.LISTENER;this._adjustButtonsState();},getDropZones:function(){return this.getRecords();},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).done(success).fail(error);},_onLoad$Success:function(){this._adjustButtonsState();},_onClick$CopyLinkButton:function(){this.listener.onCopyLink(this.selection[0]);},_onClick$AddButton:function(){this.listener.onAddZone();},_onClick$EditButton:function(){this.listener.onEditZone(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteZone(this.selection);},_onClick$PurgeButton:function(){this.listener.onPurgeZone(this.selection[0]);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.purgeButton,"-",this.copyLinkButton]);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelections");var len=this.selection.length;this.copyLinkButton.linkbutton(len==1?"enable":"disable");this.editButton.linkbutton(len==1?"enable":"disable");this.purgeButton.linkbutton(len==1?"enable":"disable");this.deleteButton.linkbutton(len!=0?"enable":"disable");}});jscape.domain.DropZonesView.LISTENER={onRefresh:$.noop,onCopyLink:$.noop,onAddZone:$.noop,onEditZone:$.noop,onDeleteZone:$.noop,onPurgeZone:$.noop};jscape.domain.BaseDropZoneController=Class.extend({onAddTag:function(value){return jscape.API.storeAclTag(value);},onLoadTags:function(){return jscape.API.getDomainTags(this.domainName);},onLoadUsers:function(){return jscape.API.getAccountNames(this.domainName).then(function(data){return data.sort();},function(){return[];});},onLoadOwners:function(){return jscape.API.getAccountAdminNames(this.domainName).then(function(data){return data.sort();},function(){return[];});},onLoadWebThemes:function(){return jscape.API.getWebThemeNames(this.domainName).then(function(data){return data.sort();},function(){return[];});},onCopyLink:function(target){return $.Deferred().resolve().promise();},_createDescriptor:function(dialog,name){return new jscape.DropZoneDescriptor(name,dialog.getUser(),dialog.getPath(),dialog.getPassword(),dialog.getCreatePathIfNotExists(),dialog.getOverwriteFileIfExists(),dialog.getWebTheme(),dialog.getOwner(),null,dialog.getTags());}});jscape.domain.AddDropZoneController=jscape.domain.BaseDropZoneController.extend({deferred:null,start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var descriptor=this._createDescriptor(dialog,dialog.getName());return jscape.API.addDropZone(this.domainName,descriptor).done($.proxy(function(descriptor){this.deferred.resolve(descriptor);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.domain.AddDropZoneDialog();dialog.setCreatePathIfNotExists(true);dialog.setOverwriteFileIfExists(true);return dialog;}});jscape.domain.EditDropZoneController=jscape.domain.BaseDropZoneController.extend({deferred:null,start:function(domainName,descriptor){this.domainName=domainName;this.zoneName=descriptor.name;this.deferred=$.Deferred();jscape.API.getDropZone(this.domainName,descriptor.name).done($.proxy(function(descriptor){this._setupDialog(descriptor).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},onSubmit:function(dialog){var descriptor=this._createDescriptor(dialog,this.zoneName);return jscape.API.setDropZone(this.domainName,descriptor.name,descriptor).done($.proxy(function(descriptor){this.deferred.resolve(descriptor);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},onCopyLink:function(target){return jscape.API.getDropZoneLink(this.domainName,this.zoneName).then(function(data){if(data&&data.uri){return new jscape.CopyToClipboardController().start(data.uri,target,window.R.string.APPLICATION_MESSAGE_COPIED);}
return data;});},_setupDialog:function(descriptor){var dialog=new jscape.domain.EditDropZoneDialog();if(descriptor){dialog.setName(descriptor.name);dialog.setPath(descriptor.path);dialog.setCreatePathIfNotExists(descriptor.createDirectoryIfNotExists);dialog.setOverwriteFileIfExists(descriptor.overwriteFileIfExists);dialog.setUser(descriptor.account);dialog.setOwner(descriptor.owner);dialog.setWebTheme(descriptor.theme);dialog.setUri(descriptor.uri);dialog.setTags(descriptor.tags);}
return dialog;}});jscape.domain.DropZoneDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog){var initializing=true;this._super(dialog,{width:"50%",minWidth:530,height:"65%"});this.fieldset=this.dialog.find(".content").first().layout({fit:true,border:false,doSize:false});this.path=$("input[name=path]",this.fieldset).textbox({required:true,validType:"dropzone_path_nonempty",missingMessage:window.R.string.DROP_ZONE_ERROR_BAD_PATH,width:"60%"});this.user=$("select[name=account]",this.fieldset).combobox({required:true,editable:true,limitToList:true,missingMessage:window.R.string.DROP_ZONE_ERROR_BAD_ACCOUNT,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Users,this),width:"60%",panelHeight:"auto",panelMinHeight:50,panelMaxHeight:"40%"});var id="dz_"+(1E9*Math.random()>>>0);this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({validType:"dropzone_password_confirm",validParams:["#"+id],missingMessage:window.R.string.DROP_ZONE_ERROR_CONFIRM_PWD,tipPosition:"bottom",width:"60%"});this.password=$("input[name=password]",this.fieldset).attr("id",id).passwordbox2({validType:"dropzone_password_compliance",validateOnCreate:false,validateOnBlur:true,delay:5000,interval:5000,inputEvents:{input:$.proxy(function(cpb,e){var t=$(e.data.target).passwordbox2("getText");cpb.passwordbox2("textbox").validatebox("options").required=t.length!=0;(!t||!t.length)&&cpb.passwordbox2("isValid");},this,this.confirmPassword)},onBeforeValidate:$.proxy(function(){this.confirmPassword&&this.confirmPassword.passwordbox2("isValid");},this),tipPosition:"bottom",width:"60%"});this.ownedBy=$("input[name=ownedby]:checkbox",this.fieldset);this.ownedBy.change($.proxy(function(){this.owner.combobox(this.ownedBy.is(":checked")?"enable":"disable");},this));this.owner=$("select[name=owner]",this.fieldset);this.owner.combobox({editable:true,limitToList:true,disabled:true,loader:$.proxy(this._onLoad$Owners,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(function(data){if(data.length==0){this.ownedBy.prop("disabled",true).prop("checked",false).change();}},this),width:"40%",panelHeight:"auto",panelMinHeight:50});this.brandedBy=$("input[name=brandedby]:checkbox",this.fieldset);this.brandedBy.change($.proxy(function(){this.theme.combobox(this.brandedBy.is(":checked")?"enable":"disable");},this));this.theme=$("select[name=webtheme]",this.fieldset);this.theme.combobox({editable:true,limitToList:true,disabled:true,loader:$.proxy(this._onLoad$Themes,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(function(data){if(data.length==0){this.brandedBy.prop("disabled",true).prop("checked",false).change();}},this),width:"40%",panelHeight:"auto",panelMinHeight:50});this.tags=$("select[name=tags]",this.fieldset).tagbox({limitToList:jscape.acl&&!jscape.acl.tic,hasDownArrow:true,loader:$.proxy(this._onLoad$Tags,this),onBeforeLoad:function(){return!initializing;},onAddTag:$.proxy(this._onClick$AddTagButton,this),tagEditor:$("#d-add-tag-inline"),width:"60%",panelHeight:"auto",panelMinHeight:50});this.createPath=$("input[name=createpath]:checkbox",this.fieldset);this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);this.uri=$("span[aria-label=zoneuri]",this.dialog);this.copyLinkButton=$("a[role=button][name=copylink]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)}).hide();initializing=false;},show:function(listener){this._super(listener);this.user.combobox("reload");this.owner.combobox("reload");this.theme.combobox("reload");this.tags.tagbox("reload");this._adjustPasswordOptions();},getPath:function(){return this.path.textbox("getValue");},setPath:function(value){this.path.textbox("setValue",value);},getUser:function(){return this.user.combobox("getValue");},setUser:function(value){this.user.combobox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue");},getOwner:function(){return this.ownedBy.is(":checked:not(:disabled)")?this.owner.combobox("getValue"):null;},setOwner:function(value){this.ownedBy.prop("checked",value!=null).change();if(value!=null){this.owner.combobox("setValue",value);}},getWebTheme:function(){return this.brandedBy.is(":checked:not(:disabled)")?this.theme.combobox("getValue"):null;},setWebTheme:function(value){this.brandedBy.prop("checked",value!=null).change();if(value!=null){this.theme.combobox("setValue",value);}},getTags:function(){return this.tags.tagbox("getValues");},setTags:function(values){this.tags.tagbox("setValues",values);},getCreatePathIfNotExists:function(){return this.createPath.is(":checked");},setCreatePathIfNotExists:function(value){this.createPath.prop("checked",!!value);},getOverwriteFileIfExists:function(){return this.overwrite.is(":checked");},setOverwriteFileIfExists:function(value){this.overwrite.prop("checked",!!value);},setUri:function(value){value=value||"";this.uri.text(value);if(!!value){this.copyLinkButton.linkbutton("enable").show();}else{this.copyLinkButton.linkbutton("disable").hide();}},_onClick$AddTagButton:function(tag){this.listener.onAddTag(tag).done($.proxy(function(){this.tags.tagbox("reload");},this));},_onClick$CopyLinkButton:function(){var value=this.uri.text();if(!!value){this.listener.onCopyLink(this.uri);}},_onLoad$Users:function(params,success,error){this.listener.onLoadUsers(params).done(success).fail(error);},_onLoad$Owners:function(params,success,error){this.listener.onLoadOwners(params).done(success).fail(error);},_onLoad$Themes:function(params,success,error){this.listener.onLoadWebThemes(params).done(success).fail(error);},_onLoad$Tags:function(params,success,error){this.listener.onLoadTags(params).done(success).fail(error);},_adjustPasswordOptions:function(){var opts=this.password.passwordbox2("textbox").validatebox("options");opts.required=!this.password.passwordbox2("isSatisfied");}});jscape.domain.DropZoneDialog.LISTENER={onAddTag:$.noop,onCopyLink:$.noop,onLoadUsers:$.noop,onLoadOwners:$.noop,onLoadWebThemes:$.noop,onLoadTags:$.noop,onSubmit:$.noop,onCancel:$.noop};jscape.domain.AddDropZoneDialog=jscape.domain.DropZoneDialog.extend({initialize:function(){this._super($("#d-dropzone-add"));this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["dropzone_name","dropzone_unique"],missingMessage:window.R.string.DROP_ZONE_ERROR_BAD_NAME,width:"60%"});},getName:function(){return this.name.textbox("getValue");},show:function(listener){this._super(listener||jscape.domain.AddDropZoneDialog.LISTENER);}});jscape.domain.AddDropZoneDialog.LISTENER=$.extend({onChangeName:$.noop},jscape.domain.DropZoneDialog.LISTENER);jscape.domain.EditDropZoneDialog=jscape.domain.DropZoneDialog.extend({initialize:function(){this._super($("#d-dropzone-edit"));this.title=this.dialog.dialog("header").text()||"";},setName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));}});jscape.domain.DeleteDropZoneController=Class.extend({deferred:null,start:function(domainName,items){this.domainName=domainName;this.deferred=$.Deferred();this._confirmDelete(items).done($.proxy(this._deleteConfirmed,this,items)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(items){var text=$.map(items,function(dropzone){return dropzone.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.DROP_ZONE_CONFIRM_DELETE_TITLE,window.R.string.DROP_ZONE_CONFIRM_DELETE_MESSAGE.supplant({0:text.escapeXml()}),false);},_deleteConfirmed:function(dropzones){$.when.apply(jQuery,$.map(dropzones,$.proxy(function(dropzone){return jscape.API.deleteDropZone(this.domainName,dropzone.name);},this))).done($.proxy(function(){this.deferred.resolve(dropzones);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});jscape.domain.PurgeDropZoneController=Class.extend({deferred:null,start:function(domainName,descriptor){this.domainName=domainName;this.deferred=$.Deferred();this._confirmPurge(descriptor.name).done($.proxy(this._purgeConfirmed,this,descriptor.name)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmPurge:function(zoneName){return jscape.ConfirmDialog.confirm(window.R.string.DROP_ZONE_CONFIRM_PURGE_TITLE,window.R.string.DROP_ZONE_CONFIRM_PURGE_MESSAGE.supplant({0:zoneName}));},_purgeConfirmed:function(zoneName){jscape.API.purgeDropZone(this.domainName,zoneName).done($.proxy(function(){this.deferred.resolve(zoneName);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});