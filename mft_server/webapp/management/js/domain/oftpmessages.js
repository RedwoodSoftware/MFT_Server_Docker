/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.domain=jscape.domain||{};jscape.OftpMessage=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k){this.id=a||"";this.date=parseInt(b)||0;this.type=c||jscape.OftpMessage.Type.REQUEST;this.direction=d||jscape.OftpMessage.Direction.UNKNOWN;this.originator=e||"";this.destination=f||"";this.username=g||"";this.tradingPartner=h||"";this.filename=i||"";this.fileDate=parseInt(j)||0;this.status=k||jscape.OftpMessage.Status.PENDING;}});jscape.OftpMessage.fromJSON=function(data){return data?$.extend(new jscape.OftpMessage(),data):null;};jscape.OftpMessage.Type={REQUEST:"REQUEST",RECEIPT:"RECEIPT"};jscape.OftpMessage.Direction={INCOMING:"INCOMING",OUTGOING:"OUTGOING",UNKNOWN:"UNKNOWN"};jscape.OftpMessage.Status={PENDING:"PENDING",SUCCESS:"SUCCESS",FAILURE:"FAILURE",RELAY_RECEIVED:"RELAY_RECEIVED",RELAY_SENT:"RELAY_SENT",RELAY_FAILURE:"RELAY_FAILURE"};jscape.domain.OftpModule=jscape.domain.DomainModule.extend({initialize:function(soa,doa){this.soa=soa;this.doa=doa;},onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.domain.OftpMessagesController();this.controller.onCreate(this.domainName,this.soa,this.doa);},onStart:function(){this.controller.onStart();},onResume:function(){this.controller.onResume();}});jscape.domain.OftpMessagesController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this._initValidators();},onCreate:function(domainName,soa,doa){this.domainName=domainName;this.sendFileController=new jscape.domain.OftpSendFileController(soa);this.sendReceiptController=new jscape.domain.OftpSendReceiptController(soa);this.sendCertificateController=new jscape.domain.OftpSendCertificateController(soa);this.resendMessageController=new jscape.domain.OftpResendMessageController(soa);this.viewController=new jscape.domain.OftpViewMessageController();this.deleteController=new jscape.domain.OftpDeleteMessageController(doa);},onStart:function(){if(this.view==null){this.view=new jscape.domain.OftpMessagesView();}
this.view.show(this);},onResume:function(){return this.view.refresh();},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listOftpMessages(this.domainName,params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onSendFile:function(){return this.sendFileController.start(this.domainName).done($.proxy(this._refreshAfter,this,1000));},onSendCertificate:function(){return this.sendCertificateController.start(this.domainName);},onSendReceipt:function(message){return this.sendReceiptController.start(this.domainName,message).done($.proxy(this._refreshAfter,this,1000));},onResendMessage:function(message){return this.resendMessageController.start(this.domainName,message).done($.proxy(this._refreshAfter,this,1000));},onViewMessage:function(message){this.viewController.start(this.domainName,message);},onDownloadMessageFile:function(id){return jscape.API.getOftpMessageFile(this.domainName,id);},onDeleteMessage:function(messages){return this.deleteController.start(this.domainName,messages).done($.proxy(this._messageDeleted,this,messages));},_refreshAfter:function(delay){setTimeout($.proxy(function(){this.view.refresh();},this),delay||0);},_messageDeleted:function(messages){this._recordDeleted(messages);},_initValidators:function(){var v=new jscape.Validator();v.rule("oftp_send_virtual_file",$.proxy(this._virtualFilenameValid,this),window.R.string.OFTP_MESSAGES_ERROR_BAD_VIRTUAL_FILE);},_virtualFilenameValid:function(value){return/^[A-Z0-9/\-.&()]{1,26}$/.test(value);}});jscape.domain.OftpMessagesView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#oftp-messages-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=oftpmessages]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"date",sortOrder:"desc",columns:[[{field:"id",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,width:"9%"},{field:"date",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"9%",align:"right",finder:"datebox",formatter:function(value){return new Date(value).toLocaleString();}},{field:"type",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatType,this),finder:this._finderFor([jscape.OftpMessage.Type.RECEIPT,jscape.OftpMessage.Type.REQUEST],$.proxy(this._formatType,this))},{field:"direction",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatDirection,this),finder:this._finderFor([jscape.OftpMessage.Direction.INCOMING,jscape.OftpMessage.Direction.OUTGOING],$.proxy(this._formatDirection,this))},{field:"originator",title:$("thead th:nth-child(8)",this.data).text(),sortable:true,width:"11%"},{field:"destination",title:$("thead th:nth-child(9)",this.data).text(),sortable:true,width:"11%"},{field:"filename",title:$("thead th:nth-child(7)",this.data).text(),sortable:true,width:"14%",formatter:$.proxy(this._formatFilename,this)},{field:"username",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"8%"},{field:"tradingPartner",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"12%"},{field:"status",title:$("thead th:nth-child(10)",this.data).text(),sortable:true,width:"8%",formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._formatStatusStyle,this),finder:this._finderFor([jscape.OftpMessage.Status.PENDING,jscape.OftpMessage.Status.SUCCESS,jscape.OftpMessage.Status.FAILURE,jscape.OftpMessage.Status.RELAY_RECEIVED,jscape.OftpMessage.Status.RELAY_SENT,jscape.OftpMessage.Status.RELAY_FAILURE],$.proxy(this._formatStatus,this))}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$ViewButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),onLoadSuccess:$.proxy(this._onLoad$Success,this)});this.sendFileButton=$("a[role=button][name=sendfile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$SendFileButton,this)});this.sendCertificateButton=$("a[role=button][name=sendCertificate]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$SendCertificateButton,this)});this.viewButton=$("a[role=button][name=view]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.sendReceiptButton=$("a[role=button][name=sendreceipt]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$SendReceiptButton,this)});this.resendButton=$("a[role=button][name=resend]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ResendButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.domain.OftpMessagesView.LISTENER;this.data.datagrid("resize");this._adjustState();},_finderFor:function(values,formatter){return{type:"combobox",options:{panelHeight:"auto",data:$.map(values,function(value){return{text:formatter(value),value:value};})}};},_formatType:function(value){return window.R.string[("OFTP_MESSAGES_TYPE_"+value).toUpperCase()]||"";},_formatDirection:function(value){return window.R.string[("OFTP_MESSAGES_DIRECTION_"+value).toUpperCase()]||"";},_formatFilename:function(value,row){var downloadAllowed=jscape.OftpMessage.Type.REQUEST==row.type&&!!value&&!/odette_certificate_\w+/i.test(value);return downloadAllowed?'<a role="button" data-options="plain:true,iconCls:\'icon-download\'" data-id="'+String(row.id).escapeXml()+'"></a>'+String(value).escapeXml():value;},_formatStatus:function(value){return window.R.string[("OFTP_MESSAGES_STATUS_"+value).toUpperCase()]||"";},_formatStatusStyle:function(value){switch(value){case jscape.OftpMessage.Status.PENDING:return"color:grey";case jscape.OftpMessage.Status.SUCCESS:return"color:green";case jscape.OftpMessage.Status.FAILURE:return"color:red";case jscape.OftpMessage.Status.RELAY_RECEIVED:return"color:grey";case jscape.OftpMessage.Status.RELAY_SENT:return"color:grey";case jscape.OftpMessage.Status.RELAY_FAILURE:return"color:red";default:return"";}},_onClick$SendFileButton:function(){this.sendFileButton.linkbutton("disable");this.listener.onSendFile().always($.proxy(function(){this.sendFileButton.linkbutton("enable");},this));},_onClick$SendCertificateButton:function(){this.sendCertificateButton.linkbutton("disable");this.listener.onSendCertificate().always($.proxy(function(){this.sendCertificateButton.linkbutton("enable");},this))},_onClick$ViewButton:function(){this.listener.onViewMessage(this.selection[0]);},_onClick$ResendButton:function(){this.listener.onResendMessage(this.selection[0]);},_onClick$SendReceiptButton:function(){this.listener.onSendReceipt(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteMessage(this.selection);},_onClick$DownloadButton:function(id){this.listener.onDownloadMessageFile(id);},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).then(success,error);},_onLoad$Success:function(){var self=this;this.data.datagrid("getPanel").find("[role=button][data-id]").linkbutton({onClick:function(){self._onClick$DownloadButton.call(self,$(this).data("id"));}}).tooltip({showDelay:0,content:window.R.string.OFTP_MESSAGES_BUTTON_DOWNLOAD});this._adjustState();},_showContextMenu:function(e){this._super(e,[this.viewButton,this.resendButton,this.deleteButton,"-",this.sendReceiptButton,"-",this.sendFileButton,this.sendCertificateButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");var message=this.selection.length==1?this.selection[0]:null;var isRequest=message&&jscape.OftpMessage.Type.REQUEST;this.viewButton.linkbutton(this.selection.length==1?"enable":"disable");this.resendButton.linkbutton(isRequest&&jscape.OftpMessage.Direction.OUTGOING==message.direction?"enable":"disable");this.sendReceiptButton.linkbutton(isRequest&&jscape.OftpMessage.Direction.INCOMING==message.direction?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.domain.OftpMessagesView.LISTENER={onSendFile:$.noop,onSendReceipt:$.noop,onSendCertificate:$.noop,onViewMessage:$.noop,onResendMessage:$.noop,onDeleteMessage:$.noop,onDownloadMessageFile:$.noop,onRefresh:$.noop};jscape.domain.OftpSendFileController=Class.extend({PROTOCOLS:["OFTP"],DEFAULTS:{fileType:"UNSTRUCTURED",maxRecordSize:128},deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{jscape.API.getTradingPartnerNames(this.domainName,this.PROTOCOLS).done($.proxy(function(names){if(names&&names.length){return names.sort(function(a,b){return a.toUpperCase()>b.toUpperCase();});}
throw window.R.string.OFTP_MESSAGES_ERROR_NO_PARTNERS;},this)).then($.proxy(function(names){this._setupDialog(names).show(this);},this)).catch($.proxy(function(){this._showNoPartnersError();this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},onSelectFile:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectFile().then(function(entry){return entry.path;});},onSelectDebugFile:function(){return new SelectPathController($.proxy(jscape.API.listDebugDir,jscape.API),$.proxy(jscape.API.createDebugPath,jscape.API)).selectFile().then(function(entry){return entry.path;});},onSubmit:function(dialog){return jscape.API.sendTradingPartnerFile(this.domainName,dialog.getPartner(),this._createData(dialog)).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return{path:dialog.getFile()||"",type:dialog.getFileType()||null,maxrecordsize:dialog.getMaxRecordSize()||0,destinationPartner:dialog.getDestinationPartner()||null,virtualfilename:dialog.getVirtualFile()||null,description:dialog.getDescription()||null,placetooutbox:!!dialog.isPlaceToOutbox(),debugfile:dialog.getDebugFile()||""};},_setupDialog:function(partners){var dialog=new jscape.domain.OftpSendFileDialog();dialog.setPartners(partners);dialog.setDestinationPartners(partners);dialog.setFileType(this.DEFAULTS.fileType);dialog.setMaxRecordSize(this.DEFAULTS.maxRecordSize);return dialog;},_showNoPartnersError:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.OFTP_MESSAGES_ERROR_NO_PARTNERS,"warning");}});jscape.domain.OftpSendFileDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-oftp-sendfile"),{width:600,resizable:false});this.fieldset=$("fieldset[name=oftpsendfilefields]",this.dialog);this.partner=$("select[name=partner]",this.fieldset).combobox({required:true,editable:false,width:170,panelHeight:"auto",panelMaxHeight:"40%"});this.destinationPartner=$("select[name=destinationpartner]",this.fieldset).combobox({required:true,editable:false,width:170,panelHeight:"auto"});this.file=$("input[name=file]",this.fieldset).textbox({required:true,tipPosition:"bottom",missingMessage:window.R.string.OFTP_MESSAGES_ERROR_BAD_FILE,width:"50%"});this.browseFileButton=$("a[role=button][name=browsefile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseFileButton,this)});this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,width:170,panelHeight:"auto",onChange:$.proxy(this._onChange$FileType,this)});this.maxRecordSize=$("input[name=recordsize]",this.fieldset).numberspinner({disabled:true,min:1,max:99999,value:1,width:120});this.description=$("input[name=description]",this.fieldset).textbox({width:"50%"});this.virtualFile=$("input[name=virtualfile]",this.fieldset).textbox({validType:"oftp_send_virtual_file",width:"50%"});this.placeToOutbox=$("input[name=placetooutbox]:checkbox",this.fieldset);this.debugFile=$("input[name=debugfile]",this.fieldset).textbox({width:"50%"});this.browseDebugFileButton=$("a[role=button][name=browsedebugfile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseDebugFileButton,this)});},getPartner:function(){return this.partner.combobox("getValue");},setPartners:function(values){this.partner.combobox("loadData",values);},getDestinationPartner:function(){return this.destinationPartner.combobox("getValue");},setDestinationPartners:function(values){this.destinationPartner.combobox("loadData",values);},getFile:function(){return this.file.textbox("getValue");},setFile:function(value){this.file.textbox("setValue",value);},getFileType:function(){return this.type.combobox("getValue");},setFileType:function(value){this.type.combobox("select",value);},getMaxRecordSize:function(){return this.maxRecordSize.is(":disabled")?0:parseInt(this.maxRecordSize.numberspinner("getValue"));},setMaxRecordSize:function(value){return this.maxRecordSize.numberspinner("setValue",parseInt(value));},getDescription:function(){return this.description.textbox("getValue");},getVirtualFile:function(){return this.virtualFile.textbox("getValue");},isPlaceToOutbox:function(){return this.placeToOutbox.is(":checked");},getDebugFile:function(){return this.debugFile.textbox("getValue");},show:function(listener){this._super(listener||jscape.domain.OftpSendFileDialog.LISTENER);this._onChange$FileType();},_onClick$BrowseFileButton:function(){this.browseFileButton.linkbutton("disable");this.listener.onSelectFile(this).done($.proxy(function(path){this.file.textbox("setValue",path).textbox("textbox").select().focus();},this)).always($.proxy(function(){this.browseFileButton.linkbutton("enable");},this));},_onClick$BrowseDebugFileButton:function(){this.browseDebugFileButton.linkbutton("disable");this.listener.onSelectDebugFile(this).done($.proxy(function(path){this.debugFile.textbox("setValue",path).textbox("textbox").select().focus();},this)).always($.proxy(function(){this.browseDebugFileButton.linkbutton("enable");},this));},_onChange$FileType:function(){var enabled=/^(fixed|variable)$/i.test(this.getFileType());this.maxRecordSize.numberspinner(enabled?"enable":"disable");}});jscape.domain.OftpSendFileDialog.LISTENER={onSelectFile:$.noop,onSelectDebugFile:$.noop};jscape.domain.OftpSendReceiptController=Class.extend({PROTOCOLS:["OFTP"],deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,message){this.domainName=domainName;this.messageId=message.id;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._setupDialog().show(this);}
return this.deferred.promise();},onSubmit:function(dialog){var data=this._createData(dialog);return jscape.API.sendOftpMessageReceipt(this.domainName,this.messageId,data).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},onSelectDebugFile:function(){return new SelectPathController($.proxy(jscape.API.listDebugDir,jscape.API),$.proxy(jscape.API.createDebugPath,jscape.API)).selectFile().then(function(entry){return entry.path;});},_createData:function(dialog){return{receiptType:dialog.getType()||null,reason:dialog.getReason()||"",description:dialog.getDescription()||"",connectionPartner:dialog.getPartner()||null,placeToOutbox:!!dialog.isPlaceToOutbox(),debugFile:dialog.getDebugFile()||""};},_setupDialog:function(){var dialog=new jscape.domain.OftpSendReceiptDialog();jscape.API.getTradingPartnerNames(this.domainName,this.PROTOCOLS).done(function(names){dialog.setPartners(names.sort(function(a,b){return a.toUpperCase()>b.toUpperCase();}));});dialog.setType("POSITIVE");return dialog;}});jscape.domain.OftpSendReceiptDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-oftp-sendreceipt"),{width:"55%"});this.fieldset=$("fieldset[name=oftpsendreceiptfields]",this.dialog);this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onChange$Type,this),width:"50%",panelHeight:"auto"});this.reason=$("select[name=reason]",this.fieldset).combobox({required:true,editable:false,width:"50%",panelHeight:"auto"});this.description=$("input[name=description]",this.fieldset).textbox({width:"50%"});this.placeToOutbox=$("input[name=placetooutbox]:checkbox",this.fieldset);this.usePartner=$("input[name=usepartner]:checkbox",this.fieldset).change($.proxy(function(){var enabled=this.usePartner.is(":checked");this.partner.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");},this));this.partner=$("select[name=partner]",this.fieldset).combobox({required:true,editable:false,width:"50%",panelHeight:"auto"});this.debugFile=$("input[name=debugfile]",this.fieldset).textbox({width:"50%"});this.browseDebugFileButton=$("a[role=button][name=browsedebugfile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseDebugFileButton,this)});},getType:function(){return this.type.combobox("getValue");},setType:function(value){this.type.combobox("select",value);},getReason:function(){return!this.reason.combobox("options").disabled?this.reason.combobox("getValue"):null;},getDescription:function(){return!this.description.textbox("options").disabled?this.description.textbox("getValue"):null;},getPartner:function(){return this.usePartner.is(":checked")?this.partner.combobox("getValue"):null;},setPartners:function(values){this.partner.combobox("loadData",values);},isPlaceToOutbox:function(){return this.placeToOutbox.is(":checked");},getDebugFile:function(){return this.debugFile.textbox("getValue");},show:function(listener){this._super(listener||jscape.domain.OftpSendReceiptDialog.LISTENER);this.usePartner.change();this._onChange$Type();},_onChange$Type:function(){var enabled="NEGATIVE"===this.getType();this.reason.combobox(enabled?"enable":"disable");this.description.textbox(enabled?"enable":"disable");},_onClick$BrowseDebugFileButton:function(){this.browseDebugFileButton.linkbutton("disable");this.listener.onSelectDebugFile().done($.proxy(function(path){this.debugFile.textbox("setValue",path).textbox("textbox").select().focus();},this)).always($.proxy(function(){this.browseDebugFileButton.linkbutton("enable");},this));}});jscape.domain.OftpSendReceiptDialog.LISTENER={onSelectDebugFile:$.noop};jscape.domain.OftpSendCertificateController=Class.extend({PROTOCOLS:["OFTP"],DEFAULT_TYPE:"REQUEST",deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject()}else{jscape.API.getTradingPartnerNames(this.domainName,this.PROTOCOLS).then(function(names){if(names&&names.length){return names.sort(function(a,b){return a.toUpperCase()>b.toUpperCase();});}
throw window.R.string.OFTP_MESSAGES_ERROR_NO_PARTNERS;}).then($.proxy(function(names){this._setupDialog(names).show(this);},this)).catch($.proxy(function(){this._showNoPartnersError();this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.sendOftpPartnerCertificate(this.domainName,dialog.getPartner(),this._createData(dialog)).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},onSelectDebugFile:function(){return new SelectPathController($.proxy(jscape.API.listDebugDir,jscape.API),$.proxy(jscape.API.createDebugPath,jscape.API)).selectFile().then(function(entry){return entry.path;});},onLoadCertificates:function(){return jscape.API.getServerKeys(this.domainName).then(function(items){return $.map(items,function(item){return item.name;});});},_createData:function(dialog){return{certificate:dialog.getCertificate()||null,type:dialog.getType()||"",destinationPartner:dialog.getDestinationPartner()||null,replacementCertificate:dialog.getReplacementCertificate()||null,placeToOutbox:!!dialog.isPlaceToOutbox(),debugFile:dialog.getDebugFile()||""};},_setupDialog:function(partners){var dialog=new jscape.domain.OftpSendCertificateDialog();dialog.setPartners(partners);dialog.setDestinationPartners(partners);dialog.setType(this.DEFAULT_TYPE);return dialog;},_showNoPartnersError:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.OFTP_MESSAGES_ERROR_NO_PARTNERS,"warning");}});jscape.domain.OftpSendCertificateDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#d-oftp-sendcert"),{width:"55%"});this.fieldset=$("fieldset[name=oftpsendcertificatefields]",this.dialog);this.partner=$("select[name=partner]",this.fieldset).combobox({required:true,editable:false,width:"50%",panelHeight:"auto"});this.destinationPartner=$("select[name=destinationpartner]",this.fieldset).combobox({required:true,editable:false,width:"50%",panelHeight:"auto"});this.certificate=$("select[name=certificate]",this.fieldset).combobox({required:true,editable:false,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Certificates,this),width:"50%",panelHeight:"auto"});this.replacement=$("select[name=replacement]",this.fieldset).combobox({required:true,editable:false,disabled:true,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Certificates,this),width:"50%",panelHeight:"auto"});$("input[name=replacecrt]:checkbox",this.fieldset).change({target:this.replacement},function(e){var enabled=$(this).is(":checked");e.data.target.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");});this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,width:"50%",panelHeight:"auto"});this.placeToOutbox=$("input[name=placetooutbox]:checkbox",this.fieldset);this.debugFile=$("input[name=debugfile]",this.fieldset).textbox({width:"50%"});this.browseDebugFileButton=$("a[role=button][name=browsedebugfile]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$BrowseDebugFileButton,this)});initializing=false;},getPartner:function(){return this.partner.combobox("getValue");},setPartners:function(values){this.partner.combobox("loadData",values);},getDestinationPartner:function(){return this.destinationPartner.combobox("getValue");},setDestinationPartners:function(values){this.destinationPartner.combobox("loadData",values);},getCertificate:function(){return this.certificate.combobox("getValue");},getType:function(){return this.type.combobox("getValue");},setType:function(value){this.type.combobox("select",value);},getReplacementCertificate:function(){return!this.replacement.combobox("options").disabled?this.replacement.combobox("getValue"):null;},isPlaceToOutbox:function(){return this.placeToOutbox.is(":checked");},getDebugFile:function(){return this.debugFile.textbox("getValue");},show:function(listener){this._super(listener||jscape.domain.OftpSendCertificateDialog.LISTENER);this.certificate.combobox("reload");this.replacement.combobox("reload");},_onClick$BrowseDebugFileButton:function(){this.browseDebugFileButton.linkbutton("disable");this.listener.onSelectDebugFile().done($.proxy(function(path){this.debugFile.textbox("setValue",path).textbox("textbox").select().focus();},this)).always($.proxy(function(){this.browseDebugFileButton.linkbutton("enable");},this));},_onLoad$Certificates:function(params,success,error){this.listener.onLoadCertificates(params).done(success).fail(error);}});jscape.domain.OftpSendCertificateDialog.LISTENER={onSelectDebugFile:$.noop,onLoadCertificates:$.noop};jscape.domain.OftpResendMessageController=Class.extend({initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,message){var deferred=$.Deferred();if(!this.allowed){deferred.reject();}else{this._confirmResend(message).then(function(){return jscape.API.resendOftpMessage(domainName,message.id);}).done(function(){deferred.resolve();deferred=null;}).fail(function(){deferred.reject();deferred=null;});}
return deferred.promise();},_confirmResend:function(message){return jscape.ConfirmDialog.confirm(window.R.string.OFTP_MESSAGES_CONFIRM_RESEND_TITLE,window.R.string.OFTP_MESSAGES_CONFIRM_RESEND_MESSAGE.supplant({0:message.id}),undefined,{width:"50%",minWidth:500});}});jscape.domain.OftpViewMessageController=Class.extend({deferred:null,start:function(domainName,message){this.domainName=domainName;this.messageId=message.id;this.deferred=$.Deferred();this._setupDialog(message).show(this);return this.deferred.promise();},onLoadData:function(){return jscape.API.getOftpMessageRecordView(this.domainName,this.messageId);},onCancel:function(dialog){dialog.destroy();this.deferred.resolve();this.deferred=null;},_setupDialog:function(message){var dialog=new jscape.domain.OftpMessageViewDialog();dialog.setTitle(jscape.OftpMessage.Type.REQUEST==message.type?window.R.string.OFTP_MESSAGES_VIEW_DIALOG_TITLE_REQUEST:window.R.string.OFTP_MESSAGES_VIEW_DIALOG_TITLE_RECEIPT);return dialog;}});jscape.domain.OftpMessageViewDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#oftp-viewrecord"),{width:"77%",height:"80%",buttons:[{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}]});this.data=$("table[role=grid][aria-label=oftpmessagerecord]",this.dialog).propertygrid({fit:true,height:"auto",loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;}});initializing=false;},show:function(listener){this._super(listener||jscape.domain.OftpMessageViewDialog.LISTENER);this.data.propertygrid("reload");},_formatDate:function(value){return typeof value==="number"?new Date(value).toLocaleString():value;},_onLoad$Data:function(params,success,error){this.listener.onLoadData().then($.proxy(function(data){return $.map(data,$.proxy(function(value,key){return{name:key,value:/date/i.test(key)?this._formatDate(value):value};},this));},this)).then(success,error);}});jscape.domain.OftpMessageViewDialog.LISTENER={onLoadData:$.noop};jscape.domain.OftpDeleteMessageController=Class.extend({deferred:null,initialize:function(allowed){this.allowed=!!allowed;},start:function(domainName,messages){this.domainName=domainName;this.deferred=$.Deferred();if(!this.allowed){this.deferred.reject();}else{this._confirmDelete(messages).done($.proxy(this._deleteConfirmed,this,messages)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}
return this.deferred.promise();},_confirmDelete:function(messages){return jscape.ConfirmDialog.confirm(window.R.string.OFTP_MESSAGES_CONFIRM_DELETE_TITLE,window.R.string.OFTP_MESSAGES_CONFIRM_DELETE_MESSAGE);},_deleteConfirmed:function(messages){$.when.apply(jQuery,$.map(messages,$.proxy(function(message){return jscape.API.deleteOftpMessage(this.domainName,message.id);},this))).done($.proxy(function(){this.deferred.resolve(messages);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});