/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.themes=jscape.themes||{};jscape.themes.WebThemeConfigurationController=Class.extend({initialize:function(themeLoader,container,customRequired){this.loader=themeLoader;this.container=container;this.customRequired=!!customRequired;},start:function(theme,customData){this.deferred=$.Deferred();this._setupView(theme,customData).show(this);return this.deferred.promise();},onChangeTheme:function(view){var theme=view.getTheme();return this.loader.start(theme).catch(function(){return theme;});},onChangeCustom:function(view){var theme=view.getCustomColors();return this.loader.start(theme.name||view.getTheme()).done($.proxy(this._updateCustomProperties,this,theme)).fail($.proxy(function(){this.loader.reset();},this));},onComplete:function(view,theme,customColors){view.destroy();this.loader.reset();this.deferred.resolve(theme,customColors);this.deferred=null;},_updateCustomProperties:function(data){},_setupView:function(theme,customData){var view=new jscape.themes.WebThemeConfigurationView(this.container,this.customRequired);if(!!customData){view.setCustomColors(customData);}else{view.setTheme(theme);}
return view;}});jscape.themes.WebThemeConfigurationView=Class.extend({colors:null,initialize:function(container,customColorsRequired){this.colors={};var content=$(container).find(".themes-list").clone();this.dialog=$("<div></div>").appendTo("body");this.dialog.append(content);content.show();this.dialog.drawer({collapsed:true,modal:true,onExpand:$.proxy(this._onExpand$Themes,this),onCollapse:$.proxy(this._onCollapse$Themes,this),width:"40%"});this.themeButtons=this.dialog.find("input[name=themepreview]:radio").change($.proxy(this._onChange$Theme,this));if(!!customColorsRequired){var re=/^theme-(.+)-colors$/;this.dialog.find("input[type=hidden]").filter("[name^=theme-],[name$=-colors]").each($.proxy(function(_,i){var name=i.name.replace(re,"$1");this.colors[name]=String(i.value||"").split(",");},this)).remove();this.customColorBoxes=this.dialog.find(".theme-color-picker").map(function(_,t){var input=$(t).children(":input");var label=input.attr("aria-label");input.colorbox({label:label||undefined,labelPosition:"top",onChange:$.proxy(this._onChange$CustomTheme,this)}).colorbox("label").attr("title",label);return input;});}else{this.dialog.find("fieldset[name=custom-theme-fields]").hide();}
this.applyCustomButton=$("a[role=button][name=applycustom]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyCustomButton,this)});},show:function(listener){this.listener=listener||jscape.themes.WebThemeConfigurationView.LISTENER;this.applyCustom=false;this.dialog.drawer("expand");this._adjustState();},hide:function(){if(!this.dialog.drawer("options").collapsed){this.dialog.drawer("collapse");}},destroy:function(){this.dialog.drawer("destroy");},getTheme:function(){return this.themeButtons.filter(":checked").val();},setTheme:function(value){this.themeButtons.filter("[value='"+value+"']").prop("checked",true).change();},getCustomColors:function(){if(this.customColorBoxes){var colors={name:this.getTheme()};for(var i=0,len=this.customColorBoxes.length;i<len;++i){var cb=this.customColorBoxes[i];var name=cb.parent().find("input.textbox-value").attr("name");colors[name]=cb.colorbox("getValue")||undefined;}
return colors;}
return null;},setCustomColors:function(value){if(!!value&&typeof value==="object"&&this.customColorBoxes){var colors=$.map(this.customColorBoxes,function(t){var name=$(t).parent().find("input.textbox-value").attr("name");return name&&value.hasOwnProperty(name)?value[name]||"":"";});var theme=value.name;!!theme&&this.themeButtons.each(function(){if(this.value===theme){$(this).prop("checked",true);return false;}});this.colors[theme]=colors;this._adjustCustomColors(theme);this.customTheme=theme;}},_onChange$Theme:function(){var theme=this.themeButtons.filter(":checked").val();if(theme){this.changingTheme=true;this._adjustCustomColors(theme);this.changingTheme=false;this.listener&&this.listener.onChangeTheme(this);}
this._adjustState();},_onChange$CustomTheme:function(){if(!this.changingTheme){this.listener.onChangeCustom(this);}},_onExpand$Themes:function(){this.dialog.data("window").mask.css("opacity",0);this.themeButtons.filter(":checked").change();},_onCollapse$Themes:function(){if(this.applyCustom==true){this.applyCustom=false;this.listener.onComplete(this,null,this.getCustomColors());}else{var theme=this.getTheme();var colors=this.customTheme===theme?this.getCustomColors():null;this.listener.onComplete(this,theme,colors);}},_onClick$ApplyCustomButton:function(){if(!this.getTheme()||!this.customColorBoxes){return;}
this.applyCustom=true;this.applyCustomButton.linkbutton("disable");this.dialog.drawer("collapse");},_adjustState:function(){var enabled=!!this.themeButtons.filter(":checked").val();this.applyCustomButton.linkbutton(enabled?"enable":"disable");if(this.customColorBoxes){this.customColorBoxes.each(function(){$(this).colorbox(enabled?"enable":"disable");})}},_adjustCustomColors:function(theme){var colors=this._themeColorsFor(theme);if(!!colors&&this.customColorBoxes&&this.customColorBoxes.length){for(var i=0;i<colors.length;++i){var cb=this.customColorBoxes.get(i);cb&&cb.colorbox("setValue",colors[i]);}}},_themeColorsFor:function(themeName){return this.colors.hasOwnProperty(themeName)?this.colors[themeName]:null;}});jscape.themes.WebThemeConfigurationView.LISTENER={onChangeTheme:$.noop,onChangeCustom:$.noop,onComplete:$.noop};jscape.themes.WebThemeLoader=Class.extend({id:null,initialize:function(pattern,current){this.pattern=decodeURI(pattern||"");this.initialValue=current;var path=decodeURI(this._themeUriFor(current));var link=$(document).find("head").children("link[rel=stylesheet]").filter(function(_,el){return decodeURI(el.href).endsWith(path);});link.attr("id","_"+this._getId());this.id=link.attr("id");},start:function(themeName){return this._updateTheme(this._themeUriFor(themeName));},reset:function(){!!this.initialValue&&this._updateTheme(this._themeUriFor(this.initialValue));},_getId:function(){var id=jscape.themes.WebThemeLoader.__id;return id?id:(jscape.themes.WebThemeLoader.__id=(1E9*Math.random()>>>0));},_updateTheme:function(uri){var deferred=$.Deferred();var tag=$("#"+this.id);if(tag&&tag.length==1&&uri){try{var t=tag[0];if(t.href!==uri){t.href=uri;}
return deferred.resolve(uri);}catch(ignored){}}
return deferred.reject();},_themeUriFor:function(name){return name?encodeURI(this.pattern.supplant({name:name})):"";}});