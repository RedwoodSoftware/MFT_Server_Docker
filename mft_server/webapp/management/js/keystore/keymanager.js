/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
var jscape=jscape||{};jscape.keystore=jscape.keystore||{};jscape.keystore.KeystoreApplication=jscape.Application.extend({onReady:function(){this._super();this._initValidators();this.view.show(this);},_createView:function(){this._super();this.view=new jscape.keystore.KeystoreView();},_initValidators:function(){var v=new jscape.Validator();v.rule("keystore_confirmpwd",$.proxy(this._passwordConfirmed,this),window.R.string.KEY_MANAGER_EXPORT_KEYS_ERROR_CONFIRM_PASSWORD);},_passwordConfirmed:function(value,params){return value==$(params[0]).val();}});jscape.keystore.KeystoreModule=jscape.ApplicationModule.extend({onCreate:function(){this._super.apply(this,arguments);},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.keystore.KeystoreView=jscape.DashboardView.extend({initialize:function(){this._super($("#key-manager[role=tablist]"));this.modules.tabs({fit:true,border:true,tabPosition:"top",onSelect:$.proxy(this._onSelect$Module,this)});this.modules.find("div[role=tablist]").filter(function(){return $(this).parents("div.dialog").length==0;}).each($.proxy(function(_,tablist){$(tablist).tabs({border:false,onSelect:$.proxy(this._onSelect$Module,this)});},this));this.modules.find(">div.tabs-header>div.tabs-wrap").hover(function(){$(this).css({overflowY:"auto",overflowX:"hidden"});},function(){$(this).css({overflowY:"",overflowX:""});});},show:function(){this._super.apply(this,arguments);this.modules.tabs("unselect",0).tabs("select",0);},valid:function(){return new jscape.Validator().validateTabs(this.modules);}});jscape.keystore.ImportPublicKeyDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkey-import"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=importpubkeyfields]",this.dialog);this.alias=$("input[name=alias]",this.fieldset).textbox({required:true});},getAlias:function(){return this.alias.textbox("getValue");},show:function(listener){this._super(listener);this.alias.textbox("textbox").focus();}});jscape.keystore.ImportPublicKeysBatchDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkey-importjson"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=importpubkeyfields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,multiple:false,missingMessage:window.R.string.KEY_MANAGER_ERROR_BAD_JSON_FILE,width:"60%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},isOverwrite:function(){return this.overwrite.is(":checked");},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});jscape.keystore.ImportPublicKeyTslDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkey-import-tsl"),{width:530,resizable:false});this.fieldset=$("fieldset[name=importpubkeyfields]",this.dialog);this.url=$("input[name=url]",this.fieldset).textbox({required:true,validType:"non_empty",invalidMessage:window.R.string.KEY_MANAGER_ERROR_BAD_URL,width:"60%"});},getUrl:function(){return this.url.textbox("getValue");}});jscape.keystore.ExportDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog){this._super(dialog,{width:530});this.fieldset=$("fieldset[name=exportkeyfields]",this.dialog);this.filename=$("input[name=filename]",this.fieldset).textbox({required:true,missingMessage:window.R.string.KEY_MANAGER_EXPORT_KEYS_ERROR_BAD_FILENAME,width:"55%"});this.format=$("select[name=format]",this.fieldset).combobox({required:true,editable:false,width:"35%",panelHeight:"auto"});},getFilename:function(){return this.filename.textbox("getValue");},setFilename:function(value){this.filename.textbox("setValue",value);},getFormat:function(){return this.format.combobox("getValue");},show:function(listener){this._super(listener);this.filename.textbox("textbox").focus();}});jscape.keystore.ExportPublicKeyDialog=jscape.keystore.ExportDialog.extend({initialize:function(){this._super($("#d-publickey-export"));}});jscape.keystore.ExportPrivateKeyDialog=jscape.keystore.ExportDialog.extend({initialize:function(){this._super($("#d-privatekey-export"));var passwordId="pwd_"+Math.random().toString(36).substr(2);this.password=$("input[name=password]",this.fieldset).attr("id",passwordId).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.password.passwordbox("textbox").on("input",$.proxy(function(){var enabled=this.password.passwordbox("textbox").val().length!=0;this.confirmPassword.passwordbox(enabled?"enableValidation":"disableValidation").passwordbox("validate");},this));this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox({required:true,lastDelay:0,validateOnBlur:true,validType:"keystore_confirmpwd['#"+passwordId+"']",missingMessage:window.R.string.KEY_MANAGER_EXPORT_KEYS_ERROR_CONFIRM_PASSWORD,width:"50%"});},getPassword:function(){return this.password.passwordbox("getValue");},show:function(){this._super.apply(this,arguments);this.password.passwordbox("textbox").triggerHandler("input");}});jscape.keystore.ExportCertificateDialog=jscape.keystore.ExportDialog.extend({initialize:function(){this._super($("#d-certificate-export"));}});jscape.keystore.KeysReportModule=jscape.keystore.KeystoreModule.extend({initialize:function(){this.view=new jscape.keystore.KeyExpirationView();},onStart:function(){this._super();this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(){return $.when(jscape.API.getServerKeys(),jscape.API.getClientPublicKeys(),jscape.API.getClientCertificates(),jscape.API.getPgpPublicKeys(),jscape.API.getPgpSecretKeys());}});jscape.keystore.KeyExpirationView=Class.extend({DATE_FORMAT:new jscape.DateFormat("{MM}-{dd}-{yy}"),initialize:function(){var initializing=true;this.fieldset=$("#keys-expiry-report-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=keyexpiryreport]",this.fieldset);this.data.propertygrid({fit:true,minHeight:300,showGroup:true,columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"25%",fixed:true},{field:"value",title:$("thead th:nth-child(2)",this.data).text(),width:"70%",align:"right",formatter:$.proxy(this._formatExpirationDate,this),styler:$.proxy(this._styleExpirationDate,this)}]],loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onLoadFilter$Data,this),onBeforeLoad:function(){return!initializing;}});initializing=false;},show:function(listener){this.listener=listener||jscape.keystore.KeyExpirationView.LISTENER;},refresh:function(){this.data.propertygrid("reload");},_formatExpirationDate:function(value){return $.isNumeric(value)?this.DATE_FORMAT.format(new Date(value)):value==null?window.R.string.KEY_MANAGER_REPORT_DATE_NON_EXPIRING:"";},_styleExpirationDate:function(value){return $.isNumeric(value)?value<new Date().getTime()?"color:red":"color:green":null;},_keyGroupFor:function(key){switch(key.type){case"server":return window.R.string.KEY_MANAGER_REPORT_GROUP_SERVER_KEYS;case"client":return window.R.string.KEY_MANAGER_REPORT_GROUP_CLIENT_KEYS;case"pgp":return window.R.string.KEY_MANAGER_REPORT_GROUP_PGP_KEYS;default:return null;}},_onLoad$Data:function(_,success,error){this.listener.onRefresh().then(function(serverKeys,clientPublicKeys,clientCertificates,pgpPublicKeys,pgpSecretKeys){return[].concat($.map(serverKeys,function(key){return $.extend(key,{type:"server"});}),$.map(clientPublicKeys,function(key){return $.extend(key,{type:"client"});}),$.map(clientCertificates,function(key){return $.extend(key,{type:"client"});}),$.map(pgpPublicKeys,function(key){return $.extend(key,{type:"pgp"});}),$.map(pgpSecretKeys,function(key){return $.extend(key,{type:"pgp"});}));}).done(success).fail(error);},_onLoadFilter$Data:function(data){if($.isArray(data)){data={total:data.length,rows:data};}
if(data.rows&&data.rows.length){data.rows=$.map(data.rows,$.proxy(function(key){var expires=key.hasOwnProperty("certificateEndDate")?parseInt(key.certificateEndDate):key.hasOwnProperty("expirationDate")?parseInt(key.expirationDate):NaN;return{name:key.name,value:!isNaN(expires)?expires:null,group:this._keyGroupFor(key),editor:null};},this));}
return data;}});jscape.keystore.KeyExpirationView.LISTENER={onRefresh:$.noop};jscape.keystore.ViewKeySummaryController=Class.extend({deferred:null,start:function(alias){this.deferred=$.Deferred();this.alias=alias;this._setupDialog(alias).show(this);return this.deferred.promise();},onCancel:function(dialog){dialog.destroy();this.deferred.resolve();this.deferred=null;},onLoadData:function(){return $.Deferred().resolve().promise();},_setupDialog:function(alias){var dialog=new jscape.keystore.ViewKeySummaryDialog();dialog.setTitle(alias);return dialog;}});jscape.keystore.ViewKeySummaryDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#d-keysummary-view"),{width:"70%",height:"75%",buttons:[{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}],onResize:$.proxy(function(){this.data&&this.data.propertygrid("resize");},this)});this.fieldset=this.dialog.find(".content").layout({fit:true,border:false,doSize:false}).first();this.data=$("table[role=grid][aria-label=summary]",this.fieldset).propertygrid({fit:true,nowrap:false,sortName:"name",columns:[[{field:"name",width:"25%",sortable:true,styler:function(){return"font-weight: bold; border-color: transparent";}},{field:"value",width:"73%",styler:function(){return"border-color: transparent; overflow-wrap: break-word; word-break: break-word";}}]],onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onFilter$Data,this)});this.title=this.dialog.dialog("header").text()||"";initializing=false;},setTitle:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value||""}));},show:function(listener){this._super(listener);this.data.datagrid("reload");this.fieldset.layout("resize");},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onFilter$Data:function(data){return $.map(data||{},function(val,key){return{name:key,value:val};});}});