/* Copyright © 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.keystore=jscape.keystore||{};jscape.GenerateServerKeyData=Class.extend({initialize:function(type,length,keyCurve,periodMillis,commonName,subjectAlternativeName,organizationUnit,organization,locality,state,country,keyUsage,keyUsageExtended,crlUrl,signingKey){this.keyType=type||"RSA";this.keyLength=parseInt(length)||2048;this.keyCurve=keyCurve||"";this.periodMillis=parseInt(periodMillis)||365*24*60*60*1000;this.commonName=commonName||"";this.subjectAlternativeName=subjectAlternativeName||"";this.organizationUnit=organizationUnit||"";this.organization=organization||"";this.locality=locality||"";this.state=state||"";this.country=country||"";this.keyUsage=keyUsage||[];this.keyUsageExtended=keyUsageExtended||[];this.crlUrl=crlUrl||"";this.signingKey=signingKey;}});jscape.keystore.ServerKeysModule=jscape.keystore.KeystoreModule.extend({onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.keystore.ServerKeysController();},onStart:function(){this._super.apply(this,arguments);this.controller.start();},onResume:function(){this._super.apply(this,arguments);this.controller.resume();}});jscape.keystore.ServerKeysController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this.importKeyController=new jscape.keystore.ImportServerKeyController();this.importJsonController=new jscape.keystore.ImportServerKeysBatchController();this.importCertificateController=new jscape.keystore.ImportServerCertificateController();this.exportPublicKeyController=new jscape.keystore.ExportServerPublicKeyController();this.exportPrivateKeyController=new jscape.keystore.ExportServerPrivateKeyController();this.exportCertificateController=new jscape.keystore.ExportServerCertificateController();this.generateKeyController=new jscape.keystore.GenerateServerKeyController();this.generateCrlController=new jscape.keystore.GenerateServerKeyCrlСontroller();this.verifyCrlController=new jscape.keystore.VerifyServerKeyRevocationСontroller();this.viewController=new jscape.keystore.ViewServerKeyController();this.generateCsrController=new jscape.keystore.GenerateServerKeyCsrController();this.generateCertificateController=new jscape.keystore.GenerateServerKeyCertificateController();this.revokeController=new jscape.keystore.RevokeServerKeyController();this.deleteController=new jscape.keystore.DeleteServerKeyController();this._initValidators();},start:function(){if(this.view==null){this.view=new jscape.keystore.ServerKeysView();}
this.view.show(this);},resume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listServerKeys(params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onLoadSuggestions:function(params){var field=params.field||null;var data=$.map(this.view.getRecords(),function(record){return field&&record.hasOwnProperty(field)?record[field]:null;});return $.Deferred().resolve(data).promise();},onImport:function(){return this.importKeyController.start().done($.proxy(this._keyImported,this));},onImportJson:function(){return this.importJsonController.start().done($.proxy(function(){this.view.refresh();},this));},onImportCertificates:function(key){return this.importCertificateController.start(key.name);},onExportPrivateKey:function(key){return this.exportPrivateKeyController.start(key.name);},onExportPublicKey:function(key){return this.exportPublicKeyController.start(key.name);},onExportCertificate:function(certificate){return this.exportCertificateController.start(certificate.name);},onGenerateCertificateRevocationList:function(){return this.generateCrlController.start();},onVerifyRevocation:function(){return this.verifyCrlController.start().done($.proxy(function(){this.view.refresh();},this));},onView:function(key){return this.viewController.start(key.name);},onGenerate:function(){return this.generateKeyController.start().done($.proxy(this._keyGenerated,this));},onGenerateCertificateSigningRequest:function(key){return this.generateCsrController.start(key.name);},onGenerateCertificate:function(key){return this.generateCertificateController.start(key).done($.proxy(this._certificateGenerated,this));},onRevokeCertificate:function(certificate){return this.revokeController.start(certificate).done($.proxy(this._certificateRevoked,this));},onDelete:function(key){return this.deleteController.start(key.name).done($.proxy(this._keyDeleted,this,key));},_keyImported:function(key){this._recordAdded(key);},_keyGenerated:function(key){this._recordAdded(key);},_certificateGenerated:function(){this.view.refresh();},_certificateRevoked:function(){this.view.refresh();},_keyDeleted:function(key){this._recordDeleted(key);},_initValidators:function(){var v=new jscape.Validator();v.rule("serverkeys_notexists",$.proxy(this._keyAliasNotExists,this),window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_ALIAS_EXISTS);v.rule("serverkeys_alternativename",$.proxy(this._alternativeNameValid,this),window.R.string.KEY_MANAGER_SERVER_KEYS_BAD_ALTERNATIVE_NAME);},_keyAliasNotExists:function(value,excludes){var aliases=$.map(this.view.getKeys(),function(key){return excludes&&$.inArray(key.name,excludes)!=-1?null:key.name;});return $.inArray(value,aliases)==-1;},_alternativeNameValid:function(value){var ret=jscape.API.validateAlternativeName(value);return ret&&ret.success===true;}});jscape.keystore.ServerKeysView=jscape.ui.DatagridView.extend({DATE_FORMAT:new jscape.DateFormat("{MM}-{dd}-{yy}"),selection:null,initialize:function(){var initializing=true;this.fieldset=$("#server-keys-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=serverkeys]",this.fieldset);this.data.datagrid({fit:true,minHeight:300,singleSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,idField:"name",sortName:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"12%"},{field:"keyAlgorithm",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"7%",finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.KeyPairAlgorithm.values(),$.proxy(function(entry){return entry.name;},this))}}},{field:"keySize",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,formatter:$.proxy(this._formatKeySize,this),finder:{type:"numberspinner",options:{editable:true,min:0}},width:"7%"},{field:"certificateSerialNumber",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"9%"},{field:"certificateIssuer",title:$("thead th:nth-child(5)",this.data).text(),sortable:false,width:"9%"},{field:"certificateSubject",title:$("thead th:nth-child(6)",this.data).text(),sortable:false,width:"9%"},{field:"certificateSubjectAlternativeName",title:$("thead th:nth-child(7)",this.data).text(),sortable:false,searchable:false,width:"9%"},{field:"certificateBeginDate",title:$("thead th:nth-child(8)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatDate,this),styler:$.proxy(this._styleDate,this,true),finder:"datebox"},{field:"certificateEndDate",title:$("thead th:nth-child(9)",this.data).text(),sortable:true,width:"9%",formatter:$.proxy(this._formatDate,this),styler:$.proxy(this._styleDate,this,false),finder:"datebox"},{field:"revoked",title:$("thead th:nth-child(10)",this.data).text(),sortable:true,width:"7%",align:"center",formatter:$.proxy(this._formatRevoked,this),finder:{type:"combobox",options:{data:[{text:"yes",value:true},{text:"no",value:false}],panelHeight:"auto"}}},{field:"domains",title:$("thead th:nth-child(11)",this.data).text(),sortable:false,width:"",formatter:function(values){return values?values.join(", ").escapeXml():null;},finder:this._createFinder("combobox",{editable:true,limitToList:false,loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"domains"}})}]],onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onClick$ViewButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustButtonsState,this)});this.generateButton=$("a[role=button][name=generate]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$GenerateButton,this)});this.generateMenu=$("div[role=menu][aria-label=generate-menu]",this.fieldset).menu({onClick:$.proxy(this._onMenu$Generate,this)});this.importButton=$("a[role=button][name=import]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ImportButton,this)});this.importMenu=$("div[role=menu][aria-label=import-menu]",this.fieldset).menu({onClick:$.proxy(this._onMenu$Import,this)});this.exportButton=$("a[role=button][name=export]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExportButton,this)});this.exportMenu=$("div[role=menu][aria-label=export-menu]",this.fieldset).menu({onClick:$.proxy(this._onMenu$Export,this)});this.crlButton=$("a[role=button][name=crl]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$CrlButton,this)});this.crlMenu=$("div[role=menu][aria-label=crl-menu]",this.fieldset).menu({onClick:$.proxy(this._onMenu$Crl,this)});this.viewButton=$("a[role=button][name=view]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.revokeButton=$("a[role=button][name=revoke]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RevokeButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.fieldset.layout("panel","south").panel("resize",{height:"auto"});this.fieldset.layout("resize");initializing=false;},show:function(listener){this.listener=listener||jscape.keystore.ServerKeysView.LISTENER;this._adjustButtonsState();},getKeys:function(){return this.getRecords();},_formatKeySize:function(value){return!!value?value:"";},_formatDate:function(value){return $.isNumeric(value)?this.DATE_FORMAT.format(new Date(value)):null;},_formatRevoked:function(value){return"<input type=\"checkbox\" onclick=\"return false\""+(value?" checked=\"checked\" />":"/>");},_styleDate:function(before,value){if($.isNumeric(value)){var now=new Date().getTime();return before&&value>now||!before&&value<now?"color:red":"color:green";}
return null;},_onLoad$Data:function(params,success,error){this.data.datagrid("unselectAll");this.listener.onLoadData(params).then(success,error);},_onLoad$Suggestions:function(params,success,error){this.listener.onLoadSuggestions(params).then(success,error);},_onClick$GenerateButton:function(){this.generateMenu.menu("show",{alignTo:this.generateButton});this.generateButton.blur();},_onMenu$Generate:function(item){if("menu-key"==item.id){this.listener.onGenerate();}else if("menu-crt"==item.id){this.listener.onGenerateCertificate(this.selection);}else if("menu-csr"==item.id){this.listener.onGenerateCertificateSigningRequest(this.selection);}},_onClick$ImportButton:function(){var opts={alignTo:this.importButton};this.importMenu.menu("show",opts);this.importButton.blur();},_onMenu$Import:function(item){if("menu-key"==item.id){this.listener.onImport();}else if("menu-crt"==item.id){this.listener.onImportCertificates(this.selection);}else if("menu-json"==item.id){this.listener.onImportJson();}},_onClick$ExportButton:function(){this.exportMenu.menu("show",{alignTo:this.exportButton});this.exportButton.blur();},_onMenu$Export:function(item){if("menu-crt"==item.id){this.listener.onExportCertificate(this.selection);}else if("menu-pubkey"==item.id){this.listener.onExportPublicKey(this.selection);}else if("menu-prvkey"==item.id){this.listener.onExportPrivateKey(this.selection);}},_onClick$ViewButton:function(){this.listener.onView(this.selection);},_onClick$RevokeButton:function(){this.listener.onRevokeCertificate(this.selection);},_onClick$DeleteButton:function(){this.listener.onDelete(this.selection);},_onClick$CrlButton:function(){this.crlMenu.menu("show",{alignTo:this.crlButton});this.crlButton.blur();},_onMenu$Crl:function(item){if("menu-crl-generate"==item.id){this.listener.onGenerateCertificateRevocationList();}else if("menu-crl-verify"==item.id){this.listener.onVerifyRevocation();}},_showContextMenu:function(e){this._super(e,[this.viewButton,this.revokeButton,{button:this.crlButton,submenu:this.crlMenu},this.deleteButton,"-",{button:this.generateButton,submenu:this.generateMenu},{button:this.importButton,submenu:this.importMenu},{button:this.exportButton,submenu:this.exportMenu}]);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelected");var enabled=this.selection!=null;this.exportButton.linkbutton(enabled?"enable":"disable");this.viewButton.linkbutton(enabled?"enable":"disable");this.deleteButton.linkbutton(enabled?"enable":"disable");this.revokeButton.linkbutton(enabled?"enable":"disable");this._adjustMenuItemState(this.generateMenu,"menu-crt",!enabled);this._adjustMenuItemState(this.generateMenu,"menu-csr",!enabled);this._adjustMenuItemState(this.importMenu,"menu-crt",!enabled);},_adjustMenuItemState:function(menu,id,disabled){var item=menu.menu("findItem",function(mi){return id==mi.id;});if(item&&item.target){menu.menu(!disabled?"enableItem":"disableItem",item.target);}}});jscape.keystore.ServerKeysView.LISTENER={onLoadData:$.noop,onLoadSuggestions:$.noop,onImport:$.noop,onImportJson:$.noop,onImportCertificates:$.noop,onExportCertificate:$.noop,onExportPublicKey:$.noop,onExportPrivateKey:$.noop,onVerifyRevocation:$.noop,onGenerateCertificateRevocationList:$.noop,onGenerate:$.noop,onGenerateCertificateSigningRequest:$.noop,onGenerateCertificate:$.noop,onRevokeCertificate:$.noop,onView:$.noop,onDelete:$.noop};jscape.keystore.ImportServerKeyController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.importServerKey(dialog.getAlias(),dialog.getFile(),dialog.getFilePassword(),dialog.getKeyAlias(),dialog.getKeyPassword(),dialog.getCertificateFile()||undefined,dialog.getCertificateFilePassword(),dialog.getCerfiticateAlias()).done($.proxy(function(key){this.deferred.resolve(key);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.ImportServerKeyDialog();}});jscape.keystore.ImportServerKeyDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-serverkey-import"),{width:"60%"});this.fieldset=$("fieldset[name=importserverkeyfields]",this.dialog);this.alias=$("input[name=alias]",this.fieldset).textbox({required:true,validType:"non_empty",missingMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_ALIAS,invalidMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_ALIAS,width:"60%"});this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",validateOnBlur:true,missingMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILE,invalidMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILE,width:"60%"});this.filePassword=$("input[name=filepwd]",this.fieldset).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.keyAlias=$("input[name=keyalias]",this.fieldset).textbox({width:"50%"});this.keyPassword=$("input[name=keypwd]",this.fieldset).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.certificateFile=$("input[name=crtfile]",this.fieldset).filebox({width:"60%"});this.certificateFilePassword=$("input[name=crtfilepwd]",this.fieldset).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.certificateAlias=$("input[name=crtalias]",this.fieldset).textbox({width:"50%"});},getAlias:function(){return this.alias.textbox("getValue");},setAlias:function(value){this.alias.textbox("setValue",value);if(value){this.alias.textbox("textbox").validatebox("options").validType=["non_empty","serverkeys_notexists['"+value+"']"];}},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},getFilePassword:function(){return this.filePassword.passwordbox("getValue");},getKeyAlias:function(){return this.keyAlias.textbox("getValue");},getKeyPassword:function(){return this.keyPassword.passwordbox("getValue");},getCertificateFile:function(){var files=this.certificateFile.filebox("files");return files&&files.length?files[0]:null;},getCertificateFilePassword:function(){return this.certificateFilePassword.passwordbox("getValue");},getCerfiticateAlias:function(){return this.certificateAlias.textbox("getValue");},show:function(listener){this._super(listener);this.alias.textbox("textbox").focus();}});jscape.keystore.ImportServerCertificateController=Class.extend({deferred:null,start:function(keyAlias){this.keyAlias=keyAlias;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.importServerKeyCertificates(this.keyAlias,dialog.getFile(),dialog.getFilePassword(),dialog.getAlias()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.ImportServerCertificatesDialog();}});jscape.keystore.ImportServerCertificatesDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-serverkey-importcrt"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=importserverkeycrtfields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",missingMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILE,invalidMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILE,width:"65%"});this.filePassword=$("input[name=filepwd]",this.fieldset).passwordbox2({width:"50%"});this.alias=$("input[name=alias]",this.fieldset).textbox({width:"50%"});},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},getFilePassword:function(){return this.filePassword.passwordbox2("getValue");},getAlias:function(){return this.alias.textbox("getValue");},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});jscape.keystore.ImportServerKeysBatchController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.importServerKeysBatch(dialog.getFile(),dialog.isOverwrite()).done($.proxy(function(){this._showSuccessMessage();this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.ImportServerKeysBatchDialog();},_showSuccessMessage:function(){$(document).triggerHandler("broadcast",window.R.string.KEY_MANAGER_SERVER_KEYS_SUCCESS_IMPORT);}});jscape.keystore.ImportServerKeysBatchDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-serverkey-importjson"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=importserverkeyjsonfields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",validateOnBlur:true,missingMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILE,invalidMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILE,width:"60%"});this.overwrite=$("input[name=overwrite]:checkbox",this.fieldset);},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},isOverwrite:function(){return this.overwrite.is(":checked");},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});jscape.keystore.ExportServerPublicKeyController=Class.extend({deferred:null,start:function(keyAlias){this.keyAlias=keyAlias;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportServerPublicKey(this.keyAlias,dialog.getFormat(),dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.keystore.ExportPublicKeyDialog();dialog.setFilename(this.keyAlias+".pub");return dialog;}});jscape.keystore.ExportServerPrivateKeyController=Class.extend({deferred:null,start:function(keyAlias){this.keyAlias=keyAlias;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportServerPrivateKey(this.keyAlias,dialog.getFormat(),dialog.getPassword(),dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.keystore.ExportPrivateKeyDialog();dialog.setFilename(this.keyAlias+".prv");return dialog;}});jscape.keystore.ExportServerCertificateController=Class.extend({deferred:null,start:function(alias){this.alias=alias;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportServerCertificate(this.alias,dialog.getFormat(),dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.keystore.ExportCertificateDialog();dialog.setFilename(this.alias+".crt");return dialog;}});jscape.keystore.GenerateServerKeyController=Class.extend({DEFAULT_DATA:new jscape.GenerateServerKeyData(),deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.generateServerKey(dialog.getAlias(),this._createData(dialog)).done($.proxy(function(key){this.deferred.resolve(key);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return new jscape.GenerateServerKeyData(dialog.getAlgorithm(),dialog.getKeyLength(),dialog.getKeyCurve(),dialog.getPeriod(),dialog.getCommonName(),dialog.getSubjectAlternativeName(),dialog.getOrganizationUnit(),dialog.getOrganization(),dialog.getLocality(),dialog.getState(),dialog.getCountry(),dialog.getKeyUsage(),dialog.getKeyUsageExtended(),dialog.getCrlUrl(),dialog.getSigningKey());},_setupDialog:function(){var dialog=new jscape.keystore.GenerateServerKeyDialog();dialog.setKeyUsage(["DIGITAL_SIGNATURE","KEY_ENCIPHERMENT"]);dialog.setKeyUsageExtended(["SERVER_AUTH","CLIENT_AUTH"]);dialog.setAlgorithm(this.DEFAULT_DATA.keyType);dialog.setKeyLength(this.DEFAULT_DATA.keyLength);dialog.setPeriod(this.DEFAULT_DATA.periodMillis);jscape.API.getServerKeys().done(function(keys){dialog.setSigningKeys($.map(keys,function(key){return key.name;}));});return dialog;}});jscape.keystore.GenerateServerKeyDialog=jscape.ui.DefaultDialog.extend({PERIOD_FACTOR:24*60*60*1000,initialize:function(){this._super($("#d-serverkey-generate"),{width:"65%",height:"80%"});this.fieldset=this.dialog.find(".content").first().layout({fit:true,border:false,doSize:false});this.tabs=$("div[role=tablist]",this.fieldset).tabs({fit:true,tabPosition:"top",plain:true});this.alias=$("input[name=alias]",this.fieldset).textbox({required:true,validType:["non_empty","serverkeys_notexists"],missingMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_ALIAS,invalidMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_ALIAS,width:"60%"});this.keyAlgorithm=$("select[name=algorithm]",this.fieldset).combobox({editable:false,onChange:$.proxy(this._onChange$KeyType,this),width:"25%",panelHeight:"auto",panelMaxHeight:"40%"});this.keyLength=$("select[name=keylength]",this.fieldset).combobox({editable:false,disabled:true,limitToList:true,autoSelectFirst:false,loadFilter:function(data){return $.map(data,function(entry){return $.extend(entry,{value:parseInt(entry.value)});});},width:"25%",panelHeight:"auto",panelMaxHeight:"40%"});this.keyCurve=$("select[name=keycurve]",this.fieldset).combobox({required:true,editable:true,limitToList:true,disabled:true,width:"25%",panelHeight:"auto",panelMaxHeight:"50%"});this.period=$("input[name=period]",this.fieldset).numberspinner({min:1,max:10000,increment:10,width:80});this.commonName=$("input[name=commonname]",this.fieldset).textbox({required:true,validType:"non_empty",missingMessage:window.R.string.KEY_MANAGER_ERROR_BAD_COMMON_NAME,invalidMessage:window.R.string.KEY_MANAGER_ERROR_BAD_COMMON_NAME,width:"50%"});this.subjectAlternative=$("input[name=subjectalternative]",this.fieldset).textbox({validType:["non_empty","serverkeys_alternativename"],delay:1500,validateOnCreate:false,validateOnBlur:true,width:"50%"});this.organizationUnit=$("input[name=organizationunit]",this.fieldset).textbox({width:"50%"});this.organization=$("input[name=organization]",this.fieldset).textbox({width:"50%"});this.locality=$("input[name=locality]",this.fieldset).textbox({width:"50%"});this.state=$("input[name=state]",this.fieldset).textbox({width:"50%"});this.country=$("input[name=country]",this.fieldset).textbox({width:"50%"});this.keyUsage=$("input[name=keyusage]:checkbox",this.fieldset);this.keyUsageExtended=$("input[name=keyusageextended]:checkbox",this.fieldset);this.crlUrl=$("input[name=crl]",this.fieldset).textbox({validType:"url",width:"60%"});this.signWith=$("input[name=signwith]:checkbox").change($.proxy(function(){var enabled=this.signWith.is(":checked:not(:disabled)");this.signingKey.combobox(enabled?"enable":"disable");},this));this.signingKey=$("select[name=serverkeys]",this.fieldset).combobox({required:true,editable:false,disabled:true,autoSelectFirst:true,onLoadSuccess:$.proxy(function(data){if(data.length==0){this.signWith.prop("disabled",true).change();}},this),width:200,panelHeight:"auto",panelMaxHeight:"40%"});},getAlias:function(){return this.alias.textbox("getValue");},getAlgorithm:function(){return this.keyAlgorithm.combobox("getValue");},setAlgorithm:function(value){this.keyAlgorithm.combobox("select",value);},getKeyLength:function(){return this.keyLength.combobox("getValue");},setKeyLength:function(value){this.keyLength.combobox("select",value);},getKeyCurve:function(){return this.keyCurve.combobox("getValue");},getPeriod:function(){return parseInt(this.period.numberspinner("getValue"))*this.PERIOD_FACTOR;},setPeriod:function(value){return this.period.numberspinner("setValue",value/this.PERIOD_FACTOR);},getCommonName:function(){return this.commonName.textbox("getValue");},getSubjectAlternativeName:function(){return this.subjectAlternative.textbox("getValue");},getOrganizationUnit:function(){return this.organizationUnit.textbox("getValue");},getOrganization:function(){return this.organization.textbox("getValue");},getLocality:function(){return this.locality.textbox("getValue");},getState:function(){return this.state.textbox("getValue");},getCountry:function(){return this.country.textbox("getValue");},getKeyUsage:function(){return this.keyUsage.filter(":checked").map(function(){return $(this).val();}).get();},setKeyUsage:function(values){this.keyUsage.filter(function(){return $.inArray($(this).val(),values)!=-1;}).prop("checked",true);},getCrlUrl:function(){return this.crlUrl.textbox("getValue");},getSigningKey:function(){return this.signWith.is(":checked:not(:disabled)")?this.signingKey.combobox("getValue"):null;},setSigningKeys:function(values){this.signingKey.combobox("loadData",values);},getKeyUsageExtended:function(){return this.keyUsageExtended.filter(":checked").map(function(){return $(this).val();}).get();},setKeyUsageExtended:function(values){this.keyUsageExtended.filter(function(){return $.inArray($(this).val(),values)!=-1;}).prop("checked",true);},show:function(listener){this._super(listener);this.dialog.dialog("resize",{height:"80%"}).dialog("center");this._onChange$KeyType();},_valid:function(){return true;},_onSubmit:function(){if(new jscape.Validator().validateTabs(this.tabs,true)){return this._super.apply(this,arguments);}},_onChange$KeyType:function(){var keyCurves=jscape.KeyPairAlgorithm.curvesOf(this.getAlgorithm());var keyLengths=jscape.KeyPairAlgorithm.lengthsOf(this.getAlgorithm());if(keyCurves&&keyCurves.length){this.keyCurve.combobox("enable").combobox("reset").combobox("loadData",keyCurves).closest("div").show();this.keyLength.combobox("disable").closest("div").hide();}else if(keyLengths&&keyLengths.length){var keyLength=this.keyLength.combobox("getValue");this.keyCurve.combobox("disable").closest("div").hide();this.keyLength.combobox("enable").combobox("reset").combobox("loadData",$.map(keyLengths,function(entry){return{text:String(entry),value:entry};})).combobox("select",parseInt(keyLength)).closest("div").show();}else{this.keyCurve.combobox("disable").closest("div").hide();this.keyLength.combobox("disable").closest("div").hide();}}});jscape.keystore.GenerateServerKeyCrlСontroller=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.generateCertificateRevocationList(dialog.getSigningKey(),dialog.getExpires()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.keystore.GenerateServerKeyCrlDialog();jscape.API.getServerKeys().done(function(keys){dialog.setSigningKeys($.map(keys,function(key){return key.name;}));});return dialog;}});jscape.keystore.GenerateServerKeyCrlDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-serverkey-generatecrl"),{width:"50%",minWidth:530,maxWidth:730});this.fieldset=$("fieldset[name=generateserverkeycrlfields]",this.dialog);this.signingKey=$("select[name=signingkey]",this.fieldset).combobox({required:true,editable:false,panelHeight:"auto",width:210});this.expires=$("input[name=expires]",this.fieldset).numberspinner({required:true,min:1,max:1000,value:30,width:80});},getSigningKey:function(){return this.signingKey.combobox("getValue");},setSigningKeys:function(values){this.signingKey.combobox("loadData",values);},getExpires:function(){return parseInt(this.expires.numberspinner("getValue"));}});jscape.keystore.VerifyServerKeyRevocationСontroller=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.verifyCertificateRevocation(dialog.getFile(),"server").done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.VerifyServerKeyRevocationDialog();}});jscape.keystore.VerifyServerKeyRevocationDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-serverkey-verifycrl"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=verifyserverkeycrlfields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,validType:"non_empty",validateOnBlur:true,missingMessage:window.R.string.KEY_MANAGER_ERROR_BAD_FILE,width:"65%"});},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});jscape.keystore.GenerateServerKeyCsrController=Class.extend({deferred:null,start:function(keyAlias){this.keyAlias=keyAlias;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.generateServerKeyCSR(this.keyAlias,dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.GenerateServerKeyCsrDialog();}});jscape.keystore.GenerateServerKeyCsrDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-serverkey-generatecsr"),{width:"50%"});this.fieldset=$("fieldset[name=generateserverkeycsrfields]",this.dialog);this.filename=$("input[name=filename]",this.fieldset).textbox({required:true,validType:"non_empty",missingMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILENAME,invalidMessage:window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_BAD_FILENAME,width:"60%"});},getFilename:function(){return this.filename.textbox("getValue");},show:function(listener){this._super(listener);this.filename.textbox("textbox").focus();}});jscape.keystore.GenerateServerKeyCertificateController=Class.extend({deferred:null,start:function(key){this.keyAlias=key.name;this.deferred=$.Deferred();this._setupDialog(key).show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.generateServerKeyCertificate(this.keyAlias,this._createData(dialog)).done($.proxy(function(key){this.deferred.resolve(key);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_parseSubject:function(data){var values={};var entries=data?data.split(/,\s*/):[];entries.forEach(function(entry){var parts=entry.split("=");if(parts.length==2){values[parts[0].toUpperCase()]=parts[1];}});return $.extend({CN:"",OU:"",O:"",L:"",ST:"",C:""},values);},_createData:function(dialog){return{periodMillis:dialog.getPeriod(),commonName:dialog.getCommonName(),subjectAlternativeName:dialog.getSubjectAlternativeName(),organizationUnit:dialog.getOrganizationUnit(),organization:dialog.getOrganization(),locality:dialog.getLocality(),state:dialog.getState(),country:dialog.getCountry(),keyUsage:dialog.getKeyUsage(),keyUsageExtended:dialog.getKeyUsageExtended(),crlUrl:dialog.getCrlUrl(),signingKey:dialog.getSigningKey()};},_setupDialog:function(key){var subject=this._parseSubject(key.certificateSubject);var dialog=new jscape.keystore.GenerateServerKeyCertificateDialog();dialog.setCommonName(subject.CN);dialog.setOrganizationUnit(subject.OU);dialog.setOrganization(subject.O);dialog.setLocality(subject.L);dialog.setState(subject.ST);dialog.setCountry(subject.C);dialog.setKeyUsage(["DIGITAL_SIGNATURE","KEY_ENCIPHERMENT"]);dialog.setKeyUsageExtended(["SERVER_AUTH","CLIENT_AUTH"]);jscape.API.getServerKeys().done(function(keys){dialog.setSigningKeys($.map(keys,function(key){return key.name;}));});return dialog;}});jscape.keystore.GenerateServerKeyCertificateDialog=jscape.ui.DefaultDialog.extend({PERIOD_FACTOR:24*60*60*1000,initialize:function(){this._super($("#d-serverkey-generatecert"),{width:"65%",height:"80%"});this.tabs=$("div[role=tablist]",this.dialog).tabs({fit:true,tabPosition:"top",plain:true});this.period=$("input[name=period]",this.fieldset).numberspinner({min:1,max:10000,value:365,increment:10,width:80});this.commonName=$("input[name=commonname]",this.fieldset).textbox({required:true,validType:"non_empty",width:"60%"});this.subjectAlternative=$("input[name=subjectalternative]",this.fieldset).textbox({validType:["non_empty","serverkeys_alternativename"],delay:1500,validateOnCreate:false,validateOnBlur:true,width:"60%"});this.organizationUnit=$("input[name=organizationunit]",this.fieldset).textbox({width:"60%"});this.organization=$("input[name=organization]",this.fieldset).textbox({width:"60%"});this.locality=$("input[name=locality]",this.fieldset).textbox({width:"60%"});this.state=$("input[name=state]",this.fieldset).textbox({width:"60%"});this.country=$("input[name=country]",this.fieldset).textbox({width:"60%"});this.keyUsage=$("input[name=keyusage]:checkbox",this.fieldset);this.keyUsageExtended=$("input[name=keyusageextended]:checkbox",this.fieldset);this.crlUrl=$("input[name=crl]",this.fieldset).textbox({validType:"url",width:"75%"});this.signWith=$("input[name=signwith]:checkbox").change($.proxy(function(){var enabled=this.signWith.is(":checked:not(:disabled)");this.signingKey.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");},this));this.signingKey=$("select[name=serverkeys]",this.fieldset).combobox({required:true,editable:false,disabled:true,width:200,panelHeight:"auto",onLoadSuccess:$.proxy(function(data){if(data.length==0){this.signWith.prop("disabled",true).change();}else{this.signingKey.combobox("select",data[0].value);}},this)});},getPeriod:function(){return parseInt(this.period.numberspinner("getValue"))*this.PERIOD_FACTOR;},getCommonName:function(){return this.commonName.textbox("getValue");},setCommonName:function(value){return this.commonName.textbox("setValue",value);},getOrganizationUnit:function(){return this.organizationUnit.textbox("getValue");},setOrganizationUnit:function(value){return this.organizationUnit.textbox("setValue",value);},getOrganization:function(){return this.organization.textbox("getValue");},setOrganization:function(value){return this.organization.textbox("setValue",value);},getLocality:function(){return this.locality.textbox("getValue");},setLocality:function(value){return this.locality.textbox("setValue",value);},getState:function(){return this.state.textbox("getValue");},setState:function(value){return this.state.textbox("setValue",value);},getCountry:function(){return this.country.textbox("getValue");},setCountry:function(value){return this.country.textbox("setValue",value);},getKeyUsage:function(){return this.keyUsage.filter(":checked").map(function(){return $(this).val();}).get();},setKeyUsage:function(values){this.keyUsage.filter(function(){return $.inArray($(this).val(),values)!=-1;}).prop("checked",true);},getCrlUrl:function(){return this.crlUrl.textbox("getValue");},getSigningKey:function(){return this.signWith.is(":checked:not(:disabled)")?this.signingKey.combobox("getValue"):null;},setSigningKeys:function(values){this.signingKey.combobox("loadData",values);},getKeyUsageExtended:function(){return this.keyUsageExtended.filter(":checked").map(function(){return $(this).val();}).get();},setKeyUsageExtended:function(values){this.keyUsageExtended.filter(function(){return $.inArray($(this).val(),values)!=-1;}).prop("checked",true);},getSubjectAlternativeName:function(){return this.subjectAlternative.textbox("getValue");},show:function(listener){this._super(listener);this.dialog.dialog("resize").dialog("center");this.commonName.textbox("textbox").focus();},_valid:function(){return true;},_onSubmit:function(){if(new jscape.Validator().validateTabs(this.tabs,true)){return this._super.apply(this,arguments);}}});jscape.keystore.RevokeServerKeyController=Class.extend({start:function(certificate){if(certificate.revoked){return jscape.API.setServerKeyRevocationStatus(certificate.name,false);}else{return this._confirmRevoke(certificate.name).done(function(){return jscape.API.setServerKeyRevocationStatus(certificate.name,true);})}},_confirmRevoke:function(alias){return jscape.ConfirmDialog.confirm(window.R.string.KEY_MANAGER_REVOKE_CERTIFICATE_TITLE,window.R.string.KEY_MANAGER_REVOKE_CERTIFICATE_MESSAGE.supplant({0:alias}));}});jscape.keystore.DeleteServerKeyController=Class.extend({deferred:null,start:function(keyAlias){this.deferred=$.Deferred();this._checkKeyUsage(keyAlias).done($.proxy(function(used){if(used){this._keyUsedError(keyAlias);this.deferred.reject();this.deferred=null;}else{this._confirmDelete(keyAlias).done($.proxy(this._deleteConfirmed,this,keyAlias)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_checkKeyUsage:function(keyAlias){return jscape.API.keyUsage(keyAlias);},_deleteConfirmed:function(keyAlias){return jscape.API.deleteServerKey(keyAlias).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},_confirmDelete:function(keyAlias){return jscape.ConfirmDialog.confirm(window.R.string.KEY_MANAGER_SERVER_KEYS_DELETE_TITLE,window.R.string.KEY_MANAGER_SERVER_KEYS_DELETE_MESSAGE.supplant({0:keyAlias}));},_keyUsedError:function(keyAlias){$.messager.alert(window.R.string.DIALOG_TITLE_ERROR,window.R.string.KEY_MANAGER_SERVER_KEYS_ERROR_KEY_USED.supplant({0:keyAlias}),"error");}});jscape.keystore.ViewServerKeyController=jscape.keystore.ViewKeySummaryController.extend({onLoadData:function(){return jscape.API.getServerKeyView(this.alias);}});