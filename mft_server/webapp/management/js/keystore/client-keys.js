/* Copyright © 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.keystore=jscape.keystore||{};jscape.GenerateClientKeyData=Class.extend({initialize:function(type,length,keyCurve,periodMillis,commonName,subjectAlternativeName,organizationUnit,organization,locality,state,country,privateKeyFilename,privateKeyFormat,privateKeyPassword){this.keyType=type||"RSA";this.keyLength=parseInt(length)||2048;this.keyCurve=keyCurve||"";this.periodMillis=parseInt(periodMillis)||365*24*60*60*1000;this.commonName=commonName||"";this.subjectAlternativeName=subjectAlternativeName||"";this.organizationUnit=organizationUnit||"";this.organization=organization||"";this.locality=locality||"";this.state=state||"";this.country=country||"";this.privateKeyFilename=privateKeyFilename;this.privateKeyFormat=privateKeyFormat;this.privateKeyPassword=privateKeyPassword;}});jscape.keystore.ClientKeysModule=jscape.keystore.KeystoreModule.extend({onCreate:function(){this._super.apply(this,arguments);this.controller=new jscape.keystore.ClientKeysController();},onStart:function(){this._super.apply(this,arguments);this.controller.start();},onResume:function(){this._super.apply(this,arguments);this.controller.resume();}});jscape.keystore.ClientKeysController=jscape.ui.DatagridController.extend({initialize:function(){this.importController=new jscape.keystore.ImportClientKeyController();this.importJsonController=new jscape.keystore.ImportClientKeysBatchController();this.importTslController=new jscape.keystore.ImportClientKeyTslController();this.generateController=new jscape.keystore.GenerateClientKeyController();this.exportPublicKeyController=new jscape.keystore.ExportClientPublicKeyController();this.exportCertificateController=new jscape.keystore.ExportClientCertificateController();this.viewKeyController=new jscape.keystore.ViewClientKeyController();this.viewCertificateController=new jscape.keystore.ViewClientCertificateController();this.crlController=new jscape.keystore.VerifyClientCertificateRevocationСontroller();this.revokeController=new jscape.keystore.RevokeClientCertificateController();this.deleteController=new jscape.keystore.DeleteClientKeyController();this._initValidators();},start:function(){if(this.view==null){this.view=new jscape.keystore.ClientKeysView();}
this.view.show(this);},resume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return $.when(jscape.API.listClientPublicKeys(params.startIndex,params.count,params.query),jscape.API.listClientCertificates(params.startIndex,params.count,params.query)).then(function(publicKeys,ceftificates){return{total:publicKeys.totalRecords+ceftificates.totalRecords,rows:[].concat(publicKeys.records,ceftificates.records),publicKeys:publicKeys.records,certificates:ceftificates.records};});},onImportFile:function(){return this.importController.start().done($.proxy(function(entry){if(entry instanceof jscape.CertificateSummary){this._certificateImported(entry);}else if(entry instanceof jscape.PublicKeySummary){this._publicKeyImported(entry);}},this));},onImportJson:function(){return this.importJsonController.start().done($.proxy(function(){this.view.refresh()},this));},onImportTsl:function(){return this.importTslController.start().done($.proxy(function(){this.view.refresh();},this));},onExportCertificate:function(certificate){return this.exportCertificateController.start(certificate.name);},onExportCertificatePublicKey:function(certificate){return this.exportPublicKeyController.start(certificate.name,true);},onExportPublicKey:function(key){return this.exportPublicKeyController.start(key.name,false);},onGenerate:function(){return this.generateController.start().done($.proxy(this._keyGenerated,this));},onViewPublicKey:function(key){return this.viewKeyController.start(key.name);},onViewCertificate:function(certificate){return this.viewCertificateController.start(certificate.name);},onVerifyRevocation:function(){return this.crlController.start().done($.proxy(function(){this.view.refresh();},this));},onRevokeCertificate:function(certificate){return this.revokeController.start(certificate).done($.proxy(this._certificateRevoked,this,certificate));},onDeletePublicKey:function(key){return this.deleteController.start(key.name,false).done($.proxy(this._publicKeyDeleted,this,key));},onDeleteCertificate:function(certificate){return this.deleteController.start(certificate.name,true).done($.proxy(this._certificateDeleted,this,certificate));},_publicKeyImported:function(key){this.view.getPublicKeys().push(key);this._recordAdded(key);},_certificateImported:function(certificate){this.view.getCertificates().push(certificate);this._recordAdded(certificate);},_keyGenerated:function(certificate){this.view.getCertificates().push(certificate);this._recordAdded(certificate);},_publicKeyDeleted:function(key){var items=this.view.getPublicKeys();var index=$.inArray(key,items);if(index!=-1){items.splice(index,1);this._recordDeleted(key);}},_certificateRevoked:function(certificate){this.view.refresh();},_certificateDeleted:function(certificate){var items=this.view.getCertificates();var index=$.inArray(certificate,items);if(index!=-1){items.splice(index,1);this._recordDeleted(certificate);}},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("clientkey_nonempty",window.R.string.KEY_MANAGER_CLIENT_KEYS_ERROR_BAD_ALIAS);v.rule("clientkey_notexists",$.proxy(this._keyAliasNotExists,this),window.R.string.KEY_MANAGER_CLIENT_KEYS_ERROR_ALIAS_EXISTS);v.rule("clienkeys_alternativename",$.proxy(this._alternativeNameValid,this),window.R.string.KEY_MANAGER_CLIENT_KEYS_ERROR_BAD_ALTERNATIVE_NAME);},_keyAliasNotExists:function(value,excludes){var keys=[].concat(this.view.getPublicKeys(),this.view.getCertificates());var aliases=$.map(keys,function(entry){return excludes&&excludes.inArray(entry.name)!=-1?null:entry.name;});return $.inArray(value,aliases)==-1;},_alternativeNameValid:function(value){var ret=jscape.API.validateAlternativeName(value);return ret&&ret.success===true;}});jscape.keystore.ClientKeysView=jscape.ui.DatagridView.extend({DATE_FORMAT:new jscape.DateFormat("{MM}-{dd}-{yy}"),selection:null,initialize:function(){var initializing=true;this.fieldset=$("#client-keys-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=clientkeys]",this.fieldset);this.data.datagrid({fit:true,minHeight:300,singleSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,idField:"name",sortName:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"14%"},{field:"keyAlgorithm",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.KeyPairAlgorithm.values(),$.proxy(function(entry){return entry.name;},this))}},width:"7%"},{field:"keySize",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,formatter:$.proxy(this._formatKeySize,this),finder:{type:"numberspinner",options:{editable:true,min:0}},width:"7%"},{field:"certificateSerialNumber",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"13%"},{field:"certificateIssuer",title:$("thead th:nth-child(5)",this.data).text(),sortable:false,width:"13%"},{field:"certificateSubject",title:$("thead th:nth-child(6)",this.data).text(),sortable:false,width:"13%"},{field:"certificateSubjectAlternativeName",title:$("thead th:nth-child(7)",this.data).text(),sortable:false,width:"11%"},{field:"certificateBeginDate",title:$("thead th:nth-child(8)",this.data).text(),sortable:true,width:"7%",formatter:$.proxy(this._formatDate,this),styler:$.proxy(this._styleDate,this,true),finder:"datebox"},{field:"certificateEndDate",title:$("thead th:nth-child(9)",this.data).text(),sortable:true,width:"7%",formatter:$.proxy(this._formatDate,this),styler:$.proxy(this._styleDate,this,false),finder:"datebox"},{field:"revoked",title:$("thead th:nth-child(10)",this.data).text(),sortable:true,width:"",align:"center",formatter:$.proxy(this._formatRevoked,this),finder:{type:"combobox",options:{data:[{text:"yes",value:true},{text:"no",value:false}],panelHeight:"auto"}}}]],onSelect:$.proxy(this._adjustButtonsState,this),onUnselect:$.proxy(this._adjustButtonsState,this),onUnselectAll:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onClick$ViewButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustButtonsState,this)});this.importButton=$("a[role=button][name=import]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ImportButton,this)});this.importMenu=$("div[role=menu][aria-label=import-menu]",this.fieldset).menu({onClick:$.proxy(this._onClick$ImportMenu,this)});this.exportButton=$("a[role=button][name=export]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExportButton,this)});this.exportMenu=$("div[role=menu][aria-label=export-menu]",this.fieldset).menu({onClick:$.proxy(this._onClick$ExportMenu,this)});this.generateButton=$("a[role=button][name=generate]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$GenerateButton,this)});this.crlButton=$("a[role=button][name=verifycrl]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$CrlButton,this)});this.viewButton=$("a[role=button][name=view]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.revokeButton=$("a[role=button][name=revoke]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RevokeButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.fieldset.layout("panel","south").panel("resize",{height:"auto"});this.fieldset.layout("resize");initializing=false;},show:function(listener){this.listener=listener||jscape.keystore.ClientKeysView.LISTENER;this.data.datagrid("resize");this._adjustButtonsState();},getPublicKeys:function(){return this.data.datagrid("getData").publicKeys||[];},getCertificates:function(){return this.data.datagrid("getData").certificates||[];},_formatKeySize:function(value){return!!value?value:"";},_formatDate:function(value){return $.isNumeric(value)?this.DATE_FORMAT.format(new Date(value)):null;},_styleDate:function(before,value){if($.isNumeric(value)){var now=new Date().getTime();return before&&value>now||!before&&value<now?"color:red":"color:green";}
return null;},_formatRevoked:function(value){return"<input type=\"checkbox\" onclick=\"return false\""+(value?" checked=\"checked\" />":"/>");},_onLoad$Data:function(params,success,error){this.data.datagrid("unselectAll");this.listener.onLoadData(params).then(success,error);},_onClick$ImportButton:function(){this.importMenu.menu("show",{alignTo:this.importButton});this.importButton.blur();},_onClick$ImportMenu:function(item){if("menu-file"==item.id){this.listener.onImportFile();}else if("menu-tsl"==item.id){this.listener.onImportTsl();}else if("menu-json"==item.id){this.listener.onImportJson();}},_onClick$GenerateButton:function(){this.listener.onGenerate();},_onClick$CrlButton:function(){this.listener.onVerifyRevocation();},_onClick$ExportButton:function(){var value=this.selection;if(this._isPublicKey(value)){this.listener.onExportPublicKey(value);}else if(this._isCertificate(value)){this.exportMenu.menu("show",{alignTo:this.exportButton});this.exportButton.blur();}},_onClick$ExportMenu:function(item){if("menu-crt"==item.id){this.listener.onExportCertificate(this.selection);}else if("menu-pubkey"==item.id){this.listener.onExportCertificatePublicKey(this.selection);}},_onClick$ViewButton:function(){if(this._isPublicKey(this.selection)){this.listener.onViewPublicKey(this.selection);}else if(this._isCertificate(this.selection)){this.listener.onViewCertificate(this.selection);}},_onClick$RevokeButton:function(){this.listener.onRevokeCertificate(this.selection);},_onClick$DeleteButton:function(){var value=this.selection;if(this._isPublicKey(value)){this.listener.onDeletePublicKey(value);}else if(this._isCertificate(value)){this.listener.onDeleteCertificate(value);}},_showContextMenu:function(e){this._super(e,[this.viewButton,this.revokeButton,this.deleteButton,"-",this.crlButton,"-",this.generateButton,{button:this.importButton,submenu:this.importMenu},{button:this.exportButton,submenu:this.exportMenu}]);},_adjustButtonsState:function(){this.selection=this.data.datagrid("getSelected");var enabled=this.selection!=null;this.exportButton.linkbutton(enabled?"enable":"disable");this.deleteButton.linkbutton(enabled?"enable":"disable");this.viewButton.linkbutton(enabled?"enable":"disable");this.revokeButton.linkbutton(enabled&&this._isCertificate(this.selection)?"enable":"disable");},_isPublicKey:function(key){return $.inArray(key,this.getPublicKeys())!=-1;},_isCertificate:function(key){return $.inArray(key,this.getCertificates())!=-1;}});jscape.keystore.ClientKeysView.LISTENER={onLoadData:$.noop,onImportFile:$.noop,onImportTsl:$.noop,onImportJson:$.noop,onExportCertificate:$.noop,onExportCertificatePublicKey:$.noop,onExportPublicKey:$.noop,onGenerate:$.noop,onViewPublicKey:$.noop,onViewCertificate:$.noop,onVerifyRevocation:$.noop,onRevokeCertificate:$.noop,onDeletePublicKey:$.noop,onDeleteCertificate:$.noop};jscape.keystore.ImportClientKeyController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.importClientKey(dialog.getAlias(),dialog.getFile()).done($.proxy(function(key){this.deferred.resolve(key);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.ImportClientKeyDialog();}});jscape.keystore.ImportClientKeyDialog=jscape.keystore.ImportPublicKeyDialog.extend({initialize:function(){this._super();this.alias.textbox({required:true,validType:["clientkey_nonempty","clientkey_notexists"],missingMessage:window.R.string.KEY_MANAGER_CLIENT_KEYS_ERROR_BAD_ALIAS,width:"60%"});this.file=$("input[name=file]",this.fieldset).filebox({required:true,multiple:false,missingMessage:window.R.string.KEY_MANAGER_CLIENT_KEYS_ERROR_BAD_FILE,width:"60%"});},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;}});jscape.keystore.ImportClientKeysBatchController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.importClientKeysBatch(dialog.getFile(),dialog.isOverwrite()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.ImportPublicKeysBatchDialog();}});jscape.keystore.ImportClientKeyTslController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.importClientKeyTsl(dialog.getUrl()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.ImportPublicKeyTslDialog();}});jscape.keystore.GenerateClientKeyController=Class.extend({DEFAULT_DATA:new jscape.GenerateClientKeyData(),deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var deferred=$.Deferred();var alias=dialog.getAlias();var exportDialog=new jscape.keystore.ExportPrivateKeyDialog();exportDialog.setFilename(alias+".prv");exportDialog.show({onSubmit:$.proxy(function(d){var data=this._createData(dialog,d.getFilename(),d.getFormat(),d.getPassword());d.destroy();deferred.resolve(data);},this),onCancel:function(d){d.destroy();deferred.reject();}});return deferred.then($.proxy(function(data){return jscape.API.generateClientKey(alias,data);},this)).then($.proxy(function(){return jscape.API.getClientCertificate(alias);},this)).done($.proxy(function(certificate){this.deferred.resolve(certificate);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog,keyFilename,keyFormat,keyPassword){return new jscape.GenerateClientKeyData(dialog.getAlgorithm(),dialog.getKeyLength(),dialog.getKeyCurve(),dialog.getPeriod(),dialog.getCommonName(),dialog.getSubjectAlternativeName(),dialog.getOrganizationUnit(),dialog.getOrganization(),dialog.getLocality(),dialog.getState(),dialog.getCountry(),keyFilename,keyFormat,keyPassword);},_setupDialog:function(){var dialog=new jscape.keystore.GenerateClientKeyDialog();dialog.setAlgorithm(this.DEFAULT_DATA.keyType);dialog.setKeyLength(this.DEFAULT_DATA.keyLength);dialog.setPeriod(this.DEFAULT_DATA.periodMillis);return dialog;}});jscape.keystore.GenerateClientKeyDialog=jscape.ui.DefaultDialog.extend({PERIOD_FACTOR:24*60*60*1000,initialize:function(){this._super($("#d-clientkey-generate"),{width:"65%",height:"80%"});this.fieldset=this.dialog.find(".content").first().layout({fit:true,border:false,doSize:false});this.tabs=$("div[role=tablist]",this.fieldset).tabs({fit:true,tabPosition:"top",plain:true});this.alias=$("input[name=alias]",this.fieldset).textbox({required:true,validType:["clientkey_nonempty","clientkey_notexists"],missingMessage:window.R.string.KEY_MANAGER_CLIENT_KEYS_ERROR_BAD_ALIAS,width:"60%"});this.keyAlgorithm=$("select[name=algorithm]",this.fieldset).combobox({editable:false,onChange:$.proxy(this._onChange$KeyType,this),width:"25%",panelHeight:"auto",panelMaxHeight:"40%"});this.keyLength=$("select[name=keylength]",this.fieldset).combobox({editable:false,disabled:true,limitToList:true,autoSelectFirst:false,loadFilter:function(data){return $.map(data,function(entry){return $.extend(entry,{value:parseInt(entry.value)});});},width:"25%",panelHeight:"auto",panelMaxHeight:"40%"});this.keyCurve=$("select[name=keycurve]",this.fieldset).combobox({required:true,editable:true,limitToList:true,disabled:true,width:"25%",panelHeight:"auto",panelMaxHeight:"50%"});this.period=$("input[name=period]",this.fieldset).numberspinner({min:1,max:10000,value:365,increment:10,width:80});this.commonName=$("input[name=cn]",this.fieldset).textbox({required:true,validType:"non_empty",missingMessage:window.R.string.KEY_MANAGER_ERROR_BAD_COMMON_NAME,invalidMessage:window.R.string.KEY_MANAGER_ERROR_BAD_COMMON_NAME,width:"50%"});this.subjectAlternative=$("input[name=sa]",this.fieldset).textbox({validType:["non_empty","clienkeys_alternativename"],delay:1500,validateOnCreate:false,validateOnBlur:true,width:"50%"});this.organizationUnit=$("input[name=ou]",this.fieldset).textbox({width:"50%"});this.organization=$("input[name=o]",this.fieldset).textbox({width:"50%"});this.locality=$("input[name=l]",this.fieldset).textbox({width:"50%"});this.state=$("input[name=s]",this.fieldset).textbox({width:"50%"});this.country=$("input[name=c]",this.fieldset).textbox({width:"50%"});},getAlias:function(){return this.alias.textbox("getValue");},getAlgorithm:function(){return this.keyAlgorithm.combobox("getValue");},setAlgorithm:function(value){this.keyAlgorithm.combobox("select",value);},getKeyLength:function(){return this.keyLength.combobox("getValue");},setKeyLength:function(value){this.keyLength.combobox("select",value);},getKeyCurve:function(){return this.keyCurve.combobox("getValue");},getPeriod:function(){return parseInt(this.period.numberspinner("getValue"))*this.PERIOD_FACTOR;},setPeriod:function(value){return this.period.numberspinner("setValue",value/this.PERIOD_FACTOR);},getCommonName:function(){return this.commonName.textbox("getValue");},getSubjectAlternativeName:function(){return this.subjectAlternative.textbox("getValue");},getOrganizationUnit:function(){return this.organizationUnit.textbox("getValue");},getOrganization:function(){return this.organization.textbox("getValue");},getLocality:function(){return this.locality.textbox("getValue");},getState:function(){return this.state.textbox("getValue");},getCountry:function(){return this.country.textbox("getValue");},show:function(listener){this._super(listener);this.dialog.dialog("resize",{height:"80%"}).dialog("center");this._onChange$KeyType();},_valid:function(){return true;},_onSubmit:function(){if(new jscape.Validator().validateTabs(this.tabs,true)){return this._super.apply(this,arguments);}},_onChange$KeyType:function(){var keyCurves=jscape.KeyPairAlgorithm.curvesOf(this.getAlgorithm());var keyLengths=jscape.KeyPairAlgorithm.lengthsOf(this.getAlgorithm());if(keyCurves&&keyCurves.length){this.keyCurve.combobox("enable").combobox("reset").combobox("loadData",keyCurves).closest("div").show();this.keyLength.combobox("disable").closest("div").hide();}else if(keyLengths&&keyLengths.length){var keyLength=this.keyLength.combobox("getValue");this.keyCurve.combobox("disable").closest("div").hide();this.keyLength.combobox("enable").combobox("reset").combobox("loadData",$.map(keyLengths,function(entry){return{text:String(entry),value:entry};})).combobox("select",parseInt(keyLength)).closest("div").show();}else{this.keyCurve.combobox("disable").closest("div").hide();this.keyLength.combobox("disable").closest("div").hide();}}});jscape.keystore.VerifyClientCertificateRevocationСontroller=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.verifyCertificateRevocation(dialog.getFile(),"client").done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.keystore.VerifyClientCertificateRevocationDialog();}});jscape.keystore.VerifyClientCertificateRevocationDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-clientkey-verifycrl"),{width:"50%"});this.fieldset=$("fieldset[name=verifyclientkeycrlfields]",this.dialog);this.file=$("input[type=file][name=file]",this.fieldset).validatebox({required:true,validType:"non_empty",missingMessage:window.R.string.KEY_MANAGER_ERROR_BAD_FILE}).change(function(){$(this).validatebox("validate");});},getFile:function(){var files=this.file[0].files;return files&&files.length?files[0]:null;},show:function(listener){this._super(listener);this.file.focus();}});jscape.keystore.RevokeClientCertificateController=Class.extend({start:function(certificate){if(certificate.revoked){return jscape.API.setClientCertificateRevocationStatus(certificate.name,false);}else{return this._confirmRevoke(certificate.name).done(function(){return jscape.API.setClientCertificateRevocationStatus(certificate.name,true);})}},_confirmRevoke:function(alias){return jscape.ConfirmDialog.confirm(window.R.string.KEY_MANAGER_REVOKE_CERTIFICATE_TITLE,window.R.string.KEY_MANAGER_REVOKE_CERTIFICATE_MESSAGE.supplant({0:alias}));}});jscape.keystore.DeleteClientKeyController=Class.extend({deferred:null,start:function(alias,isCertificate){this.deferred=$.Deferred();this._confirmDelete(alias,isCertificate).done($.proxy(this._deleteConfirmed,this,alias,isCertificate)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(alias,isCertificate){if(!!isCertificate){return jscape.ConfirmDialog.confirm(window.R.string.KEY_MANAGER_CLIENT_KEYS_DELETE_CERTIFICATE_TITLE,window.R.string.KEY_MANAGER_CLIENT_KEYS_DELETE_CERTIFICATE_MESSAGE.supplant({0:alias}));}else{return jscape.ConfirmDialog.confirm(window.R.string.KEY_MANAGER_CLIENT_KEYS_DELETE_PUBLIC_KEY_TITLE,window.R.string.KEY_MANAGER_CLIENT_KEYS_DELETE_PUBLIC_KEY_MESSAGE.supplant({0:alias}));}},_deleteConfirmed:function(alias,isCertificate){var promise=!!isCertificate?jscape.API.deleteClientCertificate(alias):jscape.API.deleteClientPublicKey(alias);promise.done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});jscape.keystore.ExportClientPublicKeyController=Class.extend({deferred:null,start:function(alias,isCertificate){this.alias=alias;this.isCertificate=!!isCertificate;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var format=dialog.getFormat();var filename=dialog.getFilename();return(this.isCertificate?jscape.API.exportClientCertificatePublicKey(this.alias,format,filename):jscape.API.exportClientPublicKey(this.alias,format,filename)).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.keystore.ExportPublicKeyDialog();dialog.setFilename(this.alias+".pub");return dialog;}});jscape.keystore.ExportClientCertificateController=Class.extend({deferred:null,start:function(alias){this.alias=alias;this.deferred=$.Deferred();this._setupDialog().show(this);this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportClientCertificate(this.alias,dialog.getFormat(),dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.keystore.ExportCertificateDialog();dialog.setFilename(this.alias+".crt");return dialog;}});jscape.keystore.ViewClientKeyController=jscape.keystore.ViewKeySummaryController.extend({onLoadData:function(){return jscape.API.getClientKeyView(this.alias);}});jscape.keystore.ViewClientCertificateController=jscape.keystore.ViewKeySummaryController.extend({onLoadData:function(){return jscape.API.getClientCertificateView(this.alias);}});