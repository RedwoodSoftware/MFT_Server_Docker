/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.settings=jscape.settings||{};jscape.ExpirationRange=Class.extend({initialize:function(a,b,c){this.lowerBound=parseInt(a)||0;this.upperBound=parseInt(b)||0;this.step=parseInt(c)||0;}});jscape.ExpirationRange.fromJSON=function(data){return data?new jscape.ExpirationRange(data.lowerBound,data.upperBound,data.step):null;};jscape.EmailServiceConfiguration=Class.extend({DEFAULTS:{connectionType:"PLAIN",authenticationType:"BASIC",port:25,encryptionAlgorithm:"Triple-DES",signingAlgorithm:"SHA-1",linkExpirationRange:new jscape.ExpirationRange(5,90,5),maxDownloadsDefault:5,deleteAfterRange:new jscape.ExpirationRange(5,90,5)},initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ab,ac){this.enabled=a||false;this.host=b||"";this.port=parseInt(c)||this.DEFAULTS.port;this.connectionType=d||this.DEFAULTS.connectionType;this.username=e||"";this.password=f||"";this.authenticationType=g||this.DEFAULTS.authenticationType;this.oauthTokenEndpointUrl=h||"";this.oauthClientId=i||"";this.oauthClientSecret=j||"";this.oauthRedirectUrl=k||"";this.sender=l||"";this.replyTo=m||"";this.debugFile=n||"";this.encryptionKeyAlias=o||"";this.encryptionAlgorithm=p||this.DEFAULTS.encryptionAlgorithm;this.signingKeyAlias=q||"";this.signingAlgorithm=r||this.DEFAULTS.signingAlgorithm;this.enableAdHocTransfer=s||false;this.enablePasswordProtection=t||false;this.passwordProtectionType=parseInt(u)||null;this.linkExpirationRange=v||this.DEFAULTS.linkExpirationRange;this.deleteAfterRange=w||this.DEFAULTS.deleteAfterRange;this.maxDownloadsDefault=parseInt(x)||this.DEFAULTS.maxDownloadsDefault;this.allowedSenders=y||[];this.publicContactRecipientsAllowed=z||false;this.topLevelDomainRecipientsAllowed=aa||false;this.allowedTopLevelDomains=ab||[];this.properties=ac||{};}});jscape.EmailServiceConfiguration.fromJSON=function(data){return data?new jscape.EmailServiceConfiguration(data.enabled,data.host,data.port,data.connectionType,data.username,undefined,data.authenticationType,data.oauthTokenEndpointUrl,data.oauthClientId,data.oauthClientSecret,data.oauthRedirectUrl,data.sender,data.replyTo,data.debugFile,data.encryptionKeyAlias,data.encryptionAlgorithm,data.signingKeyAlias,data.signingAlgorithm,data.enableAdHocTransfer,data.enablePasswordProtection,data.passwordProtectionType,jscape.ExpirationRange.fromJSON(data.linkExpirationRange),jscape.ExpirationRange.fromJSON(data.deleteAfterRange),data.maxDownloadsDefault,data.allowedSenders,data.publicContactRecipientsAllowed,data.topLevelDomainRecipientsAllowed,data.allowedTopLevelDomains,data.properties):null;};jscape.settings.EmailModule=jscape.settings.SettingsModule.extend({DEFAULT_CONFIG:new jscape.EmailServiceConfiguration(),onCreate:function(){this._super.apply(this,arguments);this.configManager=$.extend(new jscape.settings.ConfigManager(),{doLoad_:$.proxy(this._loadConfig,this),doSave_:$.proxy(this._saveConfig,this)});this.configController=new jscape.settings.EmailConfigurationController(this.configManager);this.adhocController=new jscape.settings.AdHocTransferController(this.configManager);this.resourcesController=new jscape.settings.EmailResourcesController(this.configManager);},onStart:function(){this._super.apply(this,arguments);this.configController.onStart();this.adhocController.onStart();this.resourcesController.onStart();},onResume:function(){this.configManager.loadConfig().always($.proxy(function(){this.configController.onResume();this.adhocController.onResume();this.resourcesController.onResume();},this));},onPause:function(){var changed=$.grep([this.configController,this.adhocController,this.resourcesController],function(c){return c.hasChanged();});if(!changed.length){return;}
this.__pausing=true;this._showConfirmApply().then($.proxy(function(){return this.configController.onApply();},this)).then($.proxy(function(){return this.adhocController.onApply();},this)).then($.proxy(function(){return this.resourcesController.onApply();},this)).then($.proxy(function(config){this.__pausing=false;return this.configManager.saveConfig(config,true);},this)).fail(function(){while(changed.length){changed.pop().onDiscard();}
changed=null;}).always($.proxy(function(){this.__pausing=false;},this));},_loadConfig:function(){return jscape.API.getEmailServiceConfiguration().catch($.proxy(function(){return this.DEFAULT_CONFIG},this));},_saveConfig:function(config){if(!!this.__pausing){return $.Deferred().resolve(config).promise();}
return jscape.API.setEmailServiceConfiguration(config);}});jscape.settings.EmailConfigurationController=Class.extend({config:null,encryptionKeys:null,signingKeys:null,view:null,initialize:function(publisher){this.encryptionKeys=[];this.signingKeys=[];this.publisher=publisher.subscribe(this);this._initValidators();},onConfigurationChanged:function(config){this.config=config;},onStart:function(){if(this.view==null){this.view=new jscape.settings.EmailServiceView();}
this.view.show(this);},onResume:function(){return $.when(jscape.API.getPgpPublicKeys(),jscape.API.getPgpSecretKeys()).then(function(publicKeys,secretKeys){publicKeys=$.map(publicKeys,function(key){return key.name;});secretKeys=$.map(secretKeys,function(key){return key.name;});return $.Deferred().resolve(publicKeys.concat(secretKeys),secretKeys).promise();},function(){return $.Deferred().resolve([],[]).promise();}).then($.proxy(function(encryptionKeys,signKeys){this.encryptionKeys=encryptionKeys||[];this.signingKeys=signKeys||[];},this)).done($.proxy(function(){this._setupView(this.config);},this));},onApply:function(){var config=this._createConfiguration(this.config);return this.hasChanged()?this.publisher.saveConfig(config):$.Deferred().resolve(this.config).promise();},onDiscard:function(){this._setupView(this.config);return $.Deferred().resolve().promise();},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration(this.config));},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onSelectDebugFile:function(){return new SelectPathController($.proxy(jscape.API.listDebugDir,jscape.API),$.proxy(jscape.API.createDebugPath,jscape.API)).selectFile().then(function(entry){return entry.path;});},onTestServer:function(){var config=this._createConfiguration(this.config);return new jscape.settings.TestEmailServerController().start(config);},_createConfiguration:function(config){return new jscape.EmailServiceConfiguration(this.view.getEnabled(),this.view.getHost(),this.view.getPort(),this.view.getConnectionType(),this.view.getUsername(),this.view.getPassword(),this.view.getAuthenticationType(),this.view.getOAuthTokenEndPointUrl(),this.view.getOAuthClientId(),this.view.getOAuthClientSecret(),this.view.getOAuthRedirectUrl(),this.view.getFromAddress(),this.view.getReplyToAddress(),this.view.getDebugFile(),this.view.getEncryptionKey(),this.view.getEncryptionAlgorithm(),this.view.getSigningKey(),this.view.getSigningAlgorithm(),config.enableAdHocTransfer,config.enablePasswordProtection,config.passwordProtectionType,config.linkExpirationRange,config.deleteAfterRange,config.maxDownloadsDefault,config.allowedSenders,config.publicContactRecipientsAllowed,config.topLevelDomainRecipientsAllowed,config.allowedTopLevelDomains,config.properties);},_setupView:function(config){var view=this.view;if(view&&config){view.setHost(config.host);view.setPort(config.port);view.setConnectionType(config.connectionType);view.setUsername(config.username);view.setPassword(config.password);view.setAuthenticationType(config.authenticationType);view.setOAuthTokenEndPointUrl(config.oauthTokenEndpointUrl);view.setOAuthClientId(config.oauthClientId);view.setOAuthClientSecret(config.oauthClientSecret);view.setOAuthRedirectUrl(config.oauthRedirectUrl);view.setFromAddress(config.sender);view.setReplyToAddress(config.replyTo);view.setDebugFile(config.debugFile);view.setEnabled(config.enabled);view.setEncryptionKeys(this.encryptionKeys);view.setEncryptionKey(config.encryptionKeyAlias);view.setEncryptionAlgorithm(config.encryptionAlgorithm);view.setSigningKeys(this.signingKeys);view.setSigningKey(config.signingKeyAlias);view.setSigningAlgorithm(config.signingAlgorithm);}},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("smtp_host_nonempty",window.R.string.EMAIL_SERVICE_ERROR_BAD_HOST);}});jscape.settings.EmailServiceView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#email-settings-fields");this.enabled=$("input[name=enabled]",this.fieldset).change($.proxy(this._onChange$Enabled,this));this.host=$("input[name=host]",this.fieldset).textbox({required:true,onChange:$.proxy(this._onForm$Change,this),validType:"smtp_host_nonempty",missingMessage:window.R.string.EMAIL_SERVICE_ERROR_BAD_HOST,width:"40%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:120});this.connectionType=$("select[name=conntype]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onForm$Change,this),width:120,panelHeight:"auto"});this.username=$("input[name=username]",this.fieldset).textbox({onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.password=$("input[name=password]",this.fieldset).passwordbox2({onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.authType=$("select[name=authtype]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(function(){this._onChange$AuthType();this._onForm$Change();},this),width:"40%",panelHeight:"auto"});this.oauthTokenEndPointUrl=$("input[name=tokenendpointurl]",this.fieldset).textbox({disabled:true,onChange:$.proxy(this._onForm$Change,this),width:"50%"});this.oauthClientId=$("input[name=clientid]",this.fieldset).textbox({width:"50%",onChange:$.proxy(this._onForm$Change,this),disabled:true});this.oauthClientSecret=$("input[name=clientsecret]",this.fieldset).passwordbox2({width:"50%",onChange:$.proxy(this._onForm$Change,this),disabled:true});this.oauthRedirectUrl=$("input[name=redirecturl]",this.fieldset).textbox({width:"50%",onChange:$.proxy(this._onForm$Change,this),disabled:true});this.debugFile=$("input[name=debugfile]",this.fieldset).textbox({onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.browseButton=$("a[role=button][name=browsefile]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$BrowseButton,this)});this.fromAddress=$("input[name=from]",this.fieldset).textbox({required:true,onChange:$.proxy(this._onForm$Change,this),validType:"email",missingMessage:window.R.string.EMAIL_SERVICE_ERROR_BAD_EMAIL,width:"30%"});this.replyToAddress=$("input[name=replyto]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),validType:"email",invalidMessage:window.R.string.EMAIL_SERVICE_ERROR_BAD_EMAIL,width:"30%"});this.useEncryption=$("input[name=useencryption]",this.fieldset).change($.proxy(this._onChange$UseEncryption,this));this.encryptionKey=$("select[name=encryptkey]",this.fieldset).combobox({required:true,editable:true,limitToList:true,disabled:true,onChange:$.proxy(this._onForm$Change,this),formatter:function(rowData){var t=rowData[$(this).combobox("options").textField];return t.escapeXml();},panelHeight:"auto",width:170});this.encryptionAlgorithm=$("select[name=encryptalgorithm]",this.fieldset).combobox({editable:false,limitToList:true,disabled:true,onChange:$.proxy(this._onForm$Change,this),width:170,panelHeight:"auto",panelMaxHeight:150});this.useSigning=$("input[name=usesigning]",this.fieldset).change($.proxy(this._onChange$UseSigning,this));this.signingKey=$("select[name=signkey]",this.fieldset).combobox({required:true,editable:true,limitToList:true,disabled:true,onChange:$.proxy(this._onForm$Change,this),formatter:function(rowData){var t=rowData[$(this).combobox("options").textField];return t.escapeXml();},panelHeight:"auto",width:170});this.signingAlgorithm=$("select[name=signalgorithm]",this.fieldset).combobox({editable:false,limitToList:true,disabled:true,onChange:$.proxy(this._onForm$Change,this),width:170,panelHeight:"auto",panelMaxHeight:150});this.testButton=$("a[role=button][name=test]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$TestButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.EmailServiceView.LISTENER;this.enabled.change();this.encryptionKey.change();this.useSigning.change();},getEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value);},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value)).numberspinner("validate");},getConnectionType:function(){return this.getEnabled()?this.connectionType.combobox("getValue"):null;},setConnectionType:function(value){this.connectionType.combobox("select",value);},getUsername:function(){return this.username.textbox("getValue");},setUsername:function(value){this.username.textbox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue")||"";},setPassword:function(value){this.password.passwordbox2("setValue",value||"");},getAuthenticationType:function(){return this.getEnabled()?this.authType.combobox("getValue"):null;},setAuthenticationType:function(value){this.authType.combobox("select",value);},getOAuthTokenEndPointUrl:function(){return this.oauthTokenEndPointUrl.textbox("getValue");},setOAuthTokenEndPointUrl:function(value){this.oauthTokenEndPointUrl.textbox("setValue",value);},getOAuthClientId:function(){return this.oauthClientId.textbox("getValue");},setOAuthClientId:function(value){this.oauthClientId.textbox("setValue",value);},getOAuthClientSecret:function(){return this.oauthClientSecret.passwordbox2("getValue");},setOAuthClientSecret:function(value){this.oauthClientSecret.passwordbox2("setValue",value);},getOAuthRedirectUrl:function(){return this.oauthRedirectUrl.textbox("getValue");},setOAuthRedirectUrl:function(value){this.oauthRedirectUrl.textbox("setValue",value);},getDebugFile:function(){return this.debugFile.textbox("getValue");},setDebugFile:function(value){this.debugFile.textbox("setValue",value);},getFromAddress:function(){return this.fromAddress.textbox("getValue");},setFromAddress:function(value){this.fromAddress.textbox("setValue",value);},getReplyToAddress:function(){return this.replyToAddress.textbox("getValue");},setReplyToAddress:function(value){this.replyToAddress.textbox("setValue",value);},isUseEncryption:function(){return this.useEncryption.is(":checked:not(:disabled)");},getEncryptionKey:function(){return this.isUseEncryption()?this.encryptionKey.combobox("getValue"):null;},setEncryptionKey:function(value){this.useEncryption.prop("checked",!!value).change();if(value){this.encryptionKey.combobox("select",value);}},setEncryptionKeys:function(values){this.encryptionKey.combobox("loadData",values);},getEncryptionAlgorithm:function(){return this.isUseEncryption()?this.encryptionAlgorithm.combobox("getValue"):null;},setEncryptionAlgorithm:function(value){this.encryptionAlgorithm.combobox("setValue",value);},isUseSigning:function(){return this.useSigning.is(":checked:not(:disabled)");},getSigningKey:function(){return this.isUseSigning()?this.signingKey.combobox("getValue"):null;},setSigningKey:function(value){this.useSigning.prop("checked",!!value).change();if(value){this.signingKey.combobox("clear").combobox("select",value);}},setSigningKeys:function(values){this.signingKey.combobox("loadData",values);},getSigningAlgorithm:function(){return this.isUseSigning()?this.signingAlgorithm.combobox("getValue"):null;},setSigningAlgorithm:function(value){this.signingAlgorithm.combobox("setValue",value);},_onClick$BrowseButton:function(){this.listener.onSelectDebugFile().done($.proxy(function(path){this.setDebugFile(path);this.debugFile.textbox("textbox").select().focus();},this));},_onClick$TestButton:function(){if(this.fieldset.form("validate")){this.testButton.linkbutton("disable");this.listener.onTestServer().always($.proxy(function(){this.testButton.linkbutton("enable");},this));}},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_onChange$Enabled:function(){var enabled=this.getEnabled();this.host.textbox(enabled?"enable":"disable").textbox(enabled?"enableValidation":"disableValidation");this.port.numberspinner(enabled?"enable":"disable").numberspinner(enabled?"enableValidation":"disableValidation");this.connectionType.combobox(enabled?"enable":"disable").combobox(enabled?"enableValidation":"disableValidation");this.username.textbox(enabled?"enable":"disable");this.password.passwordbox2(enabled?"enable":"disable");this.authType.textbox(enabled?"enable":"disable");this.debugFile.textbox(enabled?"enable":"disable");this.fromAddress.textbox(enabled?"enable":"disable").textbox(enabled?"enableValidation":"disableValidation");this.replyToAddress.textbox(enabled?"enable":"disable").textbox(enabled?"enableValidation":"disableValidation");this.browseButton.linkbutton(enabled?"enable":"disable");this.testButton.linkbutton(enabled?"enable":"disable");this.useEncryption.prop("disabled",!enabled).change();this.useSigning.prop("disabled",!enabled).change();this._onChange$AuthType();this.fieldset.form("validate");},_onChange$AuthType:function(){var enabled=this.getEnabled()&&"XOAUTH2"==this.getAuthenticationType();this.oauthTokenEndPointUrl.textbox(enabled?"enable":"disable");this.oauthClientId.textbox(enabled?"enable":"disable");this.oauthClientSecret.passwordbox2(enabled?"enable":"disable");this.oauthRedirectUrl.textbox(enabled?"enable":"disable");},_onChange$UseEncryption:function(){var enabled=this.isUseEncryption();this.encryptionKey.combobox(enabled?"enable":"disable");this.encryptionAlgorithm.combobox(enabled?"enable":"disable");},_onChange$UseSigning:function(){var enabled=this.isUseSigning();this.signingKey.combobox(enabled?"enable":"disable");this.signingAlgorithm.combobox(enabled?"enable":"disable");},_showContextMenu:function(e,_,parent){this._super(e,[this.testButton,"-",this.applyButton,this.discardButton],parent);}});jscape.settings.EmailServiceView.LISTENER={onSelectDebugFile:$.noop,onTestServer:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.AdHocTopLevelDomainDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#sseft-dialog-tld"),{width:530});this.fieldset=$("fieldset[name=adhoctldfields]",this.dialog);this.domain=$("input[name=domain]",this.fieldset).textbox({required:true,validType:["non_empty","adhoc_tld_unique"],missingMessage:window.R.string.ADHOC_TRANSFER_ERROR_BAD_DOMAIN,invalidMessage:window.R.string.ADHOC_TRANSFER_ERROR_BAD_DOMAIN,width:"60%"});},getDomain:function(){return this.domain.textbox("getValue");},setDomain:function(value){this.domain.textbox("setValue",value||"");if(value&&value.trim().length){this.domain.textbox("textbox").validatebox("options").validType=["non_empty","adhoc_tld_unique['"+value+"']"];}},show:function(listener){this._super(listener);this.domain.textbox("textbox").focus();}});jscape.settings.AdHocTransferController=Class.extend({config:null,domains:null,view:null,initialize:function(publisher){this.domains=[];this.publisher=publisher.subscribe(this);this._initValidators();},onConfigurationChanged:function(config){this.config=config;},onStart:function(){if(this.view==null){this.view=new jscape.settings.AdHocTransferView();}
this.view.show(this);},onResume:function(){this._setupView(this.config);},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration(this.config));},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){var config=this._createConfiguration(this.config);return this.hasChanged()?this.publisher.saveConfig(config):$.Deferred().resolve(this.config).promise();},onDiscard:function(){this._setupView(this.config);return $.Deferred().resolve().promise();},onAddDomain:function(){return new jscape.settings.AddAdHocTLDController().start().done($.proxy(this._tldAdded,this));},onEditDomain:function(domain){var index=$.inArray(domain,this.domains);if(index==-1){return $.Deferred().reject().promise();}
return new jscape.settings.EditAdHocTLDController().start(domain).done($.proxy(this._tldEdited,this,index));},onDeleteDomain:function(domain){return this.view.showConfirmDelete(domain).done($.proxy(this._tldDeleted,this,domain));},_tldAdded:function(domain){this.domains.push(domain);this.view.setTopLevelDomains(this.domains);this.view.selectItem(domain);},_tldEdited:function(index,domain){this.domains[index]=domain;this.view.setTopLevelDomains(this.domains);this.view.selectItem(domain);},_tldDeleted:function(domain){var index=$.inArray(domain,this.domains);if(index!=-1){this.domains.splice(index,1);this.view.setTopLevelDomains(this.domains);if(this.domains.length){index=Math.max(0,Math.min(index,this.domains.length-1));this.view.selectItem(this.domains[index]);}}},_createConfiguration:function(config){return new jscape.EmailServiceConfiguration(config.enabled,config.host,config.port,config.connectionType,config.username,config.password,config.authenticationType,config.oauthTokenEndpointUrl,config.oauthClientId,config.oauthClientSecret,config.oauthRedirectUrl,config.sender,config.replyTo,config.debugFile,config.encryptionKeyAlias,config.encryptionAlgorithm,config.signingKeyAlias,config.signingAlgorithm,this.view.getEnabled(),this.view.getProtectionEnabled(),this.view.getProtectionType(),this.view.getLinkExpirationRange(),this.view.getDeleteAfterRange(),this.view.getMaxDownloadsDefault(),this.view.getAllowedSenders(),this.view.getRecipientsPublicContactAllowed(),this.view.getRecipientsTopLevelDomainAllowed(),this.view.getTopLevelDomains(),config.properties);},_setupView:function(config){var view=this.view;if(view){this.domains=config?[].concat(config.allowedTopLevelDomains):[];if(config){view.setEnabled(config.enableAdHocTransfer);view.setProtectionEnabled(config.enablePasswordProtection);view.setProtectionType(config.passwordProtectionType);view.setLinkExpirationRange(config.linkExpirationRange);view.setDeleteAfterRange(config.deleteAfterRange);view.setMaxDownloadsDefault(config.maxDownloadsDefault);view.setAllowedSenders(config.allowedSenders);view.setRecipientsPublicContactAllowed(config.publicContactRecipientsAllowed);view.setRecipientsTopLevelDomainAllowed(config.topLevelDomainRecipientsAllowed);view.setTopLevelDomains(this.domains);}}},_initValidators:function(){var v=new jscape.Validator();v.rule("adhoc_tld_unique",$.proxy(this._tldNotExists,this),window.R.string.ADHOC_TRANSFER_ERROR_DOMAIN_EXISTS);},_tldNotExists:function(value,excludes){return $.inArray(value,this.domains)==-1||(excludes&&$.inArray(value,excludes)!=-1);}});jscape.settings.AddAdHocTLDController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var domain=dialog.getDomain();dialog.destroy();this.deferred.resolve(domain);},onCancel:function(dialog){dialog.destroy();this.deferred.reject();},_setupDialog:function(){var dialog=new jscape.settings.AdHocTopLevelDomainDialog();dialog.setTitle(window.R.string.ADHOC_TRANSFER_ADD_TITLE);dialog.setDomain(null);return dialog;}});jscape.settings.EditAdHocTLDController=Class.extend({deferred:null,start:function(domain){this.deferred=$.Deferred();this._setupDialog(domain).show(this);return this.deferred.promise();},onSubmit:function(dialog){var domain=dialog.getDomain();dialog.destroy();this.deferred.resolve(domain);},onCancel:function(dialog){dialog.destroy();this.deferred.reject();},_setupDialog:function(domain){var dialog=new jscape.settings.AdHocTopLevelDomainDialog();dialog.setTitle(window.R.string.ADHOC_TRANSFER_EDIT_TITLE);dialog.setDomain(domain);return dialog;}});jscape.settings.AdHocTransferView=jscape.ui.FormView.extend({DEFAULT_LINK_EXPIRES_RANGE:new jscape.ExpirationRange(5,90,5),DEFAULT_DELETE_AFTER_RANGE:new jscape.ExpirationRange(5,90,5),DEFAULT_MAX_DOWNLOADS:5,initialize:function(){this.fieldset=$("#adhoc-service-fields");this.enable=$("input[name=enable]:checkbox",this.fieldset).change($.proxy(this._onChange$Enabled,this));this.linkExpirationBegin=$("input[name=exprangebegin]",this.fieldset).numberspinner({min:1,max:90,onChange:$.proxy(this._onChange$LinkExpirationRange,this),width:70});this.linkExpirationEnd=$("input[name=exprangeend]",this.fieldset).numberspinner({min:1,max:90,onChange:$.proxy(this._onChange$LinkExpirationRange,this),width:70});this.linkExpirationStep=$("input[name=exprangestep]",this.fieldset).numberspinner({min:1,max:90,onChange:$.proxy(this._onChange$LinkExpirationRange,this),width:70});this.deleteAfterBegin=$("input[name=deleterangebegin]",this.fieldset).numberspinner({min:1,max:90,onChange:$.proxy(this._onChange$DeleteAfterRange,this),width:70});this.deleteAfterEnd=$("input[name=deleterangeend]",this.fieldset).numberspinner({min:1,max:90,onChange:$.proxy(this._onChange$DeleteAfterRange,this),width:70});this.deleteAfterStep=$("input[name=deleterangestep]",this.fieldset).numberspinner({min:1,max:90,onChange:$.proxy(this._onChange$DeleteAfterRange,this),width:70});this.maxDownloads=$("input[name=maxdownloads]",this.fieldset).numberspinner({disabled:true,min:1,max:10000,onChange:$.proxy(this._onForm$Change,this),width:70});this.protectEnabled=$("input[name=pwdprotectenabled]",this.fieldset).change($.proxy(this._onChange$ProtectEnabled,this));this.protectType=$("select[name=pwdprotect]",this.fieldset).combobox({editable:false,onChange:$.proxy(this._onForm$Change,this),width:"20%",panelHeight:"auto"});this.senders=$("input[name=senders]",this.fieldset).tagbox({editable:true,limitToList:false,hasDownArrow:false,separator:",",validType:["non_empty","multi_value['email',',']"],invalidMessage:window.R.string.EMAIL_SERVICE_ERROR_BAD_EMAIL,onChange:$.proxy(this._onForm$Change,this),width:"60%",panelHeight:"auto",panelMaxHeight:"60%"});this.recipientsPublicContactAllowed=$("input[name=recipientpubcontactallowed]",this.fieldset);this.recipientsTopLevelDomainAllowed=$("input[name=recipienttldallowed]",this.fieldset);this.tld=$("table[role=grid][aria-label=topleveldomains]",this.fieldset);this.tld.datagrid({fit:true,fitColumns:true,singleSelect:true,remoteSort:false,onSelect:$.proxy(this._adjustButtonsState,this),onSortColumn:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),columns:[[{field:"name",title:$("thead th:nth-child(1)",this.tld).text(),resizable:true,sortable:true,width:100,formatter:function(_,row){return String(row||"").escapeXml();}}]]});this.addButton=$("a[role=button][name=addtld]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edittld]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=deletetld]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.AdHocTransferView.LISTENER;this.tld.datagrid("resize");this.enable.change();this._onChange$LinkExpirationRange();this._adjustButtonsState();},showConfirmDelete:function(domain){return jscape.ConfirmDialog.confirm(window.R.string.ADHOC_TRANSFER_DELETE_TITLE,window.R.string.ADHOC_TRANSFER_DELETE_MESSAGE.supplant({0:domain}));},getEnabled:function(){return this.enable.is(":checked");},setEnabled:function(value){this.enable.prop("checked",!!value).change();},getLinkExpirationRange:function(){return new jscape.ExpirationRange(parseInt(this.linkExpirationBegin.numberspinner("getValue")),parseInt(this.linkExpirationEnd.numberspinner("getValue")),parseInt(this.linkExpirationStep.numberspinner("getValue")));},setLinkExpirationRange:function(value){value=value||this.DEFAULT_LINK_EXPIRES_RANGE;this.linkExpirationEnd.numberspinner("setValue",value.upperBound);this.linkExpirationBegin.numberspinner("setValue",value.lowerBound);this.linkExpirationStep.numberspinner("setValue",value.step);},getDeleteAfterRange:function(){return new jscape.ExpirationRange(parseInt(this.deleteAfterBegin.numberspinner("getValue")),parseInt(this.deleteAfterEnd.numberspinner("getValue")),parseInt(this.deleteAfterStep.numberspinner("getValue")));},setDeleteAfterRange:function(value){value=value||this.DEFAULT_DELETE_AFTER_RANGE;this.deleteAfterEnd.numberspinner("setValue",value.upperBound);this.deleteAfterBegin.numberspinner("setValue",value.lowerBound);this.deleteAfterStep.numberspinner("setValue",value.step);},getMaxDownloadsDefault:function(){return parseInt(this.maxDownloads.numberspinner("getValue"));},setMaxDownloadsDefault:function(value){this.maxDownloads.numberspinner("setValue",value||this.DEFAULT_MAX_DOWNLOADS);},getProtectionEnabled:function(){return this.protectEnabled.is(":checked");},setProtectionEnabled:function(value){this.protectEnabled.prop("checked",!!value).change();},getProtectionType:function(){return parseInt(this.protectType.combobox("getValue"),10);},setProtectionType:function(value){value=value?value.toString():"";this.protectType.combobox("clear").combobox("setValue",value).combobox("select",value);},getAllowedSenders:function(){return this.senders.tagbox("getValues");},setAllowedSenders:function(values){this.senders.tagbox("setValues",values);},getRecipientsPublicContactAllowed:function(){return this.recipientsPublicContactAllowed.is(":checked");},setRecipientsPublicContactAllowed:function(value){this.recipientsPublicContactAllowed.prop("checked",!!value).change();},getRecipientsTopLevelDomainAllowed:function(){return this.recipientsTopLevelDomainAllowed.is(":checked");},setRecipientsTopLevelDomainAllowed:function(value){this.recipientsTopLevelDomainAllowed.prop("checked",!!value).change();},getTopLevelDomains:function(){return this.tld.datagrid("getRows");},setTopLevelDomains:function(values){this.tld.datagrid("loading").datagrid("loadData",values).datagrid("loaded");},selectItem:function(value){this.tld.datagrid("selectRow",this.tld.datagrid("getRowIndex",value));},_onClick$AddButton:function(){this.listener.onAddDomain().done($.proxy(this._onForm$Change,this));},_onClick$EditButton:function(){var item=this.tld.datagrid("getSelected");this.listener.onEditDomain(item).done($.proxy(this._onForm$Change,this));},_onClick$DeleteButton:function(){var item=this.tld.datagrid("getSelected");this.listener.onDeleteDomain(item).done($.proxy(this._onForm$Change,this));},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_onChange$Enabled:function(){var enabled=this.getEnabled();this.linkExpirationBegin.numberspinner(enabled?"enable":"disable");this.linkExpirationEnd.numberspinner(enabled?"enable":"disable");this.linkExpirationStep.numberspinner(enabled?"enable":"disable");this.deleteAfterBegin.numberspinner(enabled?"enable":"disable");this.deleteAfterEnd.numberspinner(enabled?"enable":"disable");this.deleteAfterStep.numberspinner(enabled?"enable":"disable");this.maxDownloads.numberspinner(enabled?"enable":"disable");this.protectEnabled.prop("disabled",!enabled).change();this.senders.tagbox(enabled?"enable":"disable");this.recipientsPublicContactAllowed.prop("disabled",!enabled).change();this.recipientsTopLevelDomainAllowed.prop("disabled",!enabled).change();this.tld.datagrid("options").disabled=!enabled;this._adjustButtonsState();},_onChange$LinkExpirationRange:function(){this._onChange$Range(this.getLinkExpirationRange(),this.linkExpirationBegin,this.linkExpirationEnd,this.linkExpirationStep);},_onChange$DeleteAfterRange:function(){this._onChange$Range(this.getDeleteAfterRange(),this.deleteAfterBegin,this.deleteAfterEnd,this.deleteAfterStep);},_onChange$Range:function(range,beginInput,endInput,stepInput){var begin=range.lowerBound;var end=range.upperBound;beginInput.numberspinner("options").max=end;if(begin>end){beginInput.numberspinner("setValue",end);stepInput.numberspinner("options").max=1;}else{var step=range.step;var maxStep=end-begin;stepInput.numberspinner("options").max=maxStep;if(step>maxStep){stepInput.numberspinner("setValue",maxStep);}}
this.fieldset.triggerHandler("_change");},_onChange$ProtectEnabled:function(){var enabled=this.protectEnabled.is(":checked")&&!this.protectEnabled.is(":disabled");this.protectType.combobox(enabled?"enable":"disable");},_adjustButtonsState:function(){var opts=this.tld.datagrid("options");var enabled=this.tld.datagrid("getSelected")!=null&&!opts.disabled;this.addButton.linkbutton(!opts.disabled?"enable":"disable");this.editButton.linkbutton(enabled?"enable":"disable");this.deleteButton.linkbutton(enabled?"enable":"disable");},_showContextMenu:function(e,_,parent){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.applyButton,this.discardButton],parent);}});jscape.settings.AdHocTransferView.LISTENER={onChange:$.noop,onAddDomain:$.noop,onEditDomain:$.noop,onDeleteDomain:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.EmailResourcesController=Class.extend({VARIABLES:["domain","username","URL","date","message","password","transferEntries","entry.filename","entry.filesize","entry.downloadUrl","entry.expirationDate","entry.maxDownloads"],config:null,view:null,initialize:function(publisher){this.publisher=publisher.subscribe(this);},onConfigurationChanged:function(config){this.config=config;},onStart:function(){if(this.view==null){this.view=new jscape.settings.EmailResourcesView();}
this.view.show(this);},onResume:function(){this._setupView(this.config);},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration(this.config));},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){var config=this._createConfiguration(this.config);return this.hasChanged()?this.publisher.saveConfig(config):$.Deferred().resolve(this.config).promise();},onDiscard:function(){this._setupView(this.config);return $.Deferred().resolve().promise();},onAddVariable:function(input){return new jscape.FreemarkerVariableController().start(input,this.VARIABLES);},_createConfiguration:function(config){return $.extend(true,new jscape.EmailServiceConfiguration(),config,{properties:this.view.getResources()});},_setupView:function(config){if(this.view){var props=config?$.extend({},config.properties):{};this.view.setResources(props);}}});jscape.settings.EmailResourcesView=jscape.ui.FormView.extend({rowIndex:-1,initialize:function(){this.fieldset=$("#email-resources-fields").on("contextmenu",$.proxy(this._onForm$ContextMenu,this));this.data=$("table[role=grid][aria-label=resources]",this.fieldset);this.data.propertygrid({fit:true,fitColumns:true,showGroup:false,scrollbarSize:0,sortName:"name",sortOrder:"asc",columns:[[{field:"name",sortable:true,width:"25%"},{field:"value",resizable:false,width:"70%"}]],onClickRow:$.proxy(this._adjustButtonsState,this),onLoadSuccess:function(){$(this).propertygrid("fitColumns").propertygrid("fixColumnSize","value");},onBeforeEdit:$.proxy(this._onBefore$Edit,this),onBeginEdit:$.proxy(this._onBegin$Edit,this),onCancelEdit:$.proxy(this._onCancel$Edit,this),onAfterEdit:$.proxy(this._onForm$Change,this)});this.addVariableButton=$("a[role=button][name=addvariable]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$AddVariableButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});},show:function(listener){this.listener=listener||jscape.settings.EmailResourcesView.LISTENER;this.data.propertygrid("resize");this._onForm$Change();this._adjustButtonsState();},getResources:function(){var resources={};var rows=this.data.propertygrid("getRows");for(var i=0;i<rows.length;i++){var row=rows[i];resources[row.name]=row.value;}
return resources;},setResources:function(resources){var data=[];for(var key in resources){if(resources.hasOwnProperty(key)){data.push({name:key,value:resources[key],editor:"textarea"});}}
this.data.propertygrid("loadData",data);this._onForm$Change();},_onBefore$Edit:function(index){this.rowIndex=index;this._adjustButtonsState();this.applyButton.linkbutton("enable");},_onBegin$Edit:function(index){var editor=this.data.propertygrid("getEditor",{index:index,field:"value"});var t=$(editor.target);if(t.hasClass("textbox-f")){t=t.textbox("textbox");}
if(t.length){t.height(t.height()+(t[0].scrollHeight||0)+50);}
t.on("keydown",$.proxy(function(e){if(e.keyCode===27){e.stopPropagation();this.data.propertygrid("cancelEdit",index);}},this));},_onCancel$Edit:function(){this.rowIndex=-1;this._adjustButtonsState();},_onClick$AddVariableButton:function(){var index=this.rowIndex;if(index!=-1){this.data.propertygrid("selectRow",index).propertygrid("beginEdit",index);this.data.propertygrid("options").editIndex=index;var editor=this.data.propertygrid("getEditor",{index:index,field:"value"});if(editor!=null){var input=$(editor.target);this.listener.onAddVariable(input);}}},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_adjustButtonsState:function(){this.addVariableButton.linkbutton(this.rowIndex>=0?"enable":"disable");},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.settings.EmailResourcesView.LISTENER={onChange:$.noop,onAddVariable:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.TestEmailServerController=Class.extend({deferred:null,start:function(descriptor){this.descriptor=descriptor;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.testEmailServer(this.descriptor,dialog.getRecipient()).done($.proxy(this._testPassed,this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.settings.TestEmailServerDialog();},_testPassed:function(){$.messager.alert(window.R.string.EMAIL_SERVICE_TEST_SUCCESS_TITLE,window.R.string.EMAIL_SERVICE_TEST_SUCCESS_MESSAGE,"info");this.deferred.resolve();this.deferred=null;}});jscape.settings.TestEmailServerDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#sses-dialog-test"),{width:"50%",maxWidth:550});this.fieldset=$("fieldset[name=emailsettingstestfields]",this.dialog);this.recipient=$("input[name=recipient]",this.fieldset).textbox({required:true,validType:"email",missingMessage:window.R.string.EMAIL_SERVICE_ERROR_BAD_RECIPIENT,invalidMessage:window.R.string.EMAIL_SERVICE_ERROR_BAD_RECIPIENT,width:"70%"});},getRecipient:function(){return this.recipient.textbox("getValue");},show:function(listener){this._super(listener);this.recipient.textbox("textbox").focus();}});