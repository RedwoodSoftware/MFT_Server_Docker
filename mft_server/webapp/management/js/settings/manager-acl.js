/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.settings.ManagementRolesController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this._super(true);this.addController=new jscape.settings.AddManagementRoleController();this.editController=new jscape.settings.EditManagementRoleController();this.deleteController=new jscape.settings.DeleteManagementRoleController();this.copyController=new jscape.settings.CopyManagementRoleController();this._initValidators();},start:function(listener){this.listener=listener||jscape.settings.ManagementRolesController.LISTENER;if(this.view==null){this.view=new jscape.settings.ManagementRolesView();}
this.view.show(this);},resume:function(){this.view.refresh();},onLoadData:function(){return jscape.API.getManagementRoles().done($.proxy(function(roles){this.listener.onChangeRoles(roles);},this));},hasChanged:function(){return false;},onAddRole:function(){return this.addController.start().done($.proxy(this._roleAdded,this));},onEditRole:function(role){return this.editController.start(role).done($.proxy(this._roleEdited,this));},onCopyRole:function(role){return this.copyController.start(role).done($.proxy(this._roleCopied,this));},onDeleteRole:function(roles){return this.deleteController.start(roles).done($.proxy(this._roleDeleted,this,roles));},_roleAdded:function(role){this._recordAdded(role);},_roleEdited:function(role){this._recordEdited(role);},_roleCopied:function(role,editAfterDone){var name=role.name;if(editAfterDone){this.view.refresh($.proxy(function(){this.view.selectRecord(name);this.onEditRole(name);},this));}else{this._recordAdded(name);}},_roleDeleted:function(roles){this._recordDeleted(roles);},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("acl_role_nonempty",window.R.string.ACL_ERROR_BAD_ROLE);v.rule("acl_role_unique",$.proxy(this._roleNotExists,this),window.R.string.ACL_ERROR_ROLE_ALREDY_EXISTS);},_roleNotExists:function(value){return this.view.indexOf(value)==-1;}});jscape.settings.ManagementRolesController.LISTENER={onChangeRoles:$.noop};jscape.settings.ManagementRolesView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){this.fieldset=$("#acl-roles-fields");var initializing=true;this.data=$("table[role=grid][aria-label=roles]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:false,ctrlSelect:true,sortOrder:"asc",idField:"value",columns:[[{field:"value",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"100%"}]],loader:$.proxy(this._onLoad$Data,this),loadFilter:function(data){return $.map($.isArray(data)?data:data.rows,function(val){return{text:String(val).escapeXml(),value:val};});},onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onSortColumn:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.copyButton=$("a[role=button][name=copy]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.settings.ManagementRolesView.LISTENER;this.data.datagrid("resize");this._adjustState();},_onLoad$Data:function(params,success,error){return this.listener.onLoadData(params).then(success,error);},_onClick$AddButton:function(){this.addButton.linkbutton("disable");this.listener.onAddRole(this).always($.proxy(function(){this.addButton.linkbutton("enable");},this));},_onClick$EditButton:function(){this.editButton.linkbutton("disable");this.listener.onEditRole(this._valueOf(this.selection[0])).always($.proxy(function(){this.editButton.linkbutton("enable");},this));},_onClick$CopyButton:function(){this.copyButton.linkbutton("disable");this.listener.onCopyRole(this._valueOf(this.selection[0])).always($.proxy(function(){this.copyButton.linkbutton("enable");},this));},_onClick$DeleteButton:function(){this.deleteButton.linkbutton("disable");this.listener.onDeleteRole($.map(this.selection,$.proxy(this._valueOf,this))).always($.proxy(function(){this.deleteButton.linkbutton("enable");},this));},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.copyButton,this.deleteButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.copyButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.settings.ManagementRolesView.LISTENER={onLoadData:$.noop,onAddRole:$.noop,onEditRole:$.noop,onCopyRole:$.noop,onDeleteRole:$.noop};jscape.settings.BaseManagementRoleController=Class.extend({initialize:function(){this.addDomainAccessController=new jscape.settings.AddDomainAccessController();this.deleteDomainAccessController=new jscape.settings.DeleteDomainAccessController();},onBrowseAllowedDir:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectPath().then(function(entry){return entry.path;});},onDomainPermissions:function(dialog,domainAccess){var d=new jscape.settings.DomainPermissionsDialog();d.show({onLoadTriggerEvents:function(){return jscape.API.getTriggerEvents(domainAccess.domainName);},onLoadTriggerFunctions:function(){return jscape.API.getTriggerFunctions(domainAccess.domainName);},onLoadTriggerActions:function(){return jscape.API.getTriggerActions(domainAccess.domainName);},onSubmit:$.proxy(function(d){var deferred=$.Deferred();var promise=deferred.promise();if(!!domainAccess.enabled&&d.getPermissions().length==0){this._showDomainPermissionsEmptyError();deferred.reject();}else{domainAccess.permissions=d.getPermissions();domainAccess.allowedEvents=d.getAllowedEvents();domainAccess.allowedFunctions=d.getAllowedFunctions();domainAccess.allowedActions=d.getAllowedActions();deferred.resolve(domainAccess);}
return promise;},this),onCancel:function(d){d.destroy();}});d.setDomainName(domainAccess.domainName);d.setPermissions(domainAccess.permissions);d.setAllowedEvents(domainAccess.allowedEvents);d.setAllowedFunctions(domainAccess.allowedFunctions);d.setAllowedActions(domainAccess.allowedActions);},onAddDomainAccess:function(dialog){var values=dialog.getDomainAccesses();this.addDomainAccessController.start(values).done(function(access){values.push(access);dialog.setDomainAccesses(values);dialog.selectDomainAccess(access);});},onDeleteDomainAccess:function(dialog,domainAccess){var values=dialog.getDomainAccesses();var index=$.inArray(domainAccess,values);if(index!=-1){this.deleteDomainAccessController.start(domainAccess).done(function(){values.splice(index,1);dialog.setDomainAccesses(values);if(values.length){index=Math.min(Math.max(0,index),values.length-1);dialog.selectDomainAccess(values[index]);}});}},_showDomainPermissionsEmptyError:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.ACL_ERROR_DOMAIN_PERMISSIONS_EMPTY,"warning");}});jscape.settings.AddManagementRoleController=jscape.settings.BaseManagementRoleController.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.addManagementRole(this._createRole(dialog)).done($.proxy(function(role){this.deferred.resolve(role.name);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createRole:function(dialog){return new jscape.ManagementRole(dialog.getName(),dialog.getGlobalPermissions(),dialog.getAllowedDirectory(),dialog.getDomainAccesses());},_setupDialog:function(){var dialog=new jscape.settings.AddManagementRoleDialog();jscape.API.getAclTags().done(function(tags){dialog.setAvailableTags(tags);});return dialog;}});jscape.settings.EditManagementRoleController=jscape.settings.BaseManagementRoleController.extend({deferred:null,start:function(roleName){this.deferred=$.Deferred();this.roleName=roleName;jscape.API.getManagementRole(roleName).done($.proxy(function(role){this._setupDialog(role).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},onSubmit:function(dialog){var name=this.roleName;return jscape.API.setManagementRole(name,this._createRole(dialog,name)).done($.proxy(function(){this.deferred.resolve(name);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createRole:function(dialog,roleName){return new jscape.ManagementRole(roleName,dialog.getGlobalPermissions(),dialog.getAllowedDirectory(),dialog.getDomainAccesses());},_setupDialog:function(role){var dialog=new jscape.settings.EditManagementRoleDialog();dialog.setName(role.name);dialog.setGlobalPermissions(role.permissions);dialog.setAllowedDirectory(role.allowedDirectory);dialog.setDomainAccesses(role.domainAccesses);jscape.API.getAclTags().done(function(tags){dialog.setAvailableTags(tags);});return dialog;}});jscape.settings.DeleteManagementRoleController=Class.extend({deferred:null,start:function(roleNames){this.deferred=$.Deferred();this._confirmDelete(roleNames).done($.proxy(this._deleteConfirmed,this,roleNames)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(roleNames){return jscape.ConfirmDialog.confirm(window.R.string.ACL_CONFIRM_DELETE_ROLE_TITLE,window.R.string.ACL_CONFIRM_DELETE_ROLE_MESSAGE.supplant({0:roleNames.join(", ")}));},_deleteConfirmed:function(roleNames){$.when.apply(jQuery,$.map(roleNames,$.proxy(function(name){return jscape.API.deleteManagementRole(name);},this))).done($.proxy(function(){this.deferred.resolve(roleNames);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});jscape.settings.AddDomainAccessController=Class.extend({deferred:null,start:function(domainAccesses){this.deferred=$.Deferred();jscape.API.getDomainNames().then(function(domainNames){return $.grep(domainNames,function(domainName){for(var i=0;i<domainAccesses.length;i++){if(domainAccesses[i].domainName==domainName){return false;}}
return true;});}).done($.proxy(function(domainNames){if(domainNames.length!=0){this._setupDialog(domainNames).show(this);}else{this._showNoDomainsError();this.deferred.reject();this.deferred=null;}},this)).fail($.proxy($.proxy(function(){this.deferred.resolve();this.deferred=null;},this)));return this.deferred.promise();},onSubmit:function(dialog){var access=this._createDomainAccess(dialog);dialog.destroy();this.deferred.resolve(access);this.deferred=null;},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createDomainAccess:function(dialog){return new jscape.DomainAccess(dialog.getDomain(),['DOMAIN_STATISTICS_READ'],null,null,null,[],true);},_setupDialog:function(domains){var dialog=new jscape.settings.AddDomainAccessDialog();dialog.setDomains(domains);return dialog;},_showNoDomainsError:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.ACL_ERROR_DOMAINS_NOT_AVAILABLE,"warning");}});jscape.settings.AddDomainAccessDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-settings-acl-domainaccess"),{width:"40%",minWidth:530,maxWidth:700,minHeight:230});this.domain=$("select[name=domain]",this.fieldset).combobox({required:true,editable:false,width:"60%",panelHeight:"auto"});},getDomain:function(){return this.domain.combobox("getValue");},setDomains:function(values){this.domain.combobox("loadData",values);}});jscape.settings.DeleteDomainAccessController=Class.extend({start:function(domainAccess){return jscape.ConfirmDialog.confirm(window.R.string.ACL_CONFIRM_DELETE_DOMAIN_ACCESS_TITLE,window.R.string.ACL_CONFIRM_DELETE_DOMAIN_ACCESS_MESSAGE.supplant({0:domainAccess.domainName}));}});jscape.settings.ManagementRoleDialog=jscape.ui.DefaultDialog.extend({selection:null,editIndex:null,tags:null,initialize:function(dialog){this.selection=[];this.editIndex=-1;this.tags=[];this._super(dialog,{width:"75%",height:"90%"});this.serverPermissionsView=new jscape.settings.RolePermissionsView($("a[role=button][name=grantallpermissions]",this.dialog),$("fieldset[name=serverpermissions]",this.dialog).find("select"));this.allowedDirectory=$("input[name=restrictdir]",this.dialog).textbox({validType:"non_empty",buttonText:"...",buttonAlign:"right",buttonIcon:null,onClickButton:$.proxy(this._onClick$BrowseAllowedDirectory,this),width:"50%"});this.domains=$("table[role=grid][aria-label=domainspermissions]",this.dialog);this.domains.datagrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:true,onSelect:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onLoadSuccess:$.proxy(this._adjustRowSelection,this),onClickRow:$.proxy(this._onClick$Row,this),onDblClickRow:$.proxy(function(){this.domainPermissionsButton.click();},this),onBeginEdit:$.proxy(function(index){this.editIndex=index;},this),onEndEdit:$.proxy(function(){this.editIndex=-1;},this),sortName:"domainName",columns:[[{field:"domainName",title:$("thead th:nth-child(1)",this.domains).text(),sortable:true,width:100},{field:"enabled",title:$("thead th:nth-child(2)",this.domains).text(),sortable:true,width:70,align:"center",editor:"accessible",formatter:function(value){return"<input type=\"checkbox\""+(value?" checked=\"checked\"":"")+"/>";}},{field:"tags",title:$("thead th:nth-child(3)",this.domains).text(),width:200,editor:"tags",formatter:function(value){return(value||[]).join(", ").escapeXml();}}]],editors:{accessible:$.extend({},$.fn.datagrid.defaults.editors.checkbox,{init:function(parent){return $("<input type=\"checkbox\">").appendTo(parent);},getValue:function(target){return $(target).is(":checked");},setValue:function(target,value){$(target).prop("checked",!!value);}}),tags:$.extend({},$.fn.datagrid.defaults.editors.combobox,{init:function(parent,options){return $("<input type=\"text\">").appendTo(parent).tagbox({limitToList:true,hasDownArrow:true,width:"100%",panelHeight:"auto",onLoadSuccess:$.noop});},getValue:function(target){return $(target).tagbox("getValues");},setValue:function(target,tags){if(tags){$(target).tagbox("setValues",tags);}else{$(target).tagbox("clear");}}})}});this.domainPermissionsButton=$("a[role=button][name=permissions]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DomainPermissionsButton,this)});this.addAccessButton=$("a[role=button][name=add]",this.dialog).linkbutton({onClick:$.proxy(this._onClick$AddAccessButton,this)});this.deleteAccessButton=$("a[role=button][name=delete]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteAccessButton,this)});},getGlobalPermissions:function(){return this.serverPermissionsView.getValues();},setGlobalPermissions:function(values){this.serverPermissionsView.setValues(values);},getAllowedDirectory:function(){return this.allowedDirectory.textbox("getValue");},setAllowedDirectory:function(value){this.allowedDirectory.textbox("setValue",value);},getDomainAccesses:function(){return this.domains.datagrid("acceptChanges").datagrid("getRows");},setDomainAccesses:function(values){this.domains.datagrid("rejectChanges").datagrid("loading").datagrid("loadData",values).datagrid("loaded");},selectDomainAccess:function(value){this.domains.datagrid("selectRow",this.domains.datagrid("getRowIndex",value));},setAvailableTags:function(values){this.tags=values;},show:function(listener){this._super(listener);this._adjustRowSelection();},_valid:function(){this.domains.datagrid("acceptChanges");return this._super();},_onClick$Row:function(index){if(this.editIndex!=index){this.domains.datagrid("endEdit",this.editIndex).datagrid("beginEdit",index);var editor=this.domains.datagrid("getEditor",{index:index,field:"tags"});editor&&$(editor.target).combobox("loadData",this.tags);}},_onClick$BrowseAllowedDirectory:function(){this.allowedDirectory.textbox("button").linkbutton("disable");this.listener.onBrowseAllowedDir().done($.proxy(function(path){this.allowedDirectory.textbox("setValue",path).textbox("textbox").select().focus();},this)).always($.proxy(function(){this.allowedDirectory.textbox("button").linkbutton("enable");},this));},_onClick$DomainPermissionsButton:function(){this.listener.onDomainPermissions(this,this.selection[0]);},_onClick$AddAccessButton:function(){this.listener.onAddDomainAccess(this);},_onClick$DeleteAccessButton:function(){this.listener.onDeleteDomainAccess(this,this.selection[0]);},_adjustRowSelection:function(){this.selection=this.domains.datagrid("getSelections");this._adjustButtons();},_adjustButtons:function(){this.domainPermissionsButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteAccessButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.settings.ManagementRoleDialog.LISTENER={onAccDomainAccess:$.noop,onDeleteDomainAccess:$.noop,onDomainPermissions:$.noop,onBrowseAllowedDir:$.noop,onSubmit:$.noop,onCancel:$.noop};jscape.settings.RolePermissionsView=Class.extend({initialize:function(grantAllButton,permissionInputs){this.grantAllButton=$(grantAllButton);this.grantAllButton.switchbutton({checked:false,onChange:$.proxy(this._onChange$GrantAllButton,this),label:grantAllButton.text(),labelWidth:300,labelPosition:"after"});this.permissionInputs=permissionInputs;this.permissionInputs.each($.proxy(function(_,el){var combo=$(el);combo.combo({editable:false,multiple:true,onChange:$.proxy(this._onChange$Permissions,this,combo),width:"50%",panelHeight:"auto"});var p=combo.combo("panel");p.append(combo.parent().find(".combo-panel"));var list=p.find("ul");list.datalist({border:false,checkbox:true,selectOnCheck:true,singleSelect:false,onSelect:$.proxy(this._onChange$PermissionList,this,combo),onUnselect:$.proxy(this._onChange$PermissionList,this,combo),onSelectAll:$.proxy(this._onChange$PermissionList,this,combo),onUnselectAll:$.proxy(this._onChange$PermissionList,this,combo)});this._selectAllButtonFor(combo).click({target:combo},$.proxy(this._onClick$SelectAll,this));},this));},getValues:function(){return this.permissionInputs.map(function(){return $(this).combo("getValues");}).get();},setValues:function(values){$.each(this.permissionInputs,$.proxy(function(_,el){var combo=$(el);var list=this._permissionListFor(combo);combo.combo("clear");list.datalist("unselectAll");for(var index=0,rows=list.datalist("getData").rows,opts=list.datalist("options");index<rows.length;++index){var value=rows[index][opts.valueField];if($.inArray(value,values)!=-1){list.datalist("selectRow",index);}}},this));this._adjustSelectAllButtonSafe();},_onChange$GrantAllButton:function(checked){var permissions=!!checked?$.map(this.permissionInputs,$.proxy(function(el){var list=this._permissionListFor(el);var key=list.datalist("options").valueField;return $.map(list.datalist("getRows"),function(r){return r[key];});},this)):[];this.setValues(permissions);},_onChange$Permissions:function(combo,newValues){var btn=this._selectAllButtonFor(combo);var oldSelected=!!btn.prop("selected");btn.prop("selected",newValues.length!=0);if(oldSelected!=btn.prop("selected")){this._toggleButtonText(btn);}},_onChange$PermissionList:function(jq){var combo=$(jq);var sep=combo.combo("options").separator;var data=this._permissionListFor(combo).datalist("getSelections");combo.combo("setText",$.map(data,function(r){return r.text;}).join(sep)).combo("setValues",$.map(data,function(r){return r.value;}));},_onClick$SelectAll:function(e){var list=this._permissionListFor(e.data.target);if($(e.target).closest("button").prop("selected")){list.datalist("unselectAll");}else{list.datalist("selectAll");}},_permissionListFor:function(jq){return $(jq).combo("panel").find(".datagrid-f");},_selectAllButtonFor:function(jq){return $(jq).combo("panel").find(".select-all");},_adjustSelectAllButtonSafe:function(){var values=this.getValues();var opts=this.grantAllButton.switchbutton("options");var handler=opts.onChange;if(values.length==0){opts.onChange=$.noop;this.grantAllButton.switchbutton("uncheck");opts.onChange=handler;}else if(Object._equals(values,this._getAvailableValues())){opts.onChange=$.noop;this.grantAllButton.switchbutton("check");opts.onChange=handler;}},_getAvailableValues:function(){return $.map(this.permissionInputs,$.proxy(function(el){var list=this._permissionListFor(el);var valueField=list.datalist("options").valueField;return $.map(list.datalist("getRows"),function(r){return r[valueField];});},this));},_toggleButtonText:function(btn){var text=btn.text();var toggleText=btn.data("toggle-text")||"";if(!!toggleText&&toggleText!==text){btn.html(btn.html().replace(text,toggleText));btn.data("toggle-text",text);if(btn.data("linkbutton")){btn.linkbutton("resize");}}}});jscape.settings.AddManagementRoleDialog=jscape.settings.ManagementRoleDialog.extend({initialize:function(){this._super($("#d-settings-acl-addrole"));this.name=$("input[name=name]",this.dialog).textbox({required:true,validType:["acl_role_nonempty","acl_role_unique"],missingMessage:window.R.string.ACL_ERROR_BAD_ROLE,width:"60%"});},getName:function(){return this.name.textbox("getValue");}});jscape.settings.EditManagementRoleDialog=jscape.settings.ManagementRoleDialog.extend({initialize:function(){this._super($("#d-settings-acl-editrole"));this.title=this.dialog.dialog("header").text()||"";},setName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));}});jscape.settings.DomainPermissionsDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#d-settings-acl-domainpermissions"),{width:"70%",height:"90%"});this.title=this.dialog.dialog("header").text()||"";this.fieldset=$("fieldset[name=domainpermissionsfields]",this.dialog);this.permissionsView=new jscape.settings.RolePermissionsView($("a[role=button][name=grantallpermissions]",this.fieldset),this.fieldset.find("[name=domainpermissions]").find("select"));this.triggerTabs=$("div[role=tablist]",this.fieldset).tabs({tabPosition:"top",plain:true,height:400});$("div[role=presentation]",this.triggerTabs).layout({fit:true});this.restrictEvents=$("input[name=restrictevents]",this.fieldset);this.events=$("table[role=grid][aria-label=triggerevents]",this.fieldset);this.restrictEvents.switchbutton({checked:false,onChange:$.proxy(function(checked){this._disableDataGrid(this.events,!checked);this.events.datagrid("getPanel").panel("expand");},this)});this.events.datagrid({fitColumns:false,autoRowHeight:false,collapsible:true,collapsed:true,width:"95%",height:"auto",minHeight:150,maxHeight:350,checkOnSelect:true,selectOnCheck:true,remoteSort:false,sortOrder:"asc",idField:"type",columns:[[{field:"allowed",checkbox:true,width:50,fixed:true},{field:"name",title:$("thead th:nth-child(1)",this.events).text(),sortable:true,width:"30%"},{field:"description",title:$("thead th:nth-child(2)",this.events).text(),sortable:false,width:"65%",formatter:$.proxy(this._formatEventDescription,this)}]],loader:$.proxy(this._onLoad$Events,this),onBeforeSelect:$.proxy(this.isRestrictEvents,this),onBeforeCheck:$.proxy(this.isRestrictEvents,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._onLoadSuccess$DataGrid,this,this.events,this.restrictEvents),onExpand:$.proxy(this._onExpand$DataGrid,this,this.events)});var tep=this.events.datagrid("getPanel");tep.panel("header").click(function(){tep.panel(tep.panel("options").collapsed?"expand":"collapse",true);});this.restrictFunctions=$("input[name=restrictfunctions]",this.fieldset);this.functions=$("table[role=grid][aria-label=triggerfunctions]",this.fieldset);this.restrictFunctions.switchbutton({checked:false,onChange:$.proxy(function(checked){this._disableDataGrid(this.functions,!checked);this.functions.datagrid("getPanel").panel("expand");},this)});this.functions.datagrid({fitColumns:false,autoRowHeight:false,collapsible:true,collapsed:true,width:"95%",height:"auto",minHeight:150,maxHeight:350,checkOnSelect:true,selectOnCheck:true,remoteSort:false,sortOrder:"asc",idField:"name",columns:[[{field:"allowed",checkbox:true,width:50,fixed:true},{field:"name",title:$("thead th:nth-child(1)",this.functions).text(),sortable:true,width:"30%"},{field:"description",title:$("thead th:nth-child(2)",this.functions).text(),sortable:false,width:"65%",formatter:$.proxy(this._formatFunctionDescription,this)}]],loader:$.proxy(this._onLoad$Functions,this),onBeforeSelect:$.proxy(this.isRestrictFunctions,this),onBeforeCheck:$.proxy(this.isRestrictFunctions,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._onLoadSuccess$DataGrid,this,this.functions,this.restrictFunctions),onExpand:$.proxy(this._onExpand$DataGrid,this,this.functions)});var tfp=this.functions.datagrid("getPanel");tfp.panel("header").click(function(){tfp.panel(tfp.panel("options").collapsed?"expand":"collapse",true);});this.restrictActions=$("input[name=restrictactions]",this.fieldset);this.actions=$("table[role=grid][aria-label=triggeractions]",this.fieldset);this.restrictActions.switchbutton({checked:false,onChange:$.proxy(function(checked){this._disableDataGrid(this.actions,!checked);this.actions.datagrid("getPanel").panel("expand");},this)});this.actions.datagrid({fitColumns:false,autoRowHeight:false,collapsible:true,collapsed:true,width:"95%",height:"auto",minHeight:150,maxHeight:350,checkOnSelect:true,selectOnCheck:true,remoteSort:false,sortOrder:"asc",idField:"actionClass",columns:[[{field:"allowed",checkbox:true,width:50,fixed:true},{field:"name",title:$("thead th:nth-child(1)",this.actions).text(),sortable:true,width:"30%"},{field:"description",title:$("thead th:nth-child(2)",this.actions).text(),sortable:false,width:"65%",formatter:$.proxy(this._formatActionDescription,this)}]],loader:$.proxy(this._onLoad$Actions,this),onBeforeSelect:$.proxy(this.isRestrictActions,this),onBeforeCheck:$.proxy(this.isRestrictActions,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._onLoadSuccess$DataGrid,this,this.actions,this.restrictActions),onExpand:$.proxy(this._onExpand$DataGrid,this,this.actions)});var tap=this.actions.datagrid("getPanel");tap.panel("header").click(function(){tap.panel(tap.panel("options").collapsed?"expand":"collapse",true);});initializing=false;},setDomainName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));},getPermissions:function(){return this.permissionsView.getValues();},setPermissions:function(values){this.permissionsView.setValues(values);},isRestrictEvents:function(){return this.restrictEvents.switchbutton("options").checked;},getAllowedEvents:function(){if(!this.isRestrictEvents()){return null;}
var records=this._getSelectedDataGridRecords(this.events);return records.length?records:null;},setAllowedEvents:function(values){this.restrictEvents.switchbutton(values!==null?"check":"uncheck");this._selectDataGridRecords(this.events,values||[]);},isRestrictFunctions:function(){return this.restrictFunctions.switchbutton("options").checked;},getAllowedFunctions:function(){if(!this.isRestrictFunctions()){return null;}
var records=this._getSelectedDataGridRecords(this.functions);return records.length?records:null;},setAllowedFunctions:function(values){this.restrictFunctions.switchbutton(values!==null?"check":"uncheck");this._selectDataGridRecords(this.functions,values||[]);},isRestrictActions:function(){return this.restrictActions.switchbutton("options").checked;},getAllowedActions:function(){if(!this.isRestrictActions()){return null;}
var records=this._getSelectedDataGridRecords(this.actions);return records.length?records:null;},setAllowedActions:function(values){this.restrictActions.switchbutton(values!==null?"check":"uncheck");this._selectDataGridRecords(this.actions,values||[]);},show:function(listener){this._super(listener||jscape.settings.DomainPermissionsDialog.LISTENER);},_onClick$RestrictTriggerEvents:function(){this._disableDataGrid(this.events,!this.isRestrictEvents());},_onClick$RestrictTriggerFunctions:function(){this._disableDataGrid(this.functions,!this.isRestrictFunctions());},_onClick$RestrictTriggerActions:function(){this._disableDataGrid(this.actions,!this.isRestrictActions());},_onLoadSuccess$DataGrid:function(target,enableSwitch,data){$(target).datagrid("getPanel").find("div.datagrid-header-check input:checkbox").prop("disabled",data.rows.length==0);var enableSwitchOpts=$(enableSwitch).switchbutton("options");enableSwitchOpts.onChange(enableSwitchOpts.checked);this._createDataGridTooltips($(target));},_onExpand$DataGrid:function(target){var opts=target.datagrid("options");if(!opts._dataLoaded){target.datagrid("reload",function(){opts._dataLoaded=true;var indexes=$.map(opts._dataChecked,function(data){return target.datagrid("getRowIndex",data);});delete opts._dataChecked;for(var i=0,len=indexes.length;i<len;++i){target.datagrid("selectRow",indexes[i]);}});}},_getSelectedDataGridRecords:function(grid){var opts=grid.datagrid("options");return!opts._dataLoaded?opts._dataChecked:$.map(grid.datagrid("getChecked"),function(row){return row[opts.idField];});},_selectDataGridRecords:function(grid,selections){grid.datagrid("clearSelections");var opts=grid.datagrid("options");if(!opts._dataLoaded){opts._dataChecked=selections;}else{delete opts._dataChecked;for(var i=0,len=selections.length;i<len;++i){grid.datagrid("selectRecord",selections[i]);}}},_disableDataGrid:function(grid,disabled){var p=grid.datagrid("getPanel");if(!disabled){p.children("div.datagrid-mask").remove();}else{if(!p.children("div.datagrid-mask").length){$("<div class=\"datagrid-mask\" style=\"display:block\"></div>").appendTo(p);}}},_createDataGridTooltips:function(grid,context){grid.datagrid("getPanel").find(".easyui-tooltip").on("mouseenter",function(){$(this).tooltip({showEvent:"none",position:"bottom",content:"<div class=\"tooltip-title\"><code>"+$(this).data("tooltip-title")+"</code></div>"+$(this).text(),onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");});},_formatEventDescription:function(value,row){return'<span class="easyui-tooltip" data-tooltip-title="'+String(row.name).escapeXml()+'" title="">'+String(value).escapeXml()+"</span>";},_formatFunctionDescription:function(_,row){return $.map(row.templates,function(value,key){return'<span class="easyui-tooltip" data-tooltip-title="'+String(key).escapeXml()+'" title="">'+String(value).escapeXml()+"</span>";}).join("<br/>");},_formatActionDescription:function(value,row){return'<span class="easyui-tooltip" data-tooltip-title="'+String(row.name).escapeXml()+'" title="">'+String(value).escapeXml()+"</span>";},_onLoad$Events:function(params,success,error){this.listener.onLoadTriggerEvents(params).then(success,error);},_onLoad$Functions:function(params,success,error){this.listener.onLoadTriggerFunctions(params).then(success,error);},_onLoad$Actions:function(params,success,error){this.listener.onLoadTriggerActions(params).then(success,error);}});jscape.settings.DomainPermissionsDialog.LISTENER={onLoadTriggerEvents:$.noop,onLoadTriggerFunctions:$.noop,onLoadTriggerActions:$.noop,onSubmit:$.noop,onCancel:$.noop};jscape.settings.AclTagsController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this._super(true);this.addController=new jscape.settings.AddAclTagController();this.deleteController=new jscape.settings.DeleteAclTagController();this._initValidators();},start:function(){if(this.view==null){this.view=new jscape.settings.AclTagsView();}
this.view.show(this);},resume:function(){this.view.refresh();},onLoadData:function(params){return jscape.API.getAclTags();},hasChanged:function(){return false;},onAddTag:function(){return this.addController.start().done($.proxy(this._tagAdded,this));},onDeleteTag:function(tags){return this.deleteController.start(tags).done($.proxy(this._tagDeleted,this));},_tagAdded:function(tag){this._recordAdded(tag);},_tagDeleted:function(tags){this._recordDeleted(tags);},_initValidators:function(){var v=new jscape.Validator();v.rule("acl_tag_unique",$.proxy(this._tagNotExists,this),window.R.string.ACL_ERROR_TAG_ALREDY_EXISTS);},_tagNotExists:function(value,excludes){return(excludes&&$.inArray(value,excludes)!=-1)||this.view.indexOf(value)==-1;}});jscape.settings.AclTagsView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.fieldset=$("#acl-tags-fields");this.data=$("table[role=grid][aria-label=tags]",this.fieldset);this.data.datagrid({fit:true,remoteSort:false,singleSelect:false,ctrlSelect:true,sortOrder:"asc",idField:"value",columns:[[{field:"value",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"100%"}]],loader:$.proxy(this._onLoad$Data,this),loadFilter:function(data){return $.map($.isArray(data)?data:data.rows,function(val){return{text:String(val).escapeXml(),value:val};});},onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onSortColumn:$.proxy(this._adjustState,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.settings.AclTagsView.LISTENER;this.data.datagrid("resize");this._adjustState();},getTags:function(){return $.map(this.getRecords(),$.proxy(this._valueOf,this));},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onClick$AddButton:function(){this.addButton.linkbutton("disable");this.listener.onAddTag(this).always($.proxy(function(){this.addButton.linkbutton("enable");},this));},_onClick$DeleteButton:function(){this.deleteButton.linkbutton("disable");this.listener.onDeleteTag($.map(this.selection,$.proxy(this._valueOf,this))).always($.proxy(function(){this.deleteButton.linkbutton("enable");},this));},_showContextMenu:function(e){this._super(e,[this.addButton,this.deleteButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.settings.AclTagsView.LISTENER={onLoadData:$.noop,onAddTag:$.noop,onDeleteTag:$.noop};jscape.settings.AddAclTagController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var tagName=dialog.getName();return jscape.API.storeAclTag(tagName).done($.proxy(function(){this.deferred.resolve(tagName);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.settings.AddAclTagDialog();}});jscape.settings.DeleteAclTagController=Class.extend({start:function(tags){return this._confirmDelete(tags).then($.proxy(this._deleteConfirmed,this,tags)).then(function(){return $.Deferred().resolve(tags);},function(){return $.Deferred().reject();});},_confirmDelete:function(tags){return jscape.ConfirmDialog.confirm(window.R.string.ACL_CONFIRM_DELETE_TAG_TITLE,window.R.string.ACL_CONFIRM_DELETE_TAG_MESSAGE.supplant({0:tags.join(", ")}));},_deleteConfirmed:function(tags){return $.when.apply(jQuery,$.map(tags,function(tag){return jscape.API.deleteAclTag(tag);}));}});jscape.settings.AddAclTagDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-setting-acl-addtag"),{width:"40%",minWidth:530,maxWidth:700,minHeight:230});this.title=this.dialog.dialog("header").text()||"";this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["non_empty","acl_tag_unique"],missingMessage:window.R.string.ACL_ERROR_BAD_TAG,invalidMessage:window.R.string.ACL_ERROR_BAD_TAG,width:"60%"});},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value);this.name.textbox("textbox").validatebox("options").validType=["non_empty","acl_tag_unique['"+value+"']"];this.dialog.dialog("setTitle",this.title.supplant({0:value}));},show:function(listener){this._super(listener);this.name.textbox("textbox").focus();}});jscape.settings.CopyManagementRoleController=Class.extend({deferred:null,start:function(roleName){this.sourceName=roleName;this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var targetName=dialog.getName();var editAfterDone=dialog.isEditAfterDone();return jscape.API.copyManagementRole(this.sourceName,targetName).done($.proxy(function(data){this.deferred.resolve(data,editAfterDone);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.settings.CopyManagementRoleDialog();dialog.setName(this.sourceName);dialog.setEditAfterDone(true);return dialog;}});jscape.settings.CopyManagementRoleDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-settings-acl-copyrole"),{width:"40%",minWidth:530,maxWidth:700,minHeight:260});this.title=this.dialog.dialog("header").text();this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["acl_role_nonempty","acl_role_unique"],missingMessage:window.R.string.ACL_ERROR_BAD_ROLE,width:"60%"});this.editAfterDone=$("input[name=editafterdone]:checkbox",this.fieldset);},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));this.name.textbox("setValue",value);},isEditAfterDone:function(){return this.editAfterDone.is(":checked");},setEditAfterDone:function(value){this.editAfterDone.prop("checked",!!value);},show:function(){this._super.apply(this,arguments);this.name.textbox("textbox").select().focus();}});