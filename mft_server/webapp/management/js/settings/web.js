/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.settings=jscape.settings||{};jscape.AS2Configuration=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){this.protocol="AS2";this.enabled=a||false;this.decryptionKeyProvider=b||null;this.receiptSigningKeyProvider=c||null;this.receiptSignatureAlgorithm=d||null;this.secondaryDecryptionKeyProvider=e||null;this.secondaryReceiptSigningKeyProvider=f||null;this.secondaryReceiptSignatureAlgorithm=g||null;this.messageEncryptionRequired=h||false;this.messageSignatureRequired=i||false;this.messageWithoutFilenameAllowed=j||false;this.keepingRawMessageFileRequired=k!==undefined?!!k:true;this.fileOverwritingPolicy=l||jscape.AS2Configuration.FileOverwritingPolicy.PROHIBIT;this.unauthenticatedTransferBinding=m||null;this.uploadDirectory=n||"";this.receiptText=o||"";this.fromAddress=p||"";this.asyncReceiptProxyData=q||null;}});jscape.AS2Configuration.FileOverwritingPolicy={PROHIBIT:"PROHIBIT",OVERWRITE:"OVERWRITE",GENERATE_UNIQUE_NAME:"GENERATE_UNIQUE_NAME",valueOf:function(value){for(var key in this){if(typeof this[key]==="string"&&this[key].toLowerCase()==(value+"").toLowerCase()){return this[key];}}return null;}};jscape.AS2Configuration.fromJSON=function(data){function signatureAlgorithmFor(value){value=jscape.SignatureAlgorithm.valueOf(value);return value?value.hashAlgorithm:null;}
return data?new jscape.AS2Configuration(data.enabled,jscape.ServerKeyProvider.fromJSON(data.decryptionKeyProvider),jscape.ServerKeyProvider.fromJSON(data.receiptSigningKeyProvider),signatureAlgorithmFor(data.receiptSignatureAlgorithm),jscape.ServerKeyProvider.fromJSON(data.secondaryDecryptionKeyProvider),jscape.ServerKeyProvider.fromJSON(data.secondaryReceiptSigningKeyProvider),signatureAlgorithmFor(data.secondaryReceiptSignatureAlgorithm),data.messageEncryptionRequired,data.messageSignatureRequired,data.messageWithoutFilenameAllowed,data.keepingRawMessageFileRequired,jscape.AS2Configuration.FileOverwritingPolicy.valueOf(data.fileOverwritingPolicy),data.unauthenticatedTransferBinding,data.uploadDirectory,data.receiptText,data.fromAddress,jscape.ProxyData.fromJSON(data.asyncReceiptProxyData)):null;};jscape.AS2Configuration.TransferBinding=Class.extend({initialize:function(a,b){this.domain=a||"";this.username=b||"";}});jscape.ProxyData=Class.extend({initialize:function(a,b,c,d,e){this.type=jscape.ProxyData.Type.fromString(a);this.host=b||"";this.port=parseInt(c)||0;this.username=d||null;this.password=e||null;}});jscape.ProxyData.fromJSON=function(data){return data?new jscape.ProxyData(data.type,data.host,data.port,data.username):null;};jscape.ProxyData.Type={HTTP:"HTTP",SOCKS4:"SOCKS4",SOCKS5:"SOCKS5"};jscape.ProxyData.Type.fromString=function(data){var value=jscape.ProxyData.Type[(""+data).toUpperCase()];return!!value&&typeof value!=="function"?value:null;};jscape.SelfRegistrationServiceDescriptor=Class.extend({initialize:function(a,b,c,d){this.showRegistrationLink=a||false;this.useEmailAddressAsLogin=b||false;this.captchaRequired=c||false;this.companyNameRequired=d||false;}});jscape.SelfRegistrationServiceDescriptor.fromJSON=function(data){return data?new jscape.SelfRegistrationServiceDescriptor(data.showRegistrationLink,data.useEmailAddressAsLogin,data.captchaRequired,data.companyNameRequired):null;};jscape.WebConfiguration=Class.extend({DEFAULTS:{sessionTimeout:30*60*1000,lostPasswordEnabled:true,domainVisible:true,includeServerPort:true,sslRenegotiationAllowed:true,autoLoginAllowed:true,theme:"default",backlog:5},initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x){this.httpEnabled=a||false;this.httpAddress=b||"";this.httpPort=parseInt(c)||0;this.httpsEnabled=d||false;this.httpsAddress=e||"";this.httpsPort=parseInt(f)||0;this.keyAlias=g||"";this.fipsModeRequired=!!h||false;this.sessionTimeout=i||this.DEFAULTS.sessionTimeout;this.excludedCiphers=$.isArray(j)&&j.length?j:null;this.lostPasswordEnabled=k!=undefined?!!k:this.DEFAULTS.lostPasswordEnabled;this.redirectHttp=l||false;this.domainVisible=m!=undefined?!!m:this.DEFAULTS.domainVisible;this.domainDropdown=!!n||false;this.defaultDomain=o||"";this.clientCertificateRequired=!!p||false;this.serverName=q||"";this.includeServerPort=r!=undefined?!!r:this.DEFAULTS.includeServerPort;this.sslRenegotiationAllowed=s!=undefined?!!s:this.DEFAULTS.sslRenegotiationAllowed;this.captchaRequired=!!t||false;this.strictTransportSecurity=u||null;this.autoLoginAllowed=v!==undefined?!!v:this.DEFAULTS.autoLoginAllowed;this.theme=w||this.DEFAULTS.theme;this.backlog=parseInt(x)||this.DEFAULTS.backlog;}});jscape.WebConfiguration.configFor=function(plainHost,plainPort,secureHost,securePort){return new jscape.WebConfiguration(false,plainHost,parseInt(plainPort)||80,false,secureHost,parseInt(securePort)||443);};jscape.WebConfiguration.fromJSON=function(data){return data?new jscape.WebConfiguration(data.httpEnabled,data.httpAddress,data.httpPort,data.httpsEnabled,data.httpsAddress,data.httpsPort,data.keyAlias,data.fipsModeRequired,data.sessionTimeout,data.excludedCiphers,data.lostPasswordEnabled,data.redirectHttp,data.domainVisible,data.domainDropdown,data.defaultDomain,data.clientCertificateRequired,data.serverName,data.includeServerPort,data.sslRenegotiationAllowed,data.captchaRequired,jscape.StrictTransportSecurityPolicy.fromJSON(data.strictTransportSecurity),data.autoLoginAllowed,data.theme,data.backlog):null;};jscape.StrictTransportSecurityPolicy=Class.extend({initialize:function(a,b,c){this.maxAgeSeconds=parseInt(a)||0;this.includeSubDomains=!!b||false;this.preload=!!c||false;}});jscape.StrictTransportSecurityPolicy.fromJSON=function(data){return data?new jscape.StrictTransportSecurityPolicy(data.maxAgeSeconds,data.includeSubDomains,data.preload):null;};jscape.DocumentViewerConfiguration=Class.extend({initialize:function(a,b,c,d,e){this.enabled=a||false;this.officeDirectory=b||"";this.swfToolDirectory=c||"";this.outputDirectory=d||"";this.threads=parseInt(e)||10;}});jscape.DocumentViewerConfiguration.fromJSON=function(data){return data?$.extend(new jscape.DocumentViewerConfiguration(),data):null;};jscape.ManagementWebServerConfiguration=Class.extend({DEFAULTS:{httpHost:"127.0.0.1",httpPort:11880,httpsHost:"127.0.0.1",httpsPort:11443,sessionTimeout:30*60*1000,theme:"default",includeServerPort:true},initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){this.httpHost=a||this.DEFAULTS.httpHost;this.httpPort=parseInt(b)||this.DEFAULTS.httpPort;this.httpEnabled=!!c;this.httpsHost=d||this.DEFAULTS.httpsHost;this.httpsPort=parseInt(e)||this.DEFAULTS.httpsPort;this.httpsEnabled=!!f;this.httpsKeyAlias=g||"";this.fipsModeRequired=!!h;this.excludedCiphers=$.isArray(i)&&i.length?i:null;this.clientCertificateRequired=!!j;this.sslRenegotiationAllowed=!!k;this.sessionTimeout=parseInt(l)||this.DEFAULTS.sessionTimeout;this.serverName=m||"";this.includeServerPort=n!=undefined?!!n:this.DEFAULTS.includeServerPort;this.strictTransportSecurity=o||null;this.theme=p||this.DEFAULTS.theme;}});jscape.ManagementWebServerConfiguration.fromJSON=function(data){return data?new jscape.ManagementWebServerConfiguration(data.httpHost,data.httpPort,data.httpEnabled,data.httpsHost,data.httpsPort,data.httpsEnabled,data.httpsKeyAlias,data.fipsModeRequired,data.excludedCiphers,data.clientCertificateRequired,data.sslRenegotiationAllowed,data.sessionTimeout,data.serverName,data.includeServerPort,jscape.StrictTransportSecurityPolicy.fromJSON(data.strictTransportSecurity),data.theme):null;};jscape.settings.WebServiceModule=jscape.settings.SettingsModule.extend({initialize:function(themeLoader){this.themeLoader=themeLoader;},onCreate:function(serverAddresses,serverKeys){this._super.apply(this,arguments);this.webController=new jscape.settings.WebConfigurationController(this.themeLoader);this.restConfigController=new jscape.settings.WebRestConfigurationController(this.themeLoader);this.as2ConfigController=new jscape.settings.AS2ConfigurationController();this.signupController=new jscape.settings.SelfRegistrationController();this.webResourcesController=new jscape.settings.WebResourcesController();this.docViewerController=new jscape.settings.DocumentViewerController();this.webController.onCreate(serverAddresses,serverKeys);this.restConfigController.onCreate(serverAddresses,serverKeys);this.as2ConfigController.onCreate(serverKeys);this.signupController.onCreate();this.webResourcesController.onCreate();this.docViewerController.onCreate();},onStart:function(){this._super();this.webController.onStart(this);this.restConfigController.onStart();this.as2ConfigController.onStart();this.signupController.onStart();this.webResourcesController.onStart();this.docViewerController.onStart();},onPause:function(){this._confirmAndApply($.grep([this.webController,this.restConfigController,this.as2ConfigController,this.signupController,this.webResourcesController,this.docViewerController],function(controller){return controller.hasChanged();}));},onResume:function(){this.webController.onResume();this.restConfigController.onResume();this.as2ConfigController.onResume();this.signupController.onResume();this.webResourcesController.onResume();this.docViewerController.onResume();},onChangeWebConfig:function(config){$(document).triggerHandler("changeWebConfig.webservice",{config:config});}});jscape.settings.WebConfigurationController=Class.extend({DEFAULT_CONFIG:jscape.WebConfiguration.configFor("127.0.0.1",80,"127.0.0.1",443),DEFAULT_HSTS_POLICY:new jscape.StrictTransportSecurityPolicy(365*24*60*60,false,false),config:null,excludedCiphers:null,strictTransportSecurity:null,view:null,initialize:function(themeLoader){this.themeLoader=themeLoader;},onCreate:function(serverAddresses,serverKeys){this.inetAddresses=serverAddresses;this.serverKeys=serverKeys;this.ciphersController=new jscape.settings.SslCiphersController();this.policyController=new jscape.settings.HstsPolicyController();},onStart:function(listener){this.listener=listener||jscape.settings.WebConfigurationController.LISTENER;if(this.view==null){this.view=new jscape.settings.WebConfigurationView();}
this.view.show(this);},onResume:function(){this.view.refresh();},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration());},onReload:function(){return jscape.API.getWebServiceConfiguration().done($.proxy(function(config){this.config=config;},this)).fail($.proxy(function(){this.config=this.DEFAULT_CONFIG;},this)).always($.proxy(function(){this.excludedCiphers=this._copyCiphers(this.config);this.strictTransportSecurity=this._copyHstsSettings(this.config);this._setupView(this.config);},this));},onApply:function(){return this._saveConfig(this._createConfiguration()).done($.proxy(function(config){this.config=config;this._fireApplySuccess();this.listener.onChangeWebConfig();},this));},onDiscard:function(){return this.onReload();},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onSslCiphers:function(){return this.ciphersController.start(this.excludedCiphers||[]).done($.proxy(function(ciphers){this.excludedCiphers=ciphers.length?ciphers:null;},this));},onHstsSettings:function(){var policy=this.strictTransportSecurity;return this.policyController.start(policy).done($.proxy(function(policy){this.strictTransportSecurity=policy;},this))},onChangeTheme:function(){var c=new jscape.themes.WebThemeConfigurationController(this.themeLoader,this.view.container());return c.start(this.view.getTheme()).done($.proxy(function(theme){this.view.setTheme(theme);},this));},_saveConfig:function(config){return jscape.API.setWebServiceConfiguration(config).fail(function(jqXhr){if(jscape.API.invalidParametersResponse(jqXhr)){jscape.API.getWebServiceConfiguration();}});},_createConfiguration:function(){var hstsPolicy=this.view.isHstsEnabled()?this.strictTransportSecurity==null?this.DEFAULT_HSTS_POLICY:this.strictTransportSecurity:null;return new jscape.WebConfiguration(this.view.isHttpEnabled(),this.view.getHttpHost(),this.view.getHttpPort(),this.view.isHttpsEnabled(),this.view.getHttpsHost(),this.view.getHttpsPort(),this.view.getHttpsKey(),this.view.isFipsRequired(),this.view.getSessionTimeout(),this.excludedCiphers,this.view.isShowLostPasswordLink(),this.view.isRedirectHttp(),!this.view.isHideDomain(),this.view.isSelectDomain(),this.view.getDefaultDomain(),this.view.isClientCertificateRequired(),this.view.getServerName(),this.view.isIncludeServerPort(),this.view.isSslRenegotiationAllowed(),this.view.isCaptchaRequired(),hstsPolicy,this.view.isAutoLoginAllowed(),this.view.getTheme(),this.view.getBacklog());},_copyCiphers:function(config){return config&&config.excludedCiphers?[].concat(config.excludedCiphers):null;},_copyHstsSettings:function(config){return config&&config.strictTransportSecurity?$.extend({},config.strictTransportSecurity):null;},_setupView:function(config){var serverKeyAliases=$.map(this.serverKeys,function(key){return key.name;});if(this.view&&config){this.view.setHttpEnabled(config.httpEnabled);this.view.setHttpHosts(this.inetAddresses);this.view.setHttpsHosts(this.inetAddresses);this.view.setHttpHost(config.httpAddress);this.view.setHttpPort(config.httpPort);this.view.setHttpsEnabled(config.httpsEnabled);this.view.setHttpsHost(config.httpsAddress);this.view.setHttpsPort(config.httpsPort);this.view.setHttpsKeys(serverKeyAliases);this.view.setHttpsKey(config.keyAlias);this.view.setFipsRequired(config.fipsModeRequired);this.view.setClientCertificateRequired(config.clientCertificateRequired);this.view.setSslRenegotiationAllowed(config.sslRenegotiationAllowed);this.view.setServerName(config.serverName);this.view.setSessionTimeout(config.sessionTimeout);this.view.setIncludeServerPort(config.includeServerPort);this.view.setRedirectHttp(config.redirectHttp);this.view.setDefaultDomain(config.defaultDomain);this.view.setHideDomain(!config.domainVisible);this.view.setSelectDomain(config.domainDropdown);this.view.setShowLostPasswordLink(config.lostPasswordEnabled);this.view.setCaptchaRequired(config.captchaRequired);this.view.setHstsEnabled(config.strictTransportSecurity!=null);this.view.setAutoLoginAllowed(config.autoLoginAllowed);this.view.setTheme(config.theme);this.view.setBacklog(config.backlog);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.WebConfigurationController.LISTENER={onChangeWebConfig:$.noop};jscape.settings.WebConfigurationView=jscape.ui.FormView.extend({TIME_FACTOR:60*1000,DEFAULT_SESSION_TIMEOUT:30,DEFAULT_BACKLOG:5,initialize:function(){this.fieldset=$("#web-config-fields").layout({fit:true,doSize:false,border:false});this.httpEnabled=$("input[name=bindplain]",this.fieldset).change($.proxy(this._onChange$HttpEnabled,this));this.httpHost=$("select[name=plainhost]",this.fieldset).combobox({required:true,onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.WEB_SERVICE_ERROR_BAD_HOST,width:170,panelWidth:"auto",panelHeight:"auto"});this.httpPort=$("input[name=plainport]",this.fieldset).numberspinner({required:true,disabled:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:80});this.httpsEnabled=$("input[name=bindsecure]",this.fieldset).change($.proxy(this._onChange$HttpsEnabled,this));this.httpsHost=$("select[name=securehost]",this.fieldset).combobox({required:true,missingMessage:window.R.string.WEB_SERVICE_ERROR_BAD_HOST,onChange:$.proxy(this._onForm$Change,this),width:170,panelWidth:"auto",panelHeight:"auto"});this.httpsPort=$("input[name=secureport]",this.fieldset).numberspinner({required:true,disabled:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:80});this.privateKey=$("select[name=privatekey]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onForm$Change,this),width:"15%",panelHeight:"auto"});this.theme=$("input[name=theme]",this.fieldset).textbox({required:false,editable:false,readonly:true,onChange:$.proxy(this._onForm$Change,this),width:"15%",minWidth:200});this.theme.textbox("textbox").click($.proxy(function(){this.changeThemeButton.click();},this));this.changeThemeButton=$("a[role=button][name=changetheme]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ChangeThemeButton,this)});this.clientCertificateRequired=$("input[name=certrequired]",this.fieldset).change($.proxy(this._onForm$Change,this));this.sslRenegotiation=$("input[name=renegotiationallowed]",this.fieldset).change($.proxy(this._onForm$Change,this));this.fipsRequired=$("input[name=fipsrequired]",this.fieldset).change($.proxy(this._onForm$Change,this));this.sslCiphersButton=$("a[role=button][name=sslciphers]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$SslCiphersButton,this)});this.serverName=$("input[name=servername]",this.fieldset).textbox({onChange:$.proxy(function(){this._onChange$ServerName();this._onForm$Change();},this),width:"35%"});this.serverName.textbox("textbox").on("input",$.proxy(this._onChange$ServerName,this));this.sessionTtl=$("input[name=sessionttl]",this.fieldset).numberspinner({required:true,min:1,max:999,value:this.DEFAULT_SESSION_TIMEOUT,onChange:$.proxy(this._onForm$Change,this),width:80});this.backlog=$("input[name=backlog]",this.fieldset).numberspinner({required:true,min:1,max:999,value:this.DEFAULT_BACKLOG,onChange:$.proxy(this._onForm$Change,this),width:80});this.redirectHttp=$("input[name=redirecthttp]",this.fieldset);this.includeServerPort=$("input[name=includeserverport]",this.fieldset);this.hstsEnabled=$("input[name=enablehsts]",this.fieldset).change($.proxy(this._onChange$HstsEnabled,this));this.hstsSettingsButton=$("a[role=button][name=hstssettings]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$HstsButton,this)});this.defaultDomain=$("input[name=defaultdomain]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),width:"35%"});this.hideDomain=$("input[name=hidedomain]",this.fieldset).change($.proxy(this._onChange$HideDomain,this));this.selectDomain=$("input[name=selectdomain]",this.fieldset);this.lostPasswordLink=$("input[name=showlostpwdlink]",this.fieldset);this.capthaRequired=$("input[name=logincaptcha]",this.fieldset);this.autoLoginAllowed=$("input[name=autologin]",this.fieldset);this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._adjustButtonsBarLayout(this.fieldset);this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.WebConfigurationView.LISTENER;this.fieldset.layout("resize");this.httpEnabled.change();this.httpsEnabled.change();this.hideDomain.change();this.hstsEnabled.change();this._onChange$ServerName();},refresh:function(){this.listener.onReload();},container:function(){return this.fieldset;},isHttpEnabled:function(){return this.httpEnabled.is(":checked");},setHttpEnabled:function(value){this.httpEnabled.prop("checked",!!value).change();},getHttpHost:function(){return this.httpHost.combobox("getValue")||this.httpHost.combobox("getText");},setHttpHost:function(value){this.httpHost.combobox("setValue",value);},setHttpHosts:function(values){this.httpHost.combobox("loadData",$.map(values,$.proxy(function(value){return{text:this._formatHostname(value),value:value};},this)));},getHttpPort:function(){return parseInt(this.httpPort.numberspinner("getValue"));},setHttpPort:function(value){this.httpPort.numberspinner("setValue",parseInt(value));},isHttpsEnabled:function(){return this.httpsEnabled.is(":checked");},setHttpsEnabled:function(value){this.httpsEnabled.prop("checked",!!value).change();},getHttpsHost:function(){return this.httpsHost.combobox("getValue")||this.httpsHost.combobox("getText");},setHttpsHost:function(value){this.httpsHost.combobox("setValue",value);},setHttpsHosts:function(values){this.httpsHost.combobox("loadData",$.map(values,$.proxy(function(value){return{text:this._formatHostname(value),value:value};},this)));},getHttpsPort:function(){return parseInt(this.httpsPort.numberspinner("getValue"));},setHttpsPort:function(value){this.httpsPort.numberspinner("setValue",parseInt(value));},getHttpsKey:function(){return this.privateKey.combobox("getValue");},setHttpsKey:function(value){this.privateKey.combobox("clear").combobox("select",value);},setHttpsKeys:function(values){this.privateKey.combobox("loadData",values);},isFipsRequired:function(){return this.fipsRequired.is(":checked");},setFipsRequired:function(value){this.fipsRequired.prop("checked",!!value);},getTheme:function(){return this.theme.textbox("getValue");},setTheme:function(value){this.theme.textbox("setValue",value);},isClientCertificateRequired:function(){return this.clientCertificateRequired.is(":checked");},setClientCertificateRequired:function(value){this.clientCertificateRequired.prop("checked",!!value);},isSslRenegotiationAllowed:function(){return this.sslRenegotiation.is(":checked");},setSslRenegotiationAllowed:function(value){this.sslRenegotiation.prop("checked",!!value);},getServerName:function(){return this.serverName.textbox("getValue").trim();},setServerName:function(value){this.serverName.textbox("setValue",value);},getSessionTimeout:function(){return parseInt(this.sessionTtl.numberspinner("getValue"))*this.TIME_FACTOR;},setSessionTimeout:function(value){this.sessionTtl.numberspinner("setValue",parseInt(value)/this.TIME_FACTOR).numberspinner("validate");},getBacklog:function(){return parseInt(this.backlog.numberspinner("getValue"));},setBacklog:function(value){this.backlog.numberspinner("setValue",parseInt(value));},isRedirectHttp:function(){return this.redirectHttp.is(":checked:not(:disabled)");},setRedirectHttp:function(value){this.redirectHttp.prop("checked",value);},isIncludeServerPort:function(){return this.includeServerPort.is(":checked");},setIncludeServerPort:function(value){this.includeServerPort.prop("checked",value);},getDefaultDomain:function(){return this.defaultDomain.textbox("getValue");},setDefaultDomain:function(value){this.defaultDomain.textbox("setValue",value);},isHideDomain:function(){return this.hideDomain.is(":checked");},setHideDomain:function(value){this.hideDomain.prop("checked",!!value).change();},isSelectDomain:function(){return this.selectDomain.is(":checked");},setSelectDomain:function(value){this.selectDomain.prop("checked",!!value).change();},isShowLostPasswordLink:function(){return this.lostPasswordLink.is(":checked");},setShowLostPasswordLink:function(value){this.lostPasswordLink.prop("checked",!!value).change();},isCaptchaRequired:function(){return this.capthaRequired.is(":checked");},setCaptchaRequired:function(value){this.capthaRequired.prop("checked",!!value).change();},isAutoLoginAllowed:function(){return this.autoLoginAllowed.is(":checked");},setAutoLoginAllowed:function(value){this.autoLoginAllowed.prop("checked",!!value).change();},isHstsEnabled:function(){return this.hstsEnabled.is(":checked");},setHstsEnabled:function(value){this.hstsEnabled.prop("checked",!!value).change();},_formatHostname:function(value){return jscape.ServerParameters.allHostsIpv4(value)?window.R.string.APPLICATION_HOST_ALL_IPV4:jscape.ServerParameters.allHostsIpv6(value)?window.R.string.APPLICATION_HOST_ALL_IPV6:value;},_onClick$SslCiphersButton:function(){this.sslCiphersButton.linkbutton("disable");this.listener.onSslCiphers().done($.proxy(this._onForm$Change,this)).always($.proxy(function(){this.sslCiphersButton.linkbutton("enable");},this));},_onClick$HstsButton:function(){this.hstsSettingsButton.linkbutton("disable");this.listener.onHstsSettings().done($.proxy(this._onForm$Change,this)).always($.proxy(function(){this.hstsSettingsButton.linkbutton("enable");},this));},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onClick$ChangeThemeButton:function(){this.changeThemeButton.linkbutton("disable");this.listener.onChangeTheme().always($.proxy(function(){this.changeThemeButton.linkbutton("enable");},this));},_onChange$HttpEnabled:function(){var enabled=this.isHttpEnabled();this.httpHost.combobox(enabled?"enable":"disable");this.httpPort.numberspinner(enabled?"enable":"disable");},_onChange$HttpsEnabled:function(){var enabled=this.isHttpsEnabled();this.httpsHost.combobox(enabled?"enable":"disable");this.httpsPort.numberspinner(enabled?"enable":"disable");},_onChange$ServerName:function(){var name=this.serverName.textbox("textbox").val().trim();this.includeServerPort.prop("disabled",name.length==0);},_onChange$HstsEnabled:function(){var enabled=this.hstsEnabled.is(":checked");this.hstsSettingsButton.linkbutton(enabled?"enable":"disable");},_onChange$HideDomain:function(){var checked=this.hideDomain.is(":checked");this.selectDomain.prop("disabled",checked);this.defaultDomain.textbox("textbox").validatebox("options").required=checked;this.defaultDomain.textbox("isValid");},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.settings.WebConfigurationView.LISTENER={onChange:$.noop,onChangeTheme:$.noop,onSslCiphers:$.noop,onHstsSettings:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.HstsPolicyController=Class.extend({DEFAULT_POLICY:new jscape.StrictTransportSecurityPolicy(365*24*60*60,false,false),deferred:null,start:function(policy){this.deferred=$.Deferred();this._setupDialog(policy).show(this);return this.deferred.promise();},onSubmit:function(dialog){var policy=this._createPolicy(dialog);dialog.destroy();this.deferred.resolve(policy);this.deferred=null;},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createPolicy:function(dialog){return new jscape.StrictTransportSecurityPolicy(dialog.getMaxAgeSeconds(),dialog.isIncludeSubDomains(),dialog.isPreload());},_setupDialog:function(policy){policy=policy?policy:this.DEFAULT_POLICY;var dialog=new jscape.settings.HstsPolicyDialog();dialog.setMaxAgeSeconds(policy.maxAgeSeconds);dialog.setIncludeSubDomains(policy.includeSubDomains);dialog.setPreload(policy.preload);return dialog;}});jscape.settings.HstsPolicyDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-ssweb-hsts"),{width:550});this.fieldset=$("fieldset[name=policyfields]",this.dialog);this.maxAgeSeconds=$("input[name=maxage]",this.fieldset).numberspinner({required:true,min:0,max:365*24*60*60,width:120});this.includeSubDomains=$("input[name=includesubdomains]:checkbox",this.fieldset);this.preload=$("input[name=preload]:checkbox",this.fieldset);},getMaxAgeSeconds:function(){return parseInt(this.maxAgeSeconds.numberspinner("getValue"));},setMaxAgeSeconds:function(value){this.maxAgeSeconds.numberspinner("setValue",parseInt(value)).numberspinner("validate");},isIncludeSubDomains:function(){return this.includeSubDomains.is(":checked");},setIncludeSubDomains:function(value){this.includeSubDomains.prop("checked",!!value);},isPreload:function(){return this.preload.is(":checked");},setPreload:function(value){this.preload.prop("checked",!!value);}});jscape.settings.WebRestConfigurationController=Class.extend({DEFAULT_CONFIG:new jscape.ManagementWebServerConfiguration("127.0.0.1",11880,false,"127.0.0.1",11443,false),DEFAULT_HSTS_POLICY:new jscape.StrictTransportSecurityPolicy(365*24*60*60,false,false),config:null,excludedCiphers:null,strictTransportSecurity:null,view:null,initialize:function(themeLoader){this.themeLoader=themeLoader;},onCreate:function(serverAddresses,serverKeys){this.inetAddresses=serverAddresses;this.serverKeys=serverKeys;this.sslCiphersController=new jscape.settings.SslCiphersController();this.policyController=new jscape.settings.HstsPolicyController();},onStart:function(){if(this.view==null){this.view=new jscape.settings.WebRestConfigurationView();}
this.view.show(this);},onResume:function(){jscape.API.getManagementWebServerConfiguration().done($.proxy(function(config){this.config=config;},this)).fail($.proxy(function(){this.config=this.DEFAULT_CONFIG;},this)).always($.proxy(function(){this.excludedCiphers=this._copyCiphers(this.config.excludedCiphers);this.strictTransportSecurity=this._copyHstsSettings(this.config);this.view&&this._setupView(this.config);},this));},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration());},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise().done($.proxy(function(modified){this.view.showRestartRequiredMessage(modified);},this));},onApply:function(){var config=this._createConfiguration();return this._confirmServerRestart().then($.proxy(function(){return jscape.API.setManagementWebServerConfiguration(config);},this)).then($.proxy(function(){var deferred=$.Deferred();this._waitUntilServerRestart(config,deferred,1000);return deferred;},this)).done($.proxy(function(){this.config=config;},this)).done($.proxy(this._redirect,this,config));},onDiscard:function(){this.excludedCiphers=this._copyCiphers(this.config.excludedCiphers);this.strictTransportSecurity=this._copyHstsSettings(this.config);this._setupView(this.config);},onSslCiphers:function(){return this.sslCiphersController.start(this.excludedCiphers||[]).done($.proxy(function(ciphers){this.excludedCiphers=ciphers.length?ciphers:null;},this));},onHstsSettings:function(){var policy=this.strictTransportSecurity;return this.policyController.start(policy).done($.proxy(function(policy){this.strictTransportSecurity=policy;},this))},onChangeTheme:function(){var c=new jscape.themes.WebThemeConfigurationController(this.themeLoader,this.view.container());return c.start(this.view.getTheme()).done($.proxy(function(theme){this.view.setTheme(theme);},this));},_copyCiphers:function(ciphers){return ciphers?[].concat(ciphers):null;},_copyHstsSettings:function(config){return config&&config.strictTransportSecurity?$.extend({},config.strictTransportSecurity):null;},_createConfiguration:function(){var hstsPolicy=this.view.isHstsEnabled()?this.strictTransportSecurity==null?this.DEFAULT_HSTS_POLICY:this.strictTransportSecurity:null;return new jscape.ManagementWebServerConfiguration(this.view.getHttpHost(),this.view.getHttpPort(),this.view.isHttpEnabled(),this.view.getHttpsHost(),this.view.getHttpsPort(),this.view.isHttpsEnabled(),this.view.getHttpsKey(),this.view.isFipsRequired(),this.excludedCiphers,this.view.isClientCertificateRequired(),this.view.isSslRenegotiationAllowed(),this.view.getSessionTimeout(),this.view.getServerName(),this.view.isIncludeServerPort(),hstsPolicy,this.view.getTheme());},_setupView:function(config){var serverKeyAliases=$.map(this.serverKeys,function(key){return key.name;});if(config){this.view.setHttpHosts(this.inetAddresses);this.view.setHttpHost(config.httpHost);this.view.setHttpPort(config.httpPort);this.view.setHttpEnabled(config.httpEnabled);this.view.setHttpsHosts(this.inetAddresses);this.view.setHttpsHost(config.httpsHost);this.view.setHttpsPort(config.httpsPort);this.view.setHttpsEnabled(config.httpsEnabled);this.view.setHttpsKeys(serverKeyAliases);this.view.setHttpsKey(config.httpsKeyAlias);this.view.setFipsRequired(config.fipsModeRequired);this.view.setClientCertificateRequired(config.clientCertificateRequired);this.view.setSslRenegotiationAllowed(config.sslRenegotiationAllowed);this.view.setSessionTimeout(config.sessionTimeout);this.view.setServerName(config.serverName);this.view.setIncludeServerPort(config.includeServerPort);this.view.setHstsEnabled(config.strictTransportSecurity!=null);this.view.setTheme(config.theme);}},_waitUntilServerRestart:function(config,deferred,delay){setTimeout($.proxy(function(){jscape.API.testManagementWebServerConfiguration().done($.proxy(function(newConfig){if(!Object._equals(config,newConfig)){this._waitUntilServerRestart(config,deferred,delay*2);}else{deferred.resolve();}},this)).fail($.proxy(function(jqXhr){if(jqXhr.status==0&&!this._bindingChanged(this.config,config)){this._waitUntilServerRestart(config,deferred,delay*2);}else{deferred.resolve();}},this));},this),delay);},_bindingChanged:function(o1,o2){return this._secureConnection(o1)?o1.httpsEnabled!=o2.httpsEnabled||o1.httpsHost!=o2.httpsHost||o1.httpsPort!=o2.httpsPort:o1.httpEnabled!=o2.httpEnabled||o1.httpHost!=o2.httpHost||o1.httpPort!=o2.httpPort;},_secureConnection:function(config){return/^https/i.test(window.location.protocol)&&config.httpsEnabled;},_redirect:function(config){var secure=this._secureConnection(config);var host=secure?config.httpsHost:config.httpHost;if(jscape.ServerParameters.allAddress(host)){window.location="//"+window.location.host;}else{var port=secure?config.httpsPort:config.httpPort;window.location="//"+host+((!secure&&port==80)||(secure&&port==443)?"":":"+port);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);},_confirmServerRestart:function(){return jscape.ConfirmDialog.confirm(window.R.string.WEB_SERVICE_CONFIRM_RESTART_TITLE,window.R.string.WEB_SERVICE_CONFIRM_RESTART_MESSAGE,false);}});jscape.settings.WebRestConfigurationView=jscape.ui.FormView.extend({TIME_FACTOR:60*1000,initialize:function(){this.fieldset=$("#rest-config-fields").layout({fit:true,doSize:false,border:false});this.httpEnabled=$("input[name=bindplain]",this.fieldset).change($.proxy(this._onChange$HttpEnabled,this));this.httpHost=$("select[name=plainhost]",this.fieldset).combobox({required:true,onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.WEB_SERVICE_ERROR_BAD_HOST,width:170,panelWidth:"auto",panelHeight:"auto"});this.httpPort=$("input[name=plainport]",this.fieldset).numberspinner({required:true,disabled:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:80});this.httpsEnabled=$("input[name=bindsecure]",this.fieldset).change($.proxy(this._onChange$HttpsEnabled,this));this.httpsHost=$("select[name=securehost]",this.fieldset).combobox({required:true,onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.WEB_SERVICE_ERROR_BAD_HOST,width:170,panelWidth:"auto",panelHeight:"auto"});this.httpsPort=$("input[name=secureport]",this.fieldset).numberspinner({required:true,disabled:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:80});this.privateKey=$("select[name=privatekey]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onForm$Change,this),width:"15%",panelHeight:"auto"});this.theme=$("input[name=theme]",this.fieldset).textbox({required:false,editable:false,readonly:true,onChange:$.proxy(this._onForm$Change,this),width:"15%",minWidth:200});this.theme.textbox("textbox").click($.proxy(function(){this.changeThemeButton.click();},this));this.changeThemeButton=$("a[role=button][name=changetheme]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ChangeThemeButton,this)});this.fipsRequired=$("input[name=fipsrequired]",this.fieldset);this.clientCertificateRequired=$("input[name=certrequired]",this.fieldset);this.sslRenegotiation=$("input[name=renegotiationallowed]",this.fieldset);this.sslCiphersButton=$("a[role=button][name=sslciphers]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$SslCiphersButton,this)});this.serverName=$("input[name=servername]",this.fieldset).textbox({onChange:$.proxy(function(){this._onChange$ServerName();this._onForm$Change();},this),width:"35%"});this.serverName.textbox("textbox").on("input",$.proxy(this._onChange$ServerName,this));this.includeServerPort=$("input[name=includeserverport]",this.fieldset);this.ttl=$("input[name=ttl]",this.fieldset).numberspinner({required:true,min:1,max:999,onChange:$.proxy(this._onForm$Change,this),width:80});this.hstsEnabled=$("input[name=enablehsts]",this.fieldset).change($.proxy(this._onChange$HstsEnabled,this));this.hstsSettingsButton=$("a[role=button][name=hstssettings]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$HstsButton,this)});this.note=this.fieldset.find(".warning").hide();this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._adjustButtonsBarLayout(this.fieldset);this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.WebRestConfigurationView.LISTENER;this.fieldset.layout("resize");this.httpEnabled.change();this.httpsEnabled.change();this._onChange$ServerName();},container:function(){return this.fieldset;},isHttpEnabled:function(){return this.httpEnabled.is(":checked");},setHttpEnabled:function(value){this.httpEnabled.prop("checked",!!value).change();},getHttpHost:function(){return this.httpHost.combobox("getValue")||this.httpHost.combobox("getText");},setHttpHost:function(value){this.httpHost.combobox("setValue",value);},setHttpHosts:function(values){this.httpHost.combobox("loadData",$.map(values,$.proxy(function(value){return{text:this._formatHostname(value),value:value};},this)));},getHttpPort:function(){return parseInt(this.httpPort.numberspinner("getValue"));},setHttpPort:function(value){this.httpPort.numberspinner("setValue",parseInt(value));},isHttpsEnabled:function(){return this.httpsEnabled.is(":checked");},setHttpsEnabled:function(value){this.httpsEnabled.prop("checked",!!value).change();},getHttpsHost:function(){return this.httpsHost.combobox("getValue")||this.httpsHost.combobox("getText");},setHttpsHost:function(value){this.httpsHost.combobox("setValue",value);},setHttpsHosts:function(values){this.httpsHost.combobox("loadData",$.map(values,$.proxy(function(value){return{text:this._formatHostname(value),value:value};},this)));},getHttpsPort:function(){return parseInt(this.httpsPort.numberspinner("getValue"));},setHttpsPort:function(value){this.httpsPort.numberspinner("setValue",parseInt(value));},getHttpsKey:function(){return this.privateKey.combobox("getValue");},setHttpsKey:function(value){this.privateKey.combobox("clear").combobox("select",value);},setHttpsKeys:function(values){this.privateKey.combobox("loadData",values);},getTheme:function(){return this.theme.textbox("getValue");},setTheme:function(value){this.theme.textbox("setValue",value);},isFipsRequired:function(){return this.fipsRequired.is(":checked");},setFipsRequired:function(value){this.fipsRequired.prop("checked",!!value);},isClientCertificateRequired:function(){return this.clientCertificateRequired.is(":checked");},setClientCertificateRequired:function(value){this.clientCertificateRequired.prop("checked",!!value);},isSslRenegotiationAllowed:function(){return this.sslRenegotiation.is(":checked");},setSslRenegotiationAllowed:function(value){this.sslRenegotiation.prop("checked",!!value);},getSessionTimeout:function(){return parseInt(this.ttl.numberspinner("getValue"))*this.TIME_FACTOR;},setSessionTimeout:function(value){this.ttl.numberspinner("setValue",parseInt(value)/this.TIME_FACTOR).numberspinner("validate");},getServerName:function(){return this.serverName.textbox("getValue").trim();},setServerName:function(value){this.serverName.textbox("setValue",value);},isIncludeServerPort:function(){return this.includeServerPort.is(":checked");},setIncludeServerPort:function(value){this.includeServerPort.prop("checked",value);},isHstsEnabled:function(){return this.hstsEnabled.is(":checked");},setHstsEnabled:function(value){this.hstsEnabled.prop("checked",!!value).change();},showRestartRequiredMessage:function(required){if(!!required){this.note.text(window.R.string.WEB_SERVICE_WARNING_RESTART_REQUIRED).show();}else{this.note.text("").hide();}},_formatHostname:function(value){return jscape.ServerParameters.allHostsIpv4(value)?window.R.string.APPLICATION_HOST_ALL_IPV4:jscape.ServerParameters.allHostsIpv6(value)?window.R.string.APPLICATION_HOST_ALL_IPV6:value;},_onChange$ServerName:function(){var name=this.serverName.textbox("textbox").val().trim();this.includeServerPort.prop("disabled",name.length==0);},_onClick$SslCiphersButton:function(){this.sslCiphersButton.linkbutton("disable");this.listener.onSslCiphers().done($.proxy(this._onForm$Change,this)).always($.proxy(function(){this.sslCiphersButton.linkbutton("enable");},this));},_onChange$HttpEnabled:function(){var enabled=this.isHttpEnabled();this.httpHost.combobox(enabled?"enable":"disable");this.httpPort.numberspinner(enabled?"enable":"disable");},_onChange$HttpsEnabled:function(){var enabled=this.isHttpsEnabled();this.httpsHost.combobox(enabled?"enable":"disable");this.httpsPort.numberspinner(enabled?"enable":"disable");},_onChange$HstsEnabled:function(){var enabled=this.hstsEnabled.is(":checked");this.hstsSettingsButton.linkbutton(enabled?"enable":"disable");},_onClick$HstsButton:function(){this.hstsSettingsButton.linkbutton("disable");this.listener.onHstsSettings().done($.proxy(this._onForm$Change,this)).always($.proxy(function(){this.hstsSettingsButton.linkbutton("enable");},this));},_onClick$ChangeThemeButton:function(){this.changeThemeButton.linkbutton("disable");this.listener.onChangeTheme().always($.proxy(function(){this.changeThemeButton.linkbutton("enable");},this));},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.settings.WebRestConfigurationView.LISTENER={onChange:$.noop,onChangeTheme:$.noop,onSslCiphers:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.SslCiphersController=Class.extend({deferred:null,ciphers:null,start:function(excludedCiphers){this.deferred=$.Deferred();this._setupDialog(excludedCiphers).show(this);return this.deferred.promise();},onSelectMedium:function(dialog){dialog.setCiphers(jscape.ServerParameters.mediumCiphers());},onSelectStrong:function(dialog){dialog.setCiphers(jscape.ServerParameters.strongCiphers());},onSubmit:function(dialog){var excludedCiphers=this._mergeCiphers(dialog.getCiphers(),true);dialog.destroy();this.deferred.resolve(excludedCiphers);this.deferred=null;},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(excludedCiphers){var dialog=new jscape.settings.SslCiphersDialog();if(this.ciphers==null){jscape.API.getServerParameters().done($.proxy(function(params){this.ciphers=params.sslCiphers;dialog.setSslCiphers(params.sslCiphers);dialog.setCiphers(this._mergeCiphers(excludedCiphers,true));},this)).fail($.proxy(function(){this.ciphers=null;},this));}else{dialog.setSslCiphers(this.ciphers);dialog.setCiphers(this._mergeCiphers(excludedCiphers,true));}
return dialog;},_mergeCiphers:function(ciphers,exclude){return $.grep(this.ciphers,function(cipher){return $.inArray(cipher,ciphers)!=-1;},exclude);}});jscape.settings.SslCiphersDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-settings-web-ciphers"),{minWidth:630,width:"50%",maxWidth:"70%",height:"70%"});this.fieldset=this.dialog.find(".content").first().layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=sslciphers]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,showHeader:false,remoteSort:false,singleSelect:false,selectOnCheck:true,checkOnSelect:true,toolbar:"#{id} div.viewpane-toolbar".supplant({id:this.getId()}),onLoadSuccess:$.proxy(this._adjustButtonsState,this),idField:"value",columns:[[{field:"value",checkbox:true},{field:"text",sortable:true}]]});this.data.filter(".datagrid-body td").css("border","transparent");this.selectAllButton=$("a[role=button][name=all]",this.fieldset).linkbutton({toggle:true,onClick:$.proxy(this._onClick$SelectAllButton,this)});this.selectMediumButton=$("a[role=button][name=medium]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$SelectMediumButton,this)});this.selectStrongButton=$("a[role=button][name=strong]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$SelectStrongButton,this)});this.fieldset.layout("panel","center").panel("resize");},show:function(listener){this._super(listener||jscape.settings.SslCiphersDialog.LISTENER);this.fieldset.layout("resize");},getCiphers:function(){return $.map(this.data.datagrid("getChecked"),function(row){return row.value;});},setCiphers:function(values){if(values&&values.length){this.data.datagrid("unselectAll");for(var i=0;i<values.length;i++){this.data.datagrid("selectRecord",values[i]);}}else{this.data.datagrid("clearChecked");}},setSslCiphers:function(values){this.data.datagrid("loadData",$.map(values,function(value){return{text:value,value:value};}));},_onClick$SelectAllButton:function(){var text=this.selectAllButton.text();this.selectAllButton.html(this.selectAllButton.html().replace(text,this.selectAllButton.data("toggle-text")));this.selectAllButton.data("toggle-text",text);if(this.selectAllButton.linkbutton("options").selected){this.data.datagrid("selectAll");}else{this.data.datagrid("unselectAll");}},_onClick$SelectMediumButton:function(){this.listener.onSelectMedium(this);},_onClick$SelectStrongButton:function(){this.listener.onSelectStrong(this);},_adjustButtonsState:function(){var enabled=this.data.datagrid("getData").length!=0;this.selectAllButton.linkbutton(enabled?"enable":"disable");this.selectMediumButton.linkbutton(enabled?"enable":"disable");this.selectStrongButton.linkbutton(enabled?"enable":"disable");}});jscape.settings.SslCiphersDialog.LISTENER={onSelectMedium:$.noop,onSelectStrong:$.noop,onSubmit:$.noop,onCancel:$.noop};jscape.settings.AS2ConfigurationController=Class.extend({DEFAULT_CONFIG:new jscape.AS2Configuration(false,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,"/as2"),config:null,view:null,initialize:function(){this._initValidators();},onCreate:function(serverKeys){this.serverKeys=serverKeys;},onStart:function(){if(this.view==null){this.view=new jscape.settings.AS2ConfigurationView();$(document).off(".webservice").on("changeWebConfig.webservice",$.proxy(function(){this.onResume();},this));}
this.view.show(this);},onResume:function(){jscape.API.getAs2ServiceConfiguration().done($.proxy(function(config){this.config=config;},this)).fail($.proxy(function(){this.config=this.DEFAULT_CONFIG;},this)).always($.proxy(function(){this.view&&this._setupView(this.config);},this));},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration());},onApply:function(){return jscape.API.setAs2ServiceConfiguration(this._createConfiguration()).done($.proxy(function(config){this.config=config;},this)).done($.proxy(function(){this._fireApplySuccess();this._setupView(this.config);},this));},onDiscard:function(){this._setupView(this.config);},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onChangePrimaryReceiptSigningKey:function(keyAlias){if(keyAlias!=null){var algorithms=this._receiptSignatureAlgorithmsFor(keyAlias);this.view.setPrimaryReceiptSignatureAlgorithms($.map(algorithms,function(entry){return entry.hashAlgorithm;}));}},onChangeSecondaryReceiptSigningKey:function(keyAlias){if(keyAlias!=null){var algorithms=this._receiptSignatureAlgorithmsFor(keyAlias);this.view.setSecondaryReceiptSignatureAlgorithms($.map(algorithms,function(entry){return entry.hashAlgorithm;}));}},onChangeBindTransfersDomain:function(domainName){jscape.API.getAccountNames(domainName).done($.proxy(function(names){this.view.setAvailableUsers(names);},this));},onCopyServiceUrl:function(url){return new jscape.CopyToClipboardController().start(url);},_receiptSignatureAlgorithmsFor:function(keyAlias){for(var i=0;i<this.serverKeys.length;i++){var key=this.serverKeys[i];if(keyAlias==key.name){var keyAlgorithm=key.keyAlgorithm;return jscape.SignatureAlgorithm.filter(function(entry){return entry.asymmetricalAlgorithm==keyAlgorithm;});}}
return[];},_createConfiguration:function(){var proxyType=jscape.ProxyData.Type.fromString(this.view.getProxyType());return new jscape.AS2Configuration(this.view.getEnabled(),this.view.getPrimaryDecryptionKey()!=null?new jscape.ServerKeyProvider(this.view.getPrimaryDecryptionKey()):null,this.view.getPrimaryReceiptSigningKey()!=null?new jscape.ServerKeyProvider(this.view.getPrimaryReceiptSigningKey()):null,this.view.getPrimaryReceiptSignatureAlgorithm(),this.view.getSecondaryDecryptionKey()!=null?new jscape.ServerKeyProvider(this.view.getSecondaryDecryptionKey()):null,this.view.getSecondaryReceiptSigningKey()!=null?new jscape.ServerKeyProvider(this.view.getSecondaryReceiptSigningKey()):null,this.view.getSecondaryReceiptSignatureAlgorithm(),this.view.getMessageEncryptionRequired(),this.view.getMessageSignatureRequired(),this.view.getMessageWithoutFilenameAllowed(),this.view.getKeepingRawMessageFileRequired(),this.view.getFileOverwritingPolicy(),this.view.isBindUnauthenticatedTransfers()?new jscape.AS2Configuration.TransferBinding(this.view.getBindTransfersDomain(),this.view.getBindTransfersUser()):null,this.view.getUploadDirectory(),this.view.getReceiptText(),this.view.getFromAddress(),proxyType!=null?new jscape.ProxyData(proxyType,this.view.getProxyHost(),this.view.getProxyPort(),this.view.getProxyUsername(),this.view.getProxyPassword()):null);},_setupView:function(config){var serverKeys=$.map(this.serverKeys,function(key){return key.name;});var receiptAlgorithms=[];$.each(jscape.SignatureAlgorithm.values(),function(_,entry){if($.inArray(entry.hashAlgorithm,receiptAlgorithms)==-1){receiptAlgorithms.push(entry.hashAlgorithm);}});this.view.setPrimaryDecryptionKeys(serverKeys);this.view.setPrimaryReceiptSigningKeys(serverKeys);this.view.setPrimaryReceiptSignatureAlgorithms(receiptAlgorithms);this.view.setSecondaryDecryptionKeys(serverKeys);this.view.setSecondaryReceiptSigningKeys(serverKeys);this.view.setSecondaryReceiptSignatureAlgorithms(receiptAlgorithms);if(config){this.view.setEnabled(config.enabled);this.view.setPrimaryDecryptionKey(config.decryptionKeyProvider&&config.decryptionKeyProvider.keyAlias);this.view.setPrimaryReceiptSigningKey(config.receiptSigningKeyProvider&&config.receiptSigningKeyProvider.keyAlias);this.view.setPrimaryReceiptSignatureAlgorithm(config.receiptSignatureAlgorithm);this.view.setSecondaryDecryptionKey(config.secondaryDecryptionKeyProvider&&config.secondaryDecryptionKeyProvider.keyAlias);this.view.setSecondaryReceiptSigningKey(config.secondaryReceiptSigningKeyProvider&&config.secondaryReceiptSigningKeyProvider.keyAlias);this.view.setSecondaryReceiptSignatureAlgorithm(config.secondaryReceiptSignatureAlgorithm);this.view.setMessageEncryptionRequired(config.messageEncryptionRequired);this.view.setMessageSignatureRequired(config.messageSignatureRequired);this.view.setMessageWithoutFilenameAllowed(config.messageWithoutFilenameAllowed);this.view.setKeepingRawMessageFileRequired(config.keepingRawMessageFileRequired);this.view.setFileOverwritingPolicy(config.fileOverwritingPolicy==jscape.AS2Configuration.FileOverwritingPolicy.PROHIBIT?null:config.fileOverwritingPolicy);this.view.setUploadDirectory(config.uploadDirectory);this.view.setReceiptText(config.receiptText);this.view.setFromAddress(config.fromAddress);var proxyData=config.asyncReceiptProxyData;if(proxyData){this.view.setProxyType(proxyData.type);this.view.setProxyHost(proxyData.host);this.view.setProxyPort(proxyData.port);this.view.setProxyUsername(proxyData.username);this.view.setProxyPassword(proxyData.password);}else{this.view.setProxyType(null);}}
var transferBinding=config?config.unauthenticatedTransferBinding:null;jscape.API.getDomainNames().done($.proxy(function(names){this.view.setAvailableDomains(names);if(transferBinding){this.view.setBindUnauthenticatedTransfers(true);this.view.setBindTransfersDomain(transferBinding.domain);this.view.setBindTransfersUser(transferBinding.username);}},this));jscape.API.getAs2ServiceUrl().done($.proxy(function(data){if(data){this.view.setServicePlainUrl(data.plain||null);this.view.setServiceSecureUrl(data.secure||null);}},this));},_initValidators:function(){var v=new jscape.Validator();v.rule("astwo_uploaddir",$.proxy(this._validatorAs2UploadDir,this));},_validatorAs2UploadDir:function(value){return value&&value.length!=0&&value.charAt(0)=="/";},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.AS2ConfigurationView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#web-server-as2-fields").layout({fit:true,doSize:false,border:false});this.enabled=$("input[name=enabled]",this.fieldset).change($.proxy(this._onChange$Enabled,this));this.usePrimaryDecryptKey=$("input[name=useprimarydecryptkey]",this.fieldset).change($.proxy(this._onChange$UsePrimaryDecryptKey,this));this.primaryDecryptKey=$("select[name=primarydecryptkey]",this.fieldset).combobox({editable:false,disabled:true,onChange:$.proxy(this._onForm$Change,this),width:120,panelHeight:"auto"});this.usePrimarySignKey=$("input[name=useprimarysignkey]",this.fieldset).change($.proxy(this._onChange$UsePrimarySignKey,this));this.primarySignKey=$("select[name=primaryreceiptsingkey]",this.fieldset).combobox({editable:false,disabled:true,panelHeight:"auto",onChange:$.proxy(function(val){this._onChange$PrimarySigningKey(val);this._onForm$Change();},this),width:120});this.primaryReceiptSignature=$("select[name=primaryreceiptsignature]",this.fieldset).combobox({editable:false,disabled:true,onChange:$.proxy(this._onForm$Change,this),panelHeight:"auto",width:120});this.useSecondaryDecryptKey=$("input[name=usesecondarydecryptkey]",this.fieldset).change($.proxy(this._onChange$UseSecondaryDecryptKey,this));this.secondaryDecryptKey=$("select[name=secondarydecryptkey]",this.fieldset).combobox({editable:false,disabled:true,onChange:$.proxy(this._onForm$Change,this),width:120,panelHeight:"auto"});this.useSecondarySignKey=$("input[name=usesecondarysignkey]",this.fieldset).change($.proxy(this._onChange$UseSecondarySignKey,this));this.secondarySignKey=$("select[name=secondaryreceiptsingkey]",this.fieldset).combobox({editable:false,disabled:true,onChange:$.proxy(function(val){this._onChange$SecondarySigningKey(val);this._onForm$Change();},this),width:120,panelHeight:"auto"});this.secondaryReceiptSignature=$("select[name=secondaryreceiptsignature]",this.fieldset).combobox({editable:false,disabled:true,onChange:$.proxy(this._onForm$Change,this),width:120,panelHeight:"auto"});this.plainUrlValue=$("[aria-label=plain-url]",this.fieldset);this.copyPlainUrlButton=$("[role=button][name=copy-plain-url]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PlainUrlButton,this)});this.secureUrlValue=$("[aria-label=secure-url]",this.fieldset);this.copySecureUrlButton=$("[role=button][name=copy-secure-url]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$SecureUrlButton,this)});this.messageEncryptRequired=$("input[name=encryptrequired]",this.fieldset);this.messageSignatureRequired=$("input[name=signaturerequired]",this.fieldset);this.messageWithoutFilenameAllowed=$("input[name=allowmessagewofile]",this.fieldset);this.messageRawFileKept=$("input[name=keeprawfile]",this.fieldset);this.fileOverwriting=$("input[name=fileoverwriting]",this.fieldset).change($.proxy(this._onChange$FileOverwriting,this));this.fileOverwritingPolicy=$("select[name=fileoverwritingpolicy]",this.fieldset).combobox({editable:false,validType:"non_empty",onLoadSuccess:$.noop,onChange:$.proxy(this._onForm$Change,this),width:120,panelHeight:"auto"});this.bindTransfers=$("input[name=bindtransfers]",this.fieldset).change($.proxy(this._onChange$BindTransfers,this));this.transferUser=$("input[name=transferuser]",this.fieldset).combobox({required:true,editable:false,validType:"as2_user_nonempty",missingMessage:window.R.string.AS2_ERROR_BAD_TRANSFER_BINDING,onChange:$.proxy(this._onForm$Change,this),onLoadSuccess:$.noop,width:120,panelHeight:"auto",panelMinHeight:150,panelMaxHeight:"40%"});this.transferDomain=$("input[name=transfdomain]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(function(val){this._onChange$BindTransfersDomain(val);this._onForm$Change();},this),onLoadSuccess:$.noop,validType:"non_empty",missingMessage:window.R.string.AS2_ERROR_BAD_TRANSFER_BINDING,invalidMessage:window.R.string.AS_ERROR_BAD_TRANAFER_DOMAIN,width:120,panelHeight:"auto",panelMinHeight:150,panelMaxHeight:"40%"});this.uploadDir=$("input[name=uploaddir]",this.fieldset).textbox({required:true,validType:"astwo_uploaddir",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.AS2_ERROR_BAD_UPLOAD_DIR,invalidMessage:window.R.string.AS2_ERROR_BAD_UPLOAD_DIR,width:"50%"});this.receiptText=$("textarea[name=receiptext]",this.fieldset).textbox({multiline:true,onChange:$.proxy(this._onForm$Change,this),width:"40%",height:90});this.fromAddress=$("input[name=from]",this.fieldset).textbox({validType:"email",onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.proxyType=$("select[name=proxytype]",this.fieldset).combobox({editable:false,onChange:$.proxy(this._onChange$ProxyType,this),width:"40%",panelMinHeight:50,panelHeight:"auto",panelMaxHeight:"50%"});this.proxyHost=$("input[name=proxyhost]",this.fieldset).textbox({required:true,validType:"non_empty",onChange:$.proxy(this._onForm$Change,this),width:"50%"});this.proxyPort=$("input[name=proxyport]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});this.proxyUsername=$("input[name=proxyuser]",this.fieldset).textbox({onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.proxyPassword=$("input[name=proxypwd]",this.fieldset).passwordbox2({onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._adjustButtonsBarLayout(this.fieldset);this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.AS2ConfigurationView.LISTENER;this.fieldset.layout("resize");this.enabled.change();this._onChange$ProxyType();},getEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getPrimaryDecryptionKey:function(){return this.usePrimaryDecryptKey.is(":checked:not(:disabled)")?this.primaryDecryptKey.combobox("getValue"):null;},setPrimaryDecryptionKey:function(value){this.usePrimaryDecryptKey.prop("checked",!!value).change();if(value){this.primaryDecryptKey.combobox("clear").combobox("select",value)}},setPrimaryDecryptionKeys:function(values){this.primaryDecryptKey.combobox("loadData",values);},getPrimaryReceiptSigningKey:function(){return this.usePrimarySignKey.is(":checked:not(:disabled)")?this.primarySignKey.combobox("getValue"):null;},setPrimaryReceiptSigningKey:function(value){this.usePrimarySignKey.prop("checked",!!value).change();if(value){this.primarySignKey.combobox("clear").combobox("select",value)}},setPrimaryReceiptSigningKeys:function(values){this.primarySignKey.combobox("loadData",values);},getPrimaryReceiptSignatureAlgorithm:function(){return this.primaryReceiptSignature.combobox("options").disabled?null:this.primaryReceiptSignature.combobox("getValue");},setPrimaryReceiptSignatureAlgorithm:function(value){if(value){this.primaryReceiptSignature.combobox("select",value);}},setPrimaryReceiptSignatureAlgorithms:function(values){this.primaryReceiptSignature.combobox("reset").combobox("loadData",values);},getSecondaryDecryptionKey:function(){return this.useSecondaryDecryptKey.is(":checked:not(:disabled)")?this.secondaryDecryptKey.combobox("getValue"):null;},setSecondaryDecryptionKey:function(value){this.useSecondaryDecryptKey.prop("checked",!!value).change();if(value){this.secondaryDecryptKey.combobox("clear").combobox("select",value)}},setSecondaryDecryptionKeys:function(values){this.secondaryDecryptKey.combobox("loadData",values);},getSecondaryReceiptSigningKey:function(){return this.useSecondarySignKey.is(":checked:not(:disabled)")?this.secondarySignKey.combobox("getValue"):null;},setSecondaryReceiptSigningKey:function(value){this.useSecondarySignKey.prop("checked",!!value).change();if(value){this.secondarySignKey.combobox("clear").combobox("select",value)}},setSecondaryReceiptSigningKeys:function(values){this.secondarySignKey.combobox("loadData",values);},getSecondaryReceiptSignatureAlgorithm:function(){return this.secondaryReceiptSignature.combobox("options").disabled?null:this.secondaryReceiptSignature.combobox("getValue");},setSecondaryReceiptSignatureAlgorithm:function(value){if(value){this.secondaryReceiptSignature.combobox("select",value);}},setSecondaryReceiptSignatureAlgorithms:function(values){this.secondaryReceiptSignature.combobox("reset").combobox("loadData",values);},getMessageEncryptionRequired:function(){return this.messageEncryptRequired.is(":checked");},setMessageEncryptionRequired:function(value){this.messageEncryptRequired.prop("checked",!!value);},getMessageSignatureRequired:function(){return this.messageSignatureRequired.is(":checked");},setMessageSignatureRequired:function(value){this.messageSignatureRequired.prop("checked",!!value);},getMessageWithoutFilenameAllowed:function(){return this.messageWithoutFilenameAllowed.is(":checked");},setMessageWithoutFilenameAllowed:function(value){this.messageWithoutFilenameAllowed.prop("checked",!!value);},getKeepingRawMessageFileRequired:function(){return this.messageRawFileKept.is(":checked");},setKeepingRawMessageFileRequired:function(value){this.messageRawFileKept.prop("checked",!!value).change();},getFileOverwritingPolicy:function(){return this.fileOverwriting.is(":checked")?this.fileOverwritingPolicy.combobox("getValue"):null;},setFileOverwritingPolicy:function(value){if(value!=null){this.fileOverwriting.prop("checked",true).change();this.fileOverwritingPolicy.combobox("select",value);}else{this.fileOverwriting.prop("checked",false).change();this.fileOverwritingPolicy.combobox("reset");}},isBindUnauthenticatedTransfers:function(){return this.bindTransfers.is(":checked");},setBindUnauthenticatedTransfers:function(value){this.bindTransfers.prop("checked",!!value).change();},getBindTransfersDomain:function(){return this.transferDomain.combobox("getValue");},setBindTransfersDomain:function(value){this.transferDomain.combobox("clear").combobox("select",value);},setAvailableDomains:function(values){this.transferDomain.combobox("loadData",values);},getBindTransfersUser:function(){return this.transferUser.combobox("getValue");},setBindTransfersUser:function(value){this.transferUser.combobox("clear").combobox("setValue",value);},setAvailableUsers:function(values){var value=this.transferUser.combobox("getValue");this.transferUser.combobox("clear").combobox("loadData",values).combobox("select",value).combobox("validate");},getUploadDirectory:function(){return this.uploadDir.textbox("getValue");},setUploadDirectory:function(value){this.uploadDir.textbox("setValue",value);},getReceiptText:function(){return this.receiptText.textbox("getValue");},setReceiptText:function(value){this.receiptText.textbox("setValue",value);},getFromAddress:function(){return this.fromAddress.textbox("getValue");},setFromAddress:function(value){this.fromAddress.textbox("setValue",value);},setServicePlainUrl:function(value){this.plainUrlValue.html(String(value||"").escapeXml());if(/^http/i.test(value)){this.copyPlainUrlButton.linkbutton("enable").show();}else{this.copyPlainUrlButton.linkbutton("disable").hide();}},setServiceSecureUrl:function(value){this.secureUrlValue.html(String(value||"").escapeXml());if(/^http/i.test(value)){this.copySecureUrlButton.linkbutton("enable").show();}else{this.copySecureUrlButton.linkbutton("disable").hide();}},getProxyType:function(){return this.proxyType.combobox("getValue");},setProxyType:function(value){if(!!value){this.proxyType.combobox("select",value);}else{this.proxyType.combobox("reset");}},getProxyHost:function(){return this.proxyHost.textbox("getValue");},setProxyHost:function(value){this.proxyHost.textbox("setValue",value);},getProxyPort:function(){return this.proxyPort.numberspinner("getValue");},setProxyPort:function(value){this.proxyPort.numberspinner("setValue",value);},getProxyUsername:function(){return this.proxyUsername.textbox("getValue");},setProxyUsername:function(value){this.proxyUsername.textbox("setValue",value);},getProxyPassword:function(){return this.proxyPassword.passwordbox2("getValue");},setProxyPassword:function(value){this.proxyPassword.passwordbox2("setValue",value);},_onChange$ProxyType:function(){var type=jscape.ProxyData.Type.fromString(this.getProxyType());this.proxyHost.textbox(type!=null?"enable":"disable");this.proxyPort.numberspinner(type!=null?"enable":"disable");this.proxyUsername.textbox(type!=null?"enable":"disable");this.proxyPassword.passwordbox2(type!=null&&jscape.ProxyData.Type.SOCKS4!=type?"enable":"disable");this._onForm$Change();},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onClick$PlainUrlButton:function(){this.listener.onCopyServiceUrl(this.plainUrlValue.text()).done($.proxy(this._showDataCopiedTip,this,this.copyPlainUrlButton));},_onClick$SecureUrlButton:function(){this.listener.onCopyServiceUrl(this.secureUrlValue.text()).done($.proxy(this._showDataCopiedTip,this,this.copySecureUrlButton));},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_onChange$UsePrimaryDecryptKey:function(){var enabled=this.usePrimaryDecryptKey.is(":checked:not(:disabled)");this.primaryDecryptKey.combobox(enabled?"enable":"disable");},_onChange$UsePrimarySignKey:function(){var enabled=this.usePrimarySignKey.is(":checked:not(:disabled)");this.primarySignKey.combobox(enabled?"enable":"disable");this.primaryReceiptSignature.combobox(enabled?"enable":"disable");},_onChange$PrimarySigningKey:function(value){if(this.listener){this.listener.onChangePrimaryReceiptSigningKey(value);}},_onChange$UseSecondaryDecryptKey:function(){var enabled=this.useSecondaryDecryptKey.is(":checked:not(:disabled)");this.secondaryDecryptKey.combobox(enabled?"enable":"disable")},_onChange$UseSecondarySignKey:function(){var enabled=this.useSecondarySignKey.is(":checked:not(:disabled)");this.secondarySignKey.combobox(enabled?"enable":"disable");this.secondaryReceiptSignature.combobox(enabled?"enable":"disable");},_onChange$SecondarySigningKey:function(value){if(this.listener){this.listener.onChangeSecondaryReceiptSigningKey(value);}},_onChange$FileOverwriting:function(){var enabled=this.fileOverwriting.is(":checked:not(:disabled)");this.fileOverwritingPolicy.combobox(enabled?"enable":"disable");},_onChange$BindTransfers:function(){var enabled=this.bindTransfers.is(":checked:not(:disabled)");this.transferUser.combobox(enabled?"enable":"disable",!enabled);this.transferDomain.combobox(enabled?"enable":"disable",!enabled);},_onChange$BindTransfersDomain:function(newValue){if(newValue){this.listener.onChangeBindTransfersDomain(newValue);}},_onChange$Enabled:function(){var enabled=this.getEnabled();this.usePrimaryDecryptKey.prop("disabled",!enabled).change();this.usePrimarySignKey.prop("disabled",!enabled).change();this.useSecondaryDecryptKey.prop("disabled",!enabled).change();this.useSecondarySignKey.prop("disabled",!enabled).change();this.messageEncryptRequired.prop("disabled",!enabled);this.messageSignatureRequired.prop("disabled",!enabled);this.messageWithoutFilenameAllowed.prop("disabled",!enabled);this.messageRawFileKept.prop("disabled",!enabled);this.fileOverwriting.prop("disabled",!enabled).change();this.bindTransfers.prop("disabled",!enabled).change();this.uploadDir.textbox(enabled?"enable":"disable");this.receiptText.textbox(enabled?"enable":"disable");this.fromAddress.textbox(enabled?"enable":"disable");this.fieldset.form("validate");},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);},_showDataCopiedTip:function(target){if(target&&target.length){target.tooltip({content:window.R.string.APPLICATION_MESSAGE_COPIED||"Copied...",position:"right",showEvent:"none",showDelay:0,hideEvent:"none",hideDelay:2000,onShow:function(){$(this).tooltip("hide");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");}}});jscape.settings.AS2ConfigurationView.LISTENER={onChange:$.noop,onChangePrimaryReceiptSigningKey:$.noop,onChangeSecondaryReceiptSigningKey:$.noop,onChangeBindTransfersDomain:$.noop,onCopyServiceUrl:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.SelfRegistrationController=Class.extend({DEFAULT_DESCRIPTOR:new jscape.SelfRegistrationServiceDescriptor(),descriptor:null,view:null,onCreate:function(){},onStart:function(){if(this.view==null){this.view=new jscape.settings.SelfRegistrationView();}
this.view.show(this);},onResume:function(){jscape.API.getRegistrationServiceConfiguration().done($.proxy(function(descriptor){this.descriptor=descriptor;},this)).fail($.proxy(function(){this.descriptor=this.DEFAULT_DESCRIPTOR;},this)).always($.proxy(function(){this.view&&this._setupView(this.descriptor);},this));},hasChanged:function(){return this.descriptor!=null&&!Object._equals(this.descriptor,this._createDescriptor());},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){return jscape.API.setRegistrationServiceConfiguration(this._createDescriptor()).done($.proxy(function(descriptor){this.descriptor=descriptor;},this)).done($.proxy(this._fireApplySuccess,this));},onDiscard:function(){this._setupView(this.descriptor);},_createDescriptor:function(){return new jscape.SelfRegistrationServiceDescriptor(this.view.isShowRegistrationLink(),this.view.isUseEmailAsLogin(),this.view.isCaptchaRequired(),this.view.isCompanyNameRequired());},_setupView:function(descriptor){if(descriptor){this.view.setShowRegistrationLink(descriptor.showRegistrationLink);this.view.setUseEmailAsLogin(descriptor.useEmailAddressAsLogin);this.view.setCaptchaRequired(descriptor.captchaRequired);this.view.setCompanyNameRequired(descriptor.companyNameRequired);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.SelfRegistrationView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#self-registration-fields");this.showLink=$("input[name=showlink]",this.fieldset);this.useEmailAsLogin=$("input[name=emailaslogin]",this.fieldset);this.requireCaptcha=$("input[name=requirecaptcha]",this.fieldset);this.requireCompanyName=$("input[name=requirecompanyname]",this.fieldset);this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.SelfRegistrationView.LISTENER;},isShowRegistrationLink:function(){return this.showLink.is(":checked");},setShowRegistrationLink:function(value){this.showLink.prop("checked",!!value).change();},isUseEmailAsLogin:function(){return this.useEmailAsLogin.is(":checked");},setUseEmailAsLogin:function(value){this.useEmailAsLogin.prop("checked",!!value).change();},isCaptchaRequired:function(){return this.requireCaptcha.is(":checked");},setCaptchaRequired:function(value){this.requireCaptcha.prop("checked",!!value).change();},isCompanyNameRequired:function(){return this.requireCompanyName.is(":checked");},setCompanyNameRequired:function(value){this.requireCompanyName.prop("checked",!!value).change();},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.settings.SelfRegistrationView.LISTENER={onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.AddLanguageDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-sswres-add"),{width:530});this.language=$("select[name=language]",this.dialog).combobox({required:true,editable:false,width:"60%"});},getLanguage:function(){return this.language.combobox("getValue");},getDisplayName:function(){return this.language.combobox("getText");},disableLanguages:function(values){if(values.length==0){return;}
var data=this.language.combobox("getData");var valueField=this.language.combobox("options").valueField;$.each(data,function(index,entry){entry.disabled=$.inArray(entry[valueField],values)!=-1;});this.language.combobox("loadData",data);},show:function(listener){this._super(listener);$.each(this.language.combobox("getData"),$.proxy(function(_,entry){if(!entry.disabled){this.language.combobox("select",entry);return false;}},this));}});jscape.settings.WebResourcesController=Class.extend({configCopy:null,logoCopy:null,view:null,onCreate:function(){},onStart:function(){if(this.view==null){this.view=new jscape.settings.WebResourcesView();}
this.view.show(this);},onResume:function(){jscape.API.getWebResourcesConfiguration().done($.proxy(function(config){this.configCopy=config.clone();this._setupView(config,null);},this)).fail($.proxy(function(){this.configCopy=null;},this));jscape.API.getWebLogoConfiguration().catch(function(){return new jscape.WebLogoConfiguration();}).done($.proxy(function(config){this.logoCopy=config.clone();this._setupView(null,config);},this));},hasChanged:function(){return(this.configCopy&&!Object._equals(this.configCopy,this._createConfiguration()))||(this.logoCopy&&!Object._equals(this.logoCopy,this._createLogoConfig()));},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){return $.when(jscape.API.setWebResourcesConfiguration(this._createConfiguration()),jscape.API.setWebLogoConfiguration(this._createLogoConfig())).done($.proxy(function(resourcesConfig,logoConfig){this.configCopy=resourcesConfig.clone();this.logoCopy=logoConfig.clone();this._setupView(resourcesConfig,logoConfig);},this)).done($.proxy(this._fireApplySuccess,this));},onDiscard:function(){this._setupView(this.configCopy.clone(),this.logoCopy.clone());},onChangeLogo:function(file){jscape.WebLogoConfiguration.fromFile(file).done($.proxy(function(config){this.view.setLogoAsDataUrl(config.toDataURL());},this));},onAddLanguage:function(){var dialog=new jscape.settings.AddLanguageDialog();dialog.disableLanguages($.map(this.view.getResources(),function(resource){return resource.lang;}));dialog.show({onSubmit:$.proxy(function(d){var lang=d.getLanguage();var displayName=d.getDisplayName();d.destroy();this._languageAdded(lang,displayName);},this),onCancel:function(d){d.destroy();}});},onResetLanguages:function(){this.view.setResources(this.configCopy.clone().resources);this.view.selectLanguage(jscape.WebResources.DEFAULT_LANGUAGE);},_languageAdded:function(language,displayName){var defaultResources=$.grep(this.configCopy.resources,function(item){return item.isDefault();});var defaultProperties=defaultResources.length?defaultResources[0].properties:{};var newResources=new jscape.WebResources(language,displayName,$.extend({},defaultProperties));this.view.setResources(this.view.getResources().concat(newResources));this.view.selectLanguage(language);},_createConfiguration:function(){return new jscape.WebResourcesConfiguration(this.view.getResources());},_createLogoConfig:function(){return new jscape.WebLogoConfiguration(this.view.getLogoAsDataUrl());},_setupView:function(resourcesConfig,logoConfig){if(this.view){resourcesConfig&&this.view.setResources(resourcesConfig.resources);logoConfig&&this.view.setLogoAsDataUrl(logoConfig.toDataURL());}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.WebResourcesView=jscape.ui.FormView.extend({DEFAULT_LANG:"default",initialize:function(){this.fieldset=$("#web-resources-fields");this.logo=$("img").appendTo($("div.logo-preview",this.fieldset));this.logoFile=$("input[name=logo]",this.fieldset).css({width:0,height:0,opacity:0,position:"absolute",left:"-10000px"});this.logoFile.change($.proxy(this._onChange$Logo,this));this.logoButton=$("a[role=button][name=changelogo]",this.fieldset).linkbutton({onClick:$.proxy(function(){this.logoFile.click();},this)});this.logo.parent().click($.proxy(function(){this.logoFile.click();},this));this.language=$("select[name=language]",this.fieldset);this.language.combobox({required:true,editable:false,valueField:"lang",textField:"displayName",selectOnNavigation:false,formatter:$.proxy(this._formatLanguage,this),onChange:$.proxy(this._onChange$Language,this),width:210,panelHeight:"auto",panelMaxHeight:"40%"});this.data=$("table[role=grid][aria-label=resources]",this.fieldset);this.data.propertygrid({fit:true,fitColumns:true,showGroup:false,sortName:"name",sortOrder:"asc",loadMsg:$.fn.datagrid.defaults.loadMsg,loadFilter:function(data){return $.map(data,function(value,key){return{name:key,value:value,editor:"textarea"};});},onLoadSuccess:function(){$(this).propertygrid("fitColumns").propertygrid("fixColumnSize","value");},onBeginEdit:$.proxy(this._onBegin$Edit,this),onAfterEdit:$.proxy(this._onAfter$Edit,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.resetButton=$("a[role=button][name=reset]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ResetButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.WebResourcesView.LISTENER;this.data.propertygrid("resize",{height:"100%"});},getLogoAsDataUrl:function(){return this.logo.attr("src");},setLogoAsDataUrl:function(data){this.logo[0].src=data;this.fieldset.triggerHandler("_change",this.logo[0]);},getResources:function(){return this.language.combobox("getData");},setResources:function(values){this.data.propertygrid("loading");this.language.combobox("loadData",values);this._onChange$Language();this.data.propertygrid("loaded");this._onForm$Change();},selectLanguage:function(value){this.language.combobox("select",value);},_formatLanguage:function(item){var opts=this.language.combobox("options");return item.isDefault()?this.DEFAULT_LANG:item[opts.textField];},_onChange$Logo:function(e){var files=e.target.files;if(files&&files.length){this.listener.onChangeLogo(files[0]);}
return false;},_onChange$Language:function(){var properties=this._propertiesFor(this.language.combobox("getValue"));if(properties!=null){this.data.propertygrid("loading").propertygrid("loadData",properties).propertygrid("loaded");}
return false;},_onClick$AddButton:function(){this.listener.onAddLanguage();},_onClick$ResetButton:function(){this.listener.onResetLanguages();},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onBegin$Edit:function(index){var editor=this.data.propertygrid("getEditor",{index:index,field:"value"});var t=$(editor.target);if(t.hasClass("textbox-f")){t=t.textbox("textbox");}
if(t.length){t.height(t.height()+(t[0].scrollHeight||0)+50);}
t.off("._reditor").on("keydown._reditor",{target:this.data},function(e){if(e.keyCode===27){e.stopPropagation();$(e.data.target).propertygrid("cancelEdit",index);}});},_onAfter$Edit:function(_,data){var properties=this._propertiesFor(this.language.combobox("getValue"));if(properties!=null){properties[data.name]=data.value;}
this._onForm$Change();},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.addButton,"-",this.resetButton,"-",this.applyButton,this.discardButton],parent);},_propertiesFor:function(language){var data=this.language.combobox("getData");for(var i=0;i<data.length;i++){var resources=data[i];if(resources.lang==language){return resources.properties;}}
return null;}});jscape.settings.WebResourcesView.LISTENER={onChange:$.noop,onChangeLogo:$.noop,onAddLanguage:$.noop,onResetLanguages:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.DocumentViewerController=Class.extend({DEFAULT_CONFIG:new jscape.DocumentViewerConfiguration(false,null,null,null,10),config:null,allowed:false,view:null,initialize:function(){this._initValidators();},onCreate:function(){this.allowed=false;},onStart:function(){if(this.view==null){this.view=new jscape.settings.DocumentViewerView();}
this.view.show(this);},onResume:function(){jscape.API.getDocumentViewerAllowed().then($.proxy(function(value){this.allowed=!!value;return this.allowed?jscape.API.getDocumentViewerConfiguration():$.Deferred().reject().promise();},this)).done($.proxy(function(config){this.config=config;},this)).fail($.proxy(function(){this.config=this.DEFAULT_CONFIG;},this)).always($.proxy(function(){this.view&&this._setupView(this.config);},this));},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration());},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){if(!this.allowed){return $.Deferred().resolve().promise();}
return jscape.API.setDocumentViewerConfiguration(this._createConfiguration()).done($.proxy(function(config){this.config=config;},this)).done($.proxy(this._fireApplySuccess,this));},onDiscard:function(){this._setupView(this.config);return $.Deferred().resolve().promise();},onTest:function(){return!this.allowed?$.Deferred().resolve().promise():jscape.API.testDocumentViewer(this._createConfiguration()).done($.proxy(this._testComplete,this));},onSelectDirectory:function(){return new SelectPathController($.proxy(jscape.API.listFileSystem,jscape.API),$.proxy(jscape.API.createFileSystemPath,jscape.API)).selectDirectory().then(function(entry){return entry.path;});},_createConfiguration:function(){return new jscape.DocumentViewerConfiguration(this.view.getEnabled(),this.view.getOfficeDir(),this.view.getSwfToolDir(),this.view.getOutputDir(),this.view.getThreadCount());},_setupView:function(config){if(config){this.view.setEnabled(config.enabled);this.view.setOfficeDir(config.officeDirectory);this.view.setSwfToolDir(config.swfToolDirectory);this.view.setOutputDir(config.outputDirectory);this.view.setThreadCount(config.threads);}},_initValidators:function(){var v=new jscape.Validator();v.rule("docviewer_allowed",$.proxy(function(){return this.allowed;},this));},_testComplete:function(data){if(data&&data.valid===false){$.messager.alert(window.R.string.DOC_VIEWER_TEST_TITLE,data.message||window.R.string.APPLICATION_ERROR_TITLE,"error");}else{$.messager.alert(window.R.string.DOC_VIEWER_TEST_TITLE,data.message||window.R.string.DOC_VIEWER_TEST_SUCCESS_MESSAGE,"info");}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.DocumentViewerView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#docviewer-settings-fields");this.fieldset.layout({fit:true,doSize:false,border:true});this.fieldset.find(".content").layout({fit:true,doSize:false,border:false});this.enabled=$("input[name=enabled]:checkbox",this.fieldset).click($.proxy(this._onClick$Enabled,this)).change($.proxy(this._adjustFieldState,this));this.officeDir=$("input[name=officedir]",this.fieldset).textbox({required:true,validType:"non_empty",missingMessage:window.R.string.DOC_VIEWER_ERROR_BAD_OFFICE_DIR,invalidMessage:window.R.string.DOC_VIEWER_ERROR_BAD_OFFICE_DIR,buttonText:"...",buttonAlign:"right",buttonIcon:null,onClickButton:$.proxy(this._onClick$OfficeDirBrowseButton,this),onChange:$.proxy(this._onForm$Change,this),tipPosition:"bottom",width:"65%"});this.swfToolDir=$("input[name=swftooldir]",this.fieldset).textbox({buttonText:"...",buttonAlign:"right",buttonIcon:null,onClickButton:$.proxy(this._onClick$SwfToolDirBrowseButton,this),onChange:$.proxy(this._onForm$Change,this),width:"65%"});this.outputDir=$("input[name=outdir]",this.fieldset).textbox({required:true,validType:"non_empty",missingMessage:window.R.string.DOC_VIEWER_ERROR_BAD_OUTPUT_DIR,invalidMessage:window.R.string.DOC_VIEWER_ERROR_BAD_OUTPUT_DIR,buttonText:"...",buttonAlign:"right",buttonIcon:null,onClickButton:$.proxy(this._onClick$OutputDirBrowseButton,this),onChange:$.proxy(this._onForm$Change,this),tipPosition:"bottom",width:"65%"});this.threadCount=$("input[name=threads]",this.fieldset).numberspinner({required:true,min:1,max:100,onChange:$.proxy(this._onForm$Change,this),width:80});this.testButton=$("a[role=button][name=test]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$TestButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.DocumentViewerView.LISTENER;this._adjustFieldState();},getEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getOfficeDir:function(){return this.officeDir.textbox("getValue");},setOfficeDir:function(value){this.officeDir.textbox("setValue",value);},getSwfToolDir:function(){return this.swfToolDir.textbox("getValue");},setSwfToolDir:function(value){this.swfToolDir.textbox("setValue",value);},getOutputDir:function(){return this.outputDir.textbox("getValue");},setOutputDir:function(value){this.outputDir.textbox("setValue",value);},getThreadCount:function(){return parseInt(this.threadCount.numberspinner("getValue"));},setThreadCount:function(value){this.threadCount.numberspinner("setValue",parseInt(value)).numberspinner("validate");},_onClick$Enabled:function(e){if(this.getEnabled()){var allowed=new jscape.Validator().isSatisfied("docviewer_allowed");if(!allowed){e.preventDefault();e.stopImmediatePropagation();this.enabled.prop("checked",false).change();$.messager.alert(window.R.string.DIALOG_TITLE_ERROR,window.R.string.DOC_VIEWER_ERROR_NOT_ALLOWED,"error");}}},_onClick$OfficeDirBrowseButton:function(){this.listener.onSelectDirectory().done($.proxy(function(path){this.setOfficeDir(path);this.officeDir.textbox("textbox").select().focus();},this));},_onClick$SwfToolDirBrowseButton:function(){this.listener.onSelectDirectory().done($.proxy(function(path){this.setSwfToolDir(path);this.swfToolDir.textbox("textbox").select().focus();},this));},_onClick$OutputDirBrowseButton:function(){this.listener.onSelectDirectory().done($.proxy(function(path){this.setOutputDir(path);this.outputDir.textbox("textbox").select().focus();},this));},_onClick$TestButton:function(){if(this._valid()){this.testButton.linkbutton("disable");this.listener.onTest().always($.proxy(function(){this.testButton.linkbutton("enable");},this));}},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");this.testButton.linkbutton(this.getEnabled()&&this._valid()?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.testButton,"-",this.applyButton,this.discardButton],parent);},_adjustFieldState:function(){var enabled=this.getEnabled();$.each([this.officeDir,this.swfToolDir,this.outputDir],function(_,input){input.textbox(enabled?"enable":"disable");});this.threadCount.numberspinner(enabled?"enable":"disable");this.fieldset.form("validate");}});jscape.settings.DocumentViewerView.LISTENER={onSelectDirectory:$.noop,onChange:$.noop,onTest:$.noop,onApply:$.noop,onDiscard:$.noop};