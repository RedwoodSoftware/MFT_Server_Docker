/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.settings=jscape.settings||{};jscape.ServerManagementServiceConfiguration=Class.extend({initialize:function(a,b,c,d){this.enabled=!!a||false;this.host=b||"";this.port=parseInt(c)||0;this.timeout=parseInt(d)||0;},clone:function(){return new jscape.ServerManagementServiceConfiguration(this.enabled,this.host,this.port,this.timeout);}});jscape.ServerManagementServiceConfiguration.fromJSON=function(data){return data?new jscape.ServerManagementServiceConfiguration(data.enabled,data.host,data.port,data.timeout):null;};jscape.ManagementAccessServiceConfiguration=Class.extend({initialize:function(a,b,c,d,e){this.rules=a||[];this.authTimeout=parseInt(b)||null;this.maxAuthAttempts=parseInt(c)||null;this.maxAuthTimeout=parseInt(d)||null;this.restoringTimeout=parseInt(e)||null;}});jscape.ManagementAccessServiceConfiguration.fromJSON=function(data){return new jscape.ManagementAccessServiceConfiguration($.map(data.rules||[],jscape.IPAccessRule.fromJSON),data.authTimeout,data.maxAuthAttempts,data.maxAuthTimeout,data.restoringTimeout);};jscape.ManagementLogServiceConfiguration=Class.extend({initialize:function(a){this.recordExpirationPeriodMillis=!isNaN(parseInt(a))?parseInt(a):null;}});jscape.ManagementLogServiceConfiguration.fromJSON=function(data){return data?new jscape.ManagementLogServiceConfiguration(data.recordExpirationPeriodMillis):null;};jscape.ManagementSyslogServiceConfiguration=Class.extend({initialize:function(a,b,c,d,e,f,g){this.host=a||"";this.port=parseInt(b)||0;this.facilityCode=!isNaN(parseInt(c))?parseInt(c):1;this.processName=d||"";this.enabled=!!e;this.enableTcp=!!f;this.hostkey=g||null;}});jscape.ManagementSyslogServiceConfiguration.fromJSON=function(data){return new jscape.ManagementSyslogServiceConfiguration(data.host,data.port,data.facilityCode,data.processName,data.enabled,data.enableTcp,data.hostkey);};jscape.ManagementExtendedLogConfiguration=Class.extend({initialize:function(a){this.splunkHttpData=jscape.ManagementExtendedLogConfiguration.SplunkHttpData.fromJSON(a);}});jscape.ManagementExtendedLogConfiguration.fromJSON=function(data){return new jscape.ManagementExtendedLogConfiguration(data.splunkHttpData);};jscape.ManagementExtendedLogConfiguration.splunkHttp=function(host,port,timeout,sslRequired,token,source,sourceType,index){return new jscape.ManagementExtendedLogConfiguration(new jscape.ManagementExtendedLogConfiguration.SplunkHttpData(host,port,timeout,sslRequired,token,source,sourceType,index));};jscape.ManagementExtendedLogConfiguration.SplunkHttpData=Class.extend({initialize:function(a,b,c,d,e,f,g,h){this.host=a||"";this.port=parseInt(b)||0;this.timeout=parseInt(c)||0;this.sslRequired=!!d;this.accessToken=e||"";this.source=f||null;this.sourceType=g||null;this.index=h||null;}});jscape.ManagementExtendedLogConfiguration.SplunkHttpData.fromJSON=function(data){return data?new jscape.ManagementExtendedLogConfiguration.SplunkHttpData(data.host,data.port,data.timeout,data.sslRequired,data.accessToken,data.source,data.sourceType,data.index):null;};jscape.ManagementLogRecords=Class.extend({initialize:function(a,b,c,d,e,f,g,i){this.date=parseInt(a)||0;this.appInstanceId=b||null;this.clientHost=c||"";this.clientPort=parseInt(d)||0;this.user=e||"";this.domain=f||"";this.action=g||"";this.description=i||"";}});jscape.ManagementLogRecords.fromJSON=function(data){return data?new jscape.ManagementLogRecords(data.date,data.appInstanceId,data.clientHost,data.clientPort,data.user,data.domain,data.action,data.description):null;};jscape.IPAccessRule=Class.extend({initialize:function(a,b,c){this.mask=a;this.reason=b||"";this.allowed=c||false;}});jscape.IPAccessRule.fromJSON=function(data){return data?new jscape.IPAccessRule(data.mask,data.reason,data.allowed):null;};jscape.Administrator=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i){this.name=a;this.username=b;this.enabled=c||false;this.roles=d||[];this.phone=e||null;this.theme=f||null;this.customUiTheme=g||null;this.systemAdministrator=h||false;this.multiFactorAuthenticationRequired=i||false;}});jscape.Administrator.fromJSON=function(data){return data?new jscape.Administrator(data.name,data.username,data.enabled,data.roles,jscape.Phone.fromJSON(data.phone),data.theme,data.customUiTheme,data.systemAdministrator,data.multiFactorAuthenticationRequired):null;};jscape.ManagementRole=Class.extend({initialize:function(a,b,c,d){this.name=a||"";this.permissions=b||[];this.allowedDirectory=c||null;this.domainAccesses=d||[];}});jscape.ManagementRole.fromJSON=function(data){return data?new jscape.ManagementRole(data.name,data.permissions,data.allowedDirectory,$.map(data.domainAccesses||[],jscape.DomainAccess.fromJSON)):null;};jscape.DomainAccess=Class.extend({initialize:function(a,b,c,d,e,f,g){this.domainName=a||"";this.permissions=b||[];this.allowedEvents=$.isArray(c)?c:null;this.allowedFunctions=$.isArray(d)?d:null;this.allowedActions=$.isArray(e)?e:null;this.tags=f||[];this.enabled=g!=undefined?!!g:false;}});jscape.DomainAccess.fromJSON=function(data){return data?new jscape.DomainAccess(data.domainName,data.permissions,data.allowedEvents,data.allowedFunctions,data.allowedActions,data.tags,data.enabled):null;};jscape.settings.ManagerServiceModule=jscape.settings.SettingsModule.extend({onCreate:function(serverAddresses,serverKeys,app){var args=$.makeArray(arguments);this._super.apply(this,args);var submodules=[];this.serviceController=new jscape.settings.ManagerServiceController(serverAddresses);submodules.push(app.register("manager-service-config",new jscape.settings.SettingsSubmodule(this.serviceController)));submodules.push(app.register("manager-service-access",new jscape.settings.SettingsSubmodule(new jscape.settings.ManagerAccessController())));$.each(submodules,function(){this.onCreate.apply(this,args);});},onStart:function(){this.serviceController.start();}});jscape.settings.ManagerLoggingModule=jscape.settings.SettingsModule.extend({onCreate:function(_a,_b,app){var args=$.makeArray(arguments);this._super.apply(this,args);var submodules=[];this.recordsController=new jscape.settings.ManagerLogRecordsController();submodules.push(app.register("manager-logging-records",new jscape.settings.SettingsSubmodule(this.recordsController)));submodules.push(app.register("manager-logging-service",new jscape.settings.SettingsSubmodule(new jscape.settings.ManagerLogServiceController())));submodules.push(app.register("manager-logging-syslog",new jscape.settings.SettingsSubmodule(new jscape.settings.ManagerSyslogController())));submodules.push(app.register("manager-logging-extended",new jscape.settings.SettingsSubmodule(new jscape.settings.ManagerExtendedLogController())));submodules.push(app.register("manager-logging-debug",new jscape.settings.SettingsSubmodule(new jscape.settings.ManagerDebugLoggingController())));$.each(submodules,function(){this.onCreate.apply(this,args);});},onStart:function(){this.recordsController.start();}});jscape.settings.ManagerAuthenticationModule=jscape.settings.SettingsModule.extend({initialize:function(){$(document).on("onchangeroles.settings",$.proxy(this._onChangeRoles,this));},onCreate:function(_a,_b,app){var args=$.makeArray(arguments);this._super.apply(this,args);var submodules=[];this.authServiceController=new jscape.settings.AuthenticationServiceController();submodules.push(app.register("manager-authentication-service",new jscape.settings.SettingsSubmodule(this.authServiceController)));submodules.push(app.register("manager-authentication-multifactor",new jscape.settings.SettingsSubmodule(new jscape.settings.MultiFactorAuthServiceController())));this.webSsoController=new jscape.settings.WebSsoAuthServiceController();submodules.push(app.register("manager-authentication-sso",new jscape.settings.SettingsSubmodule(this.webSsoController)));},onStart:function(){this.authServiceController.start();},_onChangeRoles:function(e,roles){if(this.authServiceController){this.authServiceController.onChangeRoles(roles);}
if(this.webSsoController){this.webSsoController.onChangeRoles(roles);}}});jscape.settings.ManagerAccountsModule=jscape.settings.SettingsModule.extend({initialize:function(themeLoader){this.themeLoader=themeLoader;},onCreate:function(_a,b,app){var args=$.makeArray(arguments);this._super.apply(this,args);var submodules=[];this.administratorsController=new jscape.settings.AdministratorsController(this.themeLoader);submodules.push(app.register("manager-accounts-list",new jscape.settings.SettingsSubmodule(this.administratorsController)));submodules.push(app.register("manager-accounts-roles",new jscape.settings.SettingsSubmodule(new jscape.settings.ManagementRolesController(this))));submodules.push(app.register("manager-accounts-tags",new jscape.settings.SettingsSubmodule(new jscape.settings.AclTagsController())));$.each(submodules,function(){this.onCreate.apply(this,args);});},onStart:function(){this.administratorsController.start();},onChangeRoles:function(roles){$(document).triggerHandler("onchangeroles.settings",[roles]);}});jscape.settings.ManagerServiceController=Class.extend({DEFAULT_CONFIG:new jscape.ServerManagementServiceConfiguration(true,"0.0.0.0",10880,180*1000),view:null,config:null,initialize:function(addresses){this.inetAddresses=addresses||[];},start:function(){if(this.view==null){this.view=new jscape.settings.ManagerServiceView();}
this.view.show(this);},resume:function(){this.view.refresh();},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration());},onLoadData:function(){return jscape.API.getManagementServiceConfiguration().catch(function(){return null;}).then($.proxy(function(config){this.config=config||this.DEFAULT_CONFIG;this._setupView(this.config);},this));},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){return jscape.API.setManagementServiceConfiguration(this._createConfiguration()).done($.proxy(function(config){this.config=config;},this)).done($.proxy(this._fireApplySuccess,this));},onDiscard:function(){this._setupView(this.config);return $.Deferred().resolve().promise();},_createConfiguration:function(){return new jscape.ServerManagementServiceConfiguration(this.view.getEnabled(),this.view.getHost(),this.view.getPort(),this.view.getTimeout());},_setupView:function(config){this.view.setHosts(this.inetAddresses);if(config){this.view.setEnabled(config.enabled);this.view.setHost(config.host);this.view.setPort(config.port);this.view.setTimeout(config.timeout);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.ManagerServiceView=jscape.ui.FormView.extend({TIMEOUT_FACTOR:1000,initialize:function(){this.fieldset=$("#manager-service-fields").layout({fit:true,doSize:false,border:false});this.enabled=$("input[name=enabled]:checkbox",this.fieldset).change($.proxy(this._onForm$Change,this));this.host=$("select[name=host]",this.fieldset).combobox({required:true,validType:"non_empty",missingMessage:window.R.string.MANAGER_SERVICE_ERROR_BAD_HOST,onChange:$.proxy(this._onForm$Change,this),width:"30%",panelMinWidth:255,panelWidth:"auto",panelHeight:"auto"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:"15%"});this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({required:true,min:1,max:9999,onChange:$.proxy(this._onForm$Change,this),width:"15%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._adjustButtonsBarLayout(this.fieldset);this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.ManagerServiceView.LISTENER;this.fieldset.layout("resize");},refresh:function(){this.listener.onLoadData();},getEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getHost:function(){return this.host.combobox("getValue");},setHost:function(value){this.host.combobox("select",value).combobox("validate");},setHosts:function(values){this.host.combobox("loadData",$.map(values,$.proxy(function(value){return{text:this._formatHostname(value),value:value};},this)));},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",value).numberspinner("validate");},getTimeout:function(){return parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setTimeout:function(value){this.timeout.numberspinner("setValue",value/this.TIMEOUT_FACTOR).numberspinner("validate");},_formatHostname:function(value){return jscape.ServerParameters.allHostsIpv4(value)?window.R.string.APPLICATION_HOST_ALL_IPV4:jscape.ServerParameters.allHostsIpv6(value)?window.R.string.APPLICATION_HOST_ALL_IPV6:value;},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this)).always($.proxy(this._adjustFieldState,this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onForm$Change:function(){this._adjustFieldState();this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);},_adjustFieldState:function(){var enabled=this.enabled.is(":checked");this.host.combobox(enabled?"enable":"disable");this.port.numberspinner(enabled?"enable":"disable");this.timeout.numberspinner(enabled?"enable":"disable");this.fieldset.form("validate");}});jscape.settings.ManagerServiceView.LISTENER={onLoadData:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.ManagerAccessController=Class.extend({DEFAULT_CONFIG:new jscape.ManagementAccessServiceConfiguration([new jscape.IPAccessRule("*.*.*.*","default access",true),new jscape.IPAccessRule("*:*:*:*:*:*:*:*","default access",true)],10*1000,3,60*1000,60*60*1000),view:null,config:null,rules:null,initialize:function(){this.addController=new jscape.settings.AddManagerAccessRuleController();this.editController=new jscape.settings.EditManagerAccessRuleController();this.deleteController=new jscape.settings.DeleteManagerAccessRuleController();this._initValidators();},start:function(){if(this.view==null){this.view=new jscape.settings.ManagerAccessView();}
this.view.show(this);},resume:function(){this.view.refresh();},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration());},onLoadData:function(){return jscape.API.getManagementAccessServiceConfiguration().catch(function(){return null;}).then($.proxy(function(config){this.config=config||this.DEFAULT_CONFIG;this.rules=this._copyRules(this.config);this._setupView(this.config,this.rules);},this));},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){return jscape.API.setManagementAccessServiceConfiguration(this._createConfiguration()).done($.proxy(function(config){this.config=config;},this)).done($.proxy(this._fireApplySuccess,this));},onDiscard:function(){this.rules=this._copyRules(this.config);this._setupView(this.config,this.rules);return $.Deferred().resolve().promise();},onAddRule:function(){this.addController.start().done($.proxy(this._ruleAdded,this));},onEditRule:function(rule){var index=$.inArray(rule,this.rules);if(index!=-1){this.editController.start(rule).done($.proxy(this._ruleEdited,this,index));}},onDeleteRule:function(rules){this.deleteController.start(rules).done($.proxy(this._ruleDeleted,this,rules));},onRuleUp:function(rule){var index=$.inArray(rule,this.rules);this.rules.splice(index-1,2,this.rules[index],this.rules[index-1]);this.view.setAccessRules(this.rules);this.view.selectItem(rule);},onRuleDown:function(rule){var index=$.inArray(rule,this.rules);this.rules.splice(index,2,this.rules[index+1],this.rules[index]);this.view.setAccessRules(this.rules);this.view.selectItem(rule);},_ruleAdded:function(rule){this.rules.push(rule);this.view.setAccessRules(this.rules);this.view.selectItem(rule);},_ruleEdited:function(index,rule){this.rules[index]=rule;this.view.setAccessRules(this.rules);this.view.selectItem(rule);},_ruleDeleted:function(rules){var index=-1;while(rules.length){var rule=rules.pop();index=$.inArray(rule,this.rules);if(index!=-1){this.rules.splice(index,1);}}
this.view.setAccessRules(this.rules);if(this.rules.length){index=Math.max(0,Math.min(index,this.rules.length-1));this.view.selectItem(this.rules[index]);}},_copyRules:function(config){return $.extend(true,[],config?config.rules:[]);},_createConfiguration:function(){return new jscape.ManagementAccessServiceConfiguration(this.view.getAccessRules(),this.view.getAuthTimeout(),this.view.getDisableIpAttempts(),this.view.getDisableIpTimeout(),this.view.getRestoringTimeout());},_setupView:function(config,rules){this.view.setAccessRules(rules||[]);if(config){this.view.setAuthTimeout(config.authTimeout);this.view.setDisableIpAttempts(config.maxAuthAttempts);this.view.setDisableIpTimeout(config.maxAuthTimeout);this.view.setRestoringTimeout(config.restoringTimeout);}},_initValidators:function(){var v=new jscape.Validator();v.rule("ipaccess_unique",$.proxy(this._ruleNotExists,this),window.R.string.MANAGER_ACCESS_ERROR_RULE_EXISTS);},_ruleNotExists:function(value,excludes){for(var i=0;i<this.rules.length;i++){var mask=this.rules[i].mask;if(excludes&&$.inArray(mask,excludes)!=-1){continue;}
if(mask==value){return false;}}
return true;},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.IpAccessDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#ssma-dialog-ipaccess"),{width:530});this.fieldset=$("fieldset[name=manageripaccessfields]",this.dialog);this.mask=$("input[name=mask]",this.fieldset).textbox({required:true,validType:["non_empty","ipaccess_unique"],missingMessage:window.R.string.MANAGER_ACCESS_ERROR_BAD_MASK,invalidMessage:window.R.string.MANAGER_ACCESS_ERROR_BAD_MASK,width:"60%"});this.reason=$("input[name=reason]",this.fieldset).textbox({width:"60%"});this.access=$("input:radio[name=access]",this.fieldset);this.accessAllowed=this.access.filter("[value=allowed]");this.accessDenied=this.access.filter("[value=denied]");},show:function(listener){this._super(listener);this.mask.textbox("textbox").focus();},refresh:function(){this.listener.onLoadData();},getMask:function(){return this.mask.textbox("getValue");},setMask:function(value){this.mask.textbox("setValue",value);if(value&&value.trim().length){this.mask.textbox("textbox").validatebox("options").validType=["non_empty","ipaccess_unique['"+value+"']"];}},getReason:function(){return this.reason.textbox("getValue");},setReason:function(value){this.reason.textbox("setValue",value);},getAllowed:function(){return this.accessAllowed.is(":checked");},setAllowed:function(value){if(value){this.accessAllowed.prop("checked",true).change();}else{this.accessDenied.prop("checked",true);}}});jscape.settings.ManagerAccessView=jscape.ui.DatagridView.extend({TIMEOUT_FACTOR:1000,AUTH_TIMEOUT_FACTOR:60*1000,selection:null,listener:null,initialize:function(){this.selection=[];this.fieldset=$("#manager-access-fields");this.timeoutEnabled=$("input[name=timeoutenabled]:checkbox",this.fieldset).change($.proxy(this._onChange$TimeoutEnabled,this));this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({disabled:true,min:1,max:10,value:10,onChange:$.proxy(this._onForm$Change,this),width:60});this.disableIp=$("input[name=disableip]:checkbox",this.fieldset).change($.proxy(this._onChange$DisableIp,this));this.disableIpAttempts=$("input[name=disableipattempts]",this.fieldset).numberspinner({disabled:true,min:1,max:10,value:3,required:true,onChange:$.proxy(this._onForm$Change,this),width:60});this.disableIpTimeout=$("input[name=disableiptimeout]",this.fieldset).numberspinner({disabled:true,min:1,max:10,value:3,required:true,onChange:$.proxy(this._onForm$Change,this),width:60});this.restoringTimeout=$("input[name=restoringtimeout]",this.fieldset).numberspinner({disabled:true,min:0,max:1000,value:60,required:true,onChange:$.proxy(this._onForm$Change,this),width:60});this.data=$("table[role=grid][aria-label=accessrules]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,remoteSort:false,onSelect:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onLoadSuccess:$.proxy(this._adjustRowSelection,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),columns:[[{field:"mask",title:$("thead th:nth-child(1)",this.data).text(),width:60},{field:"allowed",title:$("thead th:nth-child(2)",this.data).text(),width:15,formatter:$.proxy(this._formatAccessAllowed,this),styler:$.proxy(this._styleAccessAllowed,this)},{field:"reason",title:$("thead th:nth-child(3)",this.data).text(),width:25}]]});this.moveUpButton=$("a[role=button][name=moveup]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveUpButton,this)});this.moveDownButton=$("a[role=button][name=movedown]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$MoveDownButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.ManagerAccessView.LISTENER;this.data.datagrid("resize");this._adjustRowSelection();this._onForm$Change();},refresh:function(){this.listener.onLoadData();},getAccessRules:function(){return this.data.datagrid("getRows");},setAccessRules:function(values){this.data.datagrid("loading").datagrid("loadData",values).datagrid("loaded");this.fieldset.triggerHandler("_change");},selectItem:function(value){this.data.datagrid("selectRow",this.data.datagrid("getRowIndex",value));},getAuthTimeout:function(){return this.timeoutEnabled.is(":checked")?parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR:null;},setAuthTimeout:function(value){if(value){this.timeout.numberspinner("setValue",value/this.TIMEOUT_FACTOR);}
this.timeoutEnabled.prop("checked",!!value).change();},getDisableIpAttempts:function(){return this.disableIp.is(":checked")?parseInt(this.disableIpAttempts.numberspinner("getValue")):null;},setDisableIpAttempts:function(value){if(value){this.disableIpAttempts.numberspinner("setValue",value);}
this.disableIp.prop("checked",!!value).change();},getDisableIpTimeout:function(){return this.disableIp.is(":checked")?parseInt(this.disableIpTimeout.numberspinner("getValue"))*this.AUTH_TIMEOUT_FACTOR:null;},setDisableIpTimeout:function(value){if(value){this.disableIpTimeout.numberspinner("setValue",value/this.AUTH_TIMEOUT_FACTOR);}},getRestoringTimeout:function(){return this.disableIp.is(":checked")?parseInt(this.restoringTimeout.numberspinner("getValue"))*this.AUTH_TIMEOUT_FACTOR:null;},setRestoringTimeout:function(value){if(value){this.restoringTimeout.numberspinner("setValue",value/this.AUTH_TIMEOUT_FACTOR);}},_formatAccessAllowed:function(value){return!!value?"allowed":"denied";},_styleAccessAllowed:function(value){return!!value?"color:green":"color:red";},_onClick$MoveUpButton:function(){this.listener.onRuleUp(this.selection[0]);},_onClick$MoveDownButton:function(){this.listener.onRuleDown(this.selection[0]);},_onClick$AddButton:function(){this.listener.onAddRule();},_onClick$EditButton:function(){this.listener.onEditRule(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteRule(this.selection);},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onChange$TimeoutEnabled:function(){this.timeout.numberspinner(this.timeoutEnabled.is(":checked")?"enable":"disable");},_onChange$DisableIp:function(){var checked=this.disableIp.is(":checked");this.disableIpAttempts.numberspinner(checked?"enable":"disable");this.disableIpTimeout.numberspinner(checked?"enable":"disable");this.restoringTimeout.numberspinner(checked?"enable":"disable");},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.moveUpButton,this.moveDownButton,"-",this.applyButton,this.discardButton],parent);},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");var index=this.selection.length==1?this.data.datagrid("getRowIndex",this.selection[0]):-1;var count=this.data.datagrid("getRows").length;this.moveUpButton.linkbutton(index>0&&index<=count-1?"enable":"disable");this.moveDownButton.linkbutton(index>=0&&index<count-1?"enable":"disable");this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.settings.ManagerAccessView.LISTENER={onAddRule:$.noop,onEditRule:$.noop,onDeleteRule:$.noop,onRuleUp:$.noop,onRuleDown:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.AddManagerAccessRuleController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var rule=this._createAccessRule(dialog);dialog.destroy();this.deferred.resolve(rule);this.deferred=null;},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createAccessRule:function(dialog){return new jscape.IPAccessRule(dialog.getMask(),dialog.getReason(),dialog.getAllowed());},_setupDialog:function(){var dialog=new jscape.settings.IpAccessDialog();dialog.setTitle(window.R.string.MANAGER_ACCESS_ADD_TITLE);dialog.setAllowed(true);return dialog;}});jscape.settings.EditManagerAccessRuleController=Class.extend({deferred:null,start:function(rule){this.deferred=$.Deferred();this._setupDialog(rule).show(this);return this.deferred.promise();},onSubmit:function(dialog){var rule=this._createAccessRule(dialog);dialog.destroy();this.deferred.resolve(rule);this.deferred=null;},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createAccessRule:function(dialog){return new jscape.IPAccessRule(dialog.getMask(),dialog.getReason(),dialog.getAllowed());},_setupDialog:function(rule){var dialog=new jscape.settings.IpAccessDialog();dialog.setTitle(window.R.string.MANAGER_ACCESS_EDIT_TITLE);dialog.setMask(rule.mask);dialog.setReason(rule.reason);dialog.setAllowed(rule.allowed);return dialog;}});jscape.settings.DeleteManagerAccessRuleController=Class.extend({deferred:null,start:function(rules){var text=$.map(rules,function(rule){return rule.mask;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.MANAGER_ACCESS_CONFIRM_DELETE_TITLE,window.R.string.MANAGER_ACCESS_CONFIRM_DELETE_MESSAGE.supplant({0:text}));}});jscape.settings.AdministratorsController=jscape.ui.DatagridController.extend({username:null,view:null,initialize:function(themeLoader){this.themeLoader=themeLoader;this.addController=new jscape.settings.AddAdministratorController(this.themeLoader);this.editController=new jscape.settings.EditAdministratorController(this.themeLoader);this.copyController=new jscape.settings.CopyAdministratorController();this.deleteController=new jscape.settings.DeleteAdministratorController();this.stateController=new jscape.settings.ChangeAdministratorStateController();jscape.API.getAdministrator().then(function(data){return data.username;},function(){return"";}).done($.proxy(function(username){this.username=username;},this));this._initValidators();},start:function(){if(this.view==null){this.view=new jscape.settings.AdministratorsView();}
this.view.show(this);},resume:function(){this.view.refresh();},onLoadData:function(){return jscape.API.getAdministrators();},onAdd:function(){this.addController.start().done($.proxy(this._adminAdded,this));},onCopy:function(admin){this.copyController.start(admin).done($.proxy(this._adminCopied,this));},onEdit:function(admin,force){var index=$.inArray(admin,this.view.getAdministrators());if(index!=-1||force===true){this.editController.start(admin,this._hasEnabledAdministrators(admin),this.username).done($.proxy(this._adminEdited,this,index))}},onDelete:function(admin){if(!this._hasEnabledAdministrators(admin)){this._alertNoEnabledAdministrators();return;}
this.deleteController.start([admin]).done($.proxy(this._adminDeleted,this,[admin]));},onEnable:function(admin){var index=$.inArray(admin,this.view.getAdministrators());if(index!=-1){this.stateController.start(admin,true).done($.proxy(this._adminStateChanged,this,index)).done($.proxy(this._fireApplySuccess,this));}},onDisable:function(admin){if(!this._hasEnabledAdministrators(admin)){this._alertNoEnabledAdministrators();return;}
var index=$.inArray(admin,this.view.getAdministrators());if(index!=-1){this.stateController.start(admin,false).done($.proxy(this._adminStateChanged,this,index)).done($.proxy(this._fireApplySuccess,this));}},_adminAdded:function(admin){this._recordAdded(admin);},_adminEdited:function(index,admin){this._recordEdited(admin);},_adminCopied:function(admin,editAfterDone){if(editAfterDone){this.view.refresh($.proxy(function(){this.view.selectRecord(admin);this.onEdit(admin,true);},this));}else{this._adminAdded(admin);}},_adminDeleted:function(admins){this._recordDeleted(admins);},_adminStateChanged:function(index,admin){this._reloadAndSelect(admin);},_alertNoEnabledAdministrators:function(){$.messager.alert(window.R.string.APPLICATION_ERROR_TITLE,window.R.string.ADMINISTRATORS_ERROR_NO_ENABLED_ADMINS,"error");},_initValidators:function(){var v=new jscape.Validator();v.nonEmptyRule("admin_login_nonempty",window.R.string.ADMINISTRATORS_ERROR_BAD_LOGIN);v.rule("admin_unique",$.proxy(this._loginNotExists,this),window.R.string.ADMINISTRATORS_ERROR_LOGIN_EXISTS);v.rule("admin_confirmpwd",$.proxy(this._passwordConfirmed,this),window.R.string.ADMINISTRATORS_ERROR_PASSWORDS_NOT_MATCH);},_hasEnabledAdministrators:function(exceptAdmin){return $.map(this.view.getAdministrators(),function(admin){return admin!=exceptAdmin&&admin.enabled?admin:null;}).length!=0;},_loginNotExists:function(value){var admins=this.view.getAdministrators();for(var i=0;i<admins.length;i++){if(admins[i].username==value){return false;}}
return true;},_passwordConfirmed:function(value,params){return value==$(params[0]).val();},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.AddAdministratorController=Class.extend({deferred:null,initialize:function(themeLoader){this.themeLoader=themeLoader;},start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onLoadRoles:function(){return jscape.API.getManagementRoles();},onChangeTheme:function(dialog){var c=new jscape.themes.WebThemeConfigurationController(this.themeLoader,$("#admin-themes-template"),true);return c.start(dialog.getTheme(),dialog.getCustomTheme()).done(function(theme,customData){dialog.setTheme(theme);dialog.setCustomTheme(customData);});},onSubmit:function(dialog){return jscape.API.addAdministrator(this._createAdministrator(dialog)).done($.proxy(function(admin){this.deferred.resolve(admin);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createAdministrator:function(dialog){var admin=new jscape.Administrator(dialog.getName(),dialog.getLogin(),dialog.getEnabled(),dialog.getRole(),dialog.getPhone(),dialog.getTheme(),!!dialog.getCustomTheme()?$.extend({},dialog.getCustomTheme(),{name:dialog.getTheme()}):null,dialog.isSystem(),dialog.getUseMultiFactorAuthentication());admin.password=dialog.getPassword();return admin;},_setupDialog:function(){var dialog=new jscape.settings.AddAdministratorDialog();dialog.setEnabled(true);dialog.setSystem(false);return dialog;}});jscape.settings.EditAdministratorController=Class.extend({deferred:null,initialize:function(themeLoader){this.themeLoader=themeLoader;},start:function(admin,allowChangeEnabledState,me){this.deferred=$.Deferred();this.username=admin.username;this.current=this.username===me;jscape.API.getAdministrator(this.username).done($.proxy(function(admin){this._setupDialog(admin,allowChangeEnabledState).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},onSubmit:function(dialog){var admin=this._createAdministrator(dialog);return jscape.API.setAdministrator(this.username,admin).done($.proxy(function(){this.deferred.resolve(admin);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},onLoadRoles:function(){return jscape.API.getManagementRoles();},onChangeTheme:function(dialog){var c=new jscape.themes.WebThemeConfigurationController(this.themeLoader,$("#admin-themes-template"),true);return c.start(dialog.getTheme(),dialog.getCustomTheme()).done(function(theme,customData){dialog.setTheme(theme);dialog.setCustomTheme(customData);});},onChangePassword:function(dialog){var c=new jscape.settings.ChangePasswordController();return c.start(this.username,this.current).done($.proxy(this._onDataChanged,this,dialog));},onResetTotpKey:function(dialog){return jscape.API.resetAdministratorTotp(this.username).done($.proxy(function(){this._showMessageTotpKeyReset();this._onDataChanged(dialog);},this));},_onDataChanged:function(dialog){jscape.API.getAdministrator(this.username).done($.proxy(function(admin){admin=$.extend(admin,this._createAdministrator(dialog));this._setupView(dialog,admin);},this)).fail($.proxy(this._onCancel,this,dialog));},_createAdministrator:function(dialog){return new jscape.Administrator(dialog.getName(),this.username,dialog.getEnabled(),dialog.getRole(),dialog.getPhone(),dialog.getTheme(),!!dialog.getCustomTheme()?$.extend({},dialog.getCustomTheme(),{name:dialog.getTheme()}):null,dialog.isSystem(),dialog.getUseMultiFactorAuthentication());},_setupDialog:function(admin,allowChangeEnabledState){var dialog=new jscape.settings.EditAdministratorDialog();this._setupView(dialog,admin);dialog.setEnabledChangeAllowed(allowChangeEnabledState);return dialog;},_setupView:function(dialog,admin){dialog.setName(admin.name);dialog.setLogin(admin.username);dialog.setEnabled(admin.enabled);dialog.setPhone(admin.phone);dialog.setTheme(admin.theme);dialog.setCustomTheme(admin.customUiTheme);dialog.setSystem(admin.systemAdministrator);dialog.setUseMultiFactorAuthentication(admin.multiFactorAuthenticationRequired);dialog.setRole(admin.roles);return dialog;},_showMessageTotpKeyReset:function(){$.messager.alert("",window.R.string.ADMINISTRATORS_SUCCESS_RESET_TOTP,"info");}});jscape.settings.AdministratorDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog,options){this._super(dialog,options);var initializing=true;this.name=$("input[name=name]",this.fieldset).textbox({width:"60%"});this.role=$("select[name=role]",this.fieldset).combobox({required:true,multiple:true,editable:false,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Roles,this),width:"50%",panelMinHeight:50,panelHeight:"auto",panelMaxHeight:"50%"});this.phoneCode=$("input[name=phonecode]",this.fieldset).textbox({validType:"pattern['^[\\\\d]+$']",invalidMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_PHONE,width:60});this.phoneNumber=$("input[name=phonenum]",this.fieldset).textbox({validType:"pattern['^[\\\\d- ]+$']",invalidMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_PHONE,width:120});this.phoneExtension=$("input[name=phoneext]",this.fieldset).textbox({validType:"pattern['^[\\\\d- ]+$']",invalidMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_PHONE,width:60});this.enableTheme=$("input[name=usetheme]:checkbox",this.fieldset).change($.proxy(this._onChange$EnableTheme,this));this.theme=$("input[name=theme]",this.fieldset).textbox({required:false,editable:false,readonly:true,width:"20%",minWidth:200});this.theme.textbox("textbox").click($.proxy(function(){this.changeThemeButton.click();},this));this.changeThemeButton=$("a[role=button][name=changetheme]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ChangeThemeButton,this)});this.enabled=$("input[name=enabled]:checkbox",this.fieldset);this.system=$("input[name=system]",this.fieldset).change($.proxy(this._onChange$System,this));this.useMultiFactorAuth=$("input[name=multifactorauth]",this.fieldset);initializing=false;},container:function(){return this.fieldset;},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value);},getEnabled:function(){return this.enabled.prop("checked");},setEnabled:function(value){this.enabled.prop("checked",value);},setEnabledChangeAllowed:function(value){if(!value){this.enabled.prop("readonly",true).prop("disabled",true).click(function(){return false;});}},getRole:function(){return this.role.combobox("options").disabled?[]:this.role.combobox("getValues");},setRole:function(values){this.role.combobox("setValues",values);},getPhone:function(){var code=this.phoneCode.textbox("isValid")?this.phoneCode.textbox("getValue"):null;var number=this.phoneNumber.textbox("isValid")?this.phoneNumber.textbox("getValue"):null;var ext=this.phoneExtension.textbox("isValid")?this.phoneExtension.textbox("getValue"):null;return $.isNumeric(code)||$.isNumeric(number)?new jscape.Phone(code,number,ext):undefined;},setPhone:function(value){if(!!value){value.code!=null&&this.phoneCode.textbox("setValue",value.code);value.number!=null&&this.phoneNumber.textbox("setValue",value.number);value.extension!=null&&this.phoneExtension.textbox("setValue",value.extension);}},getTheme:function(){var theme=this.theme.textbox("getValue");return this.enableTheme.is(":checked")?this.customData?this.customData.name||theme:theme:null;},setTheme:function(value){this.enableTheme.prop("checked",!!value).change();if(value&&typeof value=="object"&&value.hasOwnProperty("name")){value.name&&this.theme.textbox("setText",value.name+" (custom)");}else{this.theme.textbox("setValue",value);}},getCustomTheme:function(){return this.enableTheme.is(":checked")?this.customData:null;},setCustomTheme:function(value){this.customData=value;!!value&&this.setTheme(value);},isSystem:function(){return this.system.is(":checked");},setSystem:function(value){this.system.prop("checked",!!value).change();},getUseMultiFactorAuthentication:function(){return this.useMultiFactorAuth.is(":checked");},setUseMultiFactorAuthentication:function(value){this.useMultiFactorAuth.prop("checked",!!value).change();},show:function(listener){this._super(listener||jscape.settings.AdministratorDialog.LISTENER);this.enableTheme.change();this.system.change();this.role.combobox("reload");this.name.textbox("textbox").focus();},_formatTheme:function(name,customData){return(name||"")+(!!name&&!!customData?" (custom)":"");},_onLoad$Roles:function(params,success,error){this.listener.onLoadRoles(params).done(success).fail(error);},_onChange$System:function(){this.role.combobox(this.isSystem()?"disable":"enable").combobox(this.isSystem()?"disableValidation":"enableValidation");},_onChange$EnableTheme:function(){var enabled=this.enableTheme.is(":checked");this.theme.textbox(enabled?"enable":"disable");this.changeThemeButton.linkbutton(enabled?"enable":"disable");},_onClick$ChangeThemeButton:function(){this.changeThemeButton.linkbutton("disable");this.listener.onChangeTheme(this).always($.proxy(function(){this.changeThemeButton.linkbutton("enable");},this));}});jscape.settings.AdministratorDialog.LISTENER={onLoadRoles:$.noop,onChangeTheme:$.noop};jscape.settings.AddAdministratorDialog=jscape.settings.AdministratorDialog.extend({initialize:function(){this._super($("#d-ssms-admin-add"),{width:"50%",minWidth:650,height:"60%"});this.login=$("input[name=login]",this.fieldset).textbox({required:true,validType:["admin_login_nonempty","admin_unique"],missingMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_LOGIN,width:"60%"});this.password=$("input[name=password]",this.fieldset).passwordbox2({required:true,missingMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_PASSWORD,width:"50%"});this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({required:true,validType:"admin_confirmpwd['#"+this.password.textbox("textbox").attr("id")+"']",missingMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_PASSWORD,width:"50%"});},getLogin:function(){return this.login.textbox("getValue");},getPassword:function(){return this.password.passwordbox2("getValue");},show:function(listener){this._super(listener);this.login.textbox("textbox").focus();}});jscape.settings.EditAdministratorDialog=jscape.settings.AdministratorDialog.extend({initialize:function(){this._super($("#d-ssms-admin-edit"),{width:"50%",minWidth:650,height:"60%"});this.login=$("input[name=login]",this.fieldset).textbox({disabled:true,readonly:true,width:"50%"});this.resetTotpKeyButton=$("a[role=button][name=resettotp]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ResetTotpKeyButton,this)});this.changePasswordButton=$("a[role=button][name=changepwd]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ChangePasswordButton,this)});this.useMultiFactorAuth.change($.proxy(this._onChange$UseMultiFactorAuth,this));},show:function(listener){this._super(listener||jscape.settings.EditAdministratorDialog.LISTENER);this.useMultiFactorAuth.change();},setLogin:function(value){this.login.textbox("setValue",value).textbox("disable");},_onClick$ChangePasswordButton:function(){this.changePasswordButton.linkbutton("disable");this.listener.onChangePassword(this).always($.proxy(function(){this.changePasswordButton.linkbutton("enable");},this));},_onClick$ResetTotpKeyButton:function(){this.resetTotpKeyButton.linkbutton("disable");this.listener.onResetTotpKey(this).always($.proxy(function(){this.resetTotpKeyButton.linkbutton("enable");},this));},_onChange$UseMultiFactorAuth:function(){this.resetTotpKeyButton.linkbutton(this.getUseMultiFactorAuthentication()?"enable":"disable");}});jscape.settings.EditAdministratorDialog.LISTENER=$.extend({},jscape.settings.AdministratorDialog.LISTENER,{onChangePassword:$.noop,onResetTotpKey:$.noop});jscape.settings.CopyAdministratorController=Class.extend({deferred:null,start:function(admin){this.oldName=admin.username;this.deferred=$.Deferred();this._setupDialog(admin.username).show(this);return this.deferred.promise();},onSubmit:function(dialog){var editAfterDone=dialog.isEditAfterDone();return jscape.API.copyAdministrator(this.oldName,dialog.getLogin()).done($.proxy(function(data){this.deferred.resolve(data,editAfterDone);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(name){var dialog=new jscape.settings.CopyAdministratorDialog();dialog.setName(name);dialog.setEditAfterDone(true);return dialog;}});jscape.settings.CopyAdministratorDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-ssms-admin-copy"),{width:"40%",minWidth:530,maxWidth:700,minHeight:260});this.title=this.dialog.dialog("header").text();this.login=$("input[name=login]",this.fieldset).textbox({required:true,validType:["admin_login_nonempty","admin_unique"],delay:1500,missingMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_LOGIN,width:"60%"});this.editAfterDone=$("input[name=editafterdone]:checkbox",this.fieldset);},getLogin:function(){return this.login.textbox("getValue");},setName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:value}));this.login.textbox("setValue",value);},isEditAfterDone:function(){return this.editAfterDone.is(":checked");},setEditAfterDone:function(value){this.editAfterDone.prop("checked",!!value);},show:function(listener){this._super(listener);this.login.textbox("textbox").select().focus();}});jscape.settings.ChangePasswordController=Class.extend({deferred:null,start:function(username,current){this.username=username;this.deferred=$.Deferred();this._setupDialog(current).show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.changeAdministratorPassword(this.username,dialog.getPassword(),dialog.getCurrentPassword()).done($.proxy($.proxy(this._showPasswordChangedMessage,this))).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(current){return new jscape.settings.ChangePasswordDialog(current);},_showPasswordChangedMessage:function(){$.messager.alert(window.R.string.ADMINISTRATORS_PASSWORD_CHANGED_TITLE,window.R.string.ADMINISTRATORS_PASSWORD_CHANGED_MESSAGE,"info");}});jscape.settings.ChangePasswordDialog=jscape.ui.DefaultDialog.extend({initialize:function(current){this._super($("#d-ssms-admin-changepwd"),{width:"40%",minWidth:530,maxWidth:700,minHeight:280});if(!current){$("input[name=oldpassword]",this.fieldset).parent(".row").hide();}else{this.oldPassword=$("input[name=oldpassword]",this.fieldset).passwordbox2({width:"60%"});}
this.newPassword=$("input[name=newpassword]",this.fieldset).passwordbox2({required:true,missingMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_PASSWORD,width:"60%"});this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({required:true,validType:"admin_confirmpwd['#"+this.newPassword.textbox("textbox").attr("id")+"']",missingMessage:window.R.string.ADMINISTRATORS_ERROR_BAD_PASSWORD,invalidMessage:window.R.string.ADMINISTRATORS_ERROR_PASSWORDS_NOT_MATCH,width:"60%"});},getCurrentPassword:function(){return this.oldPassword&&this.oldPassword.length?this.oldPassword.passwordbox2("getValue"):null;},getPassword:function(){return this.newPassword.passwordbox2("getValue");}});jscape.settings.DeleteAdministratorController=Class.extend({deferred:null,start:function(admins){this.deferred=$.Deferred();this._confirmDelete(admins).done($.proxy(this._deleteConfirmed,this,admins)).fail($.proxy(this.cancel,this));return this.deferred.promise();},cancel:function(){this.deferred.reject();this.deferred=null;},_confirmDelete:function(admins){var text=$.map(admins,function(admin){return admin.username;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.ADMINISTRATORS_CONFIRM_DELETE_TITLE,window.R.string.ADMINISTRATORS_CONFIRM_DELETE_MESSAGE.supplant({0:text}));},_deleteConfirmed:function(admins){$.when.apply(jQuery,$.map(admins,$.proxy(function(admin){return jscape.API.deleteAdministrator(admin.username);},this))).done($.proxy(function(){this.deferred.resolve(admins);this.deferred=null;},this)).fail($.proxy(this.cancel,this));}});jscape.settings.ChangeAdministratorStateController=Class.extend({deferred:null,start:function(admin,enabled){this.deferred=$.Deferred();enabled=!!enabled;jscape.API.getAdministrator(admin.username).then($.proxy(function(administrator){administrator.enabled=enabled;return jscape.API.setAdministrator(administrator.username,administrator);},this)).done($.proxy(function(){admin.enabled=enabled;this.deferred.resolve(admin);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();}});jscape.settings.AdministratorsView=jscape.ui.DatagridView.extend({selection:null,listener:null,initialize:function(){var initializing=true;this.fieldset=$("#system-administrators-fields");this.data=$("table[role=grid][aria-label=systemadministrators]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:true,idField:"username",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:130},{field:"username",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:130},{field:"roles",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:150,formatter:function(value){return value.join(", ").escapeXml();}},{field:"enabled",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:80,formatter:function(value){return value?"enabled":"disabled";},styler:function(value){return value?"color:green":"color:grey";}}]],onSelect:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onSortColumn:$.proxy(this._adjustButtonsState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),onLoadSuccess:$.proxy(this._adjustRowSelection,this),});this.enableButton=$("a[role=button][name=enable]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EnableButton,this)});this.disableButton=$("a[role=button][name=disable]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DisableButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.copyButton=$("a[role=button][name=copy]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.settings.AdministratorsView.LISTENER;this.data.datagrid("resize");this._adjustRowSelection();},getAdministrators:function(){return this.getRecords();},_onClick$AddButton:function(){this.listener.onAdd();},_onClick$EditButton:function(){this.listener.onEdit(this.selection[0]);},_onClick$CopyButton:function(){this.listener.onCopy(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDelete(this.selection[0]);},_onClick$EnableButton:function(){this.listener.onEnable(this.selection[0]);},_onClick$DisableButton:function(){this.listener.onDisable(this.selection[0]);},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.copyButton,this.deleteButton,"-",this.enableButton,this.disableButton]);},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");this._adjustButtonsState();},_adjustButtonsState:function(){var admin=this.selection.length==1?this.selection[0]:null;this.enableButton.linkbutton(admin&&!admin.enabled?"enable":"disable");this.disableButton.linkbutton(admin&&admin.enabled?"enable":"disable");this.editButton.linkbutton(admin!=null?"enable":"disable");this.copyButton.linkbutton(admin!=null?"enable":"disable");this.deleteButton.linkbutton(admin!=null?"enable":"disable");}});jscape.settings.AdministratorsView.LISTENER={onLoadData:$.noop,onAdd:$.noop,onEdit:$.noop,onCopy:$.noop,onDelete:$.noop,onEnable:$.noop,onDisable:$.noop};jscape.settings.ManagerLogRecordsController=Class.extend({view:null,initialize:function(){this.exportController=new jscape.settings.ExportManagerLogRecordsController();this.purgeController=new jscape.settings.PurgeManagerLogRecordsController();},start:function(){if(this.view==null){this.view=new jscape.settings.ManagerLogRecordsView();}
this.view.show(this);},resume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listManagementLogRecords(params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onLoadSuggestions:function(params){params=jscape.Page.requestParameters(params);return jscape.API.getManagementLogRecordsSuggestions(params.query).then(function(data){return $.map(data||[],function(d){return d.text||[];});});},hasChanged:function(){return false;},onPurge:function(){return this.purgeController.start().always($.proxy(function(){this.view.firstPage();},this));},onExport:function(){return this.exportController.start();}});jscape.settings.ManagerLogServiceController=Class.extend({DEFAULT_CONFIG:new jscape.ManagementLogServiceConfiguration(),config:null,view:null,start:function(){if(this.view==null){this.view=new jscape.settings.ManagerLogSettingsView();}
this.view.show(this);},resume:function(){this.view.refresh();},onLoadData:function(){return jscape.API.getManagementLogServiceConfiguration().catch(function(){return null;}).then($.proxy(function(config){this.config=config||this.DEFAULT_CONFIG;this._setupView(this.config);},this));},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfiguration());},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){return jscape.API.setManagementLogServiceConfiguration(this._createConfiguration()).done($.proxy(function(config){this.config=config;this._fireApplySuccess();},this));},onDiscard:function(){this._setupView(this.config);},_createConfiguration:function(){return new jscape.ManagementLogServiceConfiguration(this.view.getLogExpirationPeriod());},_setupView:function(config){if(config){this.view.setLogExpirationPeriod(config.recordExpirationPeriodMillis);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.ManagerLogRecordsView=jscape.ui.DatagridView.extend({initialize:function(){var initializing=true;this.fieldset=$("#manager-log-records-fields");this.data=$("table[role=grid][aria-label=records]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"date",sortOrder:"desc",pageList:[50,100,1000],columns:[[{field:"date",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,formatter:$.proxy(this._formatDate,this),finder:"datebox",width:"13%"},{field:"appInstanceId",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,finder:this._createFinder("combobox",{loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"appInstanceId"}}),width:"15%"},{field:"clientHost",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"11%"},{field:"clientPort",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,formatter:$.proxy(this._formatPort,this),finder:this._createFinder("numberspinner",{min:1,max:65535}),width:"6%"},{field:"user",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,finder:this._createFinder("combobox",{loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"administrator"}}),width:"10%"},{field:"domain",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,finder:this._createFinder("combobox",{loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"domain"}}),width:"10%"},{field:"action",title:$("thead th:nth-child(7)",this.data).text(),sortable:true,finder:this._createFinder("combobox",{loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"logRecordAction"}}),width:"20%"},{field:"description",title:$("thead th:nth-child(8)",this.data).text(),sortable:true,finder:this._createFinder("combobox",{loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"logRecordDescription"},limitToList:false}),width:"15%"}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),onLoadSuccess:$.proxy(this._adjustState,this)});this.purgeButton=$("a[role=button][name=purge]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PurgeButton,this)});this.exportButton=$("a[role=button][name=export]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExportButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.settings.ManagerLogRecordsView.LISTENER;this.data.datagrid("resize");this._adjustState();},_formatDate:function(value){return $.isNumeric(value)&&value!=0?new Date(value).toLocaleString():"";},_formatPort:function(value){return String(value||"").escapeXml();},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onLoad$Suggestions:function(params,success,error){this.listener.onLoadSuggestions(params).then(success,error);},_onClick$PurgeButton:function(){this.purgeButton.linkbutton("disable");this.listener.onPurge().always($.proxy(function(){this.purgeButton.linkbutton("enable");},this));},_onClick$ExportButton:function(){this.exportButton.linkbutton("disable");this.listener.onExport().always($.proxy(function(){this.exportButton.linkbutton("enable");},this));},_showContextMenu:function(e){this._super(e,[this.purgeButton,"-",this.exportButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");var totalCount=parseInt(this.data.datagrid("getData").total)||0;this.purgeButton.linkbutton(totalCount>0?"enable":"disable");this.exportButton.linkbutton(totalCount>0?"enable":"disable");}});jscape.settings.ManagerLogRecordsView.LISTENER={onLoadData:$.noop,onExport:$.noop,onPurge:$.noop,onLoadSuggestions:$.noop};jscape.settings.ManagerLogSettingsView=jscape.ui.FormView.extend({TIME_FACTOR:24*60*60*1000,initialize:function(){this.fieldset=$("#manager-log-settings-fields");this.logExpires=$("input[name=logexpires]",this.fieldset).change($.proxy(this._onChange$LogExpires,this));this.logExpiresPeriod=$("input[name=logexpiresperiod]",this.fieldset).numberspinner({required:true,min:0,max:1000,value:0,onChange:$.proxy(this._onForm$Change,this),width:80});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.ManagerLogSettingsView.LISTENER;this._onForm$Change();},refresh:function(){this.listener.onLoadData();},getLogExpirationPeriod:function(){return this.logExpires.is(":checked")?parseInt(this.logExpiresPeriod.numberspinner("getValue"))*this.TIME_FACTOR:null;},setLogExpirationPeriod:function(value){if(value!=null){this.logExpiresPeriod.numberspinner("setValue",parseInt(value)/this.TIME_FACTOR).numberspinner("validate");}
this.logExpires.prop("checked",value!=null).change();},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard();},_onChange$LogExpires:function(){var enabled=this.logExpires.is(":checked");this.logExpiresPeriod.numberspinner(enabled?"enable":"disable");},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.settings.ManagerLogSettingsView.LISTENER={onLoadData:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.ManagerSyslogController=Class.extend({DEFAULT_CONFIG:new jscape.ManagementSyslogServiceConfiguration("",514,1,"MFT Server",false,null,null),view:null,config:null,start:function(){if(this.view==null){this.view=new jscape.settings.ManagerSyslogView();}
this.view.show(this);},resume:function(){this.view.refresh();},hasChanged:function(){return this.config&&!Object._equals(this.config,this._createConfig());},onLoadData:function(){return this._loadConfig().done($.proxy(function(config){this.config=config;this._setupView(this.config);},this));},onLoadClientKeys:function(){return $.when(jscape.API.getClientCertificates()).then((clientCertificates)=>{var globalCertificates=$.grep(clientCertificates,function(certificate){return certificate.domain==="";});var clientCertificateNames=$.map(globalCertificates,function(certificate){return certificate.name;});return $.Deferred().resolve(clientCertificateNames);});},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onApply:function(){return this._saveConfig(this._createConfig()).done($.proxy(function(config){this.config=config;this._fireApplySuccess();},this));},onDiscard:function(){this.view.refresh();},_loadConfig:function(){return jscape.API.getManagementSyslogServiceConfiguration().catch($.proxy(function(){return this.DEFAULT_CONFIG;},this));},_saveConfig:function(config){return jscape.API.setManagementSyslogServiceConfiguration(config).fail($.proxy(function(jqXhr){if(jscape.API.invalidParametersResponse(jqXhr)){this._loadConfig();}},this));},_createConfig:function(){return new jscape.ManagementSyslogServiceConfiguration(this.view.getHost(),this.view.getPort(),this.view.getFacility(),this.view.getProcessName(),this.view.isEnabled(),this.view.getEnableTcp(),this.view.getHostKey());},_setupView:function(data){if(data){this.view.setEnableTcp(data.enableTcp);this.view.setHostKey(data.hostkey);this.view.setFacility(data.facilityCode);this.view.setProcessName(data.processName);this.view.setEnabled(data.enabled);this.view.setPort(data.port);this.view.setHost(data.host);this.onLoadClientKeys().done($.proxy(function(clientCertificates){this.view.setHostKeys(clientCertificates);},this));}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.ManagerSyslogView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#manager-syslog-fields");this.enabled=$("input[name=enabled]:checkbox",this.fieldset).change($.proxy(this._onChange$Enabled,this));this.host=$("input[name=host]",this.fieldset).textbox({required:true,validType:"length[1,255]",onChange:$.proxy(this._onForm$Change,this),missingMessage:window.R.string.MANAGER_LOGS_ERROR_BAD_SYSLOG_HOST,invalidMessage:window.R.string.LOGGING_ERROR_BAD_SYSLOG_HOST,width:"40%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});this.enableTcp=$("input[name=enableTcp]:checkbox",this.fieldset).change($.proxy(function(){this.hostkey.combobox(this.enableTcp.is(":checked:not(:disabled)")?"enable":"disable");},this));this.hostkey=$("select[name=hostkey]",this.fieldset).combobox({limitToList:true,disabled:true,hasDownArrow:true,width:"40%",panelWidth:"auto",panelHeight:"auto",panelMaxHeight:150,onChange:$.proxy(this._onForm$Change,this),});this.facility=$("select[name=facility]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onForm$Change,this),width:"25%",panelWidth:"auto",panelHeight:"auto",panelMaxHeight:"40%"});this.process=$("input[name=processname]",this.fieldset).textbox({required:false,validType:"length[1,32]",onChange:$.proxy(this._onForm$Change,this),invalidMessage:window.R.string.MANAGER_LOGS_ERROR_BAD_SYSLOG_PROCESS_NAME,width:"40%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.ManagerSyslogView;this.enabled.change();},refresh:function(){this.listener.onLoadData();},isEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value);},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",parseInt(value));},getEnableTcp:function(){return this.enableTcp.is(":checked");},setEnableTcp:function(value){this.enableTcp.prop("checked",!!value).change();},getClientKeyCertificate:function(){return this.hostkey.combobox("getValues");},setClientKeyCertificate:function(value){this.hostkey.combobox("setValues",value);},setClientKeyCertificates:function(values){this.hostkey.combobox("loadData",values);},getHostKey:function(){var isEnableTcp=this.enableTcp.is(":checked");var hostKey=this.hostkey.combobox("getValue")
return isEnableTcp?hostKey:null;},setHostKey:function(value){this.enableTcp.prop("checked",value!=null).change();if(value!=null){this.hostkey.combobox("setValue",value);}},setHostKeys:function(values){this.hostkey.combobox("loadData",values);},getFacility:function(){return this.facility.combobox("getValue");},setFacility:function(value){this.facility.combobox("setValue",value);},getProcessName:function(){return this.process.textbox("getValue");},setProcessName:function(value){this.process.textbox("setValue",value);},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply(this).catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onChange$Enabled:function(){var enable=this.isEnabled();this.host.textbox(enable?"enable":"disable").textbox(enable?"enableValidation":"disableValidation");this.port.numberspinner(enable?"enable":"disable").numberspinner(enable?"enableValidation":"disableValidation");this.facility.combobox(enable?"enable":"disable");this.process.textbox(enable?"enable":"disable");this.fieldset.form("validate");},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.settings.ManagerSyslogView.LISTENER={onLoadData:$.noop,onChange:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.ManagerExtendedLogController=Class.extend({view:null,type:null,controllers:null,config:null,initialize:function(){this.configManager=$.extend(new jscape.settings.ConfigManager(),{doLoad_:$.proxy(this._loadConfig,this),doSave_:$.proxy(this._saveConfig,this),doTest_:$.proxy(this._testConfig,this)});this.configManager.subscribe(this);this.controllers={'NULL':new jscape.settings.NullExtendedLogsController(this.configManager),'SPLUNK':new jscape.settings.SplunkHttpLogsController(this.configManager)};},start:function(){$.each(this.controllers,function(_,c){c.onStart();});if(this.view==null){this.view=new jscape.settings.ManagerExtendedLogView();}
this.view.show(this);},resume:function(){this.view.refresh();},hasChanged:function(){return this.config!=null&&this._controller().hasChanged();},onLoadData:function(){return this.configManager.loadConfig().done($.proxy(function(config){this._setupView(config);},this));},onConfigurationChanged:function(config){this.config=config;},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onChangeType:function(type){this.type=type;$.each(this.controllers,$.proxy(function(t,c){if(this.type===t){c.onResume();}else{c.onPause();}},this));},onApply:function(){return this._controller().onApply();},onDiscard:function(){return this.view.refresh();},onTest:function(){return this._controller().onTest().done(function(){$.messager.alert("",window.R.string.MANAGER_LOGS_TEST_SUCCESS_MESSAGE,"info");});},_loadConfig:function(){return jscape.API.getManagementExtendedLogServiceConfiguration();},_saveConfig:function(config){if(!!this.__pausing){return $.Deferred().resolve(config).promise();}
return jscape.API.setManagementExtendedLogServiceConfiguration(config).fail($.proxy(function(jqXhr){if(jscape.API.invalidParametersResponse(jqXhr)){this._loadConfig();}},this));},_testConfig:function(config){return jscape.API.testManagementExtendedLogServiceConfiguration(config);},_setupView:function(config){if(config&&config.splunkHttpData){this.view.setEnabled(true);this.view.setType("SPLUNK");}else{this.view.setEnabled(false);}},_controller:function(){return this.controllers[this.view.getType()||"NULL"];}});jscape.settings.ManagerExtendedLogView=jscape.ui.FormView.extend({initialize:function(){this.fieldset=$("#manager-extendedlog-fields");this.enabled=$("input[name=enabled]:checkbox",this.fieldset).change($.proxy(this._onChange$Enabled,this));this.type=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,disabled:true,onChange:$.proxy(this._onChange$Type,this),width:"25%",panelWidth:"auto",panelHeight:"auto",panelMaxHeight:"40%"});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});this.testButton=$("a[role=button][name=test]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$TestButton,this)});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.ManagerExtendedLogView.LISTENER;this.enabled.change();},refresh:function(){this.listener.onLoadData();},isEnabled:function(){return this.enabled.is(":checked");},setEnabled:function(value){this.enabled.prop("checked",!!value).change();},getType:function(){return this.isEnabled()?this.type.combobox("getValue"):null;},setType:function(value){var selectedType=this.type.combobox("getValue");this.type.combobox("clear").combobox("select",value);if(selectedType===value){this._onForm$Change();}},_onClick$ApplyButton:function(){if(this._valid()){this.applyButton.linkbutton("disable");this.listener.onApply(this).catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this);},_onClick$TestButton:function(){if(this._valid()){this.testButton.linkbutton("disable");this.listener.onTest(this).always($.proxy(function(){this.testButton.linkbutton("enable");},this));}},_onChange$Enabled:function(){var enabled=this.isEnabled();this.type.combobox(enabled?"enable":"disable");this._onChange$Type();this.testButton.linkbutton(enabled?"enable":"disable");this.fieldset.find("fieldset[id]").triggerHandler("_enable",[enabled]);this.fieldset.form("validate");},_onChange$Type:function(){this.listener.onChangeType(this.getType());},_onForm$Change:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_showContextMenu:function(e,_,parent){this._super(e,[this.applyButton,this.discardButton],parent);}});jscape.settings.ManagerExtendedLogView.LISTENER={onLoadData:$.noop,onChange:$.noop,onTest:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.settings.NullExtendedLogsController=Class.extend({NULL_CONFIG:new jscape.ManagementExtendedLogConfiguration(null),config:null,initialize:function(publisher){this.publisher=publisher.subscribe(this);},onConfigurationChanged:function(config){this.config=config;},onStart:function(){},onPause:function(){},onResume:function(){},onStop:function(){},onApply:function(){return this.hasChanged()?this.publisher.saveConfig(this._createConfig()):$.Deferred().resolve(this.config).promise();},onDiscard:function(){return $.Deferred().resolve().promise();},onTest:function(){return $.Deferred().resolve().promise();},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfig());},_createConfig:function(){return this.NULL_CONFIG;}});jscape.settings.SplunkHttpLogsController=Class.extend({DEFAULTS:{port:8088,timeout:30*1000,sslRequired:true},view:null,config:null,initialize:function(publisher){this.publisher=publisher.subscribe(this);},onConfigurationChanged:function(config){this.config=config;},onStart:function(){if(this.view==null){this.view=new jscape.settings.SplunkHttpLogsView();}},onResume:function(){this._setupView(this.config);this.view.show(this);},onPause:function(){this.view.hide();},onStop:function(){this.view.destroy();},onApply:function(){return this.hasChanged()?this.publisher.saveConfig(this._createConfig()):$.Deferred().resolve(this.config).promise();},onDiscard:function(){this._setupView(this.config);return $.Deferred().resolve().promise();},onTest:function(){return this.publisher.testConfig(this._createConfig());},hasChanged:function(){return this.config!=null&&!Object._equals(this.config,this._createConfig());},_createConfig:function(){return jscape.ManagementExtendedLogConfiguration.splunkHttp(this.view.getHost(),this.view.getPort(),this.view.getTimeout(),this.view.isSslRequired(),this.view.getToken(),this.view.getSource(),this.view.getSourceType(),this.view.getIndex());},_setupView:function(config){if(this.view&&config){var data=config.splunkHttpData;if(data){this.view.setHost(data.host);this.view.setPort(data.port);this.view.setTimeout(data.timeout);this.view.setSslRequired(data.sslRequired);this.view.setToken(data.accessToken);this.view.setSource(data.source);this.view.setSourceType(data.sourceType);this.view.setIndex(data.index);}else{this.view.setPort(this.DEFAULTS.port);this.view.setTimeout(this.DEFAULTS.timeout);this.view.setSslRequired(this.DEFAULTS.sslRequired);}}}});jscape.settings.SplunkHttpLogsView=jscape.ui.FormView.extend({TIMEOUT_FACTOR:1000,initialize:function(){this.fieldset=$("#manager-splunklog-fields");this.host=$("input[name=host]",this.fieldset).textbox({required:true,onChange:$.proxy(this._onForm$Change,this),validType:"non_empty",missingMessage:window.R.string.MANAGER_LOGS_ERROR_BAD_SERVER_HOST,invalidMessage:window.R.string.MANAGER_LOGS_ERROR_BAD_SERVER_HOST,width:"60%"});this.port=$("input[name=port]",this.fieldset).numberspinner({required:true,min:1,max:65535,onChange:$.proxy(this._onForm$Change,this),width:100});this.timeout=$("input[name=timeout]",this.fieldset).numberspinner({required:true,min:1,max:60,onChange:$.proxy(this._onForm$Change,this),width:100});this.sslRequired=$("input[name=ssl]:checkbox",this.fieldset);this.token=$("input[name=token]",this.fieldset).passwordbox2({required:true,validType:"length[1,1024]",onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.source=$("input[name=source]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.sourceType=$("input[name=sourcetype]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),width:"40%"});this.index=$("input[name=index]",this.fieldset).textbox({required:false,onChange:$.proxy(this._onForm$Change,this),width:"40%"});this._bindEvents(this.fieldset);},show:function(listener){this.listener=listener||jscape.settings.SplunkHttpLogsView.LISTENER;this.fieldset.triggerHandler("_change");this._onForm$Enable(undefined,true);},hide:function(){this._onForm$Enable(undefined,false);},destroy:function(){this.host.textbox("destroy");this.port.numberspinner("destroy");this.timeout.numberspinner("destroy");},getHost:function(){return this.host.textbox("getValue");},setHost:function(value){this.host.textbox("setValue",value||"");},getPort:function(){return parseInt(this.port.numberspinner("getValue"));},setPort:function(value){this.port.numberspinner("setValue",value).numberspinner("validate");},getTimeout:function(){return parseInt(this.timeout.numberspinner("getValue"))*this.TIMEOUT_FACTOR;},setTimeout:function(value){this.timeout.numberspinner("setValue",value/this.TIMEOUT_FACTOR).numberspinner("validate");},isSslRequired:function(){return this.sslRequired.is(":checked");},setSslRequired:function(value){this.sslRequired.prop("checked",!!value).change();},getToken:function(){return this.token.passwordbox2("getValue");},setToken:function(value){this.token.passwordbox2("setValue",value);},getSource:function(){return this.source.textbox("getValue");},setSource:function(value){this.source.textbox("setValue",value||"");},getSourceType:function(){return this.sourceType.textbox("getValue");},setSourceType:function(value){this.sourceType.textbox("setValue",value||"");},getIndex:function(){return this.index.textbox("getValue");},setIndex:function(value){this.index.textbox("setValue",value||"");},_onForm$Change:function(){this.fieldset.closest("[role=group]").triggerHandler("_change");},_onForm$Enable:function(e,enabled){var enable=!!enabled;this.host.textbox(enable?"enable":"disable");this.port.numberspinner(enable?"enable":"disable");this.timeout.numberspinner(enable?"enable":"disable");this.sslRequired.prop("disabled",!enable);this.token.passwordbox2(enable?"enable":"disable");this.source.textbox(enable?"enable":"disable");this.sourceType.textbox(enable?"enable":"disable");this.index.textbox(enable?"enable":"disable");}});jscape.settings.SplunkHttpLogsView.LISTENER={};jscape.settings.ExportManagerLogRecordsController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.exportManagementLogRecords(dialog.getFilename()).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.ui.ExportDialog($("#d-managerlogs-export"));dialog.setFilename("manager_service.txt");return dialog;}});jscape.settings.PurgeManagerLogRecordsController=Class.extend({start:function(){return this._confirmPurge().then(function(){return jscape.API.purgeManagementLogRecords();});},_confirmPurge:function(){return jscape.ConfirmDialog.confirm(window.R.string.MANAGER_LOGS_CONFIRM_PURGE_TITLE,window.R.string.MANAGER_LOGS_CONFIRM_PURGE_MESSAGE,"warning");}});jscape.settings.ManagerDebugLoggingController=Class.extend({DEFAULT_CONFIG:[],config:null,view:null,start:function(){if(this.view==null){this.view=new jscape.settings.ManagerDebugLoggingView();}
this.view.show(this);},resume:function(){this.view.refresh();},pause:function(){this.view.discardChanges();},hasChanged:function(){return this.config&&!Object._equals(this.config,this._createConfiguration());},onLoadData:function(){return jscape.API.getDebugLoggingConfiguration().done($.proxy(function(config){this.config=config||this._copyConfiguration(this.DEFAULT_CONFIG);},this)).fail($.proxy(function(){this.config=this._copyConfiguration(this.DEFAULT_CONFIG);},this)).always($.proxy(function(){this._setupView(this.config);},this));},onApply:function(){var config=this._createConfiguration();return jscape.API.setDebugLoggingConfiguration(config).done($.proxy(function(){this.config=this._copyConfiguration(config);this._setupView(this.config);this._fireApplySuccess();},this));},onDiscard:function(){var config=this.config;this.config=this._copyConfiguration(config);this._setupView(this.config);return $.Deferred().resolve().promise();},onViewLog:function(){return new jscape.settings.ViewManagementDebugLogController().start();},_createConfiguration:function(){return this.view.getProperties();},_copyConfiguration:function(config){return[].concat(config);},_setupView:function(data){if(data&&this.view){this.view.setProperties(data);}},_fireApplySuccess:function(){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}});jscape.settings.ManagerDebugLoggingView=Class.extend({initialize:function(){this.fieldset=$("#debug-logging-config-fields").layout({fit:true,doSize:false,border:false});this.properties=$("textarea[name=properties]",this.fieldset).textbox({fit:true,required:true,multiline:true,readonly:true,disabled:true,cls:"noborder",inputEvents:$.extend({},$.fn.textbox.defaults.inputEvents,{keydown:$.proxy(function(e){if(e.keyCode==27){this.discardButton.click();}else{$.fn.textbox.defaults.inputEvents.keydown.call(e.data.target,e);}},this),blur:$.proxy(function(e){$.fn.textbox.defaults.inputEvents.blur.call(e.data.target,e);if(!(e.relatedTarget===this.applyButton[0]||e.relatedTarget===this.discardButton[0])){setTimeout($.proxy(this.discardChanges,this),50);}},this)})});this.viewLogButton=$("a[role=button][name=viewlog]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$ViewLogButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$EditButton,this)});this.applyButton=$("a[role=button][name=apply]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DiscardButton,this)});},show:function(listener){this.listener=listener||jscape.settings.ManagerDebugLoggingView.LISTENER;this.properties.textbox("resize");this._adjustButtonsState();},refresh:function(){this.listener.onLoadData();},discardChanges:function(){this.discardButton.click();},getProperties:function(){return this.properties.textbox("getValue").split(/[\r\n]/);},setProperties:function(value){var str=$.isArray(value)?value.join("\r\n"):String(value);this.properties.textbox("setValue",str);},_onClick$ViewLogButton:function(){this.viewLogButton.linkbutton("disable");this.listener.onViewLog().always($.proxy(function(){this.viewLogButton.linkbutton("enable");},this));},_onClick$EditButton:function(){this.editButton.linkbutton("disable");this._onBefore$Edit();this.properties.textbox("textbox").focus();},_onClick$ApplyButton:function(){if(this.fieldset.form("validate")){this.applyButton.linkbutton("disable");this.listener.onApply(this).done($.proxy(this._onAfter$Edit,this)).fail($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.listener.onDiscard(this).always($.proxy(this._onAfter$Edit,this));},_onBefore$Edit:function(){this.properties.textbox("enable").textbox("readonly",false);this._adjustButtonsState();},_onAfter$Edit:function(){this.properties.textbox("disable").textbox("readonly",true);this._adjustButtonsState();},_adjustButtonsState:function(){var opts=this.properties.textbox("options");if(!opts.readonly){this.editButton.linkbutton("disable").hide();this.applyButton.linkbutton("enable").show();this.discardButton.linkbutton("enable").show();}else{this.editButton.linkbutton("enable").show();this.applyButton.linkbutton("disable").hide();this.discardButton.linkbutton("disable").hide();}}});jscape.settings.ManagerDebugLoggingView.LISTENER={onLoadData:$.noop,onApply:$.noop,onDiscard:$.noop,onViewLog:$.noop};jscape.settings.ViewManagementDebugLogController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this.onLoadData("debug_log").done($.proxy(function(handle){if(handle&&handle.document){handle.document.title=window.document.title;this.deferred.resolve();}else{this._setupDialog(" ").show(this);}},this));return this.deferred;},onLoadData:function(params){return jscape.API.getDebugServerLog(params);},onCancel:function(dialog){dialog.destroy();this.deferred.resolve();this.deferred=null;},_setupDialog:function(title){var dialog=new jscape.settings.ViewManagementDebugLogDialog();dialog.setTitle(title);return dialog;}});jscape.settings.ViewManagementDebugLogDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("<div></div>").appendTo(document.body),{width:"85%",height:"90%",content:"<pre><code></code></pre>",buttons:[{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}]});this.title=this.dialog.dialog("header").text()||"";this.holder=this.dialog.find("pre");this.data=this.holder.find("code");},setTitle:function(value){this.dialog.dialog("setTitle",(""+value).escapeXml());},show:function(listener){this._super(listener||jscape.settings.ViewManagementDebugLogDialog);this._onLoad$Data();},_onLoad$Data:function(params){this.listener.onLoadData(params).then($.proxy(function(data){this.data.text(data||"");},this)).done($.proxy(this._onHighlight,this,"language-log language-javastacktrace"));},_onHighlight:function(type){if(!"Prism"in window){return;}
this.holder.addClass(type);this.data.addClass(type);try{Prism.highlightAllUnder(this.holder[0]);}catch(e){console.log(e.stack)}}});jscape.settings.ViewManagementDebugLogDialog.LISTENER={onLoadData:$.noop};