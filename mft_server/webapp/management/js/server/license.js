/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.server=jscape.server||{};jscape.server.LicenseModule=jscape.ApplicationModule.extend({onStart:function(){$(document).on("selectmenu",$.proxy(this._onSelect$MenuItem,this));},onStop:function(){$(document).off("selectmenu");},_onSelect$MenuItem:function(e,id){if("menu-license"==id){e.stopPropagation();this.onLicense();return false;}},onLicense:function(){var c=new jscape.LicenseController();c.start().done(function(message){$(document).triggerHandler("broadcast",message||window.R.string.APPLICATION_SUCCESS_APPLY);}).fail(function(message){if(!!message){$.messager.alert(window.R.string.APPLICATION_TITLE,message,"error");}});}});jscape.LicenseController=Class.extend({start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.importLicense(dialog.getFile()).done($.proxy(function(data){data=data||{};if(data.success){setTimeout(function(){$(document).triggerHandler("changelicense");},50);this.deferred.resolve(data.message);}else{this.deferred.reject(data.message);}},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.LicenseDialog();}});jscape.LicenseDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-license-import"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=importlicensefields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,width:"60%"});},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});