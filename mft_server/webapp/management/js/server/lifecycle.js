/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.server=jscape.server||{};jscape.server.ApplicationLifecycleController=Class.extend({DEFAULT_DELAY:10*1000,DEFAULT_STEP:30,STEP_FACTOR:.65,delay:0,timer:null,ptimer:null,deferred:null,initialize:function(view){this.view=view;},start:function(operation){this.progress=0;this.step=this.DEFAULT_STEP;this.delay=this.DEFAULT_DELAY;this.url=window.location.href||"/";this.deferred=$.Deferred();var promise=this.deferred.promise();operation=$.isFunction(operation)?operation:function(){return operation;};try{window.jscape.lifecycleOperationStarted=true;this._bindEvents();this._confirmStart().catch($.proxy(function(){return this.deferred.reject();},this)).then($.proxy(function(){return jscape.API.getServerParameters().then(function(data){return data?data.appVersion||"":""},function(){return"";});},this)).then($.proxy(function(version){this.appVersion=version;var ret=operation.apply(this,arguments);return $.isFunction(ret.promise)?ret.promise():$.Deferred().resolve(ret).promise();},this)).then($.proxy(function(){this._setupDialog();this._poll(this.delay);},this)).fail($.proxy(function(){this.stop();this.deferred.reject();},this));}catch(e){this.stop();this.deferred.reject();}
return promise;},stop:function(){this._stopPoll();this._unbindEvents();window.jscape.lifecycleOperationStarted=false;$.messager.progress("close");},_bindEvents:function(){$(window).on("beforeunload.applifecycle",$.proxy(this._onBeforeUnload,this));},_unbindEvents:function(){$(window).off("beforeunload.applifecycle");},_poll:function(delay){this._stopPoll();this.timer=setTimeout($.proxy(function(){this.timer=null;$.ajax(this.url,"HEAD").then($.proxy(this._onAvailable,this),$.proxy(function(xhr){this.step*=this.STEP_FACTOR;if(0===xhr.status){this._poll(this.delay);this._onProgress();}else{this._onAvailable();}},this));},this),delay||0);this._tick();},_tick:function(){var next=Math.max(0,Math.min(100,this.progress+this.step));if(next<100){var self=this;(function _t(){if(self.progress<next){self._progress(++self.progress);self.ptimer=setTimeout(_t,1000);}})();}},_stopPoll:function(){if(this.timer){clearTimeout(this.timer);this.timer=null;}
if(this.ptimer){clearTimeout(this.ptimer);this.ptimer=null;}},_onAvailable:function(){if(!this.appVersion){return this._onComplete();}
var version=this.appVersion;return jscape.API.getServerParameters().then($.proxy(function(data){if(this._complete(data,version)){this._onComplete();}else{this._poll(this.delay);}},this)).catch($.proxy(this._poll,this.delay));},_onProgress:function(){this.progress+=this.step;this._progress(this.progress);},_onComplete:function(){this._progress(100);this.stop();this.deferred.resolve();window.location.reload(true);},_onBeforeUnload:function(e){window.originalEvent=e;if(!!window.jscape.lifecycleOperationStarted){e.returnValue=this.view.confirmUnloadMessage();}
return e.returnValue||undefined;},_complete:function(data,version){return false;},_progress:function(value){this.view.onProgress(value);},_confirmStart:function(){return this.view.confirmStartDialog();},_setupDialog:function(){return this.view.showProgressDialog();}});