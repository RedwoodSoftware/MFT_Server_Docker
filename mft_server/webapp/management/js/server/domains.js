/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.server=jscape.server||{};jscape.server.DomainsDashboardAppication=jscape.Application.extend({initialize:function(){this._super();$(document).on("domaindeleted.app",$.proxy(this._onDomainDeleted,this));},destroy:function(){this._super();$(document).off("domaindeleted.app");},onReady:function(){this._super();this.view.show(this);},_onDomainDeleted:function(e,items){var domains=$.isArray(items)?items:typeof items==="string"?[items]:[];for(var i=0,len=domains.length;i<len;++i){this.menu.removeMenuItem_("menu-domains",domains[i]);}},_createView:function(){this._super();this.view=new jscape.server.DomainsDashboardView();}});jscape.server.DomainsDashboardView=jscape.DashboardView.extend({initialize:function(){this._super($("#modules[role=tablist]"));this.modules.tabs({fit:true,border:true,tabPosition:"top",onSelect:$.proxy(this._onSelect$Module,this)});this.modules.find("div[role=tablist]").filter(function(){return $(this).parents("div.dialog").length==0;}).each($.proxy(function(_,tablist){$(tablist).tabs({fit:true,border:false,onSelect:$.proxy(this._onSelect$Module,this)});},this));this.modules.find(">div.tabs-header>div.tabs-wrap").hover(function(){$(this).css({overflowY:"auto",overflowX:"hidden"});},function(){$(this).css({overflowY:"",overflowX:""});});},show:function(){this._super.apply(this,arguments);this.modules.tabs("unselect",0).tabs("select",0);}});jscape.server.DomainsModule=jscape.ApplicationModule.extend({DEFAULT_DELAY:30*1000,view:null,timerId:null,delay:0,onCreate:function(){this._super.apply(this,arguments);this.addController=new jscape.domain.NewDomainController();this.deleteController=new jscape.server.DeleteDomainController();this.statusController=new jscape.server.DomainStatusController();},onStart:function(){this.delay=this.DEFAULT_DELAY;if(this.view==null){this.view=new jscape.server.DomainsView();}
this.view.show(this);$(document).on("selectmenu",$.proxy(this._onSelect$MenuItem,this));},onStop:function(){this._stopPoll();this.statusController.stop();$(document).off("selectmenu");},onResume:function(){this.delay=this.DEFAULT_DELAY;this._poll(0);},onPause:function(){this._stopPoll();},onLoadData:function(params){if(this.loadingStatistics===true){this.delay*=2;return $.Deferred().reject().promise();}
params=jscape.Page.requestParameters(params);this.loadingStatistics=true;return jscape.API.getServerDomainsStatistics(params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter()).then($.proxy(function(data){this.delay=this.DEFAULT_DELAY;this.loadingStatistics=false;return data;},this),$.proxy(function(xhr){if(403==xhr.status){this._stopPoll();}else{this.delay*=2;}
this.loadingStatistics=false;return xhr;},this));},onLoadSuggestions:function(params){params=jscape.Page.requestParameters(params);if(!params.query){return $.Deferred().resolve([]).promise();}
return jscape.API.getServerDomainsStatisticsSuggestions(params.query).then(function(data){return $.map(data||[],function(d){return d.text||[];});});},onAddDomain:function(){return this.addController.start().then(function(domainName,editAfterDone){if(!!editAfterDone){jscape.API.editDomain(domainName);return $.Deferred().reject().promise();}
$(document).triggerHandler("broadcast",[window.R.string.DOMAIN_SUCCESS_ADD_MESSAGE]);return domainName;}).done($.proxy(this._domainAdded,this));},onEditDomain:function(domain){return jscape.API.editDomain(domain.domainName);},onDeleteDomain:function(domains){return this.deleteController.start(domains).done($.proxy(this._domainDeleted,this,domains)).done(function(names){$(document).triggerHandler("domaindeleted.app",[names])});},onDomainStartUp:function(domain){return jscape.API.setDomainAutoStart(domain.domainName,!domain.autoStartEnabled).done($.proxy(function(){this._reloadAndSelect(domain.domainName);},this));},onStartDomain:function(domains){return $.when($.map(domains,function(domain){return jscape.API.startDomain(domain.domainName);})).done($.proxy(function(){setTimeout($.proxy(this._reloadAndSelect,this,domains),500);},this)).fail($.proxy(this._reloadAndSelect,this,[]));},onStopDomain:function(domains){var names=$.map(domains,function(domain){return domain.domainName;});return this._confirmStopDomain(names).then(function(){return $.when($.map(names,function(domainName){return jscape.API.stopDomain(domainName);}));}).done($.proxy(function(){setTimeout($.proxy(this._reloadAndSelect,this,domains),500);},this)).fail($.proxy(this._reloadAndSelect,this,[]));},onPauseDomain:function(domains){var names=$.map(domains,function(domain){return domain.domainName;});return this._confirmPauseDomain(names).then(function(){return $.when($.map(names,function(domainName){return jscape.API.pauseDomain(domainName);}));}).done($.proxy(function(){setTimeout($.proxy(this._reloadAndSelect,this,domains),200);},this)).fail($.proxy(this._reloadAndSelect,this,[]));},onResumeDomain:function(domains){return $.when($.map(domains,function(domain){return jscape.API.resumeDomain(domain.domainName);},this)).done($.proxy(function(){setTimeout($.proxy(this._reloadAndSelect,this,domains),200);},this)).fail($.proxy(this._reloadAndSelect,this,[]));},onDomainStatus:function(domain){return this.statusController.start(domain);},_onSelect$MenuItem:function(e,id){if("menu-add-domain"==id){e.stopPropagation();this.onAddDomain();}},_confirmStopDomain:function(names){var message=names.length==1?window.R.string.DOMAIN_CONFIRM_STOP_MESSAGE.supplant({0:names[0]}):window.R.string.DOMAIN_CONFIRM_STOP_MULTIPLE_MESSAGE.supplant({0:names.join(", ")});return jscape.ConfirmDialog.confirm(window.R.string.DOMAIN_CONFIRM_STOP_TITLE,message);},_confirmPauseDomain:function(names){var message=names.length==1?window.R.string.DOMAIN_CONFIRM_PAUSE_MESSAGE.supplant({0:names[0]}):window.R.string.DOMAIN_CONFIRM_PAUSE_MULTIPLE_MESSAGE.supplant({0:names.join(", ")});return jscape.ConfirmDialog.confirm(window.R.string.DOMAIN_CONFIRM_PAUSE_TITLE,message);},_poll:function(delay){this._stopPoll();this.timerId=setTimeout($.proxy(function(){this.timerId=null;this.view.refresh();this._poll(this.delay);},this),delay||0);},_stopPoll:function(){if(this.timerId){clearTimeout(this.timerId);}},_domainAdded:function(domainName){this._reloadAndSelect(domainName);},_domainDeleted:function(domains){var copy=[].concat(domains);var index=-1;while(copy.length){index=this.view.indexOf(copy.shift());this.view.deleteRecord(index);}
var rows=this.view.getRecords();if(rows.length>0){index=Math.min(Math.max(0,index),rows.length-1);this._reloadAndSelect(rows[index]);}else{this._gotoPreviousPage();}},_reloadAndSelect:function(record){this.view.refresh($.proxy(function(){record&&this.view.selectRecord(record);},this));},_gotoPreviousPage:function(){this.view.previousPage($.proxy(function(){var records=this.view.getRecords();records.length&&this.view.selectRecord(records[records.length-1]);},this));}});jscape.server.DomainsView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.sizeFormat=new jscape.SizeFormat();this.fieldset=$("#server-domains-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=serverdomains]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,idField:"domainName",sortName:"domainName",sortOrder:"asc",checkOnSelect:true,selectOnCheck:true,resizeEdge:15,frozenColumns:[[{field:"_ck",checkbox:true}]],columns:[[{field:"domainName",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_NAME,sortable:true,finder:this._createFinder("combobox",{editable:true,limitToList:false,loader:$.proxy(this._onLoad$Suggestions,this),queryParams:{field:"domain"}}),width:"8%"},{field:"state",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_STATE,sortable:true,finder:{type:"combobox",options:{data:$.map(jscape.DomainStatus.values(),this._formatStatus),limitToList:true,width:170,panelHeight:"auto"}},formatter:$.proxy(function(_,rowData){return this._formatStatus(null,rowData);},this),styler:$.proxy(function(_,rowData){return this._styleStatus(null,rowData);},this),width:"5%"},{field:"startup",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_STARTUP,sortable:true,finder:{type:"combobox",options:{data:["true","false"],limitToList:true,width:70,panelHeight:"auto"}},formatter:$.proxy(function(_,rowData){return this._formatStartup(rowData);},this),width:"3%",align:"center"},{field:"currentSessions",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_CURRENT_SESSIONS,sortable:true,searchable:false,width:"5%",align:"right"},{field:"currentTransfers",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_CURRENT_TRANSFERS,sortable:true,searchable:false,width:"5%",align:"right"},{field:"totalSessions",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_TOTAL_SESSIONS,sortable:true,searchable:false,width:"5%",align:"right"},{colspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_UPLOADED},{colspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_DOWNLOADED},{colspan:3,title:window.R.string.DOMAINS_TABLE_COLUMN_QUOTA},{colspan:3,title:window.R.string.DOMAINS_TABLE_COLUMN_TRIGGERS},{colspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_LOGINS},{field:"startDate",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_DATE_START,sortable:true,formatter:$.proxy(this._formatDate,this),finder:"datebox",width:"5%",align:"right"},{field:"stopDate",rowspan:2,title:window.R.string.DOMAINS_TABLE_COLUMN_DATE_STOP,sortable:true,formatter:$.proxy(this._formatDate,this),finder:"datebox",width:"5%",align:"right"}],[{field:"bytesUploaded",title:window.R.string.DOMAINS_TABLE_COLUMN_UPLOADED_BYTES,sortable:true,searchable:false,width:"5%",align:"right",formatter:$.proxy(this._formatSize,this)},{field:"filesUploaded",title:window.R.string.DOMAINS_TABLE_COLUMN_UPLOADED_FILES,sortable:true,searchable:false,width:"4%",align:"right"},{field:"bytesDownloaded",title:window.R.string.DOMAINS_TABLE_COLUMN_DOWNLOADED_BYTES,sortable:true,searchable:false,width:"5%",align:"right",formatter:$.proxy(this._formatSize,this)},{field:"filesDownloaded",title:window.R.string.DOMAINS_TABLE_COLUMN_DOWNLOADED_FILES,sortable:true,searchable:false,width:"4%",align:"right"},{field:"uploadsQuota",title:window.R.string.DOMAINS_TABLE_COLUMN_QUOTA_UPLOADS,sortable:true,searchable:false,width:"5%",align:"right",formatter:$.proxy(function(value,rowData){return this._formatQuota(value,rowData.currentUploadedBytes||0);},this)},{field:"downloadsQuota",title:window.R.string.DOMAINS_TABLE_COLUMN_QUOTA_DOWNLOADS,sortable:true,searchable:false,width:"5%",align:"right",formatter:$.proxy(function(value,rowData){return this._formatQuota(value,rowData.currentDownloadedBytes||0);},this)},{field:"transfersQuota",title:window.R.string.DOMAINS_TABLE_COLUMN_QUOTA_TRANSFERS,sortable:true,searchable:false,width:"5%",align:"right",formatter:$.proxy(function(value,rowData){return this._formatQuota(value,(rowData.currentUploadedBytes||0)+(rowData.currentDownloadedBytes||0));},this)},{field:"runningTriggers",title:window.R.string.DOMAINS_TABLE_COLUMN_TRIGGERS_RUNNING,sortable:true,searchable:false,width:"5%",align:"right"},{field:"completedTriggers",title:window.R.string.DOMAINS_TABLE_COLUMN_TRIGGERS_COMPLETED,sortable:true,searchable:false,width:"5%",align:"right"},{field:"failedTriggers",title:window.R.string.DOMAINS_TABLE_COLUMN_TRIGGERS_FAILED,sortable:true,searchable:false,width:"5%",align:"right"},{field:"successfulLogins",title:window.R.string.DOMAINS_TABLE_COLUMN_LOGINS_SUCCESSFUL,sortable:true,searchable:false,width:"5%",align:"right"},{field:"failedLogins",title:window.R.string.DOMAINS_TABLE_COLUMN_LOGINS_FAILED,sortable:true,searchable:false,width:"5%",align:"right"}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onCheckAll:$.proxy(this._adjustState,this),onUncheckAll:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(function(){var rows=this.data.datagrid("getRows");this.data.datagrid("getPanel").find("div.datagrid-header-check input:checkbox").prop("disabled",rows.length==0);this._adjustState();},this)});this.startButton=$("a[role=button][name=start]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$StartButton,this)});this.stopButton=$("a[role=button][name=stop]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$StopButton,this)});this.pauseButton=$("a[role=button][name=pause]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PauseButton,this)});this.resumeButton=$("a[role=button][name=resume]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ResumeButton,this)});this.addButton=$("a[role=button][name=add]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.statusButton=$("a[role=button][name=status]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$StatusButton,this)});this.startUpButton=$("a[role=button][name=startup]",this.fieldset).linkbutton({disabled:true,toggle:true,onClick:$.proxy(this._onClick$StartUpButton,this)});this.fieldset.layout("panel","south").panel("resize",{height:"auto"});initializing=false;},show:function(listener){this.listener=listener||jscape.server.DomainsView.LISTENER;this.fieldset.layout("resize");this._adjustState();},selectItem:function(item){this.data.datagrid("selectRow",this.data.datagrid("getRowIndex",item));},_formatStatus:function(value,domain){var status=value||jscape.DomainStatus.valueOf(domain);switch(status){case jscape.DomainStatus.RUNNING:return window.R.string.DOMAIN_STATUS_RUNNING;case jscape.DomainStatus.PAUSED:return window.R.string.DOMAIN_STATUS_PAUSED;case jscape.DomainStatus.STOPPED:return window.R.string.DOMAIN_STATUS_STOPPED;default:return"";}},_styleStatus:function(value,domain){var status=value||jscape.DomainStatus.valueOf(domain);switch(status){case jscape.DomainStatus.RUNNING:return"color:green;font-weight:normal";case jscape.DomainStatus.PAUSED:return"color:black;font-weight:bold";case jscape.DomainStatus.STOPPED:return"color:red;font-weight:bold";default:return"color:black;font-weight:normal";}},_formatStartup:function(domain){return"<input type=\"checkbox\""+(!!domain.autoStartEnabled?" checked=\"checked\"":"")+" onclick=\"return false\"/>";},_formatDate:function(value){return $.isNumeric(value)?new Date(value).toLocaleString():"";},_formatQuota:function(total,used){return total?window.R.string.DOMAINS_TABLE_QUOTA_PATTERN.supplant({0:this._formatSize(used),1:this._formatSize(total)}):"";},_formatSize:function(value){return'<span title="{1} {2}">{0}</span>'.supplant({0:this.sizeFormat.format(value).escapeXml(),1:Number(value).toLocaleString().escapeXml(),2:String(this.sizeFormat.SIZE.BYTE.unit).escapeXml()});},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onLoad$Suggestions:function(params,success,error){this.listener.onLoadSuggestions(params).then(success,error);},_onClick$StartButton:function(){this.startButton.linkbutton("disable");this.listener.onStartDomain(this.selection);},_onClick$StopButton:function(){this.stopButton.linkbutton("disable");this.listener.onStopDomain(this.selection);},_onClick$PauseButton:function(){this.pauseButton.linkbutton("disable");this.listener.onPauseDomain(this.selection);},_onClick$ResumeButton:function(){this.resumeButton.linkbutton("disable");this.listener.onResumeDomain(this.selection);},_onClick$AddButton:function(){this.addButton.linkbutton("disable");this.listener.onAddDomain().always($.proxy(function(){this.addButton.linkbutton("enable");},this));},_onClick$EditButton:function(){this.editButton.linkbutton("disable");this.listener.onEditDomain(this.selection[0]).always($.proxy(function(){this.editButton.linkbutton("enable");},this));},_onClick$DeleteButton:function(){this.deleteButton.linkbutton("disable");this.listener.onDeleteDomain(this.selection).always($.proxy(function(){this.deleteButton.linkbutton("enable");},this));},_onClick$StatusButton:function(){this.statusButton.linkbutton("disable");this.listener.onDomainStatus(this.selection[0]).always($.proxy(function(){this.statusButton.linkbutton("enable");},this));},_onClick$StartUpButton:function(){if(this.startUpButton.length){this.startUpButton.linkbutton("disable");this.listener.onDomainStartUp(this.selection[0]).always($.proxy(function(){this.startUpButton.linkbutton("enable");},this));}},_showContextMenu:function(e){this._super(e,[this.statusButton,"-",this.addButton,this.editButton,this.deleteButton,"-",this.startButton,this.stopButton,this.pauseButton,this.resumeButton,"-",this.startUpButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");this.startButton.linkbutton(this.selection.length!=0&&this._domainStateIs(jscape.DomainStatus.STOPPED,this.selection)?"enable":"disable");this.stopButton.linkbutton(this.selection.length!=0&&!this._domainStateIs(jscape.DomainStatus.STOPPED,this.selection)?"enable":"disable");this.pauseButton.linkbutton(this.selection.length!=0&&this._domainStateIs(jscape.DomainStatus.RUNNING,this.selection)?"enable":"disable");this.resumeButton.linkbutton(this.selection.length!=0&&this._domainStateIs(jscape.DomainStatus.PAUSED,this.selection)?"enable":"disable");this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");this.statusButton.linkbutton(this.selection.length==1?"enable":"disable");if(this.startUpButton.length){if(this.selection.length==1){this.startUpButton.linkbutton("enable").linkbutton(this.selection[0].autoStartEnabled?"select":"unselect");}else{this.startUpButton.linkbutton("disable");}}},_domainStateIs:function(state,rows){var ret=rows.length!=0;for(var i=0;i<rows.length;i++){ret&=(state===jscape.DomainStatus.valueOf(rows[i]));}
return ret;}});jscape.server.DomainsView.LISTENER={onAddDomain:$.noop,onEditDomain:$.noop,onDeleteDomain:$.noop,onStartDomain:$.noop,onStopDomain:$.noop,onPauseDomain:$.noop,onResumeDomain:$.noop,onDomainStatus:$.noop,onDomainStartUp:$.noop};jscape.server.DeleteDomainController=Class.extend({start:function(domains){var deferred=$.Deferred();var promise=deferred.promise();var names=$.map(domains,function(domain){return domain.domainName;});this._confirmDelete(names).then(function(){return $.when.apply(jQuery,$.map(names,function(domainName){return jscape.API.deleteDomain(domainName);}));}).done(function(){deferred.resolve(names);deferred=null;}).fail(function(){deferred.reject();deferred=null;});return promise;},_confirmDelete:function(names){return jscape.ConfirmDialog.confirm(window.R.string.DOMAINS_CONFIRM_DELETE_TITLE,window.R.string.DOMAINS_CONFIRM_DELETE_MESSAGE.supplant({0:names.join(", ")}));}});jscape.server.DomainStatusController=Class.extend({DEFAULT_DELAY:10*1000,DEFAULT_MAX_RECORDS:1000,deferred:null,timerId:null,delay:null,statistics:null,initialize:function(){this._initValidators();},start:function(domain){this.deferred=$.Deferred();this.delay=this.DEFAULT_DELAY;this.domainName=domain.domainName;this.statistics=new jscape.DomainStatistics();this.usageSummary=new jscape.DomainUsageSummary();this.eventLogController=new jscape.server.DomainLogRecordsController();this.eventLogController.onCreate(domain.domainName);this.dialog=this._setupDialog(domain);this.eventLogController.onStart(this.dialog);this.dialog.show(this);this._poll(0);return this.deferred.promise();},stop:function(){this.eventLogController.onStop();},onStartDomain:function(dialog){return jscape.API.startDomain(this.domainName).always($.proxy(function(){this._poll(0);},this));},onStopDomain:function(dialog){return this._confirmStopDomain(this.domainName).then($.proxy(function(){return jscape.API.stopDomain(this.domainName);},this)).always($.proxy(function(){this._poll(0);},this));},onPauseDomain:function(dialog){return this._confirmPauseDomain(this.domainName).then($.proxy(function(){return jscape.API.pauseDomain(this.domainName);},this)).always($.proxy(function(){this._poll(0);},this));},onResumeDomain:function(dialog){return jscape.API.resumeDomain(this.domainName).always($.proxy(function(){this._poll(0);},this));},onRefresh:function(){return $.Deferred().resolve(this.statistics).promise();},onLoadDomainStatus:function(){return $.Deferred().resolve(jscape.DomainStatus.valueOf(this.statistics)).promise();},onLoadDomainUsage:function(startTime,endTime){this.startTime=startTime;this.endTime=endTime;return $.Deferred().resolve(this.usageSummary).promise();},onChangeDomainUsageRange:function(startTime,endTime){this.startTime=startTime;this.endTime=endTime;jscape.API.getDomainUsage(this.domainName,startTime,endTime).done($.proxy(function(data){this.usageSummary=data;},this));},onExportDomainUsage:function(startTime,endTime){return new jscape.domain.ExportDomainUsageController().start(this.domainName,startTime,endTime);},onLoadSessions:function(){return $.Deferred().resolve(this.statistics.connectionStatistics).promise();},onCloseConnection:function(session){return new jscape.domain.CloseSessionController().start(this.domainName,session).done($.proxy(this._poll,this));},onUpdateAgent:function(session){return new jscape.domain.UpdateAgentAppController().start(this.domainName,session).done($.proxy(this._poll,this));},onCancel:function(dialog){this._stopPoll();this.eventLogController.onStop();dialog.destroy();this.deferred.resolve();this.deferred=null;this.domainName=null;this.eventLogController=null;},_poll:function(delay){this._stopPoll();this.timerId=setTimeout($.proxy(function(){this.timerId=null;var domain=this.domainName;var dialog=this.dialog;this.eventLogController.onResume();jscape.API.getDomainStatistics(domain).then($.proxy(function(stats){this.statistics=stats;},this)).then(function(){return jscape.API.getDomainUsage(domain,dialog.getStartTime(),dialog.getEndTime());}).then($.proxy(function(data){this.usageSummary=data;},this)).catch($.proxy(function(data){if(403==data.status){this._stopPoll();this._showNoPermissionsMessage((data.status||"")+" "+data.statusText,$.proxy(this.onCancel,this,this.dialog));}else{this.delay*=2;this._poll(this.delay);}},this)).done($.proxy(function(){this.dialog&&this.dialog.refresh();},this));},this),delay||0);},_stopPoll:function(){if(this.timerId){clearTimeout(this.timerId);this.timerId=null;}},_showNoPermissionsMessage:function(title,callback){$.messager.alert(title,window.R.string.NO_PERMISSIONS,"error",callback);},_confirmPauseDomain:function(name){return jscape.ConfirmDialog.confirm(window.R.string.DOMAIN_CONFIRM_PAUSE_TITLE,window.R.string.DOMAIN_CONFIRM_PAUSE_MESSAGE.supplant({0:name}));},_confirmStopDomain:function(name){return jscape.ConfirmDialog.confirm(window.R.string.DOMAIN_CONFIRM_STOP_TITLE,window.R.string.DOMAIN_CONFIRM_STOP_MESSAGE.supplant({0:name}))},_setupDialog:function(domain){var dialog=new jscape.server.DomainStatusDialog();dialog.setDomainName(domain.domainName);dialog.setStatus(jscape.DomainStatus.valueOf(domain));try{return dialog;}catch(e){dialog.destroy();throw e;}},_initValidators:function(){var v=new jscape.Validator();v.rule("date_range",$.proxy(this._validDateRange,this),window.R.string.DOMAIN_STATS_ERROR_DATE_RANGE);},_validDateRange:function(_){if(!this.dialog){return true;}
var s=this.dialog.getStartTime();var e=this.dialog.getEndTime();return(s!=null&&e!=null&&s<=e)||!e;}});jscape.server.DomainLogRecordsController=jscape.domain.EventLogController.extend({onStart:function(dialog){if(this.view==null){this.view=new jscape.server.DomainLogRecordsView(dialog);}
this.view.show(this);}});jscape.server.DomainLogRecordsView=jscape.domain.EventLogView.extend({initialize:function(dialog){this._super($("#"+dialog.idFor("domain-log-records-content")));}});jscape.server.DomainStatusDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-domain-status"),{width:"80%",height:"90%",buttons:[{text:window.R.string.DIALOG_BUTTON_CLOSE||"Close",handler:$.proxy(this._onCancel,this)}]});this.title=this.dialog.dialog("header").text()||"";this.fieldset=$("#domain-status-fields"+this.getIdSuffix()).layout({fit:true,border:false});this.tabs=$("div[role=tablist]",this.dialog).tabs({fit:true,doSize:false,tabPosition:"top",plain:true});this.statisticsView=new jscape.server.DomainUsageView(this.getIdSuffix());this.sessionsView=new jscape.server.DomainSessionsView(this.getIdSuffix());this.startButton=$("a[role=button][name=startdomain]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$StartButton,this)});this.stopButton=$("a[role=button][name=stopdomain]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$StopButton,this)});this.pauseButton=$("a[role=button][name=pausedomain]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$PauseButton,this)});this.resumeButton=$("a[role=button][name=resumedomain]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ResumeButton,this)});},setDomainName:function(value){this.domainName=value||"";this.dialog.dialog("setTitle",this.title.supplant({0:this.domainName,1:window.R.string.DOMAIN_MESSAGE_LOADING}));},setStatus:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:this.domainName,1:window.R.string["DOMAIN_STATUS_"+value.toUpperCase()]}));this._adjustButtonsState(value);},getStartTime:function(){return this.statisticsView.getStartTime();},getEndTime:function(){return this.statisticsView.getEndTime();},show:function(listener,eventLogListener){this._super(listener);this.statisticsView.show(listener);this.sessionsView.show(listener);this.fieldset.layout("resize");this.tabs.tabs("resize");this._adjustButtonsState(null);},hide:function(){this._super();this.statisticsView.hide();this.sessionsView.hide();},refresh:function(){this.statisticsView.refresh();this.sessionsView.refresh();this.listener.onLoadDomainStatus().done($.proxy(this.setStatus,this));},_onClick$StartButton:function(){this.startButton.linkbutton("disable");this.listener.onStartDomain(this);},_onClick$StopButton:function(){this.stopButton.linkbutton("disable");this.listener.onStopDomain(this);},_onClick$PauseButton:function(){this.pauseButton.linkbutton("disable");this.listener.onPauseDomain(this);},_onClick$ResumeButton:function(){this.resumeButton.linkbutton("disable");this.listener.onResumeDomain(this);},_adjustButtonsState:function(status){this.startButton.linkbutton(jscape.DomainStatus.STOPPED==status?"enable":"disable");this.stopButton.linkbutton(jscape.DomainStatus.STOPPED!=status?"enable":"disable");this.pauseButton.linkbutton(jscape.DomainStatus.RUNNING==status?"enable":"disable");this.resumeButton.linkbutton(jscape.DomainStatus.PAUSED==status?"enable":"disable");}});jscape.server.DomainStatusDialog.LISTENER={onRefresh:$.noop,onStartDomain:$.noop,onStopDomain:$.noop,onPauseDomain:$.noop,onResumeDomain:$.noop,onLoadDomainStatus:$.noop,onLoadDomainUsage:$.noop,onChangeDomainUsageRange:$.noop,onExportDomainUsage:$.noop,onLoadSessions:$.noop,onCloseConnection:$.noop,onUpdateAgent:$.noop};jscape.server.DomainUsageView=jscape.domain.DomainUsageView.extend({show:function(listener){this._super({onLoadData:function(){return listener.onLoadDomainUsage.apply(listener,arguments);},onChangeRange:function(){return listener.onChangeDomainUsageRange.apply(listener,arguments);},onExport:function(){return listener.onExportDomainUsage.apply(listener,arguments);}});}});jscape.server.DomainSessionsView=jscape.domain.SessionsView.extend({show:function(listener){this._super({onLoadData:function(){return listener.onLoadSessions.apply(listener,arguments);},onCloseConnection:function(){return listener.onCloseConnection.apply(listener,arguments);},onUpdateAgent:function(){return listener.onUpdateAgent.apply(listener,arguments);}});}});