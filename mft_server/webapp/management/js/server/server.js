/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.server=jscape.server||{};jscape.server.ServerDashboardApplication=jscape.Application.extend({onReady:function(){this._super();this.view.show(this);$(document).on("mark_dirty",$.proxy(this._onMarkAsDirty,this));},_createView:function(){this._super();this.view=new jscape.server.ServerDashboardView();},_onMarkAsDirty:function(e,id,dirty){if(!dirty){this.view.markAsClean(id);}else{this.view.markAsDirty(id);}},_destroy:function(){this._super();$(document).off("mark_dirty");}});jscape.server.ServerDashboardView=jscape.DashboardView.extend({initialize:function(){this._super($("#modules[role=tablist]"));},show:function(){this._super.apply(this,arguments);this.modules.tabs({fit:true,tabPosition:"top",onSelect:$.proxy(function(title,index){this._onSelect$Module.call(this,title,index,this.modules);},this)});this.modules.find(">div.tabs-header>div.tabs-wrap").hover(function(){$(this).css({overflowY:"auto",overflowX:"hidden"});},function(){$(this).css({overflowY:"",overflowX:""});});this.modules.tabs("unselect",0).tabs("select",0);},markAsDirty:function(id){this._updateTabIcon(id,"icon-warning");},markAsClean:function(id){this._updateTabIcon(id,null);},_onSelect$Module:function(title,index,tabs){var tab=(tabs||this.modules).tabs("getSelected");if(tab.data("__subtabs")!==true){tab.data("__subtabs",true);this._subtabs(tab).each($.proxy(function(_,t){var subtabs=$(t);subtabs.tabs({fit:true,border:false,onSelect:$.proxy(function(title,index,tabs){this._onSelect$Module.call(this,title,index,subtabs);},this)});},this));}
this._super.apply(this,arguments);}});jscape.server.StatisticsModule=jscape.ApplicationModule.extend({DELAY:15*1000,initialize:function(sra,aca){this.sra=sra;this.aca=aca;},onCreate:function(app){this._super.apply(this,arguments);this.view=new jscape.server.StatisticsView();this.parameters=null;},onStart:function(){this.view.show(this);},onStop:function(){this.view.hide();},onResume:function(){this._poll(0);},onPause:function(){this._stopPoll();},onLoadData:function(){if(!this.sra&&!!this.parameters){return $.Deferred().resolve(this.parameters).promise();}
return(!!this.parameters?$.Deferred().resolve(this.parameters).promise():jscape.API.getServerParameters().catch(function(){return null;}).then($.proxy(function(data){this.parameters=data||{};},this))).then(function(){return jscape.API.getServerStatistics().catch(function(){return{};});}).then($.proxy(function(data){return $.extend({},this.parameters,data);},this)).done($.proxy(function(delay){this.sra&&this._poll(delay);},this,this.DELAY)).catch($.proxy(this._stopPoll,this));},onRestartApp:function(){if(!this.aca){return $.Deferred().reject().promise();}
this._stopPoll();return new jscape.server.ServerRestartController().start().fail($.proxy(this._poll,this,0));},_poll:function(delay){this._stopPoll();this.timerId=setTimeout($.proxy(function(){this.timerId=null;this.view.refresh();},this),delay||0);},_stopPoll:function(){var id=this.timerId;this.timerId=null;id&&clearTimeout(id);}});jscape.server.StatisticsView=Class.extend({initialize:function(){var initializing=true;this.fieldset=$("#server-statistics-fields").first().layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=statistics]",this.fieldset).propertygrid({fit:true,showGroup:true,showHeader:false,columns:[[{field:"name",width:"30%"},{field:"value",width:"65%",formatter:$.proxy(this._formatValue,this),styler:$.proxy(this._styleValue,this)}]],loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onLoad$Filter,this),onBeforeLoad:function(){return!initializing;}});this.restartButton=$("a[role=button][name=restart]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$RestartButton,this)});this.fieldset.layout("panel","south").panel("resize",{height:"auto"});initializing=false;},show:function(listener){this.listener=listener||jscape.server.StatisticsView.LISTENER;this.fieldset.layout("resize");},hide:function(){},refresh:function(){this.data.propertygrid("reload");},_formatValue:function(value,row){switch(row.type){case"date":return this._formatDate(value);case"binding":return this._formatBinding(value);case"memory":return this._formatMemoryUsage(value);case"connections":return this._formatCurrentConnections(value);case"licenseExpires":return value?this._formatExpirationDate(value.expirationDate):"";case"support":return this._formatSupportLevel(value);case"maintenance":return value?this._formatMaintenance(value.maintenance,value.endingDate):"";default:return value;}},_styleValue:function(value,row){switch(row.type){case"maintenance":return value?this._styleMaintenance(value.maintenance,value.endingDate):"";case"licenseExpires":return value?this._styleExpirationDate(value.expirationDate):"";default:return"";}},_formatCurrentConnections:function(domainStatistics){if(domainStatistics){var connections=0;for(var i=0;i<domainStatistics.length;++i){connections+=domainStatistics[i].currentSessions;}
return connections;}
return"";},_formatBinding:function(value){return value==null?window.R.string.SERVER_LICENSE_NON_BINDING:value;},_formatDate:function(value){if(value==null){return"";}
return!isNaN(value)?window.moment.utc(value).format("MM-DD-YYYY"):"";},_formatExpirationDate:function(value){if(value==null){return window.R.string.SERVER_LICENSE_NON_EXPIRING;}
if(isNaN(value)){return"";}
var d=window.moment.utc(value);var days=d.diff(moment.utc(),"days");return d.format("MM-DD-YYYY")+(days>=0?" "+window.R.string.SERVER_LICENSE_DAYS_LEFT.supplant({0:days}):"");},_styleExpirationDate:function(value){if(value!=null&&!isNaN(value)){var days=window.moment.utc(value).diff(moment.utc(),"days");if(days<=0){return"color:red";}}
return"";},_formatSupportLevel:function(value){value=!!value?value:"SILVER";return window.R.string["SERVER_LICENSE_SUPPORT_"+value.toUpperCase()]||"";},_formatMaintenance:function(maintenance,endingDate){if(maintenance){var date=maintenance.expirationDate;if($.isNumeric(date)&&date<endingDate){return window.R.string.SERVER_LICENSE_MAINTENANCE_EXPIRED.supplant({0:this._formatDate(date)});}
return this._formatExpirationDate(date);}
return window.R.string.SERVER_LICENSE_MAINTENANCE_NOT_FOUND;},_styleMaintenance:function(maintenance,endingDate){if(maintenance){return $.isNumeric(maintenance.expirationDate)&&maintenance.expirationDate<endingDate?"color:red":this._styleExpirationDate(maintenance.expirationDate);}
return"color:red";},_formatMemoryUsage:function(memory){return memory?$.isNumeric(memory.used)&&$.isNumeric(memory.total)?window.R.string.SERVER_MEMORY_USAGE.supplant({0:this._formatSize(memory.used),1:this._formatSize(memory.total)}):"":"";},_formatUptime:function(value){if(value){var time=new jscape.Hours(value);var pattern=[];if(time.hours){pattern.push("{hours} hrs.");}
if(time.minutes){pattern.push("{minutes} min.");}
if(time.seconds){pattern.push("{seconds} sec.");}
return pattern.join(" ").supplant(time);}
return"";},_formatSize:function(value){return new jscape.SizeFormat().format(value);},_onClick$RestartButton:function(){this.restartButton.linkbutton("disable");this.listener.onRestartApp().always($.proxy(function(){this.restartButton.linkbutton("enable");},this));},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onLoad$Filter:function(data){var rows=[];if(data){rows=rows.concat([{type:"string",name:window.R.string.SERVER_VERSION,value:data.appVersion||""},{type:"date",name:window.R.string.SERVER_RELEASE_DATE,value:data.buildDate||window.NaN},{type:"string",name:window.R.string.SERVER_INSTANCE_ID,value:data.appInstanceId||""},{type:"string",name:window.R.string.SERVER_TIME_ZONE,value:data.timeZone||""}]);if(data.license){rows=rows.concat($.map([{type:"string",name:window.R.string.SERVER_LICENSE_TYPE,value:data.license.type},{type:"string",name:window.R.string.SERVER_LICENSE_OWNER,value:data.license.owner},{type:"binding",name:window.R.string.SERVER_LICENSE_HOST,value:data.license.bindingHost},{type:"binding",name:window.R.string.SERVER_LICENSE_MAC,value:data.license.bindingMac},{type:"licenseExpires",name:window.R.string.SERVER_LICENSE_EXPIRES,value:data.license},{type:"maintenance",name:window.R.string.SERVER_LICENSE_MAINTENANCE_DATE,value:{maintenance:data.license.maintenance,endingDate:data.releaseDate}},{type:"support",name:window.R.string.SERVER_LICENSE_SUPPORT_LEVEL,value:data.license.supportLevel}],function(entry){return $.extend(entry,{group:window.R.string.SERVER_LICENSE});}));}
if(data.domainStatistics){rows=rows.concat($.map([{type:"string",name:window.R.string.SERVER_DOMAINS,value:data.domainStatistics?data.domainStatistics.length:""},{type:"string",name:window.R.string.SERVER_UPTIME,value:this._formatUptime(data.uptime)},{type:"string",name:window.R.string.SERVER_MANAGEMENT_CONNECTIONS,value:data.managementConnections||""},{type:"connections",name:window.R.string.SERVER_CONNECTIONS,value:data.domainStatistics},{type:"memory",name:window.R.string.SERVER_MEMORY,value:{used:(data.totalMemory-data.freeMemory),total:data.maxMemory}},{type:"string",name:window.R.string.SERVER_THREADS,value:data.threads||""},{type:"string",name:window.R.string.SERVER_DB_FILE_SIZE,value:data.databaseFileSize?this._formatSize(data.databaseFileSize):""}],function(entry){return $.extend(entry,{group:window.R.string.SERVER_STATISTICS});}));}}
return{total:rows.length,rows:rows};}});jscape.server.StatisticsView.LISTENER={onLoadData:$.noop,onRestartApp:$.noop};jscape.server.InterfacesModule=jscape.ApplicationModule.extend({onStart:function(){if(!this.view){this.view=new jscape.server.InterfacesView();}
this.view.show(this);},onResume:function(){this.view.refresh();},onLoadData:function(){return jscape.API.getServerParameters().then(function(params){return params.interfaces;});}});jscape.server.InterfacesView=Class.extend({initialize:function(){var initializing=true;this.fieldset=$("#server-interfaces-fields");this.data=$("table[role=grid][aria-label=interfaces]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,remoteSort:false,singleSelect:true,loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"25%"},{field:"displayName",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"50%"},{field:"addresses",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"25%",formatter:function(rowData){return rowData.join(", ").escapeXml();}}]]});initializing=false;},show:function(listener){this.listener=listener||jscape.server.InterfacesView.LISTENER;},refresh:function(){this.data.datagrid("reload");},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);}});jscape.server.InterfacesView.LISTENER={onLoadData:$.noop};jscape.server.ServerRestartController=jscape.server.ApplicationLifecycleController.extend({initialize:function(){this._super(new jscape.server.ServerRestartView());},start:function(){return this._super($.proxy(this.onRestartApp,this));},onRestartApp:function(){return jscape.API.startApplicationRestart();},_complete:function(data,version){return data&&data.appVersion===version;}});jscape.server.ServerRestartView=Class.extend({confirmStartDialog:function(){var self=this;return jscape.ConfirmDialog.confirm(window.R.string.SERVER_CONFIRM_RESTART_TITLE,String(window.R.string.SERVER_CONFIRM_RESTART_MESSAGE).escapeXml().replace(/[\r\n]/g,"<br/>"),true,{width:"40%",maxWidth:530,buttons:[{text:window.R.string.SERVER_CONFIRM_RESTART_BUTTON,onClick:function(){self._onClick$Btn($(this),"submit");}},{text:$.messager.defaults.cancel,onClick:function(){self._onClick$Btn($(this),"cancel");}}]});},confirmUnloadMessage:function(){return window.R.string.APPLICATION_CONFIRM_SERVER_RESTART_LEAVE;},onProgress:function(value){$.messager.progress("bar").progressbar("setValue",Math.max(0,Math.min(100,value)));},showProgressDialog:function(){var d=$.messager.progress({title:"",icon:"",msg:window.R.string.SERVER_MESSAGE_APP_RESTARTING,width:"50%",closable:false,interval:0});$.messager.progress("bar").progressbar({text:"",height:5,value:0});d.dialog("resize");return d;},_onClick$Btn:function(jq,type){var dlg=$(jq).closest(".messager-window").find(".messager-body");if(dlg&&dlg.length){var cb=dlg.dialog("options").fn;dlg.dialog("close");cb("submit"===type);}}});