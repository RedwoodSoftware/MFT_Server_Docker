/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.server=jscape.server||{};jscape.server.ApplicationUpdateLoader=Class.extend({DEFAULT_DELAY:2*1000,MAX_DELAY:20*1000,delay:0,deferred:null,cancelled:false,timer:null,start:function(){this.delay=0;this.cancelled=false;this.startTime=new Date().getTime();this.deferred=$.Deferred();var promise=this.deferred.promise();this._bindEvents();this._notify("started");jscape.API.downloadUpdate().then($.proxy(this._poll,this)).fail($.proxy(this._onError,this));return promise;},stop:function(){this._stopPoll();this._unbindEvents();this.cancel();},cancel:function(){if(!!this.cancelled||!this.deferred||/resolved|rejected/i.test(this.deferred.state())){return $.Deferred().resolve().promise();}
this.cancelled=true;return jscape.API.cancelDownloadUpdate().done($.proxy(function(){this._notify("cancelled");},this)).always($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},_bindEvents:function(){$(window).on("beforeunload",$.proxy(this.stop,this));},_unbindEvents:function(){$(window).off("beforeunload");},_poll:function(delay){this._stopPoll();this.timer=setTimeout($.proxy(function(){this.timerId=null;if(!!this.cancelled){return;}
jscape.API.downloadUpdateState().then($.proxy(function(data){this.delay=this.DEFAULT_DELAY;this._onProgress(data);},this),$.proxy(function(xhr){if(0===xhr.status){this.delay*=2;this._poll(this.delay);}else if(403===xhr.status){this._stopPoll();}else if(xhr.status>=200&&xhr.status<300){this._poll(this.delay);}else{var response=xhr.responseJSON||{};this._notify("error",undefined,response.message);}},this));},this),delay||0);},_stopPoll:function(){if(this.timer){clearTimeout(this.timer);this.timer=null;}},_notify:function(state,percent,message,elapsedMillis,remainingMillis){if(this.deferred&&"rejected"!==this.deferred.state()){this.deferred.notify({state:state,progress:{percent:percent,elapsedMillis:elapsedMillis||undefined,remainingMillis:remainingMillis||undefined},message:message||undefined});}},_onProgress:function(data){var elapsed=new Date().getTime()-this.startTime;var remaining=data?Math.round((data.totalBytes-data.downloadedBytes)/(data.downloadedBytes/elapsed)):0;var percent=data&&data.totalBytes?Number(Math.round((data.downloadedBytes/data.totalBytes)+"e2")):NaN;this._notify(data,isNaN(percent)?0:percent,undefined,elapsed,isNaN(remaining)||!isFinite(remaining)?0:remaining);if(this._complete(data)){this.deferred.resolve(true,data);}else{this._poll(this.delay);}},_onError:function(){this._stopPoll();this._notify("error");this.deferred.resolve(false);this.deferred=null;},_complete:function(data){return data&&data.totalBytes>0&&data.totalBytes===data.downloadedBytes;}});jscape.server.UpdatingController=Class.extend({DEFAULT_DELAY:10*1000,delay:0,timer:null,ptimer:null,deferred:null,start:function(versionDir,commandLine){this.progress=0;this.step=30;this.delay=this.DEFAULT_DELAY;this.url=window.location.href||"/";this.deferred=$.Deferred();var promise=this.deferred.promise();try{window.jscape.applicationUpdateStarted=true;this._bindEvents();this._confirmStart(versionDir,commandLine).catch($.proxy(function(){return this.deferred.reject();},this)).then($.proxy(function(){return jscape.API.getServerParameters().done($.proxy(function(data){this.appVersion=data?data.appVersion:"";},this)).fail($.proxy(function(){this.appVersion="";},this));},this)).then(function(){return jscape.API.startApplicationUpdate();}).then($.proxy(function(){this._setupDialog();this._poll(this.delay);},this)).fail($.proxy(function(){this.stop();this.deferred.reject();},this));}catch(e){this.stop();this.deferred.reject();}
return promise;},stop:function(){this._stopPoll();this._unbindEvents();window.jscape.applicationUpdateStarted=false;$.messager.progress("close");},_bindEvents:function(){$(window).on("beforeunload.appupdater",$.proxy(this._onBeforeUnload,this));},_unbindEvents:function(){$(window).off("beforeunload.appupdater");},_poll:function(delay){this._stopPoll();this.timer=setTimeout($.proxy(function(){this.timer=null;$.ajax(this.url,"HEAD").then($.proxy(this._onAvailable,this),$.proxy(function(xhr){this.step*=.65;if(0===xhr.status){this._poll(this.delay);this._onProgress();}else{this._onAvailable();}},this));},this),delay||0);this._tick();},_tick:function(){var next=Math.max(0,Math.min(100,this.progress+this.step));if(next<100){var self=this;(function _t(){if(self.progress<next){self._progress(++self.progress);self.ptimer=setTimeout(_t,1000);}})();}},_stopPoll:function(){if(this.timer){clearTimeout(this.timer);this.timer=null;}
if(this.ptimer){clearTimeout(this.ptimer);this.ptimer=null;}},_onAvailable:function(){if(!!this.appVersion){jscape.API.getServerParameters().then($.proxy(function(data){if(data&&data.appVersion===this.appVersion){this._poll(this.delay);}else{this._onComplete();}},this)).catch($.proxy(this._poll,this.delay));}else{this._onComplete();}},_onProgress:function(){this.progress+=this.step;this._progress(this.progress);},_onComplete:function(){this._progress(100);this.stop();this.deferred.resolve();window.location.reload(true);},_onBeforeUnload:function(e){window.originalEvent=e;if(!!window.jscape.applicationUpdateStarted){e.returnValue=window.R.string.AUTOMATIC_UPDATES_MESSAGE_CONFIRM_LEAVE;}
return e.returnValue||undefined;},_progress:function(value){$.messager.progress("bar").progressbar("setValue",Math.max(0,Math.min(100,value)));},_confirmStart:function(versionDir,commandLine){return jscape.ConfirmDialog.confirm("",(window.R.string.AUTOMATIC_UPDATES_MESSAGE_CONFIRM_START||"").escapeXml().replace(/[\r\n]/g,"<br/>").supplant({0:"<code>"+String(versionDir||"").escapeXml()+"</code>",1:"<code>"+String(commandLine||"").escapeXml()+"</code>"}),false,{width:"40%"});},_setupDialog:function(){var d=$.messager.progress({title:"",icon:"",msg:window.R.string.AUTOMATIC_UPDATES_MESSAGE_UPDATING,width:"50%",closable:false,interval:0});$.messager.progress("bar").progressbar({text:"",height:5,value:0});d.dialog("resize");}});