/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.server=jscape.server||{};jscape.server.DashboardModule=jscape.ApplicationModule.extend({DELAY:5*1000,timerId:null,maxMemory:null,onCreate:function(){this._super.apply(this,arguments);this.view=new jscape.server.DashboardView();},onStart:function(){this.view.show(this);this._loadMaxMemory();},onResume:function(){this._poll();},onPause:function(){this._stopPoll();},_poll:function(delay){this._stopPoll();this.timerId=setTimeout($.proxy(function(){this.timerId=null;this._loadData().done($.proxy(this._poll,this,this.DELAY)).fail($.proxy(this._stopPoll,this));},this),delay||0);},_stopPoll:function(){if(this.timerId){clearTimeout(this.timerId);}},_loadData:function(){return jscape.API.getServerPerformance().done($.proxy(function(data){this._setServerGraph(data.threads,data.memory);this._setConnectionsGraph(data.connections);this._setUploadsGraph(data.uploads);this._setDownloadsGraph(data.downloads);this._setExternalUploadsGraph(data.externalUploads);this._setExternalDownloadsGraph(data.externalDownloads);this._setLoginsGraph(data.userLogins);this._setTriggersGraph(data.triggers);},this));},_loadMaxMemory:function(){return jscape.API.getServerStatistics().done($.proxy(function(stats){this.maxMemory=parseInt(stats.maxMemory)||null;},this));},_setServerGraph:function(threads,memory){var minDate,maxDate;for(var i=0,len=memory.length;i<len;i++){var date=memory[i].date;minDate=Math.min(minDate||date,date);maxDate=Math.max(maxDate||date,date);}
var maxMemory=[];if(this.maxMemory){maxMemory.push([minDate,this.maxMemory]);maxMemory.push([maxDate,this.maxMemory]);}
this.view.setServerStats(this._toGraphData(threads,"amount"),this._toGraphData(memory,"heap"),this._toGraphData(memory,"allocated"),maxMemory);},_setConnectionsGraph:function(measures){this.view.setConnections(this._toGraphData(measures,"amount"));},_setUploadsGraph:function(measures){this.view.setUploads(this._toGraphData(measures,"amount"),this._toGraphData(measures,"bytes"));},_setDownloadsGraph:function(measures){this.view.setDownloads(this._toGraphData(measures,"amount"),this._toGraphData(measures,"bytes"));},_setExternalUploadsGraph:function(measures){this.view.setExternalUploads(this._toGraphData(measures,"amount"),this._toGraphData(measures,"bytes"));},_setExternalDownloadsGraph:function(measures){this.view.setExternalDownloads(this._toGraphData(measures,"amount"),this._toGraphData(measures,"bytes"));},_setLoginsGraph:function(measures){this.view.setLogins(this._toGraphData(measures,"successfulLogins"),this._toGraphData(measures,"failedLogins"));},_setTriggersGraph:function(measures){this.view.setTriggers(this._toGraphData(measures,"runningTriggers"),this._toGraphData(measures,"completedTriggers"),this._toGraphData(measures,"failedTriggers"));},_toGraphData:function(measures,key){var len=measures.length;var data=new Array(len);for(var i=0;i<len;++i){var measure=measures[i];if(measure&&measure.date){var value=parseInt(measure[key]);data.push([measure.date,isNaN(value)||value<0?null:value]);}else{data.push(null);}}
data.push([$.now(),null]);return data;}});jscape.server.DashboardView=Class.extend({initialize:function(){var defaultOptions={series:{lines:{show:true},shadowSize:0},grid:{borderWidth:1,borderColor:"#95B8E7"},legend:{position:"ne",margin:[30,5]},selection:{mode:"x"}};this.serverPlot=new jscape.server.DashboardView.Plot($("#server-plot"),$.extend(true,{},defaultOptions,{xaxes:[{mode:"time",timezone:"browser"}],yaxes:[{min:0,minTickSize:1,tickDecimals:0,position:"right"},{min:0,minTickSize:1024,position:"left",tickFormatter:function(value){return jscape.SizeFormat.format(value);}}],legend:{noColumns:4}}));this.connectionsPlot=new jscape.server.DashboardView.Plot($("#connections-plot"),$.extend(true,{},defaultOptions,{xaxis:{mode:"time",timezone:"browser",minTickSize:[1,"minute"]},yaxis:{min:0,minTickSize:1,tickDecimals:0}}));this.uploadsPlot=new jscape.server.DashboardView.Plot($("#uploads-plot"),$.extend(true,{},defaultOptions,{xaxes:[{mode:"time",timezone:"browser"}],yaxes:[{min:0,minTickSize:1,tickDecimals:0,position:"right"},{min:0,minTickSize:1024,position:"left",tickFormatter:function(value){return jscape.SizeFormat.format(value);}}],legend:{noColumns:2}}));this.downloadsPlot=new jscape.server.DashboardView.Plot($("#downloads-plot"),$.extend(true,{},defaultOptions,{xaxes:[{mode:"time",timezone:"browser"}],yaxes:[{min:0,minTickSize:1,tickDecimals:0,position:"right"},{min:0,minTickSize:1024,position:"left",tickFormatter:function(value){return jscape.SizeFormat.format(value);}}],legend:{noColumns:2}}));this.externalUploadsPlot=new jscape.server.DashboardView.Plot($("#external-uploads-plot"),$.extend(true,{},defaultOptions,{xaxes:[{mode:"time",timezone:"browser"}],yaxes:[{min:0,minTickSize:1,tickDecimals:0,position:"right"},{min:0,minTickSize:1024,position:"left",tickFormatter:function(value){return jscape.SizeFormat.format(value);}}],legend:{noColumns:2}}));this.externalDownloadsPlot=new jscape.server.DashboardView.Plot($("#external-downloads-plot"),$.extend(true,{},defaultOptions,{xaxes:[{mode:"time",timezone:"browser"}],yaxes:[{min:0,minTickSize:1,tickDecimals:0,position:"right"},{min:0,minTickSize:1024,position:"left",tickFormatter:function(value){return jscape.SizeFormat.format(value);}}],legend:{noColumns:2}}));this.loginsPlot=new jscape.server.DashboardView.Plot($("#logins-plot"),$.extend(true,{},defaultOptions,{xaxis:{mode:"time",timezone:"browser"},yaxis:{min:0,minTickSize:1,tickDecimals:0},legend:{noColumns:2}}));this.triggersPlot=new jscape.server.DashboardView.Plot($("#triggers-plot"),$.extend(true,{},defaultOptions,{xaxis:{mode:"time",timezone:"browser"},yaxis:{min:0,minTickSize:1,tickDecimals:0},legend:{noColumns:3}}));},show:function(listener){this.listener=listener||jscape.server.DashboardView.LISTENER;this.serverPlot.show(this);this.connectionsPlot.show(this);this.uploadsPlot.show(this);this.downloadsPlot.show(this);this.externalUploadsPlot.show(this);this.externalDownloadsPlot.show(this);this.loginsPlot.show(this);this.triggersPlot.show(this);},setServerStats:function(threads,heapMemory,allocatedMemory,maxMemory){this.serverPlot.setData([{label:window.R.string.GRAPH_LEGEND_THREADS,data:threads,yaxis:1},{label:window.R.string.GRAPH_LEGEND_MEMORY_HEAP,data:heapMemory,yaxis:2,lines:{fill:true}},{label:window.R.string.GRAPH_LEGEND_MEMORY_ALLOCATED,data:allocatedMemory,yaxis:2,lines:{fill:true}},{label:window.R.string.GRAPH_LEGEND_MEMORY_MAX,data:maxMemory,yaxis:2,color:"#F00"}]);},setConnections:function(connections){this.connectionsPlot.setData([{label:window.R.string.GRAPH_LEGEND_CONNECTIONS,data:connections}]);},setUploads:function(files,bytes){this.uploadsPlot.setData([{label:window.R.string.GRAPH_LEGEND_FILES,data:files,yaxis:1},{label:window.R.string.GRAPH_LEGEND_BYTES,data:bytes,yaxis:2}]);},setDownloads:function(files,bytes){this.downloadsPlot.setData([{label:window.R.string.GRAPH_LEGEND_FILES,data:files,yaxis:1},{label:window.R.string.GRAPH_LEGEND_BYTES,data:bytes,yaxis:2}]);},setExternalUploads:function(files,bytes){this.externalUploadsPlot.setData([{label:window.R.string.GRAPH_LEGEND_FILES,data:files,yaxis:1},{label:window.R.string.GRAPH_LEGEND_BYTES,data:bytes,yaxis:2}]);},setExternalDownloads:function(files,bytes){this.externalDownloadsPlot.setData([{label:window.R.string.GRAPH_LEGEND_FILES,data:files,yaxis:1},{label:window.R.string.GRAPH_LEGEND_BYTES,data:bytes,yaxis:2}]);},setLogins:function(successful,failed){this.loginsPlot.setData([{label:window.R.string.GRAPH_LEGEND_LOGINS_SUCCESSFUL,data:successful,yaxis:1,color:"#0F0"},{label:window.R.string.GRAPH_LEGEND_LOGINS_FAILED,data:failed,yaxis:1,color:"#F00"}]);},setTriggers:function(running,completed,failed){this.triggersPlot.setData([{label:window.R.string.GRAPH_LEGEND_TRIGGERS_RUNNING,data:running,yaxis:1,color:"yellow"},{label:window.R.string.GRAPH_LEGEND_TRIGGERS_COMPLETED,data:completed,yaxis:1,color:"#0F0"},{label:window.R.string.GRAPH_LEGEND_TRIGGERS_FAILED,data:failed,yaxis:1,color:"#F00"}]);}});jscape.server.DashboardView.LISTENER={};jscape.server.DashboardView.Plot=Class.extend({DAYS_RANGE:{lowerBound:-4,upperBound:1},options:null,initialize:function(placeholder,options){placeholder.panel({border:false,width:"100%",height:450,minHeight:450,maxHeight:450,onResize:$.proxy(this._onResize,this)});this.plot=$.plot(placeholder,[],options);placeholder.on("plotselected",$.proxy(this._onZoomIn,this));$("<div />").css({position:"absolute",right:"60px",top:"54px",padding:"2px",cursor:"pointer",verticalAlign:"top",border:"1px solid #DEDEDE"}).text("Zoom Out").click($.proxy(this._onZoomOut,this)).appendTo(placeholder);},show:function(listener){this.listener=listener;},setData:function(data){this.plot.setData(data);this.plot.setupGrid();this.plot.draw();},_onResize:function(width,height){if(this.plot&&width!=0&&height!=0){this.plot.resize();this.plot.setupGrid();this.plot.draw();}},_onZoomIn:function(e,ranges){this._zoom(ranges.xaxis.from,ranges.xaxis.to);},_onZoomOut:function(e){e&&e.preventDefault();var min=Number.MAX_VALUE,max=Number.MIN_VALUE;$.each(this.plot.getXAxes(),$.proxy(function(_,axis){min=Math.min(min,axis.datamin);max=Math.max(max,axis.datamax);},this));this._zoom(min,max);},_zoom:function(min,max){$.each(this.plot.getXAxes(),function(_,axis){var opts=axis.options;opts.min=min;opts.max=max;});this.plot.setupGrid();this.plot.draw();this.plot.clearSelection();}});