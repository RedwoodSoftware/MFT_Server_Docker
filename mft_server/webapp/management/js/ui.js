/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
var jscape=jscape||{};jscape.ui=jscape.ui||{};jscape.view=jscape.view||{};(function(){var fnTest=/xyz/.test(function(){xyz;})?/\b_super\b/:/.*/;var initializing=false;this.Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this();initializing=false;for(var name in prop){var overwriting=typeof prop[name]==="function"&&typeof _super[name]==="function"&&fnTest.test(prop[name]);prototype[name]=overwriting?(function(name,fn){return function(){var ref=this._super;this._super=_super[name];var result=fn.apply(this,arguments);this._super=ref;return result;}})(name,prop[name]):prop[name];}
function Class(){if(!initializing&&this.initialize){this.initialize.apply(this,arguments);}}
Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;return Class;};})();String.prototype.trim=function(){return this.replace(/(^\s+)|(\s+$)/g,"");};String.prototype.escapeXml=function(){var entities={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"};return this.replace(/[<>&"]/g,function(entry){return entities[entry]});};String.prototype.supplant=function(substitution){return this.replace(/\{([^{}]*)\}/g,function(value,variable){var replacement=substitution[variable];return typeof replacement==="string"||typeof replacement==="number"||typeof replacement==="boolean"?replacement:value;});};(function(){function support(){try{var n=0;n.toLocaleString("i");}catch(e){return"RangeError"===e.name;}return false;}
if(!support()){Number.prototype.toLocaleString=function(_,opts){var n=(opts&&opts.maximumFractionDigits?this.toFixed(opts.maximumFractionDigits):this.toString()).split(".");var s=parseInt(this,10).toString().replace(/\d/g,function(d,i,s){return(i&&(s.length-i)%3==0?",":"")+d;});return n.length>1?s+"."+n[1]:s;};}})();Object._equals=function(o1,o2){if(o1===o2){return true;}
if(o1===null||$.type(o1)!==$.type(o2)){return false;}
if(o1!==o1&&o2!==o2){return true;}
var type=$.type(o1);if(type==="date"){return o1.getTime()==o2.getTime();}else if(type==="regexp"){return o1.toString()==o2.toString();}else if(type==="array"){if(o1.length!=o2.length){return false;}
for(var i=0;i<o1.length;i++){if(!Object._equals(o1[i],o2[i])){return false;}}
return true;}else if(type==="object"){var prop;for(prop in o1){if(o1.hasOwnProperty(prop)&&!Object._equals(o1[prop],o2[prop])){return false;}}
for(prop in o2){if(o2.hasOwnProperty(prop)&&!!o2[prop]&&o1[prop]===undefined){return false;}}
return true;}
return false;};Object._nextId=function(format){var id=(1E9*Math.random()>>>0);return""+(typeof format==="function"?format.call(id):id);};Object._nextIdLetters=function(){return $.map(new Array(16),function(){return String.fromCharCode(Math.random()*26+65);}).join("");};jscape.ui.FormView=Class.extend({_valid:function(){return this.fieldset&&this.fieldset.length?this.fieldset.form("validate"):true;},_bindEvents:function(jq){if(jq&&jq.length){jq.off(".formview").on("contextmenu.formview",$.proxy(this._onForm$ContextMenu,this)).on("_change.formview",$.proxy(function(e){this._onForm$Change(e);},this)).on("input.formview",{target:jq},$.proxy(function(e){this._onForm$Input(e);},this));}},_adjustButtonsBarLayout:function(jq){if(!!jq&&jq.length&&$.data(jq[0],"layout")){jq.layout("panel","south").panel("resize",{height:"auto"});}},_onForm$Change:function(e,t){},_onForm$Input:function(e){var t=$(e.target);var f=$(e.data?e.data.target:null);if(t.length&&t.hasClass("textbox-text")){this._triggerChangeHandler(t);}else if(f.length&&(t.is(":checkbox")||t.is(":radio"))){f.triggerHandler("_change",[t]);}},_onForm$ContextMenu:function(e){e.preventDefault();this._showContextMenu(e,[],$(e.target).closest(".panel-body"));return false;},_triggerChangeHandler:function(t){if(!t.length||!t.is(":focus")||t.closest(".tagbox").length!=0||t.closest(".combo").length!=0||!!t.parent().prev().data("passwordbox")){return false;}
if(t.data("validatebox")&&t.validatebox("options").validateOnBlur===true&&t.validatebox("options").delay>$.fn.validatebox.defaults.delay){return false;}
t.triggerHandler("blur");t.focus();return true;},_showContextMenu:function(e,entries,parent){var suffix=""+Object._nextId();var items=[];for(var i=0,len=entries.length;i<len;++i){var opts=this._contextMenuItemOptions(entries[i],suffix);if(opts.separator){if(items.length<=0||i>=len-1||items[items.length-1].separator){continue;}
items.push(opts);}
if(opts.handler||opts.submenu){items.push(opts);}}
if(items.length){var menu=$("<div></div>").appendTo(parent).menu({onHide:function(){var m=$(this);setTimeout(function(){m.menu("destroy");m=null;},100);}}).off(".js-form").on("contextmenu.js-form",function(e){e.preventDefault();});this._createContextMenu(menu,items).menu("show",{top:e.pageY||0,left:e.pageX||0});}},_createTooltips:function(jq,tipSupplier){return jq.each(function(){var tip=(tipSupplier||$.noop).call(this,this)||"";if(!!tip){$(this).on("mouseenter",function(){$(this).tooltip({content:String(tip).escapeXml(),position:"right",deltaX:$(this).parent().width()-$(this).width(),showEvent:"none",showDelay:0,hideEvent:"none",hideDelay:0,zIndex:"",onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");}).on("mouseleave",function(){$(this).tooltip("hide");});}});},_createContextMenu:function(menu,items,parentItemId){$.each(items,$.proxy(function(_,opts){if(opts.handler||opts.separator){var itemId=parentItemId!==undefined?parentItemId:opts.id;var item=menu.menu("findItem",function(mi){return mi.id&&mi.id==itemId});if(parentItemId&&item&&item.target){menu.menu("appendItem",$.extend(opts,{parent:item.target}));}else{menu.menu("appendItem",opts);}}else if(opts.submenu){var id="_"+Object._nextId();menu.menu("appendItem",{id:id,text:opts.text,disabled:!!opts.disabled});this._createContextMenu(menu,opts.submenu,id);}},this));return menu;},_contextMenuItemOptions:function(menuData,suffix){if("-"===menuData){return{separator:true};}
if(typeof menuData==="object"&&menuData.hasOwnProperty("button")&&menuData.hasOwnProperty("submenu")){if(menuData.button.length&&menuData.submenu.length){var sm=menuData.submenu;var onClick=sm.menu("options").onClick;var subMenuItems=$.map(sm.children(".menu-item"),function(el){return $.extend({},sm.menu("getItem",el),{handler:function(e){var menu=$(e.target).closest(".menu");menu.length&&onClick.call(menu[0],menu.menu("getItem",this));}});});return $.extend(this._contextMenuItemOptions(menuData.button),{handler:null,submenu:subMenuItems});}
return{};}
if(menuData&&menuData.length&&$.data(menuData[0],"linkbutton")){var opts=menuData.linkbutton("options");var text=menuData.text()||opts.text;var id=text.toLowerCase().replace(/[^\w]/g,"")+(suffix||"");return{id:id,text:text,handler:opts.onClick,disabled:!!opts.disabled};}
return $.isPlainObject(menuData)?menuData:{};}});jscape.ui.DefaultDialog=jscape.ui.FormView.extend({id:null,initialize:function(selector,options){this.dialog=$(selector).clone().attr("id",this.getId());var okButtonId="ok"+this.getIdSuffix();this.dialog.dialog($.extend({height:"auto",doSize:false,modal:true,resizable:true,closable:true,closed:true,buttons:[{text:window.R.string.DIALOG_BUTTON_OK||"OK",id:okButtonId,handler:$.proxy(this._onSubmit,this)},{text:window.R.string.DIALOG_BUTTON_CANCEL||"Cancel",handler:$.proxy(this._onCancel,this)}],onClose:$.proxy(function(){if(!this.closing){this._onCancel();}},this)},options)).show();this.dialog.window("window").attr("tabindex",0).css({outline:"none"}).keydown($.proxy(function(e){if(this.isOnTop()){if(e.keyCode==13){if(!(e.target&&"textarea"==e.target.tagName.toLowerCase())){e.stopPropagation();this._onPressEnter(e);}}else if(e.keyCode==27){e.stopPropagation();this._onCancel();}}},this));this.fieldset=this.dialog.find(".content:not([name])").layout({fit:true,border:false,doSize:false}).first();this.form=this.dialog.dialog("body").children().first().wrap("<form></form>").parent();this.form.attr("method","dialog").form({novalidate:false,focusOnValidate:false,onChange:$.proxy(this._onForm$Change,this),onSubmit:function(){return false;}}).panel({fit:true,noheader:true,border:false,doSize:false});this.title=this.dialog.dialog("header").text()||"";this.okButton=this.dialog.siblings(".dialog-button").children("#"+okButtonId);this.okButton.linkbutton("disable");this._adjustChildrenId(this.dialog);},getId:function(){if(this.id==null){this.id=this._nextId();}
return this.id;},getIdSuffix:function(){return"_"+this.getId();},idFor:function(id){return id+this.getIdSuffix();},isOnTop:function(){var zIndexes=$.map(document.getElementsByClassName("window"),function(w){return parseInt($(w).css("z-index"));}).sort();return zIndexes.length&&zIndexes.pop()==parseInt(this.dialog.dialog("window").css("z-index"));},setTitle:function(title){this.dialog.dialog("setTitle",title||"");},show:function(listener){this.listener=listener;this._bindEvents(this.form);this.dialog.dialog("center").dialog("open");this._fitIfOversize(document);this._createFormTips(this.form);this._resetForm(this.form);this._onForm$Change();this._setFocusOnFirst(this.form);},hide:function(){this._enableFormValidation(this.form,false);if(this.dialog&&this.dialog.length&&$.data(this.dialog[0],"dialog")&&!this.dialog.dialog("options").closed){this.closing=true;this._destroyFormTips(this.form);this.dialog.dialog("close");this.closing=false;}},destroy:function(){this._enableFormValidation(this.form,false);this._resetForm(this.form);if(this.dialog&&this.dialog.length&&$.data(this.dialog[0],"dialog")){this.dialog.dialog("destroy");this.okButton=null;}},_bindEvents:function(jq){if(!jq||!jq.length){return;}
jq.find(".textbox-text").off(".dialogform").on("input.dialogform",{target:jq},$.proxy(function(e){var t=$(e.target);var f=$(e.data.target);if(f&&f.length){if(this._triggerChangeHandler(t)){f.trigger("_change",[t]);}}},this));},_fitIfOversize:function(parent){var height=$(parent).outerHeight();if(height<this.dialog.dialog("dialog").height()){var opts=this.dialog.dialog("options");var top=null;if(opts.top<0){top=0;height+=opts.top;}
this.dialog.dialog("resize",{minHeight:opts.minHeight>height?height:null,maxHeight:height,top:top});}},_createFormTips:function(jq){if(!jq||!jq.length){return;}
jq.find("[role=tooltip]").each(function(){var t=$(this);var db=t.attr("aria-describedby");var desc=!!db?$("#"+db):$();t.tooltip({showDelay:0,position:"bottom",content:desc.length?desc.html():undefined,onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");}});});},_destroyFormTips:function(jq){jq&&jq.length&&jq.find("[role=tooltip]").tooltip("destroy");},_resetForm:function(jq){jq&&jq.length&&jq.form("resetDirty").form("validate");return jq;},_enableFormValidation:function(jq,enable){jq&&jq.length&&jq.form(!!enable?"enableValidation":"disableValidation");return jq;},_setFocusOnFirst:function(jq){jq&&jq.length&&jq.find(":input").filter(":not(:disabled):not(:checkbox):not(:hidden)").first().focus();return jq;},_valid:function(){return this.form&&this.form.length?this.form.form("validate"):true;},_changed:function(){if(this.listener&&"function"===typeof this.listener.hasChanged){return this.listener.hasChanged(this);}
return true;},_onPressEnter:function(e){if(e&&e.isDefaultPrevented()){return;}
var btn=this._defaultButton();btn&&btn.click();},_onForm$Change:function(){var btn=this._defaultButton();btn&&btn.linkbutton(!this._changed()||!this._valid()?"disable":"enable");},_onSubmit:function(){if(this._valid()&&this.listener&&this.listener.onSubmit){var body=this.dialog.dialog("body");var mask=body.children("div.datagrid-mask");if(!mask.length){mask=$("<div class=\"datagrid-mask\" style=\"display:block\"></div>").appendTo(body);}
var btn=this._defaultButton()||$();btn.linkbutton("disable");var p=this.listener.onSubmit(this);if(typeof p==="object"&&typeof p.promise==="function"){p.done($.proxy(this.destroy,this)).fail(function(){btn.linkbutton("enable");mask.remove();mask=btn=undefined});}else{mask.remove();btn=this._defaultButton();btn&&btn.linkbutton("enable");}}},_onCancel:function(){if(this.listener&&this.listener.onCancel){this.listener.onCancel(this);}},_defaultButton:function(){return this.okButton&&this.okButton.length?this.okButton:null;},_adjustChildrenId:function(parent){function _update(elem,attr,suffix){elem.each(function(){$(this).attr(attr,$(this).attr(attr)+suffix);});}
parent=parent||this.dialog;var suffix=this.getIdSuffix();_update(parent.find("[id]"),"id",suffix);_update(parent.find("label[for]"),"for",suffix);_update(parent.find("[aria-describedby]"),"aria-describedby",suffix);},_nextId:function(prefix){return(prefix||"")+Object._nextId();}});jscape.ui.ExportDialog=jscape.ui.DefaultDialog.extend({initialize:function(selector,options){this._super(selector,$.extend({width:"50%",minWidth:500,maxWidth:750,minHeight:230},options||{}));this.filename=$("input[name=filename]",this.dialog).textbox({required:true,validType:"non_empty",width:"60%"});},getFilename:function(){return this.filename.textbox("getValue");},setFilename:function(value){this.filename.textbox("setValue",value).textbox("textbox").focus();}});jscape.ConfirmDialog={};jscape.ConfirmDialog.confirm=function(title,message,escape,options,preventConfirmation){var deferred=$.Deferred();var dlg=$.messager.confirm($.extend({title:title,msg:message,escapeXml:escape!==false,fn:function(confirmed){if(confirmed){deferred.resolve(confirmed,!!this.__dontShowAgain);}else{deferred.reject();}
deferred=null;},onClose:function(){var opts=$(this).dialog("options");!opts.__handled&&opts.fn(false);}},options||{}));dlg.next(".messager-button").find(".l-btn").each(function(){var opts=$(this).linkbutton("options");var onClick=opts.onClick;opts.onClick=function(){var opts=dlg.dialog("options");opts.__handled=true;opts.__dontShowAgain=dlg.find("input[name=dontshowagain]").is(":checked");onClick&&onClick.apply(this,arguments);}});if(preventConfirmation===true){dlg.find(".messager-question").parent().append('<div style="font-size:small;text-align:center;opacity:.7"><label><input type="checkbox" name="dontshowagain" />'+String(window.R.string.APPLICATION_MESSAGE_NOT_SHOW_AGAIN||"Don't show this message again").escapeXml()+'</label></div>');}
return deferred.promise();};jscape.view.WizardDialog=jscape.ui.DefaultDialog.extend({index:-1,items:null,initialize:function(dialog,options){this._super(dialog,$.extend({width:"50%",height:"auto",minWidth:700,minHeight:400,resizable:false,buttons:[{id:"wizard-btn-back",text:window.R.string.DIALOG_BUTTON_BACK||"< Back",handler:$.proxy(this._onBack,this),disabled:true},{id:"wizard-btn-next",text:window.R.string.DIALOG_BUTTON_NEXT||"Next >",handler:$.proxy(this._onNext,this)},{id:"wizard-btn-submit",text:window.R.string.DIALOG_BUTTON_OK||"OK",handler:$.proxy(this._onSubmit,this)},{text:window.R.string.DIALOG_BUTTON_CANCEL||"Cancel",handler:$.proxy(this._onCancel,this)}]},options||{}));this.items=[];var container=this.dialog.dialog("dialog");this.backButton=container.find("#wizard-btn-back");this.nextButton=container.find("#wizard-btn-next");this.okButton=container.find("#wizard-btn-submit");},container:function(){return this.dialog;},addItem:function(item){this.items.push(item);return item;},getItem:function(index){return index>=0&&index<this.items.length?this.items[index]:null;},getCurrentItem:function(){return this.getItem(this.index);},setCurrentItem:function(index){var previous=this.index;this.index=Math.max(0,Math.min(index,this.items.length-1));if(previous!=this.index){if(previous>=0&&previous<this.items.length){var item=this.items[previous];item&&item.pause();}
var current=this.getCurrentItem();current&&current.resume();setTimeout($.proxy(function(d){d.dialog("resize");},this,this.dialog),0);this.listener.onPageSelected(this);}
this._adjustDialogTitle();this._adjustButtonsState();},validate:function(){var item=this.getCurrentItem();return item&&typeof item.valid=="function"&&item.valid();},show:function(listener){this._super(listener||jscape.view.WizardDialog.LISTENER);this.setCurrentItem(0);this.dialog.dialog("center").find("input[type=text]:visible:not(:disabled)").first().focus();},_onBack:function(){this.backButton.linkbutton("disable");this.setCurrentItem(this.index-1);},_onNext:function(){this.nextButton.linkbutton("disable");if(this.validate()){this.setCurrentItem(this.index+1);}else{this._adjustButtonsState();}},_onSubmit:function(){if(this.validate()){var item=this.getCurrentItem();if(this.listener&&this.listener.onSubmit){this.okButton.linkbutton("disable");item.pause(true);var p=this.listener.onSubmit(this);if(typeof p==="object"&&typeof p.promise==="function"){p.done($.proxy(function(){this.destroy()},this)).fail($.proxy(function(){this.okButton.linkbutton("enable");item.resume();},this));}else{this.okButton.linkbutton("enable");}}}},_adjustDialogTitle:function(){if(this.index>=0){this.dialog.dialog("setTitle",this.title.supplant({0:this.index+1,1:this.items.length}));}},_adjustButtonsState:function(){this.backButton.linkbutton(this.index>0?"enable":"disable");this.nextButton.linkbutton(this.index<this.items.length-1?"enable":"disable");this.okButton.linkbutton(this.index==this.items.length-1?"enable":"disable");if(this.index==this.items.length-1){this.nextButton.hide();this.okButton.show();}else{this.nextButton.show();this.okButton.hide();}}});jscape.view.WizardDialog.LISTENER={onPageSelected:$.noop,onSubmit:$.noop,onCancel:$.noop};jscape.view.WizardDialog.Page=Class.extend({resume:function(){},pause:function(){},valid:function(){return true;}});jscape.view.ListView=Class.extend({items:null,currentKey:null,initialize:function(){this.items={};},addItem:function(key,value){this.items[key]=value;},getItem:function(key){return this.items.hasOwnProperty(key)?this.items[key]:null;},getCurrentItem:function(){return this.currentKey;},setCurrentItem:function(key){var previousKey=this.currentKey;this.currentKey=key;if(previousKey!=this.currentKey){var item=this.items[previousKey];if(item&&typeof item.pause==="function"){item.pause();}
item=this.items[key];if(typeof item==="function"){item=this._createItem(item);this.items[key]=item;}
if(item&&typeof item.resume==="function"){item.resume();}}},_createItem:function(item){return item;}});jscape.AutoCompleteController=Class.extend({ID:"autocomplete-list",list:null,initialize:function(){this.list=$("#"+this.ID);},start:function(input,options,formOnChange){this.input=input;this.formOnChange=!!formOnChange;this._create($.isArray(options)?{data:this._formatData(options)}:options).combobox("showPanel").combobox("clear").combobox("textbox").focus();},_formatData:function(items){return $.map(items||[],function(item){return typeof item=="object"?$.extend({},item,{value:item.value||item.text}):{value:item,text:item};});},_create:function(options){if(this.list==null||this.list.length==0){this.list=$("<select id='"+this.ID+"'></select>");this.list.appendTo(document.body);}
this.list.combobox($.extend({editable:true,hasDownArrow:false,delay:0,filter:function(query,row){function _c(a,b){return String(a).toLocaleLowerCase().indexOf(String(b).toLocaleLowerCase())>=0;}
var opts=$(this).combobox("options");return _c(row[opts.valueField],query)||(opts.groupField&&_c(row[opts.groupField],query));},formatter:$.proxy(this._formatRow,this),onLoadSuccess:$.proxy(this._createTooltips,this),onHidePanel:$.proxy(this._onHide$Panel,this),width:250,panelHeight:"auto",panelMinHeight:50,panelMaxHeight:"50%"},options||{}));this._align();return this.list;},_align:function(){var offset=this.input.offset();var left=Math.max(0,Math.min(offset.left,$(window).outerWidth()+$(document).scrollLeft()-this.list.outerWidth()-5));var top=Math.max(0,Math.min(offset.top+this.input.outerHeight(),$(window).outerHeight()+$(document).scrollTop()-this.list.outerHeight()-5));this.list.combobox("textbox").parent().css({position:"absolute",left:left,top:top,zIndex:$.fn.window.defaults.zIndex++});},_onHide$Panel:function(e){var value=this.list.combobox("getValue");if(value){this._insertText(this.input,value);}
this.input.focus();this.list.combobox("destroy");this.input=null;this.list=null;},_formatRow:function(row){var text=(""+row.text).escapeXml();if(row.tooltip){return'<span aria-desribedby="{id}">{text}</span><div role="tooltip" id="{id}" style="display:none">{tooltip}</div>'.supplant({id:Object._nextId()+"-tip",text:text,tooltip:row.tooltip});}
if(row.title||row.description){var tip=""+(row.title||row.description);return'<span aria-label="{tip}">{text}</span>'.supplant({tip:tip.escapeXml(),text:text})}
return text;},_createTooltips:function(){this.list.combobox("panel").find(".combobox-item").each(function(){var tip=$(this).find("span[aria-label]").attr("aria-label")||"";var tooltipId=$(this).find("[role=tooltip]").attr("id")||"";if(tip||tooltipId){$(this).on("mouseenter",function(){var content=tip?'<div class="tooltip-title"><code>'+$(this).text()+'</code></div>'+tip:$("#"+tooltipId).html();$(this).tooltip({content:content,position:"right",deltaX:$(this).parent().width()-$(this).width(),showEvent:"none",showDelay:0,hideEvent:"none",hideDelay:0,zIndex:"",onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");}).on("mouseleave",function(){$(this).tooltip("hide");});}});},_insertText:function(input,text){var value=input.val();var tb=input.parent().prev();if(tb.data("textbox")){if(tb.data("filebox")){tb.textbox("setText",text);}else{var range=tb.textbox("getSelectionRange");tb.textbox("initValue",value.substring(0,range.start)+text+value.substring(range.end));tb.textbox("setSelectionRange",{start:range.start,end:range.start+text.length});}
input.blur();}else{var caret=this._caret(input);input.focus();input.val(value.substring(0,caret.start)+text+value.substring(caret.end));input.blur();input[0].selectionStart=input[0].selectionEnd=input[0].selectionStart+text.length;input.change();}
if(this.formOnChange){input.closest("form").trigger("change");}},_caret:function(input){var caret={start:0,end:0};if(document.selection&&document.selection.createRange){var r1,r2,selection=document.selection;if("textarea"==input[0].tagName.toLowerCase()){r1=selection.createRange();r2=r1.duplicate();r2.moveToElementText(input[0]);r2.setEndPoint("EndToEnd",r1);caret.start=r2.text.length-r1.text.length;caret.end=caret.start+r1.text.length;}else{var value=input.val();r1=selection.createRange().duplicate();r2=selection.createRange().duplicate();r1.moveEnd("character",value.length);r2.moveStart("character",-value.length);caret.start=r1.text.length?value.lastIndexOf(r1.text):value.length;caret.end=r2.text.length;}}else{caret.start=input[0].selectionStart;caret.end=input[0].selectionEnd;}
return caret;}});jscape.LexicalDecorator=jscape.AutoCompleteController.extend({initialize:function(beginChar,endChar){this.beginChar=beginChar;this.endChar=endChar;},_insertText:function(input,value){if(this._nestedContext(input)){this._super(input,value);}else{this._super(input,this.beginChar+value+this.endChar);}},_nestedContext:function(input){if(!this.beginChar||!this.endChar){return false;}
var text=input.val().substring(0,this._caret(input).start);var count=0,i=0;while(i<text.length){if(this._startsWith(text,i,this.beginChar)){count++;i+=this.beginChar.length;}else if(this._startsWith(text,i,this.endChar)){count++;i+=this.endChar.length;}else{i++;}}
return count%2!=0;},_startsWith:function(text,pos,search){return search===text.substr(!pos||pos<0?0:+pos,search.length);}});jscape.VariableController=jscape.LexicalDecorator.extend({initialize:function(beginChar,endChar){this._super(beginChar!==undefined?beginChar:'%',endChar!==undefined?endChar:'%');},start:function(input,options,formOnChange){return this._super(input,$.extend({panelValign:"bottom",loadFilter:function(data){return $.map(data,function(entry){return entry&&entry.hasOwnProperty("text")&&entry.hasOwnProperty("value")?entry:{text:entry.name||entry,value:entry.name||entry,description:entry.description||""};});}},$.isArray(options)?{data:options}:options),formOnChange);}});jscape.FunctionController=jscape.LexicalDecorator.extend({initialize:function(beginChar,endChar){this._super(beginChar!==undefined?beginChar:'%',endChar!==undefined?endChar:'%');},start:function(input,options,formOnChange){return this._super(input,$.extend({groupField:"group",groupPosition:"sticky",helpField:"help",panelValign:"bottom",loadFilter:function(data){var entries=[];var opts=$(this).combobox("options");for(var i=0,len=data.length;i<len;++i){var row=data[i];var help=row[opts.helpField]||{};$.each(row.templates,function(key,value){entries.push({value:key,text:key.replace(/(.*)(\(.*)/,"$1 $2"),tooltip:help&&help.description?'<div class="tooltip-title">'+help.description+"</div>"
+(help.example?"<code>"+(help.example+"").escapeXml()+"</code>":"")
+(help.result?"<div>"+(help.result+"").escapeXml()+"</div>":""):undefined,description:value,group:row[opts.groupField]||""});});}
return entries;}},$.isArray(options)?{data:options}:options),formOnChange);}});jscape.FreemarkerVariableController=jscape.LexicalDecorator.extend({initialize:function(){this._super("${","}");}});jscape.CopyToClipboardController=Class.extend({start:function(text,target,message){var d=$.Deferred();if(text&&this._copyText(text)){d.resolve();}else{d.reject();}
return d.promise().done($.proxy(this._showTooltip,this,target,message));},_copyText:function(text){var $el=$("<textarea id='__"+Object._nextId()+"'></textarea>").css({position:"absolute",top:0,left:"-100000px"}).appendTo("body");try{$el[0].textContent=text;$el[0].focus();$el[0].setSelectionRange(0,$el.val().length);return document.execCommand("copy");}catch(e){return false;}finally{$el[0].textContent="";$el.remove();}},_showTooltip:function(target,message){message=message||"Copied";if(target&&target.length){target.tooltip({content:message,position:"right",showEvent:"none",showDelay:0,hideEvent:"none",hideDelay:2000,onShow:function(){$(this).tooltip("hide");},onHide:function(){$(this).tooltip("destroy");}}).tooltip("show");}else{$(document).triggerHandler("broadcast",[message]);}}});jscape.Hours=Class.extend({SECONDS_PER_MINUTE:60,MINUTES_PER_HOUR:60,MILLISECONDS_PER_SECOND:1000,MILLISECONDS_PER_MINUTE:1000*60,MILLISECONDS_PER_HOUR:1000*60*60,initialize:function(value){this.hours=value/this.MILLISECONDS_PER_HOUR|0;value%=this.MILLISECONDS_PER_HOUR;this.minutes=value/this.MILLISECONDS_PER_MINUTE|0;value%=this.MILLISECONDS_PER_MINUTE;this.seconds=value/this.MILLISECONDS_PER_SECOND|0;this.millis=value%this.MILLISECONDS_PER_SECOND|0;},_format:function(val){return val>9?""+val:"0"+val;},toString:function(){return this._format(this.hours)+":"+this._format(this.minutes)+":"+this._format(this.seconds);}});jscape.SizeFormat=Class.extend({SIZE:{BYTE:{factor:1,unit:"byte(s)"},KB:{factor:1024,unit:"KiB"},MB:{factor:1024*1024,unit:"MiB"},GB:{factor:1024*1024*1024,unit:"GiB"},TB:{factor:1024*1024*1024*1024,unit:"TiB"}},format:function(value){var size;if(value<this.SIZE.KB.factor){size=this.SIZE.BYTE;}else if(this.SIZE.KB.factor<=value&&value<this.SIZE.MB.factor){size=this.SIZE.KB;}else if(this.SIZE.MB.factor<=value&&value<this.SIZE.GB.factor){size=this.SIZE.MB;}else if(this.SIZE.GB.factor<=value&&value<this.SIZE.TB.factor){size=this.SIZE.GB;}else{size=this.SIZE.TB;}
var digits=size==this.SIZE.BYTE?0:2;return(value/size.factor).toFixed(digits)+" "+size.unit;}});jscape.SizeFormat.format=function(value){return new jscape.SizeFormat().format(value);};jscape.DateFormat=Class.extend({initialize:function(pattern){this.pattern=pattern||"{hh}:{mm}:{ss} {MM}-{dd}-{yy}";},format:function(date){var year=date.getFullYear();var month=date.getMonth()+1;var day=date.getDate();var hours=date.getHours();var minutes=date.getMinutes();var seconds=date.getSeconds();var millis=date.getMilliseconds();return this.pattern.supplant({d:day,dd:this._leadingZero(day),M:month,MM:this._leadingZero(month),y:year,yy:this._leadingZero(year),h:hours,hh:this._leadingZero(hours),m:minutes,mm:this._leadingZero(minutes),s:seconds,ss:this._leadingZero(seconds),S:millis,SS:this._leadingZero(millis)});},_leadingZero:function(value){return(value<10?"0":"")+value;}});jscape.DateFormat.format=function(value,pattern){return value?new jscape.DateFormat(pattern).format(typeof value==="number"?new Date(value):value):"";};jscape.Validator=Class.extend({rule:function(key,validator,message){var rules={};rules[key]={validator:validator,message:message||"Please provide valid data."};$.extend($.fn.validatebox.defaults.rules,rules);},ruleAsync:function(key,validator,message){this.rule(key,jscape.Validator.asyncValidator(validator,key,message),"");},ruleMessage:function(key,message){var rule=$.fn.validatebox.defaults.rules[key];if(rule){if(arguments.length==1){return rule.message;}
rule.message=message;}},removeRule:function(key){if(key in $.fn.validatebox.defaults.rules){delete $.fn.validatebox.defaults.rules[key];}},nonEmptyRule:function(key,message){this.rule(key,function(value){return value.trim().length!=0;},message);},isSatisfied:function(key,args){var rule=$.fn.validatebox.defaults.rules[key];return rule&&rule.validator?rule.validator.apply(rule.validator,Array.prototype.slice.call(arguments,1)):true;},validateTabs:function(tabs,focusOnValidate){var fields=tabs.find(".validatebox-text:not(:disabled)");for(var i=0;i<fields.length;i++){var field=$(fields[i]);if(!field.validatebox("isValid")){if(focusOnValidate!==false){this._navigateFrom(field);field.focus();}
return false;}}
return true;},_navigateFrom:function(source){source.parents(".tabs-container").each($.proxy(function(_,elem){var tabs=$(elem);var tabIndex=-1;$.each(tabs.tabs("tabs"),function(i,target){if(target.has(source).length!=0){tabIndex=i;return false;}
return true;});if(tabIndex!=-1){tabs.tabs("select",tabIndex);}
if(this.tabs!=tabs){this._navigateFrom(tabs);}},this));}});jscape.Validator.asyncValidator=function(validator,key,message){function _onValid(target,result){if((typeof result==="object"||typeof result==="function")&&result.then){result.then.call(result,function(result){return result&&result.valid===false?$.Deferred().reject((result||Object._create(null)).message||message):$.Deferred().resolve(true,"");}).catch(function(error){return $.Deferred().resolve(false,error||message);}).then(function(valid,message){var state=target.length?$.data(target[0],"validatebox"):null;if(!state){return;}
var v=new jscape.Validator();var tmpRuleKey="async_"+Object._nextIdLetters();var opts=target.validatebox("options");var oldValidType=opts.validType;var oldDelay=opts.delay;try{v.rule(tmpRuleKey,function(){return!!valid;},message);opts.validType=$.isArray(oldValidType)?$.grep([tmpRuleKey].concat(oldValidType),function(val){return val!==key;}):tmpRuleKey;opts.delay=0;if(target.validatebox("isValid")){target.closest("form").triggerHandler("_change");}}finally{opts.validType=oldValidType;opts.delay=oldDelay;v.removeRule(tmpRuleKey);}});}else{_onValid(target,$.Deferred().resolve(result));}}
return function(value,params){var args=Array.prototype.slice.call(arguments,arguments.length>1?2:1);var selector=$.isArray(params)&&params.length?$.map(params,function(obj){return $.isPlainObject(obj)&&obj.hasOwnProperty("selector")?obj.selector:null;})[0]:params;var target=typeof selector==="string"?$(selector):typeof selector==="function"?selector.apply(selector,args):$();var state=target.length?$.data(target[0],"validatebox"):null;if(!state){return true;}
setTimeout(function(){_onValid(target,validator.call(validator,value,params));},0);return false;};};$.fn._unitValueFor=function(factorInput,value){var unit=1;if(factorInput&&factorInput.length){var opts=factorInput.combobox("options");var units=$.map(factorInput.combobox("getData"),function(entry){return parseInt(entry[opts.valueField]);});units.sort(function(a,b){return a-b;});while(units.length){unit=units.pop();if(value%unit==0){break;}}}
return unit;};jscape.ui.DatagridController=Class.extend({suppressMessages:false,initialize:function(suppressMessages){this.suppressMessages=suppressMessages!=undefined?!!suppressMessages:false;},_recordAdded:function(record){this._fireApplySuccess();this._reloadAndSelect(record);},_recordEdited:function(record){this._fireApplySuccess();this._reloadAndSelect(record);},_recordDeleted:function(records){var copy=[].concat(records);var index=-1;while(copy.length){index=this.view.indexOf(copy.shift());this.view.deleteRecord(index);}
var rows=this.view.getRecords();if(rows.length>0){index=Math.min(Math.max(0,index),rows.length-1);this._reloadAndSelect(rows[index]);}else{this._gotoPreviousPage();}},_reloadAndSelect:function(record){this.view.refresh($.proxy(function(){record&&this.view.selectRecord(record);},this));},_gotoPreviousPage:function(){this.view.previousPage($.proxy(function(){var records=this.view.getRecords();records.length&&this.view.selectRecord(records[records.length-1]);},this));},_fireApplySuccess:function(){if(!this.suppressMessages){$(document).triggerHandler("broadcast",[window.R.string.APPLICATION_SUCCESS_APPLY]);}}});jscape.ui.DatagridView=jscape.ui.FormView.extend({refresh:function(callback){this.data.datagrid("reload",callback);},search:function(query){var fb=this.data.datagrid("getFindbar");if(fb&&fb.length&&!!query){fb.findbar("show").findbar("setQuery",query).findbar("search");}},firstPage:function(){this.data.datagrid("gotoPage",{page:1});},previousPage:function(callback){var pageNumber=this.data.datagrid("options").pageNumber;if(pageNumber>1&&this.data.datagrid("getData").total>0){this.data.datagrid("gotoPage",{page:--pageNumber,callback:callback});}else{this.data.datagrid("reload",callback);}},nextPage:function(callback){var opts=this.data.datagrid("options");var total=this.data.datagrid("getData").total;if(opts.pageNumber>0&&total>0&&Math.ceil(total/opts.pageSize)>opts.pageNumber){this.data.datagrid("gotoPage",{page:opts.pageNumber+1,callback:callback});}else{this.data.datagrid("reload",callback);}},getRecords:function(){return this.data.datagrid("getRows");},indexOf:function(value){return this.data.datagrid("getRowIndex",this._valueOf(value));},deleteRecord:function(value){var index=isNaN(parseInt(value))?this.indexOf(value):value;this.data.datagrid("deleteRow",index);},selectRecord:function(value){var index=this.indexOf(value);if(index!=-1){if(!this.data.datagrid("options").singleSelect){this.data.datagrid("clearSelections");}
this.data.datagrid("selectRow",index);}},_valueOf:function(obj){var idField=this.data.datagrid("options").idField;return obj&&typeof obj=="object"&&idField in obj?obj[idField]:obj;},_pageSelectionFor:function(grid){var opts=grid.datagrid("options");var selection=grid.datagrid("getSelections");if(!opts.pagination||!opts.idField){return selection;}
var pageIds=$.map(grid.datagrid("getRows"),function(row){return row[opts.idField];});return $.grep(selection,function(row){return $.inArray(row[opts.idField],pageIds)!=-1;});},_initDragAndDrop:function(target){target.off(".dropzone").on("dragenter.dropzone",{target:target},$.proxy(function(e){if(!!this._acceptDataTransfer(e)){e.stopPropagation();e.preventDefault();this._createDropArea(e);this._onDragEnter(e);}},this)).on("dragover.dropzone",$.proxy(function(e){if(!!this._acceptDataTransfer(e)){e.stopPropagation();e.preventDefault();this._onDragOver(e);}},this)).on("dragleave.dropzone",{target:target},$.proxy(function(e){var target=$(e.data.target);var offset=target.offset();if(!(e.pageX>offset.left&&e.pageX<offset.left+target.outerWidth()&&e.pageY>offset.top&&e.pageY<offset.top+target.outerHeight())){this._destroyDropArea(e);}
return false;},this)).on("drop.dropzone",{target:target},$.proxy(function(e){if(!!this._acceptDataTransfer(e)){e.stopPropagation();e.preventDefault();this._destroyDropArea(e);this._onDrop(e);}},this));},_acceptDataTransfer:function(e){return $.inArray("Files",e.originalEvent.dataTransfer.types)!=-1;},_createDropArea:function(e,message){var p=$(e.data.target);var tc=p.find(".droppable");if(p.length&&tc.length==0){tc=$("<span></span>").appendTo(p).addClass("droppable").css({position:"absolute",top:0,left:0,bottom:0,right:0});tc.append("<span></span>").text(message||"Drop files here").css({"display":"flex","height":"100%","flex-direction":"column","justify-content":"center","align-items":"center","font-size":"xx-large","font-weight":"800","background-color":"#FFF","opacity":.85});}
return tc;},_destroyDropArea:function(e){var p=$(e.data.target);if(p.length){p.find(".droppable").remove();}},_onDragEnter:function(e){},_onDragOver:function(e){var dt=e.originalEvent.dataTransfer;var p=$(e.target).closest(".droppable");if(p.length){dt.effectAllowed="copyMove";dt.dropEffect="move";}else{dt.effectAllowed="none";dt.dropEffect="none";}},_onDrop:function(e){},_onRow$ContextMenu:function(e,index,row){e.preventDefault();var grid=(this.data||$(e.target).closest("div.datagrid-view").children(".datagrid-f"));if(grid&&grid.length){grid.datagrid("cancelEdit");if(row&&index>=0){var selection=grid.datagrid("getSelections");if($.inArray(row,selection)===-1){grid.datagrid("unselectAll").datagrid("selectRow",index);}}else{grid.datagrid("unselectAll");}
this._showContextMenu(e,[]);}},_showContextMenu:function(e,entries){this._super(e,entries,$(e.target).closest(".datagrid-body"));},_createFinder:function(type,opts){if(type=="combobox"){opts=$.extend({editable:true,limitToList:false,autoSelectFirst:false,width:500,panelMinHeight:50,panelHeight:"auto",panelMaxHeight:"40%",onShowPanel:function(){var t=$(this);if(!t.combobox("options").variantsLoaded){t.combobox("reload");}
if(!t.combobox("options").variantsLoaded){t.combobox("loading").combobox("reload");}},onLoadSuccess:function(data){var t=$(this);t.combobox("loaded");if(data&&data.length){t.combobox("options").variantsLoaded=true;t.combobox("panel").panel("resize",{width:"auto",minWidth:t.outerWidth()});}},onLoadError:function(){$(this).combobox("loaded");$(this).combobox("panel").panel("resize",$.fn.combobox.defaults);}},opts||{});}
return{type:type,options:$.extend({},opts||{})};}});jscape.ui.DefaultImportController=Class.extend({_listFileEntries:function(data,type){var promises=[];if("DataTransfer"in window&&data instanceof DataTransfer&&data.items){for(var i=0,items=data.items,len=items.length;i<len;++i){var item=items[i];if(item.kind!==type){continue;}
if(item.getAsEntry){promises.push(this._readEntryContentAsync(item.getAsEntry()));}else if(item.webkitGetAsEntry){promises.push(this._readEntryContentAsync(item.webkitGetAsEntry()));}else{promises.push($.Deferred().resolve(item.getAsFile()).promise());}}}
return $.when.apply(jQuery,promises).then(function(){return $.map(arguments,function(f){return f;});});},_readEntryContentAsync:function(fileSystemEntry){var deferred=$.Deferred();var active=0;function _assertReadingComplete(count,result){if(count===0){deferred.resolve(result);}}
(function _readFileSystemEntry(fse,result,useFullPath){if(fse.isFile){++active;fse.file(function(file){if(useFullPath===true){var reader=new FileReader();var filename=fse.fullPath.replace(/(\\|\/)/g,":");reader.onload=function(e){result.push(new File([e.target.result],filename));_assertReadingComplete(--active,result);};reader.onerror=function(){_assertReadingComplete(--active,result);};reader.readAsArrayBuffer(file);}else{result.push(file);_assertReadingComplete(--active,result);}});}else if(fse.isDirectory){++active;(function _readDirEntries(reader){reader.readEntries(function(entries){if(entries.length){for(var i=0,len=entries.length;i<len;++i){_readFileSystemEntry(entries[i],result,true);}
_readDirEntries(reader);}else{_assertReadingComplete(--active,result);}})})(fse.createReader());}})(fileSystemEntry,[]);return deferred.promise();}});