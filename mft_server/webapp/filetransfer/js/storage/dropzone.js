/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.dropzone=jscape.dropzone||{};jscape.dropzone.DropZoneApplication=jscape.Application.extend({timer:null,uploadFormRequired:false,initialize:function(fileUploadMetadataRequired,timeout){this._super();this.uploadFormRequired=!!fileUploadMetadataRequired;this.timeout=timeout||-1;},onReady:function(){this._super();this.view=new jscape.dropzone.DropZoneView();this.view.show(this);this.controller=new jscape.storage.UploadFileController(new jscape.storage.UploadProgressListView(this.view.getUploadProgressList()),this.uploadFormRequired,false);this._ping();},onUploadFile:function(mode,files,dataTransfer){this._stopPing();return this.controller.start(mode,files,null,dataTransfer).done($.proxy(this._fireMessage,this,window.R.string.STORAGE_SUCCESS_UPLOAD)).fail(function(error){if(error&&error.force){$.messager.alert(window.R.string.APPLICATION_TITLE,error.message||window.R.string.STORAGE_ERROR_UPLOAD,"error");}}).always($.proxy(function(){this._ping();},this));},_stopPing:function(){if(this.timer){clearTimeout(this.timer);this.timer=null;}},_ping:function(){this._stopPing();if(this.timeout>0){this.timer=setTimeout($.proxy(function(){this.timer=null;jscape.API.ping().then(function(data){return data&&data.pong;},function(data){return data&&data.status===0;}).done($.proxy(function(complete){if(complete){this._ping();}else{window.location.reload(true);}},this));},this),this.timeout);}},_destroy:function(){this._super();this.controller=null;this.view=null;},_fireMessage:function(message){if(message){$(document).triggerHandler("broadcast",[message]);}}});jscape.dropzone.DropZoneView=Class.extend({initialize:function(){$("body").css("overflow","hidden");this.layout=$("#dropzone-layout").layout({fit:true,doSize:false,border:true});this.uploadMode=$("#uploadmodemenu");this.uploadButton=this.uploadMode.length?$("a[role=button][name=upload]",this.layout).splitbutton({plain:false,menu:"#uploadmodemenu",onClick:$.proxy(this._onClick$UploadButton,this)}):$("a[role=button][name=upload]",this.layout).linkbutton({onClick:$.proxy(this._onClick$UploadButton,this)});this.progressList=this.layout.find(".upload-progress-container");this.dropzone=this.layout.find(".dropzone");var dz=this.dropzone;$(window).on("dragenter dragover",function(e){var dt=e.originalEvent.dataTransfer;if($.inArray("Files",dt.types)==-1){return;}
e.stopPropagation();e.preventDefault();dz.addClass("hover");if($(e.target).hasClass("dropzone")){dt.effectAllowed="copyMove";dt.dropEffect="move";}else{dt.effectAllowed="none";dt.dropEffect="none";}}).on("dragleave",function(e){e.stopPropagation();e.preventDefault();if(e.originalEvent.clientX<=0||e.originalEvent.clientY<=0){dz.removeClass("hover");}}).on("drop",$.proxy(function(e){if($.inArray("Files",e.originalEvent.dataTransfer.types)==-1){return;}
e.preventDefault();e.stopPropagation();if($(e.target).hasClass("dropzone")){$(e.target).removeClass("hover");this._onDrop$File(e.originalEvent.dataTransfer);}},this));},show:function(listener){this.listener=listener||jscape.dropzone.DropZoneView.LISTENER;this.layout.layout("resize");},getUploadProgressList:function(){return this.progressList;},_onClick$UploadButton:function(){this.listener.onUploadFile(this._uploadMode());},_onDrop$File:function(dataTransfer){var files=dataTransfer.files;if(files&&files.length){this.listener.onUploadFile(this._uploadMode(),files,dataTransfer);}},_uploadMode:function(){return this.uploadMode.length?this.uploadMode.find(":checked").val():null;}});