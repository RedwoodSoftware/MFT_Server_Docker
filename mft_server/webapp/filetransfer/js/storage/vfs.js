/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.storage=jscape.storage||{};jscape.FileInfo=Class.extend({initialize:function(a,b,c,d,e,f,g){this.path=a==""?"/":a+"";this.name=b||"";this.directory=!!c;this.size=parseInt(d)||0;this.lastModified=parseInt(e)||0;this.viewable=f!=undefined?!!f:false;this.permissions=g||new jscape.FileInfo.Permissions();}});jscape.FileInfo.isRoot=function(path){return""===path||"/"===path;};jscape.FileInfo.isParentDir=function(path){return".."===path;};jscape.FileInfo.fromJSON=function(data){return data?new jscape.FileInfo(data.path,data.name,data.directory,data.size,data.lastModified,data.viewable,jscape.FileInfo.Permissions.fromJSON(data.permissions)):null;};jscape.FileInfo.fromString=function(path,directory){return typeof path=="string"?new jscape.FileInfo(path,path.substring(path.lastIndexOf("/")+1),directory):null;};jscape.FileInfo.Permissions=Class.extend({initialize:function(a,b,c,d,e,f,g){this.fileUploading=a!=undefined?!!a:true;this.fileDeletion=b!=undefined?!!b:true;this.fileRenaming=c!=undefined?!!c:true;this.fileDownloading=d!=undefined?!!d:true;this.fileSharing=e!=undefined?!!e:true;this.directoryMaking=f!=undefined?!!f:true;this.directoryDeletion=g!=undefined?!!g:true;}});jscape.FileInfo.Permissions.fromJSON=function(data){return data?new jscape.FileInfo.Permissions(data.fileUploading,data.fileDeletion,data.fileRenaming,data.fileDownloading,data.fileSharing,data.directoryMaking,data.directoryDeletion):new jscape.FileInfo.Permissions();};jscape.FileShareInfo=Class.extend({initialize:function(a,b,c,d,e,f,g,h){this.id=a||"";this.sender=b||"";this.subject=c||"";this.date=parseInt(d)||0;this.files=parseInt(e)||0;this.downloads=parseInt(f)||0;this.status=jscape.FileShareInfo.Status.valueOf(g);}});jscape.FileShareInfo.fromJSON=function(data){return data?new jscape.FileShareInfo(data.id,data.sender,data.subject,data.date,data.files,data.downloads,data.status):null;};jscape.FileShareInfo.Status={ACTIVE:"ACTIVE",REVOKED:"REVOKED",EXPIRED:"EXPIRED",values:function(){return[this.ACTIVE,this.REVOKED,this.EXPIRED];},valueOf:function(value){return $.inArray(value,this.values())!=-1?value:this.ACTIVE;}};jscape.TagCloudInfo=Class.extend({initialize:function(a,b){this.entries=a||[];this.total=parseInt(b)||0;}});jscape.TagCloudInfo.fromJSON=function(data){var total=0;var entries=$.map(data||[],jscape.TagCloudInfo.Entry.fromJSON);$.each(entries,function(_,entry){total+=entry.relevance;});return new jscape.TagCloudInfo(entries,total);};jscape.TagCloudInfo.Entry=Class.extend({initialize:function(a,b){this.tag=a||"";this.relevance=parseInt(b)||0;}});jscape.TagCloudInfo.Entry.fromJSON=function(data){return data?new jscape.TagCloudInfo.Entry(data.tag,data.relevance):null;};jscape.AdHocTransferData=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){this.paths=a||[];this.type=b||null;this.sender=c||"";this.allowedSenders=d||[];this.replyTo=e||"";this.recipients=this._parseEmailAddresses(f);this.ccRecipients=this._parseEmailAddresses(g);this.bccRecipients=this._parseEmailAddresses(h);this.subject=i||"";this.message=j||"";this.protection=k||null;this.password=l||null;this.expireAfterDays=parseInt(m)||-1;this.maxDownloads=parseInt(n)||-1;this.deleteAfterMaxDownloads=!!o;this.deleteAfterDays=parseInt(p)||null;},toJSON:function(){var obj=$.extend({},this);delete obj.allowedSenders;return obj;},_parseEmailAddresses:function(value){return $.isArray(value)?value:typeof value==="string"?value.split(", "):[];}});jscape.AdHocTransferData.fromJSON=function(data){return data?new jscape.AdHocTransferData(data.paths,data.type,data.sender,data.allowedSenders,data.replyTo,data.recipients,data.ccRecipients,data.bccRecipients,data.subject,data.message,data.protection,undefined,data.expireAfterDays,data.maxDownloads,data.deleteAfterMaxDownloads,data.deleteAfterDays):new jscape.AdHocTransferData();};jscape.AdHocTransferData.external=function(paths,sender,replyTo,recipient,cc,bcc,subject,message,protection,password,expires,maxDownloads,deleteAfterMaxDownloads,deleteAfterDays){return new jscape.AdHocTransferData(paths,"EXTERNAL",sender,undefined,replyTo,recipient,cc,bcc,subject,message,protection,password,expires,maxDownloads,deleteAfterMaxDownloads,deleteAfterDays);};jscape.AdHocTransferData.internal=function(paths,sender,replyTo,recipient,cc,bcc,subject,message,expires,maxDownloads,deleteAfterMaxDownloads,deleteAfterDays){return new jscape.AdHocTransferData(paths,"INTERNAL",sender,undefined,replyTo,recipient,cc,bcc,subject,message,undefined,undefined,expires,maxDownloads,deleteAfterMaxDownloads,deleteAfterDays);};jscape.AdHocTransferData.anonymous=function(paths,subject,expires,maxDownloads,deleteAfterMaxDownloads,deleteAfterDays){return new jscape.AdHocTransferData(paths,"ANONYMOUS",undefined,undefined,"anonymous",undefined,undefined,undefined,subject,undefined,undefined,undefined,expires,maxDownloads,deleteAfterMaxDownloads,deleteAfterDays);};jscape.SearchQueryData=Class.extend({initialize:function(a,b,c,d,e,f,g){this.query=a||"";this.file=b||"";this.tag=c||"";this.size=$.isNumeric(d)?d:null;this.sizePredicate=e||jscape.SearchQueryData.Predicate.EQUALS;this.modified=$.type(f)==="date"?f.getTime():null;this.modifiedPredicate=g||jscape.SearchQueryData.Predicate.EQUALS;},toJSON:function(){var data={query:this.query,tag:this.tag||undefined,file:this.file||undefined};if($.isNumeric(this.size)){data.size=this.size;data.sizePredicate=this.sizePredicate;}
if(this.modified!=null){data.modified=this.modified;data.modifiedPredicate=this.modifiedPredicate;}
return data;}});jscape.SearchQueryData.Predicate={LESS:"LESS",GREATER:"GREATER",EQUALS:"EQUALS",parse:function(str){switch(str){case'<':return this.LESS;case'>':return this.GREATER;default:return this.EQUALS;}},format:function(p){switch(p){case this.LESS:return"<";case this.GREATER:return">";default:return"";}}};jscape.SearchQueryTerm=Class.extend({});jscape.SearchQueryTerm.Name=jscape.SearchQueryTerm.extend({format:function(q){return q&&q.file?"file:"+(q.file.indexOf(" ")!=-1?"("+q.file+")":q.file):"";},parse:function(s,q){const re=/\bfile:([\w\-_+.*\?]+|(\(([\w\-_+.*\?\s]+)\)))\s?/;var matches=re.exec(s);if(matches!=null){q.file=matches[3]?matches[3]:matches[1];s=s.replace(matches[0],"");}
return s;}});jscape.SearchQueryTerm.Content=jscape.SearchQueryTerm.extend({format:function(q){return q&&q.query?q.query:"";},parse:function(s,q){const re=/(\b\w+:\([^)]+?\))|(\b\w+:([<>=]?)[\w\/\-_+.*\?]+\b)/gid;var val=""+s;var terms=[];var matches;while((matches=re.exec(s))!==null){if(matches.indices&&matches.indices.length){var term=matches.input.slice(matches.indices[0][0],matches.indices[0][1]);if(!!term){terms.push(term);val=val.replace(term,"");}}}
q.query=val.trim();return terms.join(" ");}});jscape.SearchQueryTerm.Tag=jscape.SearchQueryTerm.extend({format:function(q){return q&&q.tag?"tag:"+(q.tag.indexOf(" ")!=-1?"("+q.tag+")":q.tag):"";},parse:function(s,q){const re=/(\btag:\(([^)]+?)\))|(\btag:(\w+?)\b)/;var matches=re.exec(s);if(matches!=null){q.tag=matches[4]?matches[4]:matches[2];s=s.replace(matches[0],"");}
return s;}});jscape.SearchQueryTerm.Size=jscape.SearchQueryTerm.extend({format:function(q){return q&&$.isNumeric(q.size)?"size:"+jscape.SearchQueryData.Predicate.format(q.sizePredicate)+q.size:"";},parse:function(s,q){const re=/\bsize:([<>=]?)(\d+?)\b/;var matches=re.exec(s);if(matches!=null){q.size=parseInt(matches[2]);q.sizePredicate=jscape.SearchQueryData.Predicate.parse(matches[1]);s=s.replace(matches[0],"");}
return s;}});jscape.SearchQueryTerm.LastModified=jscape.SearchQueryTerm.extend({initialize:function(options){this.options=options;},format:function(q){return q&&q.modified?"modified:"+jscape.SearchQueryData.Predicate.format(q.modifiedPredicate)+this._formatDate(q.modified):"";},parse:function(s,q){const re=/\bmodified:([<>=]?)([\w\/\-\.*]+)\s?/;var matches=re.exec(s);if(matches!=null){var date=this._parseDate(matches[2]);q.modified=date!=null?date.getTime():null;q.modifiedPredicate=jscape.SearchQueryData.Predicate.parse(matches[1]);s=s.replace(matches[0],"");}
return s;},_formatDate:function(val){return this.options&&typeof this.options.formatter=="function"?this.options.formatter(val):"";},_parseDate:function(val){return this.options&&typeof this.options.parser=="function"?this.options.parser(val):null;}});jscape.SearchQueryTerms=Class.extend({initialize:function(dateOptions){this.terms=[new jscape.SearchQueryTerm.Name(),new jscape.SearchQueryTerm.Content(),new jscape.SearchQueryTerm.Tag(),new jscape.SearchQueryTerm.Size(),new jscape.SearchQueryTerm.LastModified(dateOptions)];},format:function(query){var tokens=[];for(var i=0;i<this.terms.length;i++){var entry=this.terms[i].format(query);if(!!entry){tokens.push(entry);}}
return tokens.join(" ");},parse:function(str){var query=new jscape.SearchQueryData();if(str&&str.trim().length){for(var i=0;i<this.terms.length;i++){str=this.terms[i].parse(str,query);}
query.query+=str.trim();}
return query;}});jscape.storage.FileTransferModule=jscape.ApplicationModule.extend({currentDir:null,navigateToPath:null,searching:false,initialize:function(currentDir,navigateToPathRequired,fileUploadMetadataRequired,searchOptions,addContactAllowed,viewAllowed,viewerOptions){if(!navigateToPathRequired){this.currentDir=jscape.FileInfo.fromString(currentDir,true);this.navigateToPath=null;}else{this.currentDir=null;this.navigateToPath=currentDir;}
this.config={uploadFormRequired:!!fileUploadMetadataRequired,searchAllowed:searchOptions&&!!searchOptions.allowed,viewFileAllowed:!!viewAllowed,viewerOptions:viewerOptions||{},addContactAllowed:!!addContactAllowed};this.defaultSearchCategory={value:searchOptions&&searchOptions.category,apply:function(query){if(query&&!query.file&&/(file|name)/i.test(this.value)){query.file=query.query;query.query="";}
return query;}};},onCreate:function(){this._super.apply(this,arguments);this.breadcrumbsView=new jscape.storage.BreadcrumbsView();this.listView=new jscape.storage.FileListView();if(!!this.config.searchAllowed){this.searchView=new jscape.storage.FileSearchView();this.tagCloudView=new jscape.storage.TagCloudView(this.listView.container());}
this.uploadController=new jscape.storage.UploadFileController(new jscape.storage.UploadProgressDialog(),this.config.uploadFormRequired);this.viewController=new jscape.storage.ViewFileController(this.config.viewerOptions,this.config.viewFileAllowed);this.changeDirController=new jscape.storage.ChangeDirController();this.makeDirController=new jscape.storage.MakeDirController();this.deleteController=new jscape.storage.DeletePathController();this.adHocTransferController=new jscape.storage.AdHocTransferController(this.config.addContactAllowed);this.manageTagsController=new jscape.storage.TagFileController();},onStart:function(){this.breadcrumbsView.show(this);this.listView.show(this);if(this.config.searchAllowed){this.searchView&&this.searchView.show(this);this.tagCloudView&&this.tagCloudView.show(this);}
if(this.navigateToPath){var path=this.navigateToPath;this.navigateToPath=null;this.onChangeDir(path).fail($.proxy(function(){this.onChangeDir("/");},this));}else if(this.currentDir){this.listView.refresh();jscape.API.pathInfo(this.currentDir.path).done($.proxy(function(info){this.currentDir=info;this.listView.setPermissions(info.permissions);},this));}},onResume:function(){if(!!this.currentDir){this._refreshFileList();}},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listFiles(params.startIndex,params.count,params.query).done(function(){$(document).triggerHandler("_activity.user");}).done($.proxy(function(){if(this.searching){this.breadcrumbsView.hide();this.listView.showSearchResultsToolbar();}else{this.listView.hideSearchResultsToolbar();this.breadcrumbsView.show(this);if(this.currentDir){this.breadcrumbsView.setCurrentDir(this.currentDir.path);}}
this._refreshTagCloud();},this));},onUploadFile:function(mode,files,dataTransfer){var filenames=$.map(this.listView.getFileInfos(),function(info){return!info.directory?info.name:null;});return this.uploadController.start(mode,files,filenames,dataTransfer).done($.proxy(function(){this._fireMessage(window.R.string.STORAGE_SUCCESS_UPLOAD);this._refreshFileList();},this)).fail($.proxy(function(error){if(error&&error.force){$.messager.alert(window.R.string.APPLICATION_TITLE,error.message||window.R.string.STORAGE_ERROR_UPLOAD,"error");}
this._refreshFileList();},this));},onViewFile:function(file){return this.viewController.start(file.path);},onRenameFile:function(file,filename){return jscape.API.renameFile(file.path,filename).done($.proxy(function(target){this._fireMessage((file.directory?window.R.string.STORAGE_SUCCESS_RENAME_DIR:window.R.string.STORAGE_SUCCESS_RENAME_FILE).supplant({0:file.path,1:target.path}));},this)).always($.proxy(this._refreshFileList,this));},onMoveFile:function(files,target){var paths=$.map(files,function(file){return file.path;});return jscape.API.moveFile(paths,target.path).done($.proxy(function(){var message=paths.length==1?window.R.string.STORAGE_SUCCESS_MOVE.supplant({0:paths[0],1:target.path}):window.R.string.STORAGE_SUCCESS_MOVE_BATCH.supplant({0:target.path});this._fireMessage(message);},this)).always($.proxy(this._refreshFileList,this));},onChangeDir:function(file){this.listView.showLoadingMessage();return this.changeDirController.start(file).done($.proxy(function(info){this.currentDir=info;if(this.config.searchAllowed){this.searchView.setQueryString("");this.searching=false;}
this.listView.setPermissions(info.permissions);this.listView.load({});},this)).fail($.proxy(function(){this.listView.hideLoadingMessage();},this));},onMakeDir:function(){return this.makeDirController.start().done($.proxy(this._refreshFileList,this)).done($.proxy(function(path){this._fireMessage(window.R.string.STORAGE_SUCCESS_MAKE_DIR.supplant({0:path}));},this));},onDeleteFile:function(files){return this.deleteController.start(files).done($.proxy(this._refreshFileList,this)).done($.proxy(function(){var message=files.length==1?(files[0].directory?window.R.string.STORAGE_SUCCESS_DELETE_DIR:window.R.string.STORAGE_SUCCESS_DELETE_FILE).supplant({0:files[0].path}):window.R.string.STORAGE_SUCCESS_DELETE_BATCH;this._fireMessage(message);},this));},onDownload:function(file){return jscape.API.downloadFile(file.path);},onZipDownload:function(files,selectAll){return jscape.API.zipDownload($.map(files,function(file){return file.path;}),selectAll);},onShareFile:function(files,type){return this.adHocTransferController.start(files,type);},onManageTags:function(files){$(document).triggerHandler("_activity.user");return this.manageTagsController.start(files).done($.proxy(this._fireMessage,this,window.R.string.STORAGE_SUCCESS_TAG_FILE)).done($.proxy(function(){if(this.searching){this.listView.refresh();}else{this._refreshTagCloud();}},this));},onRefreshCloud:function(){return jscape.API.tagCloud().done($.proxy(function(data){this.tagCloudView.loadData(data);},this));},onTaggedFile:function(tag){if(this.config.searchAllowed){this.searching=true;var query=new jscape.SearchQueryData(null,null,tag);var queryString=new jscape.SearchQueryTerms(this.searchView.getDateFormat()).format(query);this.searchView.setQueryString(queryString);this.listView.load(query.toJSON());}},onParseSearchQuery:function(text){var query=new jscape.SearchQueryTerms(this.searchView.getDateFormat()).parse(text);return this.defaultSearchCategory.apply(query);},onSearch:function(text){if(!this.config.searchAllowed){return;}
var query=new jscape.SearchQueryTerms(this.searchView.getDateFormat()).parse(text);query=this.defaultSearchCategory.apply(query);this.searching=true;this.listView.load(query.toJSON());},onSearchAdvanced:function(terms){if(!this.config.searchAllowed){return;}
var query=new jscape.SearchQueryData(terms.text,terms.name,terms.tag,terms.size,terms.sizePredicate,terms.date,terms.datePredicate);var queryString=new jscape.SearchQueryTerms(this.searchView.getDateFormat()).format(query);this.listView.load(query.toJSON());this.searchView.setQueryString(queryString);},onSearchClear:function(){this.searching=false;this.searchView.setQueryString("");this.listView.load({});},_refreshFileList:function(){if(this.searching){setTimeout($.proxy(function(){this.listView.refresh();},this),500);}else{this.listView.refresh();}},_refreshTagCloud:function(){if(this.tagCloudView){setTimeout($.proxy(function(){this.tagCloudView.refresh();},this),600);}},_fireMessage:function(message){if(message){$(document).triggerHandler("broadcast",[message]);}}});jscape.storage.FileListView=jscape.ui.DatagridView.extend({SIZE_FACTOR:1024,DEFAULT_PERMISSIONS:new jscape.FileInfo.Permissions(),sizeFormat:null,selection:null,editIndex:-1,initialize:function(){var initializing=true;this.sizeFormat=new jscape.SizeFormat();this.layout=$("#user-storage-pane").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=filelistinggrid]",this.layout);this.data.datagrid({fit:true,fitColumns:true,singleSelect:false,ctrlSelect:true,remoteSort:true,showFooter:true,autoRowHeight:false,pageSize:100,view:$.fn.datagrid.defaults.bufferview,columns:[[{field:"_ck",checkbox:true,width:32,fixed:true},{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"40%",editor:"text",formatter:$.proxy(function(_,rowData){return this._formatName(rowData);},this),styler:$.proxy(this._styleName,this)},{field:"path",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:300,fixed:true},{field:"size",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:150,fixed:true,formatter:$.proxy(function(_,rowData){return this._formatSize(rowData);},this)},{field:"lastModified",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:280,fixed:true,formatter:$.proxy(function(_,rowData){return this._formatDate(rowData);},this)}]],rowEvents:$.extend({},$.fn.datagrid.defaults.rowEvents,{mouseover:function(e){var tr=$(e.target).closest("tr.datagrid-row");if(tr.length&&tr.parent().length){var table=tr.closest("div.datagrid-view").children(".datagrid-f");if(table&&table.length){var data=$.data(table[0],"datagrid");if(data.highlighting||data.resizing){return;}
data.highlighting=true;tr.addClass("datagrid-row-over");}}},mouseout:function(e){var tr=$(e.target).closest("tr.datagrid-row");if(!e.relatedTarget||(tr.length&&!$.contains(tr[0],e.relatedTarget))){var table=tr.closest("div.datagrid-view").children(".datagrid-f");if(table&&table.length){var data=$.data(table[0],"datagrid");data.highlighting=false;if(data.resizing){return;}
tr.removeClass("datagrid-row-over");}}}}),onSelect:$.proxy(this._adjustRowSelection,this),onSelectAll:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onResize:$.proxy(this._onResize$FileList,this),onDragEnter:$.proxy(this._onMove$CheckFile,this),onDragOver:$.proxy(this._onMove$CheckFile,this),onBeforeDrag:$.proxy(this._onBeforeDrag$File,this),onBeforeDrop:$.proxy(this._onBeforeMove$File,this),onDrop:$.proxy(this._onMove$File,this),onCheck:$.proxy(this._onRow$Check,this),onClickRow:$.proxy(this._onClick$Row,this),onDblClickRow:$.proxy(this._onDblClick$Row,this),onAfterEdit:$.proxy(this._onEdit$After,this),onBeforeLoad:$.proxy(function(){return!initializing&&!this.loading;},this),loader:$.proxy(this._onLoad$Data,this),onLoadSuccess:$.proxy(this._onLoad$Success,this)});this.data.datagrid("getPanel").addClass("filelist");var toolbar=$("#filetoolbar");this.uploadMode=$("#uploadmodemenu");this.uploadButton=this.uploadMode.length?$("a[role=button][name=upload]",toolbar).splitbutton({plain:false,menu:"#uploadmodemenu",onClick:$.proxy(this._onClick$UploadButton,this)}):$("a[role=button][name=upload]",toolbar).linkbutton({onClick:$.proxy(this._onClick$UploadButton,this)});this.viewButton=$("a[role=button][name=view]",toolbar).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.renameButton=$("a[role=button][name=rename]",toolbar).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RenameButton,this)});this.refreshButton=$("a[role=button][name=refresh]",toolbar).linkbutton({onClick:$.proxy(this._onClick$RefreshButton,this)});this.changeDirButton=$("a[role=button][name=cwd]",toolbar).linkbutton({onClick:$.proxy(this._onClick$ChangeDirButton,this)});this.makeDirButton=$("a[role=button][name=mkdir]",toolbar).linkbutton({onClick:$.proxy(this._onClick$MakeDirButton,this)});this.downloadButtonOptions={text:window.R.string.STORAGE_BUTTON_DOWNLOAD||"Download",disabled:true,handler:$.proxy(this._onClick$DownloadButton,this)};this.zipDownloadButton=$("a[role=button][name=zipdload]",toolbar).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ZipDownloadButton,this)});this.deleteButton=$("a[role=button][name=delete]",toolbar).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});this.shareFileButton=$("a[role=button][name=sharefile]",toolbar);if(this.shareFileButton.length){this.shareFileButton.menubutton({disabled:true,plain:false,menu:"#sharefilemenu",showEvent:"mouseenter click"});$(this.shareFileButton.menubutton("options").menu).menu({onClick:$.proxy(this._onClick$ShareFileMenu,this)});}
this.tagsButton=$("a[role=button][name=tags]",toolbar).linkbutton({disabled:true,onClick:$.proxy(this._onClick$TagsButton,this)});this.searchResultsToolbar=$("#searchresultsbar").hide();this.clearSearchButton=$("a[role=button][name=clearsearch]",this.searchResultsToolbar).linkbutton({plain:true,iconCls:'icon-clear',onClick:$.proxy(this._onClick$ClearSearchButton,this)});$(document).off(".storage").on("keydown.storage",{113:this.renameButton,116:this.refreshButton,118:this.makeDirButton,119:this.deleteButton},$.proxy(this._onKeyDown,this));initializing=false;},show:function(listener){this.listener=listener||jscape.storage.FileListView.LISTENER;this.editIndex=-1;this.layout.layout("resize");this._adjustRowSelection();this._initUploadDropzone();return this;},container:function(){return this.layout;},refresh:function(){this.data.datagrid("reload");},load:function(query){this.data.datagrid("load",query);},setPermissions:function(value){this.permissions=value;this._adjustRowSelection();},showLoadingMessage:function(){this.data.datagrid("loading");},hideLoadingMessage:function(){this.data.datagrid("loaded");},showSearchResultsToolbar:function(){this.searchResultsToolbar.show();this.clearSearchButton.linkbutton("enable");this.data.datagrid("hideColumn","path");},hideSearchResultsToolbar:function(){this.searchResultsToolbar.hide();this.clearSearchButton.linkbutton("disable");this.data.datagrid("showColumn","path");},getFileInfos:function(){return this.getRecords();},_uploadMode:function(){return this.uploadMode.length?this.uploadMode.find(":checked").val():null;},_showContextMenu:function(e,_,index,row){if(this.shareFileButton.length){var opts=this.shareFileButton.menubutton("options");var menu=$(opts.menu);return this._super(e,[$.extend({},this.downloadButtonOptions,{disabled:index<0?true:undefined,handler:$.proxy(this._onDblClick$Row,this,index,row)}),this.zipDownloadButton,{text:opts.text,disabled:!!opts.disabled,submenu:$.map(menu.find("[role=menuitem]"),$.proxy(function(el){var item=menu.menu("getItem",el);return{text:item.text,disabled:!!opts.disabled,handler:$.proxy(this._onClick$ShareFileMenu,this,{name:item.name})};},this))},this.tagsButton,this.viewButton,"-",this.makeDirButton,"-",this.renameButton,this.deleteButton]);}else{return this._super(e,[$.extend({},this.downloadButtonOptions,{disabled:index<0?true:undefined,handler:$.proxy(this._onDblClick$Row,this,index,row)}),this.zipDownloadButton,this.tagsButton,this.viewButton,"-",this.makeDirButton,"-",this.renameButton,this.deleteButton]);}},_initUploadDropzone:function(){var panel=this.data.datagrid("getPanel");if(panel.find(".grid-dropzone").length!=0){return;}
panel.find(".datagrid-view").append($("<div></div>").addClass("grid-dropzone").text(window.R.string.STORAGE_MESSAGE_DROPZONE));$(window).on("dragenter dragover",$.proxy(function(e){if(!this._transferAllowed(e)){return;}
e.stopPropagation();e.preventDefault();this._showDropzoneOverlay();this._updateDropzoneOverlayEffect(e);},this)).on("dragleave",$.proxy(function(e){e.stopPropagation();e.preventDefault();if(e.originalEvent.clientX<=0||e.originalEvent.clientY<=0){this._hideDropzoneOverlay();}},this)).on("drop",$.proxy(function(e){if(!this._transferAllowed(e)){return;}
e.preventDefault();e.stopPropagation();this._hideDropzoneOverlay();if($(e.target).hasClass("grid-dropzone")){this._onDrop$File(e);}},this));this._onResize$FileList();},_showDropzoneOverlay:function(){this.data.datagrid("getPanel").find(".grid-dropzone").addClass("hover");},_hideDropzoneOverlay:function(){this.data.datagrid("getPanel").find(".grid-dropzone").removeClass("hover");},_updateDropzoneOverlayEffect:function(e){var dt=e.originalEvent.dataTransfer;if($(e.target).hasClass("grid-dropzone")){dt.effectAllowed="copyMove";dt.dropEffect="move";}else{dt.effectAllowed="none";dt.dropEffect="none";}},_transferAllowed:function(e){return e&&e.originalEvent.dataTransfer&&$.inArray("Files",e.originalEvent.dataTransfer.types)!=-1;},_onResize$FileList:function(){var panel=this.data.datagrid("getPanel");var dz=panel.find(".grid-dropzone");if(dz&&dz.length){dz.css("line-height",panel.css("height")).width(panel.width()-(dz.outerWidth()-dz.innerWidth())).height(panel.height()-(dz.outerWidth()-dz.innerWidth()));}},_formatName:function(info){var name=String(info.name||"").escapeXml();return jscape.FileInfo.isParentDir(info.path)?window.R.string.STORAGE_PARENT_DIR_TEMPLATE.supplant({0:name}):name;},_formatDate:function(info){return info.lastModified?window.moment(info.lastModified).format("ll LTS"):"";},_formatSize:function(info){return info.type=="footer"?"":info.directory?window.R.string.STORAGE_TYPE_DIRECTORY:this.sizeFormat.format(info.size);},_formatFooter:function(data){var rows=data.rows.length?data.rows:data.firstRows||[];var count=parseInt(data.total)||rows.length;for(var i=0,len=rows.length;i<len;++i){if(jscape.FileInfo.isParentDir(rows[i].path)){--count;}}
return window.R.string.STORAGE_LISTING_RESULTS.supplant({0:count});},_styleName:function(name,info){return info.type=="footer"?{style:"font-weight: bold"}:jscape.FileInfo.isParentDir(info.path)?{"class":"cdup"}:{"class":info.directory?"folder":"file"};},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");var hasParentDir=$.grep(this.selection,function(info){return jscape.FileInfo.isParentDir(info.path);}).length!=0;var singleOperation=!hasParentDir&&this.selection.length==1;var batchOperation=!hasParentDir&&this.selection.length!=0;var permissions=this.permissions||this.DEFAULT_PERMISSIONS;this.viewButton.linkbutton(singleOperation&&this.selection[0].viewable?"enable":"disable");this.uploadButton.linkbutton(!!permissions.fileUploading?"enable":"disable");this.renameButton.linkbutton(!!permissions.fileRenaming&&singleOperation?"enable":"disable");this.makeDirButton.linkbutton(!!permissions.directoryMaking?"enable":"disable");this.downloadButtonOptions.disabled=!permissions.fileDownloading||!singleOperation||this.selection[0].directory;this.zipDownloadButton.linkbutton(!!permissions.fileDownloading&&batchOperation&&!this.zipDownloadButton.linkbutton("options")._loading?"enable":"disable");this.shareFileButton.menubutton(!!permissions.fileSharing&&batchOperation?"enable":"disable");this.tagsButton.linkbutton(batchOperation?"enable":"disable");var deleteAllowed=batchOperation;for(var i=0;i<this.selection.length;++i){var directory=this.selection[i].directory;if((directory&&!permissions.directoryDeletion)||(!directory&&!permissions.fileDeletion)){deleteAllowed=false;break;}}
this.deleteButton.linkbutton(deleteAllowed?"enable":"disable");},_isSelectAll:function(){return this.data.datagrid("getPanel").find(".datagrid-header-check input[type=checkbox]").is(":checked");},_onLoad$Data:function(params,success,error){params.page=params.page||1;params.rows=params.rows||this.data.datagrid("options").pageSize;this.loading=true;return this.listener.onRefresh(params).then(jscape.Page.datagridFormatter()).then($.proxy(function(data){this.loading=false;return data;},this)).then(success,error).always($.proxy(function(){this.loading=false;},this));},_onLoad$Success:function(data){this.data.datagrid("loaded").datagrid("reloadFooter",[{name:this._formatFooter(data),type:"footer"}]).datagrid("mergeCells",{type:"footer",index:0,field:"name",colspan:4}).datagrid("enableDnd");if(this._isSelectAll()){this.data.datagrid("selectAll");}else{this._adjustRowSelection();}},_onClick$Row:function(index,row){if(this.editIndex==index){this.data.datagrid("endEdit",index);}},_onDblClick$Row:function(index,row){if(row.directory){this.listener.onChangeDir(row);}else{this.listener.onDownload(row);}},_onClick$UploadButton:function(){this.listener.onUploadFile(this._uploadMode());},_onMove$CheckFile:function(target,source){return target&&!!target.directory;},_onBeforeDrag$File:function(rows){var index=this.editIndex;if(index>=0&&rows.length){for(var i=0;i<rows.length;i++){if(this.data.datagrid("getRowIndex",rows[i])==index){return false;}}
this.editIndex=-1;this.data.datagrid("cancelEdit",index);}
return true;},_onBeforeMove$File:function(target,source){return!!source&&!!target&&target.path!=source.path;},_onMove$File:function(target,source){this.listener.onMoveFile(source,target);},_onDrop$File:function(e){var dt=e.originalEvent.dataTransfer;if(dt&&dt.files&&dt.files.length){this.listener.onUploadFile(this._uploadMode(),dt.files,dt);}},_onClick$ViewButton:function(){this.viewButton.linkbutton("disable");this.listener.onViewFile(this.selection[0]).always($.proxy(function(){this.viewButton.linkbutton("enable");},this));},_onRow$ContextMenu:function(e,index,row){this._super(e,index,row);},_onRow$Check:function(index){if(this.editIndex!=index){this.data.datagrid("cancelEdit",this.editIndex);this.editIndex=-1;}},_onClick$RenameButton:function(){var index=this.editIndex;if(index!=-1){this.editIndex=-1;this.data.datagrid("cancelEdit",index);}
index=this.data.datagrid("getRowIndex",this.selection[0]);if(index!=-1){this.data.datagrid("beginEdit",index);var editor=this.data.datagrid("getEditor",{index:index,field:"name"});if(editor){this.editIndex=index;var input=$(editor.target);var grid=this.data;setTimeout(function(){input.unbind(".rename").bind("keydown.rename",function(e){if(e.keyCode==13){if($(this).val()){grid.datagrid("endEdit",index);}else{grid.datagrid("cancelEdit",index);}
return false;}else if(e.keyCode==27){grid.datagrid("cancelEdit",index);return false;}});},0);input.focus();}}},_onEdit$After:function(index,row,changes){if(changes&&changes.name){this.listener.onRenameFile(row,changes.name);}},_onClick$RefreshButton:function(){this.refresh();},_onClick$ChangeDirButton:function(){this.listener.onChangeDir();},_onClick$MakeDirButton:function(){this.listener.onMakeDir();},_onClick$DownloadButton:function(){if(this.selection.length){this.listener.onDownload(this.selection[0]);}},_onClick$ZipDownloadButton:function(){this.zipDownloadButton.linkbutton({disabled:true,_loading:true});this.listener.onZipDownload(this.selection,this._isSelectAll()).always($.proxy(function(){this.zipDownloadButton.linkbutton({disabled:false,_loading:false});},this));},_onClick$DeleteButton:function(){this.listener.onDeleteFile(this.selection);},_onClick$ShareFileMenu:function(item){var type=item?item.name:"";if(!!type){this.shareFileButton.menubutton("disable");this.listener.onShareFile(this.selection,type).always($.proxy(function(){this.shareFileButton.menubutton("enable");},this));}},_onClick$TagsButton:function(){this.listener.onManageTags(this.selection);},_onClick$ClearSearchButton:function(){this.listener.onSearchClear(this);},_onKeyDown:function(e){var button=typeof e.data=="object"&&e.data.hasOwnProperty(e.which)?e.data[e.which]:null;if(button&&button.length&&!button.linkbutton("options").disabled){e.preventDefault();button.click();return false;}}});jscape.storage.FileListView.LISTENER={onRefresh:$.noop,onViewFile:$.noop,onRenameFile:$.noop,onMoveFile:$.noop,onChangeDir:$.noop,onMakeDir:$.noop,onUploadFile:$.noop,onDownload:$.noop,onZipDownload:$.noop,onDeleteFile:$.noop,onShareFileByEmail:$.noop,onShareFileInternal:$.noop,onShareFileLink:$.noop,onShareFile:$.noop,onManageTags:$.noop,onSearchClear:$.noop};jscape.storage.FileSearchView=Class.extend({initialize:function(){this.fieldset=$("#filetoolbar");this.query=$("input[name=query]",this.fieldset).combo({editable:true,hasDownArrow:true,selectOnNavigation:false,delay:5*60*1000,icons:[{iconCls:"icon-clear",handler:$.proxy(this._onClick$ClearButton,this)}],keyHandler:$.extend({},$.fn.combo.defaults.keyHandler,{enter:$.proxy(this._onClick$SearchButton,this),esc:function(){},down:function(){$(this).combobox("showPanel");}}),panelEvents:$.extend({},$.fn.combo.defaults.panelEvents,{mousedown:function(){}}),onShowPanel:$.proxy(this._onShow$Panel,this),onHidePanel:$.proxy(this._onHide$Panel,this),width:"60%",height:28,panelWidth:"auto",panelHeight:"auto"});this.query.combo("textbox").bind("keyup change",$.proxy(this._adjustClearButtonState,this));this.searchButton=$("a[role=button][name=search]",this.fieldset).linkbutton({onClick:$.proxy(this._onClick$SearchButton,this)});this.advancedButton=$("button[name=advancedsearch]",this.advancedPanel).linkbutton({onClick:$.proxy(this._onClick$SearchButton,this)});this.advancedPanel=$("#advancedsearch").appendTo(this.query.combo("panel")).show();$("form",this.advancedPanel).form({ajax:true,onSubmit:$.proxy(function(){return false;},this),novalidate:true});this.query.combo("getIcon",1).tooltip({content:this.advancedPanel.attr("title"),showDelay:0}).click(function(){$(this).tooltip("hide");});this.advancedPanel.removeAttr("title");this.content=$("input[name=filecontent]",this.advancedPanel).textbox({width:"100%",height:58,labelPosition:"top",doSize:false});this.filename=$("input[name=filename]",this.advancedPanel).textbox({width:"100%",height:58,labelPosition:"top",doSize:false});this.tag=$("input[name=filetag]",this.advancedPanel).textbox({width:"100%",height:58,labelPosition:"top",doSize:false});this.size=$("input[name=filesize]",this.advancedPanel).numberspinner({min:0,width:175,max:Math.pow(2,31)-1});this.sizePredicate=$("select[name=filesizepredicate]",this.advancedPanel).combobox({required:true,editable:false,width:120,panelHeight:"auto"});this.sizeUnit=$("select[name=filesizeunit]",this.advancedPanel).combobox({required:true,editable:false,width:70,panelHeight:"auto"});this.date=$("input[name=filedate]",this.advancedPanel).datebox({width:175});this.datePredicate=$("select[name=filedatepredicate]",this.advancedPanel).combobox({required:true,editable:false,width:120,panelHeight:"auto"});},setQueryString:function(value){this.query.combo("setText",value).change();if(this.query.combobox("panel").is(":visible")){this._onShow$Panel();}},setQuery:function(query){if(!!query.query){this.content.textbox("setValue",query.query);}else{this.content.textbox("reset");}
if(!!query.file){this.filename.textbox("setValue",query.file);}else{this.filename.textbox("reset");}
if(!!query.tag){this.tag.textbox("setValue",query.tag);}else{this.tag.textbox("reset");}
if($.isNumeric(query.size)){var sizeUnit=this._sizeUnitFor(query.size);this.size.numberspinner("setValue",query.size/sizeUnit);this.sizePredicate.combobox("select",query.sizePredicate);this.sizeUnit.combobox("select",sizeUnit+"");}else{this.size.numberspinner("reset");this.sizeUnit.combobox("reset");}
if($.isNumeric(query.modified)){this.date.datebox("setDate",new Date(query.modified));this.datePredicate.combobox("select",query.modifiedPredicate);}else{this.date.datebox("reset");this.datePredicate.combobox("reset");}},getName:function(){return this.filename.textbox("getValue");},getContent:function(){return this.content.textbox("getValue");},getTag:function(){return this.tag.textbox("getValue");},getSize:function(){return parseInt(this.size.numberspinner("getValue"))*parseInt(this.sizeUnit.combobox("getValue"));},getSizePredicate:function(){return this.sizePredicate.combobox("getValue");},getDate:function(){return this.date.datebox("getDate");},getDatePredicate:function(){return this.datePredicate.combobox("getValue");},getDateFormat:function(){var t=this.date;return{formatter:function(value){return t.datebox("options").formatter.call(t,$.isNumeric(value)?new Date(value):value);},parser:function(value){return t.datebox("options").parser.call(t,value);}}},show:function(listener){this.listener=listener||jscape.storage.FileSearchView.LISTENER;this.query.combo("textbox").change();return this;},_onShow$Panel:function(){this.content.textbox("resize");this.filename.textbox("resize");this.tag.textbox("resize");var query=this.listener.onParseSearchQuery(this.query.combo("getText"));this.setQuery(query);setTimeout($.proxy(function(){this.advancedPanel.find("input:visible:first").focus().select();},this),0);},_onHide$Panel:function(){setTimeout($.proxy(function(){this.query.combobox("textbox").focus();},this),0);},_onClick$ClearButton:function(){this.query.combo("hidePanel");this.listener.onSearchClear(this);},_onClick$SearchButton:function(){if(this.query.combobox("panel").is(":visible")){var terms={text:this.getContent(),name:this.getName(),tag:this.getTag(),size:this.getSize(),sizePredicate:this.getSizePredicate(),date:this.getDate(),datePredicate:this.getDatePredicate()};this.query.combo("hidePanel");this.listener.onSearchAdvanced(terms);}else{this.listener.onSearch(this.query.combo("getText"));}},_sizeUnitFor:function(value){var opts=this.sizeUnit.combobox("options");var units=$.map(this.sizeUnit.combobox("getData"),function(entry){return parseInt(entry[opts.valueField]);}).sort();var unit=1;while(units.length){unit=units.pop();if(value%unit==0){break;}}
return unit;},_adjustClearButtonState:function(){var query=this.query.combo("textbox").val();this.query.combo("getIcon",0).css("visibility",query&&query.length?"visible":"hidden");}});jscape.storage.FileSearchView.LISTENER={onSearch:$.noop,onSearchAdvanced:$.noop,onSearchClear:$.noop,onParseSearchQuery:$.noop};jscape.storage.BreadcrumbsView=Class.extend({path:"",initialize:function(){this.panel=$("#breadcrumbs");},show:function(listener){this.listener=listener||jscape.storage.BreadcrumbsView.LISTENER;this.path=null;this.panel.show();},hide:function(){this.panel.hide();},setCurrentDir:function(path){if(this.path!=path){this.path=path;this._adjustBreadcrumbs();}},setMessage:function(text){this._clear();this.panel.text(text);},_onClick$Entry:function(path){this.listener.onChangeDir(path);},_clear:function(){this.panel.filter("a").each(function(_,el){el.unbind(".linkbutton")});this.panel.empty();this.path=null;},_adjustBreadcrumbs:function(){var currentDir=this.path;this._clear();var entries=jscape.FileInfo.isRoot(currentDir)?["/"]:currentDir.split("/");for(var i=0,size=entries.length;i<size;++i){var text=entries[i];if(jscape.FileInfo.isRoot(text)){this._addBreadCrumbEntry("/","/",true);}else{var successor=entries.slice(0,i+1).join("/");this._addBreadCrumbEntry(text,successor,currentDir==successor);if(i+1<size){$("<span>/</span>").appendTo(this.panel);}}}},_addBreadCrumbEntry:function(text,path,selected){return $("<a></a>").appendTo(this.panel).linkbutton({group:"breadcrumbs",text:(text+"").escapeXml(),plain:true,selected:selected,toggle:true,onClick:$.proxy(this._onClick$Entry,this,path)});}});jscape.storage.BreadcrumbsView.LISTENER={onChangeDir:$.noop};jscape.storage.TagCloudView=Class.extend({MIN_SIZE:12,SIZE_FACTOR:3,initialize:function(layout){this.layout=$(layout);this.panel=$("#tagcloud");this.cloud=$("<div class='tagcloud-tags'></div>").appendTo(this.panel);},show:function(listener){this.listener=listener||jscape.storage.TagCloudView.LISTENER;return this;},refresh:function(){this.listener.onRefreshCloud();},loadData:function(data){var c=this.layout.layout("panel","center");var s=this.layout.layout("panel","south");if(data.total==0){if(!s.panel("options").closed){var height=s.panel("panel")._outerHeight()+c.panel("panel")._outerHeight();s.panel("collapse").panel("close");c.panel("resize",{height:height});}}else if(data.total>0){this.cloud.empty();var quotedRe=/^"([^"]+)"$/;$.each(data.entries,$.proxy(function(_,entry){var title=window.R.string.STORAGE_TAG_CLOUD_ENTRY_TITLE.supplant({0:entry.relevance});var text=quotedRe.test(entry.tag)?entry.tag.replace(quotedRe,"$1"):entry.tag;var size=this.MIN_SIZE+(entry.relevance/data.total)*this.SIZE_FACTOR;$("<a/>").appendTo(this.cloud).attr("title",title).attr("alt",title).linkbutton({plain:true,text:text.escapeXml(),onClick:$.proxy(this._onClick$Tag,this,entry.tag)}).find(".l-btn-text").css("font-size",size+"px");},this));s.panel("expand").panel("open").panel("resize",{height:"auto"});c.panel("resize",{height:c.panel("panel")._outerHeight()-s.panel("panel")._outerHeight()});}
this.layout.layout("resize");},_onClick$Tag:function(tag){this.listener.onTaggedFile(tag);}});jscape.storage.TagCloudView.LISTENER={onRefreshCloud:$.noop,onTaggedFile:$.noop};jscape.storage.ViewFileController=Class.extend({deferred:null,initialize:function(options,allowed){this.options=$.extend({},options||{});this.allowed=!!allowed;},start:function(path){if(!this.allowed){return $.Deferred().reject().promise();}
this.deferred=$.Deferred();this.path=path;var dialog=this._setupDialog(path);this._bindEvents(dialog);dialog.show(this);return this.deferred.promise();},onClose:function(dialog){dialog&&dialog.destroy();this._unbindEvents();if(this.handle){var h=this.handle;this.handle=null;try{h.parentNode.removeChild(h);}catch(ignored){}}
this.deferred.resolve();},onLoadDocument:function(){this.loadError=false;var done=false;var deferred=$.Deferred();var promise=deferred.promise();var s=document.createElement("script");s.type="text/javascript";s.async=true;s.nonce=this.options.nonce||undefined;s.src=this.options.src+(this.options.src.indexOf("?")==-1?"?":"&")+$.param({file:this.path,_:new Date().getTime()});s.onload=s.onreadystatechange=function(){if(!done&&(!s.readyState||s.readyState=="loaded"||s.readyState=="complete")){done=true;s.onload=s.onreadystatechange=s.onerror=null;deferred.resolve(s);}};s.onerror=function(){s.onload=s.onreadystatechange=s.onerror=null;deferred.reject(s);};try{var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(s,a);}catch(e){deferred.reject(s);}
return promise.done($.proxy(function(s){this.handle=s;},this)).fail($.proxy(function(s){this.handle=s;},this));},onLoadError:function(dialog,message){if(!!this.loadError){return;}
this.loadError=true;dialog&&dialog.destroy();this.deferred.reject();$.messager.alert(window.R.string.APPLICATION_TITLE,message||window.R.string.STORAGE_ERROR_LOAD_VIEWER,"error");},_bindEvents:function(dialog){this._unbindEvents();var self=this;$(document).on("onDocumentViewerLoadError",function(e,error){self.onLoadError.call(self,dialog,(error&&error.message)||null);});},_unbindEvents:function(){$(document).off("onDocumentViewerLoadError");},_setupDialog:function(path){var dialog=new jscape.storage.ViewFileDialog();dialog.setPath(path);return dialog;}});jscape.storage.ViewFileDialog=Class.extend({initialize:function(){var initializing=true;this.dialog=$('<div></div>').appendTo("body");this.dialog.dialog({width:"50%",height:"20%",border:"thin",draggable:false,modal:true,resizable:false,closable:true,closed:true,onClose:$.proxy(function(){if(!this.closing){this._onClose();}},this),onBeforeLoad:function(){return!initializing;},onLoad:$.proxy(this._onLoad$Success,this),onLoadError:$.proxy(this._onLoad$Error,this),loader:$.proxy(this._onLoad$Document,this),href:"_",extractor:function(){return'<div id="documentViewer" class="flowpaper_viewer" style="height:100%!important;"></div>';}});initializing=false;},setPath:function(value){this.dialog.dialog("setTitle",(value+"").escapeXml()||document.title);},show:function(listener){this.listener=listener;this.dialog.show().dialog("open").dialog("center");},hide:function(){if(!this.dialog.dialog("options").closed){this.closing=true;this.dialog.dialog("close");this.closing=false;}},destroy:function(){this.dialog.dialog("destroy");this.dialog=null;this.listener=null;},_onLoad$Document:function(_,success,error){this.listener.onLoadDocument(this).done(success).fail(error);},_onLoad$Success:function(){var cb=window.jscape?jscape.docviewer:null;if(typeof cb==="function"){this.dialog.dialog("resize",{width:"100%",height:"100%"}).dialog("center");cb(this.dialog.find("#documentViewer"));}else{this.listener.onLoadError(this);}},_onLoad$Error:function(xhr,status,message){this.hide();this.listener.onLoadError(this,xhr?xhr.responseText:message||status);},_onClose:function(){this.hide();this.listener.onClose(this);}});jscape.storage.ChangeDirController=Class.extend({deferred:null,start:function(info){if(info instanceof jscape.FileInfo){return jscape.API.changeDir(info.path);}else if(typeof info=="string"){return jscape.API.changeDir(info);}
this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var path=dialog.getPath();dialog.destroy();jscape.API.changeDir(path).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.storage.ChangeDirDialog();}});jscape.storage.ChangeDirDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-storage-cwd"),{width:"40%",minWidth:500});this.fieldset=$("fieldset[name=cwdfields]",this.dialog);this.path=$("input[name=path]",this.fieldset).textbox({required:true,validType:"non_empty",width:390});},getPath:function(){return this.path.textbox("getValue");}});jscape.storage.MakeDirController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var name=dialog.getName();dialog.destroy();jscape.API.makeDir(name).done($.proxy(function(){this.deferred.resolve(name);this.deferred=null;name=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){return new jscape.storage.MakeDirDialog();}});jscape.storage.MakeDirDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-storage-mkdir"),{width:"40%",minWidth:500});this.fieldset=$("fieldset[name=mkdirfields]",this.dialog);this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:"non_empty",width:340});},getName:function(){return this.name.textbox("getValue");}});jscape.storage.DeletePathController=Class.extend({start:function(files){this.deferred=$.Deferred();var paths=$.map(files,function(file){return file.path;});return this._confirmDelete(paths).then(function(){return jscape.API.deleteFile(paths);});},_confirmDelete:function(files){return jscape.ConfirmDialog.confirm(window.R.string.STORAGE_CONFIRM_DELETE_TITLE,window.R.string.STORAGE_CONFIRM_DELETE_MESSAGE);}});jscape.storage.TagFileController=Class.extend({deferred:null,start:function(files){this.deferred=$.Deferred();this.paths=$.map(files,function(file){return file.path;});if(this.paths.length==1){jscape.API.tagsFor(this.paths[0]).done($.proxy(function(tags){this._setupDialog(this.paths[0],tags).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}else{this._setupBatchDialog(this.paths).show(this);}
return this.deferred.promise();},_setupDialog:function(path,tags){var dialog=new jscape.storage.TagFileDialog();dialog.setPath(path);dialog.setTags(tags);return dialog;},_setupBatchDialog:function(paths){var dialog=new jscape.storage.TagFileBatchDialog();dialog.setPaths(paths);return dialog;},onSubmit:function(dialog){var tags=dialog.getTags();dialog.destroy();return jscape.API.tagFile(this.paths,tags).done($.proxy(function(){this.deferred.resolve();this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;}});jscape.storage.TagFileDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-storage-tagfile"),{width:"40%",minWidth:530});this.fieldset=$("fieldset[name=tagfilefields]",this.dialog);this.file=$("input[name=file]",this.fieldset).textbox({editable:false,readonly:true,width:"70%"});this.tags=$("input[name=keywords]",this.fieldset).textbox({width:"70%"});},getTags:function(){return this.tags.textbox("getValue");},setTags:function(value){this.tags.textbox("setValue",value);},setPath:function(value){this.file.textbox("setValue",value);},show:function(listener){this._super(listener);this.tags.textbox("textbox").select().focus();}});jscape.storage.TagFileBatchDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-storage-tagfilebatch"),{width:"40%",minWidth:530});this.fieldset=$("fieldset[name=tagfilefields]",this.dialog);this.files=$("input[name=files]",this.fieldset).textbox({editable:false,readonly:true,multiline:true,width:"70%"});this.tags=$("input[name=keywords]",this.fieldset).textbox({required:true,width:"70%"});},getTags:function(){return this.tags.textbox("getValue");},setPaths:function(values){this.files.textbox("setValue",values.join("\r\n"));}});jscape.storage.AdHocTransferController=Class.extend({GROUP_ID_REGEX:/^(group\:)(.+)$/i,CONTACT_ID_REGEX:/^(contact\:)(.+)$/i,addContactAllowed:false,deferred:null,contacts:null,initialize:function(addContactAllowed){this.addContactAllowed=!!addContactAllowed;this._initValidators();},start:function(files,type){this.deferred=$.Deferred();this.type=type;this.contacts=[];this.paths=$.map(files,function(file){return file.path;});if(/external/ig.test(type)){this._showExternalShareDialog(this.paths,type).fail($.proxy(this.onCancel,this,null));}else if(/internal/ig.test(type)){this._showInternalShareDialog(this.paths,type).fail($.proxy(this.onCancel,this,null));}else if(/anonymous/ig.test(type)){this._showAnonymousShareDialog(this.paths).fail($.proxy(this.onCancel,this,null));}else{this.deferred.reject();}
return this.deferred.promise();},onLoadUsers:function(){return jscape.API.getUsernames().then(function(data){return $.map(data||[],function(name){return{id:name,text:name};});});},onLoadContacts:function(){if(this.contacts&&this.contacts.length){return $.Deferred().resolve(this.contacts).promise();}
return jscape.API.listFileShareRecipients({sort:"NAME",order:"ASC",type:this.type}).then($.proxy(function(data){return $.map(data||[],$.proxy(function(item){if(item&&item.id){var matches;if((matches=this.GROUP_ID_REGEX.exec(item.id))!=null){return $.extend(item,{prefix:matches.length>1?matches[1]:undefined,group:true})}else if((matches=this.CONTACT_ID_REGEX.exec(item.id))!=null){return $.extend(item,{prefix:matches.length>1?matches[1]:undefined,contact:true});}}
return item;},this));},this)).then($.proxy(function(data){this.contacts=data;return data;},this));},onAddContact:function(dialog){if(!this.addContactAllowed){return $.Deferred().reject().promise();}
return new jscape.storage.AddContactController().start().then($.proxy(function(data){this.contacts=[];return data;},this));},onSubmitExternalDialog:function(dialog){return jscape.API.shareFiles(jscape.AdHocTransferData.external(this.paths,dialog.getSender(),dialog.getReplyTo(),dialog.getRecipient(),dialog.getCcRecipient(),dialog.getBccRecipient(),dialog.getSubject(),dialog.getMessage(),dialog.getProtection(),dialog.getPassword(),dialog.getExpires(),dialog.getMaxDownloads(),dialog.isDeleteAfterMaxDownloads(),dialog.getDeleteAfterPeriod())).done($.proxy(this.onSubmit,this)).done(function(){$(document).triggerHandler("broadcast",[window.R.string.STORAGE_SUCCESS_EMAIL_FILE]);});},onSubmitInternalDialog:function(dialog){return jscape.API.shareFiles(jscape.AdHocTransferData.internal(this.paths,dialog.getSender(),dialog.getReplyTo(),dialog.getRecipient(),dialog.getCcRecipient(),dialog.getBccRecipient(),dialog.getSubject(),dialog.getMessage(),dialog.getExpires(),dialog.getMaxDownloads(),dialog.isDeleteAfterMaxDownloads(),dialog.getDeleteAfterPeriod())).done($.proxy(this.onSubmit,this)).done(function(){$(document).triggerHandler("broadcast",[window.R.string.STORAGE_SUCCESS_EMAIL_FILE]);});},onSubmitAnonymousDialog:function(dialog){return jscape.API.shareFiles(jscape.AdHocTransferData.anonymous(this.paths,dialog.getSubject(),dialog.getExpires(),dialog.getMaxDownloads(),dialog.isDeleteAfterMaxDownloads(),dialog.getDeleteAfterPeriod())).done($.proxy(this.onSubmit,this)).done(function(data){if(data&&data.uri){new jscape.CopyToClipboardController().start(data.uri,null,window.R.string.ADHOC_TRANSFER_MESSAGE_LINK_COPIED).fail(function(){$.messager.alert({title:window.R.string.APPLICATION_TITLE||"",msg:"<a href='"+String(data.uri).escapeXml()+"' target='blank' />"+data.uri+"</a>",width:"50%",minWidth:600});});}});},onSubmit:function(){this.deferred.resolve();this.deferred=null;},onCancel:function(dialog){dialog&&dialog.destroy();this.deferred.reject();this.deferred=null;},_showExternalShareDialog:function(paths){return jscape.API.composeShareFiles(paths,"EXTERNAL").then($.proxy(function(data){var dialog=new jscape.storage.ShareFileExternalDialog(this.addContactAllowed);dialog.show({onAddContact:$.proxy(this.onAddContact,this),onLoadContacts:$.proxy(this.onLoadContacts,this),onSubmit:$.proxy(this.onSubmitExternalDialog,this),onCancel:$.proxy(this.onCancel,this)});if(data){dialog.setPaths(data.paths);dialog.setSender(data.sender,data.allowedSenders);dialog.setReplyTo(data.replyTo);dialog.setSubject(data.subject);dialog.setExpires(data.expireAfterDays);}},this));},_showInternalShareDialog:function(paths){return jscape.API.composeShareFiles(paths,"INTERNAL").then($.proxy(function(data){var dialog=new jscape.storage.ShareFileInternalDialog();dialog.show({onLoadRecipients:$.proxy(this.onLoadUsers,this),onLoadContacts:$.proxy(this.onLoadContacts,this),onSubmit:$.proxy(this.onSubmitInternalDialog,this),onCancel:$.proxy(this.onCancel,this)});if(data){dialog.setPaths(data.paths);dialog.setSender(data.sender,data.allowedSenders);dialog.setReplyTo(data.replyTo);dialog.setSubject(data.subject);dialog.setExpires(data.expireAfterDays);}},this));},_showAnonymousShareDialog:function(paths){return jscape.API.composeShareFiles(paths,"ANONYMOUS").then($.proxy(function(data){var dialog=new jscape.storage.ShareFileAnonymousDialog();dialog.show({onSubmit:$.proxy(this.onSubmitAnonymousDialog,this),onCancel:$.proxy(this.onCancel,this,dialog)});if(data){dialog.setPaths(data.paths);dialog.setSubject(data.subject);dialog.setExpires(data.expireAfterDays);}},this));},_initValidators:function(){var v=new jscape.Validator();v.rule("recipient_exists",$.proxy(this._recipientExists,this),"Please provide valid recipient.");v.rule("password_compliance",$.proxy(this._passwordCompliant,this),"Password is not compliant.");},_recipientExists:function(value){return!!value&&$.grep(this.contacts,function(c){return c.id==value||c.email==value;}).length!=0;},_passwordCompliant:function(value,params){var accountName=params&&params.length?params[0]:null;var result=jscape.API.testPasswordCompliance(accountName,value);if($.isPlainObject(result)){if(result.valid===false&&result.message){new jscape.Validator().ruleMessage("password_compliance",result.message);}
return!!result.valid;}
return true;}});jscape.ui.RecipientTagbox=Class.extend({initialize:function(jq,options,addRecipientAllowed){this.input=$(jq).tagbox($.extend({editable:true,limitToList:false,multiple:true,separator:",",valueField:"id",textField:"name",val:$.proxy(this._recipientValueOf,this),filter:$.proxy(this._filterByRecipient,this),parser:$.proxy(this._parseRecipient,this),formatter:$.proxy(this._formatRow,this),tagFormatter:$.proxy(this._formatTag,this),tagStyler:$.proxy(this._styleTag,this),keyHandler:this._keyHandlerOf($.fn.tagbox.defaults),icons:!addRecipientAllowed?undefined:[{iconCls:"icon-add",handler:function(e){e.stopPropagation();var t=$(e.data.target);if(t.tagbox("panel").is(":visible")){t.tagbox("hidePanel");}
var opts=t.tagbox("options");opts.onAddRecipient.call(t);}}],hasDownArrow:true,panelHeight:"auto",panelMaxHeight:"50%",panelMinHeight:30,tipPosition:"right",onAddRecipient:function(){}},options||{}));},tagbox:function(){return arguments.length?this.input.tagbox.apply(this.input,arguments):this.input;},reload:function(){this.input.tagbox("reload");},reloadAndSelect:function(value){this.input.tagbox("setValues",this.getValues().concat(value));this.input.tagbox("reload");},getValues:function(){return this.input.length?this._parseRecipient(this.input):[];},setRequired:function(value){this.input.tagbox("textbox").validatebox("options").required=!!value;this.input.tagbox("isValid");},_formatTag:function(value,row){if(!!row){if(!!row.prefix){return this._formatRecipient(row.name,undefined,row.prefix);}else if(!!row.email){return String(row.email).escapeXml();}}
return value;},_styleTag:function(value,row){return row&&!!row.prefix?"color:#222;cursor:pointer":"";},_formatRow:function(row){return row&&!!row.prefix?this._formatRecipient(row.name,undefined,row.prefix):!!row.email?this._formatRecipient(row.name,row.email):this._formatRecipient(row.text,row.value);},_formatRecipient:function(name,email,prefix){if(name&&name.trim().length){if(!!prefix){return"<span style=\"font-weight:600\">{prefix}</span>&nbsp;{name}".supplant({prefix:String(prefix).escapeXml(),name:String(name).escapeXml()});}
if(!!email){return"{name}&nbsp;<span style=\"color:#777\">&lt;{email}&gt;</span>".supplant({name:String(name).escapeXml(),email:String(email).escapeXml()});}
return String(name||"").escapeXml();}
return String(email||"").escapeXml();},_keyHandlerOf:function(defaults){var handler=defaults.keyHandler.enter;return $.extend({},defaults.keyHandler,{enter:function(e){if(e.keyCode==13){e.stopImmediatePropagation();}
handler.call(this,e);}});},_filterByRecipient:function(query,row){query=(query||"").toLocaleLowerCase();return row&&((row.name||"").toLocaleLowerCase().indexOf(query)!=-1||(row.email||"").toLocaleLowerCase().indexOf(query)!=-1||(row.prefix||"").toLocaleLowerCase().indexOf(query)!=-1);},_parseRecipient:function(jq){var data=jq.tagbox("getData");var opts=jq.tagbox("options");return $.map(jq.tagbox("getValues"),function(value){for(var i=0;i<data.length;i++){var item=data[i];if(item[opts.valueField]==value){return item[opts.valueField]||item.email;}}
return value;});},_recipientValueOf:function(jq){var t=$(jq).parent().prev();var opts=t.tagbox("options");var values=typeof opts.parser=="function"?opts.parser(t):t.tagbox("getValues");if($(jq).is(":focus")){values.push($(jq).val());}
return values.join(t.tagbox("options").separator);}});jscape.storage.DefaultShareFileDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog,options){this._super(dialog,$.extend({width:"60%",minWidth:800},options||{}));this.fieldset=$("fieldset[name=adhoctransferfields]",this.dialog);this.subject=$("input[name=subject]",this.fieldset).textbox({required:true,validType:"non_empty",width:"70%",invalidMessage:window.R.string.STORAGE_ERROR_BAD_SUBJECT});this.message=$("textarea[name=message]",this.fieldset).textbox({multiline:true,width:"70%",height:140});this.files=$("textarea[name=filelist]",this.fieldset).textbox({editable:false,readonly:true,multiline:true,width:"70%",height:75});this.useExpires=$("input[name=useexpires]:checkbox",this.fieldset).change($.proxy(function(){this.expires.combobox(this.useExpires.is(":checked")?"enable":"disable");},this));this.expires=$("select[name=expires]",this.fieldset).combobox({required:true,disabled:true,width:65,panelHeight:"auto",panelMinHeight:60,panelMaxHeight:"40%"});this.useMaxDownloads=$("input[name=usemaxdloads]:checkbox",this.fieldset).change($.proxy(function(){var enabled=this.useMaxDownloads.is(":checked");this.maxDownloads.numberspinner(enabled?"enable":"disable").numberspinner(enabled?"enableValidation":"disableValidation");this.deleteAfterMaxDownloads.prop("disabled",!enabled);},this));this.maxDownloads=$("input[name=maxdownloads]",this.fieldset).numberspinner({required:true,disabled:true,min:1,width:65});this.deleteAfterMaxDownloads=$("input[name=deleteaftermaxdownloads]:checkbox",this.fieldset);this.useDeleteAfterPeriod=$("input[name=usedeleteafter]:checkbox",this.fieldset).change($.proxy(function(){this.deleteAfterPeriod.combobox(this.useDeleteAfterPeriod.is(":checked")?"enable":"disable");},this));this.deleteAfterPeriod=$("select[name=deleteafter]",this.fieldset).combobox({required:true,disabled:true,width:65,panelHeight:"auto",panelMinHeight:60,panelMaxHeight:"40%"});},getSubject:function(){return this.subject.textbox("getValue");},setSubject:function(value){this.subject.textbox("setValue",value);},getMessage:function(){return this.message.textbox("getValue");},setPaths:function(values){this.files.textbox("setValue",(values||[]).join("\r\n"));},getExpires:function(){return this.useExpires.is(":checked")?parseInt(this.expires.combobox("getValue")):null;},setExpires:function(value){value=parseInt(value);if(!isNaN(value)){this.expires.combobox("select",value);}
this.useExpires.prop("checked",!isNaN(value)).change();},getMaxDownloads:function(){return this.useMaxDownloads.is(":checked")?parseInt(this.maxDownloads.numberspinner("getValue")):null;},setMaxDownloads:function(value){value=parseInt(value);if(isNaN(value)){this.useMaxDownloads.prop("checked",false).change();}else{this.useMaxDownloads.prop("checked",true).change();this.maxDownloads.numberspinner("setValue",value);}},isDeleteAfterMaxDownloads:function(){return this.deleteAfterMaxDownloads.is(":checked:not(:disabled)");},getDeleteAfterPeriod:function(){return this.useDeleteAfterPeriod.is(":checked")?parseInt(this.deleteAfterPeriod.combobox("getValue")):null;},setDeleteAfterPeriod:function(value){value=parseInt(value);if(isNaN(value)){this.useDeleteAfterPeriod.prop("checked",false).change();}else{this.useDeleteAfterPeriod.prop("checked",true).change();this.deleteAfterPeriod.combobox("setValue",value);}},show:function(listener){this._super(listener);this.useExpires.change();this.useMaxDownloads.change();this.useDeleteAfterPeriod.change();}});jscape.storage.ShareFileExternalDialog=jscape.storage.DefaultShareFileDialog.extend({initialize:function(addContactAllowed){this._super($("#d-storage-adhoc-external"));var initializing=true;this.fieldset=$("fieldset[name=adhoctransferfields]",this.dialog);this.recipient=new jscape.ui.RecipientTagbox($("input[name=to]",this.fieldset),{required:true,separator:",",validType:["non_empty","multi_value['any[\"recipient_exists\",\"email\"]',',']"],invalidMessage:window.R.string.STORAGE_ERROR_BAD_RECIPIENT,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Contacts,this),onChange:$.proxy(function(){this.recipient.setRequired(this.recipient.getValues().length==0);},this),onAddRecipient:$.proxy(this._onClick$AddRecipient,this),width:"50%"},addContactAllowed);this.ccRecipient=new jscape.ui.RecipientTagbox($("input[name=cc]",this.fieldset),{required:false,separator:",",validType:["non_empty","multi_value['any[\"recipient_exists\",\"email\"]',',']"],invalidMessage:window.R.string.STORAGE_ERROR_BAD_RECIPIENT,onBeforeLoad:function(){return!initializing;},width:"70%"});this.ccRecipient.tagbox().closest(".row").hide();this.addCcButton=$("a[role=button][name=addcc]",this.fieldset).linkbutton({plain:true,onClick:$.proxy(function(){this.addCcButton.tooltip("destroy").remove();delete this.addCcButton;this.ccRecipient.tagbox().closest(".row").show();this.ccRecipient.tagbox("resize").tagbox("textbox").focus();if(!this.hasOwnProperty("addBccButton")){this.recipient.tagbox("resize","70%");}},this)});this.addCcButton.tooltip({content:this.addCcButton.attr("title"),showDelay:0}).attr("title","");this.bccRecipient=new jscape.ui.RecipientTagbox($("input[name=bcc]",this.fieldset),{required:false,separator:",",validType:["non_empty","multi_value['any[\"recipient_exists\",\"email\"]',',']"],invalidMessage:window.R.string.STORAGE_ERROR_BAD_RECIPIENT,onBeforeLoad:function(){return!initializing;},width:"70%"});this.bccRecipient.tagbox().closest(".row").hide();this.addBccButton=$("a[role=button][name=addbcc]",this.fieldset).linkbutton({plain:true,onClick:$.proxy(function(){this.addBccButton.tooltip("destroy").remove();delete this.addBccButton;this.bccRecipient.tagbox().closest(".row").show();this.bccRecipient.tagbox("resize").tagbox("textbox").focus();if(!this.hasOwnProperty("addCcButton")){this.recipient.tagbox("resize","70%");}},this)});this.addBccButton.tooltip({content:this.addBccButton.attr("title"),showDelay:0}).attr("title","");this.sender=$("input[name=from]",this.fieldset).combobox({required:true,editable:true,limitToList:true,validType:"email",invalidMessage:window.R.string.STORAGE_ERROR_BAD_SENDER,tipPosition:"bottom",width:"60%",panelHeight:"auto",panelMaxHeight:"40%",panelMinHeight:50});this.replyTo=$("input[name=replyto]",this.fieldset).textbox({required:false,editable:true,validType:"email",width:"70%"});this.replyTo.closest(".row").hide();this.addReplyToButton=$("a[role=button][name=addreplyto]",this.fieldset).linkbutton({plain:true,onClick:$.proxy(function(){this.addReplyToButton.tooltip("destroy").remove();delete this.addReplyToButton;this.replyTo.closest(".row").show();this.replyTo.textbox("resize").textbox("textbox").focus();this.sender.combobox("resize","70%");},this)});this.addReplyToButton.tooltip({content:this.addReplyToButton.attr("title"),showDelay:0}).attr("title","");this.protection=$("select[name=protectwith]",this.fieldset).combobox({editable:false,onChange:$.proxy(function(value){this.password.passwordbox2("CUSTOM"===value?"enable":"disable").passwordbox2("isValid");},this),width:300,panelHeight:"auto"});this.password=$("input[name=custompwd]",this.fieldset).passwordbox2({required:true,validType:"password_compliance",width:"25%",minWidth:160});this.password.length&&this.password.passwordbox2("textbox").attr("autocomplete","new-password");initializing=false;},getRecipient:function(){return this.recipient.getValues();},getCcRecipient:function(){return this.ccRecipient.getValues();},getBccRecipient:function(){return this.bccRecipient.getValues();},getSender:function(){return this.sender.combobox("getValue");},setSender:function(value,data){if(!!data){this.sender.combobox("loadData",data);}
this.sender.combobox("setValue",value).combobox("isValid");},getReplyTo:function(){return this.replyTo.length?this.replyTo.textbox("getValue"):null;},setReplyTo:function(value){if(!!value){this.replyTo.textbox("setValue",value);if(!this.replyTo.is(":visible")&&this.addReplyToButton){this.addReplyToButton.click();}}},getProtection:function(){return this.protection.length?this.protection.combobox("getValue"):null;},setProtection:function(value){if(this.protection.length&&!!value){this.protection.combobox("select",value);}},getPassword:function(){return this.password.length&&!this.password.passwordbox2("options").disabled?this.password.passwordbox2("getValue"):null;},show:function(listener){this._super(listener);this.recipient.reload();},_onLoad$Contacts:function(params,success,error){this.listener.onLoadContacts(params).done($.proxy(function(data){this.ccRecipient.tagbox("loadData",data);this.bccRecipient.tagbox("loadData",data);},this)).done(success).fail(error);},_onClick$AddRecipient:function(){this.listener.onAddContact(this).done($.proxy(function(data){this.recipient.reloadAndSelect(data);},this));}});jscape.storage.ShareFileInternalDialog=jscape.storage.DefaultShareFileDialog.extend({initialize:function(){this._super($("#d-storage-adhoc-internal"));var initializing=true;this.fieldset=$("fieldset[name=adhoctransferfields]",this.dialog);this.recipient=new jscape.ui.RecipientTagbox($("input[name=to]",this.fieldset),{required:true,limitToList:true,validType:"non_empty",invalidMessage:window.R.string.STORAGE_ERROR_BAD_RECIPIENT,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Recipients,this),onChange:$.proxy(function(){this.recipient.setRequired(this.recipient.getValues().length==0);},this),width:"50%"});this.ccRecipient=new jscape.ui.RecipientTagbox($("input[name=cc]",this.fieldset),{required:false,separator:",",validType:["non_empty","multi_value['any[\"recipient_exists\",\"email\"]',',']"],invalidMessage:window.R.string.STORAGE_ERROR_BAD_RECIPIENT,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Contacts,this),width:"70%"});this.ccRecipient.tagbox().closest(".row").hide();this.addCcButton=$("a[role=button][name=addcc]",this.fieldset).linkbutton({plain:true,onClick:$.proxy(function(){this.addCcButton.tooltip("destroy").remove();delete this.addCcButton;this.ccRecipient.tagbox().closest(".row").show();this.ccRecipient.tagbox("resize").tagbox("textbox").focus();if(!this.hasOwnProperty("addBccButton")){this.recipient.tagbox("resize","70%");}},this)});this.addCcButton.tooltip({content:this.addCcButton.attr("title"),showDelay:0}).attr("title","");this.bccRecipient=new jscape.ui.RecipientTagbox($("input[name=bcc]",this.fieldset),{required:false,separator:",",validType:["non_empty","multi_value['any[\"recipient_exists\",\"email\"]',',']"],invalidMessage:window.R.string.STORAGE_ERROR_BAD_RECIPIENT,width:"70%"});this.bccRecipient.tagbox().closest(".row").hide();this.addBccButton=$("a[role=button][name=addbcc]",this.fieldset).linkbutton({plain:true,onClick:$.proxy(function(){this.addBccButton.tooltip("destroy").remove();delete this.addBccButton;this.bccRecipient.tagbox().closest(".row").show();this.bccRecipient.tagbox("resize").tagbox("textbox").focus();if(!this.hasOwnProperty("addCcButton")){this.recipient.tagbox("resize","70%");}},this)});this.addBccButton.tooltip({content:this.addBccButton.attr("title"),showDelay:0}).attr("title","");this.sender=$("input[name=from]",this.fieldset).combobox({required:false,editable:true,limitToList:true,validType:"email",invalidMessage:window.R.string.STORAGE_ERROR_BAD_SENDER,tipPosition:"bottom",width:"60%",panelHeight:"auto",panelMaxHeight:"40%",panelMinHeight:50});this.replyTo=$("input[name=replyto]",this.fieldset).textbox({required:false,editable:true,validType:"email",width:"70%"});this.replyTo.closest(".row").hide();this.addReplyToButton=$("a[role=button][name=addreplyto]",this.fieldset).linkbutton({plain:true,onClick:$.proxy(function(){this.addReplyToButton.tooltip("destroy").remove();delete this.addReplyToButton;this.replyTo.closest(".row").show();this.replyTo.textbox("resize").textbox("textbox").focus();this.sender.combobox("resize","70%");},this)});this.addReplyToButton.tooltip({content:this.addReplyToButton.attr("title"),showDelay:0}).attr("title","");initializing=false;},getRecipient:function(){return this.recipient.getValues();},getCcRecipient:function(){return this.ccRecipient.getValues();},getBccRecipient:function(){return this.bccRecipient.getValues();},getSender:function(){return this.sender.combobox("getValue");},setSender:function(value,data){if(data&&data.length){this.sender.combobox("loadData",data);this.sender.combobox("select",value);}else{this.sender.combobox("reset").combobox("disable");this.sender.parent(".row").hide();this.dialog.dialog("resize",{height:"auto"});}},getReplyTo:function(){return this.replyTo.length?this.replyTo.textbox("getValue"):null;},setReplyTo:function(value){if(!!value){this.replyTo.textbox("setValue",value);if(!this.replyTo.is(":visible")&&this.addReplyToButton){this.addReplyToButton.click();}}},show:function(listener){this._super(listener);this.recipient.reload();this.ccRecipient.reload();},_onLoad$Recipients:function(params,success,error){this.listener.onLoadRecipients(params).done(success).fail(error);},_onLoad$Contacts:function(params,success,error){this.listener.onLoadContacts(params).done($.proxy(function(data){this.ccRecipient.tagbox("loadData",data);this.bccRecipient.tagbox("loadData",data);},this)).done(success).fail(error);}});jscape.storage.ShareFileAnonymousDialog=jscape.storage.DefaultShareFileDialog.extend({initialize:function(){this._super($("#d-storage-adhoc-anonymous"));}});jscape.storage.AddContactController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.addFileShareRecipientContact(this._createData(dialog)).done($.proxy(function(data){this.deferred.resolve(data);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return{name:dialog.getName(),email:dialog.getEmail(),company:dialog.getCompany()};},_setupDialog:function(){return new jscape.storage.AddContactDialog();}});jscape.storage.AddContactDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-contacts-add"),{width:530,resizable:false});this.fieldset=$("fieldset[name=contactfields]",this.dialog);this.name=$("[name=name]",this.fieldset).textbox({required:true,validType:"non_empty",missingMessage:window.R.string.STORAGE_ERROR_BAD_CONTACT_NAME,invalidMessage:window.R.string.STORAGE_ERROR_BAD_CONTACT_NAME,width:"70%"});this.email=$("[name=email]",this.fieldset).textbox({required:true,validType:"multi_value['email',',']",missingMessage:window.R.string.STORAGE_ERROR_BAD_CONTACT_EMAIL,invalidMessage:window.R.string.STORAGE_ERROR_BAD_CONTACT_EMAIL,width:"70%"});this.company=$("[name=company]",this.fieldset).textbox({required:false,width:"70%"});},getName:function(){return this.name.textbox("getValue");},getEmail:function(){return this.email.textbox("getValue");},getCompany:function(){return this.company.textbox("getValue");}});jscape.storage.FileSharesModule=jscape.ApplicationModule.extend({initialize:function(id){this.id=id;},onCreate:function(){this._super.apply(this,arguments);this.view=new jscape.storage.FileSharesView();this.viewController=new jscape.storage.ViewFileShareController();},onStart:function(){this.view.show(this);},onResume:function(){var id=this.id;delete this.id;if(!!id){this.view.refreshAndDownload(id);}else{this.view.refresh();}},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listFileShares(params.startIndex,params.count,params.query).done(function(){$(document).triggerHandler("_activity.user");});},onViewFileShare:function(info){return this.viewController.start(info.id);},onReceiveFileShare:function(info){return jscape.API.receiveFileShare(info.id).done($.proxy(function(){this.view.refresh();},this));}});jscape.storage.FileSharesView=jscape.ui.DatagridView.extend({SIZE_FACTOR:1024,sizeFormat:null,selection:null,initialize:function(){var initializing=true;this.layout=$("#user-file-shares-pane").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=filesharesgrid]",this.layout);this.data.datagrid({fit:true,fitColumns:true,singleSelect:true,ctrlSelect:false,remoteSort:true,autoRowHeight:false,sortOrder:"desc",sortName:"date",idField:"id",pageSize:100,view:$.fn.datagrid.defaults.bufferview,columns:[[{field:"date",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:"15%",fixed:true,formatter:$.proxy(this._formatDate,this)},{field:"subject",title:$("thead th:nth-child(2)",this.data).text(),sortable:true,width:"30%"},{field:"sender",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:"20%"},{field:"files",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:"10%",fixed:true},{field:"downloads",title:$("thead th:nth-child(5)",this.data).text(),sortable:true,width:"10%",fixed:true},{field:"status",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,width:"15%",formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleStatus,this)}]],onSelect:$.proxy(this._adjustRowSelection,this),onSelectAll:$.proxy(this._adjustRowSelection,this),onUnselect:$.proxy(this._adjustRowSelection,this),onUnselectAll:$.proxy(this._adjustRowSelection,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),onDblClickRow:$.proxy(function(){this.downloadButton.click();},this),onBeforeLoad:$.proxy(function(){return!initializing&&!this.loading;},this),loader:$.proxy($.proxy(this._onLoad$Data,this)),onLoadSuccess:$.proxy(this._onLoad$Success,this)});this.data.datagrid("getPanel").addClass("filelist");this.refreshButton=$("a[role=button][name=refresh]",this.layout).linkbutton({onClick:$.proxy(this._onClick$RefreshButton,this)});this.viewButton=$("a[role=button][name=view]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.downloadButton=$("a[role=button][name=dload]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DownloadButton,this)});initializing=false;},show:function(listener){this.listener=listener||jscape.storage.FileSharesView.LISTENER;this.layout.layout("resize");this._adjustRowSelection();return this;},container:function(){return this.layout;},refreshAndDownload:function(id){this.data.datagrid("reload",$.proxy(function(){this.selectRecord(id);this.downloadButton.click();},this));},load:function(query){this.data.datagrid("load",query);},getFileInfos:function(){return this.getRecords();},_showContextMenu:function(e){return this._super(e,[this.downloadButton,this.viewButton,"-",this.refreshButton]);},_formatDate:function(val){return val?window.moment(val).format("ll LTS"):"";},_formatStatus:function(value){return window.R.string[("ADHOC_TRANSFER_STATUS_"+value).toUpperCase()]||String(value||"").escapeXml();},_styleStatus:function(value){switch(value){case jscape.FileShareInfo.Status.ACTIVE:return"color:green";case jscape.FileShareInfo.Status.EXPIRED:return"color:brown";case jscape.FileShareInfo.Status.REVOKED:return"color:red";default:return"color:#000";}},_adjustRowSelection:function(){this.selection=this.data.datagrid("getSelections");this.viewButton.linkbutton(this.selection.length==1?"enable":"disable");this.downloadButton.linkbutton(this.selection.length==1?"enable":"disable");},_onLoad$Data:function(params,success,error){params.page=params.page||1;params.rows=params.rows||this.data.datagrid("options").pageSize;this.loading=true;return this.listener.onRefresh(params).then(jscape.Page.datagridFormatter()).then($.proxy(function(data){this.loading=false;return data;},this)).then(success,error);},_onLoad$Success:function(){this._adjustRowSelection();},_onClick$RefreshButton:function(){this.refresh();},_onClick$ViewButton:function(){this.viewButton.linkbutton("disable");this.listener.onViewFileShare(this.selection[0]).always($.proxy(this._adjustRowSelection,this));},_onClick$DownloadButton:function(){this.listener.onReceiveFileShare(this.selection[0]);}});jscape.storage.FileSharesView.LISTENER={onRefresh:$.noop,onViewFileShare:$.noop,onReceiveFileShare:$.noop};jscape.storage.ViewFileShareController=Class.extend({deferred:null,start:function(id){this.deferred=$.Deferred();this.id=id;this._setupDialog().show(this).refresh();return this.deferred.promise();},onRefresh:function(){return jscape.API.getFileShareInfo(this.id);},onCancel:function(dialog){dialog.destroy();this.deferred.resolve();this.deferred=null;},_setupDialog:function(){return new jscape.storage.ViewFileShareDialog();}});jscape.storage.ViewFileShareDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#d-storage-adhoc-view"),{width:"85%",height:"80%",minHeight:600,closable:true,buttons:null});this.fieldset=$("#adhoctransferfields"+this.getIdSuffix()).layout({fit:true,doSize:false,border:false});this.sender=$("span[aria-label=sender]",this.fieldset);this.subject=$("span[aria-label=subject]",this.fieldset);this.date=$("span[aria-label=date]",this.fieldset);this.data=$("table[role=grid][aria-label=entries]",this.fieldset);this.data.datagrid({fit:true,fitColumns:true,remoteSearch:true,remoteSort:true,sortName:"name",sortOrder:"desc",idField:"id",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),width:"35%",sortable:true},{field:"downloads",title:$("thead th:nth-child(2)",this.data).text(),width:"17%",sortable:true},{field:"expires",title:$("thead th:nth-child(3)",this.data).text(),width:"25%",sortable:true,formatter:$.proxy(this._formatDate,this)},{field:"status",title:$("thead th:nth-child(4)",this.data).text(),width:"17%",sortable:true,formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleStatus,this)}]],onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Data,this),loadFilter:$.proxy(this._onFilter$Data,this)});initializing=false;},show:function(listener){this._super(listener);return this;},refresh:function(){this.data.datagrid("reload");},_formatDate:function(value){return $.isNumeric(value)?new Date(value).toLocaleString():"";},_formatStatus:function(value){return window.R.string[("ADHOC_TRANSFER_STATUS_"+value).toUpperCase()]||String(value||"").escapeXml();},_styleStatus:function(value){switch(value){case jscape.FileShareInfo.Status.ACTIVE:return"color:green";case jscape.FileShareInfo.Status.EXPIRED:return"color:brown";case jscape.FileShareInfo.Status.REVOKED:return"color:red";default:return"color:#000";}},_onFilter$Data:function(data){if(data){this.sender.text(data.sender);this.subject.text(data.subject);this.date.text(this._formatDate(data.date));return data.entries;}
return[];},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).done(success).fail(error);}});