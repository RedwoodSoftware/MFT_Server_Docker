/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.storage=jscape.storage||{};jscape.storage.StorageApplication=jscape.Application.extend({onLogout:function(){jscape.API.logout();},onReady:function(){this._super();this.view.show(this);this._forceStartModule("password-compliance");this._forceStartModule("account-inactivity");},onBroadcast:function(e,message,success,code){this._super.apply(this,arguments);code==="PWD_CHANGED"&&window.location.reload(true);},_createView:function(){this._super();this.view=new jscape.storage.StorageView();},_destroy:function(){this._forceStopModule("account-inactivity");this._forceStopModule("password-compliance");this._super();}});jscape.storage.StorageView=jscape.DashboardView.extend({initialize:function(){this._super($());},show:function(listener){this._super(listener||jscape.storage.StorageView.LISTENER);this.viewport.layout("resize");}});jscape.storage.StorageView.LISTENER={onLogout:$.noop};jscape.storage.PasswordComplianceModule=jscape.ApplicationModule.extend({passwordChanged:false,onCreate:function(){this.view=new jscape.storage.PasswordComplianceView();jscape.API.getUsername().done($.proxy(function(username){this.username=username;},this));},onStart:function(){if(!this.passwordChanged){this.view.show(this);}},onStop:function(){if(this.view){this.view.destroy();this.view=null;}},onChangePassword:function(dialog){dialog.destroy();var controller=new jscape.storage.ChangePasswordController();return controller.start(this.username,true).then($.proxy(function(){this.passwordChanged=true;this._firePasswordChanged();},this));},onClose:function(dialog){dialog.destroy();},_firePasswordChanged:function(){$(document).triggerHandler("broadcast",[window.R.string.USER_CHANGE_PASSWORD_MESSAGE,true,"PWD_CHANGED"]);}});jscape.storage.PasswordComplianceView=Class.extend({initialize:function(){this.holder=$("#logininfo");var reminder=$("#password-reminder");if(this.holder.length&&reminder.length){this.holder.tooltip({content:reminder.html(),showEvent:"none",hideEvent:"none",onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onShow:$.proxy(function(){this.holder.tooltip("tip").one("click",$.proxy(function(){this.holder.tooltip("destroy");},this)).find("a[role=button][name=changepwd]").linkbutton({onClick:$.proxy(this._onClick$ChangePasswordButton,this)});this.holder.tooltip("reposition");},this),onHide:function(){$(this).tooltip("destroy");}});}},show:function(listener){this.listener=listener||jscape.storage.PasswordComplianceView.LISTENER;if(this.holder.length){this.holder.tooltip("show");$(window).on("resize.password_reminder",$.proxy(function(){this.holder.tooltip("reposition");},this));}},destroy:function(){if(this.holder.length){this.holder.tooltip("destroy");$(window).off("resize.password_reminder");}},_onClick$ChangePasswordButton:function(){this.listener.onChangePassword(this);}});jscape.storage.PasswordComplianceView.LISTENER={onChangePassword:$.noop};jscape.storage.ChangePasswordController=Class.extend({deferred:null,initialize:function(){this._initValidators();},start:function(username,current){this.username=username;this.deferred=$.Deferred();this._setupDialog(current).show(this);return this.deferred.promise();},onSubmit:function(dialog){jscape.API.changeUserPassword(this.username,dialog.getCurrentPassword(),dialog.getPassword()).done($.proxy(function(){dialog.destroy();this.deferred.resolve();this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(current){var dialog=new jscape.storage.ChangePasswordDialog(current);dialog.setUsername(this.username);return dialog;},_initValidators:function(){var v=new jscape.Validator();v.rule("pi_password_compliance",$.proxy(this._passwordCompliant,this),"");v.rule("pi_password_confirm",$.proxy(this._passwordConfirmed,this),window.R.string.USER_ERROR_CONFIRM_PWD);},_passwordCompliant:function(value,params){var accountName=params&&params.length?params[0]:null;var result=jscape.API.testPasswordCompliance(accountName,value);if($.isPlainObject(result)){if(result.valid===false&&result.message){new jscape.Validator().ruleMessage("pi_password_compliance",result.message);}
return!!result.valid;}
return true;},_passwordConfirmed:function(value,params){return params&&params.length&&$(params[0]).val()==value;}});jscape.storage.ChangePasswordDialog=jscape.ui.DefaultDialog.extend({initialize:function(current){this._super($("#d-user-changepwd"),{width:"50%",minWidth:530});this.fieldset=$("fieldset[name=userpasswordfields]",this.dialog);if(!current){$("input[name=oldpassword]",this.fieldset).parent().remove();}else{this.oldPassword=$("input[name=oldpassword]",this.fieldset).passwordbox2({width:"70%"});}
var id="newpwd_"+(1E9*Math.random()>>>0);this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({validType:"pi_password_confirm",validParams:["#"+id],missingMessage:window.R.string.USER_ERROR_CONFIRM_PWD,tipPosition:"bottom",width:"70%"});this.newPassword=$("input[name=newpassword]",this.fieldset).attr("id",id).passwordbox2({validType:"user_password_compliance",validateOnCreate:false,validateOnBlur:true,delay:5000,interval:5000,inputEvents:{input:$.proxy(function(cpb,e){var t=$(e.data.target).passwordbox2("getText");cpb.passwordbox2("textbox").validatebox("options").required=t.length!=0;(!t||!t.length)&&cpb.passwordbox2("isValid");},this,this.confirmPassword)},onBeforeValidate:$.proxy(function(){this.newPassword&&this.confirmPassword.passwordbox2("isValid");},this),tipPosition:"bottom",width:"70%"});},getCurrentPassword:function(){return this.oldPassword&&this.oldPassword.length?this.oldPassword.passwordbox2("getValue"):null;},getPassword:function(){return this.newPassword.passwordbox2("getValue");},setUsername:function(value){var opts=this.newPassword.passwordbox2("textbox").validatebox("options");opts.validParams=!!value?[String(value).escapeXml()]:[];opts.required=!this.newPassword.passwordbox2("isSatisfied");}});