/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.account=jscape.account||{};jscape.AdHocTransferSummary=Class.extend({initialize:function(a,b,c,d,e,f,g,h,i,j,k,l,m){this.id=a||"";this.type=jscape.AdHocTransferSummary.Type.valueOf(b);this.sender=c||"";this.recipient=d||"";this.ccRecipients=e||[];this.bccRecipients=f||[];this.subject=g||"";this.message=h||"";this.transferObjects=i||[];this.dispatchTime=parseInt(j)||0;this.downloads=parseInt(k)||0;this.status=jscape.AdHocTransferSummary.Status.valueOf(l);this.address=m||"";}});jscape.AdHocTransferSummary.fromJSON=function(data){return data?new jscape.AdHocTransferSummary(data.id,data.type,data.sender,data.recipient,data.ccRecipients,data.bccRecipients,data.subject,data.message,$.map(data.transferObjects||[],jscape.AdHocTransferSummary.Entry.fromJSON),data.dispatchTime,data.downloads,data.status,data.address):null;};jscape.AdHocTransferSummary.Entry=Class.extend({initialize:function(id,type,name,path,expires,downloads,deletionTime,status,address){this.id=id||"";this.type=jscape.AdHocTransferSummary.Type.valueOf(type);this.name=name||"";this.path=path||"";this.expires=parseInt(expires)||null;this.downloads=parseInt(downloads)||0;this.deletionTime=parseInt(deletionTime)||null;this.status=jscape.AdHocTransferSummary.Status.valueOf(status);this.address=address||"";}});jscape.AdHocTransferSummary.Entry.fromJSON=function(data){return data?new jscape.AdHocTransferSummary.Entry(data.id,data.type,data.name,data.path,data.expires,data.downloads,data.deletionTime,data.status,data.address):null;};jscape.AdHocTransferSummary.Status={ACTIVE:"ACTIVE",REVOKED:"REVOKED",EXPIRED:"EXPIRED",values:function(){return[this.ACTIVE,this.REVOKED,this.EXPIRED];},valueOf:function(value){return $.inArray(value,this.values())!=-1?value:this.ACTIVE;}};jscape.AdHocTransferSummary.Type={EMAIL:"EMAIL",LINK:"LINK",INTERNAL:"INTERNAL",values:function(){return[this.EMAIL,this.LINK,this.INTERNAL];},valueOf:function(value){return $.inArray(value,this.values())!=-1?value:this.EMAIL;}};jscape.account.AdHocActivityModule=jscape.ApplicationModule.extend({onCreate:function(){this.controller=new jscape.account.AdHocTransfersController();},onStart:function(){this.controller.start();},onResume:function(){this.controller.onResume();}});jscape.account.AdHocTransfersController=jscape.ui.DatagridController.extend({view:null,initialize:function(){this.view=new jscape.account.AdHocTransfersView();this.extendController=new jscape.account.ExtendAdHocTransferController();this.revokeController=new jscape.account.RevokeAdHocTransferController();this.viewController=new jscape.account.ViewAdHocTransferController();},start:function(){this.view.show(this);},onResume:function(){this.view.refresh();},onLoadData:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listAdhocTransfers(params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onExtend:function(transfers){this.extendController.start(transfers).done($.proxy(this._transferExtended,this));},onRevoke:function(transfers){this.revokeController.start(transfers).done($.proxy(this._transferRevoked,this));},onView:function(transfer){this.viewController.start(transfer).done($.proxy(function(changed){!!changed&&this.view.refresh();},this));},onCopyLink:function(transfer){return jscape.API.getAdhocTransferLink(transfer.id).done(function(data){if(data&&data.uri){new jscape.CopyToClipboardController().start(data.uri,null,window.R.string.ADHOC_TRANSFER_MESSAGE_LINK_COPIED);}});},_transferRevoked:function(transfers){this._reloadAndSelect(transfers)},_transferExtended:function(transfer){this._reloadAndSelect(transfer);}});jscape.account.AdHocTransfersView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.layout=$("#account-adhoc-transfers-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=adhoctransfers]",this.layout);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"date",sortOrder:"desc",idField:"id",columns:[[{field:"date",title:$("thead th:nth-child(1)",this.data).text(),width:"16%",sortable:true,formatter:$.proxy(function(_,data){return this._formatDate(data.dispatchTime);},this),finder:"datebox"},{field:"subject",title:$("thead th:nth-child(2)",this.data).text(),width:"24%",sortable:true},{field:"recipient",title:$("thead th:nth-child(3)",this.data).text(),width:"20%",sortable:true},{field:"files",title:$("thead th:nth-child(4)",this.data).text(),width:"10%",sortable:true,formatter:function(_,data){return data.transferObjects.length;}},{field:"downloads",title:$("thead th:nth-child(5)",this.data).text(),width:"10%",sortable:true},{field:"type",title:$("thead th:nth-child(6)",this.data).text(),width:"10%",sortable:true,formatter:$.proxy(this._formatType,this),finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.AdHocTransferSummary.Type.values(),$.proxy(function(entry){return{text:this._formatType(entry),value:entry};},this))}}},{field:"status",title:$("thead th:nth-child(7)",this.data).text(),width:"10%",sortable:true,formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleStatus,this),finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.AdHocTransferSummary.Status.values(),$.proxy(function(entry){return{text:this._formatStatus(entry),value:entry};},this))}}}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(function(){this.viewButton.click();},this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.copyLinkButton=$("a[role=button][name=copylink]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)});this.revokeButton=$("a[role=button][name=revoke]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RevokeButton,this)});this.extendButton=$("a[role=button][name=extend]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExtendButton,this)});this.viewButton=$("a[role=button][name=view]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ViewButton,this)});this.layout.layout("panel","south").panel("resize",{height:"auto"});initializing=false;},show:function(listener){this.listener=listener||jscape.account.AdHocTransfersView.LISTENER;this.layout.layout("resize");this._adjustState();},_formatDate:function(value){return $.isNumeric(value)?new Date(value).toLocaleString():"";},_formatType:function(value){return window.R.string[("ADHOC_TRANSFER_TYPE_"+value).toUpperCase()]||String(value||"").escapeXml();},_formatStatus:function(value){return window.R.string[("ADHOC_TRANSFER_STATUS_"+value).toUpperCase()]||String(value||"").escapeXml();},_styleStatus:function(value){switch(value){case jscape.AdHocTransferSummary.Status.ACTIVE:return"color:green";case jscape.AdHocTransferSummary.Status.EXPIRED:return"color:brown";case jscape.AdHocTransferSummary.Status.REVOKED:return"color:red";default:return"color:#000";}},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then(success,error);},_onClick$RevokeButton:function(){this.listener.onRevoke(this.selection);},_onClick$ExtendButton:function(){this.listener.onExtend(this.selection);},_onClick$ViewButton:function(){this.listener.onView(this.selection[0]);},_onClick$CopyLinkButton:function(){this.listener.onCopyLink(this.selection[0],this.copyLinkButton);},_showContextMenu:function(e){this._super(e,[this.viewButton,"-",this.extendButton,this.revokeButton,"-",this.copyLinkButton]);},_adjustState:function(){this.selection=this._pageSelectionFor(this.data);var revokedCount=$.grep(this.selection,function(entry){return jscape.AdHocTransferSummary.Status.REVOKED==entry.status;}).length;this.copyLinkButton.linkbutton(this.selection.length==1?"enable":"disable");this.extendButton.linkbutton(this.selection.length!=0?"enable":"disable");this.revokeButton.linkbutton(this.selection.length!=0&&revokedCount==0?"enable":"disable");this.viewButton.linkbutton(this.selection.length==1?"enable":"disable");}});jscape.account.AdHocTransfersView.LISTENER={onLoadData:$.noop,onExtend:$.noop,onRevoke:$.noop,onView:$.noop,onCopyLink:$.noop};jscape.account.ViewAdHocTransferController=Class.extend({deferred:null,changed:null,start:function(transfer){this.deferred=$.Deferred();this.changed=false;this.transfer=transfer;this._setupDialog().show(this).refresh();return this.deferred.promise();},onLoadData:function(params){return jscape.API.getAdHocTransfer(this.transfer.id);},onExtend:function(objects,dialog){var controller=new jscape.account.ExtendAdHocTransferController();return controller.start([this.transfer],$.map(objects,function(object){return object.id;})).done($.proxy(function(){dialog.refresh();this.changed=true;},this));},onRevoke:function(objects,dialog){var controller=new jscape.account.RevokeAdHocTransferController();return controller.start([this.transfer],$.map(objects,function(object){return object.id;})).done($.proxy(function(){dialog.refresh();this.changed=true;},this));},onCopyLink:function(object){return jscape.API.getAdhocTransferLink(this.transfer.id,object.id).done(function(data){if(data&&data.uri){new jscape.CopyToClipboardController().start(data.uri,null,window.R.string.ADHOC_TRANSFER_MESSAGE_LINK_COPIED);}});},onClose:function(dialog){dialog.destroy();this.deferred.resolve(this.changed);this.deferred=null;},_setupDialog:function(){return new jscape.account.ViewAdHocTransferDialog();}});jscape.account.ViewAdHocTransferDialog=jscape.ui.DefaultDialog.extend({initialize:function(){var initializing=true;this._super($("#d-adhoctransfer-view"),{width:"85%",height:"80%",minHeight:600,closable:true,buttons:null});this.fieldset=$("#adhoctransferemailfields"+this.getIdSuffix()).layout({fit:true,doSize:false,border:false});this.sender=$("span[aria-label=sender]",this.fieldset);this.date=$("span[aria-label=date]",this.fieldset);this.recipient=$("span[aria-label=recipient]",this.fieldset);this.cc=$("span[aria-label=cc]",this.fieldset);this.bcc=$("span[aria-label=bcc]",this.fieldset);this.message=$("span[aria-label=message]",this.fieldset);this.data=$("table[role=grid][aria-label=transferobjects]",this.fieldset);this.data.datagrid({fit:true,remoteSearch:true,remoteSort:true,sortName:"name",sortOrder:"desc",idField:"id",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),width:"15%",sortable:true},{field:"path",title:$("thead th:nth-child(2)",this.data).text(),width:"28%",sortable:true},{field:"downloads",title:$("thead th:nth-child(3)",this.data).text(),width:"10%",sortable:true},{field:"expires",title:$("thead th:nth-child(4)",this.data).text(),width:"13%",sortable:true,formatter:$.proxy(function(_,data){return this._formatDate(data.expires);},this),sorter:$.proxy(this._compareNumeric,this),finder:"datebox"},{field:"deletionTime",title:$("thead th:nth-child(5)",this.data).text(),width:"13%",sortable:true,formatter:$.proxy(function(_,data){return this._formatDate(data.deletionTime);},this),sorter:$.proxy(this._compareNumeric,this),finder:"datebox"},{field:"type",title:$("thead th:nth-child(6)",this.data).text(),width:"10%",sortable:true,formatter:$.proxy(this._formatType,this),finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.AdHocTransferSummary.Type.values(),$.proxy(function(entry){return{text:this._formatType(entry),value:entry};},this))}}},{field:"status",title:$("thead th:nth-child(7)",this.data).text(),width:"11%",sortable:true,formatter:$.proxy(this._formatStatus,this),styler:$.proxy(this._styleStatus,this),finder:{type:"combobox",options:{panelHeight:"auto",data:$.map(jscape.AdHocTransferSummary.Status.values(),$.proxy(function(entry){return{text:this._formatStatus(entry),value:entry};},this))}}}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.copyLinkButton=$("a[role=button][name=copylink]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)});this.revokeButton=$("a[role=button][name=revoke]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$RevokeButton,this)});this.extendButton=$("a[role=button][name=extend]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ExtendButton,this)});this.fieldset.layout("panel","south").panel("resize",{height:"auto"});initializing=false;},show:function(listener){this._super(listener);this.fieldset.layout("resize");return this;},refresh:function(){this.data.datagrid("reload");},_formatDate:function(value){return $.isNumeric(value)?new Date(value).toLocaleString():"";},_formatType:function(value){return window.R.string[("ADHOC_TRANSFER_TYPE_"+value).toUpperCase()]||String(value||"").escapeXml();},_formatStatus:function(value){return window.R.string[("ADHOC_TRANSFER_STATUS_"+value).toUpperCase()]||String(value||"").escapeXml();},_styleStatus:function(value){switch(value){case jscape.AdHocTransferSummary.Status.ACTIVE:return"color:green";case jscape.AdHocTransferSummary.Status.EXPIRED:return"color:brown";case jscape.AdHocTransferSummary.Status.REVOKED:return"color:red";default:return"color:#000";}},_compareNumeric:function(o1,o2){o1=parseInt(o1);o2=parseInt(o2);return isNaN(o1)?(isNaN(o2)?0:1):(isNaN(o2)?1:(o1==o2?0:o1>o2?1:-1));},_onLoad$Data:function(params,success,error){this.listener.onLoadData(params).then($.proxy(function(data){return data?this._loadData(data).transferObjects:[];},this)).done(success).fail(error);},_loadData:function(data){this.sender.text(data.sender);this.date.text(this._formatDate(data.dispatchTime));this.recipient.text(data.recipient);this.cc.text(data.ccRecipients.join(", "));this.bcc.text(data.bccRecipients.join(", "));this.message.text(data.message);return data;},_onClick$RevokeButton:function(){this.revokeButton.linkbutton("disable");this.listener.onRevoke(this.selection,this).always($.proxy(this._adjustState,this));},_onClick$ExtendButton:function(){this.extendButton.linkbutton("disable");this.listener.onExtend(this.selection,this).always($.proxy(this._adjustState,this));},_onClick$CopyLinkButton:function(){this.copyLinkButton.linkbutton("disable");this.listener.onCopyLink(this.selection[0],this,this.copyLinkButton).always($.proxy(this._adjustState,this));},_adjustState:function(){this.selection=this.data.datagrid("getSelections");var revokedCount=$.grep(this.selection,function(entry){return jscape.AdHocTransferSummary.Status.REVOKED==entry.status;}).length;this.copyLinkButton.linkbutton(this.selection.length==1?"enable":"disable");this.extendButton.linkbutton(this.selection.length!=0?"enable":"disable");this.revokeButton.linkbutton(this.selection.length!=0&&revokedCount==0?"enable":"disable");}});jscape.account.ExtendAdHocTransferController=Class.extend({deferred:null,start:function(transfers,transferObjectIds){this.transfers=transfers;this.transferObjectIds=transferObjectIds||[];this.deferred=$.Deferred();this._setupDialog(transfers).show(this);return this.deferred.promise();},onSubmit:function(dialog){var expires=(dialog.getDate()||(this._addDays(new Date(),7))).getTime();$.when.apply(jQuery,$.map(this.transfers,$.proxy(function(transfer){return jscape.API.extendAdHocTransfer(transfer.id,expires,this.transferObjectIds);},this))).done($.proxy(function(){dialog.destroy();this.deferred.resolve(this.transfers);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.account.ExtendAdHocTransferDialog();dialog.setDate(this._addDays(new Date(),7));return dialog;},_addDays:function(date,days){date.setDate(date.getDate()+days);return date;}});jscape.account.ExtendAdHocTransferDialog=Class.extend({initialize:function(){this.dialog=$("#d-adhoctransfer-extend").clone().attr("id","");this.dialog.dialog({width:430,height:"auto",modal:true,resizable:false,closable:true,closed:true,buttons:[{text:window.R.string.DIALOG_BUTTON_OK,handler:$.proxy(this._onSubmit,this)},{text:window.R.string.DIALOG_BUTTON_CANCEL,handler:$.proxy(this._onCancel,this)}],onClose:$.proxy(function(){if(!this.closing){this._onCancel();}},this)}).show();this.fieldset=$("fieldset[name=adhoctransferextendfields]",this.dialog);this.date=$("input[name=date]",this.fieldset).datebox({required:true,width:150});this.date.datebox("calendar").calendar({validator:function(date){return new Date().getTime()<date.getTime();}});},getDate:function(){return this.date.datebox("getDate");},setDate:function(value){this.date.datebox("setDate",value);},show:function(listener){this.listener=listener;this.dialog.dialog("center").dialog("open");this.fieldset.form("validate");this.fieldset.find("input:first").focus();},hide:function(){if(!this._closed()){this.closing=true;this.dialog.dialog("close");this.fieldset.form("disableValidation");this.closing=false;}},destroy:function(){this.dialog.dialog("destroy");},_onSubmit:function(){if(this.fieldset.form("validate")){this.hide();this.listener.onSubmit(this);}},_onCancel:function(){this.hide();this.listener.onCancel(this);},_closed:function(){return!!this.dialog.dialog("options").closed;}});jscape.account.RevokeAdHocTransferController=Class.extend({deferred:null,start:function(transfers,transferObjectIds){return this._confirmRevoke(transfers).then($.proxy(this._revokeConfirmed,this,transfers,transferObjectIds));},_confirmRevoke:function(transfers){return jscape.ConfirmDialog.confirm(window.R.string.ADHOC_TRANSFER_REVOKE_TITLE,window.R.string.ADHOC_TRANSFER_REVOKE_MESSAGE);},_revokeConfirmed:function(transfers,transferObjectIds){return $.when.apply(jQuery,$.map(transfers,function(transfer){return jscape.API.revokeAdHocTransfer(transfer.id,transferObjectIds);}));}});