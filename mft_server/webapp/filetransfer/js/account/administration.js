/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.account=jscape.account||{};jscape.DropZoneData=Class.extend({initialize:function(name,user,path,password,createDirectoryIfNotExists,overwriteFileIfNotExists,theme,owner,uri){this.name=name||"";this.account=user||"";this.path=path||"";this.password=password||"";this.createDirectoryIfNotExists=!!createDirectoryIfNotExists;this.overwriteFileIfExists=!!overwriteFileIfNotExists;this.theme=theme||null;this.owner=owner||null;this.uri=uri||"";}});jscape.DropZoneData.fromJSON=function(data){return data?new jscape.DropZoneData(data.name,data.account,data.path,undefined,data.createDirectoryIfNotExists,data.overwriteFileIfExists,data.theme,data.owner,data.uri):null;};jscape.account.DomainAdministrationModule=jscape.ApplicationModule.extend({userControlAllowed:false,themeControlAllowed:false,zoneControlAllowed:false,initialize:function(a,b,c){this.userControlAllowed=!!a;this.themeControlAllowed=!!b;this.zoneControlAllowed=!!c;},onCreate:function(username,baseUri){this._super.apply(this,arguments);if(this.userControlAllowed){this.usersController=new jscape.account.UsersController(username);}
if(this.themeControlAllowed){this.themeController=new jscape.account.UrlBrandingController();}
if(this.zoneControlAllowed){this.zoneController=new jscape.account.DropZonesController();}},onStart:function(){this.usersController&&this.usersController.start();this.themeController&&this.themeController.start();this.zoneController&&this.zoneController.start();},onResume:function(){this.usersController&&this.usersController.onResume();this.themeController&&this.themeController.onResume();this.zoneController&&this.zoneController.onResume();}});jscape.account.DropZonesController=jscape.ui.DatagridController.extend({initialize:function(){this.view=new jscape.account.DropZonesView();this.addController=new jscape.account.AddDropZoneController();this.editController=new jscape.account.EditDropZoneController();this.deleteController=new jscape.account.DeleteDropZoneController();this._initValidators();},start:function(){this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listDropZones(params.startIndex,params.count,params.query,true).then(jscape.Page.datagridFormatter());},onAddZone:function(){this.addController.start().done($.proxy(this._dropZoneAdded,this));},onEditZone:function(zone){this.editController.start(zone).done($.proxy(this._dropZoneEdited,this));},onDeleteZone:function(zones){this.deleteController.start(zones).done($.proxy(this._dropZoneDeleted,this));},onCopyLink:function(zone){return jscape.API.getDropZoneLink(zone.name,true).then(function(data){if(data&&data.uri){return new jscape.CopyToClipboardController().start(data.uri,null,window.R.string.APPLICATION_MESSAGE_COPIED);}
return data});},_dropZoneAdded:function(){this._recordAdded();},_dropZoneEdited:function(zone){this._recordEdited(zone);},_dropZoneDeleted:function(zones){this._recordDeleted(zones);},_initValidators:function(){var v=new jscape.Validator();v.rule("dropzone_name",$.proxy(this._dropZoneNameValid,this),window.R.string.DROP_ZONE_ERROR_BAD_NAME);v.rule("dropzone_unique",$.proxy(this._dropZoneNotExists,this),window.R.string.DROP_ZONE_ERROR_ALREADY_EXIST);v.nonEmptyRule("dropzone_path_nonempty",window.R.string.DROP_ZONE_ERROR_BAD_PATH);v.rule("dropzone_path",$.proxy(this._dropZonePathValid,this),window.R.string.DROP_ZONE_ERROR_BAD_PATH);v.rule("dropzone_password_confirm",$.proxy(this._passwordConfirmed,this),window.R.string.DROP_ZONE_ERROR_CONFIRM_PWD);v.rule("dropzone_password_compliance",$.proxy(this._passwordCompliant,this),"");},_dropZoneNameValid:function(name){return/^\w+$/g.test(name);},_dropZoneNotExists:function(name){var names=$.map(this.view.getDropZones(),function(zone){return zone.name;});return $.inArray(name,names)==-1;},_dropZonePathValid:function(value){return value!=null&&value.length!=0&&value.trim().charAt(0)=='/';},_passwordCompliant:function(value,params){var accountName=params&&params.length?params[0]:null;var result=jscape.API.testPasswordCompliance(accountName,value);if($.isPlainObject(result)){if(result.valid===false){if(result.message){new jscape.Validator().ruleMessage("dropzone_password_compliance",result.message);}
return false;}}
return true;},_passwordConfirmed:function(value,params){return params&&params.length&&$(params[0]).val()==value;}});jscape.account.DropZonesView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.layout=$("#account-admin-dropzones-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=admin-dropzones]",this.layout);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:50},{field:"uri",title:$("thead th:nth-child(2)",this.data).text(),width:90,searchable:false},{field:"theme",title:$("thead th:nth-child(3)",this.data).text(),width:50},{field:"account",title:$("thead th:nth-child(4)",this.data).text(),sortable:true,width:50},{field:"path",title:$("thead th:nth-child(5)",this.data).text(),width:90},{field:"owner",title:$("thead th:nth-child(6)",this.data).text(),sortable:true,width:50,sorter:function(a,b){return a==b?0:a==null||a<b?-1:1;}}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.copyLinkButton=$("a[role=button][name=copylink]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)});this.addButton=$("a[role=button][name=add]",this.layout).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},getDropZones:function(){return this.getRecords();},show:function(listener){this.listener=listener||jscape.account.DropZonesView.LISTENER;this.layout.layout("resize");this._adjustState();},refresh:function(){this.data.datagrid("reload");},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).done(success).fail(error);},_onClick$CopyLinkButton:function(){this.listener.onCopyLink(this.selection[0]);},_onClick$AddButton:function(){this.listener.onAddZone();},_onClick$EditButton:function(){this.listener.onEditZone(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteZone(this.selection);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton,"-",this.copyLinkButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");var len=this.selection.length;this.copyLinkButton.linkbutton(len==1?"enable":"disable");this.editButton.linkbutton(len==1?"enable":"disable");this.deleteButton.linkbutton(len!=0?"enable":"disable");}});jscape.account.DropZonesView.LISTENER={onRefresh:$.noop,onCopyLink:$.noop,onAddZone:$.noop,onEditZone:$.noop,onDeleteZone:$.noop};jscape.account.BaseDropZoneController=Class.extend({initialize:function(a){this.base=a;},onLoadUsers:function(){return jscape.API.getUsernames().catch(function(){return[];});},onLoadWebThemes:function(){return jscape.API.getWebThemeNames().then(function(data){return data.sort();},function(){return[];});},onCopyLink:function(){return $.Deferred().resolve().promise();}});jscape.account.AddDropZoneController=jscape.account.BaseDropZoneController.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.addDropZone(this._createData(dialog)).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.account.AddDropZoneDialog();dialog.setCreatePathIfNotExists(true);dialog.setOverwriteFileIfExists(true);return dialog;},_createData:function(dialog){return new jscape.DropZoneData(dialog.getName(),dialog.getUser(),dialog.getPath(),dialog.getPassword(),dialog.getCreatePathIfNotExists(),dialog.getOverwriteFileIfExists(),dialog.getWebTheme());}});jscape.account.EditDropZoneController=jscape.account.BaseDropZoneController.extend({deferred:null,start:function(zone){this.zoneName=zone.name;this.deferred=$.Deferred();var promise=this.deferred.promise();jscape.API.getDropZone(zone.name).done($.proxy(function(data){this._setupDialog(data).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return promise;},onSubmit:function(dialog){return jscape.API.updateDropZone(this.zoneName,this._createData(dialog)).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},onCopyLink:function(target){return jscape.API.getDropZoneLink(this.zoneName).then(function(data){if(data&&data.uri){return new jscape.CopyToClipboardController().start(data.uri,target,window.R.string.APPLICATION_MESSAGE_COPIED,"top");}
return data});},_setupDialog:function(data){var dialog=new jscape.account.EditDropZoneDialog();if(data){dialog.setName(data.name);dialog.setPath(data.path);dialog.setCreatePathIfNotExists(data.createDirectoryIfNotExists);dialog.setOverwriteFileIfExists(data.overwriteFileIfExists);dialog.setUser(data.account);dialog.setWebTheme(data.theme);dialog.setUri(data.uri);}
return dialog;},_createData:function(dialog){return new jscape.DropZoneData(this.zoneName,dialog.getUser(),dialog.getPath(),dialog.getPassword(),dialog.getCreatePathIfNotExists(),dialog.getOverwriteFileIfExists(),dialog.getWebTheme());}});jscape.account.DropZoneDialog=jscape.ui.DefaultDialog.extend({initialize:function(dialog){var initializing=true;this._super(dialog,{width:"50%",minWidth:530,height:"60%"});this.fieldset=this.dialog.find(".content").first().layout({fit:true,border:false,doSize:false});this.user=$("select[name=account]",this.fieldset).combobox({required:true,editable:false,limitToList:true,missingMessage:window.R.string.DROP_ZONE_ERROR_BAD_ACCOUNT,onBeforeLoad:function(){return!initializing;},loader:$.proxy(this._onLoad$Users,this),width:"60%",panelHeight:"auto",panelMinHeight:50,panelMaxHeight:"40%"}).combobox("autocomplete",true);this.path=$("input[name=path]",this.fieldset).textbox({required:true,validType:["dropzone_path_nonempty","dropzone_path"],missingMessage:window.R.string.DROP_ZONE_ERROR_BAD_PATH,width:"60%"});var id="dz_"+(1E9*Math.random()>>>0);this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({validType:"dropzone_password_confirm",validParams:["#"+id],missingMessage:window.R.string.DROP_ZONE_ERROR_CONFIRM_PWD,tipPosition:"bottom",width:"55%"});this.password=$("input[name=password]",this.fieldset).attr("id",id).passwordbox2({validType:"dropzone_password_compliance",validateOnCreate:false,validateOnBlur:true,delay:5000,interval:5000,inputEvents:{input:$.proxy(function(cpb,e){var t=$(e.data.target).passwordbox2("getText");cpb.passwordbox2("textbox").validatebox("options").required=t.length!=0;(!t||!t.length)&&cpb.passwordbox2("isValid");},this,this.confirmPassword)},onBeforeValidate:$.proxy(function(){this.confirmPassword&&this.confirmPassword.passwordbox2("isValid");},this),tipPosition:"bottom",width:"55%"});this.brandedBy=$("input[name=brandedby]:checkbox",this.fieldset);this.brandedBy.change($.proxy(function(){this.theme.combobox(this.brandedBy.is(":checked")?"enable":"disable");},this));this.theme=$("select[name=theme]",this.fieldset);this.theme.combobox({editable:false,limitToList:true,disabled:true,loader:$.proxy(this._onLoad$Themes,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(function(data){if(data.length==0){this.brandedBy.prop("disabled",true).prop("checked",false).change();}},this),width:"40%",panelHeight:"auto",panelMinHeight:50}).combobox("autocomplete",true);this.createPath=$("input[name=createpath]:checkbox",this.fieldset);this.overwrite=$("input[name=overwritefile]:checkbox",this.fieldset);this.uri=$("span[aria-label=zoneuri]",this.fieldset);this.copyLinkButton=$("a[role=button][name=copylink]",this.fieldset).linkbutton({disabled:true,onClick:$.proxy(this._onClick$CopyLinkButton,this)}).hide();initializing=false;},show:function(listener){this._super(listener);this.user.combobox("reload");this.theme.combobox("reload");this._adjustPasswordOptions();},getPath:function(){return this.path.textbox("getValue");},setPath:function(value){this.path.textbox("setValue",value);},getUser:function(){return this.user.combobox("getValue");},setUser:function(value){this.user.combobox("setValue",value);},getPassword:function(){return this.password.passwordbox2("getValue");},getWebTheme:function(){return this.brandedBy.is(":checked:not(:disabled)")?this.theme.combobox("getValue"):null;},setWebTheme:function(value){this.brandedBy.prop("checked",value!=null).change();if(value!=null){this.theme.combobox("setValue",value);}},getCreatePathIfNotExists:function(){return this.createPath.is(":checked");},setCreatePathIfNotExists:function(value){this.createPath.prop("checked",!!value);},getOverwriteFileIfExists:function(){return this.overwrite.is(":checked");},setOverwriteFileIfExists:function(value){this.overwrite.prop("checked",!!value);},setUri:function(value){value=value||"";this.uri.text(value);if(!!value){this.copyLinkButton.linkbutton("enable").show();}else{this.copyLinkButton.linkbutton("disable").hide();}},_onLoad$Users:function(params,success,error){this.listener.onLoadUsers(params).done(success).fail(error);},_onLoad$Themes:function(params,success,error){this.listener.onLoadWebThemes(params).done(success).fail(error);},_onClick$CopyLinkButton:function(){this.listener.onCopyLink(this.uri);},_adjustPasswordOptions:function(){var opts=this.password.passwordbox2("textbox").validatebox("options");opts.required=!this.password.passwordbox2("isSatisfied");}});jscape.account.DropZoneDialog.LISTENER={onCopyLink:$.noop,onLoadUsers:$.noop,onLoadWebThemes:$.noop};jscape.account.AddDropZoneDialog=jscape.account.DropZoneDialog.extend({initialize:function(){this._super($("#d-dropzone-add"));this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["dropzone_name","dropzone_unique"],missingMessage:window.R.string.DROP_ZONE_ERROR_BAD_NAME,width:"60%"});},getName:function(){return this.name.textbox("getValue");},show:function(listener){this._super(listener||jscape.account.AddDropZoneDialog.LISTENER);}});jscape.account.AddDropZoneDialog.LISTENER=$.extend({onChangeName:$.noop},jscape.account.DropZoneDialog.LISTENER);jscape.account.EditDropZoneDialog=jscape.account.DropZoneDialog.extend({initialize:function(){this._super($("#d-dropzone-edit"));this.title=this.dialog.dialog("header").text()||"";},setName:function(value){this.dialog.dialog("setTitle",this.title.supplant({0:(value+"").escapeXml()}));}});jscape.account.DeleteDropZoneController=Class.extend({deferred:null,start:function(zones){this.deferred=$.Deferred();this._confirmDelete(zones).done($.proxy(this._deleteConfirmed,this,zones)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(zones){var text=$.map(zones,function(zone){return zone.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.DROP_ZONE_CONFIRM_DELETE_TITLE,window.R.string.DROP_ZONE_CONFIRM_DELETE_MESSAGE.supplant({0:text.escapeXml()}),false);},_deleteConfirmed:function(zones){$.when.apply(jQuery,$.map(zones,$.proxy(function(zone){return jscape.API.deleteDropZone(zone.name);},this))).done($.proxy(function(){this.deferred.resolve(zones);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});