/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.account=jscape.account||{};jscape.account.ChangePasswordController=Class.extend({deferred:null,initialize:function(pra){this.pra=!!pra;},start:function(username,current){this.username=username;this.deferred=$.Deferred();this._setupDialog(current).show(this);return this.deferred.promise();},onSubmit:function(dialog){return jscape.API.changeUserPassword(this.username,dialog.getCurrentPassword(),dialog.getPassword(),this.pra&&dialog.isResetRequired()).done($.proxy(function(){dialog.destroy();this.deferred.resolve();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(current){var dialog=new jscape.account.ChangePasswordDialog(this.pra,current);dialog.setUsername(this.username);return dialog;}});jscape.account.ChangePasswordDialog=jscape.ui.DefaultDialog.extend({initialize:function(pra,current){this._super($("#d-user-changepwd"),{width:"50%",minWidth:450,maxWidth:700});this.fieldset=$("fieldset[name=userpasswordfields]",this.dialog);if(!current){$("input[name=oldpassword]",this.fieldset).parent().remove();}else{this.oldPassword=$("input[name=oldpassword]",this.fieldset).passwordbox2({width:"70%"});}
var id="pwd_"+(1E9*Math.random()>>>0);this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({validType:"pi_password_confirm",validParams:["#"+id],missingMessage:window.R.string.USER_ERROR_CONFIRM_PWD,tipPosition:"bottom",width:"70%"});this.newPassword=$("input[name=newpassword]",this.fieldset).attr("id",id).passwordbox2({validType:"pi_password_compliance",validateOnCreate:false,validateOnBlur:true,delay:5000,interval:5000,inputEvents:{input:$.proxy(function(cpb,e){var t=$(e.data.target).passwordbox2("getText");cpb.passwordbox2("textbox").validatebox("options").required=t.length!=0;(!t||!t.length)&&cpb.passwordbox2("isValid");},this,this.confirmPassword)},onBeforeValidate:$.proxy(function(){this.newPassword&&this.confirmPassword.passwordbox2("isValid");},this),tipPosition:"bottom",width:"70%"});this.resetRequired=$("input[name=resetrequired]",this.fieldset);!pra&&this.resetRequired.parent().remove();},getCurrentPassword:function(){return this.oldPassword&&this.oldPassword.length?this.oldPassword.passwordbox2("getValue"):null;},getPassword:function(){return this.newPassword.passwordbox2("getValue");},setUsername:function(value){var opts=this.newPassword.passwordbox2("textbox").validatebox("options");opts.validParams=!!value?[String(value).escapeXml()]:[];opts.required=!this.newPassword.passwordbox2("isSatisfied");},isResetRequired:function(){return this.resetRequired.is(":visible")&&this.resetRequired.is(":checked");}});