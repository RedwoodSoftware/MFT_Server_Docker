/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.account=jscape.account||{};jscape.PersonalInfoData=Class.extend({initialize:function(name,username,email,company,phone,theme,customTheme){this.name=name;this.username=username;this.email=email;this.company=company||null;this.phone=phone;this.theme=theme||null;this.customTheme=customTheme||null;}});jscape.PersonalInfoData.fromJSON=function(data){return data?new jscape.PersonalInfoData(data.name,data.username,data.email,data.company,jscape.Phone.fromJSON(data.phone),data.theme,data.customTheme):null;};jscape.account.PersonalInfoModule=jscape.ApplicationModule.extend({initialize:function(themeLoader){this.themeLoader=themeLoader;},onCreate:function(themeUriPattern){this._super.apply(this,arguments);this.controller=new jscape.account.PersonalInfoController(this.themeLoader);},onStart:function(){this.controller.start();},onResume:function(){this.controller.onResume();}});jscape.account.PersonalInfoController=Class.extend({initialize:function(themeLoader){this.themeLoader=themeLoader;this.username=null;this.data=null;this.view=new jscape.account.PersonalInfoView();this._initValidators();},start:function(){this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(){return jscape.API.getPersonalInfo().done($.proxy(function(data){this.data=data||{};this.username=this.data.username;this._setupView(data);},this));},hasChanged:function(){return this.data!=null&&!Object._equals(this.data,this._createData(this.view));},onChange:function(){return $.Deferred().resolve(this.hasChanged()).promise();},onChangePassword:function(){var promise=this.username?$.Deferred().resolve(this.username).promise():jscape.API.getPersonalInfo(true).then(function(data){return data?data.username:null;});return promise.then(function(user){return new jscape.account.ChangePasswordController().start(user,true);}).then($.proxy(this._showPasswordChangedMessage,this)).done($.proxy(function(){this.view.refresh();},this));},onApply:function(){return jscape.API.setPersonalInfo(this._createData(this.view)).done($.proxy(this._fireApplySuccess,this,window.R.string.USER_SUCCESS_UPDATED)).done($.proxy(function(data){this.data=data;this._setupView(data);},this));},onDiscard:function(){return this.onRefresh();},onChangeTheme:function(){var c=new jscape.themes.WebThemeConfigurationController(this.themeLoader,$("#user-themes"),true);return c.start(this.view.getTheme(),this.view.getCustomTheme()).done($.proxy(function(theme,customData){this.view.setTheme(theme);this.view.setCustomTheme(customData);},this));},_createData:function(view){return new jscape.PersonalInfoData(view.getName(),this.username,view.getEmail(),view.getCompany(),view.getPhone(),view.getTheme(),view.getCustomTheme());},_setupView:function(data){if(data){this.view.setName(data.name);this.view.setUsername(data.username);this.view.setEmail(data.email);this.view.setCompany(data.company);this.view.setPhone(data.phone);this.view.setTheme(data.theme);this.view.setCustomTheme(data.customTheme);}},_initValidators:function(){var v=new jscape.Validator();v.rule("pi_password_compliance",$.proxy(this._passwordCompliant,this),"");v.rule("pi_password_confirm",$.proxy(this._passwordConfirmed,this),window.R.string.USER_ERROR_CONFIRM_PWD);},_passwordCompliant:function(value,params){var accountName=params&&params.length?params[0]:null;var result=jscape.API.testPasswordCompliance(accountName,value);if($.isPlainObject(result)){if(result.valid===false&&result.message){new jscape.Validator().ruleMessage("pi_password_compliance",result.message);}
return!!result.valid;}
return true;},_passwordConfirmed:function(value,params){if(params&&params.length){var t=$(params[0]);if(t.length){var val=$.data(t[0],"passwordbox")?t.passwordbox("getValue"):t.val();return value==val;}}
return false;},_showPasswordChangedMessage:function(){var deferred=$.Deferred();var dialog=$.messager.alert(window.R.string.USER_CHANGE_PASSWORD_TITLE,window.R.string.USER_CHANGE_PASSWORD_MESSAGE,"info",function(){timer&&clearTimeout(timer);timer=null;dialog=null;deferred.resolve();deferred=null;});var timer=setTimeout(function(){timer=null;dialog&&dialog.dialog("destroy");deferred.resolve();deferred=null;},60000);return deferred.promise();},_fireApplySuccess:function(message){$(document).triggerHandler("broadcast",[message]);}});jscape.account.PersonalInfoView=Class.extend({colors:null,initialize:function(){this.layout=$("#account-personal-info-fields").layout({fit:true,doSize:false,border:false});this.form=this.layout.find("form").first().form({onChange:$.proxy(this._onChange$Form,this)});this.name=$("input[name=name]",this.form).textbox({width:"50%"});this.login=$("input[name=login]",this.form).textbox({disabled:true,readonly:true,width:"40%"});this.email=$("input[name=email]",this.form).textbox({validType:{any:["variable","multi_value['email',',']"]},invalidMessage:window.R.string.USER_ERROR_BAD_EMAIL,width:"40%"});this.company=$("input[name=company]",this.form).textbox({width:"40%"});this.phoneCode=$("input[name=phonecode]",this.form).textbox({validType:"pattern['^[\\\\d]+$']",invalidMessage:window.R.string.USER_ERROR_BAD_PHONE,width:60});this.phoneNumber=$("input[name=phonenum]",this.form).textbox({validType:"pattern['^[\\\\d- ]+$']",invalidMessage:window.R.string.USER_ERROR_BAD_PHONE,width:160});this.phoneExtension=$("input[name=phoneext]",this.form).textbox({width:70,validType:"pattern['^[\\\\d- ]+$']",invalidMessage:window.R.string.USER_ERROR_BAD_PHONE});this.enableTheme=$("input[name=usetheme]:checkbox",this.form).change($.proxy(this._onChange$EnableTheme,this));this.theme=$("input[name=theme]",this.form).textbox({required:false,editable:false,readonly:true,width:"15%",minWidth:200});this.theme.textbox("textbox").click($.proxy(function(){this.changeThemeButton.click();},this));this.changeThemeButton=$("a[role=button][name=changetheme]",this.form).linkbutton({onClick:$.proxy(this._onClick$ChangeThemeButton,this)});this.changePasswordButton=$("a[role=button][name=changepwd]",this.form).linkbutton({onClick:$.proxy(this._onClick$ChangePasswordButton,this)});var tip=this.changePasswordButton.closest(".easyui-tooltip");if(tip&&tip.length&&this.changePasswordButton.linkbutton("options").disabled){tip.tooltip({showDelay:0,onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");}});}
this.applyButton=$("a[role=button][name=apply]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyButton,this)});this.discardButton=$("a[role=button][name=discard]",this.layout).linkbutton({onClick:$.proxy(this._onClick$DiscardButton,this)});},show:function(listener){this.listener=listener||jscape.account.PersonalInfoView.LISTENER;this.layout.layout("resize");},refresh:function(){this.listener.onRefresh();},valid:function(){return this.form.form("validate");},getName:function(){return this.name.textbox("getValue");},setName:function(value){this.name.textbox("setValue",value);},setUsername:function(value){this.login.textbox("setValue",value);},getEmail:function(){return this.email.textbox("getValue");},setEmail:function(value){this.email.textbox("setValue",value);},getCompany:function(){return this.company.textbox("getValue");},setCompany:function(value){this.company.textbox("setValue",value);},getPhone:function(){return this.phoneCode.textbox("isValid")&&this.phoneNumber.textbox("isValid")?new jscape.Phone(this.phoneCode.textbox("getValue"),this.phoneNumber.textbox("getValue"),this.phoneExtension.textbox("getValue")):null;},setPhone:function(phone){this.phoneCode.textbox("setValue",phone?phone.code:"");this.phoneNumber.textbox("setValue",phone?phone.number:"");this.phoneExtension.textbox("setValue",phone?phone.extension:"");},getTheme:function(){var theme=this.theme.textbox("getValue");return this.enableTheme.is(":checked")?this.customData?this.customData.name||theme:theme:null;},setTheme:function(value){this.enableTheme.prop("checked",!!value).change();if(value&&typeof value=="object"&&value.hasOwnProperty("name")){value.name&&this.theme.textbox("setText",value.name+" (custom)");}else{this.theme.textbox("setValue",value);}},getCustomTheme:function(){return this.enableTheme.is(":checked")?this.customData:null;},setCustomTheme:function(value){this.customData=value;value&&this.setTheme(value);},_onChange$Form:function(){this.listener.onChange(this).done($.proxy(function(modified){this.applyButton.linkbutton(modified?"enable":"disable");},this));},_onClick$ChangePasswordButton:function(){this.changePasswordButton.linkbutton("disable");this.listener.onChangePassword().always($.proxy(function(){this.changePasswordButton.linkbutton("enable");},this));},_onClick$ApplyButton:function(){if(this.valid()){this.applyButton.linkbutton("disable");this.listener.onApply().catch($.proxy(function(){this.applyButton.linkbutton("enable");},this));}},_onClick$DiscardButton:function(){this.discardButton.linkbutton("disable");this.listener.onDiscard().always($.proxy(function(){this.discardButton.linkbutton("enable");},this));},_onChange$EnableTheme:function(){var enabled=this.enableTheme.is(":checked");this.theme.textbox(enabled?"enable":"disable");this.changeThemeButton.linkbutton(enabled?"enable":"disable");},_onClick$ChangeThemeButton:function(){this.changeThemeButton.linkbutton("disable");this.listener.onChangeTheme(this).always($.proxy(function(){this.changeThemeButton.linkbutton("enable");},this));}});jscape.account.PersonalInfoView.LISTENER={onChangePassword:$.noop,onCustomTheme:$.noop,onChange:$.noop,onRefresh:$.noop,onApply:$.noop,onDiscard:$.noop};jscape.account.WebThemeInlineLoader=Class.extend({id:null,initialize:function(pattern,current){this.pattern=decodeURI(pattern||"");var path=decodeURI(this._themeUriFor(current));var link=$(document).find("head").children("link[rel=stylesheet]").filter(function(_,el){return decodeURI(el.href).endsWith(path);});link.attr("id","_"+(1E9*Math.random()>>>0));this.id=link.attr("id");},start:function(themeName){return this._updateTheme($("#"+this.id),this._themeUriFor(themeName));},_updateTheme:function(tag,uri){var deferred=$.Deferred();if(tag&&tag.length==1&&uri){try{var t=tag[0];if(t.href!==uri){t.href=uri;}
return deferred.resolve(uri);}catch(ignored){}}
return deferred.reject();},_themeUriFor:function(name){return name?encodeURI(this.pattern.supplant({name:name})):"";}});jscape.themes=jscape.themes||{};jscape.themes.WebThemeConfigurationController=Class.extend({initialize:function(themeLoader,container,customRequired){this.loader=themeLoader;this.container=container;this.customRequired=!!customRequired;},start:function(theme,customData){this.deferred=$.Deferred();this._setupView(theme,customData).show(this);return this.deferred.promise();},onChangeTheme:function(view){var theme=view.getTheme();return this.loader.start(theme).catch(function(){return theme;});},onChangeCustom:function(view){var theme=view.getCustomColors();return this.loader.start(theme.name||view.getTheme()).done($.proxy(this._updateCustomProperties,this,theme)).fail($.proxy(function(){this.loader.reset();},this));},onComplete:function(view,theme,customColors){view.destroy();this.loader.reset();this.deferred.resolve(theme,customColors);this.deferred=null;},_updateCustomProperties:function(data){},_setupView:function(theme,customData){var view=new jscape.themes.WebThemeConfigurationView(this.container,this.customRequired);if(!!customData){view.setCustomColors(customData);}else{view.setTheme(theme);}
return view;}});jscape.themes.WebThemeConfigurationView=Class.extend({colors:null,initialize:function(container,customColorsRequired){this.colors={};var content=$(container).find(".themes-list").clone();this.dialog=$("<div></div>").appendTo("body");this.dialog.append(content);content.show();this.dialog.drawer({collapsed:true,modal:true,onExpand:$.proxy(this._onExpand$Themes,this),onCollapse:$.proxy(this._onCollapse$Themes,this),width:"40%"});this.themeButtons=this.dialog.find("input[name=themepreview]:radio").change($.proxy(this._onChange$Theme,this));if(!!customColorsRequired){var re=/^theme-(.+)-colors$/;this.dialog.find("input[type=hidden]").filter("[name^=theme-],[name$=-colors]").each($.proxy(function(_,i){var name=i.name.replace(re,"$1");this.colors[name]=String(i.value||"").split(",");},this)).remove();this.customColorBoxes=this.dialog.find(".theme-color-picker").map(function(_,t){var input=$(t).children(":input");var label=input.attr("aria-label");input.colorbox({label:label||undefined,labelPosition:"top",onChange:$.proxy(this._onChange$CustomTheme,this)}).colorbox("label").attr("title",label);return input;});}else{this.dialog.find("fieldset[name=custom-theme-fields]").hide();}
this.applyCustomButton=$("a[role=button][name=applycustom]",this.dialog).linkbutton({disabled:true,onClick:$.proxy(this._onClick$ApplyCustomButton,this)});},show:function(listener){this.listener=listener||jscape.themes.WebThemeConfigurationView.LISTENER;this.applyCustom=false;this.dialog.drawer("expand");this._adjustState();},hide:function(){if(!this.dialog.drawer("options").collapsed){this.dialog.drawer("collapse");}},destroy:function(){this.dialog.drawer("destroy");},getTheme:function(){return this.themeButtons.filter(":checked").val();},setTheme:function(value){this.themeButtons.filter("[value='"+value+"']").prop("checked",true).change();},getCustomColors:function(){if(this.customColorBoxes){var colors={name:this.getTheme()};for(var i=0,len=this.customColorBoxes.length;i<len;++i){var cb=this.customColorBoxes[i];var name=cb.parent().find("input.textbox-value").attr("name");colors[name]=cb.colorbox("getValue")||undefined;}
return colors;}
return null;},setCustomColors:function(value){if(!!value&&typeof value==="object"&&this.customColorBoxes){var colors=$.map(this.customColorBoxes,function(t){var name=$(t).parent().find("input.textbox-value").attr("name");return name&&value.hasOwnProperty(name)?value[name]||"":"";});var theme=value.name;!!theme&&this.themeButtons.each(function(){if(this.value===theme){$(this).prop("checked",true);return false;}});this.colors[theme]=colors;this._adjustCustomColors(theme);this.customTheme=theme;}},_onChange$Theme:function(){var theme=this.themeButtons.filter(":checked").val();if(theme){this.changingTheme=true;this._adjustCustomColors(theme);this.changingTheme=false;this.listener&&this.listener.onChangeTheme(this);}
this._adjustState();},_onChange$CustomTheme:function(){if(!this.changingTheme){this.listener.onChangeCustom(this);}},_onExpand$Themes:function(){this.dialog.data("window").mask.css("opacity",0);this.themeButtons.filter(":checked").change();},_onCollapse$Themes:function(){if(this.applyCustom==true){this.applyCustom=false;this.listener.onComplete(this,null,this.getCustomColors());}else{var theme=this.getTheme();var colors=this.customTheme===theme?this.getCustomColors():null;this.listener.onComplete(this,theme,colors);}},_onClick$ApplyCustomButton:function(){if(!this.getTheme()||!this.customColorBoxes){return;}
this.applyCustom=true;this.applyCustomButton.linkbutton("disable");this.dialog.drawer("collapse");},_adjustState:function(){var enabled=!!this.themeButtons.filter(":checked").val();this.applyCustomButton.linkbutton(enabled?"enable":"disable");if(this.customColorBoxes){this.customColorBoxes.each(function(){$(this).colorbox(enabled?"enable":"disable");})}},_adjustCustomColors:function(theme){var colors=this._themeColorsFor(theme);if(!!colors&&this.customColorBoxes&&this.customColorBoxes.length){for(var i=0;i<colors.length;++i){var cb=this.customColorBoxes.get(i);cb&&cb.colorbox("setValue",colors[i]);}}},_themeColorsFor:function(themeName){return this.colors.hasOwnProperty(themeName)?this.colors[themeName]:null;}});jscape.themes.WebThemeConfigurationView.LISTENER={onChangeTheme:$.noop,onChangeCustom:$.noop,onComplete:$.noop};jscape.themes.WebThemeLoader=Class.extend({id:null,initialize:function(pattern,current){this.pattern=decodeURI(pattern||"");this.initialValue=current;var path=decodeURI(this._themeUriFor(current));var link=$(document).find("head").children("link[rel=stylesheet]").filter(function(_,el){return decodeURI(el.href).endsWith(path);});link.attr("id","_"+this._getId());this.id=link.attr("id");},start:function(themeName){return this._updateTheme(this._themeUriFor(themeName));},reset:function(){!!this.initialValue&&this._updateTheme(this._themeUriFor(this.initialValue));},_getId:function(){var id=jscape.themes.WebThemeLoader.__id;return id?id:(jscape.themes.WebThemeLoader.__id=(1E9*Math.random()>>>0));},_updateTheme:function(uri){var deferred=$.Deferred();var tag=$("#"+this.id);if(tag&&tag.length==1&&uri){try{var t=tag[0];if(t.href!==uri){t.href=uri;}
return deferred.resolve(uri);}catch(ignored){}}
return deferred.reject();},_themeUriFor:function(name){return name?encodeURI(this.pattern.supplant({name:name})):"";}});