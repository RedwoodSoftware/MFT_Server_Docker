/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.account=jscape.account||{};jscape.account.PublicKeyAuthenticationModule=jscape.ApplicationModule.extend({onCreate:function(){this.controller=new jscape.account.PublicKeyAuthenticationController();},onStart:function(){this.controller.start();},onResume:function(){this.controller.onResume();}});jscape.account.PublicKeyAuthenticationController=Class.extend({initialize:function(){this.view=new jscape.account.PublicKeyAuthenticationView();this.generateController=new jscape.account.GenerateKeyPairController();this.importController=new jscape.account.ImportPublicKeyController();this.deleteController=new jscape.account.DeletePublicKeyController();this._initValidators();},start:function(){this.view.show(this);},onResume:function(){},onGenerateKey:function(){this.generateController.start().done($.proxy(this._fireApplySuccess,this,window.R.string.PUBLIC_KEY_SUCCESS_CREATED));},onImportKey:function(){this.importController.start().done($.proxy(this._fireApplySuccess,this,window.R.string.PUBLIC_KEY_SUCCESS_IMPORTED));},onDeleteKey:function(){this.deleteController.start().done($.proxy(this._fireApplySuccess,this,window.R.string.PUBLIC_KEY_SUCCESS_DELETED));},_initValidators:function(){var v=new jscape.Validator();v.rule("file_password_confirm",$.proxy(this._passwordConfirmed,this),window.R.string.PUBLIC_KEY_BAD_CONFIRM_PWD);},_passwordConfirmed:function(value,params){return params&&params.length&&$(params[0]).val()==value;},_fireApplySuccess:function(message){$(document).triggerHandler("broadcast",[message]);}});jscape.account.PublicKeyAuthenticationView=Class.extend({initialize:function(){this.layout=$("#account-public-key-auth-fields").layout({fit:true,doSize:false,border:false});this.generateButton=$("a[role=button][name=generate]",this.layout).linkbutton({onClick:$.proxy(this._onClick$GenerateButton,this)});this.importButton=$("a[role=button][name=import]",this.layout).linkbutton({onClick:$.proxy(this._onClick$ImportButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.layout).linkbutton({onClick:$.proxy(this._onClick$DeleteButton,this)});},show:function(listener){this.listener=listener||jscape.account.PublicKeyAuthenticationView.LISTENER;this.layout.layout("resize");this._adjustState();},_onClick$GenerateButton:function(){this.listener.onGenerateKey();},_onClick$ImportButton:function(){this.listener.onImportKey();},_onClick$DeleteButton:function(){this.listener.onDeleteKey();},_adjustState:function(){}});jscape.account.PublicKeyAuthenticationView.LISTENER={onGenerateKey:$.noop,onImportKey:$.noop,onDeleteKey:$.noop};jscape.account.GenerateKeyPairController=Class.extend({DEFAULTS:{fileType:"PEM",keyType:"RSA",keyLength:2048},deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){jscape.API.generateKeyPair(dialog.getKeyType(),dialog.getKeyLength(),dialog.getKeyCurve(),dialog.getFileType(),dialog.getFilePassword()).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this)).always(function(){dialog.destroy();});},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.account.GenerateKeyPairDialog();dialog.setFileType(this.DEFAULTS.fileType);dialog.setKeyType(this.DEFAULTS.keyType);dialog.setKeyLength(this.DEFAULTS.keyLength);return dialog;}});jscape.account.GenerateKeyPairDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkeyauth-generate"),{width:"50%",height:"auto"});this.fieldset=$("fieldset[name=keypairfields]",this.dialog);this.keyType=$("select[name=type]",this.fieldset).combobox({required:true,editable:false,onChange:$.proxy(this._onChange$KeyType,this),width:"30%",panelHeight:"auto",panelMaxHeight:"40%"});this.keyLength=$("select[name=length]",this.fieldset).combobox({required:true,editable:false,disabled:true,limitToList:true,autoSelectFirst:false,loadFilter:function(data){return $.map(data,function(entry){return $.extend(entry,{value:parseInt(entry.value)});});},width:"30%",panelHeight:"auto",panelMaxHeight:"40%"});this.keyCurve=$("select[name=keycurve]",this.fieldset).combobox({required:true,editable:true,disabled:true,limitToList:true,width:"30%",panelHeight:"auto",panelMaxHeight:"50%"});this.fileType=$("input[name=filetype]:radio",this.fieldset);var id=$.now().toString(36);this.password=$("input[name=password]",this.fieldset).attr("id",id).passwordbox({lastDelay:0,validateOnBlur:true,width:"50%"});this.password.passwordbox("textbox").on("input",$.proxy(function(){this.confirmPassword.passwordbox("textbox").validatebox("options").required=this.password.textbox("textbox").val().length!=0;this.confirmPassword.passwordbox("validate");},this));this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox({lastDelay:0,validateOnBlur:true,validType:"file_password_confirm['#"+id+"']",missingMessage:window.R.string.PUBLIC_KEY_BAD_CONFIRM_PWD,width:"50%"});},getKeyType:function(){return this.keyType.combobox("getValue");},setKeyType:function(value){this.keyType.combobox("select",value);},getKeyLength:function(){return parseInt(this.keyLength.combobox("getValue"));},setKeyLength:function(value){this.keyLength.combobox("select",value);},getKeyCurve:function(){return this.keyCurve.combobox("getValue");},getFileType:function(){return this.fileType.filter(":checked").val();},setFileType:function(value){this.fileType.filter("[value="+value+"]").prop("checked",true).change();},getFilePassword:function(){return this.password.passwordbox("getValue");},show:function(listener){this._super(listener);this._onChange$KeyType();this.dialog.dialog("resize",{height:"auto"}).dialog("center");},_onChange$KeyType:function(){var keyCurves=jscape.KeyPairAlgorithm.curvesOf(this.getKeyType());var keyLengths=jscape.KeyPairAlgorithm.lengthsOf(this.getKeyType());if(keyCurves&&keyCurves.length){this.keyCurve.combobox("enable").combobox("reset").combobox("loadData",keyCurves).closest("div").show();this.keyLength.combobox("disable").closest("div").hide();}else if(keyLengths&&keyLengths.length){var keyLength=this.keyLength.combobox("getValue");this.keyCurve.combobox("disable").closest("div").hide();this.keyLength.combobox("enable").combobox("reset").combobox("loadData",$.map(keyLengths,function(entry){return{text:String(entry),value:entry};})).combobox("select",parseInt(keyLength)).closest("div").show();}else{this.keyCurve.combobox("disable").closest("div").hide();this.keyLength.combobox("disable").closest("div").hide();}}});jscape.account.ImportPublicKeyController=Class.extend({DEFAULT_FILE_TYPE:"SSH",deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){jscape.API.importPublicKey(dialog.getFile(),dialog.getFileType()).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this)).always(function(){dialog.destroy();});},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(){var dialog=new jscape.account.ImportPublicKeyDialog();dialog.setFileType(this.DEFAULT_FILE_TYPE);return dialog;}});jscape.account.ImportPublicKeyDialog=jscape.ui.DefaultDialog.extend({initialize:function(){this._super($("#d-pubkeyauth-import"),{width:"50%",minWidth:500,maxWidth:750});this.fieldset=$("fieldset[name=publickeyfields]",this.dialog);this.file=$("input[name=file]",this.fieldset).filebox({required:true,width:"60%"});this.type=$("input[name=filetype]:radio",this.fieldset);},getFile:function(){var files=this.file.filebox("files");return files&&files.length?files[0]:null;},getFileType:function(){return this.type.filter(":checked").val();},setFileType:function(value){this.type.filter("[value="+value+"]").prop("checked",true).change();},show:function(listener){this._super(listener);this.file.filebox("textbox").focus();}});jscape.account.DeletePublicKeyController=Class.extend({deferred:null,start:function(){return this._confirmDelete().then($.proxy(this._deleteConfirmed,this));},_confirmDelete:function(){return jscape.ConfirmDialog.confirm(window.R.string.PUBLIC_KEY_CONFIRM_DELETE_TITLE,window.R.string.PUBLIC_KEY_CONFIRM_DELETE_MESSAGE);},_deleteConfirmed:function(){return jscape.API.deletePublicKey();}});