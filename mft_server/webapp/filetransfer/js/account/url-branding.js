/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.account=jscape.account||{};jscape.WebThemeInfo=Class.extend({initialize:function(a,b,c){this.name=a||"";this.owner=b||"";this.uri=c||"";}});jscape.WebThemeInfo.fromJSON=function(data){return data?new jscape.WebThemeInfo(data.name,data.owner,data.uri):null;};jscape.WebThemeData=Class.extend({initialize:function(name,logo,owner,uri){this.name=name;this.encodedLogo=logo;this.owner=owner;this.uri=uri;}});jscape.WebThemeData.fromJSON=function(data){return data?new jscape.WebThemeData(data.name,data.encodedLogo,data.owner,data.uri):null;};jscape.account.UrlBrandingController=jscape.ui.DatagridController.extend({initialize:function(){this.view=new jscape.account.UrlBrandingView();this.addController=new jscape.account.AddUrlBrandingController();this.editController=new jscape.account.EditUrlBrandingController();this.deleteController=new jscape.account.DeleteUrlBrandingController();this._initValidators();},start:function(){this.view.show(this);},onResume:function(){this.view.refresh();},onRefresh:function(params){params=jscape.Page.requestParameters(params);return jscape.API.listWebThemes(params.startIndex,params.count,params.query).then(jscape.Page.datagridFormatter());},onAddTheme:function(){this.addController.start().done($.proxy(this._themeAdded,this));},onEditTheme:function(theme){this.editController.start(theme).done($.proxy(this._themeEdited,this));},onDeleteTheme:function(theme){this.deleteController.start(theme).done($.proxy(this._themeDeleted,this,theme));},_themeAdded:function(theme){this._recordAdded(theme);},_themeEdited:function(theme){this._recordEdited(theme);},_themeDeleted:function(themes){this._recordDeleted(themes);},_initValidators:function(){var v=new jscape.Validator();v.rule("webtheme_name",$.proxy(this._themeNameValid,this),window.R.string.WEB_THEME_ERROR_BAD_NAME);v.rule("webtheme_unique",$.proxy(this._themeNotExists,this),window.R.string.WEB_THEME_ERROR_ALREADY_EXIST);v.rule("webtheme_logo",$.proxy(this._logoLoaded,this),window.R.string.WEB_THEME_ERROR_LOAD_LOGO);},_themeNameValid:function(name){return name!=null&&/^[a-zA-Z0-9]+$/i.test(name);},_themeNotExists:function(name){var names=$.map(this.view.getWebThemes(),function(theme){return theme.name;});return $.inArray(name,names)==-1;},_logoLoaded:function(_,params){return $(params[0]).data("error")==null;}});jscape.account.UrlBrandingView=jscape.ui.DatagridView.extend({selection:null,initialize:function(){var initializing=true;this.layout=$("#account-url-branding-fields").layout({fit:true,doSize:false,border:false});this.data=$("table[role=grid][aria-label=urlbranding]",this.layout);this.data.datagrid({fit:true,fitColumns:true,ctrlSelect:true,pagination:true,search:true,remoteSearch:true,remoteSort:true,sortName:"name",idField:"name",columns:[[{field:"name",title:$("thead th:nth-child(1)",this.data).text(),sortable:true,width:90},{field:"uri",title:$("thead th:nth-child(2)",this.data).text(),searchable:false,width:110},{field:"owner",title:$("thead th:nth-child(3)",this.data).text(),sortable:true,width:90}]],onSelect:$.proxy(this._adjustState,this),onUnselect:$.proxy(this._adjustState,this),onUnselectAll:$.proxy(this._adjustState,this),onDblClickRow:$.proxy(this._onClick$EditButton,this),onRowContextMenu:$.proxy(this._onRow$ContextMenu,this),loader:$.proxy(this._onLoad$Data,this),onBeforeLoad:function(){return!initializing;},onLoadSuccess:$.proxy(this._adjustState,this)});this.addButton=$("a[role=button][name=add]",this.layout).linkbutton({onClick:$.proxy(this._onClick$AddButton,this)});this.editButton=$("a[role=button][name=edit]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$EditButton,this)});this.deleteButton=$("a[role=button][name=delete]",this.layout).linkbutton({disabled:true,onClick:$.proxy(this._onClick$DeleteButton,this)});initializing=false;},getWebThemes:function(){return this.getRecords();},show:function(listener){this.listener=listener||jscape.account.UrlBrandingView.LISTENER;this.layout.layout("resize");this._adjustState();},_onLoad$Data:function(params,success,error){this.listener.onRefresh(params).done(success).fail(error);},_onClick$AddButton:function(){this.listener.onAddTheme();},_onClick$EditButton:function(){this.listener.onEditTheme(this.selection[0]);},_onClick$DeleteButton:function(){this.listener.onDeleteTheme(this.selection);},_showContextMenu:function(e){this._super(e,[this.addButton,this.editButton,this.deleteButton]);},_adjustState:function(){this.selection=this.data.datagrid("getSelections");this.editButton.linkbutton(this.selection.length==1?"enable":"disable");this.deleteButton.linkbutton(this.selection.length!=0?"enable":"disable");}});jscape.account.UrlBrandingView.LISTENER={onRefresh:$.noop,onAddTheme:$.noop,onEditTheme:$.noop,onDeleteTheme:$.noop};jscape.account.AddUrlBrandingController=Class.extend({deferred:null,start:function(){this.deferred=$.Deferred();this._setupDialog().show(this);return this.deferred.promise();},onSubmit:function(dialog){var data=this._createData(dialog);dialog.destroy();jscape.API.addWebTheme(data).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},webThemeUriFor:function(themeName){return themeName&&themeName.trim().length?jscape.API.webThemeUri(themeName):$.Deferred().resolve("").promise();},_createData:function(dialog){return new jscape.WebThemeData(dialog.getName(),dialog.getLogoData());},_setupDialog:function(){return new jscape.account.AddUrlBrandingDialog();}});jscape.account.EditUrlBrandingController=Class.extend({deferred:null,start:function(theme){this.themeName=theme.name;this.themeUri=theme.uri;this.deferred=$.Deferred();jscape.API.getWebTheme(theme.name).done($.proxy(function(data){this._setupDialog(data).show(this);},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},onSubmit:function(dialog){var theme=this._createData(dialog);dialog.destroy();jscape.API.updateWebTheme(this.themeName,theme).done($.proxy(function(info){this.deferred.resolve(info);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_createData:function(dialog){return new jscape.WebThemeData(this.themeName,dialog.getLogoData(),this.themeUri);},_setupDialog:function(theme){var dialog=new jscape.account.EditUrlBrandingDialog();if(theme){dialog.setName(theme.name);dialog.setLogoData(theme.encodedLogo);dialog.setUri(theme.uri||"");}
return dialog;}});jscape.account.UrlBrandingDialog=jscape.ui.DefaultDialog.extend({DATA_URL:{pattern:/data:image\/.*;base64,(.+)/,template:"data:{0};base64,{1}",placeholder:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"},logoData:"",initialize:function(dialog){this._super(dialog,{width:"60%",minWidth:670,height:"70%"});this.fieldset=$("fieldset[name=urlbrandingfields]",this.dialog);this.logo=$("div[aria-label=logopreview] img",this.fieldset).attr("id",this.idFor("_logo"));this.logoFile=$("input[name=logo]",this.fieldset).filebox({required:true,accept:"image/*",multiple:false,validType:"webtheme_logo['#"+this.logo.attr("id")+"']",missingMessage:window.R.string.WEB_THEME_ERROR_BAD_LOGO,onChange:$.proxy(this._onChange$Logo,this),width:"60%"});this.logo.on("load error",{target:this.logoFile},function(e){e.data.target.filebox("validate");});this.logo.parent().css({width:400,height:100,overflow:"auto",border:"1px solid #DEDEDE"});this.uri=$("span[aria-label=themeuri]",this.fieldset);},getName:function(){return this.themeName;},setName:function(value){this.themeName=value;},getLogoData:function(){var dataUrl=this.logo.attr("src");return dataUrl&&dataUrl!=this.DATA_URL.placeholder?dataUrl.replace(this.DATA_URL.pattern,"$1"):"";},setLogoData:function(data,type){data=data?data:this.DATA_URL.placeholder;this.logo[0].src=this.DATA_URL.pattern.test(data)?data:this.DATA_URL.template.supplant({0:type||"image/png",1:data||""});},setUri:function(value){this.uri.text(value||"");},_onChange$Logo:function(){var files=$.grep(this.logoFile.filebox("files"),function(file){return file&&file.type.match("image.*");});if(files.length&&window.FileReader){var type=files[0].type;var reader=new FileReader();reader.onload=$.proxy(function(e){this.setLogoData(e.target.result,type);reader.onload=reader.onerror=null;type=reader=null;},this);reader.onerror=$.proxy(function(){this.setLogoData("");reader.onload=reader.onerror=null;type=reader=null;},this);reader.readAsDataURL(files[0]);}else{this.setLogoData("");}}});jscape.account.AddUrlBrandingDialog=jscape.account.UrlBrandingDialog.extend({initialize:function(){this._super($("#d-urlbranding-add"));this.name=$("input[name=name]",this.fieldset).textbox({required:true,validType:["webtheme_name","webtheme_unique"],missingMessage:window.R.string.WEB_THEME_ERROR_BAD_NAME,onChange:$.proxy(this._adjustBrandingUri,this),width:"60%"});},getName:function(){return this.name.textbox("getValue");},_adjustBrandingUri:function(){if(this.name.textbox("isValid")){this.listener.webThemeUriFor(this.getName()).done($.proxy(function(value){this.setUri(value);},this)).fail($.proxy(function(){this.setUri("");},this));}else{this.setUri("");}}});jscape.account.EditUrlBrandingDialog=jscape.account.UrlBrandingDialog.extend({initialize:function(){this._super($("#d-urlbranding-edit"));this.title=this.dialog.dialog("header").text()||"";},setName:function(value){this._super(value);this.dialog.dialog("setTitle",this.title.supplant({0:(value+"").escapeXml()}));},setLogoData:function(data){if(data&&data.trim().length){this.logoFile.filebox("textbox").validatebox("options").required=false;}
this._super(data);}});jscape.account.DeleteUrlBrandingController=Class.extend({deferred:null,start:function(themes){this.deferred=$.Deferred();this._confirmDelete(themes).done($.proxy(this._deleteConfirmed,this,themes)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));return this.deferred.promise();},_confirmDelete:function(themes){var text=$.map(themes,function(theme){return theme.name;}).join(", ");return jscape.ConfirmDialog.confirm(window.R.string.WEB_THEME_CONFIRM_DELETE_TITLE,window.R.string.WEB_THEME_CONFIRM_DELETE_MESSAGE.supplant({0:text.escapeXml()}),false);},_deleteConfirmed:function(themes){$.when.apply(jQuery,$.map(themes,$.proxy(function(theme){return jscape.API.deleteWebTheme(theme.name);},this))).done($.proxy(function(){this.deferred.resolve(themes);this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));}});