/* Copyright Â© 2009-2024. Redwood Software Inc. All rights reserved. */
jscape.dashboard=jscape.dashboard||{};jscape.dashboard.DashboardApplication=jscape.Application.extend({onReady:function(){this._super();this.view.show();},onBroadcast:function(e,message,success,code){this._super.apply(this,arguments);code==="PWD_CHANGED"&&window.location.reload(true);},onSelectModule:function(id){if("user-logout"===id){jscape.API.logout();return true;}
return this._super.apply(this,arguments);},_launch:function(){var args=$.makeArray(arguments);var ref=this._super;(jscape.API.getUsername?jscape.API.getUsername().catch(function(){return null;}):$.Deferred().resolve().promise()).done($.proxy(function(username){args.unshift(username||null);ref.apply(this,args);ref=args=null;},this));},_createView:function(){this._super();this.view=new jscape.dashboard.DashboardView(this);}});jscape.dashboard.DashboardView=jscape.DashboardView.extend({initialize:function(listener){this._super($("#modules").hide(),listener);this.tabs=this.modules;this.tabs.tabs({fit:true,doSize:false,tabPosition:"left",onSelect:$.proxy(this._onSelect$Module,this)});this.tabs.find("div[role=tablist]").filter(function(){return $(this).parents("div.dialog").length==0;}).each($.proxy(function(_,tabs){$(tabs).tabs({fit:true,border:false,onSelect:$.proxy(this._onSelect$Module,this)});},this));this.tabs.find(">div.tabs-header.tabs-header-left").find("div.tabs-wrap").hover(function(){$(this).css({overflowY:"auto",overflowX:"hidden"});},function(){$(this).css({overflowY:"",overflowX:""});});},show:function(){this._super.apply(this,arguments);this.tabs.show().tabs("resize");}});jscape.dashboard.DashboardView.LISTENER={};jscape.dashboard.PasswordComplianceModule=jscape.ApplicationModule.extend({passwordChanged:false,onCreate:function(username){this.username=username||"";this.view=new jscape.dashboard.PasswordComplianceView();},onStart:function(){if(!this.passwordChanged){this.view.show(this);}},onStop:function(){if(this.view){this.view.destroy();this.view=null;}},onChangePassword:function(dialog){dialog.destroy();var controller=new jscape.dashboard.ChangePasswordController();return controller.start(this.username,true).then($.proxy(function(){this.passwordChanged=true;this._firePasswordChanged();},this));},onClose:function(dialog){dialog.destroy();},_firePasswordChanged:function(){$(document).triggerHandler("broadcast",[window.R.string.USER_CHANGE_PASSWORD_MESSAGE,true,"PWD_CHANGED"]);}});jscape.dashboard.PasswordComplianceView=Class.extend({initialize:function(){this.holder=$("#logininfo");var reminder=$("#password-reminder");if(this.holder.length&&reminder.length){this.holder.tooltip({content:reminder.html(),showEvent:"none",hideEvent:"none",onUpdate:function(){$(this).tooltip("tip").addClass("tooltip-tip-black");},onShow:$.proxy(function(){this.holder.tooltip("tip").one("click",$.proxy(function(){this.holder.tooltip("destroy");},this)).find("a[role=button][name=changepwd]").linkbutton({onClick:$.proxy(this._onClick$ChangePasswordButton,this)});this.holder.tooltip("reposition");},this),onHide:function(){$(this).tooltip("destroy");}});}},show:function(listener){this.listener=listener||jscape.dashboard.PasswordComplianceView.LISTENER;if(this.holder.length){this.holder.tooltip("show");$(window).on("resize.password_reminder",$.proxy(function(){this.holder.tooltip("reposition");},this));}},destroy:function(){if(this.holder.length){this.holder.tooltip("destroy");$(window).off("resize.password_reminder");}},_onClick$ChangePasswordButton:function(){this.listener.onChangePassword(this);}});jscape.dashboard.PasswordComplianceView.LISTENER={onChangePassword:$.noop};jscape.dashboard.ChangePasswordController=Class.extend({deferred:null,initialize:function(){this._initValidators();},start:function(username,current){this.username=username;this.deferred=$.Deferred();this._setupDialog(current).show(this);return this.deferred.promise();},onSubmit:function(dialog){jscape.API.changeUserPassword(this.username,dialog.getCurrentPassword(),dialog.getPassword()).done($.proxy(function(){dialog.destroy();this.deferred.resolve();this.deferred=null;},this)).fail($.proxy(function(){this.deferred.reject();this.deferred=null;},this));},onCancel:function(dialog){dialog.destroy();this.deferred.reject();this.deferred=null;},_setupDialog:function(current){var dialog=new jscape.dashboard.ChangePasswordDialog(current);dialog.setUsername(this.username);return dialog;},_initValidators:function(){var v=new jscape.Validator();v.rule("pi_password_compliance",$.proxy(this._passwordCompliant,this),"");v.rule("pi_password_confirm",$.proxy(this._passwordConfirmed,this),window.R.string.USER_ERROR_CONFIRM_PWD);},_passwordCompliant:function(value,params){var accountName=params&&params.length?params[0]:null;var result=jscape.API.testPasswordCompliance(accountName,value);if($.isPlainObject(result)){if(result.valid===false&&result.message){new jscape.Validator().ruleMessage("pi_password_compliance",result.message);}
return!!result.valid;}
return true;},_passwordConfirmed:function(value,params){return params&&params.length&&$(params[0]).val()==value;}});jscape.dashboard.ChangePasswordDialog=jscape.ui.DefaultDialog.extend({initialize:function(current){this._super($("#d-user-changepwd"),{width:"50%",minWidth:530});this.fieldset=$("fieldset[name=userpasswordfields]",this.dialog);if(!current){$("input[name=oldpassword]",this.fieldset).parent().remove();}else{this.oldPassword=$("input[name=oldpassword]",this.fieldset).passwordbox2({width:"70%"});}
var id="newpwd_"+(1E9*Math.random()>>>0);this.confirmPassword=$("input[name=confirmpwd]",this.fieldset).passwordbox2({validType:"pi_password_confirm",validParams:["#"+id],missingMessage:window.R.string.USER_ERROR_CONFIRM_PWD,tipPosition:"bottom",width:"70%"});this.newPassword=$("input[name=newpassword]",this.fieldset).attr("id",id).passwordbox2({validType:"pi_password_compliance",validateOnCreate:false,validateOnBlur:true,delay:5000,interval:5000,inputEvents:{input:$.proxy(function(cpb,e){var t=$(e.data.target).passwordbox2("getText");cpb.passwordbox2("textbox").validatebox("options").required=t.length!=0;(!t||!t.length)&&cpb.passwordbox2("isValid");},this,this.confirmPassword)},onBeforeValidate:$.proxy(function(){this.newPassword&&this.confirmPassword.passwordbox2("isValid");},this),tipPosition:"bottom",width:"70%"});},getCurrentPassword:function(){return this.oldPassword&&this.oldPassword.length?this.oldPassword.passwordbox2("getValue"):null;},getPassword:function(){return this.newPassword.passwordbox2("getValue");},setUsername:function(value){var opts=this.newPassword.passwordbox2("textbox").validatebox("options");opts.validParams=!!value?[String(value).escapeXml()]:[];opts.required=!this.newPassword.passwordbox2("isSatisfied");}});